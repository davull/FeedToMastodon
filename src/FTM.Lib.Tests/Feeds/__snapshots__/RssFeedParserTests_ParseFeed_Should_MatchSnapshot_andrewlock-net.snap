{
  "Id": "https://andrewlock.net/rss/",
  "Website": "https://andrewlock.net/",
  "Title": "Andrew Lock | .NET Escapades",
  "LastUpdatedTime": "2025-11-11T10:15:23+00:00",
  "Description": "Hi, my name is Andrew, or ‘Sock’ to most people. This blog is where I share my experiences as I journey into ASP.NET Core.",
  "Language": null,
  "Items": [
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/",
      "Title": "Easier reflection with [UnsafeAccessorType] in .NET 10: Exploring the .NET 10 preview - Part 9",
      "PublishDate": "2025-11-04T10:00:00+00:00",
      "Summary": "In this post I show how to work with [UnsafeAccessor] to do 'easier' reflection and how to use .NET 10's [UnsafeAccessorType] with types you can't reference",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/unsafe_accessor_banner.png\" /><nav><p>This is the ninth post in the series: <a href=\"https://andrewlock.net/series/exploring-the-dotnet-10-preview/\">Exploring the .NET 10 preview</a>. </p> <ol class=\"list-none\"><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/\">Part 1 - Exploring the features of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/\">Part 2 - Behind the scenes of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/\">Part 3 - C# 14 extension members; AKA extension everything</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/\">Part 4 - Solving the source generator 'marker attribute' problem in .NET 10</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/\">Part 5 - Running one-off .NET tools with dnx</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/\">Part 6 - Passkey support for ASP.NET Core identity</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">Part 7 - Packaging self-contained and native AOT .NET tools for NuGet</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/\">Part 8 - Supporting platform-specific .NET tools on old .NET SDKs</a></li><li>Part 9 - Easier reflection with [UnsafeAccessorType] in .NET 10 (this post) </li></ol></nav><p>In this post I describe some of the improvements to the <code>[UnsafeAccessor]</code> mechanism that was introduced in .NET 8. <code>[UnsafeAccessor]</code> allows you to easily access private fields and invoke private methods of types, without needing to use the reflection APIs. In .NET 9 there are some limitations to the methods and types this will work with. In .NET 10, some of those gaps have been closed by the introduction of <code>[UnsafeAccessorType]</code>, and it's those improvements we'll look at in this post.</p> <h2 id=\"calling-private-members-with-unsafeaccessor-in-net-8-and-9\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/#calling-private-members-with-unsafeaccessor-in-net-8-and-9\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Calling private members with <code>[UnsafeAccessor]</code> in .NET 8 and 9</a></h2> <p>The <code>[UnsafeAccessor]</code> mechanism was introduced in .NET 8, with support for generics added in .NET 9.</p> <blockquote> <p>I'm going to ignore the question of <em>why</em> you might want to access private members like this as a tangential discussion. You've always been <em>able</em> to do this via the reflection APIs, <code>[UnsafeAccessor]</code> just makes it a bit easier and faster.</p> </blockquote> <p>For example, let's say you want to retrieve the private <code>_items</code> field in <code>List&lt;T&gt;</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">T<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">?</span></span> _items<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// .. other members</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>You could do this using reflection with code like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Get a FieldInfo object for accessing the value</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> itemsFieldInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">GetField</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"_items\"</span><span class=\"token punctuation\">,</span> BindingFlags<span class=\"token punctuation\">.</span>NonPublic <span class=\"token operator\">|</span> BindingFlags<span class=\"token punctuation\">.</span>Instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Create an instance of the list</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Retreive the list using reflection</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> items <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>itemsFieldInfo<span class=\"token punctuation\">.</span><span class=\"token function\">GetValue</span><span class=\"token punctuation\">(</span>list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">items<span class=\"token punctuation\">.</span>Length</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> items\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Prints \"16 items\"</span>\n</code></pre></div> <p>To use <code>[UnsafeAccessor]</code> you must create a special <code>extern</code> method, decorated with the attribute, that has the correct signature for accessing the member you want. In the case of a field, that means a method that takes a single parameter of the target type, and returns an instance of the field's target type as a <code>ref</code>. The name of the method itself is not important.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Create an instance of the list</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Invoke the method to retrieve the list</span>\n<span class=\"token class-name\"><span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> items <span class=\"token operator\">=</span> Accessors<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">&gt;</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetItems</span><span class=\"token punctuation\">(</span>list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">items<span class=\"token punctuation\">.</span>Length</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> items\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Prints \"16 items\"</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Accessors<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Field<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"_items\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token keyword\">ref</span> <span class=\"token return-type class-name\">T<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token function\">GetItems</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span> list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>Note that as <code>List&lt;T&gt;</code> is a generic type, we must use a \"container\" type to declare the accessor method with the correct signature. Making the method itself generic, (<code>GetItems&lt;T&gt;(List&lt;T&gt;)</code>) will not work, nor will using a closed type <code>GetItems(List&lt;int&gt;)</code>.</p> <blockquote> <p>There are some more examples later in this post on calling generic <em>methods</em>, as well as members on generic types.</p> </blockquote> <p>It's also worth noting that the <code>GetItems()</code> signature returns a <code>ref</code> (and it <em>must</em> when you're accessing a field), which means you can also <em>change</em> the field. The example below uses the same accessor method but this time <em>replaces</em> the field:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Create an instance of the list</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Capacity: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">list<span class=\"token punctuation\">.</span>Capacity</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Prints \"Capacity: 16\"</span>\n\n<span class=\"token comment\">// Invoke the method to retrieve the field ref and set the value of the field to an empty array</span>\nAccessors<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">&gt;</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetItems</span><span class=\"token punctuation\">(</span>list<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> Array<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Empty</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Capacity: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">list<span class=\"token punctuation\">.</span>Capacity</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Prints \"Capacity: 0\"</span>\n\n<span class=\"token comment\">// Same accessor as before:</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Accessors<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Field<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"_items\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token keyword\">ref</span> <span class=\"token return-type class-name\">T<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token function\">GetItems</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span> list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>Of course it's not just fields that you can invoke, you can also call methods (and therefore properties) and constructors; anything defined on <code>UnsafeAccesorType</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">UnsafeAccessorKind</span>\n<span class=\"token punctuation\">{</span>\n  Constructor<span class=\"token punctuation\">,</span>\n  Method<span class=\"token punctuation\">,</span>\n  StaticMethod<span class=\"token punctuation\">,</span>\n  Field<span class=\"token punctuation\">,</span>\n  StaticField<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>For example, the following shows an example of invoking a static method defined on <code>List&lt;T&gt;</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Invoking private static methods</span>\n<span class=\"token comment\">// We can pass `null` as the instance argument because these are static methods</span>\n<span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> isCompat1 <span class=\"token operator\">=</span> Accessors<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">?</span><span class=\"token operator\">&gt;</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsCompatibleObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">123</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span>\n<span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> isCompat2 <span class=\"token operator\">=</span> Accessors<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">?</span><span class=\"token operator\">&gt;</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsCompatibleObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span>\n<span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> isCompat3 <span class=\"token operator\">=</span> Accessors<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">?</span><span class=\"token operator\">&gt;</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsCompatibleObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.23</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// false</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Accessors<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// The method we're invoking has this signature:</span>\n    <span class=\"token comment\">//     private static bool IsCompatibleObject(object? value)</span>\n    <span class=\"token comment\">// </span>\n    <span class=\"token comment\">// Our extern signature must include the target type as the first method parameter</span>\n    <span class=\"token punctuation\">[</span><span class=\"token function\">UnsafeAccessor</span><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>StaticMethod<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"IsCompatibleObject\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">CheckObject</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span> instance<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span><span class=\"token punctuation\">?</span></span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>As you can see above, for both instance and static methods you include the \"target\" instance as the first parameter on the method (and pass <code>null</code> as the argument when invoking static methods). That way the runtime knows which <code>Type</code> it's working with: it's whatever the type of the first argument is. But what if you <em>can't</em> specify this type, because the type itself is private?</p> <h2 id=\"limitations-of-unsafeaccessor-in-net-9\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/#limitations-of-unsafeaccessor-in-net-9\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Limitations of <code>[UnsafeAccessor]</code> in .NET 9</a></h2> <p>The big limitation around using <code>[UnsafeAccessor]</code> in .NET 9 is that you must be able to directly reference all the types that are part of the target signature. As a concrete example, imagine a library you're using has a type that looks something like this.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PublicClass</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">PrivateClass</span> _private <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello world!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">internal</span> <span class=\"token return-type class-name\">PrivateClass</span> <span class=\"token function\">GetPrivate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> _private<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PrivateClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> someValue<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">internal</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> SomeValue <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> someValue<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>It's very contrived, but it'll do for our purposes. Imagine you have an instance of <code>PublicClass</code> but what you really need is <code>SomeValue</code> that's held on the <code>_private</code> field. However, <code>PrivateClass</code> is marked <code>internal</code> so you can't directly reference it. That means that none of these accessors will work, because there's no way to use <code>PrivateClass</code> in the signature:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Field<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"_private\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token keyword\">ref</span> <span class=\"token keyword\">readonly</span> <span class=\"token return-type class-name\">PrivateClass</span> <span class=\"token function\">GetByField</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PublicClass</span> instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//                         👆 ❌ Can't reference PrivateClass</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token function\">UnsafeAccessor</span><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"GetPrivate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token return-type class-name\">PrivateClass</span> <span class=\"token function\">GetByMethod</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PublicClass</span> instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//            👆 ❌ Can't reference PrivateClass</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token function\">UnsafeAccessor</span><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"get_SomeValue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetSomeValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PrivateClass</span> instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//                               👆 ❌ Can't reference PrivateClass</span>\n</code></pre></div> <p>The example above is where you can't reference the type in your signature due to its visibility. There's an additional scenario that won't work in .NET 9: where you don't have access to the types you're working with at <em>compile</em> time.</p> <p>That second scenario will likely be rarer, but there's a couple of examples of this that come to mind:</p> <ul><li>The .NET runtime has this scenario due to circular-dependencies between different libraries, for example <a href=\"https://github.com/dotnet/runtime/pull/115583\">the HTTP and Cryptography libraries</a>.</li> <li>The Datadog instrumentation libraries need to access internal properties of libraries we're instrumenting, but we <em>can't</em> reference those libraries directly due to version compatibility constraints.</li></ul> <p>In .NET 9, the only solution to these problems was to fallback to \"normal\" reflection, to use <code>System.Reflection.Emit</code>, or to use <code>System.Linq.Expressions</code>, all of which are significantly slower than <code>[UnsafeAccessor]</code>, and much more cumbersome.</p> <p>Luckily, in .NET 10, we have a way to get the best of both worlds: we can use <code>[UnsafeAccessor]</code> even with types we can't reference!</p> <h2 id=\"accessing-unreferenced-types-with-unsafeaccessortype-in-net-10\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/#accessing-unreferenced-types-with-unsafeaccessortype-in-net-10\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Accessing unreferenced types with <code>[UnsafeAccessorType]</code> in .NET 10</a></h2> <p>In .NET 9 you must be able to directly reference all the types used in the method signature of a <code>[UnsafeAccessor]</code> method. .NET 10 introduces the <code>[UnsafeAccessorType]</code> attribute, which lets us use <code>[UnsafeAccessor]</code> even with types we <em>can't</em> reference.</p> <h3 id=\"using-unsafeaccessortype-with-unsafeaccessor-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/#using-unsafeaccessortype-with-unsafeaccessor-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Using <code>[UnsafeAccessorType]</code> with <code>[UnsafeAccessor]</code></a></h3> <p>.NET 10 introduces a new attribute, <code>[UnsafeAccessorType]</code>, which allows you to specify the expected type for an <code>[UnsafeAccessor]</code> parameter as a <code>string</code>, which solves both of the scenarios described in the previous section. It's easiest to see this in action, so let's look at the same example as before. Let's say we have this hierarchy.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PublicClass</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">PrivateClass</span> _private <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello world!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">internal</span> <span class=\"token return-type class-name\">PrivateClass</span> <span class=\"token function\">GetPrivate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> _private<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PrivateClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> someValue<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">internal</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> SomeValue <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> someValue<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>And we'll create some unsafe accessor methods to retrieve that pesky <code>SomeValue</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"GetPrivate\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateClass\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token comment\">// 👈 Specify target return type as a string</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">GetByMethod</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PublicClass</span> instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//            👆 use object as return type</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token function\">UnsafeAccessor</span><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"get_SomeValue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetSomeValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateClass\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Specify target type in attribute 👆 and use object as instance type 👆</span>\n</code></pre></div> <p>As you can see in the examples above, instead of referencing the type directly, you use <code>object</code> instead and add an <code>[UnsafeAccessorType]</code> with the \"real\" type (more on that shortly).</p> <p>Once we have the above definitions, we can chain these two methods to retrieve the value stored in a <code>PrivateClass</code> instance, even though we can't reference it directly:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Create the target instance</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> publicClass <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PublicClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Invoke GetPrivate(), and return the result as an object</span>\n<span class=\"token class-name\"><span class=\"token keyword\">object</span></span> privateClass <span class=\"token operator\">=</span> <span class=\"token function\">GetByMethod</span><span class=\"token punctuation\">(</span>publicClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Pass the object and invoke the SomeValue getter method</span>\n<span class=\"token class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token keyword\">value</span> <span class=\"token operator\">=</span> <span class=\"token function\">GetSomeValue</span><span class=\"token punctuation\">(</span>privateClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Hello world!</span>\n</code></pre></div> <p>And there you have it, the ability to use <code>[UnsafeAccessor]</code> with types that you can't reference.</p> <h3 id=\"specifying-type-names-with-unsafeaccessortype-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/#specifying-type-names-with-unsafeaccessortype-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Specifying type names with <code>[UnsafeAccessorType]</code></a></h3> <p>The type name I used in the previous example was very simple, just <code>PrivateClass</code>, but this hides the fact that this is actually a fully qualified type name, just as you might use in <code>Type.GetType(name)</code> for example. This needs to be <em>fully</em> qualified though it doesn't <em>have</em> to be <em>Assembly</em> qualified, though doing so is generally more robust.</p> <p>Also note that for generic types and methods, these strings must be in either the open or closed generic format, depending on their usage, e.g. <code>List``1[[!0]]</code>. Similarly, you need the <code>+</code> for handling nested classes.</p> <p>To make that all a little more concrete, I've included some examples below taken from <a href=\"https://github.com/dotnet/runtime/blob/main/src/tests/baseservices/compilerservices/UnsafeAccessors/UnsafeAccessorsTests.cs\">the runtime's unit tests</a> for <code>[UnsafeAccessor]</code>, which demonstrates the use of <code>UnsafeAccessorType]</code> for referencing types in accessor methods. Note that all the types are defined in an assembly called <code>PrivateLib</code>, and all the classes and members are <code>internal</code>, so can't be referenced directly.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">namespace</span> <span class=\"token namespace\">PrivateLib</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Class1</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> StaticField <span class=\"token operator\">=</span> <span class=\"token number\">123</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> InstanceField <span class=\"token operator\">=</span> <span class=\"token number\">456</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">Class1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\">Class1</span> <span class=\"token function\">GetClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Class1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\">Class1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token function\">GetArray</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token class-name\">Class1</span> a<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span> a <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GenericClass<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token return-type class-name\">List<span class=\"token punctuation\">&lt;</span>Class1<span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">ClosedGeneric</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>Class1<span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token return-type class-name\">List<span class=\"token punctuation\">&lt;</span>U<span class=\"token punctuation\">&gt;</span></span> <span class=\"token generic-method\"><span class=\"token function\">GenericMethod</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>U<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>U<span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token generic-method\"><span class=\"token function\">GenericWithConstraints</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>V<span class=\"token punctuation\">,</span> W<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span> a<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>V<span class=\"token punctuation\">&gt;</span></span> b<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>W<span class=\"token punctuation\">&gt;</span></span> c<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>Class1<span class=\"token punctuation\">&gt;</span></span> d<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">where</span> <span class=\"token class-name\">W</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">T</span></span>\n         <span class=\"token operator\">=&gt;</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The following are a bunch of representative examples of accessors, in increasing complexity. Each one shows a different example of an <code>[UnsafeAccessorType]</code> usage. This also demonstrates different <em>kinds</em> of accessors, such as constructors.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// 1. Calling the Class1 constructor, returned type name is assembly qualified</span>\n<span class=\"token punctuation\">[</span><span class=\"token function\">UnsafeAccessor</span><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Constructor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateLib.Class1, PrivateLib\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">CreateClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 2. Calling a static method. Both the return type and the \"target\" parameter are assembly qualified</span>\n<span class=\"token punctuation\">[</span><span class=\"token function\">UnsafeAccessor</span><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>StaticMethod<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"GetClass\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateLib.Class1, PrivateLib\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">CallGetClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateLib.Class1, PrivateLib\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 3. Returning a ref to the static field</span>\n<span class=\"token punctuation\">[</span><span class=\"token function\">UnsafeAccessor</span><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>StaticField<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"StaticField\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">ref</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> <span class=\"token function\">GetStaticField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateLib.Class1, PrivateLib\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 4. Returning a ref to an instance field</span>\n<span class=\"token comment\">// Note that we cannot use [UnsafeAccessorType] on the return type. More on that later.</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Field<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"InstanceField\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">ref</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> <span class=\"token function\">GetInstanceField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateLib.Class1, PrivateLib\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 5. Passing an object by reference and returning an array</span>\n<span class=\"token comment\">// Note the `&amp;` in the signature when passing by reference.</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"GetArray\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateLib.Class1[], PrivateLib\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">CallM_RC1</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TargetClass</span> tgt<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateLib.Class1&amp;, PrivateLib\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">ref</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 6. Invoking a method on a generic type, and returning a closed-generic type</span>\n<span class=\"token comment\">// The return type uses a mix of fully qualified (for BCL types) and assembly qualified types</span>\n<span class=\"token comment\">// Note that the open generic definition uses !0 to indicate an unspecified type parameter</span>\n<span class=\"token punctuation\">[</span><span class=\"token function\">UnsafeAccessor</span><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"ClosedGeneric\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"System.Collections.Generic.List`1[[PrivateLib.Class1, PrivateLib]]\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">CallGenericClassClosedGeneric</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateLib.GenericClass`1[[!0]], PrivateLib\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 7. Invoking a generic method on a generic type.</span>\n<span class=\"token comment\">// This is similar to the above, but we use !!0 to indicate an unspecified generic method type parameter.</span>\n<span class=\"token comment\">// Note that the accessor method itself must be generic.</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"GenericMethod\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"System.Collections.Generic.List`1[[!!0]]\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token generic-method\"><span class=\"token function\">CallGenericClassGenericMethod</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>U<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateLib.GenericClass`1[[!0]], PrivateLib\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 8. Invoking a generic method, on a generic type, with type constraints</span>\n<span class=\"token comment\">// This is a more complex version of the above, but additionally specifies</span>\n<span class=\"token comment\">// type constraints which match the target method's constraints.</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"GenericWithConstraints\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">extern</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token generic-method\"><span class=\"token function\">CallGenericClassGenericWithConstraints</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>V<span class=\"token punctuation\">,</span>  W<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PrivateLib.GenericClass`1[[!0]], PrivateLib\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> tgt<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"System.Collections.Generic.List`1[[!0]]\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> a<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"System.Collections.Generic.List`1[[!!0]]\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> b<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>W<span class=\"token punctuation\">&gt;</span></span> c<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"System.Collections.Generic.List`1[[PrivateLib.Class1, PrivateLib]]\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> d<span class=\"token punctuation\">)</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">W</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">T</span></span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>These examples show the <em>wide</em> variety of invocations you can make using <code>[UnsafeAccessorType]</code> which makes this a very powerful approach. And what's more, it's <em>fast</em>. Using <code>[UnsafeAccessor]</code> in general is much faster than traditional reflection.</p> <p>Unfortunately, even in .NET 10, there's still a couple of gaps with what we can do.</p> <h3 id=\"limitations-of-unsafeaccessortype-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/#limitations-of-unsafeaccessortype-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Limitations of <code>[UnsafeAccessorType]</code></a></h3> <p>As I showed in the previous section, you can use <code>[UnsafeAccessorType]</code> in conjunction with <code>[UnsafeAccessor]</code> to access private members of types that you can't reference at runtime, but there's still a few gaps where you <em>can't</em> replace the use of traditional reflection. In summary, these are:</p> <ul><li>You can't call an accessor on a generic type if you can't represent the generic type argument.</li> <li>You can't call fields where the field needs to be marked with <code>[UnsafeAccessorType]</code>.</li> <li>You can't call methods that return a <code>ref</code> where the return needs to be marked with <code>[UnsafeAccessorType]</code>.</li></ul> <p>To clarify those cases, I'll provide some examples of types and accessors that <em>don't</em> work.</p> <h4 id=\"1-unable-to-represent-the-type-argument\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/#1-unable-to-represent-the-type-argument\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">1. Unable to represent the type argument</a></h4> <p>The first case is pretty simple. Imagine we have the <code>Generic&lt;T&gt;</code> type, plus a helper class, <code>Class1</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Generic<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Class1</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n</code></pre></div> <p>We need to create instances of the <code>Generic&lt;T&gt;</code> type even though it's marked internal, so we create an accessor for it:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Accessors<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Constructor<span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"Generic`1[[!0]]\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>This works fine when the <code>T</code> we need can be referenced:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">object</span></span> instance <span class=\"token operator\">=</span> Accessors<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">&gt;</span><span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span>generic<span class=\"token punctuation\">.</span><span class=\"token function\">GetType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Generic`1[System.Int32]</span>\n</code></pre></div> <p>but what happens if we need to create an instance of <code>Generic&lt;Class1&gt;</code>? The simple answer is we can't. We would need to call <code>Accessors&lt;Class1&gt;.Create()</code>, but that won't compile as we can't reference <code>Class1</code>. So if we have this pattern then we have to fallback to traditional reflection.</p> <p>What's more, even if we created an instance of <code>Generic&lt;Class1&gt;</code> using \"traditional\" reflection, we <em>wouldn't</em> be able to use <code>[UnsafeAccessor]</code> methods to interact with the object, because we would always need to do so through a method defined on <code>Accessors&lt;Class1&gt;</code>, which is again not possible because we can't reference <code>Class1</code>.</p> <h4 id=\"2-unable-to-represent-field-return-types\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/#2-unable-to-represent-field-return-types\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">2. Unable to represent field return types</a></h4> <p>We'll extend the previous example to add a new type, <code>Class2</code>, which has a couple of fields that reference the <code>Class1</code> type:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Class1</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Class2</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Class1</span> _field1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">Class1</span> _field2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>If <code>_field1</code> and <code>_field2</code> referenced known types, then we could create <code>[UnsafeAccessor]</code>s for them without issue. You might think that accessors like the following would work:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Helper for creating a C2 instance</span>\n<span class=\"token punctuation\">[</span><span class=\"token function\">UnsafeAccessor</span><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Constructor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"Class2\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Field<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"_field1\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"Class1\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token keyword\">ref</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">CallField1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"Class2\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Field<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"_field2\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"Class1\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token keyword\">ref</span> <span class=\"token keyword\">readonly</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">CallField2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"Class2\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>However, if you try to use <code>CallField1()</code> or <code>CallField2()</code> you'll get an error at runtime:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">object</span></span> class2 <span class=\"token operator\">=</span> <span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">object</span></span> field1 <span class=\"token operator\">=</span> <span class=\"token function\">CallField1</span><span class=\"token punctuation\">(</span>class2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// throws System.NotSupportedException: Invalid usage of UnsafeAccessorTypeAttribute</span>\n<span class=\"token class-name\"><span class=\"token keyword\">object</span></span> field2 <span class=\"token operator\">=</span> <span class=\"token function\">CallField2</span><span class=\"token punctuation\">(</span>class2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// throws System.NotSupportedException: Invalid usage of UnsafeAccessorTypeAttribute</span>\n</code></pre></div> <p>In both cases, you get a <code>System.NotSupportedException</code> stating <code>Invalid usage of UnsafeAccessorTypeAttribute</code>: you simply can't access fields unless you can represent the types.</p> <blockquote> <p>As an aside, this really confused me when I was first trying out the feature. Accessing a field was the first thing I tried and I assumed I was doing it wrong. 😅</p> </blockquote> <p>Just to repeat, this works fine if the field you're accessing is <em>not</em> using <code>[UnsafeAccessorType]</code>, so if <code>_field1</code> was an <code>int</code> for example. It's only trying to use <code>[UnsafeAccessorType]</code> with the field which fails.</p> <h4 id=\"3-unable-to-represent-ref-method-returns\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/#3-unable-to-represent-ref-method-returns\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">3. Unable to represent <code>ref</code> method returns</a></h4> <p>Similar to the previous issue, if you have a <code>ref</code> returning method, and you can't represent the type, then you can't use <code>[UnsafeAccessor]</code>. For example, let's add a <code>GetField1()</code> method, which returns a <code>ref</code> to <code>_field1</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Class1</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Class2</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Class1</span> _field1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">ref</span> <span class=\"token return-type class-name\">Class1</span> <span class=\"token function\">GetField1</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Class2</span> a<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token keyword\">ref</span> _field1<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>An accessor for this might look like the following:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessor</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnsafeAccessorKind<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">,</span> Name <span class=\"token operator\">=</span> <span class=\"token string\">\"GetField1\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"Class1&amp;\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token comment\">// ref return </span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token keyword\">ref</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">CallGetField1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">UnsafeAccessorType</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"Class2\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>But trying to call this accessor fails in the same way at runtime as trying to access the field directly:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">object</span></span> class2 <span class=\"token operator\">=</span> <span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">object</span></span> field1 <span class=\"token operator\">=</span> <span class=\"token function\">CallGetField1</span><span class=\"token punctuation\">(</span>class2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// throws System.NotSupportedException: Invalid usage of UnsafeAccessorTypeAttribute</span>\n</code></pre></div> <p>Those are all the limitations I found, so as long as what you're trying to do doesn't fall into one of these camps, then you should hopefully be ok!</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I described some improvements to the <code>[UnsafeAccessor]</code> mechanism that was introduced in .NET 8. I showed how <code>[UnsafeAccessor]</code> allows you to easily access private fields and invoke private members of types, without needing to use the reflection APIs in .NET 8 and .NET 9. I then described some of the limitations, namely that you need to be able to reference the types used by the members you're accessing.</p> <p>Next I introduced the <code>[UnsafeAccessorType]</code> attribute, and showed how you could use it to invoke methods on types that you <em>can't</em> reference at compile time. I showed how you can use this to invoke methods, constructors, and fields, and how to work with generic types and generic methods. Finally, I described the limitations of <code>[UnsafeAccessorType]</code>, namely that you can't use it to work with instances of generic types where you can't reference the type parameter, and that you can't use <code>[UnsafeAccessorType]</code> with fields or <code>ref</code> returning methods.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/",
      "Title": "Understanding the worst .NET vulnerability ever: request smuggling and CVE-2025-55315",
      "PublishDate": "2025-10-28T10:00:00+00:00",
      "Summary": "In this post I discuss request smuggling, the recent vulnerability in ASP.NET Core with a severity score of 9.9, and how attackers could exploit it",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/request_smuggling_banner.png\" /><p>I admit, that's a very click-baity headline, but Microsoft have given the vulnerability a CVSS score of 9.9, their highest ever. Time to panic, right?</p> <p>In this post I try to provide a bit more context. I explain how request smuggling vulnerabilities work in general, how it works in <em>this</em> case, what attackers could use it for, how the vulnerability was fixed, what you can do to protect yourself.</p> <blockquote> <p>WARNING: I am not a security professional, so do not take anything in this post as gospel or advice. I'm just a developer trying to make sense of things. 😄 All of the details in this post are based on information that was provided or referenced in the original announcement.</p> </blockquote> <h2 id=\"what-is-the-cve-2025-55315-vulnerability-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#what-is-the-cve-2025-55315-vulnerability-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What is the CVE-2025-55315 vulnerability?</a></h2> <p>On October 14th 2025, on a standard Microsoft \"patch Tuesday\", Microsoft released new versions of all their supported versions of .NET, and also published a security advisory: <a href=\"https://github.com/dotnet/aspnetcore/issues/64033\">Microsoft Security Advisory CVE-2025-55315: .NET Security Feature Bypass Vulnerability</a>. The high level summary from that announcement said:</p> <blockquote> <p>Inconsistent interpretation of http requests ('http request/response smuggling') in ASP.NET Core allows an authorized attacker to bypass a security feature over a network.</p> </blockquote> <p>The advice was \"patch all of your things\", but the real headline was that this vulnerability was given a <a href=\"https://en.wikipedia.org/wiki/Common_Vulnerability_Scoring_System\">CVSS score</a> of 9.9 our of 10, which you know, sounds pretty bad! <a href=\"https://github.com/blowdart\">Barry Dorrans AKA blowdart</a>, .NET security head honcho, gave <a href=\"https://github.com/dotnet/aspnetcore/issues/64033#issuecomment-3403054914\">an explanation of the reasoning behind the score</a> in a comment on the original issue:</p> <blockquote> <p>The bug enables HTTP Request Smuggling, which on its own for ASP.NET Core would be nowhere near that high, but that's not how we rate things...</p> <p>Instead, we score based on how the bug might affect applications built on top of ASP.NET.</p> <p>Request Smuggling allows an attacker to hide an extra request inside an another, and what that hidden request can do is very application specific.</p> <p>The smuggled request could cause your application code to</p> <ul><li>Login as a different user (EOP)</li> <li>Make an internal request (SSRF)</li> <li>Bypass CSRF checks</li> <li>Perform an injection attack</li></ul> <p>But we don't know what's possible because it's dependent on how you've written your app.</p> </blockquote> <p>That <em>does</em> all sound pretty scary! 😱 So you can understand the consternation that the issue has caused, especially given the hesitation to explain exactly what \"how you've written your app\" <em>means</em>.</p> <p>Out of curiosity, I decided to dig in further to really understand this vulnerability, how it could impact you, and what \"how you've written your app\" could mean.</p> <h2 id=\"how-does-request-smuggling-work-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#how-does-request-smuggling-work-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">How does request smuggling work?</a></h2> <p>Before we get to the actual patched vulnerability in ASP.NET Core and how the vulnerability works, I think it's important to have some background about the general <em>class</em> of exploits known as <em>HTTP request smuggling</em>.</p> <p><a href=\"https://en.wikipedia.org/wiki/HTTP_request_smuggling\">HTTP request smuggling</a> is a security exploit that has been known about for a <em>long</em> time (according to Wikipedia, <a href=\"https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf\">it was first documented in 2005</a>). It fundamentally arises when you have two different servers processing an HTTP request (e.g. a server and a proxy server), and where those two servers <em>differ</em> in how they handle \"invalid\" HTTP requests.</p> <p>In all cases of HTTP request smuggling, the exploit works by creating an invalid HTTP request (or sometimes just an <em>ambiguous</em> request), that looks a bit like two HTTP requests glued together. In summary, the exploit then works a bit like this:</p> <ul><li>The proxy server receives the ambiguous HTTP request</li> <li>The proxy server forwards the request (unmodified) to the destination server</li> <li>The server interprets the ambiguous request as <em>two</em> pipelined HTTP requests sent to the server, and processes them separately.</li></ul> <p>I think it's easiest to understand the problem with an example, so the request below shows an example from <a href=\"https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf\">the original 2005 paper</a>.</p> <blockquote> <p>Note that this is <em>not</em> an example of the request smuggling vulnerability in CVE-2025-55315, it's just a representative example of request smuggling in <em>general</em>.</p> </blockquote> <p>Let's imagine the attacker sends an HTTP request that looks like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-http\"><code class=\"language-http\"><span class=\"token request-line\"><span class=\"token method property\">POST</span> <span class=\"token request-target url\">/some_script.jsp</span> <span class=\"token http-version property\">HTTP/1.0</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Connection</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">Keep-Alive</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Content-Type</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">application/x-www-form-urlencoded</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Content-Length</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">9</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Content-Length</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">204</span></span>\n\nthis=thatPOST /vuln_page.jsp HTTP/1.0\n<span class=\"token header\"><span class=\"token header-name keyword\">Content-Type</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">application/x-www-form-urlencoded</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Content-Length</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">95</span></span>\n\nparam1=value1&amp;data=&lt;script&gt;alert(\"stealing%20your%20data:\"%2bdocument.cookie)&lt;/script&gt;&amp;foobar\n</code></pre></div> <p>The important feature of this request is that there are <em>two</em> <code>Content-Length</code> headers in the first request (and one later in the smuggled request), with different values: <code>9</code> or <code>204</code>. <strong>This is the core of the exploit</strong>; the difference between <em>which</em> of the these first two headers the HTTP proxy and HTTP server honour is what causes the vulnerability.</p> <p>Let's walk through how the exploit works, step-by-step:</p> <ul><li>The attacker sends the above HTTP request.</li> <li>The HTTP proxy receives the request, notes the duplicate <code>Content-Length</code> headers, and accepts the <em>second</em> header, the <code>204</code> length. That means the <em>whole</em> rest of the request is treated as the message body, and seems fine as far as the proxy is concerned.</li> <li>The HTTP proxy forwards the request on to the destination server.</li> <li>This server also notes the duplicate <code>Content-Length</code> header, but it takes the <em>first</em> of the headers, with the length of <code>9</code>.</li> <li>The server reads <code>9</code> bytes of the body (i.e. <code>this=that</code>) and <em>treats that as the whole request</em>. As far as the server is concerned, the whole (valid) request has been received, and it sees the rest of the data <em>as a whole new request</em>.</li> <li>That means that the destination server sees an entirely new HTTP request to process, <code>POST /vuln_page.jsp</code>, and treats it as a new request.</li></ul> <p>That's the core of the issue; the proxy saw one request, while the destination server saw <em>two</em>—the second request has been \"smuggled\" past the proxy to the server.</p> <blockquote> <p>The request smuggling technique shown here, where you have multiple <code>Content-Length</code> headers isn't the \"canonical\" example you'll generally see referenced, but I used it here because it's simpler to understand in a lot of ways.</p> <p>The canonical request smuggling attack is where you send both a <code>Content-Length</code> header and a <code>Transfer-Encoding: chunked</code> header (which specifies the length of the body as part of the body itself). As before, the request smuggling exploit relies on differences in how proxy and destination servers interpret these <a href=\"https://datatracker.ietf.org/doc/html/rfc9112#section-6.3-2.3\">conflicting headers</a>.</p> </blockquote> <p>So as you've seen, request smuggling enables sending a secret request to a destination server that an intermediate proxy server hasn't seen. In the next section we'll look at why that's a bad thing, and how it can be exploited.</p> <h2 id=\"how-can-an-attacker-exploit-request-smuggling-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#how-can-an-attacker-exploit-request-smuggling-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">How can an attacker exploit request smuggling?</a></h2> <p>On the face of it, request smuggling might not <em>seem</em> like a big deal. So the server sees two requests, so what? You could always send two requests to the server <em>anyway</em>, right? Well, yes and no.</p> <p>The issue with request smuggling is really all about the <em>mismatch</em> between the proxy and destination servers. Thanks to this mismatch, and depending on what behaviours and expectations the target application has, attackers can use request smuggling to</p> <ul><li>Reflect malicious data to other users on sites that are vulnerable to cross-site scripting.</li> <li>Poison caches with bad data.</li> <li>Exfiltrate authentication credentials or other data from client requests.</li> <li>Invoke endpoints that shouldn't be publicly accessible (because the proxy would block external access to them).</li> <li>Replace/override authentication controls handled by the proxy.</li> <li>Redirect users to malicious sites on sites vulnerable to open-redirect attacks.</li> <li>And more…</li></ul> <p>As you can see, these are all Bad™️, so you can kind of understand why the 9.9 rating was given! 😱</p> <p>That said, it's worth mentioning that not <em>all</em> of these attacks will be fruitful against <em>all</em> applications. Some of the easiest to understand versions of these exploits are where the proxy is not just doing \"dumb\" forwarding of requests, but rather it's validating or enhancing the request in some way.</p> <p>For example, if you have a proxy sat in front of your server which is responsible for handling TLS termination and client-authentication and identification using certificates, then request smuggling could be used to bypass these checks and insert your <em>own</em> identification.</p> <p>As an example of <a href=\"https://portswigger.net/web-security/request-smuggling/exploiting#bypassing-client-authentication\">that attack</a>, the HTTP request below demonstrates using a <code>Content-Length</code> and <code>Transfer-Encoding</code> request smuggling attack to \"hide\" the request to <code>/admin</code> from the front-end proxy, and insert a malicious <code>X-SSL-CLIENT-CN</code> header, which would <em>normally</em> be added by the front-end proxy:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-http\"><code class=\"language-http\"><span class=\"token request-line\"><span class=\"token method property\">POST</span> <span class=\"token request-target url\">/example</span> <span class=\"token http-version property\">HTTP/1.1</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Host</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">some-website.com</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Content-Type</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">x-www-form-urlencoded</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Content-Length</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">64</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Transfer-Encoding</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">chunked</span></span>\n\n0\n\n<span class=\"token request-line\"><span class=\"token method property\">GET</span> <span class=\"token request-target url\">/admin</span> <span class=\"token http-version property\">HTTP/1.1</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">X-SSL-CLIENT-CN</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">administrator</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Foo</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">x</span></span>\n</code></pre></div> <p>In this example, the server assumes that the <code>X-SSL-CLIENT-CN: administrator</code> header was added by the proxy, and so the server assumes that the proxy already did all the necessary authentication and authorization. The attacker is able to perform a request as an entirely different user.</p> <p>Request smuggling is clearly a big problem whenever you have a front-end proxy that does some functionality, but even when it's essentially a dumb proxy, request smuggling can still be used to <a href=\"https://portswigger.net/web-security/request-smuggling/exploiting#capturing-other-users-requests\">steal and exfiltrate data</a> from <em>other</em> user's requests, even if the attacked site is not vulnerable to cross-site scripting or other vulnerabilities.</p> <blockquote> <p>In these attacks, simply having functionality that displays data provided by a user (even sanitised) can be sufficient to <a href=\"https://portswigger.net/web-security/request-smuggling/exploiting#capturing-other-users-requests\">steal the credentials of other users</a>. So something as simple as displaying a user name or a comment could be sufficient.</p> </blockquote> <p>This post is long enough, and there are so many different attacks, that I'm going to leave it there for looking at exploits. If you'd like to learn more about what's possible, along with simple explanations and examples of exploits, I recommend the <a href=\"https://portswigger.net/\">PortSwigger</a> documentation on <a href=\"https://portswigger.net/web-security/request-smuggling/exploiting\">exploiting request smuggling</a>.</p> <h2 id=\"does-request-smuggling-only-apply-if-i-have-a-proxy-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#does-request-smuggling-only-apply-if-i-have-a-proxy-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Does request smuggling only apply if I have a proxy?</a></h2> <p>In general, whenever people talk about request smuggling, they normally talk about the case where you have multiple servers: the canonical example is a proxy server and a destination server, as I've discussed so far. But don't be fooled, these issues and vulnerabilities can apply even if you aren't strictly using a proxy.</p> <p>The <em>key</em> feature of the vulnerability is that there's an opportunity for confusion between two \"systems\", whether they're full \"servers\" or not. This obviously applies to proxy servers, but could also apply to your application if you're doing anything where you're reading/manipulating/forwarding request streams, or where there's the possibility for confusion <em>inside the same application</em>.</p> <p>For ASP.NET Core applications, if you're working with <code>HttpRequest.Body</code> or <code>HttpRequest.BodyReader</code>, or other similar methods then you <em>may</em> be vulnerable to attacks <em>even if you're not explicitly using a proxy server</em>. Even if you don't think of your application as a proxy or as using a proxy, if you're doing \"proxy-like\" things, then you could be vulnerable.</p> <blockquote> <p>Put in other words, if you're reading, manipulating, or forwarding request streams directly in ASP.NET Core, as opposed to just relying on the built-in model binding, then you could be at risk to request smuggling attacks. It's very hard to enumerate all the attack vectors, so you should consider any code that does so as a potential avenue of exploitation.</p> </blockquote> <p>We've now covered how request smuggling works and can be exploited in general, so it's time to look at the <em>specific</em> version of request smuggling that is targeted in the .NET CVE-2025-55315 vulnerability.</p> <h2 id=\"how-does-the-request-smuggling-in-cve-2025-55315-work-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#how-does-the-request-smuggling-in-cve-2025-55315-work-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">How does the request smuggling in CVE-2025-55315 work?</a></h2> <p>As we've seen, HTTP request smuggling is a general technique that relies on differences between proxies and servers in how they parse HTTP requests. I've shown two specific versions of this so far: duplicate <code>Content-Length</code> headers, and <code>Content-Length</code>/<code>Transfer-Encoding</code> confusion, but these are not exhaustive. There are variations on these approaches which also lead to request smuggling.</p> <p>The request smuggling vulnerability in <a href=\"https://github.com/dotnet/aspnetcore/issues/64033\">CVE-2025-55315</a> relies on a variation which (as far as I can tell) was first reported in June 2025 by <a href=\"https://w4ke.info/2025/06/18/funky-chunks.html\">Jeppe Bonde Weikop on their blog</a>. This variation relies on <code>Transfer-Encoding</code> and the <a href=\"https://datatracker.ietf.org/doc/html/rfc9112#name-chunk-extensions\">Chunk Extensions</a> feature.</p> <blockquote> <p>All the details and images in this section are based on the descriptions and examples in <a href=\"https://w4ke.info/2025/06/18/funky-chunks.html\">the original post</a>. That post is excellent, so if you want even more detail and explanation than here, you should definitely read it, and then you can skip the abbreviated version I provide here.</p> </blockquote> <p>To understand the vulnerability, we'll first look at how chunked transfer encoding works and what chunk extensions are. We'll then look at how invalid line-endings can lead to differences in interpretation of a request. Finally, we'll look at how this difference in interpretation can open the way for request smuggling, and how ASP.NET Core fixed the problem.</p> <h3 id=\"transfer-encoding-chunked-and-chunk-extensions\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#transfer-encoding-chunked-and-chunk-extensions\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\"><code>Transfer-Encoding: chunked</code> and chunk extensions</a></h3> <p>To understand the vulnerability, we first need to understand how <code>Transfer-Encoding: chunked</code> works, and how chunk extensions complicate things.</p> <p>When you're <em>sending</em> a request, you might not always know up-front how big the request is that you're sending. Let's take a practical example of serializing a .NET object to JSON into a request body. The only way to know for sure how big the serialized data is going to be is to actually serialize it. So you <em>could</em> serialize the data to memory <em>before</em> writing the request, but if the data is very big, then that could cause issues with allocating big arrays.</p> <p>Instead, <a href=\"https://en.wikipedia.org/wiki/Chunked_transfer_encoding\"><code>Transfer-Encoding: chunked</code></a> allows sending the request data in multiple \"chunks\". You need to know the size of each individual chunk, but not the <em>overall</em> size of the data, or how many chunks there are. This works well for serializing to a small buffer, sending that small buffer as a chunk, and then re-using the buffer to serialize the next part, until you have serialized the whole object.</p> <p>In terms of the HTTP request itself, each chunk consists of a header and a body. The header consists of a hexadecimal-formatted number of bytes, followed by a <code>\\r\\n</code> (<code>CRLF</code>) line ending. The chunk body is then the specified number of bytes, followed by another <code>\\r\\n</code>. You can have as many chunks as you need, and the request will keep being passed until you send a <code>0</code> length chunk, which indicates the end of the request.</p> <p>As an example, the following HTTP <code>POST</code> shows posting some JSON to an endpoint, but the JSON is sent as three distinct chunks:</p> <p><img src=\"https://andrewlock.net/content/images/2025/request_smuggling_01.svg\" alt=\"A simple HTTP request using chunked transfer encoding\"></p> <ul><li>Chunk 1: The header is <code>9</code> indicating 9 bytes will be sent (followed by <code>\\r\\n</code>), and then the 9 bytes of the start of the JSON document in the chunk body, again followed by <code>\\r\\n</code>.</li> <li>Chunk 1: The header is <code>e</code> indicating 14 bytes (14 in hexadecimal is <code>e</code>) will be sent (followed by <code>\\r\\n</code>), and then the remaining 14 bytes of the end of the JSON document, followed by <code>\\r\\n</code>.</li> <li>The final chunk is an \"empty\" chunk, <code>0\\r\\n\\r\\n</code>, indicating the end of the request.</li></ul> <p>We're going to see shortly that line endings are very important, so the following diagram shows the same as the above HTTP request, but with the line endings included:</p> <p><img src=\"https://andrewlock.net/content/images/2025/request_smuggling_02.svg\" alt=\"A simple HTTP request using chunked transfer encoding with the line endings shown\"></p> <p>That's \"normal\" chunked transfer encoding, so now we come to chunk extensions. <a href=\"https://datatracker.ietf.org/doc/html/rfc9112#name-chunk-extensions\">Chunk extensions</a> are part of the HTTP 1.1 protocol which allows for adding key-value pairs of metadata to individual chunks. The following example shows the same request as before, but with a chunk extension, <code>;foo=bar</code> in the second chunk:</p> <p><img src=\"https://andrewlock.net/content/images/2025/request_smuggling_03.svg\" alt=\"The same HTTP request with a chunk extension in the second chunk\"></p> <p>A chunk extension is indicated by a <code>;</code> after the chunk header length, followed by one or more key-value pairs in the form <code>key=value</code>. It's important to understand that chunk extensions are not part of the <em>data</em> that's seen by a request handler; chunk extensions are just metadata about the individual chunk. And tl;dr; they're completely useless 😅</p> <p>To the closest approximation, no-one cares about chunk extensions; client implementations don't send them, and servers just ignore them. If that's the case, how can they be the cause of such a problematic bug in .NET?</p> <p>The problem is <em>how</em> the implementation ignores them…</p> <h3 id=\"invalid-chunk-extensions-with-incorrect-line-endings\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#invalid-chunk-extensions-with-incorrect-line-endings\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Invalid chunk extensions with incorrect line endings</a></h3> <p>In general with HTTP, clients and server implementations often try to follow the <a href=\"https://en.wikipedia.org/wiki/Robustness_principle\"><em>robustness principle</em></a> of \"be conservative in what you send, and lenient with what you accept\". Unfortunately, it's this very leniency which can sometimes leave us in hot water. After all, it was leniency around requests containing both a <code>Content-Length</code> and <code>Transfer-Encoding</code> header that was the root cause of the original request smuggling exploit.</p> <blockquote> <p>Note that the <a href=\"https://datatracker.ietf.org/doc/html/rfc9112#section-6.3-2.3\">HTTP 1.1 RFC now forbids</a> forwarding both these headers, precisely to avoid request smuggling attacks.</p> </blockquote> <p>For chunk extensions though, leniency is often <em>accidentally</em> built in to the server implementations. Given that no implementations actually <em>do</em> anything with the chunk extensions, the canonical approach to handling them when parsing a chunk header is just to <em>ignore</em> them. When a <code>;</code> is parsed, it's common to just look for the end of the line, and ignore everything in between.</p> <p>For ASP.NET Core (prior to the fix), on finding a <code>;</code> in the chunk header, <a href=\"https://github.com/dotnet/aspnetcore/blob/4cf89470a7866a963d7118bb1ba90dc35683965c/src/Servers/Kestrel/Core/src/Internal/Http/Http1ChunkedEncodingMessageBody.cs#L348-L356\">Kestrel would \"parse\" the extension</a>, but in practice, it would search for the carriage return <code>\\r</code> and then check for the following <code>\\n</code>, skipping everything in between, a little bit like this (very simplified compared to <a href=\"https://github.com/dotnet/aspnetcore/blob/4cf89470a7866a963d7118bb1ba90dc35683965c/src/Servers/Kestrel/Core/src/Internal/Http/Http1ChunkedEncodingMessageBody.cs#L348-L356\">original code</a>):</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ParseExtension</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ReadOnlySequence<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">&gt;</span></span> buffer<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Chunk-extensions not currently parsed</span>\n        <span class=\"token comment\">// Just drain the data</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> extensionCursor <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">PositionOf</span><span class=\"token punctuation\">(</span>ByteCR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> suffixBuffer <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">Slice</span><span class=\"token punctuation\">(</span>extensionCursor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// skips over extensionCursor bytes</span>\n\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> suffixSpan <span class=\"token operator\">=</span> suffixBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">Slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>suffixSpan<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token char\">'\\n'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// We consumed the \\r\\n at the end of the extension, so switch modes.</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// Otherwise, keep reading data until we do find \\r\\n</span>\n        buffer <span class=\"token operator\">=</span> <span class=\"token function\">ReadMoreData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The implementation in ASP.NET Core wasn't particularly special; <a href=\"https://github.com/golang/go/blob/1d45a7ef560a76318ed59dfdb178cecd58caf948/src/net/http/internal/chunked.go#L193-L199\">most servers</a> simply skip over the bytes until they find a <code>\\r\\n</code>. The big question is exactly <em>how</em> the servers search for <code>\\r\\n</code>. What happens if they see a lone <code>\\r</code>, or a lone <code>\\n</code>? Do they treat that the same as a <code>\\r\\n</code>? Do they throw an error if they find an un-paired <code>\\r</code> or <code>\\n</code>? Or do they ignore it and keep looking for a <code>\\r\\n</code>?</p> <p>That ambiguity is at the heart of the CVE-2025-55315 request smuggling vulnerability. Differences in how proxy and server implementations treat standalone <code>\\r</code> or <code>\\n</code> in a chunk header allow for request smuggling exploits that use this ambiguity.</p> <blockquote> <p>Note that according to <a href=\"https://www.rfc-editor.org/errata/eid7633\">the RFC</a>, implementers must <em>not</em> treat <code>\\r</code> or <code>\\n</code> as \"valid\" line terminators for a chunk header, and neither <code>\\r</code> or <code>\\n</code> are allowed elsewhere in chunk headers, so correct implementations must reject requests that include these standalone line endings in chunk headers.</p> </blockquote> <p>For complete clarity, the following example is the same as the previous implementation but with an <em>invalid</em> chunk header in the chunk extension of the second chunk. Instead of ending with <code>\\r\\n</code>, the chunk extension ends with a single <code>\\n</code>:</p> <p><img src=\"https://andrewlock.net/content/images/2025/request_smuggling_04.svg\" alt=\"An HTTP request with an ambiguous line ending in a chunk extension\"></p> <p>That's the root cause of the request smuggling vulnerability, so in the next section we'll look at <em>how</em> this could be used to craft a malicious HTTP request.</p> <h3 id=\"exploiting-invalid-chunk-extensions-for-request-smuggling\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#exploiting-invalid-chunk-extensions-for-request-smuggling\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Exploiting invalid chunk extensions for request smuggling</a></h3> <p>Just as with other examples of request smuggling, the chunk extensions approach relies on differences in how a proxy parses a request compared to a subsequent server. This difference means the proxy sees one request, while the destination request sees two requests, and allows for <a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#how-can-an-attacker-exploit-request-smuggling-\">all the same exploits I discussed earlier</a>.</p> <blockquote> <p>As discussed, these examples come from <a href=\"https://w4ke.info/2025/06/18/funky-chunks.html\">this excellent blog post</a>, so see that post for more details, variations on the attack, and further ways to exploit the vulnerability.</p> </blockquote> <p>The following example shows a malicious HTTP request that exploits a difference in line-ending handling between a proxy and the destination server to smuggle a request to the <code>/admin</code> endpoint. We can imagine that the proxy is configured to automatically reject requests to <code>/admin</code> normally, and the server assumes that the proxy handles that for us.</p> <p><img src=\"https://andrewlock.net/content/images/2025/request_smuggling_05.svg\" alt=\"A request smuggling attack exploiting differences between a proxy and server implementation\"></p> <p>In this example the attacker creates a malformed chunk header with a chunk extension by sending <code>2;\\n</code>. The <code>;</code> ensures that both the proxy and and server treat the header as a chunk extension, but using <code>\\n</code> instead of <code>\\r\\n</code> results in differential parsing:</p> <ul><li>The proxy only sees a single request: <ul><li>It treats the <code>\\n</code> as a \"valid\" line-ending for the chunk header</li> <li>It then treats the <code>xx</code> as the chunk body</li> <li><code>47</code> is the next chunk header</li> <li>The next 71 bytes (<code>47</code> is hex, which is 71 in decimal) are treated as the chunk body.</li> <li>Finally there's the empty chunk block</li></ul> </li> <li>The server sees two requests: <ul><li>The server ignores the lone <code>\\n</code>, and skips all the way to <code>xx\\r\\n</code></li> <li>It then treats the <code>47</code> as the chunk body</li> <li>It sees an ending chunk,<code>0\\r\\n\\r\\n</code> and thinks the request is over</li> <li>The remaining data is treated as a completely separate request, which contains only an empty chunk in the body.</li></ul> </li></ul> <p>This is pretty much the simplest example, but you can essentially exploit this difference in all the ways I described previously. <em>Exactly</em> what the implications are for <em>your</em> application are hard to say, but given that all sorts of security bypass, credential stealing, and injection attacks are possible, it's easy to understand why the vulnerability received a CVSS rating of 9.9.</p> <blockquote> <p>One very interesting thing I found was looking at the security advisories for the same flaw in other HTTP implementations from other languages. In the python <a href=\"https://github.com/aio-libs/aiohttp\">aiohttp</a> and ruby <a href=\"https://github.com/puma/puma\">puma</a> servers, for example, give <a href=\"https://github.com/advisories/GHSA-8495-4g3g-x7pr\">the vulnerability only a moderate severity</a> rating in <a href=\"https://github.com/advisories/GHSA-c2f4-cvqm-65w2\">both cases</a>. In <a href=\"https://github.com/netty/netty\">netty</a> it's even given <a href=\"https://github.com/netty/netty/security/advisories/GHSA-fghv-69vj-qj49\">a low severity</a>.</p> <p>As far as I can tell, these servers are essentially vulnerable in the same way as ASP.NET Core is, so it's just an interesting data point, and I think reflects how Microsoft really want to make sure this gets the visibility it deserves and that customers patch their apps!</p> </blockquote> <h3 id=\"how-was-the-vulnerability-fixed-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#how-was-the-vulnerability-fixed-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">How was the vulnerability fixed?</a></h3> <p>As with most fixes for request-smuggling, the solution is to stop being lenient and/or ambiguous about how standalone line-endings are handled in chunk headers.</p> <p>In ASP.NET Core, <a href=\"https://github.com/dotnet/aspnetcore/pull/64037\">the PR that fixes the issue</a> does so by explicitly checking for <em>any</em> line-endings, instead of just looking for <code>\\r</code>. If it finds a line ending and it's <em>not</em> strictly <code>\\r\\n</code>, then Kestrel now throws a <code>KestrelBadHttpRequestException</code> and returns a <code>400</code> response.</p> <p><img src=\"https://andrewlock.net/content/images/2025/request_smuggling_06.png\" alt=\"A screenshot of the fix from the PR https://github.com/dotnet/aspnetcore/pull/64037\"></p> <blockquote> <p>I'll mention here there <em>is</em> an <code>AppContext</code> switch for <a href=\"https://github.com/dotnet/aspnetcore/blob/33ab51daf86b690432f44749824972c1f5019e83/src/Servers/Kestrel/Core/src/Internal/Http/Http1ChunkedEncodingMessageBody.cs#L31\"><em>opting-in</em> to the dangerous/vulnerable parsing behaviour</a> after you have patched your application, but please don't use it, I can't believe there's really a good (or <em>safe</em>) reason to.😅</p> </blockquote> <p>The vulnerability has been patched in ASP.NET Core, so what should you do?</p> <h2 id=\"what-should-you-do-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#what-should-you-do-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What should you do?</a></h2> <p>Obviously the <em>good</em> news here is that there is a fix for ASP.NET Core. As described <a href=\"https://github.com/dotnet/aspnetcore/issues/64033\">in the original issue</a>, the important thing is to update to the latest supported version of ASP.NET Core as soon as possible.</p> <blockquote> <p>There's no announced evidence of the request smuggling vulnerability being exploited in the wild, but given the vast number of ways that request smuggling <em>could</em> be used, would we even know? 🤔</p> </blockquote> <p>That means you should update your version of .NET 8, .NET 9, or .NET 10:</p> <table><thead><tr><th></th><th>Vulnerable versions</th><th>Lowest patched version</th></tr></thead><tbody><tr><td>.NET 10</td><td>10.0.0-rc1</td><td>10.0.0-rc2</td></tr><tr><td>.NET 9</td><td>9.0.0 - 9.0.9</td><td>9.0.10</td></tr><tr><td>.NET 8</td><td>8.0.0 - 8.0.20</td><td>8.0.21</td></tr></tbody></table> <p>If you're using ASP.NET Core 2.3 on .NET Framework, then you'll need to update your version of <em>Microsoft.AspNetCore.Server.Kestrel.Core</em>:</p> <table><thead><tr><th></th><th>Vulnerable versions</th><th>Lowest patched version</th></tr></thead><tbody><tr><td>Microsoft.AspNetCore.Server.Kestrel.Core</td><td>2.0.0-2.3.0</td><td>2.3.6</td></tr></tbody></table> <p>If you are doing self-contained deployments of your applications, you'll need to update to the patched versions and then redeploy your applications.</p> <p>And if you're using older versions of .NET Core? Well, then you <em>can't</em> patch… <a href=\"https://www.herodevs.com/\">HeroDevs</a> provide additional support for out-of-support versions of .NET (<a href=\"https://github.com/dotnet/aspnetcore/issues/64033#issuecomment-3411924593\">and have confirmed they'll be patching it in .NET 6</a>), but this vulnerability is present in basically <em>all</em> versions of .NET Core as far as I can tell. I've personally tested down to .NET Core 3.0 and I can confirm that the vulnerability is there <em>and there are no patches coming for you</em>. The best thing to do is to update to a supported version of .NET.</p> <blockquote> <p>⚠️ If you are running ASP.NET Core using &lt;=.NET Core 3.0, .NET Core 3.1, .NET 5, .NET 6 (<a href=\"https://www.herodevs.com/blog-posts/critical-asp-net-vulnerability-cve-2025-55315-reported-upgrade-now\">unless supported by HeroDevs</a>), or .NET 7, then you are vulnerable, and there are no patches. You should update to a supported version of .NET as soon as possible. Ironically, if you're stuck on old .NET Framework Web Forms or MVC applications <a href=\"https://github.com/dotnet/aspnetcore/issues/64033#issuecomment-3442910860\">you are apparently <em>not</em> vulnerable</a>.</p> </blockquote> <p>It's worth noting that if you are stuck on one of these old framework versions and <em>can't</em> upgrade, then probably the best way to protect yourself is to ensure that you have a proxy in front of your application which is confirmed to not be vulnerable (though obviously you are likely vulnerable to <em>other</em> exploits 😅).</p> <p>For example, <a href=\"https://azure.github.io/AppService/2025/10/20/dotnet-on-windows.html\">Azure App Services (AAS) confirmed</a> that applications running in AAS are no longer vulnerable, even if you haven't updated, because the proxy that AAS uses (itself a <a href=\"https://devblogs.microsoft.com/dotnet/bringing-kestrel-and-yarp-to-azure-app-services/\">YARP based ASP.NET Core proxy</a>) has been patched. By blocking the requests at the proxy level, ambiguous requests will never make it to your application, so you are protected.</p> <p>Unfortunately, right now, it's not clear exactly where you stand if you're using a service other than AAS for hosting your applications. Even IIS hasn't been confirmed to be safe or vulnerable at this point, but I did some unofficial testing on my Windows 11 box, and as fat as I can tell, it <em>is</em> vulnerable.</p> <blockquote> <p>Note that various people <a href=\"https://github.com/dotnet/aspnetcore/issues/64033#issuecomment-3445099135\">in the original issue</a> are attempting to test IIS by using the <code>Content-Length</code>/<code>Transfer-Encoding</code> version of request smuggling, which is not applicable here; we're interested in the chunk-extensions based version.</p> </blockquote> <p>Another interesting point is that this is vulnerability in HTTP/1.0 and HTTP/1.1 <em>only</em>; it is not a vulnerability in HTTP/2 or HTTP/3. HTTP/2 and HTTP/3 do not support chunked transfer encoding, and instead uses a different, more efficient, binary framing layer for data streaming. So another way to protect those applications which you <em>can't</em> upgrade may be to enforce that client's can <em>only</em> use HTTP/2 or HTTP/3. Be aware that's liable to break a <em>lot</em> of clients that are still using HTTP/1.1 though!</p> <blockquote> <p>You can configure the HTTP protocols allowed by Kestrel by configuring your Kestrel endpoints. <a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel/endpoints?view=aspnetcore-9.0#configure-http-protocols\">The documentation</a> shows various ways to do this.</p> </blockquote> <h2 id=\"how-to-know-if-you-re-affected-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#how-to-know-if-you-re-affected-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">How to know if you're affected?</a></h2> <p>The \"simplest\" way to know if you're affected is to check the version of .NET you're using to run your applications, using <code>dotnet --info</code> and verify that you're using one of the patched versions. If you are, you're safe. That's the only \"supported\" way to know that you're safe, and it's the one way I would recommend. As far as I can tell, there isn't currently a generalised tool to point at an application to find out if it's vulnerable, though it would likely be possible to write one.</p> <p>The folks at HeroDevs <a href=\"https://github.com/sirredbeard/CVE-2025-55315-repro\">re-implemented the functional tests</a> from the original ASP.NET Core fix as a console application compiled against multiple versions of ASP.NET Core. They used this to confirm that unpatched versions of .NET 8-.NET 10 are vulnerable, while <em>patched</em> versions are not. They also used this to verify .NET 6 is vulnerable, and I tweaked it to confirm everything down to at least .NET Core 3.0 is vulnerable.</p> <p>The <a href=\"https://github.com/sirredbeard/CVE-2025-55315-repro\">test in the repro</a> works by sending a chunked transfer encoding request to ASP.NET Core, with an invalid line ending in a chunk extension header. The vulnerability is identified by ASP.NET Core \"hanging\", waiting for more data, until it eventually times out. The \"fixed\" version immediately throws the <code>BadRequest</code> exception included in the fix.</p> <blockquote> <p>I <a href=\"https://www.youtube.com/watch?v=LE758TvUE5c\">saw some confusion</a> about this test online; the argument was \"if both the fixed and broken versions throw an exception, why does it matter\"? However, that's not the point of the test. The fact that Kestrel is paused waiting for more data indicates that a smuggled HTTP request <em>would</em> have been executed. You can see how this can be leveraged to exfiltrate data or attack other users both in <a href=\"https://w4ke.info/2025/06/18/funky-chunks.html#exploiting-live-users\">the chunk extensions blog</a> or <a href=\"https://portswigger.net/web-security/request-smuggling/exploiting\">on PortSwigger's site</a>.</p> </blockquote> <p>I used a similar approach to try to understand whether IIS might be vulnerable by sending the same crafted HTTP request to IIS and seeing if it hung until timing out: it did on my version of IIS (<code>10.0.26100.1882</code>):</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Send an HTTP request with an invalid chunk extension, and see</span>\n<span class=\"token comment\"># if it times out or if it's rejected with a 400... It times out 🙁</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"GET / HTTP/1.1<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>Host:<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>Transfer-Encoding: chunked<span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span><span class=\"token entity\" title=\"\\r\">\\r</span><span class=\"token entity\" title=\"\\n\">\\n</span>1;<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token operator\">|</span> <span class=\"token function\">nc</span> localhost <span class=\"token number\">80</span>\n</code></pre></div> <p>So does that definitely mean IIS is vulnerable? No, don't trust me, I'm not a security researcher 😅 But until you hear otherwise, I would play it safe and assume that IIS <em>won't</em> protect you from chunk extension request smuggling attacks. And in general, I would apply the same rules to any other proxies you are relying on in your infrastructure.</p> <p>And as a final reminder, even though request smuggling is typically described and demonstrated using a proxy in front of your server, just <em>not</em> using a proxy does <em>not</em> mean you're automatically safe. If you're reading, manipulating, or forwarding request streams directly in ASP.NET Core, as opposed to just relying on the built-in model binding, then you <em>might</em> be at risk to request smuggling attacks. It's best to play it safe, patch your apps, and wherever possible leave the complexity of manipulating requests to ASP.NET Core.</p> <p>In general, I would make sure to subscribe to <a href=\"https://github.com/dotnet/aspnetcore/issues/64033\">the ASP.NET Core issue on GitHub</a>, as it's likely that any more announcements around the issue will also be reported there.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I discuss the recent ASP.NET Core vulnerability: <a href=\"https://github.com/dotnet/aspnetcore/issues/64033\">Microsoft Security Advisory CVE-2025-55315: .NET Security Feature Bypass Vulnerability</a>. This advisory warns of a request smuggling vulnerability that affects basically all versions of ASP.NET Core.</p> <p>I described how request smuggling works in general, using a simple example of request smuggling to show how ambiguity in how HTTP is parsed can lead to HTTP proxies and HTTP servers in handling the same HTTP request in different ways. This can lead to the server seeing two requests where the proxy only sees a single request.</p> <p>After walking through a request smuggling example, I discussed some of the ways attackers could exploit a request smuggling vulnerability. That includes reflecting malicious data to other users of your app, exfiltrating authentication credentials or other data from client requests, invoking endpoints that shouldn't be publicly accessible, and various other attacks.</p> <p>Next I walked through the specific request smuggling vulnerability identified in CVE-2025-55315. This uses ambiguities in the parsing of chunk extensions when sending requests that use chunked transfer encoding. Chunk extensions are generally ignored by all servers, but lenient handling can lead to differential handling between proxy and server, providing an avenue for request smuggling.</p> <p>Finally, I walked through the mitigation steps you should take: patching your applications. I described the information we currently have about vulnerable or patched proxy servers, and how old versions of ASP.NET Core are not going to be getting patches, so will remain vulnerable (shout out again <a href=\"https://www.herodevs.com/blog-posts/critical-asp-net-vulnerability-cve-2025-55315-reported-upgrade-now\">to HeroDevs for supporting .NET 6</a>). If you're running in AAS, <a href=\"https://azure.github.io/AppService/2025/10/20/dotnet-on-windows.html\">then you're ok</a>, but otherwise, you need to check with your proxy provider to establish whether you are vulnerable or not.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/understanding-the-worst-dotnet-vulnerability-request-smuggling-and-cve-2025-55315/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/adding-metadata-to-fallback-endpoints-in-aspnetcore/",
      "Title": "Adding metadata to fallback endpoints in ASP.NET Core",
      "PublishDate": "2025-10-22T10:00:00+00:00",
      "Summary": "In this post I discuss fallback endpoints and show how adding metadata to MVC or Razor Page fallback endpoints has some quirks to be aware of",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/fallbackroutes_banner.png\" /><p>In this post I describe how metadata works for \"fallback\" endpoints in ASP.NET Core. First I briefly discuss the routing infrastructure of ASP.NET Core, and how you can add metadata to endpoints to drive other functionality. Next I describe what fallback endpoints are and why they are useful. Finally, I describe how adding metadata works for fallback endpoints, and why this might not work as you first expect for MVC and Razor Pages apps.</p> <h2 id=\"background-the-routing-infrastructure-in-asp-net-core\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/adding-metadata-to-fallback-endpoints-in-aspnetcore/#background-the-routing-infrastructure-in-asp-net-core\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Background: the routing infrastructure in ASP.NET Core</a></h2> <p>The routing infrastructure in ASP.NET Core is a fundamental component that sits as part of the middleware pipeline, it is the primary way that incoming URLs are mapped to \"handlers\" which are responsible for executing code and generating a response. For example, the following hello world app maps a single route <code>/</code> to a handler (the lambda method) which returns a string <code>\"Hello World!\"</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> WebApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> app <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapGet</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"Hello World!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>It's not apparent from this simple example, but routing in ASP.NET Core is driven by <em>two</em> main pieces of middleware:</p> <ul><li><code>EndpointRoutingMiddleware</code>—This middleware chooses which registered endpoint to execute for a given request at runtime. It's sometimes referred to as <code>RoutingMiddleware</code> (which is the name I use in this post).</li> <li><code>EndpointMiddleware</code>—This middleware is typically placed at the end of the middleware pipeline. The middleware executes the endpoint selected by the <code>RoutingMiddleware</code> for a given request.</li></ul> <blockquote> <p>Prior to .NET 6, you would typically add these middleware to your pipeline explicitly by calling <code>UseRouting()</code> and <code>UseEndpoints()</code>. However <code>WebApplication</code> adds these for your automatically, so the explicit calls generally aren't required. I described in more detail how <code>WebApplication</code> works and how it compares to the \"traditional\" <code>Startup</code> approach in <a href=\"https://andrewlock.net/exploring-dotnet-6-part-4-building-a-middleware-pipeline-with-webapplication/#a-hello-world-pipeline\">previous posts</a>.</p> </blockquote> <p>You might wonder why ASP.NET Core uses two pieces of middleware instead of just one. Separating the <em>selection</em> of an endpoint from the <em>execution</em> of an endpoint gives a specific advantage—you can execute middleware <em>between</em> these two events. This middleware can change its behaviour based on <em>metadata</em> associated with the endpoint that is going to be executed, <em>before</em> that endpoint executes.</p> <h2 id=\"adding-metadata-to-endpoints-to-control-functionality\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/adding-metadata-to-fallback-endpoints-in-aspnetcore/#adding-metadata-to-endpoints-to-control-functionality\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Adding metadata to endpoints to control functionality</a></h2> <p>As already described, endpoint routing is a core feature of ASP.NET Core. Adding <em>metadata</em> to specific endpoints is important for controlling the behaviour of different endpoints.</p> <p>There are several features that rely on metadata to work correctly. The most common examples are the <code>AuthorizationMiddleware</code> and <code>CorsMiddleware</code>, which must be placed <em>between</em> the <code>RoutingMiddleware</code> and <code>EndpointMiddleware</code> so that they know which policies to apply for the selected endpoint.</p> <p><img src=\"https://andrewlock.net/content/images/2019/endpoint_routing.svg\" alt=\"Image of routing in ASP.NET Core \"></p> <p>For example, you might have a global authorization requirement policy which applies to all endpoints in your application. You would then apply specific \"Allow anonymous access\" policies to the \"login\" and \"forgotten password\" endpoints so they can be accessed when you're not logged in.</p> <p>For this functionality to work, you need to apply metadata to the login and forgot password policies. You typically apply metadata in one of two ways:</p> <ul><li>Adding attributes, e.g. <code>[AllowAnonymous]</code> or <code>[Authorize]</code>, to an MVC action or Razor Page.</li> <li>Using an extension method, e.g. <code>AllowAnonymous()</code> or <code>RequireAuthorization()</code> to a minimal API or other endpoint.</li></ul> <p>When the <code>RoutingMiddleware</code> endpoint executes, it selects the endpoint that will execute. Subsequent middleware can then inspect the endpoint details to see if there's any attached middleware and act accordingly.</p> <p>Let's look at the authorization case again. Calling the <code>AllowAnonymous()</code> method, for example, <a href=\"https://github.com/dotnet/aspnetcore/blob/d4349298d046f24282a6030d8935e81aa2440141/src/Security/Authorization/Policy/src/AuthorizationEndpointConventionBuilderExtensions.cs#L125\">adds an instance of the <code>AllowAnonymousAttribute</code> as metadata to the endpoint</a>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthorizationEndpointConventionBuilderExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">IAllowAnonymous</span> _allowAnonymousMetadata <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AllowAnonymousAttribute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\">TBuilder</span> <span class=\"token generic-method\"><span class=\"token function\">AllowAnonymous</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TBuilder<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">TBuilder</span> builder<span class=\"token punctuation\">)</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">TBuilder</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IEndpointConventionBuilder</span></span>\n    <span class=\"token punctuation\">{</span>\n        builder<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>endpointBuilder <span class=\"token operator\">=&gt;</span>\n        <span class=\"token punctuation\">{</span>\n            endpointBuilder<span class=\"token punctuation\">.</span>Metadata<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>_allowAnonymousMetadata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> builder<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>Similarly, calling <code>RequireAuthorization()</code> <a href=\"https://github.com/dotnet/aspnetcore/blob/d4349298d046f24282a6030d8935e81aa2440141/src/Security/Authorization/Policy/src/AuthorizationEndpointConventionBuilderExtensions.cs#L21\">adds an instance of the <code>AuthorizeAttribute</code></a> as metadata:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthorizationEndpointConventionBuilderExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\">TBuilder</span> <span class=\"token generic-method\"><span class=\"token function\">RequireAuthorization</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TBuilder<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">TBuilder</span> builder<span class=\"token punctuation\">)</span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">TBuilder</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IEndpointConventionBuilder</span></span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">RequireAuthorization</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AuthorizeAttribute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The <code>AuthorizationMiddleware</code>, which runs after the <code>RoutingMiddleware</code> and before the <code>EndpointMiddleware</code>, can inspect the selected endpoint and read this metadata to decide what authorization policies to apply to the selected endpoint.</p> <h2 id=\"trying-it-out-in-a-sample-app\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/adding-metadata-to-fallback-endpoints-in-aspnetcore/#trying-it-out-in-a-sample-app\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Trying it out in a sample app</a></h2> <p>We can try this all out in a simple minimal API app that just shows the basics:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>AspNetCore<span class=\"token punctuation\">.</span>Authorization</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> WebApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Configure basic cookie authentication (so that authorization works)</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AddCookie</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddAuthorization</span><span class=\"token punctuation\">(</span>opt <span class=\"token operator\">=&gt;</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Unless specified, you must be logged in to be authorized</span>\n    opt<span class=\"token punctuation\">.</span>FallbackPolicy <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AuthorizationPolicyBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                            <span class=\"token punctuation\">.</span><span class=\"token function\">RequireAuthenticatedUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                            <span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> app <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapGet</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"Hello World!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// You can't view this unless logged in</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapGet</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/Account/Login\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"Login page\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AllowAnonymous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// You can always view this</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>This is a simple minimal API that has two endpoints:</p> <ul><li><code>/</code> the home page</li> <li><code>/Account/Login</code> which is the login page</li></ul> <p>For this app I added rudimentary authentication and authorization. I've not added any way to actually sign in or anything, literally I've just configured the minimum requirements. We then configure a global policy that says \"unless otherwise specified, you must be logged in to be authorized to view the page\".</p> <p>The result is that if we try to run the app, and navigate to <code>/</code>, We're automatically redirected to the <code>/Account/Login</code> page, because we're not (and can't be) logged in. However, we <em>can</em> view the <code>/Account/Login</code> page, because it's decorated with <code>AllowAnonymous()</code> metadata.</p> <p><img src=\"https://andrewlock.net/content/images/2025/fallbackroutes_01.png\" alt=\"The authorization metadata prevents directly accessing /, but allows accessing the /Acount/Login route\"></p> <p>Many cross-cutting features which are implemented in middleware but which must behave differently for specific endpoints use this metadata approach. Authorization is the canonical example, but <a href=\"https://learn.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-9.0\">CORS policies</a>, <a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/openapi/aspnetcore-openapi?view=aspnetcore-9.0\">OpenAPI documentation</a>, <a href=\"https://github.com/andrewlock/NetEscapades.AspNetCore.SecurityHeaders\">or my security headers library</a> work in similar ways.</p> <h2 id=\"fallback-routing-in-asp-net-core\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/adding-metadata-to-fallback-endpoints-in-aspnetcore/#fallback-routing-in-asp-net-core\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Fallback routing in ASP.NET Core</a></h2> <p>Routing is a core component of ASP.NET Core, and consists of many distinct concepts. For example:</p> <ul><li><strong>Route patterns</strong>—This is the URL path pattern that should be matched to an incoming request.</li> <li><strong>Handlers</strong>—Every route pattern has an associated handler which is is the code that runs to generate a response when the pattern matches an incoming request.</li> <li><strong>Route parameters</strong>—These are variable sections in a route pattern that can be extracted and automatically converted to types for use in your handlers.</li> <li><strong>Binding</strong>—You can automatically extract details from an incoming request for use in your handlers</li></ul> <p>and many more! These features manifest to greater or lesser extent whichever part of ASP.NET Core you're using, whether it's MVC, Razor Pages, Blazor, or minimal APIs.</p> <p>The fundamental first step of routing is deciding <em>which</em> route pattern the incoming URL matches. This is done by building a graph of the registered endpoints and then finding the correct match for the incoming URL:</p> <p><img src=\"https://andrewlock.net/content/images/2020/graphs_2_01.png\" alt=\"A ValuesController endpoint routing application\"></p> <blockquote> <p>I discussed how ASP.NET Core creates an endpoint graph and how you can visualize that graph in my series <a href=\"https://andrewlock.net/series/visualizing-asp-net-core-3-endpoints-using-graphvizonline/\">Visualizing ASP.NET Core 3.0 endpoints using GraphvizOnline</a>.</p> </blockquote> <p>Each route is associated with a handler, but there's also the concept of a <em>fallback</em> route. This route matches <em>any</em> incoming request, as long as the request is <em>not</em> matched by any other route, and it invokes the provided handler.</p> <p>There are many different ways to add a fallback route to your app, and in general it will depend which part of ASP.NET Core you're using; minimal APIs, MVC, Razor Pages etc. The simplest approach is to call the <code>MapFallback()</code> method, and provide a handler to execute directly. For example, we could add a fallback endpoint to my previous sample:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> app <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapGet</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"Hello World!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapGet</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/Account/Login\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"Login page\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AllowAnonymous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapFallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"Fallback\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 👈 Add this</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Now, if we run the app and hit any random URL, we're redirected to the <code>/Account/Login</code> page. That's because our fallback \"you must be logged in\" authorization policy kicks in, and redirects us. In the image below you can see that <code>/random-url</code> was matched, but redirected automatically to our login page:</p> <p><img src=\"https://andrewlock.net/content/images/2025/fallbackroutes_02.png\" alt=\"The fallback route /random-url was automatically redirected\"></p> <p>It's probably more common to have your fallback route redirect to an <em>existing</em> endpoint, whether that's a file, an MVC controller, or a Razor Page. The most common reason for using a fallback route like this is for handling SPA applications. Many SPA applications <a href=\"https://weblog.west-wind.com/posts/2020/Jul/12/Handling-SPA-Fallback-Paths-in-a-Generic-ASPNET-Core-Server#client-side-navigation\">handle \"routing\" on the client-side</a> and generate nice, normal looking routes. However, if the client refreshes the page then the \"incorrect\" path is sent as a request to ASP.NET Core.</p> <p>For example, the client side SPA app might send a request to <code>/something/customers/123</code>, but that doesn't necessarily <em>mean</em> anything to your application. Instead, in that scenario, you often need to return your \"home page\", have the SPA app run its boot up code and then do the routing on the client-side.</p> <p>Exactly what \"return your 'home page'\" means will depend on your app, but there's probably a <code>MapFallback*</code> overload for you: For example:</p> <ul><li><code>MapFallbackToFile(string filepath)</code> returns a file e.g. <code>Index.html</code> when there's no match for a route.</li> <li><code>MapFallbackToPath(string page)</code> executes the given Razor Page as the fallback.</li> <li><code>MapFallbackToController(string action, string controller)</code> executes the indicated MVC controller and action as the fallback.</li></ul> <p>All these <code>MapFallback()</code> overloads seem similar, but they actually behave somewhat differently when it comes to metadata, as we'll look at in the next section.</p> <h2 id=\"fallback-routing-and-metadata-for-simple-endpoints\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/adding-metadata-to-fallback-endpoints-in-aspnetcore/#fallback-routing-and-metadata-for-simple-endpoints\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Fallback routing and metadata for simple endpoints</a></h2> <p>We can explore the differences in metadata handling by thinking about the same simple authorization app we've been looking at so far. To test how metadata works, we can simply add an <code>AllowAnonymous()</code> call to our <code>MapFallback()</code> methods. For example, taking our initial <code>MapFallback()</code> example:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>AspNetCore<span class=\"token punctuation\">.</span>Authorization</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> WebApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AddCookie</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddAuthorization</span><span class=\"token punctuation\">(</span>opt <span class=\"token operator\">=&gt;</span>\n<span class=\"token punctuation\">{</span>\n    opt<span class=\"token punctuation\">.</span>FallbackPolicy <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AuthorizationPolicyBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                            <span class=\"token punctuation\">.</span><span class=\"token function\">RequireAuthenticatedUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                            <span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> app <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapGet</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"Hello World!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapGet</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/Account/Login\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"Login page\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AllowAnonymous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapFallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"Fallback\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AllowAnonymous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                                 <span class=\"token comment\">// 👆 Add this</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>All I've added in this case is the <code>AllowAnonymous()</code> call to the <code>MapFallback()</code> configuration. Prior to adding the <code>AllowAnonymous()</code>, call, hitting a random URL would result in an unauthorized request, and we would be redirected to the <code>/Account/Login</code> endpoint. However, by adding <code>AllowAnonymous()</code>, we've added metadata to the fallback endpoint which means that the endpoint <em>is</em> authorized, and executes for a random URL:</p> <p><img src=\"https://andrewlock.net/content/images/2025/fallbackroutes_03.png\" alt=\"The fallback endpoint is allowed to execute\"></p> <p>Similarly, with the <code>MapFallbackToFile()</code> method, adding <code>AllowAnonymous()</code> attaches metadata to this fallback endpoint. Changing the above <code>MapFallback()</code> call to <code>MapFallbackToFile(\"index.html\")</code> (and adding an <em>index.html</em> file to the application in the <em>wwwroot</em> folder) gives the same result; hitting any unknown URL returns the <em>index.html</em> file:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">app<span class=\"token punctuation\">.</span><span class=\"token function\">MapFallbackToFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"index.html\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AllowAnonymous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p><img src=\"https://andrewlock.net/content/images/2025/fallbackroutes_04.png\" alt=\"The fallback file is also allowed to execute\"></p> <p>You would be forgiven for thinking that the Razor Page and MVC based fallback methods behaved in a similar way, but somewhat surprisingly, they don't!</p> <h2 id=\"fallback-routing-and-metadata-for-razor-pages-and-mvc\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/adding-metadata-to-fallback-endpoints-in-aspnetcore/#fallback-routing-and-metadata-for-razor-pages-and-mvc\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Fallback routing and metadata for Razor Pages and MVC</a></h2> <p>To show this in action, I created a tiny Razor Pages app, and added three very simple Razor Pages, which are somewhat equivalent to the minimal API version above:</p> <p><em>/Index.chstml</em>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-cshtml\"><code class=\"language-cshtml\"><span class=\"token directive\"><span class=\"token keyword\">@page</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">&gt;</span></span>Index<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p><em>/Account/Login.chstml</em> - note the <code>[AllowAnonymous]</code> attribute here to allow anonymous access</p> <div class=\"pre-code-wrapper\"><pre class=\"language-cshtml\"><code class=\"language-cshtml\"><span class=\"token directive\"><span class=\"token keyword\">@page</span></span>\n<span class=\"token directive\"><span class=\"token keyword\">@attribute</span> <span class=\"token csharp language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Microsoft<span class=\"token punctuation\">.</span>AspNetCore<span class=\"token punctuation\">.</span>Authorization<span class=\"token punctuation\">.</span>AllowAnonymous</span></span><span class=\"token punctuation\">]</span></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">&gt;</span></span>Login<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>And finally <em>/Fallback.cshtml</em>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-cshtml\"><code class=\"language-cshtml\"><span class=\"token directive\"><span class=\"token keyword\">@page</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">&gt;</span></span>Fallback<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>I then added the same authentication and authorization services as before to the Razor pages app, and added a fallback mapping using <code>MapFallbackToPage(\"/Fallback\")</code>, and marked that fallback route with <code>AllowAnonymous()</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>AspNetCore<span class=\"token punctuation\">.</span>Authorization</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> WebApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddRazorPages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// same authentication and authorization services as before</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AddCookie</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddAuthorization</span><span class=\"token punctuation\">(</span>opt <span class=\"token operator\">=&gt;</span>\n<span class=\"token punctuation\">{</span>\n    opt<span class=\"token punctuation\">.</span>FallbackPolicy <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AuthorizationPolicyBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">RequireAuthenticatedUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> app <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Standard Razor Pages stuff</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">UseRouting</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">UseAuthorization</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapStaticAssets</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapRazorPages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">WithStaticAssets</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Add a fallback page and try to mark it as allow anonymous</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapFallbackToPage</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/Fallback\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AllowAnonymous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Overall this is essentially the Razor Pages equivalent of the minimal API app from before. Consequently, if we navigate to <code>/Index</code>, the authorization policy means we get redirected to the <code>/Account/Login</code> page. That page has the <code>[AllowAnonymous]</code> attribute, so we can view that page:</p> <p><img src=\"https://andrewlock.net/content/images/2025/fallbackroutes_05.png\" alt=\"The /Index page redirects to /Account/Login\"></p> <p>Now let's try hitting the fallback route by trying a random URL. Seeing as we marked the fallback route as <code>AllowAnonymous()</code> then we should see the <code>/Fallback</code> page, right?</p> <p><img src=\"https://andrewlock.net/content/images/2025/fallbackroutes_06.png\" alt=\"The fallback route still redirects to /Account/Login too\"></p> <p>Hmmm… that's not right 🤔 It seems like the <code>AllowAnonymous()</code> call on the <code>MapFallbackToPage()</code> definition isn't working?!</p> <p>The explanation is a little more nuanced…</p> <h2 id=\"why-doesn-t-allowanonymous-work-on-mapfallbacktopage-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/adding-metadata-to-fallback-endpoints-in-aspnetcore/#why-doesn-t-allowanonymous-work-on-mapfallbacktopage-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Why doesn't <code>AllowAnonymous()</code> work on <code>MapFallbackToPage()</code>?</a></h2> <p><a href=\"https://github.com/dotnet/aspnetcore/blob/main/src/Http/Routing/src/Builder/EndpointRouteBuilderExtensions.cs#L390\">The <code>MapFallback()</code></a> and <code>MapFallbackToFile()</code> calls <a href=\"https://github.com/dotnet/aspnetcore/blob/main/src/Middleware/StaticFiles/src/StaticFilesEndpointRouteBuilderExtensions.cs#L54-L56\">are actually registering <em>new</em> endpoints</a>; they have a catch-all route pattern and a handler, and the metadata gets associated to this new endpoint.</p> <p><code>MapFallbackToPage()</code> and <code>MapFallbackToController()</code> work <a href=\"https://github.com/dotnet/aspnetcore/blob/cf40577071ca80f7396e702a75212ed0f7ff8f54/src/Mvc/Mvc.RazorPages/src/Builder/RazorPagesEndpointRouteBuilderExtensions.cs#L139-L147\">slightly differently</a>. These do add an extra endpoint, but the endpoint is added with additional <code>DynamicPageMetadata</code> metadata (for Razor Pages) or <code>DynamicControllerMetadata</code> metadata (for MVC). The Razor Pages/MVC infrastructure then finds this metadata and uses it to select a <em>different</em> endpoint to execute. <em>That's</em> the endpoint selected by the routing infrastructure, not the \"original\" fallback endpoint.</p> <p>This all means that <a href=\"https://github.com/dotnet/aspnetcore/issues/14679#issuecomment-537715318\">the \"fallback\" endpoint is essentially <em>replaced</em> by the real page it points to</a>. Which <em>also</em> means that any metadata you add to that fallback endpoint is <em>lost</em> when it's actually invoked, which includes the <code>AllowAnonymous()</code> call! In other words, calling <code>AllowAnonymous()</code> (or adding any <em>other</em> metadata) on a <code>MapFallbackToPage()</code> or <code>MapFallbackToController()</code> call does nothing.</p> <p>To make our fallback page behave like we want it to, we have to add the <code>[AllowAnonymous]</code> attribute to the <em>destination</em> page instead, to the <code>/Fallback</code> page:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-cshtml\"><code class=\"language-cshtml\"><span class=\"token directive\"><span class=\"token keyword\">@page</span></span>\n<span class=\"token directive\"><span class=\"token keyword\">@attribute</span> <span class=\"token csharp language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Microsoft<span class=\"token punctuation\">.</span>AspNetCore<span class=\"token punctuation\">.</span>Authorization<span class=\"token punctuation\">.</span>AllowAnonymous</span></span><span class=\"token punctuation\">]</span></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">&gt;</span></span>Fallback<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>After making that change, now if we hit a random URL we <em>can</em> access the page, because the <em>destination</em> has the required metadata:</p> <p><img src=\"https://andrewlock.net/content/images/2025/fallbackroutes_07.png\" alt=\"After adding the allow anonymous to the destination, it works\"></p> <p>And that pretty much covers it. Just remember that if you need to add metadata to a fallback Razor Page or MVC controller, then you must add it to the <em>destination</em> endpoint, not the \"fallback\" endpoint itself.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/adding-metadata-to-fallback-endpoints-in-aspnetcore/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I briefly described the routing infrastructure of ASP.NET Core, and how you can add metadata to endpoints to drive other functionality. Next I describe what fallback endpoints are and why they are useful. Finally, I showed how adding metadata works differently when creating fallback endpoints using <code>MapFallbackToPage()</code> and <code>MapFallbackToController()</code>.</p> <p>For these cases, the fallback endpoint is replaced by the real <em>destination</em> endpoint. Consequently, if you want to add metadata to these endpoints, you must add it to the destination endpoint <em>not</em> the fallback endpoint.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/adding-metadata-to-fallback-endpoints-in-aspnetcore/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/easily-publishing-nuget-packages-from-github-actions-with-trusted-publishing/",
      "Title": "Publishing NuGet packages from GitHub actions the easy way with Trusted Publishing",
      "PublishDate": "2025-09-30T10:00:00+00:00",
      "Summary": "In this post I describe how you can use nuget.org's new Trusted Publishing feature to publish NuGet packages from a GitHub Actions workflow",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/trusted_publishing_banner.png\" /><p>In this post I describe how you can use <a href=\"https://www.nuget.org/\">nuget.org</a>'s <a href=\"https://devblogs.microsoft.com/dotnet/enhanced-security-is-here-with-the-new-trust-publishing-on-nuget-org/\">new Trusted Publishing feature</a> to publish NuGet packages from a GitHub Actions workflow, <em>without</em> having to generate and store API keys, while simultaneously benefiting from improved security.</p> <h2 id=\"how-do-you-push-nuget-packages-today-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/easily-publishing-nuget-packages-from-github-actions-with-trusted-publishing/#how-do-you-push-nuget-packages-today-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">How do you push NuGet packages today?</a></h2> <p>If you're someone that creates NuGet packages and pushes them to <a href=\"https://www.nuget.org/\">nuget.org</a> today, then you're probably doing so in one of several ways:</p> <ul><li>Building the packages locally and manually uploading them to <a href=\"https://www.nuget.org\">nuget.org</a>.</li> <li>Building the packages in CI, downloading them, and manually uploading them to <a href=\"https://www.nuget.org\">nuget.org</a>.</li> <li>Building the packages in CI, and pushing them directly to <a href=\"https://www.nuget.org\">nuget.org</a> from CI.</li></ul> <p>Each of these approaches is progressively \"better\" in that they generally improve the consistency of your builds and reduce the number of manual steps you require. However, pushing your <em>.nupkg</em> files to NuGet from CI is also somewhat \"harder\" than just uploading them locally, via the <a href=\"https://www.nuget.org/packages/manage/upload\">nuget.org website</a>.</p> <p>Instead of just dragging-and-dropping your package onto the web page, you now need to:</p> <ul><li>Generate an API key</li> <li>Store it <em>securely</em> in GitHub Actions (e.g. as a Secret)</li> <li>Pass the secret in your GitHub Actions workflow</li> <li>Rotate the secret whenever it changes</li> <li>Make sure others in your organisation can do the same (if you're publishing packages for an org)</li></ul> <p>None of that is insurmountable, but managing the lifecycle of long-lived secrets <a href=\"https://www.bleepingcomputer.com/news/security/over-12-million-auth-secrets-and-keys-leaked-on-github-in-2023/\">is notoriously difficult</a>. And that's where Trusted Publishing steps in.</p> <h2 id=\"what-is-trusted-publishing-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/easily-publishing-nuget-packages-from-github-actions-with-trusted-publishing/#what-is-trusted-publishing-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What is Trusted Publishing?</a></h2> <p>Trusted Publishing is an initiative that's been in place for many ecosystems for a while. For example Python has it for PyPI, Ruby has it for RubyGems.org, and JavaScript has it for npm. And as of last week, .NET has Trusted Publishing for <a href=\"https://www.nuget.org\">nuget.org</a> 🎉</p> <p><a href=\"https://repos.openssf.org/trusted-publishers-for-all-package-repositories\">Trusted Publishing</a> is an approach that uses existing authentication standards (<a href=\"https://openid.net/developers/how-connect-works/\">OpenID Connect</a>) to connect CI infrastructure provides (such as GitHub Actions or GitLab Pipelines) with public package repositories (like PyPI and <a href=\"https://www.nuget.org\">nuget.org</a>). Instead of needing to store and manage API keys so that the two systems can talk to each other, you use OpenID Connect to retrieve short-lived authentication tokens, which you can then use to push packages to the package repository.</p> <p>Exactly how this works will vary by provider and package repository, but the overall flow is the same. For GitHub actions and <a href=\"https://www.nuget.org\">nuget.org</a>, it looks something like this:</p> <ul><li>The user configures a \"trust policy\" on <a href=\"https://www.nuget.org\">nuget.org</a>.</li> <li>In a CI workflow, you retrieve an OpenID Connect token for the job from GitHub. <ul><li>In this example, GitHub is the Identity Provider (IdP).</li> <li>The token is a signed JSON Web Token (JWT), which includes details about the repository and the workflow that's running.</li></ul> </li> <li>You send the token to <a href=\"https://www.nuget.org\">nuget.org</a>, exchanging the token for an API key. <ul><li>NuGet.org verifies the contents of the JWT against the configured trust policy.</li> <li>If everything matches up, <a href=\"https://www.nuget.org\">nuget.org</a> issues a short-lived API token that can be used to publish packages.</li></ul> </li> <li>The CI workflow uses the API token to push the <em>.nupkg</em> packages to <a href=\"https://www.nuget.org\">nuget.org</a>.</li></ul> <figure> <picture> <img src=\"https://andrewlock.net/content/images/2025/trusted_publishing_01.png\"> </picture><figcaption>Diagram of Trusted Publishers flow. From <a href=\"https://repos.openssf.org/trusted-publishers-for-all-package-repositories\">Trusted Publishers for All Package Repositories</a>.</figcaption></figure> <p>Because the trust-policy is configured ahead of time, and you're <em>already</em> authenticated with GitHub (due to running in their infrastructure) it's pretty easy to get up and running.</p> <h2 id=\"configuring-trusted-publishing-on-nuget-org\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/easily-publishing-nuget-packages-from-github-actions-with-trusted-publishing/#configuring-trusted-publishing-on-nuget-org\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Configuring Trusted Publishing on NuGet.org</a></h2> <p>Once I saw the blog post, I decided to give it a try for <a href=\"https://andrewlock.net/sleep-pc-a-dotnet-tool-to-make-windows-sleep-after-a-timeout/\">my new sleep-pc tool</a>, seeing as I hadn't set up CI for it yet. I'll start by showing the workflow <em>without</em> NuGet publishing, to provide the baseline, and then show the steps I took to add publishing via Trusted Publishing.</p> <h3 id=\"the-workflow-starting-point\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/easily-publishing-nuget-packages-from-github-actions-with-trusted-publishing/#the-workflow-starting-point\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The workflow starting point</a></h3> <p>The initial workflow, without publishing, is shown below. This is stored in the file <code>.github/workflows/BuildAndPack.yml</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> BuildAndPack\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build-and-publish</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">permissions</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">contents</span><span class=\"token punctuation\">:</span> read\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> windows<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>dotnet@v4\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">dotnet-version</span><span class=\"token punctuation\">:</span> 10.0.x\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dotnet pack\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          dotnet pack\n          dotnet pack -r win-x64</span>\n</code></pre></div> <p>This just does 3 things:</p> <ul><li>Checkout the repo</li> <li>Install .NET 10</li> <li>Run <code>dotnet pack</code></li></ul> <p>It's worth nothing that I added the <code>permissions</code> entry to limit the permissions to reading from the repository <a href=\"https://docs.github.com/en/actions/tutorials/authenticate-with-github_token#modifying-the-permissions-for-the-github_token\">as a security best practice</a>. This isn't required, but I added it mostly to show what needs to change when we use trusted publishing.</p> <h3 id=\"updating-the-workflow-to-add-trusted-publishing-support\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/easily-publishing-nuget-packages-from-github-actions-with-trusted-publishing/#updating-the-workflow-to-add-trusted-publishing-support\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Updating the workflow to add Trusted Publishing support</a></h3> <p>To add trusted publishing, we need to do three things:</p> <ul><li>Add the <code>id-token: write</code> permission.</li> <li>Use <code>NuGet/login@v1</code> to exchange an OIDC token for a NuGet API key.</li> <li>Use the generated API key to push the packages to NuGet</li></ul> <p>The following shows the updated workflow, with comments highlighting the differences:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> BuildAndPack\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build-and-publish</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">permissions</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">contents</span><span class=\"token punctuation\">:</span> read\n      <span class=\"token key atrule\">id-token</span><span class=\"token punctuation\">:</span> write  <span class=\"token comment\"># enable GitHub OIDC token issuance for this job</span>\n\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> windows<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>dotnet@v4\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">dotnet-version</span><span class=\"token punctuation\">:</span> 10.0.x\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dotnet pack\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          dotnet pack\n          dotnet pack -r win-x64</span>\n\n      <span class=\"token comment\"># Use the ambient GitHub token to login to NuGet and retrieve an API key</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> NuGet login (OIDC → temp API key)\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> NuGet/login@v1\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> login\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token comment\"># Secret is your NuGet username, e.g. andrewlock</span>\n          <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NUGET_USER <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> push to NuGet\n        <span class=\"token comment\"># Only push to NuGet if we're building a tag (optional)</span>\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> startsWith(github.ref<span class=\"token punctuation\">,</span> 'refs/tags/')\n        <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> pwsh\n        <span class=\"token comment\"># Loop through all the packages in the output folder and push them to</span>\n        <span class=\"token comment\"># nuget.org, using the NUGET_API_KEY generated by the previous login step</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          Get-ChildItem artifacts/package/release -Filter *.nupkg | ForEach-Object {\n            dotnet nuget push $_.FullName `\n              --api-key \"${{ steps.login.outputs.NUGET_API_KEY }}\" `\n              --source https://api.nuget.org/v3/index.json\n          }</span>\n</code></pre></div> <p>In this workflow, the only secret you need to configure is the <code>NUGET_USER</code> secret, which should be set to your <a href=\"https://www.nuget.org\">nuget.org</a> <em>username</em> (not your email address). Given that it's public information anyway, storing it in a secret seems a tad overkill, but why not 😄</p> <p><img src=\"https://andrewlock.net/content/images/2025/trusted_publishing.png\" alt=\"Add the NUGET_USER name to your repo\"></p> <p>If you run this workflow now, the <code>NuGet login</code> step will fail with an error like the following:</p> <div class=\"pre-code-wrapper\"><pre><code>Requesting GitHub OIDC token from: https://run-actions-1-azure-eastus.actions.githubusercontent.com/100//idtoken/aae150a5-757c-411a-b2b0-f82a9b26401f/1943e299-9d47-50e7-8d56-90681c654f24?api-version=2.0&amp;audience=https%3A%2F%2Fwww.nuget.org\nError: Token exchange failed (401): No matching trust policy owned by user '***' was found.\n</code></pre></div> <p>As you can see from the message, the stage failed because we haven't yet configured a trust policy on <a href=\"https://www.nuget.org\">nuget.org</a>, so that's our next job.</p> <h3 id=\"configuring-a-trust-policy-on-nuget-org\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/easily-publishing-nuget-packages-from-github-actions-with-trusted-publishing/#configuring-a-trust-policy-on-nuget-org\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Configuring a trust policy on NuGet.org</a></h3> <p>Configuring a trust policy is very easy. We start by signing in at <a href=\"https://www.nuget.org/\">nuget.org</a> and navigating to <a href=\"https://www.nuget.org/account/trustedpublishing\">the Trusted Publishing page</a>:</p> <p><img src=\"https://andrewlock.net/content/images/2025/trusted_publishing_02.png\" alt=\"The Trusted Publishing page is available in the account menu\"></p> <p>Click <strong>Create</strong> to create a new policy, and fill in all the required fields:</p> <ul><li>A name for the policy. I think it makes sense to be the name of the package/github repo.</li> <li>The package owner (whether it's an individual account or an organisation)</li> <li>The GitHub repository details (owner and repository)</li> <li>The workflow file that will be pushing to Nuget</li></ul> <p>You can see how I completed this for my sleep-pc tool below:</p> <p><img src=\"https://andrewlock.net/content/images/2025/trusted_publishing_03.png\" alt=\"The configured details for the sleep-pc tool\"></p> <p>Once you've created the trust policy, it exists in a \"partially\" active state until you <em>use</em> the policy</p> <p><img src=\"https://andrewlock.net/content/images/2025/trusted_publishing_04.png\" alt=\"The partially active policy\"></p> <p>Now if you run the workflow again the login step is successful:</p> <div class=\"pre-code-wrapper\"><pre><code>Requesting GitHub OIDC token from: https://run-actions-1-azure-eastus.actions.githubusercontent.com/73//idtoken/21d84c5d-b6a5-49e0-bc04-e46694e083df/b3fac26f-8847-5e96-b7ae-47d656a98f51?api-version=2.0&amp;audience=https%3A%2F%2Fwww.nuget.org\nSuccessfully exchanged OIDC token for NuGet API key.\n</code></pre></div> <p>and the policy has changed to be fully active:</p> <p><img src=\"https://andrewlock.net/content/images/2025/trusted_publishing_05.png\" alt=\"The fully active policy\"></p> <p>Assuming everything else goes to plan, in the next step your package will be published to NuGet, no long-lived API keys required 🎉</p> <h2 id=\"wrapping-up\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/easily-publishing-nuget-packages-from-github-actions-with-trusted-publishing/#wrapping-up\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Wrapping up</a></h2> <p>As far as I can tell, as of today, there's no additional benefits from using trusted publishing on <a href=\"https://www.nuget.org\">nuget.org</a>, aside from the ease of publishing, and the lack of long-lived credentials. I can certainly foresee additional benefits in the future, with packages pushed via trusted publishing having additional verification marks. For example, maybe there will be some <a href=\"https://andrewlock.net/creating-provenance-attestations-for-nuget-packages-in-github-actions/\">tie-in to provenance attestations</a> in the future? I guess we'll wait and see!</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/easily-publishing-nuget-packages-from-github-actions-with-trusted-publishing/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I discussed <a href=\"https://repos.openssf.org/trusted-publishers-for-all-package-repositories\">Trusted Publishing</a> and how it can help by avoiding the need to store long-lived credentials in your GitHub repositories. I then showed how I configured publishing of my sleep-pc package from my <a href=\"https://github.com/andrewlock/sleep-pc\">GitHub repository</a> to <a href=\"https://www.nuget.org/packages/sleep-pc\">nuget.org</a> using Trusted Publishing.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/easily-publishing-nuget-packages-from-github-actions-with-trusted-publishing/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/sleep-pc-a-dotnet-tool-to-make-windows-sleep-after-a-timeout/",
      "Title": "sleep-pc: a .NET Native AOT tool to make Windows sleep after a timeout",
      "PublishDate": "2025-09-23T10:00:00+00:00",
      "Summary": "In this post I describe a small native AOT .NET tool that I built to force a Windows PC to go to sleep after a timer expires",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/sleep-pc_banner.png\" /><p>In this post I describe a small .NET tool that I built to force a Windows PC to go to sleep after a timer expires. I describe the Win32 API I used to send my laptop to sleep, and how I expanded the proof of concept to be a Native AOT-compiled .NET tool that you can <a href=\"https://github.com/andrewlock/sleep-pc\">view on GitHub</a> or install <a href=\"https://www.nuget.org/packages/sleep-pc\">from Nuget</a>.</p> <h2 id=\"background-go-to-sleep-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/sleep-pc-a-dotnet-tool-to-make-windows-sleep-after-a-timeout/#background-go-to-sleep-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Background: go to sleep!</a></h2> <p>Getting a laptop to go to sleep seems to be one of those things that's just way harder than it should be. Whether it's a MacBook that decides to wake up and heat my backpack over night, or a Windows laptop that just <em>won't</em> go to sleep, I always seem to have issues.</p> <p>One weekend, I was wrestling with exactly the latter issue: I just couldn't get my Windows laptop to sleep. <em>Specifically</em>, I couldn't get it to sleep when <a href=\"https://support.microsoft.com/en-us/windows/windows-media-player-legacy-e8f84f54-cd64-865c-2e83-1d8ec121b5b8\">Windows Media Player Legacy</a> finished playing a playlist. As someone that goes to sleep with videos playing in the background, it's <em>very</em> annoying…</p> <blockquote> <p>Yes, I know it's old. Yes, I use <a href=\"https://www.videolan.org/\">VLC</a> too. I still prefer the old WMP for some things, namely adding a few videos to a playlist from my library, seeing the last played time etc</p> </blockquote> <p>What's particularly annoying is that I've tried every troubleshooting approach under the sun. The power plans are correct. I've run and explored <code>powercfg</code>. I did it all, man. And eventually I just got bored and wrote a tiny app that <em>forces</em> the laptop to sleep after a given time limit has expired.</p> <h2 id=\"sending-a-pc-to-sleep-with-setsuspendstate\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/sleep-pc-a-dotnet-tool-to-make-windows-sleep-after-a-timeout/#sending-a-pc-to-sleep-with-setsuspendstate\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Sending a PC to sleep with <code>SetSuspendState</code></a></h2> <p>The first version I knocked out in just a few minutes, and it looked something like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Runtime<span class=\"token punctuation\">.</span>InteropServices</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> wait <span class=\"token operator\">=</span> TimeSpan<span class=\"token punctuation\">.</span><span class=\"token function\">FromSeconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1 hour</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Waiting for {wait}\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nThread<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span>wait<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Sleeping!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">SetSuspendState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">DllImport</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PowrProf.dll\"</span><span class=\"token punctuation\">,</span> SetLastError <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">SetSuspendState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> hibernate<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> forceCritical<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> disableWakeEvent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>This tiny program simply sleeps for a hardcoded period of time (1 hour for my purposes) and then makes a P/Invoke call to the <a href=\"https://learn.microsoft.com/en-us/windows/win32/api/powrprof/nf-powrprof-setsuspendstate\"><code>SetSuspendState</code> method in <code>PowrProf.dll</code></a>, a Win32 API (i.e. Windows only) which sends the laptop to sleep.</p> <blockquote> <p>I set <code>hibernate=false</code> here, however it appears that Windows often still hibernates regardless of this value, depending on your system settings. This can apparently happen particularly when Hybrid Sleep is enabled. In my case it does hibernate, which is fine for me, as that's what I <em>really</em> wanted anyway.</p> </blockquote> <p>And that's pretty much all you need to implement the functionality I was after! Of course, I couldn't <em>quite</em> leave it at simple as that.</p> <h2 id=\"adding-some-pizzazz\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/sleep-pc-a-dotnet-tool-to-make-windows-sleep-after-a-timeout/#adding-some-pizzazz\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Adding some pizzazz</a></h2> <p>Given this was such a little tool, my first thoughts were:</p> <ul><li>Add some proper command-line arg parsing</li> <li>Package it as a Native AOT tool using <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">the new .NET 10 tools support</a></li> <li>Jazz up the console somewhat</li> <li>Allow a \"dry run\" option</li></ul> <p>I first set about adding command-line parsing and help generation as a quick way for testing various options.</p> <h3 id=\"using-consoleappframework-to-create-console-apps\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/sleep-pc-a-dotnet-tool-to-make-windows-sleep-after-a-timeout/#using-consoleappframework-to-create-console-apps\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Using ConsoleAppFramework to create console apps</a></h3> <p>There's lots of different options for this, for example:</p> <ul><li><a href=\"https://www.nuget.org/packages/System.CommandLine\">System.CommandLine</a></li> <li><a href=\"https://www.nuget.org/packages/Spectre.Console.Cli\">Spectre.Console.Cli</a></li> <li><a href=\"https://www.nuget.org/packages/ConsoleAppFramework\">ConsoleAppFramework</a></li></ul> <p><em>ConsoleAppFramework</em> is a project I haven't seen mentioned very much, but it's one I've used in the past that I've had a good experience with. As per <a href=\"https://github.com/Cysharp/ConsoleAppFramework\">the project description</a>:</p> <blockquote> <p><strong>ConsoleAppFramework</strong> v5 is Zero Dependency, Zero Overhead, Zero Reflection, Zero Allocation, AOT Safe CLI Framework powered by C# Source Generator; achieves exceptionally high performance, fastest start-up time(with NativeAOT) and minimal binary size. Leveraging the latest features of .NET 8 and C# 13 (<a href=\"https://github.com/dotnet/roslyn/blob/main/docs/features/incremental-generators.md\">IncrementalGenerator</a>, <a href=\"https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-9.0/function-pointers#function-pointers-1\">managed function pointer</a>, <a href=\"https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/operators/lambda-expressions#input-parameters-of-a-lambda-expression\">params arrays and default values lambda expression</a>, <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.ispanparsable-1\"><code>ISpanParsable&lt;T&gt;</code></a>, <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.posixsignalregistration\"><code>PosixSignalRegistration</code></a>, etc.), this library ensures maximum performance while maintaining flexibility and extensibility.</p> </blockquote> <p>Which you know, is all pretty cool😄 From my point of view, what I like the most is the simplicity, but it also ticks a lot of boxes for performance. It does require a modern version of .NET (.NET 8+) but that's fine with me in this case.</p> <p>Add the package to your project:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet <span class=\"token function\">add</span> package ConsoleAppFramework\n</code></pre></div> <p>Converting my little proof of concept to a \"real\" console app, with help text, argument parsing and validation was as simple as this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>ComponentModel<span class=\"token punctuation\">.</span>DataAnnotations</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">ConsoleAppFramework</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Runtime<span class=\"token punctuation\">.</span>InteropServices</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">await</span> ConsoleApp<span class=\"token punctuation\">.</span><span class=\"token function\">RunAsync</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">,</span> App<span class=\"token punctuation\">.</span>Countdown<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/// &lt;summary&gt;</span>\n    <span class=\"token comment\">/// Waits for the provided number of seconds before sending the computer to sleep</span>\n    <span class=\"token comment\">/// &lt;/summary&gt;</span>\n    <span class=\"token comment\">/// &lt;param name=\"sleepDelaySeconds\"&gt;-s|--seconds, The time in seconds before the computer is put to sleep. Defaults to 1 hour&lt;/param&gt;</span>\n    <span class=\"token comment\">/// &lt;param name=\"dryRun\"&gt;If true, prints a message instead of sleeping&lt;/param&gt;</span>\n    <span class=\"token comment\">/// &lt;param name=\"ct\"&gt;Used to cancel execution&lt;/param&gt;</span>\n    <span class=\"token comment\">/// &lt;returns&gt;&lt;/returns&gt;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Countdown</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Range</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">99</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span><span class=\"token class-name\"><span class=\"token keyword\">uint</span></span> sleepDelaySeconds <span class=\"token operator\">=</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> dryRun <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">CancellationToken</span> ct <span class=\"token operator\">=</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> wait <span class=\"token operator\">=</span> TimeSpan<span class=\"token punctuation\">.</span><span class=\"token function\">FromSeconds</span><span class=\"token punctuation\">(</span>sleepDelaySeconds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Waiting for {wait}\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span>wait<span class=\"token punctuation\">,</span> ct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Sleeping!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>dryRun<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">SetSuspendState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">DllImport</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PowrProf.dll\"</span><span class=\"token punctuation\">,</span> SetLastError <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">SetSuspendState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> hibernate<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> forceCritical<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> disableWakeEvent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>To add <code>ConsoleAppFramework</code> support I just had to:</p> <ul><li>Call the source-generated <code>ConsoleApp.RunAsync()</code> method</li> <li>Decorate my target method with XML comments describing the command, the arguments, and validation requirements</li></ul> <p>This generates all the help text you would expect:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dotnet run -- <span class=\"token parameter variable\">--help</span>\nUsage: <span class=\"token punctuation\">[</span>options<span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-h<span class=\"token operator\">|</span>--help<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>--version<span class=\"token punctuation\">]</span>\n\nWaits <span class=\"token keyword\">for</span> the provided number of seconds before sending the computer to <span class=\"token function\">sleep</span>\n\nOptions:\n  -s<span class=\"token operator\">|</span>--seconds<span class=\"token operator\">|</span>--sleep-delay-seconds <span class=\"token operator\">&lt;</span>uint<span class=\"token operator\">&gt;</span>    The <span class=\"token function\">time</span> <span class=\"token keyword\">in</span> seconds before the computer is put to sleep. Defaults to <span class=\"token number\">1</span> hour <span class=\"token punctuation\">(</span>Default: <span class=\"token number\">3600</span><span class=\"token punctuation\">)</span>\n  --dry-run                                    If true, prints a message instead of sleeping <span class=\"token punctuation\">(</span>Optional<span class=\"token punctuation\">)</span>\n</code></pre></div> <p>Pretty neat!</p> <p>Being source generated, you can even F12 the implementation and see exactly what it's doing, but I'm not going to dig into that here. You can see I also added the \"dry run\" option, so that I could easily test without my laptop going to sleep repeatedly!</p> <h3 id=\"adding-native-aot-support\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/sleep-pc-a-dotnet-tool-to-make-windows-sleep-after-a-timeout/#adding-native-aot-support\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Adding Native AOT support</a></h3> <p>Adding Native AOT support was pretty simple, as ConsoleAppFramework already supports Native AOT, and the app isn't doing much else. I added the <code>&lt;PublishAot&gt;true&lt;/PublishAot&gt;</code> setting to my project file, and there were no build warnings.</p> <p>I was somewhat surprised to find that <code>[DllImport]</code> wasn't flagged, as I thought you had to use the new <code>[LibraryImport]</code> source-generator-based attribute, but apparently that's not always necessary. The <a href=\"https://learn.microsoft.com/en-us/dotnet/standard/native-interop/best-practices\">docs still recommend using it</a> though, so I switched to the new attribute, specifying all the marshalling value as required:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">LibraryImport</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"PowrProf.dll\"</span><span class=\"token punctuation\">,</span> SetLastError <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">return</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">MarshalAs</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnmanagedType<span class=\"token punctuation\">.</span>Bool<span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token comment\">// return is actually BOOL (int)</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">partial</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">SetSuspendState</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MarshalAs</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnmanagedType<span class=\"token punctuation\">.</span>U1<span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> hibernate<span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MarshalAs</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnmanagedType<span class=\"token punctuation\">.</span>U1<span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> forceCritical<span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">MarshalAs</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>UnmanagedType<span class=\"token punctuation\">.</span>U1<span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> disableWakeEvent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>After making this change I tested publishing a Native AOT version of the app using</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet publish <span class=\"token parameter variable\">-r</span> win-x64 <span class=\"token parameter variable\">-c</span> Release\n</code></pre></div> <p>And the resulting <em>sleep-pc.exe</em> file was 3.3MB—not bad for a .NET app including all the runtime bits it needs! But I wondered if I could push that further…</p> <p>After looking through <a href=\"https://learn.microsoft.com/en-us/dotnet/core/deploying/trimming/trimming-options\">the trimming options documentation</a>, I found a bunch of knobs and levers to pull and ultimately managed to shave off ~0.3MB. Not a massive additional improvement, and maybe I could have gone smaller, but meh, good enough! I show the final <em>.csproj</em> I ended up with in the next section.</p> <blockquote> <p><a href=\"https://github.com/MichalStrehovsky/sizoscope\">Michal Strehovský's Sizoscope project</a> is a neat way to \"peak inside\" your Native AOT binaries to see where all that space is going, and to give you ideas for things you could remove.</p> </blockquote> <p>With the tool now publishing as Native AOT, I worked on publishing it as a NuGet package.</p> <h3 id=\"packaging-as-a-native-aot-tool\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/sleep-pc-a-dotnet-tool-to-make-windows-sleep-after-a-timeout/#packaging-as-a-native-aot-tool\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Packaging as a Native AOT tool</a></h3> <p>I've <a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/\">written</a> <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">a lot</a> <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/\">recently</a> about .NET tools, and particularly the .NET 10 feature for creating Native AOT .NET tools. Somewhat as a proof of concept, I tried applying this to my new <em>sleep-pc</em> tool.</p> <p>I opted for the <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#the-best-of-both-worlds-framework-dependent-and-platform-specific-tools-in-the-same-package\">\"compromise package\"</a> approach that I described in my previous post. With this appoach:</p> <ul><li>The \"root\" <em>sleep-pc.nupkg</em> contains a .NET 8 framework-dependent build of the tool, with a pointer to the platform-specific version of the tool for .NET 10 SDK users.</li> <li>The packaged application has <code>&lt;RollForward&gt;Major&lt;/RollForward&gt;</code> so that it will run on .NET 9 if the user has that installed and no .NET 8 runtime.</li> <li>The platform-specific package contains the Native AOT asset only, which is used when the user has .NET 10+ installed.</li></ul> <p>I discussed this compromise package style a lot in the last post, so here I just show my final <em>.csproj</em> file:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>Exe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RootNamespace</span><span class=\"token punctuation\">&gt;</span></span>SleepPc<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RootNamespace</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>latest<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AllowUnsafeBlocks</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>AllowUnsafeBlocks</span><span class=\"token punctuation\">&gt;</span></span>\n\n    <span class=\"token comment\">&lt;!--  NuGet/Tool settings --&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackAsTool</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackAsTool</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ToolCommandName</span><span class=\"token punctuation\">&gt;</span></span>sleep-pc<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ToolCommandName</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageId</span><span class=\"token punctuation\">&gt;</span></span>sleep-pc<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageId</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageVersion</span><span class=\"token punctuation\">&gt;</span></span>0.1.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageVersion</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Authors</span><span class=\"token punctuation\">&gt;</span></span>Andrew Lock<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Authors</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Description</span><span class=\"token punctuation\">&gt;</span></span>A tool for sending your windows laptop to sleep  after a given time<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Description</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageTags</span><span class=\"token punctuation\">&gt;</span></span>sleep;timer;windows;tool<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageTags</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageLicenseExpression</span><span class=\"token punctuation\">&gt;</span></span>MIT<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageLicenseExpression</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RollForward</span><span class=\"token punctuation\">&gt;</span></span>Major<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RollForward</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>CopyOutputSymbolsToPublishDirectory</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>CopyOutputSymbolsToPublishDirectory</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token comment\">&lt;!-- Conditional framework version to support NuGet tool --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span> <span class=\"token attr-name\">Condition</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(RuntimeIdentifier) != <span class=\"token punctuation\">'</span><span class=\"token punctuation\">'</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net10.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span> <span class=\"token attr-name\">Condition</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(RuntimeIdentifier) == <span class=\"token punctuation\">'</span><span class=\"token punctuation\">'</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFrameworks</span><span class=\"token punctuation\">&gt;</span></span>net8.0;net10.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFrameworks</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span> <span class=\"token attr-name\">Condition</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(TargetFramework) == <span class=\"token punctuation\">'</span>net10.0<span class=\"token punctuation\">'</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>win-x64<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>\n    \n    <span class=\"token comment\">&lt;!--  Size optimisation bits for Native AOT --&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DebuggerSupport</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DebuggerSupport</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>EventSourceSupport</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>EventSourceSupport</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>HttpActivityPropagationSupport</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>HttpActivityPropagationSupport</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>MetricsSupport</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>MetricsSupport</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TrimmerRemoveSymbols</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TrimmerRemoveSymbols</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>StripSymbols</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>StripSymbols</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>InvariantGlobalization</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>InvariantGlobalization</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>IlcDisableReflection</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>IlcDisableReflection</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>IlcTrimMetadata</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>IlcTrimMetadata</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>IlcOptimizationPreference</span><span class=\"token punctuation\">&gt;</span></span>Size<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>IlcOptimizationPreference</span><span class=\"token punctuation\">&gt;</span></span>\n\n    <span class=\"token comment\">&lt;!-- For analysis by Sizoscope  --&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>IlcGenerateMstatFile</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>IlcGenerateMstatFile</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>IlcGenerateDgmlFile</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>IlcGenerateDgmlFile</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ConsoleAppFramework<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>5.5.0<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>IncludeAssets</span><span class=\"token punctuation\">&gt;</span></span>runtime; build; native; contentfiles; analyzers; buildtransitive<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>IncludeAssets</span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PrivateAssets</span><span class=\"token punctuation\">&gt;</span></span>all<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PrivateAssets</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageReference</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>With this project file we can now package the tool as two NuGet packages by running</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet pack\ndotnet pack <span class=\"token parameter variable\">-r</span> win-x64\n</code></pre></div> <p>and the resulting packages are pretty decent sizes:</p> <p><img src=\"https://andrewlock.net/content/images/2025/sleep-pc.png\" alt=\"The two sleep-pc NuGet packages\"></p> <p>That covers most things, so all that's left is spicing up the console logs!</p> <h3 id=\"improving-the-console-output\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/sleep-pc-a-dotnet-tool-to-make-windows-sleep-after-a-timeout/#improving-the-console-output\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Improving the console output</a></h3> <p>Your go-to option whenever you want to have nice looking console output is to use <a href=\"https://www.nuget.org/packages/Spectre.Console\">Spectre.Console</a> but, perhaps controversially, I decided to forgo it in this case. My reasoning being that Spectre.Console technically isn't AOT compatible, and there was really only a tiny amount of dynamism that I wanted.</p> <p>Basically, all I wanted to add was a countdown timer, instead of the app just sitting in a <code>Thread.Sleep()</code> or <code>Task.Wait()</code>. To achieve that I used a <a href=\"https://stackoverflow.com/questions/888533/how-can-i-update-the-current-line-in-a-c-sharp-windows-console-app\">trick</a> that I've used in the past to \"replace\" a line in the console, by sending backspaces in a <code>Console.WriteLine()</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> wait <span class=\"token operator\">=</span> TimeSpan<span class=\"token punctuation\">.</span><span class=\"token function\">FromSeconds</span><span class=\"token punctuation\">(</span>sleepDelaySeconds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Write the initial text</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"⏰ Time remaining:         \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Send a bunch of backspaces followed by the formatted text</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\b\\b\\b\\b\\b\\b\\b\\b{0:hh\\\\:mm\\\\:ss}\"</span><span class=\"token punctuation\">,</span> wait<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>When this is running, it looks like the console is updating in place. It's not perfect, but it does the job well enough for me:</p> <p><img src=\"https://andrewlock.net/content/images/2025/sleep-pc.gif\" alt=\"The animated console loop\"></p> <p>To make the countdown run properly, we have to switch to a loop to make sure we're updating the console regularly. That adds a bit of complexity, particularly given we don't want to \"drift\" from the deadline, but it's relatively self explanatory:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Calculate when we should end, to avoid drift</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> wait <span class=\"token operator\">=</span> TimeSpan<span class=\"token punctuation\">.</span><span class=\"token function\">FromSeconds</span><span class=\"token punctuation\">(</span>sleepDelaySeconds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> deadline <span class=\"token operator\">=</span> DateTimeOffset<span class=\"token punctuation\">.</span>UtcNow<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>wait<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dryRunText <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>dryRun <span class=\"token punctuation\">?</span> <span class=\"token string\">\" (dry run)\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nConsole<span class=\"token punctuation\">.</span>OutputEncoding <span class=\"token operator\">=</span> System<span class=\"token punctuation\">.</span>Text<span class=\"token punctuation\">.</span>Encoding<span class=\"token punctuation\">.</span>UTF8<span class=\"token punctuation\">;</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$@\"Will sleep after, </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">wait</span><span class=\"token format-string\"><span class=\"token punctuation\">:</span>hh\\:mm\\:ss</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> at </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">deadline</span><span class=\"token format-string\"><span class=\"token punctuation\">:</span>dd MMM yy HH:mm:ss</span><span class=\"token punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">dryRunText</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Press ctrl-c to cancel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"⏰ Time remaining:         \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>ct<span class=\"token punctuation\">.</span>IsCancellationRequested<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Update the clock</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\b\\b\\b\\b\\b\\b\\b\\b{0:hh\\\\:mm\\\\:ss}\"</span><span class=\"token punctuation\">,</span> wait<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1_000</span><span class=\"token punctuation\">,</span> ct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">catch</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Canceled by the user (Ctrl+C)</span>\n        <span class=\"token keyword\">goto</span> canceled<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    wait <span class=\"token operator\">=</span> deadline <span class=\"token operator\">-</span> DateTimeOffset<span class=\"token punctuation\">.</span>UtcNow<span class=\"token punctuation\">;</span> \n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wait <span class=\"token operator\">&lt;=</span> TimeSpan<span class=\"token punctuation\">.</span>Zero<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"💤 Deadline reached, sleeping</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">dryRunText</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>dryRun<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">SetSuspendState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> ex<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"⚠️ Error triggering sleep: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">ex</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> \n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\ncanceled<span class=\"token punctuation\">:</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"❌ Sleep cancelled\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>And that's it!</p> <p>You can find the <a href=\"https://github.com/andrewlock/sleep-pc\">full code for the tool on GitHub </a> and the tool <a href=\"https://www.nuget.org/packages/sleep-pc\">on NuGet</a>:</p> <p><img src=\"https://andrewlock.net/content/images/2025/sleep-pc_2.png\" alt=\"The sleep-pc tool on NuGet\"></p> <p>Install it using <code>dotnet tool install -g sleep-pc</code>, and no more failed sleeping!</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/sleep-pc-a-dotnet-tool-to-make-windows-sleep-after-a-timeout/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I described a small .NET tool that I built to force a Windows PC to go to sleep after a timer expires. I started by showing the the Win32 API I used to send my laptop to sleep, and the small proof of concept app. I then expanded this implementation to Native AOT compile the app, pack it as a .NET tool, and add some improved console output. You can <a href=\"https://github.com/andrewlock/sleep-pc\">view the code on GitHub</a> or install the tool <a href=\"https://www.nuget.org/packages/sleep-pc\">from Nuget</a>.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/sleep-pc-a-dotnet-tool-to-make-windows-sleep-after-a-timeout/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/",
      "Title": "Supporting platform-specific .NET tools on old .NET SDKs: Exploring the .NET 10 preview - Part 8",
      "PublishDate": "2025-09-16T10:00:00+00:00",
      "Summary": "In this post I look at the advantages, trade-offs, and implications of the new platform-specific .NET tool feature added in .NET 10, and how to support old SDKs",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/tools.webp\" /><nav><p>This is the eighth post in the series: <a href=\"https://andrewlock.net/series/exploring-the-dotnet-10-preview/\">Exploring the .NET 10 preview</a>. </p> <ol class=\"list-none\"><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/\">Part 1 - Exploring the features of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/\">Part 2 - Behind the scenes of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/\">Part 3 - C# 14 extension members; AKA extension everything</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/\">Part 4 - Solving the source generator 'marker attribute' problem in .NET 10</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/\">Part 5 - Running one-off .NET tools with dnx</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/\">Part 6 - Passkey support for ASP.NET Core identity</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">Part 7 - Packaging self-contained and native AOT .NET tools for NuGet</a></li><li>Part 8 - Supporting platform-specific .NET tools on old .NET SDKs (this post) </li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/\">Part 9 - Easier reflection with [UnsafeAccessorType] in .NET 10</a></li></ol></nav><p>In this post I look in more depth at the <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">platform-specific (self-contained or Native AOT) NuGet package support</a> added in .NET 10, and in particular look at how you can continue to support users working with older versions of the .NET SDK.</p> <p>I start by discussing what the new platform-specific features mean to .NET tool authors, in terms of advantages, trade-offs, and implications. I then discuss some possible approaches that attempt to give the best of both worlds: improvements for .NET 10 SDK users, but continued support for .NET 9 SDK and earlier users.</p> <h2 id=\"the-evolution-of-net-tools-in-net-10\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#the-evolution-of-net-tools-in-net-10\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The evolution of .NET tools in .NET 10</a></h2> <p>I have talked about .NET tools in my <a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/\">last couple</a> of <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">posts</a>, but the reality is that nothing much changed about authoring or consuming .NET tools for a long time. .NET Core 3.0 introduced \"local\" tools back in 2019, and they pretty much stayed the same since then.</p> <p>However in .NET 10, we suddenly have new features 🎉</p> <ul><li><code>dotnet tool exec</code>/<code>dotnet dnx</code>/<code>dnx</code> allows <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/\">running a .NET tool without explicitly installing it first</a>.</li> <li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">Platform-specific tools</a> allow packaging tools as self-contained or even Native AOT compiled tools.</li></ul> <p>In this post I discuss how these two features interact and their implications when thinking about the maintenance and support of a .NET tool, as a tool author.</p> <h2 id=\"what-do-these-new-features-mean-for-tool-authors-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#what-do-these-new-features-mean-for-tool-authors-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What do these new features mean for tool authors?</a></h2> <p>The new features in .NET 10 are cool for consumers of packages, but what do they mean for tool authors?</p> <h3 id=\"one-shot-tool-running-with-dnx\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#one-shot-tool-running-with-dnx\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">One-shot tool running with <code>dnx</code></a></h3> <p>We'll start by thinking about the <code>dnx</code> \"one-off\" tool running scenario. The primary benefit of this feature is to the <em>consumers</em> of packages, as they don't need to run two commands just to run a tool. It also means they don't \"pollute\" their path, among other minor things, for something that they only want to run once.</p> <p>As a package author, I don't think there's <em>much</em> for you to think about here. Regardless of how you've written your package, the consumer-side feature works pretty much the same. Customers need to be using the .NET 10 SDK, but you can pack your tool using any SDK, so there's no limitations there. And the runtime requirements for your package are the same regardless of whether they are run using <code>dnx</code> or <code>dotnet tool install</code>.</p> <p>I think the one aspect you could tweak to improve the experience for consumers of your package is to keep your packages as small as possible. The first time a consumer runs <code>dnx</code>, .NET must download your package, and the smaller the package is, the quicker this will be. This applies to the \"normal\" <code>dotnet tool install</code> path too, but the \"one-off\" nature of <code>dnx</code> adds additional weight to the size aspect I think.</p> <h3 id=\"platform-specific-tools\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#platform-specific-tools\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Platform-specific tools</a></h3> <p>The other feature, platform-specific tools, has more nuance to it, as it requires changes to the <em>.nupkg</em> packages themselves, and isn't solely an SDK feature. It puts requirements on the author-side (you need to use the .NET 10 SDK to produce platform-specific tools), but it <em>also</em> puts requirements on the consumers of the package.</p> <p>As far as I can tell, there are three main advantages to platform-specific tools:</p> <ol><li>Simpler support matrix</li> <li>Reduced package size</li> <li>Faster startup for Native AOT tools</li></ol> <p>I'm thinking primarily about self-contained or nativeAOT packages for these advantages, but I'll explain each advantage in more detail below.</p> <h4 id=\"1-simpler-support-matrix-with-self-contained-tools\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#1-simpler-support-matrix-with-self-contained-tools\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">1. Simpler support matrix with self-contained tools</a></h4> <p>As I explained in <a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/\">a previous post</a>, if you really want to support as many consumers of your package as possible, you need to compile your tool for <em>all</em> the .NET runtime versions you support. For example if you want to support .NET 6+ that means you need to build and ideally <em>test</em> your tool against .NET 6, .NET 7, .NET 8, .NET 9, and soon .NET 10. That's easy enough in practice, but it's also a bit of a pain.</p> <blockquote> <p>As a reminder, this is necessary because you don't know what .NET runtime or SDK version consumers may have installed when they try to use your tool.</p> </blockquote> <p>You can potentially <em>partially</em> work around this issue by <em>only</em> building for .NET 6 (given the example above), and relying <a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#configuring-your-tools-to-roll-forward\">on setting <code>RollForward=Major</code></a> to ensure consumers can still run the tool if they only have .NET 8 installed (for example). That reduces the \"build\" burden, but you still need to test your tool on newer runtimes, as there can potentially be breaking changes between major versions. If there are breaking changes that affect you, then you might not be able to rely on the rollforward setting at all.</p> <p>With self-contained or NativeAOT tools, the whole support matrix issue goes away. You only need to support a single target framework, the one you pack into the package. This takes away a bunch of complexity, avoids potential issues related to rollforward and simplifies your life overall as a package author by removing this variable. And on the consumer side, you hopefully get a more reliable experience too.</p> <h4 id=\"2-reduced-package-size\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#2-reduced-package-size\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">2. Reduced package size</a></h4> <p>Given you're only packing your tool for a <em>single</em> platform and framework with self-contained/NativeAOT tools, you <em>may</em> be able to significantly reduce the size of the resulting package. This will inevitably be very tool-specific:</p> <ul><li>Some tools can't be NativeAOT compiled, and so may need to bundle more of the underlying runtime in the package, especially if your tool isn't trim-safe.</li> <li>If a tool has native platform-specific dependencies, the platform-specific tool can significantly reduce the number of dependencies required, by only packing a single file, instead of one per platform.</li> <li>If a tool supports many target frameworks (for maximum compatibility with consumer environments) you may be able to save a lot of space by switching to only including the single self-contained runtime.</li></ul> <p>The <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">sample app in my previous post</a> was the perfect example of how the platform-specific tools <em>can</em> significantly reduce the size of the package, due to a large number of supported frameworks, and a native dependency that supports many target platforms:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_15.png\" alt=\"Comparing framework-dependent with Native AOT packages\"></p> <p>All those files mean a difference of 92MB to 2.6MB!</p> <blockquote> <p>Bear in mind, this is pretty much a worst/base case example, given the large number of supported frameworks and the large number of native dependencies. Your mileage may vary.</p> </blockquote> <p>Of course, disk space is cheap, so should you really care? The answer, as always, is it depends. Depending on how your tool is used, the size difference may or may not make a big difference.</p> <p>That said, a smaller package is clearly better for the <code>dnx</code> feature of .NET 10, as the assumption is that consumers often <em>won't</em> have the tool downloaded. The bigger the package, the slower it will be to download, and the longer the user has to wait for your tool to execute. Smaller packages are always going to be better in these cases.</p> <h4 id=\"3-faster-startup\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#3-faster-startup\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">3. Faster startup</a></h4> <p>Having a smaller package should make <code>dnx</code> executions faster the first time, but once the tool is downloaded, the size of the package doesn't <em>really</em> matter that much. However, if you have native AOT compiled your application, then you'll consistently benefit from the faster startup characteristics.</p> <blockquote> <p>Fast startup times are one of <a href=\"https://learn.microsoft.com/en-us/dotnet/core/deploying/native-aot/?tabs=windows%2Cnet8\">the key benefits</a> of native AOT compiling your .NET application. They also often have a smaller memory footprint when running, as there's no JIT compiler running (among other reasons).</p> </blockquote> <p>Even if you're not native AOT compiling your application, then another <em>theoretical</em> benefit of a self-contained application is that you may be able to benefit from the performance improvements of a newer runtime. <a href=\"https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-10/\">Every version of .NET gets a bit faster</a>; so if consumers of your package use the included .NET 10 runtime instead of an earlier runtime, then your tool could see performance improvements.</p> <p>However, as self-contained tools <em>require</em> the .NET 10 SDK, that means customers will <em>definitely</em> have the .NET 10 runtime available, so you likely <em>won't</em> see performance improvements today compared to a framework-dependent package. For that reason, I've not considered this as a benefit today, though in the future, as more .NET SDKs are released this calculation may change.</p> <p>So we have three <em>potential</em> benefits of platform-specific tools: a simpler support matrix, reduced package size, and Native AOT startup time improvements. Unfortunately, it's not <em>all</em> roses. There are downsides to adopting platform-specific tools too.</p> <h3 id=\"downsides-to-platform-specific-tools-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#downsides-to-platform-specific-tools-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Downsides to platform-specific tools.</a></h3> <p>In my <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#limitations-and-recommendations\">previous post</a> I discussed some of the implications of using the platform-specific tools feature, and I also mentioned it above. The crux of the problem is that by default, using platform-specific tools means consumers <em>must</em> be using the .NET 10 SDK. If they try to install a platform-specific tool when using an earlier SDK, they'll get an error like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dotnet tool <span class=\"token function\">install</span> sayhello\n\nTool <span class=\"token string\">'sayhello'</span> failed to update due to the following:\nThe settings <span class=\"token function\">file</span> <span class=\"token keyword\">in</span> the tool<span class=\"token string\">'s NuGet package is invalid: Command '</span>sayhello<span class=\"token string\">' uses unsupported runner '</span>'.\"\nTool <span class=\"token string\">'sayhello'</span> failed to install. Contact the tool author <span class=\"token keyword\">for</span> assistance.\n</code></pre></div> <p>or like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dotnet tool <span class=\"token function\">install</span> sayhello.win-x64\n\nTool <span class=\"token string\">'sayhello.win-x64'</span> failed to update due to the following:\nThe settings <span class=\"token function\">file</span> <span class=\"token keyword\">in</span> the tool<span class=\"token string\">'s NuGet package is invalid: Command '</span>sayhello<span class=\"token string\">' uses unsupported runner '</span>executable<span class=\"token string\">'.\"\nTool '</span>sayhello.win-x64' failed to install. Contact the tool author <span class=\"token keyword\">for</span> assistance.\n</code></pre></div> <p>This all stems from the <em>DotnetToolSettings.xml</em> that's included in the <em>.nupkg</em> package and tells the .NET SDK <em>how</em> to run your app. For .NET 9 and below (and for framework-dependent, platform-agnostic tools in .NET 10) the file looks something like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DotNetCliTool</span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Command</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">EntryPoint</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MultiRid.dll<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Runner</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>dotnet<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DotNetCliTool</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>As you can see, this uses <code>Version=1</code> for the schema, and has <code>Runner=dotnet</code> for the <code>Command</code> entry. In contrast, if we look at the <em>DotnetToolSettings.xml</em> files for your .NET 10 platform-specific tools, these use schema <code>Version=2</code>, and a different (or missing) <code>Runner</code>.</p> <p>The <em>DotnetToolSettings.xml</em> file in the platform-specific package looks like this, for example:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DotNetCliTool</span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Command</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">EntryPoint</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MultiRid<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Runner</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>executable<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DotNetCliTool</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>Unfortunately, the <code>Runner=executable</code> is only understood by the .NET 10+ SDK, which means you can't install these packages on earlier SDKs.</p> <h2 id=\"the-conundrum-should-tool-authors-use-platform-specific-packages-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#the-conundrum-should-tool-authors-use-platform-specific-packages-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The conundrum: should tool authors use platform-specific packages?</a></h2> <p>We've established that platform-specific packages may have many benefits for some .NET tools, but they can only be used by users with the .NET 10 SDK. The two questions you need to answer as a tool author are:</p> <ol><li>Would my tool benefit from platform-specific packages?</li> <li>Is it a problem to require that my users use the .NET 10 SDK?</li></ol> <p>As I've already described, the answer to the first question will depend on your tool. Platform-specific packages give 3 main advantages in general, but these advantages are biggest if you have a large range of supported target frameworks, if your tool uses platform-specific dependencies, and if you can NativeAOT your package. If those don't apply to you, then the trade off in installation support may not be worth it.</p> <p>However, if we assume your tool <em>would</em> benefit from being platform-specific packages, you have to consider whether the requirement that users use the .NET 10 SDK is a problem.</p> <p>Depending on the tool that you're creating, this might be fine. If you're just creating an OSS tool, or a tool for your own consumption, for example, then requiring that users have the .NET 10 SDK installed might not be a problem for you. After all, <em>in general</em>, people should always be using the newest .NET SDK as it can still build for earlier .NET runtimes.</p> <p>However, if you're building a tool where adoption and ease-of-use is your primary concern, then this may not be acceptable. This might be the case if your tool is produced by a company, if it's a part of your product, or if it's intended to run in places where .NET 10 won't.</p> <blockquote> <p><a href=\"https://github.com/dotnet/runtime/issues/109939\">.NET 10 doesn't support as many Linux distributions as some previous versions</a>, dropping support for older Alpine and Ubuntu versions, for example. If you need your tool to run in those scenarios, and you want to distribute it via NuGet, then you <em>must</em> support earlier versions of the SDK.</p> </blockquote> <p>This conflict made me wonder if there was some sort of middle-ground possible, a kind of \"compromise\" package that gives you the best of all worlds.</p> <h2 id=\"the-best-of-both-worlds-framework-dependent-and-platform-specific-tools-in-the-same-package\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#the-best-of-both-worlds-framework-dependent-and-platform-specific-tools-in-the-same-package\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The best of both worlds? Framework-dependent and platform-specific tools in the same package</a></h2> <p>The compromise solution I had in mind looks something like this:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_12.png\" alt=\"A workaround for the .NET 10 SDK compatibility problem\"></p> <p>I'll show how to implement this sort of package shortly, but before we get into the technical details, I think it's worth discussing the pros and cons of this approach, what scenarios it supports, and the implications for both tool authors and consumers.</p> <p>With this setup, you pack the framework-dependent, platform-agnostic version of your tool inside the lowest support target-framework <em>tools</em> folder, i.e. <code>tools/netcoreapp3.1</code> in this case. In addition, in the <code>net10.0</code> folder, we pack the <code>Version=2</code> <em>DotnetToolSettings.xml</em> file that points to all our other platform-specific packages.</p> <blockquote> <p>As a reminder, when you produce platform-specific tools, you typically produce <code>N+1</code> packages, where <code>N</code> is the number of platforms. e.g. you produce the root package, <code>sayhello.&lt;version&gt;.nupkg</code>, <code>sayhello.win-x64.&lt;version&gt;.nupkg</code>, <code>sayhello.linux-x64.&lt;version&gt;.nupkg</code>, etc.</p> </blockquote> <p>If you install or run this tool with the .NET 10 SDK, the SDK will download the package, read the <em>xml</em> file in the <code>net10.0</code> folder, and then immediately fetch and run the appropriate platform-specific package, e.g. <code>sayhello.win-x64</code>. So if you have the .NET 10 SDK installed you get the optimised Native AOT version of the package.</p> <p>For users that are using earlier versions of the SDK, anything from <code>netcoreapp3.1</code> to <code>net9.0</code>, the SDK looks for the highest <em>compatible</em> tools folder (<code>tools/netcoreapp3.1</code>) and reads the <em>xml</em> file it contains, which is a standard <code>Version=1</code> file:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DotNetCliTool</span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Command</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">EntryPoint</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MultiRid.dll<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Runner</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>dotnet<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DotNetCliTool</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>The older SDKs just see a normal, \"traditional\", framework-dependent platform-agnostic .NET tool and can run it without issue.</p> <p>On the face of it, this looks like you have the best of both worlds:</p> <ul><li>.NET 10 SDK users can use a NativeAOT version of the tool distributed in platform-specific packages.</li> <li>Earlier SDK users can still use the .NET tool, just as they would before.</li></ul> <p>However, it's not quite as simple as that. Let's consider the three advantages of platform-specific tools I highlighted earlier:</p> <ol><li><strong>Simpler support matrix</strong>. ❌ With this model you're <em>not</em> simplifying your matrix. Instead of replacing your support matrix with a single self-contained tool, your existing support matrix stays the same, assuming you were also always going to add support for .NET 10 (likely self-contained or Native AOT compiled).</li> <li><strong>Reduced package size</strong>. ❌ This also likely doesn't apply. Your \"root\" package contains the same target framework files as in the previous (non-platform specific) version of the package. So users on old SDKs have the exact same package size, and users on the .NET 10 SDK have the combination of the \"root\" package <em>and</em> the platform-specific package to download!</li> <li><strong>Faster startup for Native AOT tools</strong>. ✅ This one still applies. For .NET 10 SDK users, once you've downloaded the platform-specific Native AOT package, they'll benefit from the Native AOT advantages.</li></ol> <p>So on the face of it, this approach currently only seems to make sense if you are producing Native AOT platform-specific packages, which will see the associated startup benefits.</p> <p>It's worth pointing out that this cost-benefit calculation applies <em>today</em>, but that it will change over time. In the future, when .NET 11, .NET 12, or .NET 13 SDKs are released, your package doesn't need to change. Those newer users can still install your .NET 10 tool, and your package size and support matrix doesn't need to change, because you can support those users with the existing NativeAOT tool.</p> <p>In addition, as time goes on, you may well want to reduce your support for earlier versions of the .NET SDK. That will likely involve removing support for earlier runtimes from your root package, or relying on <code>RollForward=Major</code> for support instead. All of which means this approach may become <em>more</em> useful with time than it is today.</p> <p>So unfortunately there's still not a \"correct\" answer here. It really depends on your requirements for supporting older .NET SDKs and how much you're willing to \"penalise\" users who <em>are</em> on the .NET 10 SDK with larger package versions.</p> <h2 id=\"case-study-1-the-datadog-dd-trace-net-tool\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#case-study-1-the-datadog-dd-trace-net-tool\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Case-study 1: the Datadog <code>dd-trace</code> .NET tool</a></h2> <p>There's so many pros and cons at play here, it's hard to grasp onto something concrete, so I thought it would make sense to consider some concrete examples, starting with the Datadog <code>dd-trace</code> .NET Tool.</p> <p><a href=\"https://www.nuget.org/packages/dd-trace#supportedframeworks-body-tab\">The Datadog <code>dd-trace</code> tool</a> provides an easy way to add automatic instrumentation to your application. For example, after installing the tool you can instrument your app something like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dd-trace run -- MyApp.exe\n</code></pre></div> <p>The exact details of how to use the tool or how it works aren't important for this discussion, the more important point is that we support basically <em>all</em> of the frameworks that we can instrument:</p> <p><img src=\"https://andrewlock.net/content/images/2025/dd_trace.png\" alt=\"The contents of the dd-trace tool showing support for .NET Core 2.1\"></p> <p>In addition, we also ship <a href=\"https://docs.datadoghq.com/tests/setup/dotnet/?tab=ciproviderwithautoinstrumentationsupport#installing-the-net-tracer-cli\">self-contained versions</a> of the tool for some platforms which we make available as direct download links rather than using the .NET SDK.</p> <p>The question is whether platform-specific packages make sense for the <code>dd-trace</code> .NET tool 🤔</p> <p>The obvious first point is that we <em>can't</em> require our users to use the .NET 10 SDK. We need to support users with whatever tools they're currently using, which means if we do anything with platform-specific packages, we would <em>need</em> to ship the \"combination\" package I described in the previous section (and which I'll show how to create in the next section).</p> <p>But would that actually be useful? We already create self-contained (trimmed) builds of our tool, but we <em>don't</em> produce Native AOT builds, and I don't think we will be able to. Bearing that in mind, and considering the theoretical benefits:</p> <ol><li><strong>Simpler support matrix</strong>. ❌ We are shipping for all TFMs from .NET Core 2.1-.NET 10 whichever approach we take.</li> <li><strong>Reduced package size</strong>. ❌ The size is actually much <em>worse</em> with platform-specific packages, as .NET 10 SDK users pay the cost of the existing tool (~135MB), and <em>then</em> the cost of a self-contained (trimmed) package (~50MB). In contrast, simply adding .NET 10 to the existing package would only add ~5MB to the package size</li> <li><strong>Faster startup for Native AOT tools</strong>. ❌ We don't ship the tool as a NativeAOT tool, so there will likely not be any performance benefits.</li></ol> <p>So it seems like shipping a platform-specific package for <code>dd-trace</code> simply doesn't make sense. That said, it's possible we could redesign some of the tool internals so that it <em>does</em> make more sense, but without the potential benefits of Native AOT it's hard to justify.</p> <h2 id=\"case-study-2-the-sleep-pc-net-tool\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#case-study-2-the-sleep-pc-net-tool\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Case study 2: the <code>sleep-pc</code> .NET tool</a></h2> <p>As a contrast to <code>dd-trace</code> is a small tool I wrote the other week to solve a simple problem called <code>sleep-pc</code>. <code>sleep-pc</code> simply sends a Windows PC to sleep after a specified duration.</p> <blockquote> <p>A short post on this tool is coming shortly!</p> </blockquote> <p>In general this is a tool for me, which I don't expect (or particularly <em>want</em>) to be widely used, so I could simply require the .NET 10 SDK. However as an exercise, I decided I would support .NET 8+. What's more, I could easily NativeAOT compile this tool.</p> <p>In this case, the compromise-package approach works pretty well. If we look inside the <code>sleep-pc</code> package, we can see the framework-dependent platform-agnostic tool is in the <code>net8.0</code> folder, so the tool supports the .NET 8 SDK+, and we have a link to the Native AOT compiled <code>sleep-pc.win-x64</code> package in the <code>net10.0</code> folder:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_16.png\" alt=\"The sleep-pc tool root package contents\"></p> <p>What's more, this \"root\" package is only 17KB, so you <em>really</em> aren't paying much size cost for having to download it first on .NET 10 (in addition to the 1.5MB Native AOT package). So in this case I think the compromise-package approach works well 🎉.</p> <h2 id=\"implementing-the-compromise-package\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#implementing-the-compromise-package\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Implementing the compromise package</a></h2> <p>Hopefully we've established that the compromise-package approach, in which we embed one or more framework-dependent platform-agnostic versions of a .NET tool into a \"root\" package, <em>may</em> be useful. In this section I'll (finally) show how to implement it.</p> <p>The good news is that it's actually relatively simple to do. The basic steps are:</p> <ul><li>Target all the runtimes you need. You must target at least .NET 10 plus one or more older runtimes.</li> <li>Add conditions to your <em>.csproj</em> file so that you apply the self-contained/Native AOT properties to the <code>net10.0</code> target <em>only</em>.</li> <li>Conditionally set the <code>&lt;TargetFramework&gt;</code>/<code>&lt;TargetFrameworks&gt;</code> based on the value of <code>RuntimeIdentifier</code> (which is optionally specified when you're calling <code>dotnet pack</code>)</li> <li>Run <code>dotnet pack</code> to produce the root package, and then <code>dotnet pack -r &lt;runtime&gt;</code> for each of your supported runtimes.</li></ul> <p>The <em>.csproj</em> below shows a concrete example based on the \"sayhello\" example from <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">my previous post</a>.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>Exe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token comment\">&lt;!-- We specify these later, conditionally --&gt;</span>\n    <span class=\"token comment\">&lt;!-- &lt;TargetFrameworks&gt;netcoreapp3.1;net10.0&lt;/TargetFrameworks&gt; --&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>latest<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>\n\n    <span class=\"token comment\">&lt;!-- Standard tool settings --&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackAsTool</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackAsTool</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ToolCommandName</span><span class=\"token punctuation\">&gt;</span></span>sayhello<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ToolCommandName</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageId</span><span class=\"token punctuation\">&gt;</span></span>sayhello<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageId</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageVersion</span><span class=\"token punctuation\">&gt;</span></span>1.0.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageVersion</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Authors</span><span class=\"token punctuation\">&gt;</span></span>Andrew Lock<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Authors</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Description</span><span class=\"token punctuation\">&gt;</span></span>A tool that says hello<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Description</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageTags</span><span class=\"token punctuation\">&gt;</span></span>ascii;art;figlet;console;tool<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageTags</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageLicenseExpression</span><span class=\"token punctuation\">&gt;</span></span>MIT<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageLicenseExpression</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RollForward</span><span class=\"token punctuation\">&gt;</span></span>Major<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RollForward</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  \n  <span class=\"token comment\">&lt;!-- Package dependencies  --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Spectre.Console<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0.50.0<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.Data.Sqlite<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>9.0.8<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token comment\">&lt;!-- If we're running 'dotnet pack -r &lt;runtime&gt;' then             --&gt;</span>\n  <span class=\"token comment\">&lt;!-- RuntimeIdentifier will have a value, and we explicitly        --&gt;</span>\n  <span class=\"token comment\">&lt;!-- target .NET 10. This produces the platform-specific packages. --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span> <span class=\"token attr-name\">Condition</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(RuntimeIdentifier) != <span class=\"token punctuation\">'</span><span class=\"token punctuation\">'</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net10.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token comment\">&lt;!-- By default, 'dotnet pack' does not have a RuntimeIdentifier  --&gt;</span>\n  <span class=\"token comment\">&lt;!-- so the 'root' package will know about both of these runtimes --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span> <span class=\"token attr-name\">Condition</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(RuntimeIdentifier) == <span class=\"token punctuation\">'</span><span class=\"token punctuation\">'</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFrameworks</span><span class=\"token punctuation\">&gt;</span></span>netcoreapp3.1;net10.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFrameworks</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  \n  <span class=\"token comment\">&lt;!-- For .NET 10, dotnet pack will treat the app as a Native AOT  --&gt;</span>\n  <span class=\"token comment\">&lt;!-- package so it _won't_ pack it in the root package, and will  --&gt;</span>\n  <span class=\"token comment\">&lt;!-- create a Version=2 DotnetToolSettings.xml file in the root.  --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span> <span class=\"token attr-name\">Condition</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(TargetFramework) == <span class=\"token punctuation\">'</span>net10.0<span class=\"token punctuation\">'</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>linux-x64;linux-arm64;win-x64;win-arm64;osx-arm64;<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishTrimmed</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishTrimmed</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>StripSymbols</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>StripSymbols</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  \n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>The 'trick' to creating this compromise package is the conditional setting of frameworks when you're creating the 'root' package with <code>dotnet pack</code> versus the platform-specific packages with <code>dotnet pack -r &lt;runtime&gt;</code>.</p> <p>When you run <code>dotnet pack</code> as-is, <code>$(RuntimeIdentifier)</code> is empty, so the pack tool sees both <code>netcoreapp3.1</code> and <code>net10.0</code> target frameworks. Additionally, it sees that the <code>net10.0</code> target is going to be Native AOT compiled, so it <em>shouldn't</em> include it in the root package. For the <code>netcoreapp3.1</code> target it just sees a normal framework-dependent, platform agnostic build, so it packs that using the <code>Version=1</code> <em>xml</em> file.</p> <p>In contrast, when you run <code>dotnet pack -r &lt;runtime&gt;</code>, <code>$(RuntimeIdentifier)</code> has a value, so the pack tool <em>only</em> sees the <code>net10.0</code> target framework. This is important because .NET Core 3.1 doesn't support Native AOT so it would fail to build, but even if this was <code>net8.0</code> or something which <em>does</em> support Native AOT, we don't want (or need) to include it in the platform-specific package; it would just be dead weight.</p> <p>When you build this package you get a root package that supports .NET Core 3.1+, as I showed earlier:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_12.png\" alt=\"A workaround for the .NET 10 SDK compatibility problem\"></p> <p>And additionally, you'll have a Native AOT platform-specific package:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_17.png\" alt=\"The platform-specific package contents\"></p> <p>So if the compromise-package works for your use-case: win-win!</p> <h2 id=\"alternative-compromises\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#alternative-compromises\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Alternative compromises</a></h2> <p>When I was initially discussing the possibility of <a href=\"https://github.com/dotnet/sdk/issues/50517\">a compromise package on the .NET SDK repo</a>, <a href=\"https://github.com/baronfel\">Chet Husk</a> described a slightly different approach that <a href=\"https://github.com/dotnet/aspire/commit/55e0bdc9796f3ea3da4c54402969d07610179f16\">he had taken with the Aspire CLI</a>. This approach is by necessity pretty hacky, as it has to dive into the internals of the pack command and tweak things. Overall, the result is quite different to my previous compromise package proposal.</p> <p>This alternative takes the following approach:</p> <ul><li>The tool targets a single target framework, anything .NET 9 or below.</li> <li>A framework-dependent platform agnostic version of the tool is embedded in the \"root\" package</li> <li>The <em>DotnetToolSettings.xml</em> file embedded in the root package is tweaked to look a bit like a cross between a <code>Version=1</code> file and a <code>Version=2</code> file</li></ul> <p>That last point is a surprising one, in that it really doesn't feel like it should work 😅 The resulting root package looks something like this:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_18.png\" alt=\"The alternative compromise package\"></p> <p>The <em>xml</em> file is marked as a <code>Version=1</code> file, and has <code>Runner=dotnet</code> for the command so it can be run by older .NET SDKs without issue. The <em>interesting</em> point is that apparently the .NET 10 SDK still reads the <code>RuntimeIdentifierPackage</code> elements, even though the file <em>isn't</em> <code>Version=2</code>.</p> <blockquote> <p>Which makes me wonder… why was a breaking <code>Version=2</code> needed if a purely additive solution to <code>Version=1</code> would have worked? 🤷</p> </blockquote> <p>Overall, this alternative package has many of the same pros and cons as my compromise package. There are a few notable differences:</p> <ul><li>My compromise package requires that you multi-target, with at least one framework being .NET 10, the alternative package makes most sense with a single non-.NET 10 framework.</li> <li>My compromise package generally requires that your platform-specific package is .NET 10, whereas the alternative package uses the same framework for everything.</li></ul> <p>I think that the differences between the approaches mean one isn't necessarily always better than the other, but you might find it suits some scenarios better than others.</p> <p>For completeness, the following is a complete <em>.csproj</em> file for the tool generated above. Just be aware that it's somewhat messing with the internals of the <code>Microsoft.NET.PackTool</code> targets:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token comment\">&lt;!-- Standard tool settings --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>Exe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>latest<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackAsTool</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackAsTool</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ToolCommandName</span><span class=\"token punctuation\">&gt;</span></span>sayhello<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ToolCommandName</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageId</span><span class=\"token punctuation\">&gt;</span></span>sayhello<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageId</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageVersion</span><span class=\"token punctuation\">&gt;</span></span>1.0.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageVersion</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Authors</span><span class=\"token punctuation\">&gt;</span></span>Andrew Lock<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Authors</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Description</span><span class=\"token punctuation\">&gt;</span></span>A tool that says hello<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Description</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageTags</span><span class=\"token punctuation\">&gt;</span></span>ascii;art;figlet;console;tool<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageTags</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageLicenseExpression</span><span class=\"token punctuation\">&gt;</span></span>MIT<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageLicenseExpression</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RollForward</span><span class=\"token punctuation\">&gt;</span></span>Major<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RollForward</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  \n  <span class=\"token comment\">&lt;!-- Package dependencies  --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Spectre.Console<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0.50.0<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.Data.Sqlite<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>9.0.8<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token comment\">&lt;!-- target .NET 10 and configure AOT etc--&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net10.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>linux-x64;linux-arm64;win-x64;win-arm64;osx-arm64;<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishTrimmed</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishTrimmed</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>StripSymbols</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>StripSymbols</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  \n  <span class=\"token comment\">&lt;!-- A bunch of hackery to embed the FDD build in the root package --&gt;</span>\n  <span class=\"token comment\">&lt;!-- and to fix the xml files to look like V1 --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span> <span class=\"token attr-name\">Condition</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(RuntimeIdentifier) == <span class=\"token punctuation\">'</span><span class=\"token punctuation\">'</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>_ToolPackageShouldIncludeImplementation</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>_ToolPackageShouldIncludeImplementation</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>GenerateNuspecDependsOn</span><span class=\"token punctuation\">&gt;</span></span>$(GenerateNuspecDependsOn);_MakeV2ConfigLookLikeV1<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>GenerateNuspecDependsOn</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Target</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_MakeV2ConfigLookLikeV1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token comment\">&lt;!-- Use the XmlPoke Task to make the v2 config also look like a v1 config --&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>XmlPoke</span>\n            <span class=\"token attr-name\">XmlInputPath</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(_ToolsSettingsFilePath)<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\">Value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\">Query</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/DotNetCliTool/@Version<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\">Namespaces</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(Namespace)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>XmlPoke</span>\n            <span class=\"token attr-name\">XmlInputPath</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(_ToolsSettingsFilePath)<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\">Value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token entity named-entity\" title=\"<\">&amp;lt;</span>Command Name=<span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span>$(ToolCommandName)<span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span> EntryPoint=<span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span>$(ToolEntryPoint)<span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span> Runner=<span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span>$(ToolCommandRunner)<span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span> /<span class=\"token entity named-entity\" title=\">\">&amp;gt;</span><span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\">Query</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/DotNetCliTool/Commands<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\">Namespaces</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(Namespace)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Target</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>This post is already plenty long enough, so I'm not going to go into any more detail about this approach, but it should at least give you an alternative for creating packages that can use the newest features of the .NET 10 SDK while remaining compatible with earlier .NET SDKs</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I discussed what the new platform-specific (self-contained or Native AOT compiled) NuGet package support means for package authors, and how to leverage them while still supporting users on pre-.NET 10 SDK versions. I started by describing the problem: users on older .NET SDKs can't use your tool at all by default if you use the new .NET 10 platform-specific tools feature.</p> <p>For the remainder of the post I described a potential compromise in which .NET 10 SDK users can use platform-specific tools, while pre-.NET SDK users continue to use a framework-dependent platform-agnostic version of the tool. This has some trade offs, in that the \"root\" package needs to be large, but this may still be worth it in some cases. I described two different variants of the package, each with different requirements and trade-offs.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/",
      "Title": "Packaging self-contained and native AOT .NET tools for NuGet: Exploring the .NET 10 preview - Part 7",
      "PublishDate": "2025-09-09T10:00:00+00:00",
      "Summary": "In this post we look at the new support for platform-specific .NET tools, so that you can pack your tools as self-contained or Native AOT packages",
      "Content": "<img src=\"https://andrewlock.net/content/images/2018/03/tinyapi_banner.jpg\" /><nav><p>This is the seventh post in the series: <a href=\"https://andrewlock.net/series/exploring-the-dotnet-10-preview/\">Exploring the .NET 10 preview</a>. </p> <ol class=\"list-none\"><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/\">Part 1 - Exploring the features of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/\">Part 2 - Behind the scenes of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/\">Part 3 - C# 14 extension members; AKA extension everything</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/\">Part 4 - Solving the source generator 'marker attribute' problem in .NET 10</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/\">Part 5 - Running one-off .NET tools with dnx</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/\">Part 6 - Passkey support for ASP.NET Core identity</a></li><li>Part 7 - Packaging self-contained and native AOT .NET tools for NuGet (this post) </li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/\">Part 8 - Supporting platform-specific .NET tools on old .NET SDKs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/\">Part 9 - Easier reflection with [UnsafeAccessorType] in .NET 10</a></li></ol></nav><p>In this post we'll look at the support for platform-specific .NET tools feature added in .NET 10,. This new feature allows you to pack tools in a variety of different ways—including self-contained, trimmed, and using native AOT—mirroring the many different ways you can publish .NET apps today.</p> <p>In this post we'll use a sample app to look at each of those package types in turn to see the impact the package type has on the package size and the contents of the packages. I'll highlight some of the bugs I found during testing, and also when the various package types might be most useful.</p> <h2 id=\"-net-tools\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#-net-tools\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">.NET tools</a></h2> <p>I discussed .NET tools at length in <a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/\">my previous post</a>, so for this post I'm going to assume you're already familiar with the general .NET tools feature. There's not been much change to them since .NET Core 3.0, so that's a pretty safe bet!</p> <p>That said, the previous post covers one important aspect that's particularly relevant to this post: <a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#ensuring-compatibility-by-multi-targeting\">ensuring compatibility for consumers of your package by multi-targeting your tool against multiple frameworks</a>. I strongly recommend reading that section of the post at least, if you haven't already.</p> <h2 id=\"the-many-ways-to-deploy-net-applications-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#the-many-ways-to-deploy-net-applications-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The many ways to deploy .NET applications.</a></h2> <p>So I'm assuming you already know a bit about .NET tools, but before we get to the new .NET tool features in .NET 10, we first need to look at some of the ways you can <a href=\"https://learn.microsoft.com/en-us/dotnet/core/deploying/\">publish your .NET applications</a> today:</p> <ul><li><strong>Framework-dependent executable</strong>. The .NET runtime must be installed on the target machine. The published app is small because it does not include any of the runtime binaries.</li> <li><strong>Self-contained executable</strong>. The published app includes all the .NET runtime binaries it needs, so is very large, but the benefit is that you don't need a .NET runtime installed on the target machine.</li> <li><strong>Trimmed self-contained executable</strong>. As with the previous example, but the binaries are <a href=\"https://learn.microsoft.com/en-us/dotnet/core/deploying/trimming/trim-self-contained\">trimmed</a> to remove unused code, significantly reducing the size of the published app.</li> <li><strong>Native AOT executable</strong>. <a href=\"https://learn.microsoft.com/en-us/dotnet/core/deploying/native-aot/?tabs=windows%2Cnet8\">Native Ahead of Time (AOT)</a> compiled applications have fast startup and smaller memory footprints, and don't need a .NET runtime installed on the host machine. They are platform-specific and some features (like some reflection APIs) are not available.</li></ul> <p>Another dimension to consider is whether deployments are \"platform agnostic\" or \"platform specific\". In simple terms:</p> <ul><li><strong>Platform agnostic deployments</strong> can run on <em>any</em> platform, e.g. Linux ARM64 or Windows x64, typically expressed as a runtime ID e.g. <code>linux-arm64</code>, <code>win-x64</code>.</li> <li><strong>Platform specific deployments</strong> can <em>only</em> run on a specific platform.</li></ul> <p>This becomes particularly important when you have <em>native</em> dependencies, so you need a different version of the library for each platform. In these cases, platform agnostic deployments include the native libraries for <em>all</em> supported platforms, whereas platform specific deployments need only include the libraries for a single platform.</p> <p>The rough summary is that the .NET 10 SDK now supports creating and consuming .NET tools using all these new deployment models.</p> <h2 id=\"-net-tools-support-more-deployment-models-in-net-10\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#-net-tools-support-more-deployment-models-in-net-10\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">.NET tools support more deployment models in .NET 10</a></h2> <p>Prior to .NET 10, it was only possible to publish .NET tools using the \"framework dependent\" deployment model. .NET 10 preview 6 <a href=\"https://github.com/dotnet/core/blob/main/release-notes/10.0/preview/preview6/sdk.md#platform-specific-net-tools\">announced support</a> for publishing .NET tools using more deployment models:</p> <ul><li>Framework-dependent, platform-agnostic (the way it works today)</li> <li>Framework-dependent, platform-specific</li> <li>Self-contained, platform-specific</li> <li>Trimmed, platform-specific</li> <li>Native AOT-compiled, platform-specific</li></ul> <p>The \"Framework-dependent, platform-specific\" option is useful if you have native dependencies in your app, as it effectively splits these across multiple NuGet packages, making each individual package smaller.</p> <p>The self-contained, trimmed, and NativeAOT options are particularly useful, as they mean you're no longer dependent on the consumer having the correct .NET runtime already installed on the target machine. Instead of having to <a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#ensuring-compatibility-by-multi-targeting\">support multiple runtimes</a> or <a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#configuring-your-tools-to-roll-forward\">configure <code>RollForward</code></a> for your application, you can just pack the whole runtime (ideally, trimmed or AOT compiled) into your package, and don't worry about the target machine.</p> <blockquote> <p>There's some caveats to this, which I discuss <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#limitations-and-recommendations\">at the end of this post</a>.</p> </blockquote> <p>That's the crux of the feature, so for the remainder of the post we'll look at how to generate each of the different packages, what the NuGet packages look like, and what they contain.</p> <h3 id=\"the-sample-app\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#the-sample-app\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The sample app</a></h3> <p>For the test app, I created a sample based on Chet Husk's <a href=\"https://github.com/baronfel/multi-rid-tool\">multi-rid-tool</a> which looked a bit like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>Exe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFrameworks</span><span class=\"token punctuation\">&gt;</span></span>netcoreapp3.1;net5.0;net6.0;net7.0;net8.0;net9.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFrameworks</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>EmbedUntrackedSources</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>EmbedUntrackedSources</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>CopyOutputSymbolsToPublishDirectory</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>CopyOutputSymbolsToPublishDirectory</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackAsTool</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackAsTool</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ToolCommandName</span><span class=\"token punctuation\">&gt;</span></span>sayhello<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ToolCommandName</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageId</span><span class=\"token punctuation\">&gt;</span></span>sayhello<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageId</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageVersion</span><span class=\"token punctuation\">&gt;</span></span>1.0.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageVersion</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Authors</span><span class=\"token punctuation\">&gt;</span></span>Andrew Lock<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Authors</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Description</span><span class=\"token punctuation\">&gt;</span></span>A tool that says hello<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Description</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageLicenseExpression</span><span class=\"token punctuation\">&gt;</span></span>MIT<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackageLicenseExpression</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Spectre.Console<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0.50.0<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.Data.Sqlite<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>9.0.8<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>There's nothing particularly interesting there, it's a simple exe called <code>sayhello</code> that has a <em>bunch</em> of target frameworks, is packed as a .NET tool, and has a couple of dependencies. The <em>Microsoft.Data.Sqlite</em> dependency is there to ensure we have a native dependency (SQLite) while Spectre.Console is there because it's cool.</p> <p>In <em>Program.cs</em> we have some simple code that ensures we use the dependencies (to make sure they're not completely trimmed out for example):</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span>Sqlite</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Spectre<span class=\"token punctuation\">.</span>Console</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SqliteConnection</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Data Source=:memory:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconnection<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> command <span class=\"token operator\">=</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">CreateCommand</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncommand<span class=\"token punctuation\">.</span>CommandText <span class=\"token operator\">=</span> <span class=\"token string\">\"SELECT 'world'\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> reader <span class=\"token operator\">=</span> command<span class=\"token punctuation\">.</span><span class=\"token function\">ExecuteReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> name <span class=\"token operator\">=</span> reader<span class=\"token punctuation\">.</span><span class=\"token function\">GetString</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> figlet <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">FigletText</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Hello </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">name</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">!\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">Centered</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">Color</span><span class=\"token punctuation\">(</span>Color<span class=\"token punctuation\">.</span>Green<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    AnsiConsole<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span>figlet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>This program just prints <code>Hello world!</code> when you run it:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-powershell\"><code class=\"language-powershell\">    _   _          _   _                                       _       _   _ \n   <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>   ___  <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>   ___     __      __   ___    _ __  <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>   __<span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>\n   <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>_<span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>  <span class=\"token operator\">/</span> _ \\ <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>  <span class=\"token operator\">/</span> _ \\    \\ \\ <span class=\"token operator\">/</span>\\ <span class=\"token operator\">/</span> <span class=\"token operator\">/</span>  <span class=\"token operator\">/</span> _ \\  <span class=\"token punctuation\">|</span> '__<span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>  <span class=\"token operator\">/</span> _` <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>\n   <span class=\"token punctuation\">|</span>  _  <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>  __/ <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">|</span>    \\ V  V <span class=\"token operator\">/</span>  <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>    <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>_<span class=\"token punctuation\">|</span>\n   <span class=\"token punctuation\">|</span>_<span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>_<span class=\"token punctuation\">|</span>  \\___<span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>_<span class=\"token punctuation\">|</span> <span class=\"token punctuation\">|</span>_<span class=\"token punctuation\">|</span>  \\___/      \\_/\\_/    \\___/  <span class=\"token punctuation\">|</span>_<span class=\"token punctuation\">|</span>    <span class=\"token punctuation\">|</span>_<span class=\"token punctuation\">|</span>  \\__<span class=\"token punctuation\">,</span>_<span class=\"token punctuation\">|</span> <span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span>\n</code></pre></div> <p>Next we're going to publish it using each of the five different approaches. In each case we <em>could</em> control the publish output by passing values to the <code>dotnet pack</code> commands. However, in practice you'll likely want to embed the options inside the project file, so that's the approach I take in this post.</p> <h3 id=\"framework-dependent-platform-agnostic\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#framework-dependent-platform-agnostic\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Framework-dependent, platform agnostic</a></h3> <p>For the application above, by default, when you run <code>dotnet pack</code> you'll get a framework-dependent, platform agnostic package. The tool can be installed on any of the supported platforms, but you need one of the supported .NET runtimes installed on the target machine:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet pack <span class=\"token parameter variable\">-o</span> ./artifacts/packages/agnostic\n</code></pre></div> <p>This produces the package in the <em>./artifacts/packages/agnostic</em> folder, and results in a single, chonky, package:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_01.png\" alt=\"The sayhello package is large, at 91MB\"></p> <p>If you open the package using <a href=\"https://github.com/nugetpackageexplorer\">NuGet Package Explorer</a>, you can see why the package is so large: it contains duplicate files for every target framework, and each target framework contains the native files for <em>all</em> the supported platforms</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_02.png\" alt=\"The package contains a folder for each target framework, each of which contains all the runtimes\"></p> <p>Finally, if we look at the <em>DotnetToolSettings.xml</em> file, we see something like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DotNetCliTool</span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Command</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">EntryPoint</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MultiRid.dll<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Runner</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>dotnet<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DotNetCliTool</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>This package is effectively the same as you get today if you're packing your .NET tools with the .NET 9 SDK or earlier.</p> <p>There are two main reasons the package is large:</p> <ul><li>We target multiple frameworks to support multiple .NET runtime environments</li> <li>We support all platforms in a single package.</li></ul> <p>For the next scenario, we address the second of those points.</p> <h3 id=\"framework-dependent-platform-specific\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#framework-dependent-platform-specific\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Framework-dependent, platform specific</a></h3> <p>In the next scenario, instead of supporting <em>all</em> platforms (<code>linux-x64</code>/<code>win-x64</code> etc) in a single package, we split each of those into a separate package. This is handled automatically by the .NET 10 SDK when you specify runtime IDs in your project. To produce platform-specific NuGet packages, we simply add the following property group to our project:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token comment\">&lt;!-- specific --&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>linux-x64;linux-arm64;win-x64;win-arm64;any<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>There's a couple of interesting points here:</p> <ul><li><strong>We explicitly set <code>PublishSelfContained=false</code></strong>. This is because on earlier versions of .NET Core, setting a runtime ID would automatically set <code>PublishSelfContained=true</code>, but that's a different scenario we're going to get to later!</li> <li><strong>We have an additional <code>any</code> runtime ID</strong>. The <code>any</code> option was <a href=\"https://github.com/dotnet/core/blob/main/release-notes/10.0/preview/preview7/sdk.md#any-rid-in-multi-rid-tools\">added in .NET 10 preview 7</a> and is meant to ensure you still produce a \"platform agnostic\" package <em>in addition</em> to the platform-specific packages, so that you have a \"fallback\".</li></ul> <p>If we run .NET pack again:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet pack <span class=\"token parameter variable\">-o</span> ./artifacts/packages/specific\n</code></pre></div> <p>This time we end up with 6 different packages:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_03.png\" alt=\"The dotnet pack command produces 6 different packages\"></p> <p>We now have</p> <ul><li>A \"top level\" NuGet package with the \"correct\" name for our tool.</li> <li>A package for each of the 4 specific runtime IDs we specified in our project file.</li> <li>An \"any\" package, which should be used on platforms that don't have a dedicated package.</li></ul> <p>We'll look at each of these packages in turn.</p> <p>The top-level package is tiny, and contains just a single file for each target framework:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_04.png\" alt=\"The DotnetToolSettings.xml file for each framework \"></p> <p>The <em>DotnetToolSettings.xml</em> file in this case looks like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DotNetCliTool</span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Command</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifierPackages</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifierPackage</span> <span class=\"token attr-name\">RuntimeIdentifier</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>linux-x64<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello.linux-x64<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifierPackage</span> <span class=\"token attr-name\">RuntimeIdentifier</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>linux-arm64<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello.linux-arm64<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifierPackage</span> <span class=\"token attr-name\">RuntimeIdentifier</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>win-x64<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello.win-x64<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifierPackage</span> <span class=\"token attr-name\">RuntimeIdentifier</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>win-arm64<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello.win-arm64<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifierPackage</span> <span class=\"token attr-name\">RuntimeIdentifier</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>any<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello.any<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RuntimeIdentifierPackages</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DotNetCliTool</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>There's some interesting aspects to this file compared to the platform agnostic version:</p> <ul><li>The <code>&lt;DotNetCliTool&gt;</code> element has <code>Version=2</code> for the platform-specific version, and <code>Version=1</code> for the platform-agnostic version.</li> <li>There's a collection of <code>&lt;RuntimeIdentifierPackage&gt;</code> which match a runtime ID to a different package.</li></ul> <p>If we look at one of those platform-specific packages, e.g. <em>sayhello.linux-x64.1.0.0</em>, and compare it to the platform agnostic version, we can see why it's so much smaller:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_05.png\" alt=\"The sayhello.linux-x64 package contents\"></p> <p>There's still a folder for every target framework, but now instead of a <em>runtimes</em> folder with all the different platform-specific binaries, there's only the single platform, <code>linux-x64</code> in this case.</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_14.png\" alt=\"Comparing the platform agnostic package to the platform specific package\"></p> <p>It's also worth looking at the <em>DotnetToolSettings.xml</em> file in these packages:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DotNetCliTool</span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Command</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">EntryPoint</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MultiRid<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Runner</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>executable<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DotNetCliTool</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>As you can see, this is another <code>Version=2</code> manifest and interestingly this is where we see a new \"runner\" type, <code>executable</code>, with a defined <code>EntryPoint</code> which is the executable that will run.</p> <p>So the platform-specific packages can be much smaller as they only need a single runtime, but the <code>any</code> package <em>does</em> still need all those runtimes, so that it will work on any platform. Unfortunately, <a href=\"https://github.com/dotnet/sdk/issues/50312\">there's currently a bug</a> which means that <em>none</em> of the runtimes are currently included, so actually the <em>any</em> package <em>won't</em> work on any platform if your app has native dependencies 😅 That should be fixed <a href=\"https://github.com/dotnet/sdk/pull/50376\">in .NET 10 RC2</a>.</p> <h3 id=\"self-contained-platform-specific\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#self-contained-platform-specific\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Self-contained, platform specific</a></h3> <p>For the next permutation, we build a self-contained application, so we bundle the .NET runtime as part of the package. The other change in this case is that there's no point in targeting multiple frameworks for increased compatibility; you only need to target one, because it's going to be bundled in the package anyway:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net9.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>linux-x64;linux-arm64;win-x64;win-arm64<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>The other thing to note is that there's no <code>any</code> runtime ID here. That's because there's currently a bug that will cause errors if you try to add it:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"> C:<span class=\"token punctuation\">\\</span>Program Files<span class=\"token punctuation\">\\</span>dotnet<span class=\"token punctuation\">\\</span>sdk<span class=\"token punctuation\">\\</span><span class=\"token number\">10.0</span>.100-preview.7.25380.108<span class=\"token punctuation\">\\</span>Sdks<span class=\"token punctuation\">\\</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\\</span>targets<span class=\"token punctuation\">\\</span>Microsoft.NET.Sdk.FrameworkReferenceResolution.targets<span class=\"token punctuation\">(</span><span class=\"token number\">528,5</span><span class=\"token punctuation\">)</span>:\nerror NETSDK1082: There was no runtime pack <span class=\"token keyword\">for</span> Microsoft.NETCore.App available <span class=\"token keyword\">for</span> the specified RuntimeIdentifier <span class=\"token string\">'any'</span><span class=\"token builtin class-name\">.</span>\n</code></pre></div> <p>This <a href=\"https://github.com/dotnet/sdk/pull/50421\">should also be fixed</a> for .NET 10 RC 2, and will mean you can have a true fallback package, just as we saw for the framework-dependent, platform-specific case. For now though, we'll have to do without the <code>any</code> package.</p> <p>Running <code>dotnet pack</code> once again:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet pack <span class=\"token parameter variable\">-o</span> ./artifacts/packages/specific\n</code></pre></div> <p>If we look at the packages this scenario produces, they're very similar to the previous framework-dependent platform-specific case, but much larger, because they ship .NET in the package too:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_06.png\" alt=\"The self-contained, platform-specific packages\"></p> <p>The root <code>sayhello</code> package is essentially the same as the root package for the platform-specific version, the only difference being that the self-contained package only contains a single target framework.</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_08.png\" alt=\"The sayhello root package only contains a sing any\"></p> <p>However, If we look inside the platform-specific packages like <code>sayhello.linux-arm64</code> you'll see that there's a <em>lot</em> of files in the package, everything you need to run the .NET app, even when there's no .NET runtime installed on the target application.</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_07.png\" alt=\"Inside the sayhello.linux-arm64 package there are a lot files, that are part of the .NET runtime\"></p> <p>If we look at the <em>DotnetToolSettings.xml</em> file in these self-contained package you can see that it's still the same as the framework-dependent platform-specific package, pointing towards the executable shim:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DotNetCliTool</span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>2<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Command</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sayhello<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">EntryPoint</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MultiRid.exe<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Runner</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>executable<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Commands</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DotNetCliTool</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>Even though these packages are large, if you think back to the first framework-dependent, platform agnostic package we're much smaller than the 90MB we started with.</p> <h3 id=\"self-contained-trimmed\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#self-contained-trimmed\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Self-contained, trimmed</a></h3> <p>If you're going to go to the effort of building self-contained, platform-specific packages, then it <em>likely</em> makes sense to go to the next step and enable trimming too. <a href=\"https://learn.microsoft.com/en-us/dotnet/core/deploying/trimming/trim-self-contained\">Enabling an application for trimming</a> <em>can</em> be somewhat risky depending on the libraries and methods your application uses. However, if your application <em>is</em> amenable to trimming, it can significantly reduce the resulting package sizes.</p> <p>To create trimmed NuGet packages, you just need the <code>&lt;PublishTrimmed&gt;</code> property on top of our previous configuration:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net9.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>linux-x64;linux-arm64;win-x64;win-arm64<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token comment\">&lt;!-- 👇 Add this --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishTrimmed</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishTrimmed</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>Again we publish with</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet pack <span class=\"token parameter variable\">-o</span> ./artifacts/packages/trimmed\n</code></pre></div> <p>And this time the packages are a third of the size, around 10MB each, much better!</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_09.png\" alt=\"The packages when building self-contained trimmed packages\"></p> <p>We're almost done, the last case we have to look at is native AOT.</p> <h3 id=\"native-aot\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#native-aot\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Native AOT</a></h3> <p>As per <a href=\"https://learn.microsoft.com/en-us/dotnet/core/deploying/native-aot/\">the documentation</a>:</p> <blockquote> <p>Publishing your app as <em>Native AOT</em> produces an app that's self-contained and that has been ahead-of-time (AOT) compiled to native code. Native AOT apps have faster startup time and smaller memory footprints. These apps can run on machines that don't have the .NET runtime installed.</p> </blockquote> <p>If you're <em>already</em> packaging your application as both self-contained and trimmed, it's very possible that your application could be Native AOT compatible too. And given that you're building tools, it's very possible that you could get real benefits from compiling your application as native AOT.</p> <p>We'll update the tool to build as Native AOT, and to reduce the size of the package, we'll also strip the symbols</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>linux-x64;linux-arm64;win-x64;win-arm64;<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RuntimeIdentifiers</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishSelfContained</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishTrimmed</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishTrimmed</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token comment\">&lt;!-- 👇 Add these --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>StripSymbols</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>StripSymbols</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>Publishing for native AOT is a little trickier than for the other packages, because you can <em>only</em> native AOT compile on the same platform as you're running on. In total, you need to run <code>dotnet pack</code> once for each runtime, and once for the \"root\" package.</p> <p>Running the simple <code>dotnet pack</code> produces the \"root\" package:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet pack <span class=\"token parameter variable\">-o</span> ./artifacts/packages/nativeoat\n</code></pre></div> <p>and then you need to run <code>dotnet pack</code> for each runtime ID, for example:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet pack <span class=\"token parameter variable\">-o</span> ./artifacts/packages/nativeaot --runtime-id win-x64\n</code></pre></div> <p>This produces the <code>sayhello.win-x64.1.0.0</code> package only. You then need to run it again for each of the supported runtimes.</p> <blockquote> <p><a href=\"https://bsky.app/profile/chethusk.bsky.social\">Chet Husk</a> has an example of how you can do this in GitHub actions and later aggregate the packages together. Note that he uses <code>--current-runtime</code> instead of listing each runtime ID specifically. Be aware that <a href=\"https://github.com/dotnet/sdk/issues/50313\">this <em>doesn't</em> work</a> if you are using <code>&lt;TargetFrameworks&gt;</code> in your project; you must use <code>&lt;TargetFramework&gt;</code> instead.</p> </blockquote> <p>If we look at those packages, you can see that the native AOT packages are even smaller than the trimmed packages!</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_10.png\" alt=\"The native AOT packages are only 2.5MB\"></p> <p>And if we look inside the package, you can see that there's only 2 application files left: the native AOT'd .NET tool, and the native library:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_11.png\" alt=\"The contents of the native AOT package\"></p> <p>In many ways this represents the \"pinnacle\" of .NET tool usability; on supported platforms, consumers of your tool will benefit from the fastest start up times and the smallest download sizes (which further improves <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/\">the dnx one-off-tool experience</a>). In the cases where you're on an unsupported platform, you should be able to fallback to the same framework dependent, platform-agnostic packages that are available today, so there's nothing much lost there.</p> <blockquote> <p>Note that as mentioned earlier, the <code>any</code> fallback for self-contained, trimmed, and Native AOT packages does not work as of .NET 10 preview 7, but <a href=\"https://github.com/dotnet/sdk/pull/50421\">it should be working</a> for RC2.</p> </blockquote> <p>So the last remaining question is: as a tool author, should you actually use these new platform-specific packages?</p> <h2 id=\"limitations-and-recommendations\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#limitations-and-recommendations\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Limitations and recommendations</a></h2> <p>The main limitation with <em>all</em> of the new platform-specific package types is that they only work when you're using the .NET 10 SDK. If you try to install any of the packages that use version 2 of the <code>&lt;DotNetCliTool&gt;</code> element then you'll get an error similar to the following:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dotnet tool <span class=\"token function\">install</span> sayhello --tool-path .<span class=\"token punctuation\">\\</span>specific <span class=\"token parameter variable\">--source</span> D:<span class=\"token punctuation\">\\</span>repos<span class=\"token punctuation\">\\</span>blog-examples<span class=\"token punctuation\">\\</span>MultiRid<span class=\"token punctuation\">\\</span>artifacts<span class=\"token punctuation\">\\</span>packages<span class=\"token punctuation\">\\</span>specific\n\nTool <span class=\"token string\">'sayhello'</span> failed to update due to the following:\nThe settings <span class=\"token function\">file</span> <span class=\"token keyword\">in</span> the tool<span class=\"token string\">'s NuGet package is invalid: Command '</span>sayhello<span class=\"token string\">' uses unsupported runner '</span>'.\"\nTool <span class=\"token string\">'sayhello'</span> failed to install. Contact the tool author <span class=\"token keyword\">for</span> assistance.\n</code></pre></div> <p>Given this requirement, depending on the specifics of the .NET tool you're creating, the benefits of creating a platform-specific tool may be limited.</p> <p>First of all, if your tool don't have any native dependencies, then there's fundamentally no difference between the framework-dependent platform-<em>specific</em> packages and the framework-dependent platform <em>agnostic</em> packages, other than the fact that you can only run the platform-specific tool if you're using the .NET 10 SDK.</p> <p>Where things get interesting is if you're currently targeting <em>multiple</em> frameworks with your tool. In these cases you end up with multiple instances of the app, compiled for each target framework, all packaged in the same <em>.nupkg</em>. If you want to support the widest range of installed frameworks, then theoretically you need a new copy for every framework. That can both increase complexity in the tool and increase the size of the package that needs to be downloaded.</p> <blockquote> <p>You can avoid that somewhat by configuring <a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#configuring-your-tools-to-roll-forward\">the <code>rollForward</code> rules</a> for your tool, but there's always a certain amount of risk in relying solely on that approach.</p> </blockquote> <p>The neat thing about the self-contained/trimmed/Native AOT packages is that you <em>don't</em> need to multi-target your application for multiple frameworks, because you include the framework in the package! That reduces the complexity in your tool (no need to multi-target) and the size of your package (no need for multiple copies of the compiled app).</p> <p>At least, that's the theory. <em>Today</em>, it's not really true, because these packages <em>only</em> support .NET 10, because they require the .NET 10 SDK to install the tool. So ease of support and compatibility is actually a reason <em>not</em> to use the platform-specific packages today. This will become less of a problem as time goes on and more people are using the latest .NET SDKs, but today it's hard to recommend as your sole approach.</p> <p>That said, there are <em>some</em> \"escape route\" avenues I explored to try to get the best of both worlds. These may work for you if you want to support both the enhanced experience of the .NET 10 SDK while still supporting users stuck on older SDKs.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I described the new platform-specific .NET tool packages that are supported in .NET 10 as of preview 6 and 7. The .NET 10 SDK allows you to easily create \"root\" meta-packages that delegate to platform-specific versions of your .NET tool. This is particularly useful if your app has native dependencies, as it can significantly reduce the size of each package.</p> <p>In addition, you can create self-contained, trimmed, or native AOT compiled versions of your app. These packages mean you're no longer beholden to the consumer having the correct version of the runtime installed for your tool (though currently it does mean they <em>must</em> have the .NET 10 SDK installed).</p> <p>In this post we looked at the results of using each of the new package types, the impact it has on the package size and the contents of the packages. I highlighted some of the bugs I found during testing (but which will hopefully be resolved by the time .NET 10 goes GA in November). Finally, I discussed some of the limitations of the new packages, the most important being that you must have the .NET 10 SDK installed to install tools that use the new package types.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/using-and-authoring-dotnet-tools/",
      "Title": "Using and authoring .NET tools",
      "PublishDate": "2025-09-02T10:00:00+00:00",
      "Summary": "In this post I describe some of the complexities around authoring .NET tools, specifically around supporting multiple .NET runtimes and testing in CI",
      "Content": "<img src=\"https://andrewlock.net/content/images/2019/tools.jpg\" /><p>In this post I describe some of the complexities around authoring .NET tools, particularly where you don't know which version of the .NET runtime customers will have installed. Finally, I provide some tips for working with and testing .NET tools in a continuous integration (CI) environment.</p> <h2 id=\"what-are-net-tools-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#what-are-net-tools-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What are .NET tools?</a></h2> <p><a href=\"https://learn.microsoft.com/en-us/dotnet/core/tools/global-tools\">.NET tools</a> are programs that are distributed via NuGet and can be installed using the .NET SDK. They can either be installed globally on a machine or locally to a specific folder.</p> <p>There are a number of first-party global tools from Microsoft, like the <a href=\"https://learn.microsoft.com/en-us/ef/core/cli/dotnet\">EF Core tool</a>, but you can also write your own. In the past I've described creating <a href=\"https://andrewlock.net/creating-a-net-core-global-cli-tool-for-squashing-images-with-the-tinypng-api/\">a tool that uses the TinyPNG API to squash images</a>, and <a href=\"https://andrewlock.net/converting-web-config-files-to-appsettings-json-with-a-net-core-global-tool/\">a tool for converting web.config files to appsettings.json format</a>. The majority of .NET tools are command-line tools, but there's no reason they <em>need</em> to be. MonoGame's Content Builder tools for example <a href=\"https://andrewlock.net/creating-your-first-sample-game-with-monogame/#exploring-the-default-monogame-template\">include GUI tools</a> as well.</p> <h2 id=\"working-with-local-tools\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#working-with-local-tools\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Working with local tools</a></h2> <p>Some tools make the most sense as global tools. If they're broadly applicable to multiple applications, and you generally don't need a specific version of the tool for use in different projects (<a href=\"https://www.nuget.org/packages/DiffEngineTray\"><code>DiffEngineTray</code> is a good example</a>) then global tools make sense. However, that's <em>not</em> always the case. Sometimes the version of the tool <em>does</em> matter, and you want different versions for different applications.</p> <p>In these cases, <em>local tools</em> are a better option. You can define the tools that are required for a specific project by creating a <em>dotnet-tools manifest</em>. This is a JSON file which lives in your repository and is checked-in to source control. You can create a new tool-manifest by running the following in the root of your repository:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet new tool-manifest\n</code></pre></div> <p>By default, this creates the following manifest JSON file <em>dotnet-tools.json</em> inside the .config folder of your repository:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"isRoot\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"tools\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The initial manifest doesn't include any tools, but you can install new ones by running <code>dotnet tool install</code> (i.e. without the <code>-g</code> or <code>--tool-path</code> flag). So you can, for example, install the Cake tool for your project by running:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dotnet tool <span class=\"token function\">install</span> Cake.Tool\n\nYou can invoke the tool from this directory using the following commands: <span class=\"token string\">'dotnet tool run dotnet-cake'</span> or <span class=\"token string\">'dotnet dotnet-cake'</span><span class=\"token builtin class-name\">.</span>\nTool <span class=\"token string\">'cake.tool'</span> <span class=\"token punctuation\">(</span>version <span class=\"token string\">'0.35.0'</span><span class=\"token punctuation\">)</span> was successfully installed. Entry is added to the manifest <span class=\"token function\">file</span> C:<span class=\"token punctuation\">\\</span>repos<span class=\"token punctuation\">\\</span>test<span class=\"token punctuation\">\\</span>.config<span class=\"token punctuation\">\\</span>dotnet-tools.json.\n</code></pre></div> <p>This updates the manifest by adding the <code>cake.tool</code> reference to the <code>tools</code> section, including the version required (the current latest version - you can update the version manually as required), and the command you need to run to execute the tool (<code>dotnet-cake</code>):</p> <div class=\"pre-code-wrapper\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"isRoot\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"tools\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"cake.tool\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"5.0.0\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"commands\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"dotnet-cake\"</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>When a colleague clones the repository and wants to run the Cake tool, they can run the following commands to first restore the tool, and then run it:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Restore the NuGet packages specifed in the manifest</span>\ndotnet tool restore\n\n<span class=\"token comment\"># Run the tool using one of the following forms:</span>\ndotnet tool run dotnet-cake\n<span class=\"token comment\"># or you can use:</span>\ndotnet dotnet-cake\n<span class=\"token comment\"># or even shorter:</span>\ndotnet cake\n</code></pre></div> <p>Alternatively, as of .NET 10 preview 6, you can use the even simpler <code>dnx</code> or <code>dotnet dnx</code> tools to one-shot run the tools. When the tool is specified in the tool manifest, you can just use <code>dnx</code> and it will automatically use the version specified in the manifest:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># One-shot run the tool using either of the following:</span>\ndnx Cake.Tool\ndotnet dnx Cake.Tool\n</code></pre></div> <p>.NET tools are basically just a .NET application packed into a NuGet package, so they are subject to all the same requirements. One of the most important aspects is the fact that .NET applications are compiled against a specific runtime. And that's also where things can get a bit tricky.</p> <h2 id=\"ensuring-compatibility-by-multi-targeting\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#ensuring-compatibility-by-multi-targeting\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Ensuring compatibility by multi-targeting</a></h2> <p>There are a couple of slightly annoying difficulties working with, and authoring, .NET tools. .NET tools are just normal <a href=\"https://learn.microsoft.com/en-us/dotnet/core/deploying/?pivots=visualstudio#framework-dependent-deployment\">framework-dependent</a> .NET apps, so they are dependent on the correct .NET runtime being available on your machine. As a concrete example, if you build a .NET tool, and it targets <code>net8.0</code>, then you <em>must</em> have the .NET 8 runtime installed on the target machine, regardless of which version of the SDK you <em>install</em> the tool with.</p> <p>As a consequence, if you want to support <em>any</em> the of the runtimes a customer <em>might</em> have installed on their machine, then you need to build and pack your tool for <em>multiple</em> target frameworks.</p> <p>That's easy enough to do in principal, as you can \"just\" add all the target frameworks you need to support in your project's <code>&lt;TargetFrameworks&gt;</code> element in the <em>.csproj</em> file</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>Exe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token comment\">&lt;!-- 👇 Targeting ALL the frameworks!--&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFrameworks</span><span class=\"token punctuation\">&gt;</span></span>netcoreapp2.1;netcoreapp3.0;netcoreapp3.1;net5.0;net6.0;net7.0;net8.0;net9.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFrameworks</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>latest<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackAsTool</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PackAsTool</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ToolCommandName</span><span class=\"token punctuation\">&gt;</span></span>sayhello<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ToolCommandName</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>As you can see from the above list, if you <em>really</em> want to support everything, then that's a <em>lot</em> of target frameworks to add. And it's not without its downsides.</p> <p>For a start, when you create multi-targeted apps like this, you'll <em>generally</em> be limited to <em>only</em> APIs present in the <em>lowest</em> target framework. In the example above, that means .NET Core 2.1 APIs😬</p> <p>What's more, each target framework you add here increases the size of the NuGet package. When you pack your app, you'll build it for each of the target frameworks, and pack everything into the same NuGet package:</p> <p><img src=\"https://andrewlock.net/content/images/2025/multirid_13.png\" alt=\"The contents of the package with multiple runtimes packed into the same package\"></p> <p>This can significantly increase the size of the package, which isn't <em>generally</em> a problem, except that it makes all restore and <code>dnx</code> operations (for example) slower.</p> <p>Building and packaging for all the target runtimes that you support is the \"safest\" approach to supporting the widest range of customers that you can. However, if you're willing to take a little risk there's an alternative approach.</p> <h2 id=\"configuring-your-tools-to-roll-forward\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#configuring-your-tools-to-roll-forward\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Configuring your tools to roll forward</a></h2> <p>In the previous section I said that explicitly targeting all the .NET runtimes that you support in a .NET tool is the \"best\" way to make sure your tool can run on a customer's environment, regardless of which runtime they use.</p> <p>However, an alternative (and in many ways, complementary) approach, is to <em>not</em> target all these runtime versions. Instead, you allow your application to run with a <em>newer</em> version of the runtime than it was built for, by using the <code>&lt;RollForward&gt;</code> element.</p> <p>For example, let's say you have a tool that works on .NET 6 and you don't want to have to multi-target it for .NET 7, .NET 8, .NET 9 etc as well. Given that each version of .NET has very high compatibility with the previous version, you could instead <em>only</em> build your tool for .NET 6, and then tell the <code>dotnet</code> host to allow using <em>any</em> runtime that's available for .NET 6 or above. You can do this by setting <code>RollForward=Major</code> in your project file:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net6.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RollForward</span><span class=\"token punctuation\">&gt;</span></span>Major<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RollForward</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>Setting <code>&lt;RollForward&gt;</code> in your project ensures that this property is copied to the <a href=\"https://learn.microsoft.com/en-us/dotnet/core/versions/selection#control-roll-forward-behavior\"><em>runtimeonfig.json</em> file</a> that is deployed with your tool. You can find this inside your NuGet packge; note the <code>rollFoward</code> property below that mirrors the value you set in your project:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"runtimeOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"tfm\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"net6.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"rollForward\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Major\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"framework\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Microsoft.NETCore.App\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"6.0.0\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"configProperties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"System.Reflection.Metadata.MetadataUpdater.IsSupported\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>With the <code>rollForward</code> configured for your tool, as long as someone is able to install your .NET tool (which they can do as long as they have the .NET 6+ SDK installed) then they will be able to run the app, even though you <em>only</em> built and packaged your app for .NET 6.</p> <blockquote> <p>Note that this isn't <em>completely</em> safe, as the .NET runtime isn't <em>guaranteed</em> to be compatible across major versions. Nevertheless, in practice it's relatively safe, and is generally recommended.</p> </blockquote> <p>One of the best reasons to set <code>RollForward=Major</code> in your project even if you <em>do</em> pack for multiple target frameworks is to support <em>currently unreleased</em> .NET versions that come out in the future. For example, let's say you have a .NET tool published that supports .NET 9. By default, when .NET 10 comes out, people won't be able to run your tool unless you go back and explicitly add a <code>net10.0</code> target. By setting <code>RollForward=Major</code> you can ensure there's <em>some</em> support immediately.</p> <h2 id=\"handy-dotnet-tool-tips\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#handy-dotnet-tool-tips\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Handy <code>dotnet tool</code> tips</a></h2> <p>The final section in this post is a bit of a grab-bag of handy options available when working with .NET tools, particularly when you're doing things in continuous integration (CI) systems. These are generally things I have run into when working with them myself, and they aren't always obvious.</p> <h3 id=\"testing-locally-built-packages-with-source-and-tool-path\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#testing-locally-built-packages-with-source-and-tool-path\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Testing locally built packages with <code>--source</code> and <code>--tool-path</code></a></h3> <p>As mentioned previously, .NET tools are basically just .NET apps, so for the most part you can test them the way you would test any other apps. However, you may also want to explicitly test the final artifact that you're producing, i.e. the <em>.nupkg</em> file.</p> <p>When you're testing a tool you've produced locally, I recommend using both the <code>--source</code> and <code>--tool-path</code> settings:</p> <ul><li><code>--source</code> Specifies where to install the tool <em>from</em>. Point it to a folder containing <em>.nupkg</em> files to install from those packages only, instead of other NuGet sources.</li> <li><code>--tool-path</code> Specifies where to install the tool <em>to</em>. The .NET tool will be installed and unpacked to this directory and can then be run from this directory.</li></ul> <p>For example:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Install version 1.2.3 of the dd-trace package </span>\n<span class=\"token comment\"># that is found in the /app/install/ folder</span>\n<span class=\"token comment\"># and install it into the /tool path</span>\ndotnet tool <span class=\"token function\">install</span> dd-trace <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--source</span> /app/install/. <span class=\"token punctuation\">\\</span>\n    --tool-path /tool <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--version</span> <span class=\"token number\">1.2</span>.3\n</code></pre></div> <p>Using both of these settings when you're testing locally-built packages ensures that you are both <em>actually</em> installing the tool that you think you are (instead of accidentally installing from a remote source), and that you're not \"polluting\" your local NuGet cache with these test files.</p> <h3 id=\"installing-pre-release-versions-with-prerelease\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#installing-pre-release-versions-with-prerelease\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Installing pre-release versions with <code>--prerelease</code></a></h3> <p>If you're producing a package that has a pre-release suffix (i.e. it has a version like <code>1.0.0-beta</code> or <code>0.0.1-preview</code> instead of just <code>1.0.0</code> or <code>0.0.1</code>) then you may be surprised to find you <em>can't</em> easily test it locally. This is because you must pass the <code>--prerelease</code> flag when installing a pre-release version:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># The --prerelease flag is required when installing pre-release versions</span>\ndotnet tool <span class=\"token function\">install</span> dd-trace <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--source</span> /app/install/. <span class=\"token punctuation\">\\</span>\n    --tool-path /tool <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--version</span> <span class=\"token number\">1.2</span>.3-preview <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--prerelease</span>\n</code></pre></div> <p>Note that this flag is only available from .NET 5+ of the .NET SDK</p> <h3 id=\"provide-robustness-with-allow-downgrade\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#provide-robustness-with-allow-downgrade\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Provide robustness with <code>--allow-downgrade</code></a></h3> <p>If you're installing a .NET tool in CI you should generally specify a version, to make sure that your CI is repeatable. But what happens if the tool is already installed?</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dotnet tool <span class=\"token function\">install</span> <span class=\"token parameter variable\">-g</span> dotnet-serve <span class=\"token parameter variable\">--version</span> <span class=\"token number\">1.10</span>.175\nThe requested version <span class=\"token number\">1.10</span>.175 is lower than existing version <span class=\"token number\">1.10</span>.190.\n</code></pre></div> <p>As shown in the above example, if you try to install a version of a tool that is <em>lower</em> than the currently installed version, this will fail.</p> <blockquote> <p>I <em>think</em> that historically you actually couldn't install <em>any</em> new version of a tool if it was already installed on the machine, and instead you would have to use <code>dotnet tool update</code>, but as of at least .NET 9 it seems you can technically update to a <em>newer</em> version of a package using the above <code>dotnet tool install</code> command.</p> </blockquote> <p>The <code>dotnet tool update</code> command works by uninstalling the tool and then installing a new version, so you might think that you can use that instead, but no:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dotnet tool update <span class=\"token parameter variable\">-g</span> dotnet-serve <span class=\"token parameter variable\">--version</span> <span class=\"token number\">1.10</span>.175\nThe requested version <span class=\"token number\">1.10</span>.175 is lower than existing version <span class=\"token number\">1.10</span>.190.\n</code></pre></div> <p>You get the exact same error message. The key here is that you need to include the <code>--allow-downgrade</code> option when running <code>dotnet tool update</code></p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dotnet tool update <span class=\"token parameter variable\">-g</span> dotnet-serve <span class=\"token parameter variable\">--version</span> <span class=\"token number\">1.10</span>.175 --allow-downgrade\nTool <span class=\"token string\">'dotnet-serve'</span> was successfully updated from version <span class=\"token string\">'1.10.190'</span> to version <span class=\"token string\">'1.10.175'</span><span class=\"token builtin class-name\">.</span>\n</code></pre></div> <blockquote> <p>Note that <code>dotnet tool install --allow-downgrade</code> <em>also</em> works. It seems like the two commands do exactly the same thing these days, so I don't know why update hasn't been deprecated to be honest 😅</p> </blockquote> <p>That's the last of my tips for now. In the next post we'll look at some new features coming to .NET tool packages in .NET 10!</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-and-authoring-dotnet-tools/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I discussed how to work .NET tools. I described how to install local tools using a tools manifest, and some of the considerations when you're authoring tools. In particular, I discussed the considerations about multi-targeting to ensure maximum compatibility with customer environments and using <code>RollForward=Major</code> to ensure <em>future</em> compatibility. Finally I provided some general tips about using .NET tools, particularly for when you're building and testing .NET tools in CI. In the next post we'll look at some of the new features coming to .NET tools in .NET 10!</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/using-and-authoring-dotnet-tools/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/fixing-an-old-dotnet-core-native-library-loading-issue-on-alpine/",
      "Title": "Fixing an old .NET Core native library loading issue on Alpine",
      "PublishDate": "2025-08-26T10:00:00+00:00",
      "Summary": "In this post I walk through the process of solving a native library loading issue on alpine with an old .NET runtime, showing the steps we took and the solution",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/sqlite_banner.png\" /><p>In this post I describe an issue I ran into at work when we were trying to test an app using <em>Microsoft.Data.SQLite</em> on <a href=\"https://www.alpinelinux.org/\">Alpine Linux</a>, and were running into this error: <code>Unhandled exception. System.DllNotFoundException: Unable to load shared library 'e_sqlite3' or one of its dependencies</code>.</p> <p>This post is primarily a walkthrough of the steps I took to solve the issue. I describe the problem itself, the environment in which it happened, the things we tried to isolate the issue, the eventual root cause, and how we resolved it.</p> <h2 id=\"the-background-net-10-requires-alpine-3-17\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/fixing-an-old-dotnet-core-native-library-loading-issue-on-alpine/#the-background-net-10-requires-alpine-3-17\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The background: .NET 10 requires alpine 3.17+</a></h2> <p>We ran into the issue while working on <a href=\"http://github.com/DataDog/dd-trace-dotnet\">the Datadog .NET tracer</a> in a branch where we were adding <a href=\"https://github.com/DataDog/dd-trace-dotnet/pull/7170\">provisional support for .NET 10</a>. One of the issues we ran into in this branch was that .NET 10 no longer runs on the version of alpine we were previously using, <code>alpine:3.14</code>.</p> <blockquote> <p>One of the issues we have to deal with in general is that we support a <em>wide</em> range of target frameworks and deployment platforms, which generally means we need to use and test on \"old\" versions of both distros and target frameworks.</p> </blockquote> <p>Initial attempts to run .NET 10 on <code>alpine:3.14</code> fails at runtime with the following error:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">Failed to load /usr/share/dotnet/host/fxr/10.0.0-preview.5.25277.114/libhostfxr.so, error:\nError relocating /usr/share/dotnet/host/fxr/10.0.0-preview.5.25277.114/libhostfxr.so: \n_ZSt28__throw_bad_array_new_lengthv: symbol not found\n\nThe library libhostfxr.so was found, but loading it from /usr/share/dotnet/host/fxr/10.0.0-preview.5.25277.114/libhostfxr.so failed\n</code></pre></div> <p><a href=\"https://github.com/dotnet/runtime/issues/117608\">We subsequently confirmed</a> that this is expected: <a href=\"https://github.com/dotnet/runtime/issues/117608\">.NET 10 has updated its support matrix</a>, and now requires Alpine 3.17 or higher.</p> <p>After jumping through the various hoops to confirm that we <em>could</em> update the base image of alpine without breaking anything, we updated our build and test images to use <code>alpine:3.17</code>. And that's when we started hitting the issue that is the focus of this post.</p> <h2 id=\"the-problem-unable-to-load-shared-library-e_sqlite3-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/fixing-an-old-dotnet-core-native-library-loading-issue-on-alpine/#the-problem-unable-to-load-shared-library-e_sqlite3-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The problem: <code>Unable to load shared library 'e_sqlite3'</code></a></h2> <p>As part of CI tests, we run over a hundred different sample applications, across a variety of different package version combinations and target frameworks. After updating to the new version of alpine, we started seeing issues in one application in particular, <a href=\"https://github.com/DataDog/dd-trace-dotnet/tree/835d79f94261ca1cbf5177c50ebc442329bbb057/tracer/test/test-applications/integrations/Samples.Microsoft.Data.Sqlite\"><em>Samples.Microsoft.Data.Sqlite</em></a>. This was failing in two specific target frameworks, <code>netcoreapp3.1</code> and <code>net5.0</code>, and was failing with the following error:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">Unhandled exception. System.DllNotFoundException: Unable to load shared library <span class=\"token string\">'e_sqlite3'</span> or one of its dependencies. In order to <span class=\"token builtin class-name\">help</span> diagnose loading problems, consider setting the LD_DEBUG environment variable: Error loading shared library libe_sqlite3: No such <span class=\"token function\">file</span> or directory\n    at SQLitePCL.SQLite3Provider_e_sqlite3.NativeMethods.sqlite3_libversion_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    at SQLitePCL.SQLite3Provider_e_sqlite3.SQLitePCL.ISQLite3Provider.sqlite3_libversion_number<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    at SQLitePCL.raw.SetProvider<span class=\"token punctuation\">(</span>ISQLite3Provider imp<span class=\"token punctuation\">)</span>\n    at SQLitePCL.Batteries_V2.Init<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    at SQLitePCL.Batteries.Init<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    at Samples.Microsoft.Data.Sqlite.Program.OpenConnection<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> D:<span class=\"token punctuation\">\\</span>a<span class=\"token punctuation\">\\</span>_work<span class=\"token punctuation\">\\</span><span class=\"token number\">1</span><span class=\"token punctuation\">\\</span>s<span class=\"token punctuation\">\\</span>tracer<span class=\"token punctuation\">\\</span>test<span class=\"token punctuation\">\\</span>test-applications<span class=\"token punctuation\">\\</span>integrations<span class=\"token punctuation\">\\</span>Samples.Microsoft.Data.Sqlite<span class=\"token punctuation\">\\</span>Program.cs:line <span class=\"token number\">29</span>\n    at Samples.Microsoft.Data.Sqlite.Program.Main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> D:<span class=\"token punctuation\">\\</span>a<span class=\"token punctuation\">\\</span>_work<span class=\"token punctuation\">\\</span><span class=\"token number\">1</span><span class=\"token punctuation\">\\</span>s<span class=\"token punctuation\">\\</span>tracer<span class=\"token punctuation\">\\</span>test<span class=\"token punctuation\">\\</span>test-applications<span class=\"token punctuation\">\\</span>integrations<span class=\"token punctuation\">\\</span>Samples.Microsoft.Data.Sqlite<span class=\"token punctuation\">\\</span>Program.cs:line <span class=\"token number\">17</span>\n    at Samples.Microsoft.Data.Sqlite.Program.<span class=\"token operator\">&lt;</span>Main<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n</code></pre></div> <p>As you might expect, this app uses <a href=\"https://www.nuget.org/packages/Microsoft.Data.Sqlite\">the <em>Microsoft.Data.Sqlite</em> package</a> package, which transitively references various SQLite packages. The question was:</p> <ul><li>Why is the library unable to load the <code>libe_sqlite3</code>?</li> <li>Why does it only affect .NET Core 3.1 and .NET 5?</li></ul> <h2 id=\"narrowing-down-the-issue\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/fixing-an-old-dotnet-core-native-library-loading-issue-on-alpine/#narrowing-down-the-issue\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Narrowing down the issue</a></h2> <p>One of the difficulties with solving the problem was that we were changing multiple variables at once: we updated the base image to <code>alpine:3.17</code> <em>and</em> we were building with the .NET 10 preview SDK too. Unfortunately, for technical reasons, it wasn't easy for us to separate these two steps entirely, so we took a slightly different approach.</p> <p>Our base suspicion was that the updated alpine base image was the problem. There were lots of possible reasons this <em>could</em> be the case, such as missing native dependencies, but before we narrowed our focus, we wanted to isolate the issue to alpine.</p> <p>To confirm our suspicions, we used a build of the sample taken from the <code>master</code> branch's CI, and ran it on both <code>alpine:3.14</code> and <code>alpine:3.17</code>, <em>without</em> the .NET tracer attached, running against .NET Core 3.1. The results were:</p> <ul><li>On <code>alpine:3.14</code>, the app ran without issue.</li> <li>On <code>alpine:3.17</code>, the app crashed with <code>Unable to load shared library 'e_sqlite3' or one of its dependencies</code>.</li></ul> <p>OK, so the problem was <em>definitely</em> the new <code>alpine:3.17</code> image. Now to try to understand <em>why</em> it was a problem.</p> <h2 id=\"checking-for-missing-dependencies-with-ldd\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/fixing-an-old-dotnet-core-native-library-loading-issue-on-alpine/#checking-for-missing-dependencies-with-ldd\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Checking for missing dependencies with <code>ldd</code></a></h2> <p>So at this point, we know the app itself is correct, and that the <code>libe_sqlite3</code> exists and is in the right location, because it works with <code>alpine:3.14</code>. So then why can't the library be loaded?</p> <p>I started by running the <a href=\"http://linux.die.net/man/1/ldd\"><code>ldd</code> (List Dynamic Dependencies) command</a> inside the <code>alpine:3.17</code> project, passing in the path to the SQLite library. This then lists the dynamic dependencies of the library:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ ldd ./runtimes/linux-musl-x64/native/libe_sqlite3.so\n  /lib/ld-musl-x86_64.so.1 <span class=\"token punctuation\">(</span>0x741dab2ae000<span class=\"token punctuation\">)</span>\n  libc.so <span class=\"token operator\">=</span><span class=\"token operator\">&gt;</span> /lib/ld-musl-x86_64.so.1 <span class=\"token punctuation\">(</span>0x741dab2ae000<span class=\"token punctuation\">)</span>\n</code></pre></div> <p>This shows that the SQLite library is linked only against <a href=\"https://en.wikipedia.org/wiki/Musl\">musl</a>'s <code>libc</code>, and that the library is present. So that means the issue is likely <em>not</em> due to a missing dependency.</p> <h2 id=\"debugging-native-library-loading-issues-with-ld_debug-and-ld_library_path\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/fixing-an-old-dotnet-core-native-library-loading-issue-on-alpine/#debugging-native-library-loading-issues-with-ld_debug-and-ld_library_path\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Debugging native library loading issues with <code>LD_DEBUG</code> and <code>LD_LIBRARY_PATH</code></a></h2> <p>The next thing I tried was doing what the error message said:</p> <div class=\"pre-code-wrapper\"><pre><code>In order to help diagnose loading problems, consider setting the LD_DEBUG environment variable\n</code></pre></div> <p>The <code>LD_DEBUG</code> variable is a feature of the Linux dynamic linker that <a href=\"https://bnikolic.co.uk/blog/linux-ld-debug.html\">allows dumping information</a> about how it's functioning. This is great for debugging, and there's lots of options you can pass to it. For the example below, I used the <code>libs</code> option which displays native library search paths:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token assign-left variable\">LD_DEBUG</span><span class=\"token operator\">=</span>libs <span class=\"token function\">ls</span>\n<span class=\"token number\">295</span>:\t<span class=\"token function\">find</span> <span class=\"token assign-left variable\">library</span><span class=\"token operator\">=</span>libselinux.so.1 <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> searching\n<span class=\"token number\">295</span>:\t search <span class=\"token assign-left variable\">cache</span><span class=\"token operator\">=</span>/etc/ld.so.cache\n<span class=\"token number\">295</span>:\t  trying <span class=\"token assign-left variable\">file</span><span class=\"token operator\">=</span>/lib/x86_64-linux-gnu/libselinux.so.1\n<span class=\"token number\">295</span>:\t\n<span class=\"token number\">295</span>:\t<span class=\"token function\">find</span> <span class=\"token assign-left variable\">library</span><span class=\"token operator\">=</span>libc.so.6 <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> searching\n<span class=\"token number\">295</span>:\t search <span class=\"token assign-left variable\">cache</span><span class=\"token operator\">=</span>/etc/ld.so.cache\n<span class=\"token number\">295</span>:\t  trying <span class=\"token assign-left variable\">file</span><span class=\"token operator\">=</span>/lib/x86_64-linux-gnu/libc.so.6\n<span class=\"token number\">295</span>:\t\n<span class=\"token number\">295</span>:\t<span class=\"token function\">find</span> <span class=\"token assign-left variable\">library</span><span class=\"token operator\">=</span>libpcre2-8.so.0 <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> searching\n<span class=\"token number\">295</span>:\t search <span class=\"token assign-left variable\">cache</span><span class=\"token operator\">=</span>/etc/ld.so.cache\n<span class=\"token number\">295</span>:\t  trying <span class=\"token assign-left variable\">file</span><span class=\"token operator\">=</span>/lib/x86_64-linux-gnu/libpcre2-8.so.0\n<span class=\"token number\">295</span>:\t\n<span class=\"token number\">295</span>:\tcalling init: /lib64/ld-linux-x86-64.so.2\n<span class=\"token number\">295</span>:\tcalling init: /lib/x86_64-linux-gnu/libc.so.6\n<span class=\"token number\">295</span>:\tcalling init: /lib/x86_64-linux-gnu/libpcre2-8.so.0\n<span class=\"token number\">295</span>:\tcalling init: /lib/x86_64-linux-gnu/libselinux.so.1\n<span class=\"token number\">295</span>:\tinitialize program: <span class=\"token function\">ls</span>\n<span class=\"token number\">295</span>:\ttransferring control: <span class=\"token function\">ls</span>\n<span class=\"token number\">295</span>:\t\n</code></pre></div> <p>Unfortunately, running our app with <code>LD_DEBUG=libs dotnet Samples.Microsoft.Data.Sqlite.dll</code> doesn't reveal anything interesting. That's because the <code>libe_sqlite.so</code> native library <em>isn't</em> loaded as a dynamic dependency, so <code>LD_DEBUG</code> doesn't give us any information. Rather, the SQLite library is explicitly loaded by the .NET runtime, so it's the <em>runtime</em> that's unable to load the library.</p> <blockquote> <p>Another useful tool for debugging linking issues is <a href=\"https://linux.die.net/man/1/strace\"><code>strace</code></a> which provides insights into all system calls.</p> </blockquote> <p>The next thing I tried was explicitly setting <code>LD_LIBRARY_PATH</code> to include the path to <code>libe_sqlite.so</code>. <code>LD_LIBRARY_PATH </code> is a set of additional paths to search for dynamically linked libraries, in addition to the standard locations. As a hack, I tried setting the variable to include the directory containing the SQLite library:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token assign-left variable\">LD_LIBRARY_PATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$LD_LIBRARY_PATH</span>:/project/runtimes/linux-musl-x64/native/ <span class=\"token punctuation\">\\</span>\n  dotnet Samples.Microsoft.Data.Sqlite.dll\n</code></pre></div> <p>And sure enough, it worked! The sample successfully found the <code>libe_sqlite.so</code> library, and ran correctly!</p> <p>So at this point, we're pretty certain that it's purely a problem with .NET <em>finding</em> the native library when we're running on <code>alpine:3.17</code>, not an issue with loading the library itself.</p> <h2 id=\"the-root-cause-net-runtime-id-resolution\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/fixing-an-old-dotnet-core-native-library-loading-issue-on-alpine/#the-root-cause-net-runtime-id-resolution\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The root cause: .NET runtime ID resolution</a></h2> <p>So what's going on here?</p> <p>At this point, my best guess was essentially that .NET Core 3.1 and .NET 5 simply didn't support <code>alpine:3.17</code> based on the fact:</p> <ul><li>Alpine 3.17 wasn't released until 2022</li> <li>.NET Core 3.1 was release in 2019 and .NET 5 in 2020</li></ul> <p>What's more, Microsoft <a href=\"https://github.com/dotnet/dotnet-docker/pull/4221\">added dockerfiles for <code>alpine:3.17</code></a> but they <em>only</em> added them for .NET 6+. Microsoft never updated .NET Core 3.1 images to use <code>alpine:3.17</code>, <a href=\"https://github.com/dotnet/dotnet-docker/commit/5408c0cc39a3ed8d2847fec075223eedee9bd4eb\">even though they were still updating 3.1 at this time</a>. So even though .NET Core 3.1 and .NET 5 <a href=\"https://github.com/dotnet/core/blob/main/release-notes/3.1/3.1-supported-os.md#linux\">officially support Alpine 3.13+</a>, it seems the native library lookup rules are just broken on Alpine 3.17.</p> <p>And that pretty much sums it up: the native-library lookup rules are broken for Alpine 3.17+ on .NET Core 3.1 and .NET 5.</p> <p>I had actually forgotten that in earlier versions of .NET Core, there were <a href=\"https://github.com/dotnet/runtime/pull/62938/files\">hardcoded lists</a> mapping from distro names like <code>alpine:3.17</code> to runtime IDs, like <code>linux-musl-x64</code>. If the mapping was missing, then .NET didn't know which runtime ID to use, and instead of choosing the correct <code>linux-musl-x64</code> runtime ID, it would fallback to <code>linux-x64</code>. And choosing the wrong runtime ID is why the app was failing previously.</p> <p>This problem of a missing runtime ID entry causing native failures on alpine was actually <a href=\"https://github.com/dotnet/runtime/issues/65152\">a problem</a> that happened repeatedly:</p> <ul><li><a href=\"https://github.com/dotnet/runtime/pull/62938\">add RID for Alpine 3.15</a></li> <li><a href=\"https://github.com/dotnet/runtime/pull/68505\">add RID for Alpine 3.16</a></li> <li><a href=\"https://github.com/dotnet/runtime/pull/75396\">Add RID for alpine-3.17 + alpine-{armv6,x86,s390x,ppc64le}</a></li> <li><a href=\"https://github.com/dotnet/runtime/pull/86276\">add RID for Alpine 3.18</a></li></ul> <p>Eventually, a new <a href=\"https://github.com/dotnet/runtime/pull/65339\">fallback was added</a> for alpine that explicitly used <code>linux-musl-x64</code> artifacts for unknown alpine versions, so this shouldn't be a problem for .NET 7+.</p> <h2 id=\"the-solution-dotnet_runtime_id\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/fixing-an-old-dotnet-core-native-library-loading-issue-on-alpine/#the-solution-dotnet_runtime_id\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The solution: <code>DOTNET_RUNTIME_ID</code></a></h2> <p>OK, so now we understood <em>why</em> the problem is happening. But how could we fix it?</p> <p>Luckily, the .NET host allows <a href=\"https://github.com/dotnet/runtime/blob/v5.0.0/src/installer/corehost/cli/hostmisc/utils.cpp#L206C25-L206C42\">explicitly setting the runtime ID</a> via an environment variable, <code>DOTNET_RUNTIME_ID</code>. If this variable is set, the runtime uses that in preference to its usual fallbacks, so even these old runtime versions can work on newer versions of alpine.</p> <p>So in this scenario, we can set <code>DOTNET_RUNTIME_ID=linux-musl-x64</code> and the app runs perfectly:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token assign-left variable\">DOTNET_RUNTIME_ID</span><span class=\"token operator\">=</span>linux-musl-x64 dotnet Samples.Microsoft.Data.Sqlite.dll\n</code></pre></div> <p>Problem solved!</p> <p>So the solution was very simple in the end, but I thought it was worth describing the process we went through to narrow it down. And maybe it will help someone who (like me) has forgotten that this was a thing😅</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/fixing-an-old-dotnet-core-native-library-loading-issue-on-alpine/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I walkthrough how we solved an error running .NET Core 3.1 and .NET 5 on Alpine Linux 3.17: <code>Unable to load shared library 'e_sqlite3' or one of its dependencies</code>. I describe the problem itself—the failure to load the SQLite native library—the environment in which it happened, the things we tried to isolate the issue, the eventual root cause, and how we resolved it.</p> <p>In the end, we traced the issue to a fallback path in the .NET runtime, which would result in the runtime using the <code>linux-x64</code> runtime ID instead of the required <code>linux-musl-x64</code> on Alpine for newer versions of Alpine. This fallback path has been fixed in newer versions of .NET, but in older versions you must force the runtime to use the correct runtime ID by setting <code>DOTNET_RUNTIME_ID=linux-musl-x64</code>.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/fixing-an-old-dotnet-core-native-library-loading-issue-on-alpine/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/converting-an-xunit-project-to-tunit/",
      "Title": "Converting an xUnit test project to TUnit",
      "PublishDate": "2025-08-19T10:00:00+00:00",
      "Summary": "In this post I discuss the new TUnit testing framework, why I ported one of my libraries to use it instead of xUnit and related issues I had to deal with",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/tunit_banner.jpg\" /><p>In this post I discuss the new <a href=\"https://github.com/thomhurst/TUnit\">TUnit testing framework</a>, why I ported one of my libraries to use it instead of xUnit, how I did that, and related issues I had to deal with.</p> <h2 id=\"what-is-tunit\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xunit-project-to-tunit/#what-is-tunit\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What is TUnit</a></h2> <p><a href=\"https://github.com/thomhurst/TUnit\">TUnit</a> is a new testing library, similar to <a href=\"https://xunit.net/\">xUnit</a>, <a href=\"https://nunit.org/\">NUnit</a>, or <a href=\"https://learn.microsoft.com/en-us/dotnet/core/testing/unit-testing-mstest-intro\">MSTest</a>, that you can use to write test suites for your .NET applications. As per <a href=\"https://github.com/thomhurst/TUnit?tab=readme-ov-file\">the TUnit project's README</a>:</p> <blockquote> <p><strong>TUnit</strong> is a next-generation testing framework for C# that outpaces traditional frameworks with <strong>source-generated tests</strong>, <strong>parallel execution by default</strong>, and <strong>Native AOT support</strong>. Built on the modern Microsoft.Testing.Platform, TUnit delivers faster test runs, better developer experience, and unmatched flexibility.</p> </blockquote> <p>The project is still pretty new, with the very first alpha releases first appearing in 2024, and without a v1.0.0 release yet. That said, <a href=\"https://github.com/thomhurst/TUnit?tab=readme-ov-file#-current-status\">according to the current status</a>, \"The API is mostly stable\", and it certainly seems well developed both from a feature point of view, but also in terms of documentation and guides. More on that later!</p> <p>Another important aspect is that it uses the newer <a href=\"https://learn.microsoft.com/en-us/dotnet/core/testing/microsoft-testing-platform-intro?tabs=dotnetcli\"><em>Microsoft.Testing.Platform</em></a> experience (instead of the old <a href=\"https://learn.microsoft.com/en-us/dotnet/core/testing/microsoft-testing-platform-vs-vstest\">VSTest</a> runner), so it requires using a recent version of the .NET SDK. Even though it's new, Visual Studio, VS Code, and Rider all support the newer lightweight platform, and <a href=\"https://github.com/thomhurst/TUnit?tab=readme-ov-file#%EF%B8%8F-ide-support\">hence support TUnit</a> (though you may need to enabled the option in your IDE). Consequently, you'll see your TUnit tests show up in your IDE's test explorer, just as you are used to with other frameworks.</p> <p>One of the selling points of TUnit is that many of the decisions made in the design mean that it can be <em>fast</em>. That includes source-generation based test discovery and even NativeAOT support. The <a href=\"https://github.com/thomhurst/TUnit?tab=readme-ov-file#scenario-a-test-that-takes-50ms-to-execute-repeated-100-times-including-spawning-a-new-process-and-initialising-the-test-framework\">benchmarks on the TUnit</a> README describe various scenarios, but the one that really stands out is:</p> <blockquote> <p>A test that takes 50ms to execute, repeated 100 times (including spawning a new process and initialising the test framework)</p> </blockquote> <p>The first set of benchmarks for this scenario run on an Apple M1 mac, and show a very impressive speed up versus other frameworks (which I think is ultimately due to the increased parallelization used by TUnit):</p> <table><thead><tr><th>Method</th><th style=\"text-align:right\">Mean</th><th style=\"text-align:right\">Error</th><th style=\"text-align:right\">StdDev</th></tr></thead><tbody><tr><td>TUnit AOT</td><td style=\"text-align:right\">235.8 ms</td><td style=\"text-align:right\">12.94 ms</td><td style=\"text-align:right\">38.15 ms</td></tr><tr><td>TUnit</td><td style=\"text-align:right\">643.5 ms</td><td style=\"text-align:right\">21.41 ms</td><td style=\"text-align:right\">63.13 ms</td></tr><tr><td>NUnit</td><td style=\"text-align:right\">13,517.6 ms</td><td style=\"text-align:right\">269.19 ms</td><td style=\"text-align:right\">644.96 ms</td></tr><tr><td>xUnit</td><td style=\"text-align:right\">13,932.4 ms</td><td style=\"text-align:right\">276.32 ms</td><td style=\"text-align:right\">505.26 ms</td></tr><tr><td>MSTest</td><td style=\"text-align:right\">13,704.8 ms</td><td style=\"text-align:right\">269.71 ms</td><td style=\"text-align:right\">614.28 ms</td></tr></tbody></table> <p>For me the speed up is a nice benefit, but ultimately it's not the main reason I looked at TUnit or wondered if it was worth converting my existing xUnit-based project to use TUnit…</p> <h2 id=\"why-change-test-frameworks-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xunit-project-to-tunit/#why-change-test-frameworks-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Why change test frameworks?</a></h2> <p>In general, I wouldn't recommend changing your test framework. Yes, there are differences between the different frameworks, but many of those differences are cosmetic; it is <em>really</em> worth the hassle for minor changes? How much are you going to gain?</p> <p>And yet, I considered it 😅 This was actually first driven by an issue I found at work, working on <a href=\"http://github.com/DataDog/dd-trace-dotnet\">the DataDog .NET Tracer</a>, when we tried to update to using the .NET 10 preview 5 SDK and our xUnit test libraries were failing to discover any tests. Not <em>failing</em>, just failing to run any tests 😬. That issue was ultimately an unrelated distraction, but it made us wonder; what is the chance that we will hit an issue with xUnit at some point and be completely stuck?</p> <p>That might seem a bit irrational, if it wasn't for the \"xUnit v3\" issue…</p> <p>xUnit v2 uses <a href=\"https://www.nuget.org/packages/xunit/\">the \"xUnit\" NuGet package</a>, and is the framework that most people think about when they are talking about xUnit (at least, historically). xUnit v2 supports basically all target frameworks; it supports .NET standard 1.1+ (so all .NET Core) and .NET Framework 4.5.2+.</p> <p>xUnit.v3 is in some ways an evolution, and in others is a rebuilding of xUnit. It uses <a href=\"https://www.nuget.org/packages/xunit.v3\">a different NuGet package</a>, and only supports .NET Framework 4.7.2 and .NET 8+ target frameworks.</p> <p>It's obviously entirely up to the maintainers to decide what to support, and they've settled on supporting only the frameworks that Microsoft supports, which is totally reasonable on the face of it. But it gives us a tricky question at work, given that we need to test on a wide variety of older frameworks which are used by customers. Even in my OSS projects I normally favour supporting a larger number of target frameworks for ease of use by consumers, and that range is always going to be larger than xUnit.v3's matrix</p> <p>All that means that it's unlikely I'll <em>ever</em> adopt xUnit.v3, either at work, <em>or</em> in my personal projects. Which means I'm essentially stuck on xUnit v2 <em>forever</em>. And that makes me nervous, given that xUnit v2 isn't receiving updates any more…</p> <blockquote> <p>I have some other minor gripes with xUnit which also contribute to the uneasiness, not least is the fact that xUnit.v3 has had 3 major versions in the space of 6 months. That level of churn is something I personally don't want to have to deal with in a test framework.</p> </blockquote> <p>All of which made me wonder if TUnit could be a potential alternative, so I decided to try it out on one of my OSS projects.</p> <h2 id=\"how-is-tunit-different-to-xunit-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xunit-project-to-tunit/#how-is-tunit-different-to-xunit-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">How is TUnit different to xUnit?</a></h2> <p>One of the nice things about <a href=\"https://tunit.dev/docs\">the TUnit docs</a> is that they explicitly try to address the differences between TUnit and other test frameworks. For xUnit, <a href=\"https://tunit.dev/docs/comparison/framework-differences#xunit\">the TUnit docs highlight 5 main points of difficulty</a>:</p> <ul><li><strong>Async tests parallel limit</strong>. xUnit allows limiting the <em>thread</em> count, but not the number of concurrent tests, because with <code>async</code> tests, those two things are not the same. With TUnit, you can explicitly choose the number of tests to run in parallel.</li> <li><strong>Set up and tear downs</strong>. xUnit mostly relies on constructors and <code>IDisposable</code> to handle test setup and shutdown. If you want <em>async</em> setup and teardown, you have to implement <code>IAsyncLifetime</code>, and there are some complexities around inheritance. With TUnit you can use all these approaches if you want, but you have an additional option, <code>[BeforeTest]</code> and <code>[AfterTest]</code> attributes.</li> <li><strong>Assembly level hooks</strong>. xUnit doesn't have an easy way to run something before executing the tests for an assembly, TUnit has <code>[BeforeAssembly]</code> and <code>[AfterAssembly]</code>.</li> <li><strong>TestContext</strong>. xUnit doesn't track the state of the \"current\" test in things like tear down methods. With TUnit you can inject a context object into tear down methods or use the static <code>TestContext.Current</code>.</li> <li><strong>Assertions</strong>. xUnit assertions use a somewhat \"legacy\" <code>Assert.Equal(x, y)</code> format, which makes it hard to know if the <code>x</code> or <code>y</code> is the actual or expected value. TUnit assertions use a fluent style like FluentAssertions or Shouldly.</li></ul> <p>Now, to be fair to xUnit, many of these complaints are directed towards the <em>v2</em> version of xUnit. For example, xUnit v3 <a href=\"https://xunit.net/docs/getting-started/v3/whats-new#test-context\">has a <code>TestContext</code> type</a> similar to TUnit's, <a href=\"https://xunit.net/docs/getting-started/v3/whats-new#miscellaneous-changes\">and an <code>[AssemblyFixture]</code> attribute</a> for providing assembly-level hooks.</p> <p>That said, TUnit brings a bunch of extra features to the table too:</p> <ul><li><strong>Source generation</strong>. Instead of discovering tests at runtime, TUnit <a href=\"https://tunit.dev/docs/comparison/framework-differences/#source-generated--native-aot-support--single-file-support\">relies on source generators to drive test discovery</a>, which makes things much faster at runtime.</li> <li><strong>Native AOT support</strong>. One benefit to using Native AOT is that you can actually use Native AOT to publish your <em>test</em> projects. For most projects that's likely overkill, but if you're testing an app you're going to deploy with NativeAOT, that could be handy.</li> <li><strong>Test ordering</strong>. TUnit provides <a href=\"https://tunit.dev/docs/comparison/framework-differences/#test-dependencies\">a <code>[DependsOn]</code> attribute</a> that allows providing an implicit ordering to tests, without having to disable parallelization in general or set ordinal <code>Order</code> values.</li> <li><strong>Console capture</strong>. With xUnit v2, nothing you write to <code>Console</code> is captured in the test output, but <a href=\"https://tunit.dev/docs/customization-extensibility/logging/\">TUnit automatically intercepts these logs</a> and correlates them with the current test. For the record, xUnit v3 has an option for this too.</li></ul> <p>Of course, the <em>really</em> important difference from my point of view is the supported frameworks. As I mentioned before, xUnit v3 only supports .NET Framework 4.7.2 and .NET 8+. TUnit, on the other hand, supports .NET 8+ but <em>also</em> .NET Standard 2.0, which means .NET Framework 4.7.2, but more importantly <em>also</em> .NET Core 2.0+ which is the really killer feature from my point of view.</p> <p>So with that in mind, I set about seeing what it would be like to convert one of my OSS projects to use TUnit instead of xUnit.</p> <h2 id=\"converting-an-xunit-project-to-tunit\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xunit-project-to-tunit/#converting-an-xunit-project-to-tunit\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Converting an XUnit project to TUnit</a></h2> <p>Further kudos is due to the TUnit project: they have <a href=\"https://tunit.dev/docs/migration/xunit\">a step-by-step guide</a> describing migrating from xUnit to TUnit. And it worked amazingly well! So this section is mostly a rehash of those steps, with examples applied to my repo, and some caveats.</p> <h3 id=\"1-add-the-tunit-packages\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xunit-project-to-tunit/#1-add-the-tunit-packages\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">1. Add the TUnit packages</a></h3> <p>First of all, add the TUnit package to your test projects, for example:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet <span class=\"token function\">add</span> package TUnit\n</code></pre></div> <p>At this point you'll have both xUnit and TUnit references in your project.</p> <h3 id=\"2-remove-the-automatically-added-global-usings\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xunit-project-to-tunit/#2-remove-the-automatically-added-global-usings\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">2. Remove the automatically added global usings</a></h3> <p>TUnit adds implicit global <code>using</code> statements to your project, however having these as well as xUnit <code>using</code> statements may cause some namespaces clashes. It's important that the projects are building successfully for the next step, so disable the using statements in the test projects:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TUnitImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TUnitImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TUnitAssertionsImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TUnitAssertionsImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>You should now be able to build the project, which will also make sure all the TUnit analyzers are running and available.</p> <h3 id=\"3-convert-the-xunit-usages-to-tunit\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xunit-project-to-tunit/#3-convert-the-xunit-usages-to-tunit\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">3. Convert the xUnit usages to TUnit</a></h3> <p>The next step is the really neat part. TUnit includes <a href=\"https://github.com/thomhurst/TUnit/blob/main/TUnit.Analyzers/Migrators/XUnitMigrationAnalyzer.cs#L114\">an analyzer</a> that helps convert from xUnit to TUnit. And the best bit is that you can run the analyzer and associated code fixer from the command line, and it will convert the project to TUnit for you:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet <span class=\"token function\">format</span> analyzers <span class=\"token parameter variable\">--severity</span> info <span class=\"token parameter variable\">--diagnostics</span> TUXU0001\n</code></pre></div> <p><a href=\"https://github.com/andrewlock/NetEscapades.AspNetCore.SecurityHeaders/pull/255/commits/0e49268406f485bcab6585974e9ba0da69aa9e3a\">I ran this</a> on the two test projects in my library and it did all the grunt work of conversion. It removed the <code>using xunit</code>, changed <code>[Fact]</code> to <code>[Test]</code>, and <code>[InlineData]</code> to <code>[Arguments]</code>, among various other things:</p> <p><img src=\"https://andrewlock.net/content/images/2025/tunit.png\" alt=\"A diff of some of the changes\"></p> <p>This wasn't completely successful, in that it left a few xUnit asserts untouched, but as I was generally converting to FluentAssertions anyway, I just went ahead and <a href=\"https://github.com/andrewlock/NetEscapades.AspNetCore.SecurityHeaders/pull/252\">completed that conversion first</a>.</p> <p>Another thing to note is that the analyzer performed some general reformatting of some lines (you can see removed blank lines in the screenshot above, for example). This wasn't a big deal for me, but it's something worth bearing in mind.</p> <h3 id=\"4-reinstate-the-global-usings\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xunit-project-to-tunit/#4-reinstate-the-global-usings\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">4. Reinstate the global usings</a></h3> <p>Now that all the usages are converted, you need to re-enable the TUnit namespaces, so the easiest thing to do is to revert the <code>TUnitImplicitUsings</code> and <code>TUnitAssertionsImplicitUsings</code> properties.</p> <h3 id=\"5-remove-unneeded-packages\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xunit-project-to-tunit/#5-remove-unneeded-packages\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">5. Remove unneeded packages</a></h3> <p>We're almost done. Finally, you can remove all the xUnit packages, including the runner packages, and importantly <em>also</em> the <em>Microsoft.NET.Test.Sdk</em> package. TUnit uses the newer, lightweight <em>Microsoft.Testing.Platform</em> package instead, and references the package transitively, so the only package you need is TUnit.</p> <p>At this point, you should be able to build and test your project, and if all has gone well, you can test your project with <code>dotnet test</code>, or however you prefer!</p> <h2 id=\"related-issues\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xunit-project-to-tunit/#related-issues\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Related issues</a></h2> <p>There were a few minor issues I ran into.</p> <p>The first one I've already mentioned, in that I had to fix some <code>Assert</code> calls that weren't converted correctly, primarily <code>Assert.Throws&lt;&gt;</code> calls. As described previously, I resolved the issue by converting to FluentAssertions instead, before converting to TUnit.</p> <p>Another issue I had was with TRX report generation. TUnit and <em>Microsoft.Testing.Platform</em> support TRX report generation by way of <a href=\"https://tunit.dev/docs/extensions/#trx-test-reports\">an extension package</a>, <em>Microsoft.Testing.Extensions.TrxReport</em>. <a href=\"https://learn.microsoft.com/en-us/dotnet/core/testing/microsoft-testing-platform-extensions-test-reports#visual-studio-test-reports\">Theoretically</a> you just need to remove the <code>--logger trx</code> call used with <em>Microsoft.NET.Test.Sdk</em>, and add the <code>--report-trx</code> version required by <em>Microsoft.Testing.Platform</em>.</p> <p>However, I found that I needed to add <code>--report-trx</code> (and the <code>--results-directory</code> argument) <em>after</em> a <code>--</code> argument. And related to this, I had to work around the fact that <a href=\"https://nuke.build/\">Nuke</a>, my preferred build system, doesn't have first-class support for the <em>Microsoft.Testing.Platform</em> library. All in all I had to make the following changes to the <code>Test</code> stage in my Nuke script:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-diff\"><code class=\"language-diff\">DotNetTest(s =&gt; s\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span><span class=\"token line\">   .SetProjectFile(Solution)\n</span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">   .SetConfiguration(Configuration)\n</span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">   .SetProperty(\"Version\", Version)\n</span><span class=\"token prefix unchanged\"> </span><span class=\"token line\">   .When(IsServerBuild, x =&gt; x\n</span></span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\">       .SetLoggers(\"trx\")\n</span><span class=\"token prefix deleted\">-</span><span class=\"token line\">       .SetResultsDirectory(TestResultsDirectory))\n</span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\">       .SetProcessArgumentConfigurator(x=&gt;x\n</span><span class=\"token prefix inserted\">+</span><span class=\"token line\">           .Add(\"--\")\n</span><span class=\"token prefix inserted\">+</span><span class=\"token line\">           .Add(\"--report-trx\")\n</span><span class=\"token prefix inserted\">+</span><span class=\"token line\">           .Add(\"--results-directory\")\n</span><span class=\"token prefix inserted\">+</span><span class=\"token line\">           .Add(TestResultsDirectory)));\n</span></span></code></pre></div> <p>The final issue I had was with my use of <a href=\"https://github.com/VerifyTests/Verify\">Verify</a> for snapshot testing. Verify has plugins for multiple test frameworks, including TUnit. However, unfortunately for me, even the <em>earliest</em> version of <a href=\"https://www.nuget.org/packages/Verify.TUnit/26.5.0#dependencies-body-tab\">Verify.TUnit</a> only supports .NET 8+, not earlier versions of .NET Core, which makes it a deal breaker for me.</p> <blockquote> <p>Verify is another library where I'm indefinitely stuck on old versions (both in OSS and at work) due to the dropping of older frameworks. That, plus a somewhat aggressive approach to breaking changes, means I'm about 12-16 major versions behind the latest, and unable to upgrade 😅</p> </blockquote> <p>So this left me a little stuck. I considered just removing Verify entirely, seeing as I was only using it in a single test. However I <em>also</em> wanted to consider moving to TUnit for other projects, and converting <em>those</em> projects could end up tricky due to the Verify dependency…</p> <p>So I did something moderately drastic. I forked Verify at the highest version that I could add a .NET Core 2.1 target to (<code>21.3.0</code>) and uploaded <a href=\"https://www.nuget.org/packages/NetEscapades.Verify\">my own version</a>. I don't envisage this going any further or necessarily being a long-term solution, but it may make it simpler for me to convert some of my other libraries to TUnit without having to also swap to a different snapshot testing library!</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xunit-project-to-tunit/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I discussed the new <a href=\"https://github.com/thomhurst/TUnit\">TUnit testing framework</a>, looking at some of it's features, and some of its differences from other frameworks. Then I described how the move for xUnit to create xUnit.v3 had prompted me to consider changing the test framework for my open source libraries to TUnit. This isn't something you should take lightly, but the fact that xUnit.v3 on works on .NET 8+ (and .NET Framework) was a blocker for me to use it in my libraries, so I tried a sample conversion for one of my libraries.</p> <p>For the remainder of the post I described the process of converting an xUnit project to TUnit. I found this to be incredibly smooth, thanks to the TUnit project providing a migration tool, by way of Roslyn analyzers. This process worked smoothly overall, with only relatively minor changes required on my side after the conversion. Overall TUnit seems very interesting, and I shall be watching it with interest, and potentially converting more of my projects across!</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/converting-an-xunit-project-to-tunit/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/running-dotnet-in-the-browser-without-blazor/",
      "Title": "Running .NET in the browser without Blazor",
      "PublishDate": "2025-08-12T10:00:00+00:00",
      "Summary": "In this post I show how to run .NET in your browser without using Blazor, and instead rely on lower-level abstractions provided by [JSImport] and [JSExport]",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/wasmbrowser_banner.png\" /><p>In this post I show how you can run .NET in your browser <em>without</em> using Blazor, and instead rely only on the WASM base infrastructure that Blazor builds on top of. I also look at some of the improvements coming to this in .NET 10, primarily around client-side file fingerprinting.</p> <h2 id=\"background-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/running-dotnet-in-the-browser-without-blazor/#background-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Background:</a></h2> <p><a href=\"https://developer.mozilla.org/en-US/docs/WebAssembly\">WebAssembly</a> (WASM) leapt onto the .NET scene back in 2017 when Steve Sanderson showed off <a href=\"https://www.youtube.com/watch?v=MiLAE6HMr10&amp;ab_channel=NDCConferences\">a tech demo</a> of what would ultimately become <a href=\"https://dotnet.microsoft.com/en-us/apps/aspnet/web-apps/blazor\">Blazor</a>. Blazor is a full component-based web-framework for building web applications using HTML and C#. It can run in multiple <a href=\"https://learn.microsoft.com/en-us/aspnet/core/blazor/components/render-modes\">render modes</a>, with the Interactive WebAssembly mode running entirely in the browser using the power of WASM.</p> <p>When you talk bout .NET and WASM, most people will immediately think about Blazor, but there are several other ways to combine .NET with WASM:</p> <ul><li>Run .NET <a href=\"https://learn.microsoft.com/en-us/aspnet/core/client-side/dotnet-interop?view=aspnetcore-9.0#browser-app\">on WASM in the browser</a> <em>without</em> using Blazor.</li> <li>Run .NET <a href=\"https://learn.microsoft.com/en-us/aspnet/core/client-side/dotnet-interop?view=aspnetcore-9.0#nodejs-console-app\">on WASM inside a Node.js process</a> on the server.</li> <li><a href=\"https://devblogs.microsoft.com/dotnet/extending-web-assembly-to-the-cloud/\">Write WebAssembly System Interface (WASI) compatible .NET components</a> (and invoke other WASI components written in other languages).</li></ul> <p>In addition, you can integrate Blazor components into <a href=\"https://learn.microsoft.com/en-us/aspnet/core/blazor/components/js-spa-frameworks?view=aspnetcore-10.0\">other JavaScript frameworks</a> like Vue or React, with improvements to this process coming in .NET 10.</p> <p>In this post, I'm looking at the first approach, running .NET using WASM in the browser, but <em>not</em> using Blazor components.</p> <blockquote> <p>This feature has been available from .NET 7 as best I can tell. In this post I'm using the .NET 10 preview 6 version of the workload and templates, but they haven't changed significantly.</p> </blockquote> <h2 id=\"installing-the-experimental-wasm-templates\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/running-dotnet-in-the-browser-without-blazor/#installing-the-experimental-wasm-templates\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Installing the experimental WASM templates</a></h2> <p>The templates for building a .NET application that can be run from JavaScript don't ship with the default SDK. They're experimental, so you need to explicitly install them. Which NuGet package to install depends on which version of the templates you want:</p> <ul><li>.NET 8: <code>Microsoft.NET.Runtime.WebAssembly.Templates</code></li> <li>.NET 9: <code>Microsoft.NET.Runtime.WebAssembly.Templates.net9</code></li> <li>.NET 10: <code>Microsoft.NET.Runtime.WebAssembly.Templates.net10</code></li></ul> <p>We want the latest templates, so we'll install the .NET 10 templates (preview 6 at the time of writing)</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet new <span class=\"token function\">install</span> Microsoft.NET.Runtime.WebAssembly.Templates.net10\n</code></pre></div> <p>This installs three templates:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">Success: Microsoft.NET.Runtime.WebAssembly.Templates.net10::10.0.0-preview.6.25358.103 installed the following templates:\nTemplate Name            Short Name   Language  Tags\n-----------------------  -----------  --------  -----------------------\nWasi Console App         wasiconsole  <span class=\"token punctuation\">[</span>C<span class=\"token comment\">#]      Wasi/WasiConsole</span>\nWebAssembly Browser App  wasmbrowser  <span class=\"token punctuation\">[</span>C<span class=\"token comment\">#]      Web/WebAssembly/Browser</span>\nWebAssembly Console App  wasmconsole  <span class=\"token punctuation\">[</span>C<span class=\"token comment\">#]      Web/WebAssembly/Console</span>\n</code></pre></div> <p>Alternatively you can install the <code>wasm-experimental</code> workload, which includes the templates and also…a bunch of <em>stuff</em> 😅 I'm not really sure what that extra stuff is actually <em>used</em> for though, because as far as I can tell, none of it is required for this 🤷‍♂️</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet workload <span class=\"token function\">install</span> wasm-experimental\n</code></pre></div> <p>Note that <a href=\"https://github.com/dotnet/runtime/blob/main/src/mono/wasm/features.md#aot\">if you want to AOT compile the resulting application</a> then you will also need to install the <code>wasm-tools</code> workload. This will give better performance, but it will greatly increase file size (and therefore startup time), so you'll need to decide which trade-offs to make there.</p> <h2 id=\"creating-a-net-wasm-application\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/running-dotnet-in-the-browser-without-blazor/#creating-a-net-wasm-application\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Creating a .NET WASM application</a></h2> <p>With the template installed, we can create a new application:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet new wasmbrowser\n</code></pre></div> <p>The template creates the following files:</p> <p><img src=\"https://andrewlock.net/content/images/2025/wasmbrowser_01.png\" alt=\"Screenshot of the files generated by the template\"></p> <p>We'll look at most of these files shortly, but first we'll run the app. You can run it with a simple <code>dotnet run</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">WasmAppHost --use-staticwebassets --runtime-config D:<span class=\"token punctuation\">\\</span>repos<span class=\"token punctuation\">\\</span>temp<span class=\"token punctuation\">\\</span>bin<span class=\"token punctuation\">\\</span>Debug<span class=\"token punctuation\">\\</span>net10.0<span class=\"token punctuation\">\\</span>temp.runtimeconfig.json\n\nApp url: http://localhost:5156/\nApp url: https://localhost:7048/\nDebug at url: http://localhost:5156/_framework/debug\nDebug at url: https://localhost:7048/_framework/debug\n</code></pre></div> <p>If you open the app in the browser, you'll see that the template is a simple stopwatch application. It starts as soon as you open the page, and then you can pause, reset, and start the timer:</p> <p><img src=\"https://andrewlock.net/content/images/2025/wasmbrowser_02.png\" alt=\"Screenshot of the wasmbrowser application\"></p> <p>So how does this work? For the rest of the post we'll look at the template and how it works.</p> <h2 id=\"exploring-the-template\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/running-dotnet-in-the-browser-without-blazor/#exploring-the-template\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Exploring the template</a></h2> <p>We'll start by looking at <code>Program.cs</code>, which is a top-level program that contains a helper type called <code>StopwatchSample</code>. The \"program\" itself is very simple, as shown below. First it writes to the console (which will appear in the browser's console window) and then optionally calls the static method <code>StopwatchSample.Start()</code> if the correct args are passed to the program. It then enters an infinite loop, calling <code>Render()</code> every second.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello, Browser!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">==</span> <span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"start\"</span><span class=\"token punctuation\">)</span>\n    StopwatchSample<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    StopwatchSample<span class=\"token punctuation\">.</span><span class=\"token function\">Render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The bulk of the implementation is defined in the <code>StopwatchSample</code> type, shown below. In general, this type is a simple wrapper around a static <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.stopwatch?view=net-9.0\"><code>System.Diagnostics.Stopwatch</code> instance</a>. The interesting parts are the <code>Render()</code> method that calls <code>SetInnerText</code> (which is decorated with <code>[JSImport]</code> attribute), and the other methods that are decorated with <code>[JSExport]</code> attributes.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StopwatchSample</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Stopwatch</span> stopwatch <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> stopwatch<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token function\">SetInnerText</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#time\"</span><span class=\"token punctuation\">,</span> stopwatch<span class=\"token punctuation\">.</span>Elapsed<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token string\">@\"mm\\:ss\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">JSImport</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"dom.setInnerText\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"main.js\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">internal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">partial</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">SetInnerText</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">JSExport</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">internal</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">Toggle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stopwatch<span class=\"token punctuation\">.</span>IsRunning<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            stopwatch<span class=\"token punctuation\">.</span><span class=\"token function\">Stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span>\n        <span class=\"token punctuation\">{</span>\n            stopwatch<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">JSExport</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">internal</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stopwatch<span class=\"token punctuation\">.</span>IsRunning<span class=\"token punctuation\">)</span>\n            stopwatch<span class=\"token punctuation\">.</span><span class=\"token function\">Restart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">else</span>\n            stopwatch<span class=\"token punctuation\">.</span><span class=\"token function\">Reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">Render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">JSExport</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">internal</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">IsRunning</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> stopwatch<span class=\"token punctuation\">.</span>IsRunning<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>As you might have guessed, <code>[JSImport]</code> and <code>[JSExport]</code> provide the means for interacting with JavaScript in the browser from your .NET Code. These attributes are used to drive two source generators, <code>JSImportGenerator</code> and <code>JSExportGenerator</code> respectively, both in <em>Microsoft.Interop.JavaScript</em>. As such, you can <kbd>F12</kbd> to view the generated source in your IDE and see exactly what it's doing.</p> <p>Ultimately it's somewhat gnarly code to read, so I'm not going to go into more detail here, but it's essentially just marshalling between the .NET (WASM) world and the JavaScript world, binding existing JavaScript functions (in the case of <code>[JSImport]</code>), or describing the shape of methods to expose for JavaScript to call.</p> <p><img src=\"https://andrewlock.net/content/images/2025/wasmbrowser_03.png\" alt=\"A screenshot of the JSImportGenerator generated code showing marshalling code\"></p> <p>To understand what this generated code is interacting <em>with</em> we'll next take a look at the HTML and JavaScript code. The HTML is very bare-bones:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">&gt;</span></span>temp78<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>viewport<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>width=device-width, initial-scale=1.0<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token comment\">&lt;!-- 👇 These are updated during dotnet run and dotnet publish --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>preload<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>webassembly<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>importmap<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>module<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>main#[.{fingerprint}].js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">&gt;</span></span>Stopwatch<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">&gt;</span></span>\n    Time elapsed in .NET is <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>time<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>i</span><span class=\"token punctuation\">&gt;</span></span>loading...<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>i</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>pause<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>Pause<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>reset<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>Reset<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>The HTML here shows the broad outline of the app that we saw earlier. It includes some <code>link</code> and <code>script</code> elements, which are required for hooking up the .NET WASM components, and it includes the basic element structure for the app, including a bunch of elements with explicit <code>id</code>s.</p> <p>Next we look at the main.js file, which is the entrypoint for the application, as it's linked directly in the <em>index.html</em> file above. I've added comments to this one to explain what each step is doing:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Import the .NET runtime support</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> dotnet <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./_framework/dotnet.js'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> setModuleImports<span class=\"token punctuation\">,</span> getAssemblyExports<span class=\"token punctuation\">,</span> getConfig<span class=\"token punctuation\">,</span> runMain <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> dotnet\n    <span class=\"token punctuation\">.</span><span class=\"token function\">withApplicationArguments</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"start\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// these are the args passed to the program</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Set up the .NET WASM runtime </span>\n\n<span class=\"token comment\">// setModuleImports associates a set of imports (dom.setInnerText) with an</span>\n<span class=\"token comment\">// associated module (main.js). This pair must match the values provided in the </span>\n<span class=\"token comment\">// [JSImport] attribute to connect everything up correctly</span>\n<span class=\"token function\">setModuleImports</span><span class=\"token punctuation\">(</span><span class=\"token string\">'main.js'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">dom</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function-variable function\">setInnerText</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">selector<span class=\"token punctuation\">,</span> time</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> time\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Return information about the environment and app. e.g. Environment variables (very few)</span>\n<span class=\"token comment\">// runtimeConfig, assembly name, referenced assemblies etc</span>\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token function\">getConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// get all the functions exposed in the main assembly by [JSExport], so that they</span>\n<span class=\"token comment\">// can be invoked from JavaScript</span>\n<span class=\"token keyword\">const</span> exports <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getAssemblyExports</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>mainAssemblyName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// attach a click handler to the reset button and invoke the exported</span>\n<span class=\"token comment\">// StopwatchSample.Reset() function</span>\ndocument<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'reset'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    exports<span class=\"token punctuation\">.</span>StopwatchSample<span class=\"token punctuation\">.</span><span class=\"token function\">Reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    e<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// attach a click handler to the pause button and invoke the exported</span>\n<span class=\"token comment\">// StopwatchSample.Toggle() function</span>\n<span class=\"token keyword\">const</span> pauseButton <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pause'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\npauseButton<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> isRunning <span class=\"token operator\">=</span> exports<span class=\"token punctuation\">.</span>StopwatchSample<span class=\"token punctuation\">.</span><span class=\"token function\">Toggle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    pauseButton<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> isRunning <span class=\"token operator\">?</span> <span class=\"token string\">'Pause'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'Start'</span><span class=\"token punctuation\">;</span>\n    e<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// run the C# Main() method and keep the runtime process running and executing further API calls</span>\n<span class=\"token keyword\">await</span> <span class=\"token function\">runMain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>That covers pretty much all there is to it. In summary:</p> <ul><li><code>[JSExport]</code> and <code>[JSImport]</code> generate C# code that handles marshalling to and from JavaScript types.</li> <li><em>Index.html</em> references the bundled WASM .NET runtime and your compiled application.</li> <li><em>main.js</em> handles booting up the .NET runtime, providing the required imports for where your app needs to call into JavaScript, and running the .NET application.</li></ul> <p>A nice part of the tooling around these features is that you can just <code>dotnet run</code> or <kbd>F5</kbd> your application and run them in the browser, but ultimately you'll want to publish your project when you run it in production.</p> <h2 id=\"publishing-your-wasm-application\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/running-dotnet-in-the-browser-without-blazor/#publishing-your-wasm-application\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Publishing your WASM application</a></h2> <p>You can publish your application using a simple <code>dotnet publish -c Release</code> and by default, the tooling will compile your application, publish and trim the framework references, and both gzip and brotli compress the output.</p> <p>Another interesting point is <a href=\"https://learn.microsoft.com/en-us/aspnet/core/release-notes/aspnetcore-10.0?view=aspnetcore-10.0#client-side-fingerprinting\">client-side fingerprinting of these assets</a>. .NET 9 introduced <a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/map-static-files\">server-side fingerprint of static assets</a> (with <code>MapStaticAssets()</code>) and in .NET 10 you can opt in to similar fingerprinting of the assets both for Blazor WebAssembly apps and also for Blazor-less WASM applications (as we're discussing).</p> <p>To enable this behaviour you need to do several things:</p> <ul><li>Add <code>&lt;script type=\"importmap\"&gt;&lt;/script&gt;</code> to your <em>index.html</em>.</li> <li>Add <code>#[.{fingerprint}]</code> to your script references in <em>index.html</em>.</li> <li>Set <code>OverrideHtmlAssetPlaceholders=true</code>.</li> <li>Opt-in for your assets using <code>&lt;StaticWebAssetFingerprintPattern&gt;</code>.</li></ul> <blockquote> <p>These are all done by default in the template, however <a href=\"https://github.com/dotnet/aspnetcore/issues/62211#issuecomment-3146544516\">there's a bug</a> with the last point, which should be <a href=\"https://github.com/dotnet/runtime/pull/118572\">fixed in an update</a>. Read on for more details.</p> </blockquote> <p>The first two points are covered by new additions to the templates in .NET 10, which adds the <code>importmap</code> and the fingerprint to <code>main</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>preload<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>webassembly<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>importmap<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>module<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>main#[.{fingerprint}].js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>The template also adds <code>&lt;link rel=\"preload\" id=\"webassembly\" /&gt;</code> which enables preloading of the webassembly files, with the intention of improving cold-start times. When you run your application, these elements are rewritten to look similar to the following, with fingerprinting of all the files:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_framework/dotnet.y5zm2li12l.js<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>preload<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">as</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>script<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">fetchpriority</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>high<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">crossorigin</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>anonymous<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">integrity</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sha256-eo4p7mQEfnCQ6TQ0N72uJX+t0QX8QmikrPGJjyy3QLQ=<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>importmap<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>{\n  \"imports\": {\n    \"./_framework/dotnet.native.js\": \"./_framework/dotnet.native.hwglpvp32y.js\",\n    \"./_framework/dotnet.runtime.js\": \"./_framework/dotnet.runtime.0t78nptbqi.js\",\n    \"./_framework/dotnet.js\": \"./_framework/dotnet.y5zm2li12l.js\",\n    \"./main.js\": \"./main.ofkecrt505.js\"\n  },\n  \"scopes\": {},\n  \"integrity\": {\n    \"./_framework/dotnet.js\": \"sha256-eo4p7mQEfnCQ6TQ0N72uJX+t0QX8QmikrPGJjyy3QLQ=\",\n    \"./_framework/dotnet.native.hwglpvp32y.js\": \"sha256-0S3nkr+7+aZ+9tFRQOEYkmozryFXfrzgl+nv+qz71QM=\",\n    \"./_framework/dotnet.native.js\": \"sha256-0S3nkr+7+aZ+9tFRQOEYkmozryFXfrzgl+nv+qz71QM=\",\n    \"./_framework/dotnet.runtime.0t78nptbqi.js\": \"sha256-fBs/I1SdlqDOQOqxGF+LdElB3o5/FirA8fyIHRUy9cE=\",\n    \"./_framework/dotnet.runtime.js\": \"sha256-fBs/I1SdlqDOQOqxGF+LdElB3o5/FirA8fyIHRUy9cE=\",\n    \"./_framework/dotnet.y5zm2li12l.js\": \"sha256-eo4p7mQEfnCQ6TQ0N72uJX+t0QX8QmikrPGJjyy3QLQ=\",\n    \"./main.js\": \"sha256-9EZteoeGyecFbFTmMweXxx9ItCAClDZ8n+6lXEEulSU=\",\n    \"./main.ofkecrt505.js\": \"sha256-9EZteoeGyecFbFTmMweXxx9ItCAClDZ8n+6lXEEulSU=\"\n  }\n}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>module<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>main.ofkecrt505.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>In the <em>.csproj</em> file, the template also adds the required <code>OverrideHtmlAssetPlaceholders</code> and <code>StaticWebAssetFingerprintPattern</code> entries, which enables the above behaviour:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk.WebAssembly<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net10.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AllowUnsafeBlocks</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>AllowUnsafeBlocks</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token comment\">&lt;!-- 👇 Required for fingerprinting --&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OverrideHtmlAssetPlaceholders</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OverrideHtmlAssetPlaceholders</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token comment\">&lt;!-- 👇 Required for fingerprinting --&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>StaticWebAssetFingerprintPattern</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>JS<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Pattern</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>*.js<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p><em>However</em>. If you publish your application and inspect the <code>index.html</code> file you'll see that the <code>main.js</code> fingerprint is conspicuously missing:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!--           No fingerprint 👇 --&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>module<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>main.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>So what's going on here🤔 It turns out <a href=\"https://github.com/dotnet/runtime/pull/118572\">this was a bug</a> in the template, but you can work around it by making a change to your template:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-diff\"><code class=\"language-diff\"><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span><span class=\"token line\"> &lt;StaticWebAssetFingerprintPattern Include=\"JS\" Pattern=\"*.js\" /&gt;\n</span></span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span><span class=\"token line\"> &lt;StaticWebAssetFingerprintPattern Include=\"JS\" Pattern=\"*.js\" Expression=\"#[.{fingerprint}]!\" /&gt;\n</span></span></code></pre></div> <p>Adding the <code>Expression=\"#[.{fingerprint}]!\"</code> attribute (which is referenced <a href=\"https://learn.microsoft.com/en-us/aspnet/core/release-notes/aspnetcore-10.0?view=aspnetcore-10.0#client-side-fingerprinting\">in the documentation</a>) resolves the issue on publish, and ensures the fingerprint is added to the script files.</p> <h2 id=\"reducing-the-size-of-the-published-application\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/running-dotnet-in-the-browser-without-blazor/#reducing-the-size-of-the-published-application\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Reducing the size of the published application</a></h2> <p>Out of interest I checked the published size of this sample app (in release mode) and it looks roughly like the following:</p> <ul><li>6.8MB uncompressed</li> <li>2.5MB compressed (gzip)</li> <li>2.0MB compressed (brotli)</li></ul> <p>That includes all the files, including the .NET runtime, so that's not bad. The runtime is obviously heavily trimmed to reach these sizes, but can we go smaller? One obvious standout were <code>icu</code> assemblies, so I wondered if <a href=\"https://learn.microsoft.com/en-us/dotnet/core/runtime-config/globalization\">enabling globalization invariant</a> mode could reduce things further. I added the following to the project file:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>InvariantGlobalization</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>InvariantGlobalization</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>and ran <code>dotnet publish -c Release</code> again. And sure enough, there's some nice gains to be had:</p> <ul><li>4.3MB uncompressed—2.5MB reduction</li> <li>1.7MB compressed (gzip)—0.8MB reduction</li> <li>1.4MB compressed (brotli)—0.6MB reduction</li></ul> <p>That gave a 30-37% reduction in total app size, which is a pretty nice reduction! Obviously it depends on your application as to whether globalization invariant mode is feasible or not, but it's a handy tool to have if so.</p> <p>And that's all there is to it. This approach to running .NET code in JavaScript is much more low level than using Blazor or interacting with other web frameworks, so it's much less likely that you'll see big value from plugging in at this layer. However, if you don't <em>need</em> Blazor, then this might be just what you need!</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/running-dotnet-in-the-browser-without-blazor/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I described the various ways .NET code can run using WebAssembly (WASM), focusing on running .NET code in the browser <em>without</em> using the Blazor web component framework. I walked through the basic template for running .NET in the browser using WASM, examining both the .NET and JavaScript code to understand how they work together. Finally, I looked at some changes to the client-side fingerprinting in .NET 10 that enable cache-busting fingerprinting for your published assets.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/running-dotnet-in-the-browser-without-blazor/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/",
      "Title": "Passkey support for ASP.NET Core identity: Exploring the .NET 10 preview - Part 6",
      "PublishDate": "2025-08-05T10:00:00+00:00",
      "Summary": "In this post I look at the passkey support added to ASP.NET Core Identity and the Blazor Web App template, explore how it works, and look at the implementation",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/passkeys_banner.png\" /><nav><p>This is the sixth post in the series: <a href=\"https://andrewlock.net/series/exploring-the-dotnet-10-preview/\">Exploring the .NET 10 preview</a>. </p> <ol class=\"list-none\"><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/\">Part 1 - Exploring the features of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/\">Part 2 - Behind the scenes of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/\">Part 3 - C# 14 extension members; AKA extension everything</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/\">Part 4 - Solving the source generator 'marker attribute' problem in .NET 10</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/\">Part 5 - Running one-off .NET tools with dnx</a></li><li>Part 6 - Passkey support for ASP.NET Core identity (this post) </li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">Part 7 - Packaging self-contained and native AOT .NET tools for NuGet</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/\">Part 8 - Supporting platform-specific .NET tools on old .NET SDKs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/\">Part 9 - Easier reflection with [UnsafeAccessorType] in .NET 10</a></li></ol></nav><p>In this post I look at the passkey support added to ASP.NET Core Identity in .NET 10 preview 6. I primarily focus on the changes included in the Blazor template, looking at what's been added and changed as part of the passkey support. Finally, we take a peek at the source code of the template changes, to understand the new WebAuthn interactions with the browser.</p> <blockquote> <p>This post was written using the features available in .NET 10 preview 6. Many things may change between now and the final release of .NET 10.</p> </blockquote> <h2 id=\"what-are-passkeys-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/#what-are-passkeys-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What are passkeys?</a></h2> <p><a href=\"https://fidoalliance.org/passkeys/\">Passkeys</a> provide a secure, unphishable, password-less way to authenticate with websites and apps. They're based on standards provided by <a href=\"https://fidoalliance.org/\">FIDO (Fast IDentity Online)</a> and let you sign in to apps using the same mechanisms that you use to unlock your laptop or phone: such as your biometrics or a PIN. They're inherently more secure than passwords, though <a href=\"https://arstechnica.com/security/2024/12/passkey-technology-is-elegant-but-its-most-definitely-not-usable-security/\">they do have some usability challenges</a> when it comes to sharing your passkeys between multiple devices.</p> <p>In .NET 10 preview 6, ASP.NET Core has added support for passkeys as an alternative way to login to apps that are using ASP.NET Core Identity. They don't completely replace passwords in the current templates, so you still need to register with a password initially, but you can add a passkey to your account subsequently for easier logging in.</p> <blockquote> <p>Personally, this seems like it fundamentally misses the point of passkeys. The whole point of passkeys in my eyes is that you <em>don't</em> have passwords, so you can't be phished. Having an ever-present mandatory password seems to defeat half the purpose of passkeys.</p> </blockquote> <p>In the next section I take a brief look at the default Blazor template with individual authentication enabled to see how it's changed from the .NET 9 version.</p> <h2 id=\"trying-out-the-new-template\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/#trying-out-the-new-template\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Trying out the new template</a></h2> <p>Passkey support was added <a href=\"https://github.com/dotnet/aspnetcore/pull/62112\">in this giant PR</a>, which added the new passkey abstractions to ASP.NET Core Identity and made the changes to the Blazor Web App template that we're looking at in this post. Before we get started, it's worth noting what \"passkey supports\" actually <em>means</em>. As noted in the PR description:</p> <blockquote> <p>Note that the goal of this PR is to add support for passkey authentication in ASP.NET Core Identity. While it implements core WebAuthn functionality, it does not provide a complete and general-purpose WebAuthn/FIDO2 library. The public API surface is limited in order to enable long-term stability of the feature. Targeted extensibility points were added to enable functionality not implemented by default, most notably attestation statement validation. This allows the use of third-party libraries to fill the missing gaps, when desired. Community feedback may result in additional extensibility APIs being added in the future.</p> </blockquote> <p>If you want (or need) a more full-featured library, then you might want to consider <a href=\"https://github.com/passwordless-lib/fido2-net-lib\">the Fido2 library</a> which supports .NET 8 and above. You can also use this library in combination with the built-in passkey support to enable additional features such as attestation statement validation.</p> <p>Before looking at the code, we'll start by creating a new web app with ASP.NET Core Identity, and explore what the new passkey support looks like in the UI.</p> <blockquote> <p>Passkey support was added in .NET 10 preview 6, so you need to be using at least this version of the SDK. If you're using a later version, then things may change from what I show here.</p> </blockquote> <p>Create a new Blazor Web App with individual authentication:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet new blazor <span class=\"token parameter variable\">-au</span> Individual\n</code></pre></div> <p>You can run the application using <code>dotnet run</code> or by pressing <kbd>F5</kbd> in your IDE, and you'll be greeted with the familiar Blazor web app. Navigate to the <strong>Register</strong> page and create a new user:</p> <p><img src=\"https://andrewlock.net/content/images/2025/passkeys_02.png\" alt=\"The register page of the application\"></p> <p>So far, there's no obvious difference. After creating your account, click the \"Click here to confirm your account\" link and then navigate to the login page.</p> <blockquote> <p>Note that in the default template, users must still create a password for the account, even if they later want to use passkeys. This isn't a requirement of ASP.NET Core Identity itself, just of how the template works.</p> </blockquote> <p>After registering, login, and navigate to the account page. Here you'll find a new section, <strong>Passkeys</strong>, which allows you to register a passkey:</p> <p><img src=\"https://andrewlock.net/content/images/2025/passkeys_03.png\" alt=\"The passkey management page of the application\"></p> <p>Click <strong>Add a new passkey</strong> to initiate the registration process. Clicking this button will pop up a native dialog from your browser. If you're using a password manager with passkey support, like <a href=\"https://1password.com/\">1Password</a>, then it will likely prompt you to save your passkeys there. Otherwise you'll get a native popup from your browser with your available options:</p> <p><img src=\"https://andrewlock.net/content/images/2025/passkeys_04.png\" alt=\"The passkey enrolment popup\"></p> <p>What this dialog looks like and which options are available to you will depend on the device you're using. In the case above I was using a Windows device with a Windows Hello camera.</p> <blockquote> <p>You'll notice there's also a <strong>Use another device</strong> option, which lets you use (for example) a nearby phone with biometric support to perform the authentication. You can read more about <a href=\"https://www.passkeycentral.org/design-guidelines/optional-patterns/cross-device-sign-in\">cross-device sign-in here</a>.</p> </blockquote> <p>Choose where to save your passkey, perform the necessary authentication, and you should see confirmation that the passkey is enrolled:</p> <p><img src=\"https://andrewlock.net/content/images/2025/passkeys_05.png\" alt=\"The passkey enrolment success popup\"></p> <p>Now that you've saved the passkey to your device, the Blazor app prompts you to choose a name for the passkey. Technically the passkey is already saved at this point (with the name \"Unnamed passkey\") but you should choose a more descriptive key name and click <strong>Continue</strong>:</p> <p><img src=\"https://andrewlock.net/content/images/2025/passkeys_07.png\" alt=\"Naming a newly-enrolled passkey\"></p> <p>Now that your passkey is enrolled you can enrol another passkey, rename an existing key, or delete the key from the passkeys page:</p> <p><img src=\"https://andrewlock.net/content/images/2025/passkeys_08.png\" alt=\"The manage passkeys page\"></p> <p>Next we'll try-out the login flow. Logout of your account, and on the login page don't enter your username and password. Instead, click the <strong>Log in with a passkey</strong> link:</p> <p><img src=\"https://andrewlock.net/content/images/2025/passkeys_01.png\" alt=\"The login page contains a 'log in with a passkey' link\"></p> <p>When you click this link, the browser will generally pop-up a window prompting you to choose a passkey to use to login with:</p> <p><img src=\"https://andrewlock.net/content/images/2025/passkeys_06.png\" alt=\"The 'use a saved passkey' dialog in Chrome on Windows\"></p> <p>After choosing the saved passkey, you'll be prompted to authenticate with your device using a native prompt. In my case this involved another face-recognition Windows Hello authentication, but it will vary by device. After authenticating, you're immediately logged in to the website, without needing to enter a username and password.</p> <blockquote> <p>As a small bonus, if you want to delete the passkeys saved on your Windows device, for example after testing with a sample app, go to the Windows Settings app and choose Accounts &gt; Passkeys (or click <a href=\"ms-settings:savedpasskeys\">this link</a>). From there you can delete your old passkeys (but make sure you don't delete any you actually need!)</p> </blockquote> <p>That pretty much covers all the user-facing changes to support passkeys in the new template. There's no ability to use passkeys as an additional factor for multi-factor authentication, or to remove the password associated with the account entirely.</p> <p>To finish off this post we'll look at some of the code changes behind the passkey support, focusing on the parts that interact with the ASP.NET Core Identity system and the browser.</p> <h2 id=\"looking-at-the-code-changes\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/#looking-at-the-code-changes\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Looking at the code changes</a></h2> <p>All the code I show in this section is part of the template when you create a new Blazor Web App template using .NET 10 preview 6. There were also changes made to the ASP.NET Core Identity system to support the template additions, but I don't go into those here.</p> <blockquote> <p>Note that the code shown here is specifically for .NET 10 preview 6. <a href=\"https://github.com/dotnet/aspnetcore/pull/62530\">This code has already been updated</a> for newer previews, and will likely change again before final GA release, so take it all with a pinch of salt!</p> </blockquote> <p>On the UI side, the most important new component is <em>Components/Account/Shared/PasskeySubmit.razor</em> and its corresponding collocated JavaScript file <em>PasskeySubmit.razor.js</em>. The JavaScript in particular contains all the functions for calling the browser's WebAuthn features for interacting with passkeys. We'll look at this file in detail shortly.</p> <p>Aside from the <code>PasskeySubmit</code> component, there are several new and updated components:</p> <ul><li><em>Components/Account/Pages/Login.razor</em>—Updated to include the \"log in with a passkey\" link.</li> <li><em>Components/Account/Shared/ManageNavMenu.razor</em>—Updated to include the \"Passkeys\" menu item.</li> <li><em>Components/Account/Manage/Passkeys.razor</em>—The passkey management page for adding and deleting passkeys.</li> <li><em>Components/Account/Manage/RenamePasskey.razor</em>—The page for renaming passkeys.</li></ul> <p>On the backend of the application there are two main changes:</p> <ul><li>New APIs in <code>IdentityComponentsEndpointRouteBuilderExtensions</code> called by the Blazor components for interacting with ASP.NET Core Identity</li> <li>A new EF Core migration for saving a user's passkey information to the database.</li></ul> <p>That covers pretty much all of the public-facing changes in the templates, so let's look at each of them in more detail.</p> <p>We'll start with the <code>PasskeySubmit</code> component, the markup for which is shown below:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>submit<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>__passkeySubmit<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">@attributes</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>AdditionalAttributes<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>@ChildContent<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>passkey-submit</span> <span class=\"token attr-name\">operation</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@Operation<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@Name<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">email-name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@EmailName<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>passkey-submit</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>The component itself is pretty simple, just a form submit button and a custom element called <code>passkey-submit</code>. If we take a look in <code>PasskeySubmit.razor.js</code> we can see how this custom-element is wired up. The outline of this is shown below, along with some bonus comments explaining various API calls:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// register a custom element definition</span>\ncustomElements<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'passkey-submit'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">extends</span> HTMLElement <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> formAssociated <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// connectedCallback fires when an element is inserted into the DOM</span>\n    <span class=\"token function\">connectedCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// attaches the custom-element to a form</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>internals <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">attachInternals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// grab the details passed as attributes to the element</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>attrs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">operation</span><span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'operation'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">emailName</span><span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'email-name'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Register a submit handler on the form, and if it was triggered</span>\n        <span class=\"token comment\">// by the __passkeySubmit button then try to submit a Passkey credential</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>internals<span class=\"token punctuation\">.</span>form<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'submit'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>submitter<span class=\"token operator\">?.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'__passkeySubmit'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                event<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\">// get or create a passkey credential and submit the form</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">obtainCredentialAndSubmit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// try to auto-fill the passkey, to improve the user experience</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">tryAutofillPasskey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// disconnectedCallback fires when an element is removed from the DOM</span>\n    <span class=\"token function\">disconnectedCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>abortController<span class=\"token operator\">?.</span><span class=\"token function\">abort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">async</span> <span class=\"token function\">tryAutofillPasskey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>attrs<span class=\"token punctuation\">.</span>operation <span class=\"token operator\">===</span> <span class=\"token string\">'Request'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">await</span> PublicKeyCredential<span class=\"token punctuation\">.</span><span class=\"token function\">isConditionalMediationAvailable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// If the component is in 'request' mode (i.e. login), </span>\n            <span class=\"token comment\">// and autofill is available and supported in the browser</span>\n            <span class=\"token comment\">// then try to pre-autofill</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">obtainCredentialAndSubmit</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* useConditionalMediation */</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">async</span> <span class=\"token function\">obtainCredentialAndSubmit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">useConditionalMediation <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// AbortController works similarly to a CancelationToken in .NET</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>abortController<span class=\"token operator\">?.</span><span class=\"token function\">abort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>abortController <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AbortController</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> signal <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>abortController<span class=\"token punctuation\">.</span>signal<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> formData <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> credential<span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// Either create a new credential or request an existing one</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>attrs<span class=\"token punctuation\">.</span>operation <span class=\"token operator\">===</span> <span class=\"token string\">'Create'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                credential <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">createCredential</span><span class=\"token punctuation\">(</span>signal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>attrs<span class=\"token punctuation\">.</span>operation <span class=\"token operator\">===</span> <span class=\"token string\">'Request'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">const</span> email <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormData</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>internals<span class=\"token punctuation\">.</span>form<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>attrs<span class=\"token punctuation\">.</span>emailName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">const</span> mediation <span class=\"token operator\">=</span> useConditionalMediation <span class=\"token operator\">?</span> <span class=\"token string\">'conditional'</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n                credential <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">requestCredential</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">,</span> mediation<span class=\"token punctuation\">,</span> signal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Unknown passkey operation '</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>operation<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">'.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\">// convert the credential to JSON and store it in the form data</span>\n            <span class=\"token keyword\">const</span> credentialJson <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>credential<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            formData<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>attrs<span class=\"token punctuation\">.</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.CredentialJson</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> credentialJson<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'AbortError'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// Canceled by user action, do not submit the form</span>\n                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            formData<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>attrs<span class=\"token punctuation\">.</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.Error</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// Set the form data and submit it</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>internals<span class=\"token punctuation\">.</span><span class=\"token function\">setFormValue</span><span class=\"token punctuation\">(</span>formData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>internals<span class=\"token punctuation\">.</span>form<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>This code shows all the behaviour added to the <code>passkey-submit</code> element. We're just missing the definition of two functions: <code>createCredential()</code> and <code>requestCredential()</code>, shown below:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Called to create a new passkey</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createCredential</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">signal</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Call the ASP.NET Core Identity endpoint to get the passkey options for the app</span>\n    <span class=\"token keyword\">const</span> optionsResponse <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchWithErrorHandling</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/Account/PasskeyCreationOptions'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\n        signal<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Convert the response to a passkey options JSON object</span>\n    <span class=\"token keyword\">const</span> optionsJson <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> optionsResponse<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> PublicKeyCredential<span class=\"token punctuation\">.</span><span class=\"token function\">parseCreationOptionsFromJSON</span><span class=\"token punctuation\">(</span>optionsJson<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Trigger the browser to create a passkey credential using </span>\n    <span class=\"token comment\">// the provided options and return the credentials</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> navigator<span class=\"token punctuation\">.</span>credentials<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">publicKey</span><span class=\"token operator\">:</span> options<span class=\"token punctuation\">,</span> signal <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Called to trigger a login using a passkey</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">requestCredential</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">email<span class=\"token punctuation\">,</span> mediation<span class=\"token punctuation\">,</span> signal</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Call the ASP.NET Core Identity endpoint to get the passkey options for the app</span>\n    <span class=\"token keyword\">const</span> optionsResponse <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchWithErrorHandling</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/Account/PasskeyRequestOptions?username=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>email<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\n        signal<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Convert the response to a passkey options JSON object</span>\n    <span class=\"token keyword\">const</span> optionsJson <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> optionsResponse<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> PublicKeyCredential<span class=\"token punctuation\">.</span><span class=\"token function\">parseRequestOptionsFromJSON</span><span class=\"token punctuation\">(</span>optionsJson<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Trigger the browser to try to login to a passkey credential using</span>\n    <span class=\"token comment\">// the provided options and return the credentials</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> navigator<span class=\"token punctuation\">.</span>credentials<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">publicKey</span><span class=\"token operator\">:</span> options<span class=\"token punctuation\">,</span> mediation<span class=\"token punctuation\">,</span> signal <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Helper function for sending an HTTP request and returning the response</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">fetchWithErrorHandling</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">credentials</span><span class=\"token operator\">:</span> <span class=\"token string\">'include'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span>options\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>response<span class=\"token punctuation\">.</span>ok<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> text <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">The server responded with status </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>status<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>These functions make calls to 2 API endpoints, exposed in <code>IdentityComponentsEndpointRouteBuilderExtensions</code>. The first is <code>/Account/PasskeyCreationOptions</code>, which is called when you're adding a passkey to an existing logged-in user's account:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">internal</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">IdentityComponentsEndpointRouteBuilderExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\">IEndpointConventionBuilder</span> <span class=\"token function\">MapAdditionalIdentityEndpoints</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">IEndpointRouteBuilder</span> endpoints<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> accountGroup <span class=\"token operator\">=</span> endpoints<span class=\"token punctuation\">.</span><span class=\"token function\">MapGroup</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/Account\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// ...</span>\n        \n        accountGroup<span class=\"token punctuation\">.</span><span class=\"token function\">MapPost</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/PasskeyCreationOptions\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>\n            <span class=\"token class-name\">HttpContext</span> context<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FromServices</span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\">UserManager<span class=\"token punctuation\">&lt;</span>ApplicationUser<span class=\"token punctuation\">&gt;</span></span> userManager<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FromServices</span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\">SignInManager<span class=\"token punctuation\">&lt;</span>ApplicationUser<span class=\"token punctuation\">&gt;</span></span> signInManager<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> userManager<span class=\"token punctuation\">.</span><span class=\"token function\">GetUserAsync</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>user <span class=\"token keyword\">is</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> Results<span class=\"token punctuation\">.</span><span class=\"token function\">NotFound</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Unable to load user with ID '</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">userManager<span class=\"token punctuation\">.</span><span class=\"token function\">GetUserId</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>User<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">'.\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\">// Collect current user's details to create a PasskeyCreationArgs object</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> userId <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> userManager<span class=\"token punctuation\">.</span><span class=\"token function\">GetUserIdAsync</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> userName <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> userManager<span class=\"token punctuation\">.</span><span class=\"token function\">GetUserNameAsync</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> <span class=\"token string\">\"User\"</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> userEntity <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PasskeyUserEntity</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">,</span> userName<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">displayName</span><span class=\"token punctuation\">:</span> userName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> passkeyCreationArgs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PasskeyCreationArgs</span><span class=\"token punctuation\">(</span>userEntity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// Use the arguments to create the passkey options object</span>\n            <span class=\"token comment\">// and return it as JSON, for use client-side</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> options <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> signInManager<span class=\"token punctuation\">.</span><span class=\"token function\">ConfigurePasskeyCreationOptionsAsync</span><span class=\"token punctuation\">(</span>passkeyCreationArgs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> TypedResults<span class=\"token punctuation\">.</span><span class=\"token function\">Content</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span><span class=\"token function\">AsJson</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">contentType</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The <code>SignInManager.ConfigurePasskeyCreationOptionsAsync()</code> method is where all the actual work occurs (renamed to <code>MakePasskeyCreationOptionsAsync</code> in a future .NET 10 release). This method is responsible for generating the passkey options, storing them in an authentication cookie, and returning the JSON. For reference, the returned JSON will look something like this (I removed most of the <code>pubKeyCredParams</code> options for brevity):</p> <div class=\"pre-code-wrapper\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"rp\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"localhost\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"OWVhMDBjMDUtYjU4LThmODEtMWNlNWNihmYS00NWMmRlNjdi\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"test@test.com\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"test@test.com\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"challenge\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"4ZIzlOlk9bTwB4veQVQc9w\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"pubKeyCredParams\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"public-key\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"alg\"</span><span class=\"token operator\">:</span> <span class=\"token number\">-7</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"public-key\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"alg\"</span><span class=\"token operator\">:</span> <span class=\"token number\">-37</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"timeout\"</span><span class=\"token operator\">:</span> <span class=\"token number\">60000</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"excludeCredentials\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"hints\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"attestation\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"attestationFormats\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>These options are returned to the browser and are used to generate the passkey client-side.</p> <p>The other API endpoint, <code>PasskeyRequestOptions</code> is almost identical, though as this is intended for logging-in, there's no authenticated user <em>required</em> at this point (though if you enter your username first, it can be used to improve the UX of choosing a passkey).</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">accountGroup<span class=\"token punctuation\">.</span><span class=\"token function\">MapPost</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/PasskeyRequestOptions\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FromServices</span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\">UserManager<span class=\"token punctuation\">&lt;</span>ApplicationUser<span class=\"token punctuation\">&gt;</span></span> userManager<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FromServices</span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\">SignInManager<span class=\"token punctuation\">&lt;</span>ApplicationUser<span class=\"token punctuation\">&gt;</span></span> signInManager<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FromQuery</span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">?</span></span> username<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsNullOrEmpty</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">await</span> userManager<span class=\"token punctuation\">.</span><span class=\"token function\">FindByNameAsync</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> passkeyRequestArgs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PasskeyRequestArgs<span class=\"token punctuation\">&lt;</span>ApplicationUser<span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token punctuation\">{</span>\n        User <span class=\"token operator\">=</span> user<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> options <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> signInManager<span class=\"token punctuation\">.</span><span class=\"token function\">ConfigurePasskeyRequestOptionsAsync</span><span class=\"token punctuation\">(</span>passkeyRequestArgs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> TypedResults<span class=\"token punctuation\">.</span><span class=\"token function\">Content</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span><span class=\"token function\">AsJson</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">contentType</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Note that these options are used both during passkey creation and login with the <code>PasskeySubmit</code> component, but the <em>results</em> of that operation, i.e. the credential created or retrieved from the browser, are just stored in a form field and submitted. The <em>handling</em> of that data happens in the <code>Passkeys</code> and <code>Login</code> components.</p> <p>The <code>Passkeys</code> component contains markup similar to the following, which places the <code>PasskeySubmit</code> component inside a form, and hooks up the <code>AddPasskey()</code> handler:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-cshtml\"><code class=\"language-cshtml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>form</span> <span class=\"token attr-name\">@formname</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>add-passkey<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">@onsubmit</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>AddPasskey<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">method</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>post<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AntiforgeryToken</span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PasskeySubmit</span> <span class=\"token attr-name\">Operation</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>PasskeyOperation.Create<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Input<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>btn btn-primary<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>Add a new passkey<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PasskeySubmit</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>form</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>As you've already seen, the <code>PasskeySubmit</code> component, handles the registration of a passkey client-side, and then stores the details about the passkey in the surrounding form. The <code>AddPasskey()</code> method must then use this form data to actually save and persist the passkey details. This method is shown below with comments (with some error handling elided for brevity):</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">AddPasskey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Retrieves details from the HttpContext that were stored when </span>\n    <span class=\"token comment\">// ConfigurePasskeyCreationOptionsAsync/MakePasskeyCreationOptionsAsync was called</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> options <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> SignInManager<span class=\"token punctuation\">.</span><span class=\"token function\">RetrievePasskeyCreationOptionsAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Verify that the provided credentials are valid and can be saved</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> attestationResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> SignInManager<span class=\"token punctuation\">.</span><span class=\"token function\">PerformPasskeyAttestationAsync</span><span class=\"token punctuation\">(</span>Input<span class=\"token punctuation\">.</span>CredentialJson<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>attestationResult<span class=\"token punctuation\">.</span>Succeeded<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        RedirectManager<span class=\"token punctuation\">.</span><span class=\"token function\">RedirectToCurrentPageWithStatus</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Error: Could not add the passkey: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">attestationResult<span class=\"token punctuation\">.</span>Failure<span class=\"token punctuation\">.</span>Message</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">.\"</span></span><span class=\"token punctuation\">,</span> HttpContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Save the results to the user account</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> setPasskeyResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> UserManager<span class=\"token punctuation\">.</span><span class=\"token function\">SetPasskeyAsync</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> attestationResult<span class=\"token punctuation\">.</span>Passkey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>setPasskeyResult<span class=\"token punctuation\">.</span>Succeeded<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        RedirectManager<span class=\"token punctuation\">.</span><span class=\"token function\">RedirectToCurrentPageWithStatus</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error: The passkey could not be added to your account.\"</span><span class=\"token punctuation\">,</span> HttpContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Immediately prompt the user to enter a name for the credential</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> credentialIdBase64Url <span class=\"token operator\">=</span> Base64Url<span class=\"token punctuation\">.</span><span class=\"token function\">EncodeToString</span><span class=\"token punctuation\">(</span>attestationResult<span class=\"token punctuation\">.</span>Passkey<span class=\"token punctuation\">.</span>CredentialId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    RedirectManager<span class=\"token punctuation\">.</span><span class=\"token function\">RedirectTo</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Account/Manage/RenamePasskey/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">credentialIdBase64Url</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The <code>UserManager.SetPasskeyAsync()</code> method is where the passkey is actually saved to the database, in a table called <code>AspNetUserPasskeys</code>. The initial definition for this table changed <a href=\"https://github.com/dotnet/aspnetcore/pull/62530\">in a recent update</a>, which is the version I show below. It's a simpler definition than the version used in preview 6, in that the <code>Data</code> column contains a JSON representation of the passkey credential details. The migration code shows that the database consists of just 2 ID columns and the Data column:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">migrationBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">CreateTable</span><span class=\"token punctuation\">(</span>\n    <span class=\"token named-parameter punctuation\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"AspNetUserPasskeys\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token named-parameter punctuation\">columns</span><span class=\"token punctuation\">:</span> table <span class=\"token operator\">=&gt;</span> <span class=\"token keyword\">new</span>\n    <span class=\"token punctuation\">{</span>\n        CredentialId <span class=\"token operator\">=</span> table<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Column</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"BLOB\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">maxLength</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">nullable</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        UserId <span class=\"token operator\">=</span> table<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Column</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TEXT\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">nullable</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Data <span class=\"token operator\">=</span> table<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Column</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"TEXT\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">nullable</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token named-parameter punctuation\">constraints</span><span class=\"token punctuation\">:</span> table <span class=\"token operator\">=&gt;</span>\n    <span class=\"token punctuation\">{</span>\n        table<span class=\"token punctuation\">.</span><span class=\"token function\">PrimaryKey</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PK_AspNetUserPasskeys\"</span><span class=\"token punctuation\">,</span> x <span class=\"token operator\">=&gt;</span> x<span class=\"token punctuation\">.</span>CredentialId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        table<span class=\"token punctuation\">.</span><span class=\"token function\">ForeignKey</span><span class=\"token punctuation\">(</span>\n            <span class=\"token named-parameter punctuation\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"FK_AspNetUserPasskeys_AspNetUsers_UserId\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token named-parameter punctuation\">column</span><span class=\"token punctuation\">:</span> x <span class=\"token operator\">=&gt;</span> x<span class=\"token punctuation\">.</span>UserId<span class=\"token punctuation\">,</span>\n            <span class=\"token named-parameter punctuation\">principalTable</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"AspNetUsers\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token named-parameter punctuation\">principalColumn</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Id\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token named-parameter punctuation\">onDelete</span><span class=\"token punctuation\">:</span> ReferentialAction<span class=\"token punctuation\">.</span>Cascade<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>There's lots more code we <em>could</em> look at, some of which is pretty interesting, but seeing as this code is all changing rapidly in these preview releases, and this post is already long-enough as it is, I'll leave it there. Happy playing with passkeys!</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I gave a brief overview of Passkeys, and showed how basic passkey support has been added to ASP.NET Core Identity and the Blazor Web App template. I walked through the user process of adding a new passkey to an account, renaming it, and using it to log in. Finally I walked through the new code added to the template in .NET 10 preview 6. Much of this code has already changed in newer previews, but the overall flow and the interaction between the components remains the same.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/",
      "Title": "Running one-off .NET tools with dnx: Exploring the .NET 10 preview - Part 5",
      "PublishDate": "2025-07-29T10:00:00+00:00",
      "Summary": "In this post I show the new dnx command for running .NET tools without installing them and look at exactly how it works.",
      "Content": "<img src=\"https://andrewlock.net/content/images/2019/banner_local_tools.jpg\" /><nav><p>This is the fifth post in the series: <a href=\"https://andrewlock.net/series/exploring-the-dotnet-10-preview/\">Exploring the .NET 10 preview</a>. </p> <ol class=\"list-none\"><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/\">Part 1 - Exploring the features of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/\">Part 2 - Behind the scenes of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/\">Part 3 - C# 14 extension members; AKA extension everything</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/\">Part 4 - Solving the source generator 'marker attribute' problem in .NET 10</a></li><li>Part 5 - Running one-off .NET tools with dnx (this post) </li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/\">Part 6 - Passkey support for ASP.NET Core identity</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">Part 7 - Packaging self-contained and native AOT .NET tools for NuGet</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/\">Part 8 - Supporting platform-specific .NET tools on old .NET SDKs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/\">Part 9 - Easier reflection with [UnsafeAccessorType] in .NET 10</a></li></ol></nav><p>In this post I briefly show the new <code>dnx</code> command for running one-off .NET tools without installing them. I show how to use the command, how the command works in practice, and how the command works behind the scenes in the .NET SDK.</p> <h2 id=\"running-tools-without-installing-them-with-dnx\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/#running-tools-without-installing-them-with-dnx\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Running tools without installing them with <code>dnx</code></a></h2> <p>The Node.js ecosystem has had a tool called <code>npx</code> <a href=\"https://blog.npmjs.org/post/162869356040/introducing-npx-an-npm-package-runner?utm_source=chatgpt.com\">since 2017</a>. Sitting alongside the <code>npm</code> package-manager tool, it allows running a Node.js tool from a package without having to installing it globally. .NET Core added support for tools in NuGet packages shortly afterwards in 2018, back in .NET Core 2.1, but this has always required an explicit <code>dotnet tool install</code> command before you can run the tool. Until now.</p> <p>.NET 10 preview 6 added support for running .NET tools without explicitly installing them first with the introduction of the new .NET SDK command <code>dnx</code>. What's more, the .NET SDK also ships a standalone <code>dnx</code> command so that you can run <code>dnx &lt;tool&gt;</code> directly instead of <code>dotnet dnx &lt;tool&gt;</code>.</p> <p>One of the easiest ways to understand what's available with the new <code>dnx</code> command is to take a look at the built-in command line help:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dnx <span class=\"token parameter variable\">--help</span>\nDescription:\n  Executes a tool from <span class=\"token builtin class-name\">source</span> without permanently installing it.\n\nUsage:\n  dotnet dnx <span class=\"token operator\">&lt;</span>packageId<span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&lt;</span>commandArguments<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>options<span class=\"token punctuation\">]</span>\n\nArguments:\n  <span class=\"token operator\">&lt;</span>PACKAGE_ID<span class=\"token operator\">&gt;</span>        Package reference <span class=\"token keyword\">in</span> the form of a package identifier like <span class=\"token string\">'Newtonsoft.Json'</span> or package identifier and version separated by <span class=\"token string\">'@'</span> like <span class=\"token string\">'Newtonsoft.Json@13.0.3'</span><span class=\"token builtin class-name\">.</span>\n  <span class=\"token operator\">&lt;</span>commandArguments<span class=\"token operator\">&gt;</span>  Arguments forwarded to the tool\n\nOptions:\n  <span class=\"token parameter variable\">--version</span> <span class=\"token operator\">&lt;</span>VERSION<span class=\"token operator\">&gt;</span>       The version of the tool package to install.\n  -y, <span class=\"token parameter variable\">--yes</span>                 Accept all confirmation prompts using <span class=\"token string\">\"yes.\"</span>\n  <span class=\"token parameter variable\">--interactive</span>             Allows the <span class=\"token builtin class-name\">command</span> to stop and <span class=\"token function\">wait</span> <span class=\"token keyword\">for</span> user input or action <span class=\"token punctuation\">(</span>for example to complete authentication<span class=\"token punctuation\">)</span>. <span class=\"token punctuation\">[</span>default: True<span class=\"token punctuation\">]</span>\n  --allow-roll-forward      Allow a .NET tool to roll forward to newer versions of the .NET runtime <span class=\"token keyword\">if</span> the runtime it targets isn't installed.\n  <span class=\"token parameter variable\">--prerelease</span>              Include pre-release packages.\n  <span class=\"token parameter variable\">--configfile</span> <span class=\"token operator\">&lt;</span>FILE<span class=\"token operator\">&gt;</span>       The NuGet configuration <span class=\"token function\">file</span> to use.\n  <span class=\"token parameter variable\">--source</span> <span class=\"token operator\">&lt;</span>SOURCE<span class=\"token operator\">&gt;</span>         Replace all NuGet package sources to use during installation with these.\n  --add-source <span class=\"token operator\">&lt;</span>ADDSOURCE<span class=\"token operator\">&gt;</span>  Add an additional NuGet package <span class=\"token builtin class-name\">source</span> to use during installation.\n  --disable-parallel        Prevent restoring multiple projects <span class=\"token keyword\">in</span> parallel.\n  --ignore-failed-sources   Treat package <span class=\"token builtin class-name\">source</span> failures as warnings.\n  --no-http-cache           Do not cache packages and http requests.\n  -v, <span class=\"token parameter variable\">--verbosity</span> <span class=\"token operator\">&lt;</span>LEVEL<span class=\"token operator\">&gt;</span>   Set the MSBuild verbosity level. Allowed values are q<span class=\"token punctuation\">[</span>uiet<span class=\"token punctuation\">]</span>, m<span class=\"token punctuation\">[</span>inimal<span class=\"token punctuation\">]</span>, n<span class=\"token punctuation\">[</span>ormal<span class=\"token punctuation\">]</span>, d<span class=\"token punctuation\">[</span>etailed<span class=\"token punctuation\">]</span>, and diag<span class=\"token punctuation\">[</span>nostic<span class=\"token punctuation\">]</span>.\n  -?, -h, <span class=\"token parameter variable\">--help</span>            Show <span class=\"token builtin class-name\">command</span> line help.\n</code></pre></div> <p>As you might expect, there's a lot of overlap with the existing <code>dotnet tool</code> commands. One point that differs is the (optional) way you can specify the package version with a <code>@</code> separator, for example, <code>Newtonsoft.Json@13.0.3</code>. This is a common pattern used in other ecosystems like Node.js and Go, for example, and it's now making it's way to .NET.</p> <blockquote> <p>I think we first saw this notation in .NET <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#adding-nuget-package-references\">with the recent <code>dotnet run app.cs</code> feature</a>. Overall, it points to a willingness to break from some of .NET's tendency towards verbosity in favour of embracing more concise patterns, particularly patterns from other ecosystems.</p> </blockquote> <p>So now let's try it out. As an example, I'll use the classic demo tool <code>dotnetsay</code>. When you run using <code>dnx dotnetsay</code>, you have to confirm that the .NET SDK should download the tool. If you answer <code>n</code>, the run is cancelled; if you answer <code>y</code> then it downloads and runs the tool:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dnx dotnetsay\nTool package dotnetsay@2.1.7 will be downloaded from <span class=\"token builtin class-name\">source</span> https://api.nuget.org/v3/index.json.\nProceed? <span class=\"token punctuation\">[</span>y/n<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span>: y\n\n        Welcome to using a .NET Core global tool<span class=\"token operator\">!</span>\n</code></pre></div> <p>Note that you only get the confirmation the first time you run and download the tool. The next time, the tool runs without confirmation:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dnx dotnetsay\n\n        Welcome to using a .NET Core global tool<span class=\"token operator\">!</span>\n</code></pre></div> <p>And there you have it: one-shot .NET tool execution.</p> <h2 id=\"how-is-dnx-different-to-dotnet-tool-install-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/#how-is-dnx-different-to-dotnet-tool-install-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">How is <code>dnx</code> different to <code>dotnet tool install</code>?</a></h2> <p>Now, you might be thinking that this <code>dnx</code> is nice and short, but is it <em>really</em> that different to installing the tool? And the answer is both yes and no.</p> <p>The typical way you would <em>install</em> the <code>dotnetsay</code> tool globally would be using:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet tool <span class=\"token function\">install</span> <span class=\"token parameter variable\">-g</span> dotnetsay\n</code></pre></div> <p>The <code>-g</code> means the tool is installed globally, though you can <a href=\"https://andrewlock.net/new-in-net-core-3-local-tools/\">also install tools locally</a>. You can then run the tool by simply running:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnetsay\n\n        Welcome to using a .NET Core global tool<span class=\"token operator\">!</span>\n</code></pre></div> <p>But what does \"installed globally\" actually <em>mean</em>? And how does it differ from what <code>dnx</code> does?</p> <p>Step one in both cases is to download <a href=\"https://www.nuget.org/packages/dotnetsay\">the dotnetsay NuGet package</a>. This goes through layers of caching and is ultimately expanded into the global package location. This is also where all the NuGet packages that are downloaded as part of project builds are stored by default.</p> <blockquote> <p>You can see the location of the NuGet-related folders on your machine by running <code>dotnet nuget locals all --list</code></p> </blockquote> <p>After downloading the package, the SDK also copies the expanded package to the \"dotnet tool\" store location. By default, these expanded directories can be found at <code>~/.dotnet/tools/.store</code>. The .NET SDK <em>also</em> installs an executable shim in <code>~/.dotnet/tools</code>, which is also on the machine's <code>PATH</code>, so they can be easily invoked.</p> <p>In contrast, the <code>dnx</code> command downloads the package and installs it into the global package cache, but it <em>doesn't</em> install anything in the tool store or add a shim to <code>~/.dotnet/tools</code>. Instead it runs the tool directly from the package cache. This is what makes it the \"one shot\" run instead of the persistent <code>dotnet tool install</code> approach.</p> <h2 id=\"how-does-dnx-work-behind-the-scenes-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/#how-does-dnx-work-behind-the-scenes-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">How does <code>dnx</code> work behind the scenes?</a></h2> <p>Whenever a big new feature drops in .NET, I like to sniff around to see how it was implemented, and <code>dnx</code> was no different. I started by finding the origin of the <code>dnx</code> command itself by running <code>where dnx</code> from a command line:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> where dnx\nC:<span class=\"token punctuation\">\\</span>Program Files<span class=\"token punctuation\">\\</span>dotnet<span class=\"token punctuation\">\\</span>dnx.cmd\n</code></pre></div> <p>As you can see, the <code>dnx</code> command is actually a <code>cmd</code> file, installed side-by-side with the <code>dotnet.exe</code>. If you crack it open you can see that all it's doing is invoking <code>dotnet dnx</code>, and passing the remaining arguments:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-cmd\"><code class=\"language-cmd\"><span class=\"token operator\">@</span><span class=\"token command\"><span class=\"token keyword\">echo</span> off</span>\n\"%~dp0dotnet.exe\" dnx %*\n</code></pre></div> <p>There's <a href=\"https://github.com/dotnet/sdk/blob/main/src/Layout/redist/dnx\">a similar file</a> for Linux and MacOS that provides the <code>dnx</code> command, and as expected, it does a similar thing:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/sh</span>\n\n<span class=\"token comment\"># Licensed to the .NET Foundation under one or more agreements.</span>\n<span class=\"token comment\"># The .NET Foundation licenses this file to you under the MIT license.</span>\n\n<span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">dirname</span> <span class=\"token string\">\"<span class=\"token variable\">$0</span>\"</span><span class=\"token variable\">)</span></span>/dotnet\"</span> dnx <span class=\"token string\">\"<span class=\"token variable\">$@</span>\"</span>\n</code></pre></div> <p>So the .NET SDK exposes <a href=\"https://github.com/dotnet/sdk/blob/681138b2d3d7255a17ad6cb4812787a0d5edef99/src/Cli/dotnet/Commands/Dnx/DnxCommandParser.cs#L10\">a <code>dnx</code> command</a> which parses the arguments and options, and creates an instance of <a href=\"https://github.com/dotnet/sdk/blob/main/src/Cli/dotnet/Commands/Tool/Execute/ToolExecuteCommand.cs#L42\">the <code>ToolExecuteCommand</code></a>. This command is responsible for downloading and running the command.</p> <p>At a high level, this command does the following things:</p> <ol><li>If a version for the tool is <em>not</em> specified, try to locate the tool <a href=\"https://learn.microsoft.com/en-us/dotnet/core/tools/global-tools#install-a-local-tool\">in the local tools manifest</a>. If it's present in the manifest, run the tool from there.</li> <li>Otherwise, try to find the package to install from nuget.org.</li> <li>If the tool is not currently downloaded, ask for permission and download the tool.</li> <li>Finally, run the tool.</li></ol> <p>That's pretty much all there is to it, but I'll go into a little more detail below.</p> <p>The <code>ToolExecuteCommand</code> only considers the local tool manifest if you don't specify a version to install, otherwise it skips the step entirely. Next the command looks for a tool manifest, <em>dotnet-tools.json</em>. If it finds a manifest, and the tool being run is <em>listed</em> in the manifest, the command downloads and runs the tool without any further interaction.</p> <p>If you <em>do</em> specify a version, or if there's no manifest, or the manifest doesn't list the tool being run, then it moves onto installing the tool globally. First it searches for the package on nuget.org, or whichever sources are configured in the <em>nuget.config</em> file.</p> <p>Assuming the requested package exists, the command next checks whether it has permission to download the package. The command prompts for confirmation as we saw earlier (<code>Proceed? [y/n] (y): y</code>). Interestingly, this prompt is shown whether or not you're running in an interactive setting; though you can bypass the flag by passing the auto-confirm <code>--yes</code> flag.</p> <p>Once the command has confirmation, it downloads the tool and runs it. Voila!</p> <p>That's about all there is to the <code>dnx</code> command. It's a nice little quality of life bump for the .NET ecosystem, which leverages all the existing features of .NET tools to make things that little bit easier.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this short post I showed the new <code>dnx</code> command and how to use it to run .NET tools without explicitly installing them first. Next I discussed the difference between the <code>dnx</code> command and the <code>dotnet tool install</code> command. Finally I walked through the code behind the feature; the <code>ToolExecuteCommand</code> in the .NET SDK.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/",
      "Title": "Solving the source generator 'marker attribute' problem in .NET 10: Exploring the .NET 10 preview - Part 4",
      "PublishDate": "2025-07-22T10:00:00+00:00",
      "Summary": "In this post I discuss a new source generator API, AddEmbeddedAttributeDefinition(), added in .NET 10, which makes it easier to embed generated attributes",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/embeddedattribute_banner.png\" /><nav><p>This is the fourth post in the series: <a href=\"https://andrewlock.net/series/exploring-the-dotnet-10-preview/\">Exploring the .NET 10 preview</a>. </p> <ol class=\"list-none\"><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/\">Part 1 - Exploring the features of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/\">Part 2 - Behind the scenes of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/\">Part 3 - C# 14 extension members; AKA extension everything</a></li><li>Part 4 - Solving the source generator 'marker attribute' problem in .NET 10 (this post) </li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/\">Part 5 - Running one-off .NET tools with dnx</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/\">Part 6 - Passkey support for ASP.NET Core identity</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">Part 7 - Packaging self-contained and native AOT .NET tools for NuGet</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/\">Part 8 - Supporting platform-specific .NET tools on old .NET SDKs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/\">Part 9 - Easier reflection with [UnsafeAccessorType] in .NET 10</a></li></ol></nav><p>In this post I discuss the addition of a new API for source generators included in version 4.14 of the Roslyn compiler (included as part of the .NET 10 SDK). This provides a simple solution to an otherwise annoying problem associated with the \"marker attributes\" that often drive source generator behaviours. In this post I describe the problem and recap the existing solution which is available in previous SDKs. Next I describe the new API and show how you can use it. Finally, I discuss the trade-offs between the new API and the existing solution, and when you should choose each option.</p> <blockquote> <p>This post was written using the features available in .NET 10 preview 5. Many things may change between now and the final release of .NET 10.</p> </blockquote> <h2 id=\"background-marker-attributes-and-source-generators\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/#background-marker-attributes-and-source-generators\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Background: Marker attributes and source generators</a></h2> <p>Incremental source generators have been around for several years now, and the runtime includes many built-in generators, so I expect most people are familiar with <em>using</em> source generators, even if they're not familiar with <em>building</em> them. As such, you're likely familiar with the trigger for many source generators being the addition of an attribute of some kind.</p> <p>For example, <a href=\"https://andrewlock.net/exploring-dotnet-6-part-8-improving-logging-performance-with-source-generators/#the-net-6-loggermessage-source-generator\">the <code>LoggerMessage</code> source generator</a> that is part of the <em>Microsoft.Extensions.Logging</em> library in .NET 6 uses a <code>[LoggerMessage]</code> attribute to define the code that will be generated:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span>Logging</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestController</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 👇 Adding the attribute here generates code for LogHelloWorld</span>\n    <span class=\"token punctuation\">[</span><span class=\"token function\">LoggerMessage</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> LogLevel<span class=\"token punctuation\">.</span>Information<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Writing hello world response to {Person}\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">partial</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">LogHelloWorld</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Person</span> person<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>Similarly in my <a href=\"https://github.com/andrewlock/NetEscapades.EnumGenerators\">NetEscapades.EnumGenerators</a> library, you add the <code>[EnumExtensions]</code> attribute to an <code>enum</code> to generate a class of handy extension methods:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">EnumExtensions</span></span><span class=\"token punctuation\">]</span> <span class=\"token comment\">// 👈 Add this to generate `ColorExtensions`</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">Color</span>\n<span class=\"token punctuation\">{</span>\n    Red <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    Blue <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>In both of these cases, the attribute itself is only a marker, used at compile-time, to tell the source generator what to generate. But where does that attribute <em>come from</em>?</p> <p>A pattern that is <em>very</em> commonly used in examples (both from Microsoft and from the community) is to use a source generator API called <code>RegisterPostInitializationOutput()</code>. This hook is seemingly <em>tailor made</em> for adding marker attributes to the user's compilation, which you can then use later in the generator. In fact, this scenario <a href=\"https://github.com/dotnet/roslyn/blob/NET-SDK-9.0.100/docs/features/incremental-generators.cookbook.md#augment-user-codeode\">is explicitly called out in the source generator cook book</a> as \"the way\" to work with marker attributes:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Generator</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HelloWorldGenerator</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IIncrementalGenerator</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Initialize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IncrementalGeneratorInitializationContext</span> context<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        context\n            <span class=\"token punctuation\">.</span><span class=\"token function\">RegisterPostInitializationOutput</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">=&gt;</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// Add the source code to the user's compilation</span>\n                i<span class=\"token punctuation\">.</span><span class=\"token function\">AddSource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MyExampleAttribute.g.cs\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">@\"\n                namespace HelloWorld\n                {\n                    internal class MyExampleAttribute: global::System.Attribute {} \n                }\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// ... generator implementaation</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>And <em>most</em> of the time, this works great. Right up until it doesn't…</p> <p>The <code>[MyExample]</code> attribute is added as an <code>internal</code> attribute, so it's theoretically not exposed outside of the project that the source generator is added to. <em>However</em>, there's a common scenario where this <em>does</em> become a problem:</p> <ul><li>The source generator adds an attribute using <code>RegisterPostInitializationOutput</code> as above.</li> <li>The source generator is added to <em>multiple</em> projects in a solution.</li> <li>One project using the generator references a different project that uses the generator.</li> <li>You're using <code>[InternalsVisibleTo]</code> in the referenced project.</li></ul> <p>In this scenario you'll get a <code>CS0436</code> warning, and a build warning along the lines of:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">warning CS0436: The <span class=\"token builtin class-name\">type</span> <span class=\"token string\">'MyExampleAttribute'</span> <span class=\"token keyword\">in</span> <span class=\"token string\">'HelloWorldGenerator\\MyExampleAttribute.g.cs'</span> conflicts with the imported <span class=\"token builtin class-name\">type</span> <span class=\"token string\">'MyExampleAttribute'</span> <span class=\"token keyword\">in</span> <span class=\"token string\">'MyProject, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null'</span><span class=\"token builtin class-name\">.</span>\n</code></pre></div> <p>The problem is that we've defined the same type with the same namespace in two different projects, and the compiler can't distinguish between them. Now <em>technically</em> this is only a warning, but ignoring them is a pain, and it's all a bit messy generally.</p> <p>Ultimately, adding code using <code>RegisterPostInitializationOutput()</code> is just not as neat as it seems, and there are better options.</p> <h2 id=\"solving-the-duplicate-attribute-problem-with-a-shared-dll\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/#solving-the-duplicate-attribute-problem-with-a-shared-dll\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Solving the duplicate attribute problem with a shared dll</a></h2> <p>I first wrote about the \"marker attribute\" problem for source generators <a href=\"https://andrewlock.net/creating-a-source-generator-part-7-solving-the-source-generator-marker-attribute-problem-part1/\">back in 2022</a>, when I was wrestling with the problem myself. In that post (<a href=\"https://andrewlock.net/creating-a-source-generator-part-8-solving-the-source-generator-marker-attribute-problem-part2/\">and the subsequent post</a>) I described the problem and several potential solutions. Ultimately I settled on an approach for handling marker attributes (which has separately become the general suggested approach) which is to include the attributes in a separate shared dll in the NuGet package.</p> <p>For example, the <code>LoggerMessage</code> generator is part of the <em>Microsoft.Extensions.Logging.Abstractions</em> library. It is packaged in the same NuGet package that people will install anyway, and the marker attributes are contained in the referenced dll, so they will always be there.</p> <p><img src=\"https://andrewlock.net/content/images/2021/attributes_01.png\" alt=\"The contents of the Microsoft.Extensions.Logging.Abstractions package contains both the dll and the analyzer\"></p> <p>Simlarly, my <a href=\"https://www.nuget.org/packages/NetEscapades.EnumGenerators/1.0.0-beta14\">NetEscapades.EnumGenerators</a> package includes the <em>NetEscapades.EnumGenerators.Attributes.dll</em> packaged separately from the generator dll <em>NetEscapades.EnumGenerators.dll</em>, and is actually referenced by the target project.</p> <p><img src=\"https://andrewlock.net/content/images/2025/embeddedattribute.png\" alt=\"The contents of the NetEscapades.EnumGenerators package contains the NetEscapades.EnumGenerators.Attributes dll in the lib sub-folder\"></p> <p>The advantage of this approach is that when you reference the package in multiple projects, they're <em>all</em> referencing the same type; in this case the <code>[EnumExtensions]</code> attribute in <em>NetEscapades.EnumGenerators.Attributes.dll</em>. We're not generating identical code in each target project, so there's no type conflict. Problem solved 🎉</p> <p>The big downside with this approach is that it's just more complicated to build. You need a <em>separate</em> project for the attributes dll, and you need to do some MSBuild faffing to make sure you pack the attributes dll into the <em>lib</em> folder of the NuGet package while the analyzer is packed into the <em>analyzers</em> folder.</p> <blockquote> <p>I'm not going to detail the whole process here; see <a href=\"https://andrewlock.net/creating-a-source-generator-part-8-solving-the-source-generator-marker-attribute-problem-part2/#4-pack-the-dll-into-the-generator-package\">my previous post</a> for the approach. Alternatively, see <a href=\"https://github.com/andrewlock/NetEscapades.EnumGenerators/blob/main/src/NetEscapades.EnumGenerators/NetEscapades.EnumGenerators.csproj\">the source code for NetEscapades.EnumGenerators</a> and copy-paste what you need! It's ultimately not <em>too</em> hard, just a bit of a faff😅</p> </blockquote> <p>Even though the separate attributes dll works well, it's a shame that <code>RegisterPostInitializationOutput()</code> never quite fulfilled it's design as an easy way to add code to a target project which the generator could then use. Thankfully, in .NET 10, this is finally possible!</p> <h2 id=\"how-does-roslyn-avoid-these-issues-with-the-embedded-attribute\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/#how-does-roslyn-avoid-these-issues-with-the-embedded-attribute\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">How does Roslyn avoid these issues? With the <code>[Embedded]</code> attribute</a></h2> <p>An interesting part of this story is that the compiler has had the ability to add synthesized types into the compilation for a long time. You can see this, for example, in some of the generated code of collection expressions (<a href=\"https://andrewlock.net/behind-the-scenes-of-collection-expressions-part-3-arrays-span-of-t-and-immutable-collections/#optimized-collection-expressions-for-arrays\">which I showed in a previous post</a>), which may generate types and embed them in the target dll to optimize the initialization of various collections.</p> <p>The compiler might <em>also</em> generate attributes, which it embeds in the target compilation. This isn't always necessary (the attributes are often included in the .NET base class libraries), but is particularly useful when using a newer SDK with an older target runtime; in those older runtimes, the attributes may not be available, so they're synthesised at build time.</p> <p>The interesting thing is that Roslyn essentially has the same problem that we have with our embedded generator attributes; it may need to generate the attributes in multiple projects, but it must <em>not</em> cause type collision issues. As a result, whenever it needs to emit a potentially problematic attribute, the compiler <a href=\"https://github.com/dotnet/roslyn/blob/d3571ef089ef13c74ea786dce8ef615916a097cd/src/Compilers/CSharp/Portable/Emitter/Model/PEAssemblyBuilder.cs#L391-L396\">always emits an additional attribute</a>: <code>[Embedded]</code>. Applying <code>[Embedded]</code> to a type ensures that it's not visible outside the <em>current</em> project (more accurately, the current compilation). In other words, it solves the <code>[InternalsVisibleTo]</code> problem.</p> <p>The snag is that up until now, you weren't able to add the <code>[Embedded]</code> type yourself, and you weren't able to use the automatically-synthesized version. That changed in <a href=\"https://github.com/dotnet/roslyn/pull/76523/files\">dotnet/roslyn#76523</a>, which enabled adding the attribute yourself:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">namespace</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>CodeAnalysis</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">internal</span> <span class=\"token keyword\">sealed</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EmbeddedAttribute</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">global</span><span class=\"token punctuation\">::</span>System<span class=\"token punctuation\">.</span>Attribute\n    <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The definition of this attribute is very strict, because it must match the definition that the compiler generates. Specifically:</p> <ol><li>It must be <code>internal</code></li> <li>It must be a <code>class</code></li> <li>It must be <code>sealed</code></li> <li>It must be non-<code>static</code></li> <li>It must have an <code>internal</code> or <code>public</code> parameterless constructor</li> <li>It must inherit from <code>System.Attribute</code>.</li> <li>It must be allowed on any type declaration (<code>class</code>, <code>struct</code>, <code>interface</code>, <code>enum</code>, or <code>delegate</code>)</li></ol> <p>The above example is about the simplest version that does that.</p> <h2 id=\"solving-warning-cs0436-in-source-generators-with-embedded-and-addembeddedattributedefinition-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/#solving-warning-cs0436-in-source-generators-with-embedded-and-addembeddedattributedefinition-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Solving warning <code>CS0436</code> in source generators with <code>[Embedded]</code> and <code>AddEmbeddedAttributeDefinition()</code></a></h2> <p>With the new capability to manually add <code>EmbeddedAttribute</code> to our compilation, we can revisit the marker attribute issues we were having in our source generator. The big problem we were facing was the \"leaking\" of <code>internal</code> generated attributes across projects when you use <code>[InternalsVisibleTo]</code>; <code>[Embedded]</code> provides a solution to that.</p> <p>To solve the issue, we need to:</p> <ol><li>Add the <code>EmbeddedAttribute</code> definition to our project.</li> <li>Apply the <code>[Embedded]</code> attribute to our generated marker attribute types.</li></ol> <p><em>Technically</em>, you can do the first point however you like, but <a href=\"https://github.com/dotnet/roslyn/pull/76583\">dotnet/roslyn#76583</a> introduced a convenient API, <code>AddEmbeddedAttributeDefinition()</code>, which will generate the definition for you.</p> <p>Putting those two changes together, we can update the <code>HelloWorldGenerator</code> example from earlier to solve the <code>CSO436</code> problem with the addition of just 2 lines of code:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Generator</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HelloWorldGenerator</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IIncrementalGenerator</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Initialize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IncrementalGeneratorInitializationContext</span> context<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        context\n            <span class=\"token punctuation\">.</span><span class=\"token function\">RegisterPostInitializationOutput</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">=&gt;</span>\n            <span class=\"token punctuation\">{</span>\n                i<span class=\"token punctuation\">.</span><span class=\"token function\">AddEmbeddedAttributeDefinition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 👈 Add the definition</span>\n                i<span class=\"token punctuation\">.</span><span class=\"token function\">AddSource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MyExampleAttribute.g.cs\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">@\"\n                namespace HelloWorld\n                {\n                    // 👇 Use the attribute\n                    [global::Microsoft.CodeAnalysis.EmbeddedAttribute]\n                    internal class MyExampleAttribute: global::System.Attribute {} \n                }\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// ... generator implementaation</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>With those two lines; no more <code>CSO436</code> errors due to type confusion! 🎉</p> <blockquote> <p>Note that in the example above I used the fully qualified type name for the <code>[Embedded]</code> attribute. This often isn't necessary, but can sometimes bite you if your don't, so I always do it in my generated source code.</p> </blockquote> <p>The addition of <code>[Embedded]</code> and <code>AddEmbeddedAttributeDefinition()</code> in .NET 10 nicely solve an annoying quirk of incremental source generators, so it's really nice to see the support added. However, it's not <em>all</em> sunshine and roses, and you shouldn't <em>always</em> use it.</p> <h2 id=\"should-you-use-addembeddedattributedefinition-or-a-shared-dll-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/#should-you-use-addembeddedattributedefinition-or-a-shared-dll-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Should you use <code>AddEmbeddedAttributeDefinition()</code> or a shared dll?</a></h2> <p>The <code>AddEmbeddedAttributeDefinition()</code> and <code>[Embedded]</code> attribute approach seems like a great solution, and it will likely be the go-to approach for anyone building a <em>new</em> source generator with the .NET 10 SDK. There are some caveats though.</p> <h3 id=\"are-all-your-customers-using-the-net-10-sdk-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/#are-all-your-customers-using-the-net-10-sdk-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Are all your customers using the .NET 10 SDK?</a></h3> <p>The <code>AddEmbeddedAttributeDefinition()</code> API is available in Roslyn 4.14, which corresponds to version <a href=\"https://www.nuget.org/packages/Microsoft.CodeAnalysis.CSharp/4.14.0\">4.14.0 of <em>Microsoft.CodeAnalysis.CSharp</em></a>. This is the package you will need to reference in your source generator for the API to be available.</p> <p>This isn't <em>just</em> a dependency on your side though. This version of <em>Microsoft.CodeAnalysis.CSharp</em> requires anyone <strong>installing</strong> your package to be using <em>at least</em> version 9.0.300 or .NET 10 preview 4 of the .NET SDK (both released in May 25). If they're using Visual Studio, they need to be using at least version 17.14 (i.e. the latest version at the time of writing).</p> <p>If you're ok with putting those requirements on consumers of your package, then using <code>AddEmbeddedAttributeDefinition()</code> should be your go-to approach for your marker attributes. If I was creating a new source generator, I would definitely start with this as the minimum requirement, take the easy option, and just document the requirements.</p> <p>However, if you have an <em>existing</em> generator, then you have a tricky question to answer; are you willing to make the breaking change to update <em>Microsoft.CodeAnalysis.CSharp</em>? How many of your customers are using old versions of the .NET SDK? Are you willing to force them to have to upgrade to continue to use your package? The answer to those questions will likely be different for each source generator author.</p> <h3 id=\"are-you-already-using-the-shared-dll-approach-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/#are-you-already-using-the-shared-dll-approach-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Are you already using the shared dll approach?</a></h3> <p>If you're already using the \"shared\" dll approach, then you may not have much to gain by switching to <code>AddEmbeddedAttributeDefinition()</code>. You've already done the hard work to setup the shared dll, and this approach has other potential benefits (which we'll come to shortly), so it may not be worth switching your approach. Essentially you'd be choosing to make a breaking change <em>not</em> to solve an active problem, but to make your life a bit easier. Is it worth it?🤷‍♂️</p> <p>That said, switching to <code>AddEmbeddedAttributeDefinition()</code> <em>may</em> simplify some things for you with regards to testing, as well as generally making your generator easier to understand.</p> <h3 id=\"do-you-need-any-additional-capabilities-from-having-a-shared-dll-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/#do-you-need-any-additional-capabilities-from-having-a-shared-dll-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Do you need any additional capabilities from having a shared dll?</a></h3> <p>One good thing about including a shared dll in your source generator NuGet package is that it doesn't have to <em>just</em> include attributes. This shared dll can include anything that the target project needs to reference. In some cases this may be the <em>main</em> purpose of the package, with the source generator being just a helpful addition.</p> <blockquote> <p>This is obviously the case for the <em>Microsoft.Extensions.Logging.Abstractions</em> package discussed previously. The main purpose of the package is to provide the shared abstractions; the addition of the <code>[LoggerMessage]</code> attribute and the source generator was added much later as an optimisation.</p> </blockquote> <p>Another example of this might be if the code that your source generator generates has a public API that needs to expose public types. For example, imagine that my <a href=\"https://github.com/andrewlock/NetEscapades.EnumGenerators\">NetEscapades.EnumGenerators</a> library generated code similar to the following (it doesn't😅):</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ColorExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">ToStringFast</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">Color</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TransformType</span> transform<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>transform <span class=\"token operator\">==</span> TransformType<span class=\"token punctuation\">.</span>LowerInvariant<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">value</span> <span class=\"token keyword\">switch</span>\n            <span class=\"token punctuation\">{</span>\n                Color<span class=\"token punctuation\">.</span>Red <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"red\"</span><span class=\"token punctuation\">,</span>\n                Color<span class=\"token punctuation\">.</span>Blue <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"blue\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">value</span> <span class=\"token keyword\">switch</span>\n        <span class=\"token punctuation\">{</span>\n            Color<span class=\"token punctuation\">.</span>Red <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"Red\"</span><span class=\"token punctuation\">,</span>\n            Color<span class=\"token punctuation\">.</span>Blue <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"Blue\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>That <code>TransformType</code> enum is part of the public API of the <code>ColorExtensions</code> class. The <code>ToStringFast()</code> method above might be called from a <em>different</em> project to the one that generates it, so we need the <code>TransformType</code> enum to <em>also</em> be available in that project.</p> <p>We <em>could</em> generate the <code>TransformType</code> at the same time in the assembly containing <code>ColorExtensions</code>, but then if we use the source generator in another project we'd generate the same type there <em>too</em>. We could try workarounds by using different namespaces, but it's all a bit messy.</p> <p>An important thing to note is that we <em>can't</em> generate the <code>TransformType</code> and apply <code>[Embedded]</code> to it. If we did that, we wouldn't be able to reference <code>ToStringFast</code> outside the project that it's defined. Which means we wouldn't be able to call <code>ToStringFast</code> from a different project, because we can't create a <code>TransformType</code> to pass in!</p> <p>The easiest solution is to include the <code>TransformType</code> in the shared dll. And if you're doing that, then maybe it's just as easy to include the attributes in there too? That gives you all the same benefits, without the stringent .NET 10 SDK requirements.</p> <p>That said, if you're willing to accept the SDK requirement, you can certainly take both approaches. You can generate your marker attributes and add <code>[Embedded]</code> to them, and only include additional helper types in your shared dll.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I discussed the \"marker attribute\" problem for source generators. I described the problem of <code>CS0436</code> errors that you can get if you generate the marker attributes with your source generator (as is often shown in tutorials, because it's simple). I then showed the pre-.NET 10 approach to solving the problem by using a shared dll. Next I discussed how the Roslyn compiler solves a similar problem using the <code>[Embedded]</code> attribute. I then explained that this capability is now available to source generator authors too, along with the <code>AddEmbeddedAttributeDefinition()</code> API to make generating the API simple. Finally I discussed the pros and cons of using the <code>AddEmbeddedAttributeDefinition()</code> approach over a shared dll.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/",
      "Title": "C# 14 extension members; AKA extension everything: Exploring the .NET 10 preview - Part 3",
      "PublishDate": "2025-07-15T10:00:00+00:00",
      "Summary": "In this post I look at the C#14 extension members feature. I show how to convert extension methods to the new syntax and how to add new types of extension.",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/extension_everything_banner.webp\" /><nav><p>This is the third post in the series: <a href=\"https://andrewlock.net/series/exploring-the-dotnet-10-preview/\">Exploring the .NET 10 preview</a>. </p> <ol class=\"list-none\"><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/\">Part 1 - Exploring the features of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/\">Part 2 - Behind the scenes of dotnet run app.cs</a></li><li>Part 3 - C# 14 extension members; AKA extension everything (this post) </li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/\">Part 4 - Solving the source generator 'marker attribute' problem in .NET 10</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/\">Part 5 - Running one-off .NET tools with dnx</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/\">Part 6 - Passkey support for ASP.NET Core identity</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">Part 7 - Packaging self-contained and native AOT .NET tools for NuGet</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/\">Part 8 - Supporting platform-specific .NET tools on old .NET SDKs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/\">Part 9 - Easier reflection with [UnsafeAccessorType] in .NET 10</a></li></ol></nav><p>In this post I take a short look at the C#14 <em>extension members</em> feature which is available in the latest .NET 10 previews. In this post I describe what the feature is, how it extends the existing capabilities of extension methods, and how to create extension members in .NET 10. Finally, I show how I added support for the feature in the latest version of my <a href=\"https://github.com/andrewlock/NetEscapades.EnumGenerators\">NetEscapades.EnumGenerators</a> NuGet package.</p> <blockquote> <p>This post was written using the features available in .NET 10 preview 5. Many things may change between now and the final release of .NET 10.</p> </blockquote> <h2 id=\"background-extension-methods\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/#background-extension-methods\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Background: Extension methods</a></h2> <p>Extension methods were introduced <em>way</em> back in 2007 with .NET Framework 3.5 as a supporting feature for <a href=\"https://learn.microsoft.com/en-us/dotnet/csharp/linq/\">LINQ</a>. They provided a way to emulate adding an instance method to a type, by writing a <code>static</code> method. For example, you could add an extension method to <code>IEnumerable</code> called <code>IsEmpty()</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EnumerableExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token generic-method\"><span class=\"token function\">IsEmpty</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">IEnumerable<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span> target<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">=&gt;</span> <span class=\"token operator\">!</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">Any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The extension method is pretty much just an \"ordinary\" extension method. You can call it the same way you would call any other <code>static</code> method in a class if you like:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> values <span class=\"token operator\">=</span> Enumerable<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Empty</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>EnumerableExtensions<span class=\"token punctuation\">.</span><span class=\"token function\">IsEmpty</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Calling the extension method using the type</span>\n<span class=\"token punctuation\">{</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Enumerable is empty\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>However, the <code>this</code> modifier on the first argument indicates that the method can <em>also</em> be called as an instance method, on the <em>receiver</em> type, <code>IEnumerable&lt;T&gt;</code>. This is the typical way to call extension methods and results in terser code overall:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> values <span class=\"token operator\">=</span> Enumerable<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Empty</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">.</span><span class=\"token function\">IsEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Invoking as an extension method</span>\n<span class=\"token punctuation\">{</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Enumerable is empty\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The instance method approach is generally used everywhere possible, and the static invocation is only used where disambiguation is required due to naming clashes. Today, extension methods are used in a diverse range of scenarios and use many different patterns, but you will find them all over most code bases; including in the .NET runtime itself.</p> <h2 id=\"extension-members-and-extension-everything\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/#extension-members-and-extension-everything\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Extension members and extension everything</a></h2> <p>Shortly after extension methods were introduced, way back in C# 3.0, there were requests to allow additional extension members. \"Instance\" extension methods were great, but why not extension properties? Why not <em>static</em> extension methods?</p> <p>Well apparently, for C# 4.0, an attempt to design the \"extension everything\" feature was explored, but ultimately failed. Periodically <a href=\"https://github.com/dotnet/csharplang/blob/90ed288e3c4871b1d19862a418bced7dafa12721/meetings/2016/LDM-2016-05-10.md\">new efforts to try to reimagine extension everything</a> would flare up, but ultimately they came to nothing. Until now.🎉 In C# 14.0, finally, extension everything is essentially here, under the name <em>extension members</em>.</p> <p>Before we look at how to define extension members, a word of warning. The extension members feature introduces some new syntax, which can often be controversial. You may well think it's ugly, and to be honest, I probably wouldn't disagree with you. Ultimately, the C# design team opted to optimize the experience of <em>using</em> the extension members over brevity of the syntax used to <em>author</em> extension members, which I think makes sense.</p> <blockquote> <p>The <a href=\"https://devblogs.microsoft.com/dotnet/csharp-exploring-extension-members/\">blog post announcing extension members in .NET 10 preview 3</a> is great and covers a lot of the design decisions about the current feature, so I encourage you to check it out after this post, if you haven't already!</p> </blockquote> <p>We'll start by looking at how to convert an existing extension method to use the new extension member syntax as a way of introducing the changes.</p> <h3 id=\"converting-an-extension-method-to-an-extension-member\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/#converting-an-extension-method-to-an-extension-member\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Converting an extension method to an extension member</a></h3> <p>Before I show some code, it's important to know that you <em>don't</em> have to convert your extension methods over to the new syntax; the new syntax is entirely optional. Your existing extension methods will continue to work with the old <code>this</code> syntax without any changes:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EnumerableExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// The \"old\" extension member syntax still works in .NET 10 and C#14</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token generic-method\"><span class=\"token function\">IsEmpty</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">IEnumerable<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span> target<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">=&gt;</span> <span class=\"token operator\">!</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">Any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>If you wish to explore the new syntax, then you need to make sure you're using C#14 in your project. While .NET 10 is still in preview, that means you need to set the <code>&lt;LangVersion&gt;</code> property to <code>preview</code>, <em>even if you're using the .NET 10 SDK and targeting</em> <code>net10.0</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>Exe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token comment\">&lt;!-- 👇 You can set any target framework as long as you're using the .NET 10 SDK...--&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net10.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token comment\">&lt;!-- ... but you must set this 👇--&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>preview<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>If you wish to convert your method to the new extension member syntax, you need to do four things:</p> <ol><li>Add an <code>extension(){ }</code> block around your method.</li> <li>Move the receiver parameter, <code>IEnumerable&lt;T&gt; target</code> in this case, as a \"parameter\" to the <code>extension</code> block.</li> <li>Move the generic type arguments, <code>T</code> in this case, from the method to the <code>extension</code> block.</li> <li>Remove the <code>static</code> modifier from the method to make it an instance method.</li></ol> <blockquote> <p>Note that not <em>all</em> extension methods can be converted to the new syntax, as described <a href=\"https://devblogs.microsoft.com/dotnet/csharp-exploring-extension-members/\">in this post</a>.</p> </blockquote> <p>Putting that all together, the new extension member implementation looks like the following:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EnumerableExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token generic-method\"><span class=\"token function\">extension</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IEnumerable<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span> target<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">IsEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token operator\">!</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">Any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>which makes all the changes I described above:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EnumerableExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 👇 extension block with type parameters and receiver parameter</span>\n    <span class=\"token generic-method\"><span class=\"token function\">extension</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IEnumerable<span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">&gt;</span></span> target<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//   👇 no static modifier</span>\n        <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">IsEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token operator\">!</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">Any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//                 👆 'this' receiver parameter  removed</span>\n\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The <code>extension</code> block is the key to the new syntax, and is likely where developer \"feelings\" are going to come out i.e. how much do you dislike this new unusual syntax and the extra nesting it requires 😅. Of course, there's very good reason for this syntax, and we'll explore that more in the next section, but there's some aspects which are clearly quite nice about it. For example, a nice side-effect is that the instance extension method now looks more like it does when it's <em>invoked</em>; i.e. its a zero-parameter instance method instead of a one parameter static method.</p> <p>One downside of the very new syntax, is that it confuses any tooling that isn't aware of it 😅 I haven't installed <a href=\"https://www.jetbrains.com/rider/nextversion/\">the Rider EAP</a> yet to see if it handles this syntax, but I don't think it does yet. Visual Studio preview does support the syntax however, and even includes a code fix to automatically convert to the new syntax if you wish:</p> <p><img src=\"https://andrewlock.net/content/images/2025/extension_everything.png\" alt=\"Visual Studio provides a code fix to convert to extension members\"></p> <p>There's no particularly compelling reason to convert extension methods to the extension member syntax if you're not doing anything else. It's purely a syntactic difference; they both compile to the exact same thing. The more interesting case is if you want to use other <em>types</em> of extension member.</p> <h3 id=\"adding-other-extension-members\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/#adding-other-extension-members\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Adding other extension members</a></h3> <p>We've seen the new syntax, but we haven't seen any new <em>features</em> yet. However, the extension members feature that shipped in .NET 10 preview 3 adds support for three new <em>types</em> of extension member</p> <ul><li>Static extension methods</li> <li>Static extension properties</li> <li>Instance extension properties</li></ul> <p>Additionally, extension operators have already been implemented and should be available in .NET 10 preview 7.</p> <p>I'll start with static extension methods, because they're the most interesting to me. <em>Implementation</em> wise, the syntax looks very similar to the instance extension method syntax we've already seen, with two minor differences:</p> <ol><li>The method should be <code>static</code></li> <li>You don't need to specify a name for the receiver parameter (and even if you add it, it can't be accessed from the <code>static</code> method you define)</li></ol> <p>Let's look at an example. The following creates a static method on <code>string</code> called <code>HasValue()</code> which is the inverse of <code>string.IsNullOrEmpty</code></p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StringExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 👇 Extension block specifies receiver type but doesn't specify a parameter name</span>\n    <span class=\"token function\">extension</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//    👇 static extension method</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">HasValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">=&gt;</span> <span class=\"token operator\">!</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsNullOrEmpty</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The following shows an example of its use:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> someValue <span class=\"token operator\">=</span> <span class=\"token string\">\"something\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">HasValue</span><span class=\"token punctuation\">(</span>someValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"The value was: \"</span> <span class=\"token operator\">+</span> someValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The revelation here, and the difference from instance extension methods, is that the extension method is added to the <code>string</code> <em>type</em>, not the <code>someValue</code> <em>variable</em>.</p> <p>Next, we'll look at an extension property. The following adds an <code>IsAscii</code> instance extension property to string:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StringExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 👇 Extension block specifies receiver type and target parameter</span>\n    <span class=\"token function\">extension</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> target<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 👇 You can just write the property like you'd write a \"normal\" property</span>\n        <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> IsAscii\n            <span class=\"token operator\">=&gt;</span> target<span class=\"token punctuation\">.</span><span class=\"token function\">All</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=&gt;</span> <span class=\"token keyword\">char</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsAscii</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//    👆 You can access the receive paramter because it's an instance extension</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>You can then use the property on <code>string</code> instances, just as you would for an instance extension method</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> someValue <span class=\"token operator\">=</span> <span class=\"token string\">\"something\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> isAscii <span class=\"token operator\">=</span> someValue<span class=\"token punctuation\">.</span>IsAscii<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 👈 Access the instance extension property on a variable</span>\n</code></pre></div> <p>Defining a static extension property is very similar, so for the sake of brevity I'll leave that for now. As a brief bonus treat, here's what a static operator definition might look like:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PathExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token function\">extension</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">string</span> <span class=\"token keyword\">operator</span> <span class=\"token operator\">/</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> left<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> right<span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">=&gt;</span> Path<span class=\"token punctuation\">.</span><span class=\"token function\">Combine</span><span class=\"token punctuation\">(</span>left<span class=\"token punctuation\">,</span> right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>This could then be used something like the following:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> fullPath <span class=\"token operator\">=</span> <span class=\"token string\">\"part1\"</span> <span class=\"token operator\">/</span> <span class=\"token string\">\"part2\"</span> <span class=\"token operator\">/</span> <span class=\"token string\">\"test.txt\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"part1/part2/test.txt\"</span>\n</code></pre></div> <p>So hold on for .NET 10 preview 7 for that!</p> <h3 id=\"disambiguating-extension-members\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/#disambiguating-extension-members\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Disambiguating extension members</a></h3> <p>Before we move on, it's worth addressing the disambiguation story. Sometimes you may need to invoke the extension methods directly, typically due to clashes between multiple extension methods with the same signature. This has always been the way to handle the ambiguity for extension methods, and it's essentially the same for other extension members.</p> <ul><li>For instance extension methods, you invoke statically and pass the instance as the first parameter.</li> <li>For static extension methods, you invoke as a simple zero parameter <code>static</code> method.</li> <li>For instance extension properties, you call the <code>get_</code> prefixed method, and pass the instance as the first parameter.</li> <li>For static extension methods, you call the <code>get_</code> prefixed method.</li></ul> <p>For example, for the extensions shown so far we might invoke them directly like this</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> hasValue <span class=\"token operator\">=</span> EnumerableExtensions<span class=\"token punctuation\">.</span><span class=\"token function\">IsEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// An instance extension method</span>\n<span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> hasValue <span class=\"token operator\">=</span> StringExtensions<span class=\"token punctuation\">.</span><span class=\"token function\">HasValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"something\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// A static extension method</span>\n<span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> isAscii <span class=\"token operator\">=</span> StringExtensions<span class=\"token punctuation\">.</span><span class=\"token function\">get_IsAscii</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"something\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// An instance extension property</span>\n</code></pre></div> <p>The <code>get_</code> prefix for the property might seem strange given normal C# naming, but it's actually how properties are <em>normally</em> implemented behind the scenes in C#. Indeed if you looks at the assembly metadata in a .NET dll using a tool such as <a href=\"https://www.jetbrains.com/decompiler/\">dotPeek</a>, then you'll see that properties really <em>are</em> implemented as methods with <code>get_</code> and <code>set_</code> prefixes:</p> <p><img src=\"https://andrewlock.net/content/images/2025/extension_everything_2.png\" alt=\"Looking at the metadata in a dll\"></p> <p>The screenshot above shows that once compiled, the <code>StringExtensions.IsAscii</code> extension property has a very similar implementation to \"normal\" properties like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SomeClass</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Value <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>That pretty much covers everything for this post, so I'll finish with a quick update on my <a href=\"https://github.com/andrewlock/NetEscapades.EnumGenerators\">NetEscapades.EnumGenerators</a> NuGet package.</p> <h2 id=\"a-case-study-netescapades-enumgenerators\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/#a-case-study-netescapades-enumgenerators\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">A case study: NetEscapades.EnumGenerators</a></h2> <p>The <a href=\"https://github.com/andrewlock/NetEscapades.EnumGenerators\">NetEscapades.EnumGenerators</a> NuGet package lets you generate extension methods and helpers for enums, to allow fast \"reflection\". You use it by adding the <code>[EnumExtensions]</code> attribute to an enum:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">EnumExtensions</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">MyColours</span>\n<span class=\"token punctuation\">{</span>\n    Red<span class=\"token punctuation\">,</span>\n    Green<span class=\"token punctuation\">,</span>\n    Blue<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>and by default the package generates a class called <code>MyColoursExtensions</code> similar to the following:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyColoursExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">ToStringFast</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token keyword\">global</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">MyColours</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> <span class=\"token function\">AsUnderlyingType</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token keyword\">global</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">MyColours</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">IsDefined</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">global</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">MyColours</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">global</span><span class=\"token punctuation\">::</span><span class=\"token return-type class-name\">MyColours</span> <span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">?</span></span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>I've only shown a couple of the methods above but as you can see, there's basically two different types of method:</p> <ul><li>Extension methods like <code>ToStringFast()</code> and <code>AsUnderlyingType()</code></li> <li>Static methods like <code>IsDefined()</code> and <code>Parse()</code></li></ul> <p>Until now, you always had to call the static methods using the <code>MyColoursExtensions</code> type, e.g.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> colour <span class=\"token operator\">=</span> MyColoursExtensions<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Red\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>But if you're targeting C#14, the package simply adds an extension block around these members:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">partial</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyColoursExtensions</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">ToStringFast</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token keyword\">global</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">MyColours</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> <span class=\"token function\">AsUnderlyingType</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token keyword\">global</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">MyColours</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 👇 Added if you target C#14</span>\n    <span class=\"token function\">extension</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">global</span><span class=\"token punctuation\">::</span>MyColours<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">IsDefined</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">global</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">MyColours</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">global</span><span class=\"token punctuation\">::</span><span class=\"token return-type class-name\">MyColours</span> <span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">?</span></span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>and now those static extension members are available on the <code>MyColours</code> enum type itself:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> colour <span class=\"token operator\">=</span> MyColours<span class=\"token punctuation\">.</span><span class=\"token function\">Parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Red\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>which just feels much nicer to me! Anyway, the fact that it was frankly a trivial change to convert these static methods into extension methods was a real bonus, and definitely gives me renewed confidence that even if the new syntax looks a bit janky at first glance, it's clearly well thought out.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I described the new extension members feature coming in C#14 and .NET 10. I started by providing some background on extension methods in case you haven't seem then before, and then showed how you could convert these to use the new extension member syntax. I then showed how you could add the new extension member types: static extension methods, static and instance extension properties, and extension operators (coming in .NET 10 preview 7). Finally, I described how adding support for C#14 in the latest version of the <a href=\"https://github.com/andrewlock/NetEscapades.EnumGenerators\">NetEscapades.EnumGenerators</a> NuGet package makes for a better experience using the extensions.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/",
      "Title": "Behind the scenes of dotnet run app.cs: Exploring the .NET 10 preview - Part 2",
      "PublishDate": "2025-07-08T10:00:00+00:00",
      "Summary": "In this post I looks at how the new single-file .NET run experience is implemented inside the .NET SDK, focusing on how the virtual-project file is built",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/single-file-dotnet-2.webp\" /><nav><p>This is the second post in the series: <a href=\"https://andrewlock.net/series/exploring-the-dotnet-10-preview/\">Exploring the .NET 10 preview</a>. </p> <ol class=\"list-none\"><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/\">Part 1 - Exploring the features of dotnet run app.cs</a></li><li>Part 2 - Behind the scenes of dotnet run app.cs (this post) </li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/\">Part 3 - C# 14 extension members; AKA extension everything</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/\">Part 4 - Solving the source generator 'marker attribute' problem in .NET 10</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/\">Part 5 - Running one-off .NET tools with dnx</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/\">Part 6 - Passkey support for ASP.NET Core identity</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">Part 7 - Packaging self-contained and native AOT .NET tools for NuGet</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/\">Part 8 - Supporting platform-specific .NET tools on old .NET SDKs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/\">Part 9 - Easier reflection with [UnsafeAccessorType] in .NET 10</a></li></ol></nav><p>In the <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/\">previous post</a>, I described the new feature coming in .NET 10 for building and running a single C# file <em>without</em> needing to first create a <em>.csproj</em> project. In that post I described the various features currently implemented, what's coming soon, and the vision for the feature.</p> <p>In this post, I look behind the scenes to see <em>how</em> the feature is implemented. I'm looking at the code at a point of time, so no doubt things will change, potentially a <em>lot</em>, before the final release with .NET 10. But I still think there's value in the looking at how it works <em>in general</em>, so you have a mental model for how the feature works, the limitations, and various edge cases you may run into.</p> <p>As way of an introduction, we'll briefly take a look at the <code>dotnet run app.cs</code> experience, and then we'll dig into the code later.</p> <h2 id=\"what-is-dotnet-run-app-cs-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#what-is-dotnet-run-app-cs-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What is <code>dotnet run app.cs</code>?</a></h2> <p>Prior to .NET 10, a \"hello world\" C# application required at least 2 files:</p> <ul><li>A <em>.csproj</em> project file</li> <li>A <em>.cs</em> file containing <a href=\"https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/program-structure/top-level-statements\">top-level statements</a></li></ul> <p>Now .NET 10 includes <a href=\"https://devblogs.microsoft.com/dotnet/announcing-dotnet-run-app/\">preview support</a> for removing the need for the <em>.csproj</em> file too. Finally, a .NET application <em>only</em> needs a single <em>.cs</em> file. The hello-world C# program now becomes:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello, world\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Save that to a file, <em>app.cs</em> for example, and you can run your application with <code>dotnet run app.cs</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dotnet run app.cs\nHello, world\n</code></pre></div> <p>Alternatively, a more complex example that demonstrates many of the features available in .NET 10 preview 5 might look like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token preprocessor property\">#!/usr/bin/dotnet run</span>\n\n<span class=\"token preprocessor property\">#:sdk Microsoft.NET.Sdk.Web</span>\n<span class=\"token preprocessor property\">#:package Newtonsoft.Json@13.0.3</span>\n<span class=\"token preprocessor property\">#:property UserSecretsId 2eec9746-c21a-4933-90af-c22431f35459</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> WebApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> app <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">MapGet</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> JsonConvert<span class=\"token punctuation\">.</span><span class=\"token function\">SerializeObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token punctuation\">{</span> Greeting <span class=\"token operator\">=</span> <span class=\"token string\">\"Hello, World!\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>This shows the <code>#:</code> directives currently available, as well as the shebang. Next we'll look into the code behind these features.</p> <h2 id=\"how-does-it-work-behind-the-scenes-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#how-does-it-work-behind-the-scenes-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">How does it work behind the scenes?</a></h2> <p>Many of <a href=\"https://github.com/oleg-shilo/cs-script/wiki/CS-Script-Overview\">the</a> <a href=\"https://github.com/dotnet-script/dotnet-script\">previous</a> <a href=\"https://cakebuild.net/\">single-file</a> or <a href=\"https://learn.microsoft.com/en-us/archive/msdn-magazine/2016/january/essential-net-csharp-scripting#the-c-repl-command-line-interface-csiexe\">REPL</a> experiences for C# and .NET used subtly different \"dialects\" of C#. Each of those tools used slightly different approaches and worked in different ways, which was similarly different to the \"full\" C# experience.</p> <p>The <code>dotnet run app.cs</code> approach is to create a \"virtual\" <em>.csproj</em> file, and otherwise aim to fallback to the \"full\" <code>dotnet build</code> experience that you get with a \"traditional\" .NET project using a <em>.csproj</em> file. The advantage of this approach is that you can pretty much do anything you would do with a \"normal\" project in the single-file case. It also means there's always a direct route to converting the single-file into a project; it's essentially just whatever the <em>virtual</em> project looks like.</p> <p>So what happens when you call <code>dotnet run app.cs</code>? At a high level, the CLI takes the following steps:</p> <ul><li>Determine if the provided path, <code>app.cs</code>, is <a href=\"https://github.com/dotnet/sdk/blob/87febc1daa96f146653611ace6f5e8c39af41722/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L920\">a valid single-file program</a>.</li> <li>If it is, create <a href=\"https://github.com/dotnet/sdk/blob/87febc1daa96f146653611ace6f5e8c39af41722/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L30\">a <code>VirtualProjectBuildingCommand</code></a>, and execute it.</li> <li><a href=\"https://github.com/dotnet/sdk/blob/87febc1daa96f146653611ace6f5e8c39af41722/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L273\">Calculate a cache object</a>, to determine whether the project needs to be rebuilt.</li> <li>If it does, parse the file, <a href=\"https://github.com/dotnet/sdk/blob/87febc1daa96f146653611ace6f5e8c39af41722/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L757\">extracting all the directives</a>.</li> <li>Use the directives to <a href=\"https://github.com/dotnet/sdk/blob/87febc1daa96f146653611ace6f5e8c39af41722/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L506\">create an in-memory string version</a> of a <em>.csproj</em> project file</li> <li>Use MSBuild to do a <code>Restore</code> and <code>Build</code> with the provided virtual project file</li> <li>Run the built command</li></ul> <p>For the rest of the post we'll be looking at these steps in order.</p> <h3 id=\"identifying-candidate-single-file-programs\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#identifying-candidate-single-file-programs\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Identifying candidate single-file programs</a></h3> <p>The <code>dotnet</code> SDK uses System.CommandLine to parse the provided arguments, and tries to find the project or single-file to execute <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/RunCommand.cs#L449\">by calling <code>DiscoverProjectFilePath</code></a>. This method first tries to find a corresponding project file, but if one isn't provided (and you're not <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#running-c-directly-from-stdin-code\">reading from stdin</a>), then the <code>RunCommand</code> checks if the provided argument is a valid entry point for the single-file program by calling <code>VirtualProjectBuildingComman.IsValidEntryPointPath()</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">IsValidEntryPointPath</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> entryPointFilePath<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>File<span class=\"token punctuation\">.</span><span class=\"token function\">Exists</span><span class=\"token punctuation\">(</span>entryPointFilePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entryPointFilePath<span class=\"token punctuation\">.</span><span class=\"token function\">EndsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".cs\"</span><span class=\"token punctuation\">,</span> StringComparison<span class=\"token punctuation\">.</span>OrdinalIgnoreCase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Check if the first two characters are #!</span>\n    <span class=\"token keyword\">try</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> stream <span class=\"token operator\">=</span> File<span class=\"token punctuation\">.</span><span class=\"token function\">OpenRead</span><span class=\"token punctuation\">(</span>entryPointFilePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> first <span class=\"token operator\">=</span> stream<span class=\"token punctuation\">.</span><span class=\"token function\">ReadByte</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> second <span class=\"token operator\">=</span> stream<span class=\"token punctuation\">.</span><span class=\"token function\">ReadByte</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> first <span class=\"token operator\">==</span> <span class=\"token char\">'#'</span> <span class=\"token operator\">&amp;&amp;</span> second <span class=\"token operator\">==</span> <span class=\"token char\">'!'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">catch</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>Hopefully the logic here makes sense: if the file exists and it either ends with <code>.cs</code> <em>or</em> the first two characters of the file are <code>#!</code>, then the file is considered a valid entry point for a single-file program.</p> <p>If you <em>are</em> reading from stdin, then you pass the argument <code>-</code> to <code>dotnet run</code>, e.g.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token operator\">&gt;</span> 'Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello, World!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>' <span class=\"token operator\">|</span> dotnet run <span class=\"token operator\">-</span>\nHello<span class=\"token punctuation\">,</span> World<span class=\"token operator\">!</span>\n</code></pre></div> <p>This is identified in <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/RunCommand.cs#L566-L572\">the <code>RunCommand.ParseResult()</code></a> method, which writes the input to a temporary file:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// If '-' is specified as the input file, read all text from stdin into a temporary file and use that as the entry point.</span>\nentryPointFilePath <span class=\"token operator\">=</span> Path<span class=\"token punctuation\">.</span><span class=\"token function\">GetTempFileName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> stdinStream <span class=\"token operator\">=</span> Console<span class=\"token punctuation\">.</span><span class=\"token function\">OpenStandardInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> fileStream <span class=\"token operator\">=</span> File<span class=\"token punctuation\">.</span><span class=\"token function\">OpenWrite</span><span class=\"token punctuation\">(</span>entryPointFilePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    stdinStream<span class=\"token punctuation\">.</span><span class=\"token function\">CopyTo</span><span class=\"token punctuation\">(</span>fileStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>After all this parsing is complete, a new <code>RunCommand</code> is created, passing in the path to the single-file.</p> <h3 id=\"checking-for-previous-builds\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#checking-for-previous-builds\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Checking for previous builds</a></h3> <p>As part of the <code>RunCommand.Execute()</code> method, a new <code>VirtualProjectBuildingCommand</code> <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/RunCommand.cs#L286\">is created</a> and <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/RunCommand.cs#L265\">executed</a>. The first step is running <code>NeedsToBuild()</code> to check whether a new build actually needs to be started, or whether a cached build result can be reused.</p> <p>The <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L298\"><code>NeedsToBuild</code></a> method starts by <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L273-L296\">building a cache entry object</a> based on all the files that are part of the compilation. That includes all of <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L44\">the following files</a> in the directory, and all parent directories:</p> <ul><li><a href=\"https://learn.microsoft.com/en-us/dotnet/core/tools/global-json\"><em>global.json</em></a></li> <li><a href=\"https://learn.microsoft.com/en-us/nuget/reference/nuget-config-file\"><em>NuGet.config</em></a></li> <li><a href=\"https://learn.microsoft.com/en-us/visualstudio/msbuild/customize-by-directory?view=vs-2022#directorybuildprops-and-directorybuildtargets\"><em>Directory.Build.props</em></a></li> <li><a href=\"https://learn.microsoft.com/en-us/visualstudio/msbuild/customize-by-directory?view=vs-2022#directorybuildprops-and-directorybuildtargets\"><em>Directory.Build.targets</em></a></li> <li><a href=\"https://devblogs.microsoft.com/dotnet/introducing-central-package-management/\"><em>Directory.Packages.props</em></a></li> <li><a href=\"https://learn.microsoft.com/en-us/visualstudio/msbuild/msbuild-response-files?view=vs-2022\"><em>Directory.Build.rsp</em></a></li> <li><a href=\"https://learn.microsoft.com/en-us/visualstudio/msbuild/msbuild-response-files?view=vs-2022\"><em>MSBuild.rsp</em></a></li></ul> <p>The <code>NeedsToBuild</code> method then checks for a file called <code>build-success.cache</code> in the output folder, which is written after a build is completed. If this file is found, it's deserialized into a <code>RunFileBuildCacheEntry</code> object. This entry is compared to the one created for the current run. The previous build is considered valid if:</p> <ul><li>The global MSBuild properties are the same</li> <li>The entrypoint file has not changed since the last build</li> <li>None of the implicit files (listed previously) have changed or been deleted since the last build</li> <li>There are no <em>new</em> implicit build files</li></ul> <p>If all these are satisfied, then <code>dotnet run</code> can skip most of the build. Otherwise we continue with the build.</p> <h3 id=\"preparing-the-virtual-project\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#preparing-the-virtual-project\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Preparing the virtual project</a></h3> <p>The first step of the build is to create a sentinel file, <code>build-start.cache</code>, in the single-file's output directory. This is used to optimize the cache checks; if the start file does not exist, or it's newer than the success file, then a build is definitely required. With the caching all dealt with, <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L167-L184\">an MSBuild build is initialized</a>, and the building of the virtual project starts properly with <code>PrepareProjectInstance()</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">VirtualProjectBuildingCommand</span> <span class=\"token function\">PrepareProjectInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sourceFile <span class=\"token operator\">=</span> <span class=\"token function\">LoadSourceFile</span><span class=\"token punctuation\">(</span>EntryPointFileFullPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    _directives <span class=\"token operator\">=</span> <span class=\"token function\">FindDirectives</span><span class=\"token punctuation\">(</span>sourceFile<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">reportAllErrors</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">errors</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>As you can see from the above, this method reads the file into memory and <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L757C51-L757C65\">calls <code>FindDirectives()</code></a>, which looks for both the shebang (<code>#!</code>) and all the <code>#:</code> directives in the file. I won't go through all the details of exactly how that works, but it uses <a href=\"https://github.com/dotnet/roslyn/blob/75e79dace86b274327a1afe479228d82a06051a4/src/Compilers/CSharp/Portable/Syntax/SyntaxTokenParser.cs\">the experimental <code>SyntaxTokenParser</code> API</a> to parse the file up until the first C# token, and to extract all of the directives.</p> <p>The virtual project file is created <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L447\">in <code>CreateProjectInstance()</code></a>, which in turn calls <code>CreateProjectRootElement()</code>, shown below:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token return-type class-name\">ProjectRootElement</span> <span class=\"token function\">CreateProjectRootElement</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProjectCollection</span> projectCollection<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    Debug<span class=\"token punctuation\">.</span><span class=\"token function\">Assert</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_directives<span class=\"token punctuation\">.</span>IsDefault<span class=\"token punctuation\">,</span> <span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\"><span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>PrepareProjectInstance<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> should have been called first.\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> projectFileFullPath <span class=\"token operator\">=</span> Path<span class=\"token punctuation\">.</span><span class=\"token function\">ChangeExtension</span><span class=\"token punctuation\">(</span>EntryPointFileFullPath<span class=\"token punctuation\">,</span> <span class=\"token string\">\".csproj\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> projectFileWriter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StringWriter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">WriteProjectFile</span><span class=\"token punctuation\">(</span>\n        projectFileWriter<span class=\"token punctuation\">,</span>\n        _directives<span class=\"token punctuation\">,</span>\n        <span class=\"token named-parameter punctuation\">isVirtualProject</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token named-parameter punctuation\">targetFilePath</span><span class=\"token punctuation\">:</span> EntryPointFileFullPath<span class=\"token punctuation\">,</span>\n        <span class=\"token named-parameter punctuation\">artifactsPath</span><span class=\"token punctuation\">:</span> <span class=\"token function\">GetArtifactsPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token named-parameter punctuation\">includeRuntimeConfigInformation</span><span class=\"token punctuation\">:</span> BuildTarget <span class=\"token operator\">!=</span> <span class=\"token string\">\"Publish\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> projectFileText <span class=\"token operator\">=</span> projectFileWriter<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StringReader</span><span class=\"token punctuation\">(</span>projectFileText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> xmlReader <span class=\"token operator\">=</span> XmlReader<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> projectRoot <span class=\"token operator\">=</span> ProjectRootElement<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span>xmlReader<span class=\"token punctuation\">,</span> projectCollection<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    projectRoot<span class=\"token punctuation\">.</span>FullPath <span class=\"token operator\">=</span> projectFileFullPath<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> projectRoot<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>This method</p> <ul><li>Sets the virtual project's file path to be the path to the single-file program.</li> <li>Writes a project file to a <code>StringWriter()</code> instance.</li> <li>Reads the project file into and <code>XmlReader</code> instance and creates an MSBuild project <code>ProjectRootElement</code> instance</li></ul> <p>The interesting method here is <code>WriteProjectFile()</code>, this is a pretty long method, but we'll look at it in detail, as it is the heart of the implementation.</p> <h3 id=\"creating-the-virtual-project\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#creating-the-virtual-project\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Creating the virtual project</a></h3> <p>The <code>WriteProjectFile()</code> method handles two distinct scenarios. It's used to create the \"virtual\" project used by <code>dotnet run</code>, but also the \"output\" project file created by <code>dotnet project convert</code>. We'll look at both paths at the same time, as that's how the code is structured inside <code>WriteProjectFile()</code>.</p> <h4 id=\"handling-sdk-directives\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#handling-sdk-directives\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Handling <code>#:sdk</code> directives</a></h4> <p>The method starts by extracting all the supported directives from the <code>ImmutableArray&lt;&gt;</code> passed in:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">WriteProjectFile</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">TextWriter</span> writer<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">ImmutableArray<span class=\"token punctuation\">&lt;</span>CSharpDirective<span class=\"token punctuation\">&gt;</span></span> directives<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> isVirtualProject<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">?</span></span> targetFilePath <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">?</span></span> artifactsPath <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> includeRuntimeConfigInformation <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> processedDirectives <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sdkDirectives <span class=\"token operator\">=</span> directives<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">OfType</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>CSharpDirective<span class=\"token punctuation\">.</span>Sdk<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> propertyDirectives <span class=\"token operator\">=</span> directives<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">OfType</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>CSharpDirective<span class=\"token punctuation\">.</span>Property<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> packageDirectives <span class=\"token operator\">=</span> directives<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">OfType</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>CSharpDirective<span class=\"token punctuation\">.</span>Package<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> projectDirectives <span class=\"token operator\">=</span> directives<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">OfType</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>CSharpDirective<span class=\"token punctuation\">.</span>Project<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>It then calculates what is the main SDK to use. The single-file projects uses the <a href=\"https://learn.microsoft.com/en-us/dotnet/core/project-sdk/overview\">SDK-style projects</a> common with .NET Core, so we need at least <em>one</em> SDK for the project.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> sdkValue <span class=\"token operator\">=</span> <span class=\"token string\">\"Microsoft.NET.Sdk\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sdkDirectives<span class=\"token punctuation\">.</span><span class=\"token function\">FirstOrDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">is</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span> firstSdk<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    sdkValue <span class=\"token operator\">=</span> firstSdk<span class=\"token punctuation\">.</span><span class=\"token function\">ToSlashDelimitedString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    processedDirectives<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>If you don't specify an SDK in your single-file using the <code>#:sdk</code> directive, then the value <code>\"Microsoft.NET.Sdk\"</code> is used. Interestingly, when building with dotnet run, the virtual project does <em>not</em> specify the <code>Sdk</code> attribute in the <code>&lt;Project&gt;</code> element. Instead it directly imports the <code>Sdk.props</code> file, and subsequently the <code>Sdk.targets</code> file, as we'll see shortly.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isVirtualProject<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Building with dotnet run</span>\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n        <span class=\"token operator\">&lt;</span>Project<span class=\"token operator\">&gt;</span>\n\n          <span class=\"token operator\">&lt;</span>PropertyGroup<span class=\"token operator\">&gt;</span>\n            <span class=\"token operator\">&lt;</span>IncludeProjectNameInArtifactsPaths<span class=\"token operator\">&gt;</span><span class=\"token boolean\">false</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>IncludeProjectNameInArtifactsPaths<span class=\"token operator\">&gt;</span>\n            <span class=\"token operator\">&lt;</span>ArtifactsPath<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">{</span><span class=\"token function\">EscapeValue</span><span class=\"token punctuation\">(</span>artifactsPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ArtifactsPath<span class=\"token operator\">&gt;</span>\n          <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>PropertyGroup<span class=\"token operator\">&gt;</span>\n\n          <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token operator\">--</span> We need to explicitly import Sdk props<span class=\"token operator\">/</span>targets so we can <span class=\"token keyword\">override</span> the targets below<span class=\"token punctuation\">.</span> <span class=\"token operator\">--</span><span class=\"token operator\">&gt;</span>\n          <span class=\"token operator\">&lt;</span><span class=\"token class-name\">Import</span> Project<span class=\"token operator\">=</span><span class=\"token string\">\"Sdk.props\"</span> Sdk<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(sdkValue)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n        <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">else</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Create project file with dotnet convert project</span>\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n        <span class=\"token operator\">&lt;</span><span class=\"token class-name\">Project</span> Sdk<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(sdkValue)}\"</span><span class=\"token operator\">&gt;</span>\n\n        <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <blockquote> <p>I'm not entirely sure <em>why</em> we need to take the approach of directly importing the <code>Sdk.props</code> files and <code>Sdk.targets</code> files (later) individually for the virtual project, but I assume there's some reason the ordering isn't right otherwise 😅</p> </blockquote> <p>That handles the primary SDK, but you can also provide additive MSBuild projects, like <a href=\"https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/dotnet-aspire-sdk\">the one needed for Aspire</a> by providing additional <code>#:sdk</code> directives, which optionally have a version. The next part of <code>WriteProjectFile</code></p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sdk <span class=\"token keyword\">in</span> sdkDirectives<span class=\"token punctuation\">.</span><span class=\"token function\">Skip</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isVirtualProject<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 👇 I inlinedthe method below for simplicity</span>\n        <span class=\"token comment\">// WriteImport(writer, \"Sdk.props\", sdk);</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sdk<span class=\"token punctuation\">.</span>Version <span class=\"token keyword\">is</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// dotnet run, no version</span>\n            writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n                  <span class=\"token operator\">&lt;</span><span class=\"token class-name\">Import</span> Project<span class=\"token operator\">=</span><span class=\"token string\">\"Sdk.props\"</span> Sdk<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(sdk.Name)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n                <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// dotnet run, with version</span>\n            writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n                  <span class=\"token operator\">&lt;</span><span class=\"token class-name\">Import</span> Project<span class=\"token operator\">=</span><span class=\"token string\">\"Sdk.props\"</span> Sdk<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(sdk.Name)}\"</span> Version<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(sdk.Version)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n                <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sdk<span class=\"token punctuation\">.</span>Version <span class=\"token keyword\">is</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// dotnet project convert, no version</span>\n        writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n              <span class=\"token operator\">&lt;</span><span class=\"token class-name\">Sdk</span> Name<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(sdk.Name)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n            <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// dotnet project convert, with version</span>\n        writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n              <span class=\"token operator\">&lt;</span><span class=\"token class-name\">Sdk</span> Name<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(sdk.Name)}\"</span> Version<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(sdk.Version)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n            <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    processedDirectives<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <h4 id=\"handling-property-directives\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#handling-property-directives\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Handling <code>#:property</code> directives</a></h4> <p>Once all the SDK directives are handled we get to the standard properties. The only potential surprise here is that <code>PublishAot</code> is set, which is a new addition in preview 6.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Kept in sync with the default `dotnet new console` project file (enforced by `DotnetProjectAddTests.SameAsTemplate`).</span>\nwriter<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n      <span class=\"token operator\">&lt;</span>PropertyGroup<span class=\"token operator\">&gt;</span>\n        <span class=\"token operator\">&lt;</span>OutputType<span class=\"token operator\">&gt;</span>Exe<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>OutputType<span class=\"token operator\">&gt;</span>\n        <span class=\"token operator\">&lt;</span>TargetFramework<span class=\"token operator\">&gt;</span>net10<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>TargetFramework<span class=\"token operator\">&gt;</span>\n        <span class=\"token operator\">&lt;</span>ImplicitUsings<span class=\"token operator\">&gt;</span>enable<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ImplicitUsings<span class=\"token operator\">&gt;</span>\n        <span class=\"token operator\">&lt;</span>Nullable<span class=\"token operator\">&gt;</span>enable<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Nullable<span class=\"token operator\">&gt;</span>\n        <span class=\"token operator\">&lt;</span>PublishAot<span class=\"token operator\">&gt;</span><span class=\"token boolean\">true</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>PublishAot<span class=\"token operator\">&gt;</span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>PropertyGroup<span class=\"token operator\">&gt;</span>\n    <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Next <a href=\"https://learn.microsoft.com/en-us/dotnet/core/project-sdk/msbuild-props#enabledefaultitems\"><code>EnableDefaultItems</code> is disabled</a>. This ensures the default includes for <em>.cs</em> files, embedded resources, and other content files <em>aren't</em> included in the implicit project. That's important for being able to have multiple single-file apps side-by-side:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isVirtualProject<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span>\"\n\n          <span class=\"token operator\">&lt;</span>PropertyGroup<span class=\"token operator\">&gt;</span>\n            <span class=\"token operator\">&lt;</span>EnableDefaultItems<span class=\"token operator\">&gt;</span><span class=\"token boolean\">false</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>EnableDefaultItems<span class=\"token operator\">&gt;</span>\n          <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>PropertyGroup<span class=\"token operator\">&gt;</span>\n        <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The next block is for setting all the remaining properties set via <code>#:property</code> directives. They're all added into a <code>&lt;PropertyGroup&gt;</code> as follows:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>propertyDirectives<span class=\"token punctuation\">.</span><span class=\"token function\">Any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span>\"\n\n          <span class=\"token operator\">&lt;</span>PropertyGroup<span class=\"token operator\">&gt;</span>\n        <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> property <span class=\"token keyword\">in</span> propertyDirectives<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n                <span class=\"token operator\">&lt;</span><span class=\"token punctuation\">{</span>property<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">}</span><span class=\"token operator\">&gt;</span><span class=\"token punctuation\">{</span><span class=\"token function\">EscapeValue</span><span class=\"token punctuation\">(</span>property<span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token punctuation\">{</span>property<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">}</span><span class=\"token operator\">&gt;</span>\n            <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        processedDirectives<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"  &lt;/PropertyGroup&gt;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>For virtual projects, <code>FileBasedProgram</code> is also added to the <code>Features</code> compilation:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isVirtualProject<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// After `#:property` directives so they don't override this.</span>\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span>\"\n\n          <span class=\"token operator\">&lt;</span>PropertyGroup<span class=\"token operator\">&gt;</span>\n            <span class=\"token operator\">&lt;</span>Features<span class=\"token operator\">&gt;</span>$<span class=\"token punctuation\">(</span>Features<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>FileBasedProgram<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Features<span class=\"token operator\">&gt;</span>\n          <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>PropertyGroup<span class=\"token operator\">&gt;</span>\n        <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The <code>FileBasedProgram</code> feature is a <a href=\"https://github.com/dotnet/roslyn/blob/c8b5f306d86bc04c59a413ad17b6152663a1e744/src/Compilers/CSharp/Portable/CSharpParseOptions.cs#L233-L239\">switch that makes the Roslyn compiler ignore <code>#:</code> directives</a>. Without it, the compiler will report errors if you try to use <code>#:</code> in non single-file program.</p> <h4 id=\"handling-package-and-project-directives\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#handling-package-and-project-directives\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Handling <code>#:package</code> and <code>#:project</code> directives</a></h4> <p>Next up, we have the <code>#:package</code> directives. These are written pretty plainly as you'd expect, every directive becomes a <code>&lt;PackageReference&gt;</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>packageDirectives<span class=\"token punctuation\">.</span><span class=\"token function\">Any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span>\"\n\n          <span class=\"token operator\">&lt;</span>ItemGroup<span class=\"token operator\">&gt;</span>\n        <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> package <span class=\"token keyword\">in</span> packageDirectives<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>package<span class=\"token punctuation\">.</span>Version <span class=\"token keyword\">is</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n                    <span class=\"token operator\">&lt;</span><span class=\"token class-name\">PackageReference</span> Include<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(package.Name)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n                <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span>\n        <span class=\"token punctuation\">{</span>\n            writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n                    <span class=\"token operator\">&lt;</span><span class=\"token class-name\">PackageReference</span> Include<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(package.Name)}\"</span> Version<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(package.Version)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n                <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        processedDirectives<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"  &lt;/ItemGroup&gt;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>Similarly, <code>#:project</code> references are written as <code>&lt;ProjectReference&gt;</code> elements:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>projectDirectives<span class=\"token punctuation\">.</span><span class=\"token function\">Any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span>\"\n\n          <span class=\"token operator\">&lt;</span>ItemGroup<span class=\"token operator\">&gt;</span>\n        <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> projectReference <span class=\"token keyword\">in</span> projectDirectives<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n                <span class=\"token operator\">&lt;</span><span class=\"token class-name\">ProjectReference</span> Include<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(projectReference.Name)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n            <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        processedDirectives<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"  &lt;/ItemGroup&gt;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <h4 id=\"file-references-and-sdk-targets\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#file-references-and-sdk-targets\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">File references and <code>#:sdk</code> targets</a></h4> <p>We're nearly at the end of the method now, but before we get there we've got some important final elements to write if we're creating a virtual project for <code>dotnet run</code>. First of all, we write a <code>Compile</code> reference to the single-file. Unlike \"normal\" SDK-style projects that add all .cs files by default, that was disabled by setting <code>EnableDefaultItems=False</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isVirtualProject<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    Debug<span class=\"token punctuation\">.</span><span class=\"token function\">Assert</span><span class=\"token punctuation\">(</span>targetFilePath <span class=\"token keyword\">is</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n\n          <span class=\"token operator\">&lt;</span>ItemGroup<span class=\"token operator\">&gt;</span>\n            <span class=\"token operator\">&lt;</span><span class=\"token class-name\">Compile</span> Include<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(targetFilePath)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n          <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ItemGroup<span class=\"token operator\">&gt;</span>\n\n        <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>Next, two <code>RuntimeHostConfigurationOption</code> values are set (as long as we're <em>not</em> doing a <code>dotnet publish</code>, i.e. you're only doing a <code>dotnet run</code>)</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>includeRuntimeConfigInformation<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> targetDirectory <span class=\"token operator\">=</span> Path<span class=\"token punctuation\">.</span><span class=\"token function\">GetDirectoryName</span><span class=\"token punctuation\">(</span>targetFilePath<span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n      <span class=\"token operator\">&lt;</span>ItemGroup<span class=\"token operator\">&gt;</span>\n        <span class=\"token operator\">&lt;</span><span class=\"token class-name\">RuntimeHostConfigurationOption</span> Include<span class=\"token operator\">=</span><span class=\"token string\">\"EntryPointFilePath\"</span> Value<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(targetFilePath)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n        <span class=\"token operator\">&lt;</span><span class=\"token class-name\">RuntimeHostConfigurationOption</span> Include<span class=\"token operator\">=</span><span class=\"token string\">\"EntryPointFileDirectoryPath\"</span> Value<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(targetDirectory)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ItemGroup<span class=\"token operator\">&gt;</span>\n\n    <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>Setting these values allow you to retrieve the \"original\" file path at runtime using <code>AppContext</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">?</span></span> filePath <span class=\"token operator\">=</span> AppContext<span class=\"token punctuation\">.</span><span class=\"token function\">GetData</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"EntryPointFilePath\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">?</span></span> directoryPath <span class=\"token operator\">=</span> AppContext<span class=\"token punctuation\">.</span><span class=\"token function\">GetData</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"EntryPointFileDirectoryPath\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>As far as I can tell, this isn't actually used by the SDK anywhere, it's just useful if you want to determine the current single-file's path from inside the single-file program. As noted above though, this information is lost if you <em>publish</em> the app.</p> <p>Near the end of the file we have the <code>Sdk.targts</code> imports, which correspond to all the <code>Sdk.props</code> added at the top of the file:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sdk <span class=\"token keyword\">in</span> sdkDirectives<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// WriteImport(writer, \"Sdk.targets\", sdk);</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sdk<span class=\"token punctuation\">.</span>Version <span class=\"token keyword\">is</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n                  <span class=\"token operator\">&lt;</span><span class=\"token class-name\">Import</span> Project<span class=\"token operator\">=</span><span class=\"token string\">\"Sdk.targets\"</span> Sdk<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(sdk.Name)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n                <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span>\n        <span class=\"token punctuation\">{</span>\n            writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"\"</span></span>\"\n                  <span class=\"token operator\">&lt;</span><span class=\"token class-name\">Import</span> Project<span class=\"token operator\">=</span><span class=\"token string\">\"Sdk.targets\"</span> Sdk<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(sdk.Name)}\"</span> Version<span class=\"token operator\">=</span><span class=\"token string\">\"{EscapeValue(sdk.Version)}\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n                <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n      \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>sdkDirectives<span class=\"token punctuation\">.</span><span class=\"token function\">Any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Debug<span class=\"token punctuation\">.</span><span class=\"token function\">Assert</span><span class=\"token punctuation\">(</span>sdkValue <span class=\"token operator\">==</span> <span class=\"token string\">\"Microsoft.NET.Sdk\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span>\"\n              <span class=\"token operator\">&lt;</span><span class=\"token class-name\">Import</span> Project<span class=\"token operator\">=</span><span class=\"token string\">\"Sdk.targets\"</span> Sdk<span class=\"token operator\">=</span><span class=\"token string\">\"Microsoft.NET.Sdk\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">&gt;</span>\n            <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The last addition for the virtual project is a workaround for <a href=\"https://github.com/NuGet/Home/issues/14148\">an issue logged in NuGet</a>, where some restore targets fail when used with the in-memory virtual project. To work around the issue for now, <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L61-L109\">a bunch of targets are overridden</a> and written to the project:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span>TargetOverrides<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>The targets are defined <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L61-L109\">here</a>; I'll show what that looks like shortly when we recap.</p> <p>And with that, we close off the <code>&lt;Project&gt;</code> element, and we're done!</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">writer<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span>\"\n\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Project<span class=\"token operator\">&gt;</span>\n    <span class=\"token string\">\"\"</span>\"<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <h4 id=\"putting-it-all-together\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#putting-it-all-together\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Putting it all together</a></h4> <p>Before we move on, let's put this all together to see what a \"complete\" virtual-project file looks like. The easiest way to see that is to take a look at some of <a href=\"https://github.com/dotnet/sdk/blob/3c21adb924c3c33682255711fd42a714210d8075/test/dotnet.Tests/CommandTests/Run/RunFileTests.cs#L1578\">the tests</a>. The following is taken from just such a test.</p> <p>If you have the following simple single-file app:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token preprocessor property\">#!/program</span>\n<span class=\"token preprocessor property\">#:sdk Microsoft.NET.Sdk</span>\n<span class=\"token preprocessor property\">#:sdk Aspire.Hosting.Sdk@9.1.0</span>\n<span class=\"token preprocessor property\">#:property TargetFramework=net11.0</span>\n<span class=\"token preprocessor property\">#:package System.CommandLine@2.0.0-beta4.22272.1</span>\n<span class=\"token preprocessor property\">#:property LangVersion=</span><span class=\"token return-type class-name\">preview</span>\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Then the virtual project built looks like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>IncludeProjectNameInArtifactsPaths</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>IncludeProjectNameInArtifactsPaths</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ArtifactsPath</span><span class=\"token punctuation\">&gt;</span></span>/artifacts<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ArtifactsPath</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token comment\">&lt;!-- We need to explicitly import Sdk props/targets so we can override the targets below. --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Import</span> <span class=\"token attr-name\">Project</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Sdk.props<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Import</span> <span class=\"token attr-name\">Project</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Sdk.props<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Aspire.Hosting.Sdk<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>9.1.0<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>Exe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net10.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>EnableDefaultItems</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>EnableDefaultItems</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net11.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>preview<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Features</span><span class=\"token punctuation\">&gt;</span></span>$(Features);FileBasedProgram<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Features</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>System.CommandLine<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>2.0.0-beta4.22272.1<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Compile</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/path/to/Program.cs<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeHostConfigurationOption</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>EntryPointFilePath<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/path/to/Program.cs<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RuntimeHostConfigurationOption</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>EntryPointFileDirectoryPath<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/path/to/<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Import</span> <span class=\"token attr-name\">Project</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Sdk.targets<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Import</span> <span class=\"token attr-name\">Project</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Sdk.targets<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Aspire.Hosting.Sdk<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>9.1.0<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n\n  <span class=\"token comment\">&lt;!--\n    Override targets which don't work with project files that are not present on disk.\n    See https://github.com/NuGet/Home/issues/14148.\n  --&gt;</span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Target</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_FilterRestoreGraphProjectInputItems<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">DependsOnTargets</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_LoadRestoreGraphEntryPoints<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token comment\">&lt;!-- No-op, the original output is not needed by the overwritten targets. --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Target</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Target</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_GetAllRestoreProjectPathItems<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">DependsOnTargets</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_FilterRestoreGraphProjectInputItems;_GenerateRestoreProjectPathWalk<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">Returns</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@(_RestoreProjectPathItems)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token comment\">&lt;!-- Output from dependency _GenerateRestoreProjectPathWalk. --&gt;</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Target</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Target</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_GenerateRestoreGraph<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">DependsOnTargets</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_FilterRestoreGraphProjectInputItems;_GetAllRestoreProjectPathItems;_GenerateRestoreGraphProjectEntry;_GenerateProjectRestoreGraph<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">Returns</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@(_RestoreGraphEntry)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token comment\">&lt;!-- Output partly from dependency _GenerateRestoreGraphProjectEntry and _GenerateProjectRestoreGraph. --&gt;</span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>_GenerateRestoreGraphProjectEntryInput</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@(_RestoreProjectPathItems)<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Exclude</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(MSBuildProjectFullPath)<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>MSBuild</span>\n        <span class=\"token attr-name\">BuildInParallel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(RestoreBuildInParallel)<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">Projects</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@(_GenerateRestoreGraphProjectEntryInput)<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">Targets</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_GenerateRestoreGraphProjectEntry<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">Properties</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(_GenerateRestoreGraphProjectEntryInputProperties)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Output</span>\n          <span class=\"token attr-name\">TaskParameter</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>TargetOutputs<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">ItemName</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_RestoreGraphEntry<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>MSBuild</span><span class=\"token punctuation\">&gt;</span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>MSBuild</span>\n        <span class=\"token attr-name\">BuildInParallel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(RestoreBuildInParallel)<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">Projects</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@(_GenerateRestoreGraphProjectEntryInput)<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">Targets</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_GenerateProjectRestoreGraph<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">Properties</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$(_GenerateRestoreGraphProjectEntryInputProperties)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Output</span>\n          <span class=\"token attr-name\">TaskParameter</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>TargetOutputs<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">ItemName</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>_RestoreGraphEntry<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>MSBuild</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Target</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>There's a <em>lot</em> there, right?!😅 The interesting thing is if we look at what the <em>converted</em> project looks like:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Import</span> <span class=\"token attr-name\">Project</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Sdk.props<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Import</span> <span class=\"token attr-name\">Project</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Sdk.props<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Aspire.Hosting.Sdk<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>9.1.0<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>Exe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net10.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishAot</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net11.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>preview<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>LangVersion</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>System.CommandLine<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>2.0.0-beta4.22272.1<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p><em>Much</em> simpler! 😀</p> <p>With that, we can get back on track with the process of actually building the app.</p> <h3 id=\"building-with-msbuild\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#building-with-msbuild\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Building with MSBuild</a></h3> <p>We left off just before we were going to do a restore and build of our single-file app. Now that we have built an in-memory project file, and parsed it into an MSBuild <code>ProjectInstance</code>, we can finally get started. First we need to do a restore, though the current MSBuild API <a href=\"https://github.com/dotnet/msbuild/issues/11519\">makes this quite cumbersome to achieve</a>, requiring setting <a href=\"https://github.com/dotnet/sdk/blob/4177291d4d3dabd5341239d01b3e844125659304/src/Cli/dotnet/Commands/Run/VirtualProjectBuildingCommand.cs#L188-L207\">a bunch of properties and flags</a>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Creating project instance details not shown</span>\n<span class=\"token class-name\">ProjectInstance</span> project <span class=\"token operator\">=</span> <span class=\"token function\">CreateProjectInstance</span><span class=\"token punctuation\">(</span><span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> restoreRequest <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">BuildRequestData</span><span class=\"token punctuation\">(</span>\n    project<span class=\"token punctuation\">,</span>\n    <span class=\"token named-parameter punctuation\">targetsToBuild</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Restore\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token named-parameter punctuation\">hostServices</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    BuildRequestDataFlags<span class=\"token punctuation\">.</span>ClearCachesAfterBuild <span class=\"token operator\">|</span> BuildRequestDataFlags<span class=\"token punctuation\">.</span>SkipNonexistentTargets <span class=\"token operator\">|</span> BuildRequestDataFlags<span class=\"token punctuation\">.</span>IgnoreMissingEmptyAndInvalidImports <span class=\"token operator\">|</span> BuildRequestDataFlags<span class=\"token punctuation\">.</span>FailOnUnresolvedSdk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> restoreResult <span class=\"token operator\">=</span> BuildManager<span class=\"token punctuation\">.</span>DefaultBuildManager<span class=\"token punctuation\">.</span><span class=\"token function\">BuildRequest</span><span class=\"token punctuation\">(</span>restoreRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Ultimately there's just two statements here, creating a <code>BuildRequestData</code> instance, and passing it to the previously-initialized MSBuild <code>BuildManager</code>. This does the restore, and if all is well, we can run a build too:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> buildRequest <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">BuildRequestData</span><span class=\"token punctuation\">(</span>\n    <span class=\"token function\">CreateProjectInstance</span><span class=\"token punctuation\">(</span>projectCollection<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token named-parameter punctuation\">targetsToBuild</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">BuildTarget</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> buildResult <span class=\"token operator\">=</span> BuildManager<span class=\"token punctuation\">.</span>DefaultBuildManager<span class=\"token punctuation\">.</span><span class=\"token function\">BuildRequest</span><span class=\"token punctuation\">(</span>buildRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>This is essentially the same two steps—create a <code>BuildRequest</code> and call <code>BuildManager</code>—but in this case it's much easier to create the request.</p> <p>If that all succeeds, the cache entry is serialized to the <code>build-success.cache</code> file, and the single-file build is complete!</p> <p>At this point, the single-file app is built, and as far as the <code>RunCommand</code> is concerned, it's mostly just like any other .NET app. This post has already gone on <em>way</em> too long, so I'll leave it there. If you've made it this far, congratulations 😅 I don't know how <em>useful</em> this post will be in a practical sense, but I often find it useful to dig into the details like this occasionally, to get a real feel for how things work.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In the <a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/\">previous post</a>, I described the new feature coming in .NET 10 for building and running a single C# file <em>without</em> needing to first create a <em>.csproj</em> project. In this post, I showed the code that implements the single-file feature in the <code>dotnet</code> SDK. I showed how the SDK identifies a target as a single-file program, how the caching system reduces the number of rebuilds, and then focused primarily on the code that creates an in-memory virtual-project. This may not be particularly practical useful, but I always find it interesting to see how things work under the hood!</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/",
      "Title": "Exploring the features of dotnet run app.cs: Exploring the .NET 10 preview - Part 1",
      "PublishDate": "2025-07-01T10:00:00+00:00",
      "Summary": "In this post I discuss the new single-file .NET run experience, in which you can run a C# file directly, without needing a csproj project file",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/single-file-dotnet.webp\" /><nav><p>This is the first post in the series: <a href=\"https://andrewlock.net/series/exploring-the-dotnet-10-preview/\">Exploring the .NET 10 preview</a>. </p> <ol class=\"list-none\"><li>Part 1 - Exploring the features of dotnet run app.cs (this post) </li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-2-behind-the-scenes-of-dotnet-run-app.cs/\">Part 2 - Behind the scenes of dotnet run app.cs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-3-csharp-14-extensions-members/\">Part 3 - C# 14 extension members; AKA extension everything</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-4-solving-the-source-generator-marker-attribute-problem-in-dotnet-10/\">Part 4 - Solving the source generator 'marker attribute' problem in .NET 10</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-5-running-one-off-dotnet-tools-with-dnx/\">Part 5 - Running one-off .NET tools with dnx</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-6-passkey-support-for-aspnetcore-identity/\">Part 6 - Passkey support for ASP.NET Core identity</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-7-packaging-self-contained-and-native-aot-dotnet-tools-for-nuget/\">Part 7 - Packaging self-contained and native AOT .NET tools for NuGet</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-8-supporting-platform-specific-dotnet-tools-on-old-sdks/\">Part 8 - Supporting platform-specific .NET tools on old .NET SDKs</a></li><li><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-9-easier-reflection-with-unsafeaccessortype/\">Part 9 - Easier reflection with [UnsafeAccessorType] in .NET 10</a></li></ol></nav><p>In this post I describe the new feature coming in .NET 10 for building and running a single C# file <em>without</em> needing to first create a .csproj project. I show it in action, describe the features, and discuss the limitations. In the next post I look at how it works behind the scene.</p> <blockquote> <p>I struggled a bit with what to call this post, because there doesn't seem to be a final name for the feature I'm describing 😅 In some places it's called \"<a href=\"https://github.com/dotnet/sdk/issues/48990\">file-based programs</a>\", internally it's sometimes referred to as \"<a href=\"https://github.com/dotnet/sdk/blob/main/documentation/general/dotnet-run-file.md#multiple-c-files\">runfile</a>\", but publicly it's described more as \"<a href=\"https://devblogs.microsoft.com/dotnet/announcing-dotnet-run-app/\">dotnet run app.cs</a>\", which describes <em>how</em> you use it.</p> </blockquote> <h2 id=\"what-is-dotnet-run-app-cs-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#what-is-dotnet-run-app-cs-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What is <code>dotnet run app.cs</code>?</a></h2> <p>Prior to .NET 10, a \"hello world\" C# application required at least 2 files:</p> <ul><li>A <em>.csproj</em> project file</li> <li>A <em>.cs</em> file containing <a href=\"https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/program-structure/top-level-statements\">top-level statements</a></li></ul> <p>Now .NET 10 includes <a href=\"https://devblogs.microsoft.com/dotnet/announcing-dotnet-run-app/\">preview support</a> for removing the need for the <em>.csproj</em> file too. Finally, a .NET application <em>only</em> needs a single <em>.cs</em> file. The hello-world C# program now becomes:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello, world\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Save that to a file, <em>app.cs</em> for example, and you can run your application with <code>dotnet run app.cs</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dotnet run app.cs\nHello, world\n</code></pre></div> <p>This was first demoed by Damian Edwards in <a href=\"https://www.youtube.com/watch?v=98MizuB7i-w\">this short 15 minute session at MSBuild</a> where he gives a good overview. You can also read more about it in <a href=\"https://devblogs.microsoft.com/dotnet/announcing-dotnet-run-app/\">the announcement post</a>. In the next section I'll describe the basic features that are available with the new single-file experience.</p> <h2 id=\"what-features-are-available-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#what-features-are-available-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What features are available?</a></h2> <p>The single-file <code>dotnet run</code> experience is currently relatively limited and yet also provides enough configuration points for you to get a long way before you hit a wall. The following small example shows a simple no-op Aspire app host implemented as a single file. It doesn't actually <em>do</em> anything, it's just for demonstrating all the features available in .NET 10 preview 5. I'll walk through this same, and the features it uses, from top to bottom:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token preprocessor property\">#!/usr/bin/dotnet run</span>\n\n<span class=\"token preprocessor property\">#:sdk Microsoft.NET.Sdk</span>\n<span class=\"token preprocessor property\">#:sdk Aspire.AppHost.Sdk 9.3.0</span>\n\n<span class=\"token preprocessor property\">#:package Aspire.Hosting.AppHost@9.3.0</span>\n\n<span class=\"token preprocessor property\">#:property UserSecretsId 2eec9746-c21a-4933-90af-c22431f35459</span>\n\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span>Configuration</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> DistributedApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbuilder<span class=\"token punctuation\">.</span>Configuration<span class=\"token punctuation\">.</span><span class=\"token function\">AddInMemoryCollection</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Dictionary<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">?</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">{</span> <span class=\"token string\">\"ASPIRE_DASHBOARD_OTLP_ENDPOINT_URL\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"https://localhost:21049\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span> <span class=\"token string\">\"ASPIRE_RESOURCE_SERVICE_ENDPOINT_URL\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"https://localhost:22001\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span> <span class=\"token string\">\"ASPNETCORE_URLS\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"https://localhost:17246\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nbuilder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>This script demonstrates all of the new directives available with the single run file experience.</p> <h3 id=\"making-a-file-executable-with-a-shebang\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#making-a-file-executable-with-a-shebang\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Making a file executable with a shebang</a></h3> <p>The line starting with <code>#!</code> at the top of the script is called <a href=\"https://en.wikipedia.org/wiki/Shebang_(Unix)\">a <em>shebang</em></a>, and is a directive for *nix systems that allow you to run the file directly. In this case, it tells the system to run the file using <code>/usr/bin/dotnet run &lt;file&gt;</code>. If you make the file executable using <code>chmod</code>, then you can run it directly from your shell:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">chmod</span> +x app.cs\n./app.cs\n</code></pre></div> <h3 id=\"adding-sdk-references\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#adding-sdk-references\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Adding SDK references</a></h3> <p>By default, single-file apps will use the <code>Microsoft.NET.Sdk</code> MSBuild project SDK by default, which is what you need for building console apps. However, if you're building ASP.NET Core apps, for example, then you need the <code>Microsoft.NET.Sdk.Web</code> SDK, and you need to set that using the <code>#:sdk</code> syntax.</p> <blockquote> <p><a href=\"https://learn.microsoft.com/en-us/dotnet/core/project-sdk/overview\">MSBuild project SDKs</a> are what you normally see referenced in the <code>&lt;Project&gt;</code> element in your <em>.csproj</em> file. You don't <em>normally</em> have to worry about them much, because <code>dotnet new</code> templates create the correct values for you.</p> </blockquote> <p>In the Aspire example above you'll actually see <em>two</em> <code>#:sdk</code> references:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token preprocessor property\">#:sdk Microsoft.NET.Sdk</span>\n<span class=\"token preprocessor property\">#:sdk Aspire.AppHost.Sdk 9.3.0</span>\n</code></pre></div> <p>The first <code>#:sdk</code> sets the <em>project</em> SDK, and then the second <code>#:sdk</code> specifies the <a href=\"https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/dotnet-aspire-sdk\">Aspire additive MSBuild project SDK</a>, which is a versioned SDK that comes from a NuGet package.</p> <blockquote> <p>The current syntax for specifying the version of versioned SDKs may well change. As of .NET preview 5, the syntax uses a space separator, but is changing to use <code>@</code> in the future e.g. <code>#:sdk Aspire.AppHost.Sdk@9.3.0</code>.</p> </blockquote> <p>The <code>Aspire.AppHost.Sdk</code> SDK comes from a NuGet package, so obviously there's a way to specify NuGet package references too!</p> <h3 id=\"adding-nuget-package-references\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#adding-nuget-package-references\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Adding NuGet package references</a></h3> <p>You can reference NuGet packages using the <code>#:package</code> directive, providing a package name and a version. The following installs version 9.3.0 of the Aspire.Hosting.AppHost NuGet package:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token preprocessor property\">#:package Aspire.Hosting.AppHost@9.3.0</span>\n</code></pre></div> <p>You can also use wildcards for version numbers, so all of the following are also valid:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token preprocessor property\">#:package Aspire.Hosting.AppHost@*</span>\n<span class=\"token preprocessor property\">#:package Aspire.Hosting.AppHost@9.*</span>\n<span class=\"token preprocessor property\">#:package Aspire.Hosting.AppHost@9.3.*</span>\n</code></pre></div> <p>The wildcard will generally resolve to the highest package version that satisfies the other requirements.</p> <h3 id=\"updating-msbuild-properties\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#updating-msbuild-properties\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Updating MSBuild properties</a></h3> <p>The final (currently) supported directive is <code>#:property</code> which is used to define MSBuild properties for the app. Basically any properties that you would normally define in a <em>.csproj</em> file in a <code>&lt;PropertyGroup&gt;</code> can be added using this directive. In my example, I set the <code>UserSecretsId</code> property value using:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token preprocessor property\">#:property UserSecretsId 2eec9746-c21a-4933-90af-c22431f35459</span>\n</code></pre></div> <p>This is another example where the syntax will be changing shortly. Instead of space-separated values, you will need to use <code>=</code> separated values, e.g.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token preprocessor property\">#:property UserSecretsId=2eec9746-c21a-4933-90af-c22431f35459</span>\n</code></pre></div> <p>That's all the directives that are supported as of .NET 10 preview 5, but in .NET preview 6 you'll have one more available.</p> <h3 id=\"referencing-projects-coming-soon-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#referencing-projects-coming-soon-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Referencing projects (coming soon)</a></h3> <p>.NET 10 preview 6 should include the ability for single files to reference <em>projects</em> via a <code>#:project</code> directive. This work is <a href=\"https://github.com/dotnet/sdk/pull/49311\">already merged</a>, but it's not released yet, so it could change before then. Currently, you can either reference a project using the full path to the <em>.csproj</em> file, or simply reference the <em>directory</em> containing the project:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token preprocessor property\">#:project ../src/MyProject</span>\n<span class=\"token preprocessor property\">#:project ../src/MyProject/MyProject.csproj</span>\n</code></pre></div> <p>Being able to reference the project directory instead of the full <em>.csproj</em> path is a nice way to reduce a bit of duplication. And it's pretty much in line with the philosophy <a href=\"https://www.youtube.com/watch?v=rb9oXSpfEB0&amp;list=PLdo4fOcmZ0oX-DBuRG4u58ZTAJgBAeQ-t&amp;index=3\">Damian Edwards and others described on a recent community standup</a>: given this whole experience is new, they want to make it as smooth as possible for newcomers coming in, which means smoothing off any rough edges they can.</p> <h2 id=\"who-is-dotnet-run-app-cs-for-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#who-is-dotnet-run-app-cs-for-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Who is <code>dotnet run app.cs</code> for?</a></h2> <p>That brings us nicely to the question: who is the single-file experience actually <em>for</em>? First and foremost, the .NET team have made it clear that this is about making the learning experience for newcomers to .NET as smooth as possible. Many other languages, whether they're Node.js or Python, for example, have a single-file experience, and now .NET does too.</p> <p>Overall, the feature is intended to shield you from all the things you don't care about when you're very first learning C# and .NET; i.e. the project file. Think of yourself as a brand new C# user. You run <code>dotnet new console</code> to create a new console app. The <code>Program.cs</code> file is simple and elegant, just a <code>Console.WriteLine()</code> but you also have this mysterious <em>.csproj</em> file, filled with <em>XML</em> of all things, and with a bunch of stuff that will likely nothing to you 😅</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>Exe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net9.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>With single-file run, that all goes away. As a newcomer you can start from scratch, just the <em>.cs</em> file, and can slowly introduce concepts as you go.</p> <p>Eventually you'll hit a point where it <em>does</em> make sense to have a dedicated project—maybe you want to have multiple <em>.cs</em> files, for example. At that point, you can simply convert your single-file to a project, by running:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet project convert app.cs\n</code></pre></div> <p>Running that command on the Aspire app host example I showed at the start of this post creates a project file that looks like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Sdk</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Aspire.AppHost.Sdk<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>9.3.0<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>Exe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net10.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ImplicitUsings</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>enable<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Nullable</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>UserSecretsId</span><span class=\"token punctuation\">&gt;</span></span>2eec9746-c21a-4933-90af-c22431f35459<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>UserSecretsId</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Aspire.Hosting.AppHost<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>9.3.<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>All the directives I added are included in the project, and you can see the other defaults that I <em>didn't</em> specify there too now. This is a very slick grow-up story for moving from single-file projects to a project file.</p> <p>Although newcomers are the main target audience for the single-file experience, there's several scenarios where removing the heaviness of needing a dedicated project (and corresponding directory) makes sense. For example:</p> <ul><li><strong>Utility scripts</strong>. Previously you would likely use bash or PowerShell, but now you can easily use C# if you prefer.</li> <li><strong>Samples</strong>. Many libraries or frameworks have multiple sample apps for demonstrating a feature, each of which would need its own folder and project file. Now you can have a single folder where each <em>.cs</em> file is a sample app.</li></ul> <p>That covers a couple of the main uses, but we can also consider uses for which single-file programs are <em>already</em> used! This is not the first attempt at creating a single-file or scripting experience for .NET. For example, I first used a single-file C# experience with <a href=\"https://cakebuild.net/\">Cake</a>, but there are various other approaches too, such as the <a href=\"https://github.com/dotnet-script/dotnet-script\">dotnet-script</a> tool, <a href=\"https://github.com/oleg-shilo/cs-script/wiki/CS-Script-Overview\">CS-Script</a>, or even the <a href=\"https://learn.microsoft.com/en-us/archive/msdn-magazine/2016/january/essential-net-csharp-scripting#the-c-repl-command-line-interface-csiexe\">C# REPL CLI tool, CSI.exe</a>. Each of those tools work in slightly different ways, many of which may well also lend themselves to the new built-in experience.</p> <h2 id=\"going-further-with-escape-hatches\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#going-further-with-escape-hatches\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Going further with escape hatches</a></h2> <p>I've covered a lot of the features that are explicitly part of the <code>dotnet run app.cs</code> experience, but the fact that the whole feature is built around a \"virtual\" project, means that you can somewhat hack around current limitations in the directives. Put another, way, there are various files that the single-file app will <em>implicitly</em> use if they're available. These include:</p> <ul><li><a href=\"https://learn.microsoft.com/en-us/dotnet/core/tools/global-json\"><em>global.json</em></a></li> <li><a href=\"https://learn.microsoft.com/en-us/nuget/reference/nuget-config-file\"><em>NuGet.config</em></a></li> <li><a href=\"https://learn.microsoft.com/en-us/visualstudio/msbuild/customize-by-directory?view=vs-2022#directorybuildprops-and-directorybuildtargets\"><em>Directory.Build.props</em></a></li> <li><a href=\"https://learn.microsoft.com/en-us/visualstudio/msbuild/customize-by-directory?view=vs-2022#directorybuildprops-and-directorybuildtargets\"><em>Directory.Build.targets</em></a></li> <li><a href=\"https://devblogs.microsoft.com/dotnet/introducing-central-package-management/\"><em>Directory.Packages.props</em></a></li> <li><a href=\"https://learn.microsoft.com/en-us/visualstudio/msbuild/msbuild-response-files?view=vs-2022\"><em>Directory.Build.rsp</em></a></li> <li><a href=\"https://learn.microsoft.com/en-us/visualstudio/msbuild/msbuild-response-files?view=vs-2022\"><em>MSBuild.rsp</em></a></li></ul> <p>I won't go into details about all these files here, so see the linked documentation if you've not heard about them (the <em>.rsp</em> files were new to me)! Arguably the most useful of these files is the <em>Directory.Build.props</em> which essentially allows you to \"enhance\" your single-file app with anything that you would normally put in a <em>.csproj</em> file. This is particularly useful if you have, for example, a bunch of single-file apps in a directory, and you want to set a property or add a package to them all, without updating each one.</p> <blockquote> <p>That's all a bit abstract, but you can see various examples of this kind of thing in <a href=\"https://github.com/DamianEdwards/runfile\">Damian Edwards' playground repository</a> for the feature!</p> </blockquote> <p>Before we finish, I'll describe some of the features that should be coming soon to the <code>dotnet run app.cs</code> experience .</p> <h2 id=\"what-else-is-coming-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#what-else-is-coming-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What else is coming?</a></h2> <p>In this section I'll highlight a few things that are very likely to be part of the future single-file experience. As always with preview features, there's no guarantee that they'll make the final cut, but the bets are good for the first few features at least given they're already merged!</p> <h3 id=\"publishing-single-file-apps\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#publishing-single-file-apps\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Publishing single file apps</a></h3> <p>One feature which isn't available in .NET 10 preview 5, but which is already merged for preview 6, is the ability <a href=\"https://github.com/dotnet/sdk/pull/49310\">to <em>publish</em> your single-file apps</a> using:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet publish app.cs\n</code></pre></div> <p>What's more, by default, <a href=\"https://github.com/dotnet/sdk/issues/49189\">the apps are published as NativeAOT apps</a>! You can disable that by adding <code>#:property PublishAot false</code> to your project, but it's likely that things will just work for many of the scenarios single-file apps are designed for🤷‍♂️</p> <h3 id=\"running-with-dotnet-app-cs\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#running-with-dotnet-app-cs\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Running with <code>dotnet app.cs</code></a></h3> <p>Another feature <a href=\"https://github.com/dotnet/sdk/pull/48387\">that's already merged</a> is support for running single-file apps <em>without</em> using the <code>run</code> command, i.e. you can use</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet app.cs\n</code></pre></div> <p>instead of having to use</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet run app.cs\n</code></pre></div> <p>One of the main advantages to this is that it makes the support for shebangs on linux more robust. For example, if you want to use <code>/usr/bin/env</code> in order to \"find\" the <code>dotnet</code> executable, instead of assuming it's in <code>/usr/bin/dotnet</code> then previously you would need something like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token preprocessor property\">#!/usr/bin/env dotnet run</span>\n<span class=\"token comment\">// ^ Might not work in all shells. \"dotnet run\" might be passed as a single argument to \"env\".</span>\n</code></pre></div> <p>Unfortunately, this multi-argument requirement might not work in some shells. With the new <code>dotnet app.cs</code> support however, you can use the simpler, and more widely supported:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token preprocessor property\">#!/usr/bin/env dotnet</span>\n<span class=\"token comment\">// ^ Should work in all shells.</span>\n</code></pre></div> <h3 id=\"running-c-directly-from-stdin-code\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#running-c-directly-from-stdin-code\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Running C# directly from stdin code</a></h3> <p>Support for piping C# code directly to <code>dotnet run</code> was <a href=\"https://github.com/dotnet/sdk/pull/49348\">merged recently</a> and means you can do things like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> <span class=\"token string\">'Console.WriteLine(\"Hello, World!\");'</span> <span class=\"token operator\">|</span> dotnet run -\nHello, World<span class=\"token operator\">!</span>\n</code></pre></div> <p>This pipes a hello world app directly from the console to <code>dotnet run</code> and executes it. The classic case of \"you should never do this but people do all the time\" of curl-ing a website and running it directly is now possible 😅</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-S</span> http://totally-safe-not-scary-at-all.com/ <span class=\"token operator\">|</span> dotnet run -\nAll your bases are belong to us<span class=\"token operator\">!</span>\n</code></pre></div> <h3 id=\"future-ideas\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#future-ideas\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Future ideas</a></h3> <p>You can see all the other issues that have been opened (or closed) for the feature by looking for <a href=\"https://github.com/dotnet/sdk/issues?q=state%3Aopen%20label%3A%22Area-run-file%22\">the <code>Area-run-file</code> label on GitHub</a>. You can also read more about the feature in general, including much of what's in this post, as well as <a href=\"https://github.com/dotnet/sdk/blob/main/documentation/general/dotnet-run-file.md#alternatives-and-future-work\">other planned work here</a>.</p> <h2 id=\"what-is-not-coming-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#what-is-not-coming-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What is <em>not</em> coming?</a></h2> <p>So that covers the features that are currently shipped, as well as a bunch of features that will be shipping very soon, and some potential features that <em>may</em> ship with .NET 10. But what about the other side; what's <em>not</em> coming?</p> <p>One big feature that is <em>not</em> coming to .NET 10 <a href=\"https://github.com/dotnet/sdk/issues/48174\">is support for multiple files</a>. This was originally planned to be included, with things like \"nested\" files and sub directories being implicitly included in the compilation. Instead, this work has been <a href=\"https://github.com/dotnet/sdk/blob/main/documentation/general/dotnet-run-file.md#multiple-c-files\">pushed back to .NET 11</a>, to focus on making the single-file experience as good as possible.</p> <blockquote> <p>You can <em>indirectly</em> get support for multiple files using Directory.Build.props and Directory.Build.targets and adding references to the files \"manually\".</p> </blockquote> <p>Another thing that was mentioned in <a href=\"https://www.youtube.com/watch?v=rb9oXSpfEB0&amp;list=PLdo4fOcmZ0oX-DBuRG4u58ZTAJgBAeQ-t&amp;index=3\">a recent community standup</a> is that single-file support is <em>not</em> coming to Visual Studio. The 1st party support from Microsoft will <em>only</em> be in Visual Studio Code (and the CLI, obviusly). There's already <a href=\"https://youtrack.jetbrains.com/issue/RIDER-126336/Support-dotnet-run-file.cs\">an issue for adding Rider support here</a> so be sure to upvote it if you're interested in support!</p> <p>Finally, it's worth saying that at this stage, single-file support is <em>only</em> coming for <code>.cs</code> files; not for <em>.vb</em> or <em>.fs</em> files. The team haven't entirely ruled this out as a possibility, but it's very unlikely Microsoft will add support themselves.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I described the new single-file experience of <code>dotnet run app.cs</code> coming to .NET 10. I showed how the basic feature works and described the various features supported today: <code>#:package</code>, <code>#:property</code>, <code>#:sdk</code>, and shebangs. I then described the target audience for the feature, described some of the other files you can reference, and discussed some new features that are coming soon. Finally, I described some of the scenarios and environments that will not be supported. In the next post I'll dig into some of the SDK code itself and show how some of the features are implemented.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/exploring-dotnet-10-preview-features-1-exploring-the-dotnet-run-app.cs/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/working-with-stacked-branches-in-git-part-2/",
      "Title": "Working with stacked branches in git (Part 2)",
      "PublishDate": "2025-06-24T09:00:00+00:00",
      "Summary": "In this post looking at stacked branches I describe how to handle scenarios such as merging one of your stacked branches and handling changes to main",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/pancake_stack.webp\" /><p>In <a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-1/\">my previous post</a> I described stacked branches and why I like to use them for medium to large features. That's primarily because they make unblocking yourself easier, and the review process of your PRs easier for others.</p> <p>One of the difficulties of stacked branches is that they're simply more complex to work with than isolated branches. In <a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-1/\">the previous post</a> I described how to change commits earlier in the stack of branches. In this post I describe how to handle other common scenarios when working with stacked branches.</p> <h2 id=\"why-use-stacked-branches-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-2/#why-use-stacked-branches-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Why use stacked branches?</a></h2> <p>Just to level set, I'll describe briefly again why I think stacked branches should be your go-to approach for building medium to large features.</p> <blockquote> <p>This section is essentially the same as from the previous post—if you've already that post (and I think you should 😉) then you can jump to the next section.</p> </blockquote> <p>Stacked branches in Git refers to having multiple branches that depend on one another in a linear stack. Each of the commits in a branch in the stack build on the changes made in the previous branch. For example, in the Git diagram below, there's three branches in the stack:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_01.png\" alt=\"An example stack of branches\"></p> <p>In the example above:</p> <ul><li>Branch <code>stack/a</code> branches from commit <code>main2</code> and contains two commits: <code>a1</code> and <code>a2</code></li> <li>Branch <code>stack/b</code> is stacked on branch <code>stack/a</code> and contains one commit: <code>b1</code></li> <li>Branch <code>stack/c</code> is stacked on branch <code>stack/b</code> and contains two commits: <code>c1</code> and <code>c2</code></li></ul> <p>All three <code>stack/*</code> branches are related to the same general feature, with the subsequent branches building on top of the changes made in the previous branches. Now, given that all of the branches are related to the same overall feature, you might be thinking \"why not just have a single branch with 5 commits\"?</p> <p>My main argument is that using stacked branches makes it easier for people to review your changes in a PR. By creating a PR for each branch segment in the stack, the resulting PRs will be:</p> <ul><li>Smaller in scope. By definition each branch will contain smaller changes than the whole stack, so each branch will generally be smaller, and therefore easier to review.</li> <li>More coherent. The intention behind stacked branches is to keep each branch in the stack modular, which makes each branch easier to review than the whole stack.</li> <li>Signposting the thought behind the changes. By creating a stack of PRs, you can effectively <em>guide</em> people on how to review the code, especially as each branch will be accompanied with a PR description explaining the changes.</li></ul> <p>The above reasoning focuses very much on the experience of PR reviewers rather than the commit author. In many cases, creating a well curated stack of branches will be <em>more</em> work for the author than doing all the work in a single branch. However, I argue that it's worth that extra effort:</p> <ul><li>The easier your PRs are to review, it's likely that the quicker you will get reviews.</li> <li>Reviewers are more likely to catch real issues if the changes are smaller, more modularised, and coherent.</li> <li>You can keep working on the next branch in the stack while you wait for reviews on earlier branches, so you're never blocked.</li></ul> <blockquote> <p>You can also make an argument that creating modular <em>commits</em> achieves the same thing, and I would agree. However, that generally requires reviewers to review your branches commit-by-commit, which I find people just don't do by default (especially as GitHub pushes you towards reviewing everything at once). Using stacked branches and stacked PRs plays relatively nicely with the \"defaults\" of GitHub, so I have found it to be more successful.</p> </blockquote> <p>Having said all that, <em>managing</em> stacked branches, is definitely harder work than using most of the default Git workflows. There's no substitute for getting comfortable with Git in general (I had my personal Git-epiphany after reading <a href=\"https://think-like-a-git.net/\">Think Like a Git</a>), but in this post I'll describe some of the core workflows I use when working with stacked branches.</p> <h2 id=\"working-with-stacked-branches\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-2/#working-with-stacked-branches\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Working with stacked branches</a></h2> <p>In the previous post, I mentioned various issues that you need to handle when working with stacked branches:</p> <ul><li>Reordering or amending commits within a stack</li> <li>Rebasing a stack of PRs after changes on <code>main</code></li> <li>Pushing a stack of rebased PRs</li> <li>Rebasing a stack after a PR is merged</li></ul> <p>I described various approaches to handling that first task <a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-1/#reordering-or-amending-commits-within-a-stack\">in the previous post</a>, and in this post I look at some of those remaining tasks.</p> <h2 id=\"rebasing-a-stack-of-prs-after-changes-on-main\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-2/#rebasing-a-stack-of-prs-after-changes-on-main\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Rebasing a stack of PRs after changes on <code>main</code></a></h2> <p>When you're working with stacked branches, you're inevitably working on longer-lived features. It's therefore inevitable that someone will merge something to master, and you'll need to either merge in those changes or rebase on top.</p> <blockquote> <p>Personally, I <em>never</em> merge <code>main</code> into my feature branches and <em>always</em> rebase my branches on top instead. The net result is essentially the same—the changes are reflected in your branch and you must handle any merge conflicts—but I find using merge creates a web of connections that's much harder to follow.</p> <p>That said, rebasing a branch <em>can</em> mean you must resolve more conflicts than you would with a merge. With a merge, you have one set of conflicts to merge and you're done. In a rebase, each commit is \"replayed\" on top of <code>main</code>, so you must resolve any conflicts for <em>each</em> commit, which will mean more conflicts to resolve if you have changed the conflicting code multiple times in different commits. Despite this, rebasing is still my preferred approach.</p> </blockquote> <p>Let's say you're working on the same <code>feature/*</code> stack as in my previous post. You currently have three branches in the stack, and are still working on it. Meanwhile, someone merges a PR to <code>main</code>, the commit <code>\"Another change\"</code> in the image below:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_05.png\" alt=\"The initial stack with 3 branches feature/part1, feature/part2, feature/part3\"></p> <p>You want to rebase your stack on top of <code>main</code> to ensure you handle any merge conflicts now, so that you can make a PR shortly.</p> <p>The important feature that makes this simple is <code>--update-refs</code>. <a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-is-easier-with-update-refs/\">I've written about <code>--update-refs</code> previously</a>, and mentioned it in passing in the previous post, but it's <em>crucial</em> for working with stacked branches. The reason why will become obvious shortly. For now, let's consider what we need to do.</p> <blockquote> <p>⚠️ I'm showing you the <em>hard</em> way, just to emphasize the benefits of <code>--update-refs</code>, so don't be put off. We'll look at the easy approach instead shortly.</p> </blockquote> <p>To rebase the <code>feature/*</code> stack on top of <code>main</code> <em>without</em> using <code>--update-refs</code>, we would need to:</p> <ul><li>Rebase all the commits in <code>feature/part-3</code> from <code>\"First sub-feature\"</code> to <code>\"Final sub-feature tweak\"</code> inclusive onto <code>main</code>.</li> <li>Force reset/move the <code>feature/part-1</code> to point to the appropriate commit in the rebased stack.</li> <li>Force reset/move the <code>feature/part-2</code> to point to the appropriate commit in the rebased stack.</li></ul> <p>Those final two points might surprise you if you're not very comfortable with rebasing, but <em>by default</em> this would be necessary. For example, if we step through this approach, first we would rebase all the commits in the stack:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> rebase main\n</code></pre></div> <p>This \"moves\" all the commits that are part of the stack onto <code>main</code>, but as you can see below, it leaves the <em>other</em> branches in the stack pointing to the same (old) commits as before:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_06.png\" alt=\"Result after performing a basic rebase\"></p> <p>We then have to <em>manually</em> move those branch references to the correct (new) commit. The easiest way to do this is by force-creating a commit with the same name at the new commit. For example:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># These SHA commits are taken from the new stack</span>\n<span class=\"token function\">git</span> branch <span class=\"token parameter variable\">--force</span> feature/part-2 ed46a50e2c2bdfa00c9c6582ef511fac5e3af98c\n<span class=\"token function\">git</span> branch <span class=\"token parameter variable\">--force</span> feature/part-1 80067aec4e77ffac22bf8e6dd33cb9838cb98e2f\n\n<span class=\"token comment\"># Alternatively, we could derive the correct commit as relative</span>\n<span class=\"token comment\"># references from the new feature/part-3 branch.</span>\n<span class=\"token comment\"># feature/part-3~2 means \"the second commit before feature/part-3\" for example</span>\n<span class=\"token function\">git</span> branch <span class=\"token parameter variable\">--force</span> feature/part-2 feature/part-3~2\n<span class=\"token function\">git</span> branch <span class=\"token parameter variable\">--force</span> feature/part-1 feature/part-3~3\n</code></pre></div> <p>After making this change, our stack has been cleanly rebased on top of <code>main</code>:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_07.png\" alt=\"The stack is now rebased on top of main\"></p> <p>So that approach <em>works</em> but it requires multiple commands, requires manually tailoring the commands depending on your stack and is easy to get wrong.</p> <p>\"Isn't there an easier way?\" I hear you cry!</p> <p>Yes, there is, and it's <code>--update-refs</code>. With <code>--update-refs</code>, Git will automatically \"fix\" those branch references itself, without you needing to do all those calculations yourself. First let's back to our original stack:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_05.png\" alt=\"The initial stack with 3 branches feature/part1, feature/part2, feature/part3\"></p> <p>We now need to run just one command:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> rebase main --update-refs\n</code></pre></div> <p>and we can jump straight to the final situation we wanted, with all the branches in the correct place:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_07.png\" alt=\"The stack is now rebased on top of main\"></p> <p>When you're working with stacked branches, <code>--update-refs</code> becomes practically a requirement, so that I basically never want to <em>not</em> use it. For that reason, I always enable <code>--update-refs</code> by default, across all my repositories:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> rebase.updateRefs <span class=\"token boolean\">true</span>\n</code></pre></div> <p>Enabling this by default means that you don't even need to pass <code>--update-refs</code> to your <code>rebase</code> commands, it will just be implicitly added, so rebasing a stack of PRs on top of <code>main</code> becomes as simple as rebasing a <em>single</em> branch, simply:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> rebase main\n</code></pre></div> <blockquote> <p>There are some rare cases where I <em>don't</em> want to use <code>--update-refs</code>. One example is if I have just created a \"backup\" of a branch by running <code>git branch my-backup</code>, before I do a risky rebase. In that case I use <code>--no-update-refs</code> to leave the backup branch un-touched.</p> </blockquote> <p>Once you have <code>--update-refs</code> in the mix, rebasing the stack of branches is as easy as rebasing a single branch, and the other branches just come along for the ride. Pushing that stack to a remote, however, isn't quite as easy.</p> <h3 id=\"pushing-a-stack-of-rebased-prs\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-2/#pushing-a-stack-of-rebased-prs\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Pushing a stack of rebased PRs</a></h3> <p>One of the realities of working with stacked branches is that you're going to be periodically rebasing, as your total stack of branches is likely going to live longer than the average small branch. And consequently, you're going to need to <em>push</em> that whole stack of branches periodically.</p> <p>Until recently, I didn't bother with anything particularly fancy for pushing these branches. I would simply call <code>git push origin --force-with-lease &lt;branch&gt;</code> for each branch I needed to push, something like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> push origin --force-with-lease feature/part-1<span class=\"token punctuation\">;</span>\n<span class=\"token function\">git</span> push origin --force-with-lease feature/part-2<span class=\"token punctuation\">;</span>\n<span class=\"token function\">git</span> push origin --force-with-lease feature/part-3<span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Pretty ugly, but I just lived with it 😅</p> <p>However, a question from a colleague about whether this could be made simpler, and <a href=\"https://github.com/andrewlock/blog-comments/discussions/75#discussioncomment-10737102\">a discussion in the comments of my <code>--update-refs</code></a> post made me look for a cleaner solution. After a bit of hacking around, I found <a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/\">a solution I'm pretty happy with</a>, which pushes the full stack of commits to a remote repository with a single command: <code>git push-stack</code>!</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> <span class=\"token function\">git</span> push-stack\nEnumerating objects: <span class=\"token number\">20</span>, done.\nCounting objects: <span class=\"token number\">100</span>% <span class=\"token punctuation\">(</span><span class=\"token number\">20</span>/20<span class=\"token punctuation\">)</span>, done.\nDelta compression using up to <span class=\"token number\">16</span> threads\nCompressing objects: <span class=\"token number\">100</span>% <span class=\"token punctuation\">(</span><span class=\"token number\">12</span>/12<span class=\"token punctuation\">)</span>, done.\nWriting objects: <span class=\"token number\">100</span>% <span class=\"token punctuation\">(</span><span class=\"token number\">18</span>/18<span class=\"token punctuation\">)</span>, <span class=\"token number\">1.61</span> KiB <span class=\"token operator\">|</span> <span class=\"token number\">1.61</span> MiB/s, done.\nTotal <span class=\"token number\">18</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>, reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, pack-reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>from <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nTo D:<span class=\"token punctuation\">\\</span>repos<span class=\"token punctuation\">\\</span>temp<span class=\"token punctuation\">\\</span>temp69\n + 540f580<span class=\"token punctuation\">..</span>.e12b308 feature/part-3 -<span class=\"token operator\">&gt;</span> feature/part-3 <span class=\"token punctuation\">(</span>forced update<span class=\"token punctuation\">)</span>\nTotal <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, pack-reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>from <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nTo D:<span class=\"token punctuation\">\\</span>repos<span class=\"token punctuation\">\\</span>temp<span class=\"token punctuation\">\\</span>temp69\n + 44a77b9<span class=\"token punctuation\">..</span>.98143f9 feature/part-2 -<span class=\"token operator\">&gt;</span> feature/part-2 <span class=\"token punctuation\">(</span>forced update<span class=\"token punctuation\">)</span>\nTotal <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, pack-reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>from <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nTo D:<span class=\"token punctuation\">\\</span>repos<span class=\"token punctuation\">\\</span>temp<span class=\"token punctuation\">\\</span>temp69\n + 834f474<span class=\"token punctuation\">..</span>.4480c40 feature/part-1 -<span class=\"token operator\">&gt;</span> feature/part-1 <span class=\"token punctuation\">(</span>forced update<span class=\"token punctuation\">)</span>\n</code></pre></div> <p>The above output shows that I had <code>feature/part-3</code> checked out, and when I ran the <code>git push-stack</code> command, it pushed all of the branches to the default remote, <code>origin</code>. <a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/\">I showed in a previous post</a> how I built this command up, so for now I'll just provide the Git alias configuration commands to run, so that you can create your own <code>push-stack</code> alias:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> alias.default-branch <span class=\"token string\">\"!git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@'\"</span>\n<span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> alias.merge-base-origin <span class=\"token string\">'!f() { git merge-base ${1-HEAD} origin/$(git default-branch); };f '</span>\n<span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> alias.stack <span class=\"token string\">'!f() { BRANCH=${1-HEAD}; MERGE_BASE=$(git merge-base-origin $BRANCH); git log --decorate-refs=refs/heads --simplify-by-decoration --pretty=format:\\\"%(decorate:prefix=,suffix=,tag=,separator=%n)\\\" $MERGE_BASE..$BRANCH; };f '</span>\n<span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> alias.push-stack <span class=\"token string\">'!f() { BRANCH=${1-HEAD};  git stack $BRANCH | xargs -I {} git push --force-with-lease origin {}; };f '</span>\n</code></pre></div> <p>This command makes it easy to push all the branches in your currently checked out stack to a remote. You can read more about the exact behaviour, assumptions, and options for <code>push-stack</code> <a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/\">in my previous post</a>. <code>git push-stack</code> is particularly useful when you've made changes somewhere in the middle of your stack, or you've just rebased it. No matter how many branches are in your stack, simply run <code>git push-stack</code> and they're all pushed to the remote.</p> <h3 id=\"rebasing-a-stack-after-a-pr-is-merged\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-2/#rebasing-a-stack-after-a-pr-is-merged\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Rebasing a stack after a PR is merged</a></h3> <p>If all is going to plan with your Git stack, each branch in your stack will be merged to <code>main</code> one at a time. Depending on how your repository is set up to merge (with or without a merge commit, with or without squashing), this could make it easier or harder to rebase your commits afterwards.</p> <p>Most people have the biggest problems rebasing a stack when a repository uses squashing to merge a PR. This is because Git no longer \"understands\" that a given branch is now part of the <code>main</code> branch.</p> <p>Let's say we have the following stack, which has already been pushed to the remote:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_11.png\" alt=\"The stack of branches prior to mere\"></p> <p>The first PR, for branch <code>feature/part-1</code>, has been approved, and you merge it. As per the repository's settings, the branch is squashed to a single commit when it's merged to <code>main</code>, and the remote branch <code>feature/part-1</code> is deleted. If you do a <code>git fetch</code>, the commit graph looks something like this:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_12.png\" alt=\"The stack of branches after running git fetch, after the feature branch is merged\"></p> <p>With <code>feature/part-1</code> merged, you now need to rebase the remainder of the stack on top of <code>origin/main</code>. Unfortunately, if you run simply <code>git rebase origin/main</code> then you'll be hit with a bunch of merge conflicts, as Git can't tell that the commits <code>\"First sub-feature\"</code> and <code>\"Update for first-feature\"</code> have been merged into a single commit, <code>\"feature/part-1\"</code>.</p> <p>To work around this you need to be more specific with your <code>rebase</code> command. You need to rebase all the commits between the top of the stack (<code>feature/part-3</code>) and <code>feature/part-1</code><em>onto</em> <code>origin/main</code>. The key to this rebase operation is the <code>--onto</code> option. Assuming you have checked out <code>feature/part-3</code>, you can run:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> rebase feature/part-1 <span class=\"token parameter variable\">--onto</span> origin/main\n</code></pre></div> <p>Assuming you have <code>--update-refs</code> enabled as I have previously encouraged, this moves the whole remainder of the stack for you:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">git</span> rebase feature/part-1 <span class=\"token parameter variable\">--onto</span> origin/main\nSuccessfully rebased and updated refs/heads/feature/part-3.\nUpdated the following refs with --update-refs:\n        refs/heads/feature/part-2\n</code></pre></div> <p>Leaving your local repository looking like this:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_13.png\" alt=\"The stack of branches after rebasing onto origin/main\"></p> <p>All that remains is to clean up by pushing the stack and cleaning up the now defunct <code>feature/part-1</code> branch:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> push-stack\n<span class=\"token comment\"># We have to use -D here to force delete the branch,</span>\n<span class=\"token comment\"># as Git won't see it as having been merged</span>\n<span class=\"token function\">git</span> branch <span class=\"token parameter variable\">-D</span> feature/part-1\n</code></pre></div> <p>The final result is that our local repository looks like this:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_14.png\" alt=\"The repository after rebasing the stack\"></p> <p>and we're ready to continue with our stack!</p> <p>Just to reiterate, the magic here is the use of <code>--onto</code> in <code>git rebase</code>. You just need to know two things:</p> <ul><li><code>&lt;base&gt;</code>: The \"bottom\" of the stack that you want to rebase. Can be a commit SHA or a branch. The <code>feature/part-1</code> branch in our example</li> <li><code>&lt;onto&gt;</code>: Where you want to rebase your stack onto. Typically <code>origin/main</code> or equivalent.</li></ul> <p>and then use this construct:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> rebase <span class=\"token operator\">&lt;</span>base<span class=\"token operator\">&gt;</span> <span class=\"token parameter variable\">--onto</span> <span class=\"token operator\">&lt;</span>onto<span class=\"token operator\">&gt;</span>\n</code></pre></div> <p>With that, I think we've covered the majority of complexities that occur when working with stacked branches. If there are any challenging Git gymnastics you think I've glossed over or missed, do let me know in the comments!</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-2/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this follow up post to my previous post about using stacked branches, I described how to handle some common scenarios. In particular, I described how to rebase a stack of branches after commits to the <code>main</code> branch, how to push a stack of rebased branches, and how to rebase a stack after one of your branches has been merged. These, coupled with <a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-1/\">making local changes</a> to branches, are the most common scenarios I encounter working with stacked branches. Hopefully the techniques I describe in this post help you to use stacked branches in your own work</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/working-with-stacked-branches-in-git-part-2/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/working-with-stacked-branches-in-git-part-1/",
      "Title": "Working with stacked branches in git (Part 1)",
      "PublishDate": "2025-06-17T09:00:00+00:00",
      "Summary": "In this post I describe why I like to use stacked branches and stacked PRs for larger features, and how I handle making changes to commits in the stack",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/git_stack_banner.jpg\" /><p>In this post (and the subsequent post) I describe the Git workflow that I typically use when I'm working on medium-to-large features. For these features I like to use stacked branches and stacked PRs, where each branch is a small unit of the work that can be reviewed, but where each branch builds on top of previous commits in the stack. In this post I describe the overall workflow I use, as we as some of the approaches I use to make working with stacked branches easier.</p> <h2 id=\"why-use-stacked-branches-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-1/#why-use-stacked-branches-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Why use stacked branches?</a></h2> <p>Stacked branches in Git refers to having multiple branches that depend on one another in a linear stack. Each of the commits in a branch in the stack build on the changes made in the previous branch. For example, in the Git diagram below, there's three branches in the stack:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_01.png\" alt=\"An example stack of branches\"></p> <p>In the example above:</p> <ul><li>Branch <code>stack/a</code> branches from commit <code>main2</code> and contains two commits: <code>a1</code> and <code>a2</code></li> <li>Branch <code>stack/b</code> is stacked on branch <code>stack/a</code> and contains one commit: <code>b1</code></li> <li>Branch <code>stack/c</code> is stacked on branch <code>stack/b</code> and contains two commits: <code>c1</code> and <code>c2</code></li></ul> <p>All three <code>stack/*</code> branches are related to the same general feature, with the subsequent branches building on top of the changes made in the previous branches. Now, given that all of the branches are related to the same overall feature, you might be thinking \"why not just have a single branch with 5 commits\"?</p> <p>My main argument is that using stacked branches makes it easier for people to review your changes in a PR. By creating a PR for each branch segment in the stack, the resulting PRs will be:</p> <ul><li>Smaller in scope. By definition each branch will contain smaller changes than the whole stack, so each branch will generally be smaller, and therefore easier to review.</li> <li>More coherent. The intention behind stacked branches is to keep each branch in the stack modular, which makes each branch easier to review than the whole stack.</li> <li>Signposting the thought behind the changes. By creating a stack of PRs, you can effectively <em>guide</em> people on how to review the code, especially as each branch will be accompanied with a PR description explaining the changes.</li></ul> <p>The above reasoning focuses very much on the experience of PR reviewers rather than the commit author. In many cases, creating a well curated stack of branches will be <em>more</em> work for the author than doing all the work in a single branch. However, I argue that it's worth that extra effort:</p> <ul><li>The easier your PRs are to review, it's likely that the quicker you will get reviews.</li> <li>Reviewers are more likely to catch real issues if the changes are smaller, more modularised, and coherent.</li> <li>You can keep working on the next branch in the stack while you wait for reviews on earlier branches, so you're never blocked.</li></ul> <blockquote> <p>You can also make an argument that creating modular <em>commits</em> achieves the same thing, and I would agree. However, that generally requires reviewers to review your branches commit-by-commit, which I find people just don't do by default (especially as GitHub pushes you towards reviewing everything at once). Using stacked branches and stacked PRs plays relatively nicely with the \"defaults\" of GitHub, so I have found it to be more successful.</p> </blockquote> <p>Having said all that, <em>managing</em> stacked branches, is definitely harder work than using most of the default Git workflows. There's no substitute for getting comfortable with Git in general (I had my personal Git-epiphany after reading <a href=\"https://think-like-a-git.net/\">Think Like a Git</a>), but in this post (and the next) I'll describe some of the core workflows I use when working with stacked branches.</p> <h2 id=\"working-with-stacked-branches\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-1/#working-with-stacked-branches\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Working with stacked branches</a></h2> <p>Given this is a post about stacked branches, I would be somewhat remis if I didn't mention <a href=\"https://graphite.dev/\">Graphite</a>. Until recently, Graphite was primarily focused on providing a really nice stacked branch workflow when you're working with GitHub. Of course, they've apparently pivoted to focus on AI now it seems (I'm shocked, <em>shocked</em> I tell you).</p> <blockquote> <p>I haven't personally used Graphite, because they didn't have a Windows client for the longest time, and even now they require you install <code>node</code> first (grmbl).</p> </blockquote> <p>If you're not interested in using Graphite, then you'll need to handle a bunch of common scenarios when you're developing locally using stacked branches and when you're pushing your branches and creating PRs.</p> <ul><li>Reordering or amending commits within a stack</li> <li>Rebasing a stack of PRs after changes on <code>main</code></li> <li>Pushing a stack of rebased PRs</li> <li>Rebasing a stack after a PR is merged</li></ul> <p>I discuss approaches to handling the first of these tasks in this post, and tackle the remainder in the subsequent post. In some cases I'll use the command line, while in others I'll use a GUI, such as the Git GUI elements in JetBrains' Rider. In both posts I assume that you're familiar with the basics of working with Git, such as committing files and checking out branches, whether that's via the command line or using a GUI.</p> <h2 id=\"reordering-or-amending-commits-within-a-stack\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-1/#reordering-or-amending-commits-within-a-stack\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Reordering or amending commits within a stack</a></h2> <p>Even when I'm working with stacked branches I will sometimes notice errors, omissions, or updates that I want to make to commits <em>earlier</em> in the stack. For example, imagine we're starting from this existing stack of three branches in the <code>feature/*</code> stack:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_02.png\" alt=\"The initial stack with 3 branches feature/part1, feature/part2, feature/part3\"></p> <p>While working on this stack I discover that I need to make a tweak in the first sub-feature code. There are multiple ways I handle this in practice, depending on the nature of the changes I want to make, though they all use interactive rebase in some way:</p> <ul><li>Commit to the <code>HEAD</code>, use interactive rebase, and reorder the commits</li> <li>Use <code>git absorb</code> and interactive rebase to fixup commits</li> <li>Interactive rebase, pause, edit and continue</li></ul> <p>There are multiple other options available, but these are the approaches I use most often when I'm specifically working with stacked branches. We'll look at each of these options in turn and how they work in practice.</p> <h3 id=\"commit-to-head-and-interactive-rebase\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-1/#commit-to-head-and-interactive-rebase\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Commit to <code>HEAD</code> and interactive rebase</a></h3> <p>The first approach simply uses a standard Git feature for rearranging commits: interactive rebase. This works best when the change you want to make is isolated from changes made in subsequent branches in the stack, so there's no merge-conflict risk.</p> <p>For example, we start by making the necessary change as an additional commit on the top of the stack i.e. on the currently checked-out branch at the <code>HEAD</code>. For our worked example, this adds the commit <code>\"Update for first feature\"</code> to the <code>HEAD</code> branch <code>feature/part-3</code>:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_03.png\" alt=\"The updated stack after adding a new feature commit to the HEAD\"></p> <p>We now need to \"move\" this commit down so that it's part of the branch <code>feature/part-1</code>. We could do this either with the command line or with a GUI. With the command line, we could use a command like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> rebase feature/part-1^1 <span class=\"token parameter variable\">-i</span> --update-refs\n</code></pre></div> <p>To explain this command, I'll break it down piece by piece</p> <ul><li><code>git rebase</code>: perform <a href=\"https://git-scm.com/docs/git-rebase\">a rebase operation</a>, which can be used to \"move\" and reorder commits</li> <li><code>git rebase feature/part-1</code>: rebase all the commits between the current <code>HEAD</code> and the branch <code>feature/part-1</code></li> <li><code>git rebase feature/part-1^1</code>: (note the <code>^1</code> suffix) rebase all the commits between the current <code>HEAD</code> and the <em>parent commit</em> of branch <code>feature/part-1</code></li> <li><code>-i</code>: perform an <em>interactive</em> rebase; more on that shortly.</li> <li><code>--update-refs</code>: \"move\" the branch pointers along with the commits they're currently pointing to when doing the rebase. You can read more about <code>--update-refs</code> <a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-is-easier-with-update-refs/\">in a previous post</a>.</li></ul> <p>When you run the interactive rebase command above, <code>git</code> opens an editor with a file that looks like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">pick 834f474 First sub-feature\nupdate-ref refs/heads/feature/part-1\n\npick 44a77b9 Second sub-feature\nupdate-ref refs/heads/feature/part-2\n\npick 0732570 Final sub-feature\npick 540f580 Final sub-feature tweak\npick c26fbac Update <span class=\"token keyword\">for</span> first feature\n\n<span class=\"token comment\"># Rebase 40967d0..c26fbac onto 40967d0 (7 commands)</span>\n<span class=\"token comment\"># </span>\n<span class=\"token comment\"># Commands:</span>\n<span class=\"token comment\"># p, pick &lt;commit&gt; = use commit</span>\n<span class=\"token comment\"># r, reword &lt;commit&gt; = use commit, but edit the commit message</span>\n<span class=\"token comment\"># e, edit &lt;commit&gt; = use commit, but stop for amending</span>\n<span class=\"token comment\"># s, squash &lt;commit&gt; = use commit, but meld into previous commit</span>\n<span class=\"token comment\"># ...</span>\n</code></pre></div> <p>This gives a textual representation of the commits in the stack. You're then free to rearrange, delete, reword, or perform a wide range of other operations on the commits. For this example, we simply need to rearrange the commits, and move the <code>pick c26fbac</code> commit, so that it appears just before <code>update-ref refs/heads/feature/part-1</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">pick 834f474 First sub-feature\n<span class=\"token comment\"># 👇 Move the commit here</span>\npick c26fbac Update <span class=\"token keyword\">for</span> first feature\nupdate-ref refs/heads/feature/part-1\n\npick 44a77b9 Second sub-feature\nupdate-ref refs/heads/feature/part-2\n\npick 0732570 Final sub-feature\npick 540f580 Final sub-feature tweak\n\n<span class=\"token comment\"># Rebase 40967d0..c26fbac onto 40967d0 (7 commands)</span>\n</code></pre></div> <p>Save the file, close it, and the git interactive rebase continues:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> <span class=\"token function\">git</span> rebase feature/part-1^1 <span class=\"token parameter variable\">-i</span> --update-refs\nSuccessfully rebased and updated refs/heads/feature/part-3.\nUpdated the following refs with --update-refs:\n        refs/heads/feature/part-1\n        refs/heads/feature/part-2\n</code></pre></div> <p>If you take a visual look at the result, you can see that the commit <code>\"Update for first feature\"</code> has moved from the top of the stack to being part of <code>feature/part-1</code>:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_04.png\" alt=\"The Update for first feature has moved to be part of feature/part-1\"></p> <p>This approach works well when the commit you want to add is self-contained and where the reordering won't cause merge-conflicts. Unfortunately, that's not always the case, and often it's not clear whether it's the case or not!</p> <h3 id=\"using-git-absorb-and-interactive-rebase\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-1/#using-git-absorb-and-interactive-rebase\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Using <code>git absorb</code> and interactive rebase</a></h3> <p><code>git-absorb</code> is a \"plugin\" for Git that can automatically create \"fixup!\" commits for use with interactive rebase. It's a port of Facebook's hg absorb tool, and automates creating commits that can be auto-squashed into previous commits.</p> <blockquote> <p>I discussed auto-squashing <a href=\"https://andrewlock.net/smoother-rebases-with-auto-squashing-git-commits/\">in a previous post</a>, and looked at <code>git-absorb</code> <a href=\"https://andrewlock.net/super-charging-git-rebase-with-git-absorb/\">in the subsequent post</a>. If you're not familiar with those tools I strongly recommend reading those posts, though I'll give a quick recap here.</p> </blockquote> <p><code>--autosquash</code> is a feature of Git's interactive rebase which can automatically rearrange commits during an interactive rebase, based on the commit names. For example, lets imagine you have the following stack of commits:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">pick a43f263 Add initial interfaces\npick a643ac3 Add base types\npick a08d5fa Add implementation\n</code></pre></div> <p>You make an additional commit, but you actually want to <em>amend</em> the commit <code>\"Add base types\"</code>. You <em>could</em> add a new commit to the <code>HEAD</code> and then during an interactive rebase you could manually move it to the correct position and change the command to <code>fixup</code>. However, if you use the special commit message <code>\"fixup! Add base types\"</code> (i.e. the target commit message with a <code>fixup!</code> prefix), then you can use the <code>--autosquash</code> feature to automatically move the commit to the correct place. The Rider GUI even has built-in support for generating these <code>fixup!</code> messages natively:</p> <p><img src=\"https://andrewlock.net/content/images/2023/git_autosquash_04.png\" alt=\"Rider showing a list of commits in the commit message dialog\"></p> <p>In this example, assuming you've added the message as expected, if you then run <code>git rebase main -i --autosquash</code>, the commit-list editor pops up with the <code>fixup!</code> commit correctly moved to the right place and changed to be <code>fixup</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">pick a43f263 Add initial interfaces\npick a643ac3 Add base types\nfixup 48009ba fixup<span class=\"token operator\">!</span> Add base types\npick a08d5fa Add implementation\n</code></pre></div> <p>Or if you're using the GUI, the same thing works in Rider (<a href=\"https://andrewlock.net/smoother-rebases-with-auto-squashing-git-commits/#enabling-autosquash-by-default\">if you enable <code>--autosquash</code> by default</a>):</p> <p><img src=\"https://andrewlock.net/content/images/2023/git_autosquash_06.png\" alt=\"Rider automatically handles autosquashing\"></p> <p>Hopefully it's clear why this all comes in handy when you're working with stacked branches. If you want to amend a commit that's earlier in the stack, you can create a <code>fixup!</code> commit, perform an interactive rebase, and the commit is fixed with little fanfare or issues.</p> <p>As I described <a href=\"https://andrewlock.net/super-charging-git-rebase-with-git-absorb/\">in my previous post</a>, <code>git absorb</code> makes all this even easier and more automated!</p> <p>Once you've <a href=\"https://andrewlock.net/super-charging-git-rebase-with-git-absorb/#installing-and-configuring-git-absorb\">installed <code>git-absorb</code></a>, you don't have to try to craft the <code>fixup!</code> messages yourself. Simply make whatever changes you need, stage them with <code>git add</code> and then run <code>git absorb</code>. <code>git-absorb</code> will figure out which of the previous commits need to be modified to incorporate your changes and generate the relevant <code>fixup!</code> commits. So to reiterate, you make your changes, and run:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> <span class=\"token function\">add</span> <span class=\"token builtin class-name\">.</span> <span class=\"token comment\"># Include all the files in fixup commits. Alternatively you can include a subset.</span>\n<span class=\"token function\">git</span> absorb <span class=\"token comment\"># Generate fixup commits using the default settings</span>\n</code></pre></div> <p><code>git-absorb</code> will work out which commits need amending, and commit additional <code>fixup!</code> commits:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">INFO committed, header: -1,1 +1,1, commit: 5395eafdbb2740dc76adb234b112914b491ffd44\nINFO committed, header: -1,1 +1,1, commit: eacb60be2235b621f50158c68ae7a5e61a313081\nINFO committed, header: -0,0 +1,1, commit: f5c5748a20bd6fa23b563844c1cddeeb683f1499\n</code></pre></div> <p>You can then run <code>git rebase main -i --autosquash</code> (or use a GUI as in the image below), and the commits are automatically moved to the right place:</p> <p><img src=\"https://andrewlock.net/content/images/2023/git_absorb_01.png\" alt=\"Using git absorb to create fixup commits\"></p> <p>I have obviously written multiple posts <a href=\"https://andrewlock.net/smoother-rebases-with-auto-squashing-git-commits/\">about <code>--autosquash</code></a> and <a href=\"https://andrewlock.net/super-charging-git-rebase-with-git-absorb/\"><code>git absorb</code> previously</a>, but I really want to highlight them here as they're key tools for me when I'm working on stacked branches. <code>--update-refs</code> falls in the same bucket; if you're working with stacked branches, you <em>really</em> need to <a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-is-easier-with-update-refs/\">take a look</a>. What's more, you probably want to enable <code>--update-refs</code> and <code>--autosquash</code> by default. You can do this by running:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> rebase.autosquash <span class=\"token boolean\">true</span>\n<span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> rebase.updateRefs <span class=\"token boolean\">true</span>\n</code></pre></div> <p>As I said at the start of the post, keeping a \"clean\" stack of commits and branches for PR reviewers is one of the big selling points of stacked branches, and these tools make it that much easier and lower overhead, so I strongly recommend giving them a try.</p> <h3 id=\"interactive-rebase-pause-and-continue\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-1/#interactive-rebase-pause-and-continue\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Interactive rebase, pause, and continue</a></h3> <p>Both of the approaches described about involve creating the edits at the <code>HEAD</code> and then doing an interactive rebase to move the commits to the \"correct\" place in the stack. This is often the lowest friction approach, but sometimes it can be more tricky.</p> <p>I have found this approach tends to fall down most when code has changed multiple times in the same stack of commits. If you're making some changes in <code>feature/part-1</code> for example, and then make <em>additional</em> changes in <code>feature/part-2</code>, but then subsequently realise you had a bug in the <code>feature/part-1</code> commit, it can be difficult to avoid merge conflicts. What's more it can ultimately just get very confusing!</p> <p>In this scenario, I sometimes like to use a \"replay\" approach using interactive rebase. With this approach, you start rebasing, and Git starts applying the commits, but then it pauses for you to make your changes. You can add commits or even amend existing commits before continuing. Git then continues applying the subsequent commits on top to rebase the rest of the stack.</p> <p>For an example, we'll go back to our <code>feature/</code> git stack:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_04.png\" alt=\"The Update for first feature has moved to be part of feature/part-1\"></p> <p>We have <code>feature/part-3</code> currently checked out, but we realise that we actually need to change something about the <code>\"First sub-feature\"</code> commit, and due to conflicts, the previous simpler approaches with <code>git absorb</code> etc won't work here. So instead, we opt for a rebase and pause approach.</p> <p>The first step is to initiate an interactive rebase, whether this is with the command line or an IDE:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> rebase <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">--root</span>\n</code></pre></div> <blockquote> <p>I'm rebasing from the <code>root</code> in the above example, but you can use any commit <em>prior</em> to the one you want to change in your stack.</p> </blockquote> <p>This opens the standard interactive git document in your editor of choice:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">pick 40967d0 First change\npick 834f474 First sub-feature\npick a6ad343 Update <span class=\"token keyword\">for</span> first feature\nupdate-ref refs/heads/feature/part-1\n\npick 21f86bc Second sub-feature\nupdate-ref refs/heads/feature/part-2\n\npick <span class=\"token number\">8715850</span> Final sub-feature\npick 2b95f7a Final sub-feature tweak\n\n<span class=\"token comment\"># Rebase 2b95f7a onto 160efe0 (8 commands)</span>\n<span class=\"token comment\">#</span>\n<span class=\"token comment\"># Commands:</span>\n<span class=\"token comment\"># p, pick &lt;commit&gt; = use commit</span>\n<span class=\"token comment\"># r, reword &lt;commit&gt; = use commit, but edit the commit message</span>\n<span class=\"token comment\"># e, edit &lt;commit&gt; = use commit, but stop for amending</span>\n</code></pre></div> <p>The command we're interested in here is <code>edit</code>. We simply change the command from <code>pick</code> to <code>edit</code>, and then <em>after</em> that commit has been applied, Git will pause the rebase:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">pick 40967d0 First change\n<span class=\"token comment\"># 👇 Change this one to edit</span>\nedit 834f474 First sub-feature\npick a6ad343 Update <span class=\"token keyword\">for</span> first feature\nupdate-ref refs/heads/feature/part-1\n<span class=\"token punctuation\">..</span>.\n</code></pre></div> <p>After saving and closing the file, git starts to rebase, but then pauses:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">Stopped at 834f474<span class=\"token punctuation\">..</span>.  First sub-feature\nYou can amend the commit now, with\n\n  <span class=\"token function\">git</span> commit <span class=\"token parameter variable\">--amend</span> \n\nOnce you are satisfied with your changes, run\n\n  <span class=\"token function\">git</span> rebase <span class=\"token parameter variable\">--continue</span>\n</code></pre></div> <p>At this point, I make the changes I need to, and commit them in one of two ways:</p> <ul><li><code>git commit -m \"Adding the extra changes\"</code></li> <li><code>git commit --amend --no-edit</code></li></ul> <p>In the first example, a new commit is created immediately after <code>\"First sub-feature\"</code>; in the second example, the <code>\"First sub-feature\"</code> commit is directly amended. Sometimes, I'll do a <code>git reset HEAD~</code> which will essentially <em>remove</em> the previous commit, but keeps the working directory the same. This can be useful if you want to \"see\" the changes made in the previous commit while you're working on your update.</p> <p>Once you've made all your changes and you're reading to continue rebasing, run <code>git rebase --continue</code>. You will likely need to deal with merge conflicts (that's why we took the replay approach after all), but once they're resolved, you should have the extra commit, <code>\"Adding the extra changes\"</code>, in the correct place:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_05.png\" alt=\"The extra commit has been included in part 1\"></p> <p>You're probably getting the impression that interactive rebase is always the answer when doing anything with stacked branches, and to some extent, I think it really is! In the next post we'll look at how it can help us with other common stacked branch scenarios, such as pushing the whole stack to a remote server, or rebasing the stack when one of the branches has been merged.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-part-1/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I discussed stacked branches and stacked PRs, and why I like to use them when working on any moderately hard feature. The main benefit is to reviewers of my PRs, who can more easily understand a cohesive set of changes, in manageable chunks. The main benefit to me is faster reviews, and I'm not blocked on changes before I keep working.</p> <p>I then showed some of the Git techniques I use when I need to make changes to a branch in the stack. In each case I use interactive rebase to make the changes, but whether I use <code>git-absorb</code>, simple commit reordering, or edit-and-continue depends on each case.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/working-with-stacked-branches-in-git-part-1/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/converting-an-xna-game-to-monogame/",
      "Title": "Converting a Microsoft XNA 3.1 game to MonoGame",
      "PublishDate": "2025-06-10T09:00:00+00:00",
      "Summary": "In this post I describe how I took a Microsoft XNA 3.1 game from 15 years ago and converted it to use MonoGame on .NET 8 in just a few hours",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/trash_banner.webp\" /><p>In this post I describe how I took a <a href=\"https://en.wikipedia.org/wiki/Microsoft_XNA\">Microsoft XNA Framework</a> 3.1 game, written over 15 years in 2009, and updated it to run using <a href=\"https://monogame.net/\">MonoGame</a>, on .NET 8, in just a few hours. This is a follow on from <a href=\"https://andrewlock.net/creating-your-first-sample-game-with-monogame/\">my previous post</a> in which I took a brief look at the history of XNA and MonoGame and the getting started story. This post continues on where that post left off, starting from the MonoGame sample app to describe the steps I took to port my XNA game to MonoGame.</p> <h2 id=\"background-porting-a-game-from-xna-to-monogame\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xna-game-to-monogame/#background-porting-a-game-from-xna-to-monogame\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Background: Porting a game from XNA to MonoGame</a></h2> <p>MonoGame was one of those technologies I had vaguely heard of, but never paid much attention to, and certainly didn't know any of the history or capabilities around it. It came to my attention a couple of weeks ago when James Montemagno and Frank Kruegar were talking about \"vibe coding a MonoGame game from scratch\" on an episode of <a href=\"https://www.mergeconflict.fm/457\">Merge Conflict</a>. When James mentioned that MonoGame was an implementation of XNA, it really piqued my interest.</p> <p>I was interested because back in 2009, when I was trying to decide whether to work on a PhD or get a job, I dabbled with the idea of getting into game development. I really didn't pursue the gaming side at all, but I worked on a small game as a way of trying it out, and sure enough I used the XNA framework! So I wondered: how easy would it be to port the game I wrote all those years ago to use MonoGame instead?</p> <p>As you'll see in this post, the answer is actually really quite easy. The main issues I ran into were due to the fact that the game I wrote targeted version 3.1 of the XNA framework (and .NET Framework 3.5!😮), whereas MonoGame is based on the 4.0 version of XNA.</p> <p>The game I wrote was a clone of \"Trash\", which was <a href=\"https://www.lemonamiga.com/games/details.php?id=2820\">a game I had for the Amiga 600</a> that I spent <em>hours</em> playing with my Dad when I was a kid:</p> <p><img src=\"https://andrewlock.net/content/images/2025/trash.png\" alt=\"Screenshot of Trash\"></p> <p>Trash was itself a shameless clone of Nintendo's <a href=\"https://en.wikipedia.org/wiki/Dr._Mario\">Dr. Mario</a>, so when I was learning the ropes, it seemed like a good game to clone to get my bearings. The end result was definitely <em>not</em> polished (including crudely built models and sprites using a copy of <a href=\"https://en.wikipedia.org/wiki/Autodesk_3ds_Max\">3DS Max</a> of…questionable provenance), but it worked:</p> <p><img src=\"https://andrewlock.net/content/images/2025/trash_02.webp\" alt=\"Screenshot of my Trash clone\"></p> <p>So that's the history of my Trash clone. I still had the files knocking around, and after I heard about MonoGame, I decided to give myself an evening to see if I could port the game to MonoGame. Not to actually <em>develop</em> the app or to do anything more with it; just to see if I <em>could</em> update it to MonoGame. I decided my general approach would be:</p> <ol><li>Get a basic MonoGame sample running locally.</li> <li>Replace the content of the MonoGame sample with my Trash source code.</li> <li>Fix any issues that arose.</li></ol> <p>I had no interest in distributing or improving the code. And I have to say, looking back at code I wrote 15 years ago was a horrifying experience 😂</p> <h2 id=\"creating-the-basic-monogame-sample\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xna-game-to-monogame/#creating-the-basic-monogame-sample\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Creating the basic MonoGame sample</a></h2> <p>As in my previous post, I started with the \"MonoGame Cross-Platform Desktop Application\" sample application and used <a href=\"https://devblogs.microsoft.com/dotnet/introducing-slnx-support-dotnet-cli/\">the new slnx format</a> for the solution file.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Create the new sln file</span>\ndotnet new sln\n<span class=\"token comment\"># Convert the sln file to a slnx file</span>\ndotnet sln migrate\n<span class=\"token comment\"># Delete the original sln file</span>\n<span class=\"token function\">rm</span> *.sln\n</code></pre></div> <p>Next I created a \"MonoGame Cross-Platform Desktop Application\" using the <code>mgdesktopgl</code> template:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token comment\"># Create the template in a \"Trash\" subfolder</span>\ndotnet new mgdesktopgl <span class=\"token operator\">--</span>output Trash\n<span class=\"token comment\"># Add the new project to the template</span>\ndotnet sln add <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>Trash/\n</code></pre></div> <p>If you run the app at this point, you'll get a Cornflower Blue \"game\":</p> <p><img src=\"https://andrewlock.net/content/images/2025/monogame_00.png\" alt=\"The default MonoGame sample 'game'\"></p> <p>This serves as the starting point for porting Trash.</p> <h2 id=\"porting-an-existing-xna-game-to-monogame\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xna-game-to-monogame/#porting-an-existing-xna-game-to-monogame\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Porting an existing XNA game to MonoGame</a></h2> <p>The MonoGame sample supports .NET 8 and targets the Microsoft XNA 4.0 API, but my game targeted XNA 3.1 and <em>.NET Framework 3.5</em>, as you can see from the (ugly, non-SDK) project file:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFrameworkVersion</span><span class=\"token punctuation\">&gt;</span></span>v3.5<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFrameworkVersion</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>XnaFrameworkVersion</span><span class=\"token punctuation\">&gt;</span></span>v3.1<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>XnaFrameworkVersion</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>As best as I can tell, the fact that my old app targets .NET Framework 3.5 really didn't factor in to the port much; the only issues I had were related to MonoGame using version 4.0 of the XNA API rather than 3.1.</p> <p>For the remainder of this post I'll walk through the steps I took updating the app</p> <h3 id=\"1-copying-the-files-across\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xna-game-to-monogame/#1-copying-the-files-across\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">1. Copying the files across</a></h3> <p>The first step was a basic one, I simply copied all the files across from the old project to the new one. That included both <em>.cs</em> files and all the content files like <em>.wav</em> sound files and <em>.png</em> sprite files. The only files I initially left out were:</p> <ul><li>The <em>.csproj</em> file. I used the MonoGame generated file instead.</li> <li>The <em>AssemblyInfo.cs</em> file. The assembly attributes in this file such as <code>[AssemblyTitle]</code> are generated automatically by the default SDK instead.</li></ul> <p>At this point I optimistically tried to build and… not quite.</p> <h3 id=\"2-fixing-3-1-to-4-0-conversion-issues\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xna-game-to-monogame/#2-fixing-3-1-to-4-0-conversion-issues\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">2. Fixing 3.1 to 4.0 conversion issues</a></h3> <p>After copying across the old files, I (amazingly) only had a single build error:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">Error CS1061 <span class=\"token builtin class-name\">:</span> <span class=\"token string\">'GraphicsDevice'</span> does not contain a definition <span class=\"token keyword\">for</span> <span class=\"token string\">'RenderState'</span>\nand no accessible extension method <span class=\"token string\">'RenderState'</span> accepting a first argument of\n<span class=\"token builtin class-name\">type</span> <span class=\"token string\">'GraphicsDevice'</span> could be found <span class=\"token punctuation\">(</span>are you missing a using directive or an\nassembly reference?<span class=\"token punctuation\">)</span>\n</code></pre></div> <p>A very quick googleing of the error led to <a href=\"https://stackoverflow.com/questions/44442303/monogame-whats-the-new-code-for-monogame-for-graphicsdevice\">this SO post</a> indicating that this was a breaking change in the move from XNA 3.1 to XNA 4.0: <code>RenderState</code> was removed in favour of <code>RasterizerState</code>, so to fix the build issue, I simply need to replace these calls. For example</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Before                                               👇</span>\n<span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> defaultUseScissorTest <span class=\"token operator\">=</span> spriteBatch<span class=\"token punctuation\">.</span>GraphicsDevice<span class=\"token punctuation\">.</span>RenderState<span class=\"token punctuation\">.</span>ScissorTestEnable<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// After                                                👇</span>\n<span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> defaultUseScissorTest <span class=\"token operator\">=</span> spriteBatch<span class=\"token punctuation\">.</span>GraphicsDevice<span class=\"token punctuation\">.</span>RasterizerState<span class=\"token punctuation\">.</span>ScissorTestEnable<span class=\"token punctuation\">;</span>\n</code></pre></div> <p>The fact that this was the only initial build error is a testament to Microsoft's general commitment to compatibility. But even more impressive in my eyes is how seamless MonoGame's support is for the XNA API. I didn't even have to rename any namespaces or anything, the code just compiled. Very neat.</p> <blockquote> <p>MonoGame doesn't actually support <em>all</em> the APIs include in XNA 4.0. Most notably, the <a href=\"https://github.com/MonoGame/MonoGame/issues/4311\"><code>.Storage</code></a> and <code>.Net</code> namespaces are not included. The storage and multi-platofrm APIs were deemed too tricky to port to be multiplatform in their original format.</p> </blockquote> <p>So with those changes the game compiled. Time to try running it!</p> <h3 id=\"3-fixing-the-content-pipeline\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xna-game-to-monogame/#3-fixing-the-content-pipeline\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">3. Fixing the content pipeline</a></h3> <p>Unfortunately, even though the game compiled, as soon as I ran it, it crashed with a <code>FileNotFound</code> exception:</p> <p><img src=\"https://andrewlock.net/content/images/2025/monogame_04.png\" alt=\"System.IO.FileNotFoundException: Could not find file 'D:\\repos\\TrashMonoGame\\artifacts\\bin\\Trash\\debug\\Content\\Audio\\Trash.xgs'.\"></p> <p>When the app is initializing, it attempts to create an instance of <code>AudioEngine</code>, but the file it's looking for, <code>Content\\Audio\\Trash.xgs</code> doesn't exist. The <em>.xgs</em> format is a XACT Game Studio file that contains the details of the audio files. This file is normally generated by the XNA content pipeline, but as far as I can tell, MonoGame doesn't use the same process.</p> <p>Rather than try to force MonoGame to use the <code>AudioEngine</code>, <code>WaveBank</code>, and <code>SoundBank</code> types that I was using originally, I decided it would make more sense to switch to <a href=\"https://docs.monogame.net/articles/getting_to_know/howto/audio/HowTo_PlayASound.html\">the \"typical\" MonoGame approach</a> to playing sound effects and music. In the simplest case this looks like the following:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\">SoundEffect</span> soundEffect <span class=\"token operator\">=</span> Content<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Load</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>SoundEffect<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path_to_sound.wav\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsoundEffect<span class=\"token punctuation\">.</span><span class=\"token function\">Play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Or for looping effects:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\">SoundEffect</span> effect <span class=\"token operator\">=</span> Content<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Load</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>SoundEffect<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path_to_sound.wav\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">SoundEffectInstance</span> instance <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span><span class=\"token function\">CreateInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ninstance<span class=\"token punctuation\">.</span>IsLooped <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\ninstance<span class=\"token punctuation\">.</span><span class=\"token function\">Play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>and for music:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\">Song</span> song <span class=\"token operator\">=</span> Content<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Load</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Song<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rock_loop_stereo.wav\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>MediaPlayer<span class=\"token punctuation\">.</span>State <span class=\"token operator\">!=</span> MediaState<span class=\"token punctuation\">.</span>Stopped<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    MediaPlayer<span class=\"token punctuation\">.</span><span class=\"token function\">Stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nMediaPlayer<span class=\"token punctuation\">.</span><span class=\"token function\">Play</span><span class=\"token punctuation\">(</span>song<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>In the example above, <code>Content</code> is an <a href=\"https://docs.monogame.net/api/Microsoft.Xna.Framework.Content.ContentManager.html\">instance of <code>ContentManager</code></a>, which relies on <a href=\"https://docs.monogame.net/articles/getting_to_know/howto/content_pipeline/\">the MonoGame content pipeline</a> to load content. This in turn relies on the MonoGame Content Builder (MGCB) tools to process the assets and make them available to the game at runtime.</p> <p>To run the MGCB content editor and to import all your assets, you can run the .NET tool that's <a href=\"https://andrewlock.net/creating-your-first-sample-game-with-monogame/#exploring-the-default-monogame-template\">installed as part of the manifest</a>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet mgcb-editor\n</code></pre></div> <p>This runs the graphical content editor that you can use to add content to MonoGame. You can open the <em>.mgcb</em> file that's included in the default template, add your content (<em>.wav</em> files and sprite textures etc), and build the pipeline.</p> <p><img src=\"https://andrewlock.net/content/images/2025/monogame_02.png\" alt=\"The MGCB Editor\"></p> <p>After adding all of the content, the MGCB editor managed to process <em>most</em> of the content, however there was one file in particular that it <em>couldn't</em> process: a <em>.xap</em> file. This file is an XACT Audio Project, which defines how audio content is handled and processed, but the <code>XactImporter</code> and <code>XactProcessor</code> it requires <a href=\"https://github.com/MonoGame/MonoGame/issues/2661\">is not supported in MonoGame yet</a>.</p> <p>Luckily, the <em>.xap</em> file is easily readable in a text editor, for example:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-json\"><code class=\"language-json\">Cue\n<span class=\"token punctuation\">{</span>\n    Name = Navigate;\n\n    Variation\n    <span class=\"token punctuation\">{</span>\n        Variation Type = <span class=\"token number\">3</span>;\n        Variation Table Type = <span class=\"token number\">1</span>;\n        New Variation on Loop = <span class=\"token number\">0</span>;\n    <span class=\"token punctuation\">}</span>\n\n    Sound Entry\n    <span class=\"token punctuation\">{</span>\n        Name = Navigate;\n        Index = <span class=\"token number\">1</span>;\n        Weight Min = <span class=\"token number\">0</span>;\n        Weight Max = <span class=\"token number\">255</span>;\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>Using this file as a basis, the MGCB editor to process the existing <em>.wav</em> files, and the <code>SoundEffect</code> and <code>SoundEffectInstance</code> types to load the sounds in the game, I replaced the previous sound handling with <a href=\"https://stackoverflow.com/questions/16289951/xna-monogame-is-there-an-alternative-to-xact\">the updated MonoGame approach</a>. With the sound loading issue fixed, I tried building and running the app again and…nope, still not quite there,</p> <h3 id=\"4-adding-a-missing-font\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xna-game-to-monogame/#4-adding-a-missing-font\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">4. Adding a missing font</a></h3> <p>The next issue I ran into actually was a broken build after using the MGCB editor to add all my content files. When trying to build I would get the following error:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-txt\"><code class=\"language-txt\">Narkisim Italic.spritefont: Error  : Processor 'FontDescriptionProcessor' had unexpected failure!. System.IO.FileNotFoundException: Could not find \"Narkisim\" font file.\n   at Microsoft.Xna.Framework.Content.Pipeline.Processors.FontDescriptionProcessor.Process(FontDescription input, ContentProcessorContext context) in /home/runner/work/MonoGame/MonoGame/MonoGame.Framework.Content.Pipeline/Processors/FontDescriptionProcessor.cs:line 67\n   at Microsoft.Xna.Framework.Content.Pipeline.ContentProcessor`2.Microsoft.Xna.Framework.Content.Pipeline.IContentProcessor.Process(Object input, ContentProcessorContext context) in /home/runner/work/MonoGame/MonoGame/MonoGame.Framework.Content.Pipeline/ContentProcessor.cs:line 60\n   at MonoGame.Framework.Content.Pipeline.Builder.PipelineManager.ProcessContent(PipelineBuildEvent pipelineEvent) in /home/runner/work/MonoGame/MonoGame/MonoGame.Framework.Content.Pipeline/Builder/PipelineManager.cs:line 846\nD:/repos/TrashMonoGame/Trash/Content/Fonts/Narkisim_16.spritefont\n</code></pre></div> <p>This shows that the MonoGame content builder couldn't process the <em>Narkisim_16.spritefont</em> content, because it can't find the <code>Narkisim</code> font that the spritefont is using. And sure enough, on my Windows 11 machine, the font isn't installed by default. As it turns out, that's because <code>Narkisim</code> is an optional font, that's installed as part of the Hebrew language pack.</p> <blockquote> <p>No, I'm not exactly sure why I chose to use a Hebrew font😅 I'm guessing it's because it was the closest match I could fine to the original Trash font.</p> </blockquote> <p>I could have chosen to use a different font, but instead I chose to simply <a href=\"https://learn.microsoft.com/en-us/windows/deployment/windows-missing-fonts?pivots=windows-11\">install the missing font</a> using Windows update. After installing <code>Narkisim</code>, the build finally worked!</p> <p>Unfortunately, we're not out of the woods yet.</p> <h3 id=\"5-fixing-the-rasterizerstate-behaviour\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xna-game-to-monogame/#5-fixing-the-rasterizerstate-behaviour\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">5. Fixing the <code>RasterizerState</code> behaviour</a></h3> <p>After installing the missing font, the game builds, and the splash screen even displays:</p> <p><img src=\"https://andrewlock.net/content/images/2025/monogame_01.webp\" alt=\"The Trash splash screen\"></p> <p>However, if you press any key as it says, the app immediately crashes with an exception:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-txt\"><code class=\"language-txt\">Unhandled exception. System.InvalidOperationException: You cannot modify a default rasterizer state object.\n   at Microsoft.Xna.Framework.Graphics.RasterizerState.ThrowIfBound()\n   at Microsoft.Xna.Framework.Graphics.RasterizerState.set_ScissorTestEnable(Boolean value)\n   at Trash.ScrollingFont.DrawScissored(GameTime gameTime) in D:\\repos\\TrashMonoGame\\Trash\\ScrollingObject.cs:line 250\n   at Trash.ScrollingFont.Draw(GameTime gameTime) in D:\\repos\\TrashMonoGame\\Trash\\ScrollingObject.cs:line 222\n   at Trash.CreditsScreen.Draw(GameTime gameTime) in D:\\repos\\TrashMonoGame\\Trash\\CreditsScreen.cs:line 96\n   at Microsoft.Xna.Framework.Game.SortingFilteringCollection`1.ForEachFilteredItem[TUserData](Action`2 action, TUserData userData)\n   at Trash.TrashGame.Draw(GameTime gameTime) in D:\\repos\\TrashMonoGame\\Trash\\TrashGame.cs:line 105\n   at Microsoft.Xna.Framework.Game.DoDraw(GameTime gameTime)\n   at Microsoft.Xna.Framework.Game.Tick()\n   at Microsoft.Xna.Framework.SdlGamePlatform.RunLoop()\n   at Microsoft.Xna.Framework.Game.Run(GameRunBehavior runBehavior)\n   at Program.&lt;Main&gt;$(String[] args) in D:\\repos\\TrashMonoGame\\Trash\\Program.cs:line 2\n</code></pre></div> <p>The mistake here is using code like this to enable \"<a href=\"https://learn.microsoft.com/en-us/windows/win32/direct3d9/scissor-test\">scissor testing</a>\":</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">spriteBatch<span class=\"token punctuation\">.</span>GraphicsDevice<span class=\"token punctuation\">.</span>RasterizerState<span class=\"token punctuation\">.</span>ScissorTestEnable <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Instead, you need to create a new <code>RasterizerState</code> object and set it on the <code>GraphicsDevice</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">spriteBatch<span class=\"token punctuation\">.</span>GraphicsDevice<span class=\"token punctuation\">.</span>RasterizerState <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> ScissorTestEnable <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>After making the change above, the game finally runs! But it doesn't quite run <em>correctly</em>…</p> <h3 id=\"6-fixing-the-scissor-test\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xna-game-to-monogame/#6-fixing-the-scissor-test\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">6. Fixing the scissor test</a></h3> <p>After the previous change, the app runs, but the \"scrolling object\" code that was setting <code>ScissorTestEnable=true</code> originally doesn't work as expected. The scrolling content is meant to be \"constrained\" by the pill bottle, but as you can see in the screenshot below, the scrolling text isn't constrained at all i.e. the scissor test isn't working.</p> <p><img src=\"https://andrewlock.net/content/images/2025/monogame_05.webp\" alt=\"The scrolling text is not constrained by the pill bottle\"></p> <p>The mistake I made in the code was attempting to set <code>RaterizerState</code> <em>after</em> calling <code>ResizedSpriteBatch.Begin()</code>. Instead, you must pass the <code>ResizedSpriteBatch</code> object into the <code>Begin()</code> call:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Pass the RaterizerState into the Begin() call</span>\nspriteBatch<span class=\"token punctuation\">.</span><span class=\"token function\">Begin</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">rasterizerState</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">RaterizerState</span> <span class=\"token punctuation\">{</span> ScissorTestEnable <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>And with that final change, the scissor test works as expected, and the game runs!</p> <p><img src=\"https://andrewlock.net/content/images/2025/monogame_06.webp\" alt=\"The scrolling text is correctly constrained and the game runs as expected\"></p> <p>And there we have it, the conversion of an XNA 3.1 game to MonoGame in just a couple of hours!</p> <p>As I said at the start of this post, the original Trash clone I wrote was just a proof of concept to try out the XNA framework, so it's very rough and ready. The graphics are clearly dubious at best, but the game contains all the gameplay elements of the original. I've put the code <a href=\"https://github.com/andrewlock/Trash\">on GitHub</a>, but I have no intention of developing it any further at this stage. I haven't even fixed the horrendous coding style I apparently had 15 years ago so don't judge me! 🙈</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-an-xna-game-to-monogame/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I describe how I took a 15 year old, .NET Framework 3.5 game built using Microsoft's XNA 3.1 framework, and updated it to use MonoGame instead. In <a href=\"https://andrewlock.net/creating-your-first-sample-game-with-monogame/\">the previous post</a> I described some of the history of MonoGame and explored the getting started template. By using that post as a starter, and copying in all my old files, I managed to convert my old codebase in just a few hours.</p> <p>I ran into a few issues during the conversion, mostly stemming from the fact that MonoGame targets the XNA 4.0 API, but most of the issues were fixable relatively easily. The main issue was the lack of <code>XactProcessor</code> support in MonoGame, so I resorted to rewriting the sound processing to use <code>SoundEffect</code> instead. Ultimately this didn't require too many changes, thanks to existing abstractions in my code. Once all the issues were fixed, the game ran great!</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/converting-an-xna-game-to-monogame/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/creating-your-first-sample-game-with-monogame/",
      "Title": "Creating your first sample game with MonoGame",
      "PublishDate": "2025-06-03T09:00:00+00:00",
      "Summary": "In this post I provide an introduction to MonoGame, looking at it's history, the requirements for building with MonoGame, and finally a first sample app.",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/mono_banner.webp\" /><p>In this post I provide an introduction to the <a href=\"https://monogame.net/\">MonoGame</a> framework. I start by looking at the history of MonoGame and the XNA framework and then show how to get started with MonoGame. Finally we take a look at a default sample app. In my next post I will show how I used MonoGame to port a Microsoft XNA game from 2009 to run on .NET 8 in just a few hours.</p> <h2 id=\"background-a-brief-history-of-microsoft-xna-and-monogame\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/creating-your-first-sample-game-with-monogame/#background-a-brief-history-of-microsoft-xna-and-monogame\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Background: A brief history of Microsoft XNA and MonoGame</a></h2> <p>Microsoft's XNA framework was first announced back in 2004 (and first released in preview in 2006) as a set of tools for building video games that would run on Windows and Xbox 360 (and later, Windows phone). The Microsoft XNA framework was originally based on .NET Framework 2.0 on Windows and <a href=\"https://en.wikipedia.org/wiki/.NET_Compact_Framework\">.NET Compact Framework</a> on Xbox 360, with this later being updated to support .NET Framework 3.5.</p> <p><img src=\"https://andrewlock.net/content/images/2025/Microsoft_XNA_logo.svg\" alt=\"The XNA logo\"></p> <p>The XNA framework was meant to provide an easy way of writing games that focused on the content, rather than having to think about all the minutia that would change between platforms. It had a big focus on indie games, where gameplay is the key attraction, rather than the focus being the highest performance or the best graphics. XNA didn't provide a full game engine, instead providing lower-level abstractions, as well as a collection of tools for building content-pipelines and such.</p> <p>Shortly after the XNA framework was released and was heavily promoted by Microsoft, a project called <a href=\"https://web.archive.org/web/20120620235417/http://www.monoxna.org/node/4\">Mono.XNA</a> was created. Much as <a href=\"https://en.wikipedia.org/wiki/Mono_(software)\">Mono</a> was intended as an open-source cross-platform version of .NET Framework, so Mono.XNA was conceived as an open-source cross-platform version of Microsoft XNA, enabling users to build games that would run on Windows, Mac, and Linux, using OpenGL for rendering. At around the same time, Bill Reiss started a project called <a href=\"https://web.archive.org/web/20090317075046/http://silversprite.codeplex.com:80/\">SilverSprite</a>, with the goal of running XNA games in the browser, using Silverlight 2.0, and later 3.0.</p> <p>In 2009 <a href=\"https://github.com/jalf\">José Antonio Leal de Farias</a>, <a href=\"https://monogame.net/presskit/#history\">started an open-source project</a> called <a href=\"https://web.archive.org/web/20140225023450/https://monogame.codeplex.com/releases/view/36738\">XNA.Touch</a>, with the goal of porting simple 2D XNA games to mobile. XNA.Touch used code primarily from SilverSprite and some parts from Mono.XNA to create a framework that enabled running XNA games on the iPhone. This culminated in 2010 with multiple games being released to the Apple App Store.</p> <p>In 2011, XNA.Touch was renamed to <a href=\"https://monogame.net/\">MonoGame</a>. MonoGame added support for Android, Mac, Linux, Windows (using OpenGL) in the same year; they added support for DirectX 11, Windows 8, and Windows 8 Phone in 2012; and then in 2013 they added support for the PlayStation 4. Today, MonoGame even supports PlayStation 5 and Nintendo Switch.</p> <figure> <picture> <img src=\"https://andrewlock.net/content/images/2025/mono_arch.png\"> </picture><figcaption>The architecture of the various MonoGame options, from <a href=\"https://monogame.net/\">MonoGame</a>.</figcaption></figure> <p>Today, MonoGame implements the Microsoft XNA 4.0 API. Just as for XNA, MonoGame provides the <em>building blocks</em> to build your own engine and tools, but it isn't quite an engine itself. It also provides a bunch of tools for working with content (similar to the tools XNA provided).</p> <h2 id=\"getting-started-with-monogame\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/creating-your-first-sample-game-with-monogame/#getting-started-with-monogame\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Getting started with MonoGame</a></h2> <p><a href=\"https://docs.monogame.net/articles/getting_started/index.html\">Getting started with MonoGame</a> is incredibly simple if you're already a .NET developer. There are basically only two steps:</p> <ol><li>Install the .NET 8 SDK (or newer)</li> <li>Install the MonoGame templates</li></ol> <p>I obviously already had the .NET 9 SDK installed, so all that remained was to install the MonoGame templates with:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet new <span class=\"token function\">install</span> MonoGame.Templates.CSharp\n</code></pre></div> <p>After installing the templates you have a bunch of templates available:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-txt\"><code class=\"language-txt\">The following template packages will be installed:\n   MonoGame.Templates.CSharp\n\nSuccess: MonoGame.Templates.CSharp::3.8.3 installed the following templates:\nTemplate Name                Short Name         Language  Tags\n---------------------------  -----------------  --------  -------------------------------------------------------------\nMonoGame 2D StartKit                          mg2dstartkit                [C#]        MonoGame/Games/Mobile/Android/iOS/Desktop/Windows/Linux/macOS\nMonoGame Android Application                  mgandroid                   [C#]        MonoGame/Games/Mobile/Android\nMonoGame Blank 2D StartKit                    mgblank2dstartkit           [C#]        MonoGame/Games/Mobile/Android/iOS/Desktop/Windows/Linux/macOS\nMonoGame Content Pipeline Extension           mgpipeline                  [C#]        MonoGame/Games/Extensions\nMonoGame Cross-Platform Desktop Application   mgdesktopgl                 [C#]        MonoGame/Games/Desktop/Windows/Linux/macOS\nMonoGame Game Library                         mglib                       [C#]        MonoGame/Games/Library\nMonoGame iOS Application                      mgios                       [C#]        MonoGame/Games/Mobile/iOS\nMonoGame Shared Library Project               mgshared                    [C#]        MonoGame/Games/Library\nMonoGame Windows Desktop Application          mgwindowsdx                 [C#]        MonoGame/Games/Desktop/Windows/Linux/macOS\n</code></pre></div> <p>MonoGame supports all the IDEs you would expect (Visual Studio, VS Code, and <a href=\"https://docs.monogame.net/articles/getting_started/2_choosing_your_ide_rider.html\">Rider</a>). I was just going to use the OpenGL-based application, so as far as I could tell, I didn't need to install any additional components. If you're using one of the other templates, then you may need to install additional components using Visual Studio or the dotnet CLI, <a href=\"https://docs.monogame.net/articles/getting_started/2_choosing_your_ide_visual_studio.html\">as described in the documentation</a>.</p> <p>With the templates installed, I set about creating my first MonoGame application.</p> <h2 id=\"creating-my-first-monogame-application\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/creating-your-first-sample-game-with-monogame/#creating-my-first-monogame-application\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Creating my first MonoGame application</a></h2> <p>Before creating the MonoGame project, I created a solution to hold the project. Just to try it out, I decided to use <a href=\"https://devblogs.microsoft.com/dotnet/introducing-slnx-support-dotnet-cli/\">the new slnx format</a> seeing as <a href=\"https://blog.jetbrains.com/dotnet/2024/10/04/support-for-slnx-solution-files/\">Rider supports it</a>.</p> <p>As far as I can tell, you can't create a slnx file <em>directly</em> using the .NET CLI, so I created a new sln file, and converted it instead:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Create the new sln file</span>\ndotnet new sln\n<span class=\"token comment\"># Convert the sln file to a slnx file</span>\ndotnet sln migrate\n<span class=\"token comment\"># Delete the original sln file</span>\n<span class=\"token function\">rm</span> *.sln\n</code></pre></div> <p>Next I created a \"MonoGame Cross-Platform Desktop Application\" using the <code>mgdesktopgl</code> template:</p> <p>Create the project</p> <div class=\"pre-code-wrapper\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token comment\"># Create the template in a \"MyGame\" subfolder</span>\ndotnet new mgdesktopgl <span class=\"token operator\">--</span>output MyGame\n<span class=\"token comment\"># Add the new project to the template</span>\ndotnet sln add <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>MyGame/\n</code></pre></div> <p>We now have our sample application. Before testing it out, let's take a look at some of the files it includes.</p> <h2 id=\"exploring-the-default-monogame-template\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/creating-your-first-sample-game-with-monogame/#exploring-the-default-monogame-template\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Exploring the default MonoGame template</a></h2> <p>We'll start by looking at the project template. As you can see below, the project is a .NET 8 app, which adds a couple of embedded resources for the app icon. It references two NuGet packages:</p> <ul><li><code>MonoGame.Framework.DesktopGL</code>—This is the \"main\" MonoGame NuGet package for the sample that includes the required implementation for creating a cross-platform desktop application based on OpenGL. There are other packages for other MonoGame targets.</li> <li><code>MonoGame.Content.Builder.Task</code>—<a href=\"https://nuget.info/packages/MonoGame.Content.Builder.Task\">This small package</a> contains MSBuild properties and tasks for running MonoGame's content pipeline.</li></ul> <div class=\"pre-code-wrapper\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Project</span> <span class=\"token attr-name\">Sdk</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Microsoft.NET.Sdk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>WinExe<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>OutputType</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>net8.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TargetFramework</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RollForward</span><span class=\"token punctuation\">&gt;</span></span>Major<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RollForward</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PublishReadyToRun</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PublishReadyToRun</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TieredCompilation</span><span class=\"token punctuation\">&gt;</span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TieredCompilation</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ApplicationManifest</span><span class=\"token punctuation\">&gt;</span></span>app.manifest<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ApplicationManifest</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ApplicationIcon</span><span class=\"token punctuation\">&gt;</span></span>Icon.ico<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ApplicationIcon</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PropertyGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>None</span> <span class=\"token attr-name\">Remove</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Icon.ico<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>None</span> <span class=\"token attr-name\">Remove</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Icon.bmp<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>EmbeddedResource</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Icon.ico<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>LogicalName</span><span class=\"token punctuation\">&gt;</span></span>Icon.ico<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>LogicalName</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>EmbeddedResource</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>EmbeddedResource</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Icon.bmp<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>LogicalName</span><span class=\"token punctuation\">&gt;</span></span>Icon.bmp<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>LogicalName</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>EmbeddedResource</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MonoGame.Framework.DesktopGL<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>3.8.*<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PackageReference</span> <span class=\"token attr-name\">Include</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MonoGame.Content.Builder.Task<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Version</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>3.8.*<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ItemGroup</span><span class=\"token punctuation\">&gt;</span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Target</span> <span class=\"token attr-name\">Name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>RestoreDotnetTools<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">BeforeTargets</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Restore<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Message</span> <span class=\"token attr-name\">Text</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Restoring dotnet tools<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">Importance</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>High<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Exec</span> <span class=\"token attr-name\">Command</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>dotnet tool restore<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Target</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Project</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre></div> <p>Another interesting point is the additional MSBuild target <code>RestoreDotnetTools</code> which runs <code>dotnet tool restore</code> just before restoring NuGet packages. This restores the various <code>mgcb</code> dotnet tools that are included as part of the manifest in <em>.config/dotnet-tools.json</em>. These are the MonoGame Content Builder (MGCB) tools which provide graphical and command-line tools for editing and optimising your content for processing:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"isRoot\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"tools\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"dotnet-mgcb\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.8.3\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"commands\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"mgcb\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"dotnet-mgcb-editor\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.8.3\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"commands\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"mgcb-editor\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"dotnet-mgcb-editor-linux\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.8.3\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"commands\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"mgcb-editor-linux\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"dotnet-mgcb-editor-windows\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.8.3\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"commands\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"mgcb-editor-windows\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"dotnet-mgcb-editor-mac\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.8.3\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"commands\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"mgcb-editor-mac\"</span> <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The manifest includes 5 different tools:</p> <ul><li><code>dotnet-mgcb</code>—<a href=\"https://www.nuget.org/packages/dotnet-mgcb\">The MonoGame Content Builder (MGCB) command line tool</a> is used for optimizing content for runtime use.</li> <li><code>dotnet-mgcb-editor</code>—<a href=\"https://www.nuget.org/packages/dotnet-mgcb-editor\">The MonoGame Framework Content Builder Editor (MGCB-Editor)</a> is a graphical tool used for editing your content projects ready for processing. There are Windows/Linux/Mac specific versions of the tool, but as far as I can tell, you can just run the generic tool.</li></ul> <p>Finally, we come to the code. The <em>Program.cs</em> file leverages all the modern .NET goodness to be just two lines:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> game <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">MyGame<span class=\"token punctuation\">.</span>Game1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ngame<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Finally, we can see the <code>Game1</code> class itself. This very simple example includes the basics—creating a <code>GraphicsDeviceManager</code> and a <code>SpriteBatch</code>—but mostly highlights the different stages in the XNA/MonoGame game loop that you should override to create your own game.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Xna<span class=\"token punctuation\">.</span>Framework</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Xna<span class=\"token punctuation\">.</span>Framework<span class=\"token punctuation\">.</span>Graphics</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Xna<span class=\"token punctuation\">.</span>Framework<span class=\"token punctuation\">.</span>Input</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token namespace\">MyGame</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Game1</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">Game</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">GraphicsDeviceManager</span> _graphics<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">SpriteBatch</span> _spriteBatch<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">Game1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _graphics <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">GraphicsDeviceManager</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Content<span class=\"token punctuation\">.</span>RootDirectory <span class=\"token operator\">=</span> <span class=\"token string\">\"Content\"</span><span class=\"token punctuation\">;</span>\n        IsMouseVisible <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Initialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// TODO: Add your initialization logic here</span>\n\n        <span class=\"token keyword\">base</span><span class=\"token punctuation\">.</span><span class=\"token function\">Initialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">LoadContent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _spriteBatch <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SpriteBatch</span><span class=\"token punctuation\">(</span>GraphicsDevice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// TODO: use this.Content to load your game content here</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">GameTime</span> gameTime<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>GamePad<span class=\"token punctuation\">.</span><span class=\"token function\">GetState</span><span class=\"token punctuation\">(</span>PlayerIndex<span class=\"token punctuation\">.</span>One<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Buttons<span class=\"token punctuation\">.</span>Back <span class=\"token operator\">==</span> ButtonState<span class=\"token punctuation\">.</span>Pressed <span class=\"token operator\">||</span> Keyboard<span class=\"token punctuation\">.</span><span class=\"token function\">GetState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsKeyDown</span><span class=\"token punctuation\">(</span>Keys<span class=\"token punctuation\">.</span>Escape<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">Exit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// TODO: Add your update logic here</span>\n\n        <span class=\"token keyword\">base</span><span class=\"token punctuation\">.</span><span class=\"token function\">Update</span><span class=\"token punctuation\">(</span>gameTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Draw</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">GameTime</span> gameTime<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        GraphicsDevice<span class=\"token punctuation\">.</span><span class=\"token function\">Clear</span><span class=\"token punctuation\">(</span>Color<span class=\"token punctuation\">.</span>CornflowerBlue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// TODO: Add your drawing code here</span>\n\n        <span class=\"token keyword\">base</span><span class=\"token punctuation\">.</span><span class=\"token function\">Draw</span><span class=\"token punctuation\">(</span>gameTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>Aside from some basic setup, the sample game essentially contains just two behaviours:</p> <ul><li>Listen for the <kbd>Escape</kbd> key on the keyboard, or the <kbd>Back</kbd> button on a keypad, and exit the game if they're pressed.</li> <li>Paint the colour Cornflower Blue as the game background.</li></ul> <p>And that's essentially all there is to it. You can run the template using <code>dotnet run</code>, or by pushing <kbd>F5</kbd> in your IDE. The resulting \"game\" just shows a blue screen until you hit exit:</p> <p><img src=\"https://andrewlock.net/content/images/2025/monogame_00.png\" alt=\"The default MonoGame sample 'game'\"></p> <p>And that's all there is to it. In the next post I'll show how I started from this sample to port a Microsoft XNA game from 2009 to run on .NET 8 in just a few hours.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/creating-your-first-sample-game-with-monogame/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I described a brief history of the Microsoft XNA framework and the creation of MonoGame as an open-source implementation of the Microsoft XNA 4.0 API. I then discussed the basic requirements for building a MonoGame Windows application: the .NET 8 SDK and the .NET CLI templates. Finally, we took a tour of the sample app to see the relevant NuGet packages, tools, and code that the sample uses. In the next post I'll show how I started from this sample to port a Microsoft XNA game to MonoGame in just a few hours.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/creating-your-first-sample-game-with-monogame/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/converting-a-docker-compose-file-to-aspire/",
      "Title": "Converting a docker-compose file to .NET Aspire",
      "PublishDate": "2025-05-27T09:00:00+00:00",
      "Summary": "In this post I describe how I converted the deployment method of the mailing-list manager lismonk from a docker-compose.yml file to an Aspire app host project",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/listmonk_banner.png\" /><p>In this post, I take a <em>docker-compose.yml</em> file for <a href=\"https://listmonk.app/\">the open-source mailing list manager listmonk</a>, and rewrite it to use .NET Aspire. Functionally, this results in the same app, but as an app directly modelled in .NET it's (theoretically) easier to both run the stack locally with your IDE <em>and</em> to generate \"publish\" artifacts for deploying the app. To prove the app is modelled as expected I subsequently <em>publish</em> the app again as a <em>docker-compose.yml</em> file, and compare the output.</p> <blockquote> <p>Note that I have only dabbled with Aspire, not used it in anger, and I haven't got my head around all of the intricacies yet. If you see something weird in this post—I'm not doing something in the best way, or something doesn't work as I <em>think</em> it does—please do leave a comment and correct me!</p> </blockquote> <p>I start by giving a high-level overview of .NET Aspire and why you might want to use it. I then describe the listmonk app, and show the docker-compose setup we're seeking to implement. Piece by piece, we'll convert the standard <em>docker-compose.yml</em> file to an Aspire app host. Finally, we'll add a publisher which allows aspire to generate a <em>docker-compose.yml</em> file <em>from</em> the app host project, and see how it compares to the original.</p> <h2 id=\"what-is-net-aspire-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-a-docker-compose-file-to-aspire/#what-is-net-aspire-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What is .NET Aspire?</a></h2> <p>According to <a href=\"https://learn.microsoft.com/en-us/dotnet/aspire/get-started/aspire-overview\">the documentation</a>:</p> <blockquote> <p>.NET Aspire provides tools, templates, and packages to help you build observable, production-ready apps. Delivered through NuGet packages, .NET Aspire simplifies common challenges in modern app development.</p> </blockquote> <p>The primary focus of .NET Aspire is the <em>local</em> development experience. It's intended to simplify the interconnections (and associated configuration) that are often required to connect various parts of your system.</p> <p>For example, most apps require a database. When you're working locally, maybe you spin up a PostgreSQL Docker container, or perhaps you rely on a local SQL Server installation. Either way, there are usernames, passwords, ports, connection strings, database names… all things that you need to feed both into the configuration of the database, but <em>also</em> into any apps and services that <em>use</em> the database.</p> <p>Inherently, this configuration isn't <em>hard</em>. After all, we've been doing it for decades. But it <em>is</em> annoying and somewhat error prone. What's more, if someone new starts trying to work on the same project, they have to decode all these requirements for running the app before they can get started. With .NET Aspire the goal is to simplify that process.</p> <p>.NET Aspire has many different parts to it, but at its core, it has an app host project. This is a .NET project which describes and models all the interconnections between your apps. This is where you declare that you need <em>this</em> database with <em>that</em> password, and so on.</p> <p>There's a lot more to .NET Aspire, especially if you're building .NET applications—you can ensure your .NET apps are automatically injected with connection strings, for example—but the app host <em>isn't</em> strictly tied to .NET. The app <em>itself</em> is .NET, but that's just the language for modelling the interconnections between services. It can be used to model <em>any</em> applications, very similar to how a <em>docker-compose.yml</em> file can model any docker-based applications.</p> <h2 id=\"what-is-listmonk-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-a-docker-compose-file-to-aspire/#what-is-listmonk-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What is listmonk?</a></h2> <p><a href=\"https://listmonk.app/\">Listmonk</a> is a self-hosted newsletter and mailing list manager. It doesn't handle sending emails itself, it relies on third-party services for that. Rather, listmonk handles designing email campaigns, managing subscribers, and performing analytics.</p> <p><img src=\"https://andrewlock.net/content/images/2025/lismonk.png\" alt=\"The listmonk app\"></p> <p>Listmonk is written in Go, using a Vue frontend with Buefy for UI, and is free and open source software licensed under AGPLv3. Being Go, you can run listmonk <a href=\"https://listmonk.app/docs/installation/#binary\">as a single binary</a>, but there's <a href=\"https://listmonk.app/docs/installation/#docker\">also a suggested <em>docker-compose.yml</em></a> for running the application.</p> <p>For this post, I'm not going to be looking into the listmonk app itself at all. All I'm interested in is whether it's possible to create a .NET aspire app host project for running listmonk using the same suggested setup as the docker-compose file.</p> <p>For reference, I'm using <a href=\"https://github.com/knadh/listmonk/blob/86f808bc77ccded66a42bc19d96ebbd8d5e199ff/docker-compose.yml\">the docker-compose file</a> at the time of the v5.0.1 release, reproduced below. This file only contains two services:</p> <ul><li><code>app</code>. The listmonk app itself, running as a docker container.</li> <li><code>db</code>. A PostgreSQL database, again running as a docker container.</li></ul> <p>There's a bunch of shared configuration between the two apps, some volumes and bind mounts, and various other docker-compose specific configuration. For the rest of the app we'll aim to convert this entirely to an Aspire app.</p> <p>For completeness, <a href=\"https://github.com/knadh/listmonk/blob/86f808bc77ccded66a42bc19d96ebbd8d5e199ff/docker-compose.yml\">this is the original <em>docker-compose.yml</em> file</a> we're converting:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">x-db-credentials</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;db-credentials</span>                             <span class=\"token comment\"># Use the default POSTGRES_ credentials if they're available or simply default to \"listmonk\"</span>\n  <span class=\"token key atrule\">POSTGRES_USER</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;db-user</span> listmonk                            <span class=\"token comment\"># for database user, password, and database name</span>\n  <span class=\"token key atrule\">POSTGRES_PASSWORD</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;db-password</span> listmonk\n  <span class=\"token key atrule\">POSTGRES_DB</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;db-name</span> listmonk\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># listmonk app</span>\n  <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> listmonk/listmonk<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> listmonk_app\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"9000:9000\"</span>                                           <span class=\"token comment\"># To change the externally exposed port, change to: $custom_port:9000</span>\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> listmonk\n    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> listmonk.example.com                            <span class=\"token comment\"># Recommend using FQDN for hostname</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>sh<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">-</span>c<span class=\"token punctuation\">,</span> <span class=\"token string\">\"./listmonk --install --idempotent --yes --config '' &amp;&amp; ./listmonk --upgrade --yes --config '' &amp;&amp; ./listmonk --config ''\"</span><span class=\"token punctuation\">]</span>\n                                                              <span class=\"token comment\"># --config (file) param is set to empty so that listmonk only uses the env vars (below) for config.</span>\n                                                              <span class=\"token comment\"># --install --idempotent ensures that DB installation happens only once on an empty DB, on the first ever start.</span>\n                                                              <span class=\"token comment\"># --upgrade automatically runs any DB migrations when a new image is pulled.</span>\n\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>                                              <span class=\"token comment\"># The same params as in config.toml are passed as env vars here.</span>\n      <span class=\"token key atrule\">LISTMONK_app__address</span><span class=\"token punctuation\">:</span> 0.0.0.0<span class=\"token punctuation\">:</span><span class=\"token number\">9000</span>\n      <span class=\"token key atrule\">LISTMONK_db__user</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*db-user</span>\n      <span class=\"token key atrule\">LISTMONK_db__password</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*db-password</span>\n      <span class=\"token key atrule\">LISTMONK_db__database</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*db-name</span>\n      <span class=\"token key atrule\">LISTMONK_db__host</span><span class=\"token punctuation\">:</span> listmonk_db\n      <span class=\"token key atrule\">LISTMONK_db__port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5432</span>\n      <span class=\"token key atrule\">LISTMONK_db__ssl_mode</span><span class=\"token punctuation\">:</span> disable\n      <span class=\"token key atrule\">LISTMONK_db__max_open</span><span class=\"token punctuation\">:</span> <span class=\"token number\">25</span>\n      <span class=\"token key atrule\">LISTMONK_db__max_idle</span><span class=\"token punctuation\">:</span> <span class=\"token number\">25</span>\n      <span class=\"token key atrule\">LISTMONK_db__max_lifetime</span><span class=\"token punctuation\">:</span> 300s\n      <span class=\"token key atrule\">TZ</span><span class=\"token punctuation\">:</span> Etc/UTC\n      <span class=\"token key atrule\">LISTMONK_ADMIN_USER</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>LISTMONK_ADMIN_USER<span class=\"token punctuation\">:</span><span class=\"token punctuation\">-</span><span class=\"token punctuation\">}</span>           <span class=\"token comment\"># If these (optional) are set during the first `docker compose up`, then the Super Admin user is automatically created.</span>\n      <span class=\"token key atrule\">LISTMONK_ADMIN_PASSWORD</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>LISTMONK_ADMIN_PASSWORD<span class=\"token punctuation\">:</span><span class=\"token punctuation\">-</span><span class=\"token punctuation\">}</span>   <span class=\"token comment\"># Otherwise, the user can be setup on the web app after the first visit to http://localhost:9000</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./uploads<span class=\"token punctuation\">:</span>/listmonk/uploads<span class=\"token punctuation\">:</span>rw                        <span class=\"token comment\"># Mount an uploads directory on the host to /listmonk/uploads inside the container.</span>\n                                                              <span class=\"token comment\"># To use this, change directory path in Admin -&gt; Settings -&gt; Media to /listmonk/uploads</span>\n\n  <span class=\"token comment\"># Postgres database</span>\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> postgres<span class=\"token punctuation\">:</span>17<span class=\"token punctuation\">-</span>alpine\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> listmonk_db\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"127.0.0.1:5432:5432\"</span>                                 <span class=\"token comment\"># Only bind on the local interface. To connect to Postgres externally, change this to 0.0.0.0</span>\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> listmonk\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">&lt;&lt;</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*db-credentials</span>\n    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"CMD-SHELL\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pg_isready -U listmonk\"</span><span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 10s\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 5s\n      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> volume\n        <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span> listmonk<span class=\"token punctuation\">-</span>data\n        <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span> /var/lib/postgresql/data\n\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">listmonk</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">listmonk-data</span><span class=\"token punctuation\">:</span>\n</code></pre></div> <p>Before we can get started on the conversion, we'll install the prerequisites for Aspire.</p> <h2 id=\"getting-started-with-aspire\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-a-docker-compose-file-to-aspire/#getting-started-with-aspire\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Getting started with Aspire</a></h2> <p>To work with Aspire, I first made sure I had <a href=\"https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/setup-tooling?tabs=windows&amp;pivots=dotnet-cli#install-net-aspire-prerequisites\">installed the prerequisites</a>:</p> <ul><li>.NET 9 SDK (you can also use .NET 8)</li> <li>Docker Desktop for Windows (you can also use other OCI runtimes like Podman)</li></ul> <p>It's <em>very</em> likely you already have those if you're a .NET developer, which is nice. I primarily used <a href=\"https://blog.jetbrains.com/dotnet/2024/02/19/jetbrains-rider-and-the-net-aspire-plugin/\">JetBrains Rider</a> to work on the app, but for this post I primarily use the .NET CLI.</p> <p>Once you have the prerequisites, it's best to install the Aspire project templates. This makes it easy to create new projects. Install the templates with <code>dotnet new install Aspire.ProjectTemplates</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ dotnet new <span class=\"token function\">install</span> Aspire.ProjectTemplates\nThe following template packages will be installed:\n   Aspire.ProjectTemplates\n\nSuccess: Aspire.ProjectTemplates::9.3.0 installed the following templates:\nTemplate Name                  Short Name              Language  Tags\n-----------------------------  ----------------------  --------  -------------------------------------------------------------------------------\n.NET Aspire App Host           aspire-apphost          <span class=\"token punctuation\">[</span>C<span class=\"token comment\">#]      Common/.NET Aspire/Cloud</span>\n.NET Aspire Empty App          aspire                  <span class=\"token punctuation\">[</span>C<span class=\"token comment\">#]      Common/.NET Aspire/Cloud/Web/Web API/API/Service</span>\n.NET Aspire Service Defaults   aspire-servicedefaults  <span class=\"token punctuation\">[</span>C<span class=\"token comment\">#]      Common/.NET Aspire/Cloud/Web/Web API/API/Service</span>\n.NET Aspire Starter App        aspire-starter          <span class=\"token punctuation\">[</span>C<span class=\"token comment\">#]      Common/.NET Aspire/Blazor/Web/Web API/API/Service/Cloud/Test/MSTest/NUnit/xUnit</span>\n.NET Aspire Test Project <span class=\"token punctuation\">(</span><span class=\"token punctuation\">..</span>.  aspire-mstest           <span class=\"token punctuation\">[</span>C<span class=\"token comment\">#]      Common/.NET Aspire/Cloud/Web/Web API/API/Service/Test/MSTest</span>\n.NET Aspire Test Project <span class=\"token punctuation\">(</span><span class=\"token punctuation\">..</span>.  aspire-nunit            <span class=\"token punctuation\">[</span>C<span class=\"token comment\">#]      Common/.NET Aspire/Cloud/Web/Web API/API/Service/Test/NUnit</span>\n.NET Aspire Test Project <span class=\"token punctuation\">(</span><span class=\"token punctuation\">..</span>.  aspire-xunit            <span class=\"token punctuation\">[</span>C<span class=\"token comment\">#]      Common/.NET Aspire/Cloud/Web/Web API/API/Service/Test/xUnit</span>\n</code></pre></div> <p>The template I wanted was <code>aspire-apphost</code>. This creates <em>just</em> the app host project, without creating associated .NET apps or class libraries. I created a new folder, and then created the new project inside it:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> LismonkAspire\n<span class=\"token builtin class-name\">cd</span> LismonkAspire\ndotnet new aspire-apphost\n</code></pre></div> <p>This created a .NET 9 Aspire 9.3 app host project. The <em>AppHost.cs</em> project contained the following code; effectively an empty app host project:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> DistributedApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nbuilder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>There's a bunch of additional files, but for now, this was what I was interested in, so I set about modelling the listmonk services in this file. I started with the PostgreSQL database, seeing as the listmonk app depends on it.</p> <h2 id=\"modelling-the-database-in-aspire\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-a-docker-compose-file-to-aspire/#modelling-the-database-in-aspire\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Modelling the database in Aspire</a></h2> <p>The base Aspire app host project includes the ability to <a href=\"https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/app-host-overview#built-in-resource-types\">model various resources</a>, such as executables, .NET apps, and docker containers. However there are also various <a href=\"https://learn.microsoft.com/en-us/dotnet/aspire/get-started/aspire-overview#net-aspire-integrations\"><em>integrations</em></a>, which are NuGet package \"plugins\", intended to simplify connecting to common services or platforms. There is just such a package for PostgreSQL.</p> <p>To install the integration, simply install <a href=\"https://www.nuget.org/packages/Aspire.Hosting.PostgreSQL#readme-body-tab\">the relevant NuGet package</a>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet <span class=\"token function\">add</span> package Aspire.Hosting.PostgreSQL\n</code></pre></div> <p>This installs v9.3.0 of the NuGet package in the project and makes the <code>AddPostgres()</code> extension method available. The section of the docker-compose we need to model is this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">x-db-credentials</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;db-credentials</span>                             <span class=\"token comment\"># Use the default POSTGRES_ credentials if they're available or simply default to \"listmonk\"</span>\n  <span class=\"token key atrule\">POSTGRES_USER</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;db-user</span> listmonk                            <span class=\"token comment\"># for database user, password, and database name</span>\n  <span class=\"token key atrule\">POSTGRES_PASSWORD</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;db-password</span> listmonk\n  <span class=\"token key atrule\">POSTGRES_DB</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;db-name</span> listmonk\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Postgres database</span>\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> postgres<span class=\"token punctuation\">:</span>17<span class=\"token punctuation\">-</span>alpine\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> listmonk_db\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"127.0.0.1:5432:5432\"</span>                                 <span class=\"token comment\"># Only bind on the local interface. To connect to Postgres externally, change this to 0.0.0.0</span>\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> listmonk\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">&lt;&lt;</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*db-credentials</span>\n    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"CMD-SHELL\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pg_isready -U listmonk\"</span><span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 10s\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 5s\n      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> volume\n        <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span> listmonk<span class=\"token punctuation\">-</span>data\n        <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span> /var/lib/postgresql/data\n</code></pre></div> <p>The first part of this, the <code>x-db-credentials</code> section, may be unfamiliar to you. It's a way of getting some \"code-reuse\" in YAML. I'm not going to go into it in detail here. For now, it's enough to know that the <code>db</code> service <em>effectively</em> has the following environment variables defined:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">POSTGRES_USER</span><span class=\"token punctuation\">:</span> listmonk\n  <span class=\"token key atrule\">POSTGRES_PASSWORD</span><span class=\"token punctuation\">:</span> listmonk\n  <span class=\"token key atrule\">POSTGRES_DB</span><span class=\"token punctuation\">:</span> listmonk\n</code></pre></div> <p>With that in mind, we'll now model this service in Aspire. I've opted for a close-to direct representation, with some exceptions, which I'll describe later. I've annotated the code below to explain what's going on:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> DistributedApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Create these values as secrets</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> postgresUser <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddParameter</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"db-user\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">secret</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> postgresPassword <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddParameter</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"db-password\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">secret</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Add a default for the database name </span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> postgresDbName <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddParameter</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"db-name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"listmonk\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">publishValueAsDefault</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Create these as variables to be used elsewhere</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dbPort <span class=\"token operator\">=</span> <span class=\"token number\">5432</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dbContainerName <span class=\"token operator\">=</span> <span class=\"token string\">\"listmonk_db\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Sets the POSTGRES_USER and POSTGRES_PASSWORD implicitly</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> db <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddPostgres</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"db\"</span><span class=\"token punctuation\">,</span> postgresUser<span class=\"token punctuation\">,</span> postgresPassword<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">port</span><span class=\"token punctuation\">:</span> dbPort<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithImage</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"postgres\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"17-alpine\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Ensure we use the same image as docker-compose</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithContainerName</span><span class=\"token punctuation\">(</span>dbContainerName<span class=\"token punctuation\">)</span> <span class=\"token comment\">// Use a fixed container name</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithLifetime</span><span class=\"token punctuation\">(</span>ContainerLifetime<span class=\"token punctuation\">.</span>Persistent<span class=\"token punctuation\">)</span> <span class=\"token comment\">// Don't tear-down the container when we stop Aspire</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithDataVolume</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"listmonk-data\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Wire up the PostgreSQL data volume</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"POSTGRES_DB\"</span><span class=\"token punctuation\">,</span> postgresDbName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Explicitly set this value, so that it's auto-created</span>\n</code></pre></div> <p>One big advantage of .NET Aspire over YAML is that creating \"variables\" to share in multiple places is simple and intuitive. Instead of having to create YAML \"anchors\" and reference them elsewhere, we simply create values and pass them around.</p> <p>What's more, by using <code>AddParameter()</code> we can declare that a value should be provided <em>externally</em>, as it is above for <code>db-user</code> and <code>db-password</code>. What's more, we can mark the fact that these should be secrets, so that if we publish our Aspire app, Aspire can handle the fact they contain sensitive data.</p> <p>There's a few things from the <em>docker-compose.yml</em> that <em>aren't</em> modelled in Aspire, namely the \"restart behaviour\" and the healthcheck. I left these out, as the <code>AddPostgres()</code> integration adds its own health check, and these are fundamentally specific to docker-compose; we'll look at them again later when we configure a Docker publisher.</p> <h2 id=\"modelling-the-app-in-aspire\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-a-docker-compose-file-to-aspire/#modelling-the-app-in-aspire\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Modelling the app in Aspire</a></h2> <p>With the database implemented, we move on to the listmonk app itself. This, again, is implemented as a Docker container, but there's no helpful integration or extension method for it; we'll have to model this one ourselves. Luckily, there's not much to configure; we're mostly just setting a bunch of environment variables, exposing the app over port 9000, and changing the command used to run the app:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// Optional initial super-user configuration</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> listmonkSuperUser <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddParameter</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"listmonk-admin-user\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">secret</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> listmonkSuperUserPassword <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddParameter</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"listmonk-admin-password\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">secret</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> publicPort <span class=\"token operator\">=</span> <span class=\"token number\">9000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// The port to access the app from the browser</span>\n\nbuilder<span class=\"token punctuation\">.</span><span class=\"token function\">AddContainer</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"listmonk\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"listmonk/listmonk\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">tag</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"latest\"</span><span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">.</span><span class=\"token function\">WaitFor</span><span class=\"token punctuation\">(</span>db<span class=\"token punctuation\">)</span> <span class=\"token comment\">// The app depends on the db, so wait for it to be healthy</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithHttpEndpoint</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">port</span><span class=\"token punctuation\">:</span> publicPort<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">9000</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Expose port 9000 in the container as \"publicPort\"</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithExternalHttpEndpoints</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// The HTTP endpoint should be publicly accessibly</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithArgs</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sh\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./listmonk --install --idempotent --yes --config '' &amp;&amp; ./listmonk --upgrade --yes --config '' &amp;&amp; ./listmonk --config ''\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithBindMount</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">source</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"./uploads\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">target</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/listmonk/uploads\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// mount the folder ./uploads on the host into the container </span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_app__address\"</span><span class=\"token punctuation\">,</span> <span class=\"token interpolation-string\"><span class=\"token string\">$\"0.0.0.0:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">publicPort<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// This points to the app itself (used in emails)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_db__user\"</span><span class=\"token punctuation\">,</span> postgresUser<span class=\"token punctuation\">)</span> <span class=\"token comment\">// Database connection settings</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_db__password\"</span><span class=\"token punctuation\">,</span> postgresPassword<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_db__database\"</span><span class=\"token punctuation\">,</span> postgresDbName<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_db__host\"</span><span class=\"token punctuation\">,</span> dbContainerName<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_db__port\"</span><span class=\"token punctuation\">,</span> dbPort<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_db__ssl_mode\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"disable\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_db__max_open\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"25\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_db__max_idle\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"25\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_db__max_lifetime\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"300s\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TZ\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Etc/UTC\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_ADMIN_USER\"</span><span class=\"token punctuation\">,</span> listmonkSuperUser<span class=\"token punctuation\">)</span> <span class=\"token comment\">// Optional super-user</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LISTMONK_ADMIN_PASSWORD\"</span><span class=\"token punctuation\">,</span> listmonkSuperUserPassword<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Most of the variables we set are values that are mirrored in the <code>db</code> configuration. Using variables means we can easily flow the values to both places, which highlights one of the benefits of Aspire.</p> <blockquote> <p>There's a number of things I'm fairly sure I'm not doing \"correctly\" here. For example, the <code>dbContainerName</code> and <code>dbPort</code>; I hard-coded those as variables when configuring the <code>db</code> service and re-used them here. Is that reasonable? Is that a problem if I (for example) later decide to run my PostgreSQL instance as a service instead of a Docker container? Probably, but that's always something I could address later I guess.</p> <p>Another example is the public port: I hardcoded it to <code>9000</code>, because that's what the docker-compose file does, but I would probably <em>like</em> to just be able to have Aspire choose the host port automatically and then have that flow through. That <em>almost</em> works, but I couldn't see an easy way to have it set the <code>LISTMONK_app__address</code> environment variable to include the host <code>0.0.0.0</code> the way I need it to, without manually creating an <code>EnvironmentCallbackAnnotation</code>. And that just got too ugly.</p> </blockquote> <p>Ignoring the caveats above, theoretically we've now converted the app and can take it for a spin!</p> <h2 id=\"testing-it-out\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-a-docker-compose-file-to-aspire/#testing-it-out\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Testing it out</a></h2> <p>Before we can run the app, we first need to set the values for the parameters we defined in our app host. Given that many of these are marked as secrets, we should probably do this using <a href=\"https://learn.microsoft.com/en-us/aspnet/core/security/app-secrets?view=aspnetcore-9.0&amp;tabs=windows\">user-secrets</a> when running locally. You can edit the user-secrets for your app host using the IDE, or alternatively, set the values using the command line. I opted for the latter, setting some \"super-secret\" values.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet user-secrets <span class=\"token builtin class-name\">set</span> <span class=\"token string\">\"Parameters:db-user\"</span> <span class=\"token string\">\"listmonk\"</span>\ndotnet user-secrets <span class=\"token builtin class-name\">set</span> <span class=\"token string\">\"Parameters:db-password\"</span> <span class=\"token string\">\"listmonk\"</span>\ndotnet user-secrets <span class=\"token builtin class-name\">set</span> <span class=\"token string\">\"Parameters:listmonk-admin-user\"</span> <span class=\"token string\">\"admin-user\"</span>\ndotnet user-secrets <span class=\"token builtin class-name\">set</span> <span class=\"token string\">\"Parameters:listmonk-admin-password\"</span> <span class=\"token string\">\"admin-password\"</span>\n</code></pre></div> <p>Note that the secrets are all nested under the <code>Parameters</code> key, by prefixing the values with <code>Parameters:</code>. We can now run the app. Either hit F5 in your IDE or type <code>dotnet run</code>, and the app starts up. The Aspire app host starts <a href=\"https://learn.microsoft.com/en-us/dotnet/aspire/fundamentals/dashboard/overview?tabs=bash\">the Aspire dashboard</a>, showing our apps. From there we can view the logs, environment, and various other aspects of our apps:</p> <p><img src=\"https://andrewlock.net/content/images/2025/listmonk_aspire.png\" alt=\"The Aspire dashboard for our listmonk app\"></p> <p>We can also see a link to our listmonk app at http://localhost:9000. Clicking the link opens the app, where we can login with our Admin username and password. And there we have it, our listmonk app, running in Aspire!</p> <p><img src=\"https://andrewlock.net/content/images/2025/listmonk_aspire_2.png\" alt=\"The listmonk app running in Aspire\"></p> <p>With the app modelled in Aspire, I decided to see what it would like if we went the other way: creating the <em>docker-compose.yml</em> file <em>from</em> the Aspire app host.</p> <h2 id=\"publishing-the-app-host-as-a-docker-compose-yml-file\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-a-docker-compose-file-to-aspire/#publishing-the-app-host-as-a-docker-compose-yml-file\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Publishing the app host as a docker-compose.yml file</a></h2> <p>My reason for re-creating the <em>docker-compose.yml</em> file was to see if the <em>generated</em> file looked the same as the <em>source</em> file. If so, then I could be pretty comfortable that Aspire was doing what I intended, at the modelling worked correctly. To do this, I needed to configure an Aspire <a href=\"https://learn.microsoft.com/en-us/dotnet/aspire/whats-new/dotnet-aspire-9.3#deployment--publish\"><em>publisher</em></a>.</p> <p>A publisher takes your Aspire app host and spits out a bunch of artifacts that can be used by other tools. This could be a <em>docker-compose.yml</em> file, which is what I wanted, but it could also be Kubernetes Helm charts, it could be Azure ARM/Bicep templates, or anything really. This part of the Aspire experience is less mature than the local-dev-loop, but with 9.3 it's looking much more promising.</p> <p>I started by installing the preview package of <a href=\"https://www.nuget.org/packages/Aspire.Hosting.Docker/9.3.0-preview.1.25265.20#readme-body-tab\">the <em>Aspire.Hosting.Docker</em> NuGet package</a>. This provides publishing capabilities for the app host:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet <span class=\"token function\">add</span> package Aspire.Hosting.Docker <span class=\"token parameter variable\">--version</span> <span class=\"token number\">9.3</span>.0-preview.1.25265.20\n</code></pre></div> <p>Next, we enable the publisher by adding the following to our app host:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddDockerComposeEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"docker-compose\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>That's all we <em>need</em> to do, but I decided to make a few tweaks to the app host, to ensure we more closely replicate the final docker-compose file.</p> <p>First, for the <code>listmonk</code> app, I used the <code>PublishAsDockerComposeService()</code> extension to add the <code>restart: unless-stopped</code> setting to the output <em>docker-compose.yml</em> file.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\">builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddContainer</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"listmonk\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"listmonk/listmonk\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">tag</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"latest\"</span><span class=\"token punctuation\">)</span> \n    <span class=\"token comment\">// ... other config not shown</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">PublishAsDockerComposeService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resource<span class=\"token punctuation\">,</span> service<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span>\n    <span class=\"token punctuation\">{</span>\n        service<span class=\"token punctuation\">.</span>Restart <span class=\"token operator\">=</span> <span class=\"token string\">\"unless-stopped\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Similarly, for the database service, I used the same method to set the <code>restart</code> setting and provide the same <code>healthcheck</code> as the original docker-compose file used:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> db <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddPostgres</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"db\"</span><span class=\"token punctuation\">,</span> postgresUser<span class=\"token punctuation\">,</span> postgresPassword<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">port</span><span class=\"token punctuation\">:</span> dbPort<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// ... other config not shown</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">PublishAsDockerComposeService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resource<span class=\"token punctuation\">,</span> service<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span>\n    <span class=\"token punctuation\">{</span>\n        service<span class=\"token punctuation\">.</span>Restart <span class=\"token operator\">=</span> <span class=\"token string\">\"unless-stopped\"</span><span class=\"token punctuation\">;</span>\n        service<span class=\"token punctuation\">.</span>Healthcheck <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            Interval <span class=\"token operator\">=</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span>\n            Timeout <span class=\"token operator\">=</span> <span class=\"token string\">\"5s\"</span><span class=\"token punctuation\">,</span>\n            Retries <span class=\"token operator\">=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n            StartPeriod <span class=\"token operator\">=</span> <span class=\"token string\">\"0s\"</span><span class=\"token punctuation\">,</span> \n            Test <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"CMD-SHELL\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pg_isready -U listmonk\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Note that these settings are <em>only</em> applied when <em>publishing</em> the app, they don't really make sense when running locally.</p> <p>To use the publisher it seems I needed to install <a href=\"https://learn.microsoft.com/en-gb/dotnet/aspire/whats-new/dotnet-aspire-9.2#-aspire-cli-preview\">the Aspire CLI</a>. This is still in preview at the moment, but I couldn't see a way of invoking the publisher without it:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ dotnet tool <span class=\"token function\">install</span> <span class=\"token parameter variable\">--global</span> aspire.cli <span class=\"token parameter variable\">--prerelease</span>\nYou can invoke the tool using the following command: aspire\nTool <span class=\"token string\">'aspire.cli'</span> <span class=\"token punctuation\">(</span>version <span class=\"token string\">'9.3.0-preview.1.25265.20'</span><span class=\"token punctuation\">)</span> was successfully installed.\n</code></pre></div> <p>With the tool installed you can run <code>aspire publish</code>, and the CLI will publish the app host as a <em>.env</em> file and a <em>docker-compose.yml</em> file:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-ps\"><code class=\"language-ps\">&gt; aspire publish -o publish\n🛠  Generating artifacts...\n                                           \n✔  Publishing artifacts ━━━━━━━━━━ 00:00:00\n\n👍  Successfully published artifacts to: D:\\repos\\ListmonkAspire\\publish\n</code></pre></div> <p>The files produced are shown below. First of all, we have the <em>.env</em> file, which is where all the parameters that we set in user-secrets are set when running in a docker-compose deployment:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token comment\"># Parameter db-user</span>\n<span class=\"token key attr-name\">DB_USER</span><span class=\"token punctuation\">=</span>\n\n<span class=\"token comment\"># Parameter db-password</span>\n<span class=\"token key attr-name\">DB_PASSWORD</span><span class=\"token punctuation\">=</span>\n\n<span class=\"token comment\"># Parameter db-name</span>\n<span class=\"token key attr-name\">DB_NAME</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">listmonk</span>\n\n<span class=\"token comment\"># Parameter listmonk-admin-user</span>\n<span class=\"token key attr-name\">LISTMONK_ADMIN_USER</span><span class=\"token punctuation\">=</span>\n\n<span class=\"token comment\"># Parameter listmonk-admin-password</span>\n<span class=\"token key attr-name\">LISTMONK_ADMIN_PASSWORD</span><span class=\"token punctuation\">=</span>\n</code></pre></div> <p>Then we have the <em>docker-compose.yml</em> itself. That file is reproduced below</p> <div class=\"pre-code-wrapper\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"docker.io/postgres:17-alpine\"</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"listmonk_db\"</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">POSTGRES_HOST_AUTH_METHOD</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"scram-sha-256\"</span>\n      <span class=\"token key atrule\">POSTGRES_INITDB_ARGS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"--auth-host=scram-sha-256 --auth-local=scram-sha-256\"</span>\n      <span class=\"token key atrule\">POSTGRES_USER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${DB_USER}\"</span>\n      <span class=\"token key atrule\">POSTGRES_PASSWORD</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${DB_PASSWORD}\"</span>\n      <span class=\"token key atrule\">POSTGRES_DB</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${DB_NAME}\"</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"5432:5432\"</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"volume\"</span>\n        <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/var/lib/postgresql/data\"</span>\n        <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"listmonk-data\"</span>\n        <span class=\"token key atrule\">read_only</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"aspire\"</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"unless-stopped\"</span>\n    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"CMD-SHELL\"</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"pg_isready -U listmonk\"</span>\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10s\"</span>\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5s\"</span>\n      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span>\n      <span class=\"token key atrule\">start_period</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0s\"</span>\n  <span class=\"token key atrule\">listmonk</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"listmonk/listmonk:latest\"</span>\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"sh\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"-c\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./listmonk --install --idempotent --yes --config '' &amp;&amp; ./listmonk --upgrade --yes --config '' &amp;&amp; ./listmonk --config ''\"</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">LISTMONK_app__address</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.0.0.0:9000\"</span>\n      <span class=\"token key atrule\">LISTMONK_db__user</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${DB_USER}\"</span>\n      <span class=\"token key atrule\">LISTMONK_db__password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${DB_PASSWORD}\"</span>\n      <span class=\"token key atrule\">LISTMONK_db__database</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${DB_NAME}\"</span>\n      <span class=\"token key atrule\">LISTMONK_db__host</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"listmonk_db\"</span>\n      <span class=\"token key atrule\">LISTMONK_db__port</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5432\"</span>\n      <span class=\"token key atrule\">LISTMONK_db__ssl_mode</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"disable\"</span>\n      <span class=\"token key atrule\">LISTMONK_db__max_open</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"25\"</span>\n      <span class=\"token key atrule\">LISTMONK_db__max_idle</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"25\"</span>\n      <span class=\"token key atrule\">LISTMONK_db__max_lifetime</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"300s\"</span>\n      <span class=\"token key atrule\">TZ</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Etc/UTC\"</span>\n      <span class=\"token key atrule\">LISTMONK_ADMIN_USER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${LISTMONK_ADMIN_USER}\"</span>\n      <span class=\"token key atrule\">LISTMONK_ADMIN_PASSWORD</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"${LISTMONK_ADMIN_PASSWORD}\"</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"9000:9000\"</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"bind\"</span>\n        <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/listmonk/uploads\"</span>\n        <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"D:\\\\repos\\\\blog-examples\\\\ListmonkAspire\\\\uploads\"</span>\n        <span class=\"token key atrule\">read_only</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"service_started\"</span>\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"aspire\"</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"unless-stopped\"</span>\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">aspire</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"bridge\"</span>\n<span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">listmonk-data</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"local\"</span>\n</code></pre></div> <p>There's a few cosmetic differences between this generated file and the original, but for the <em>most</em> part they seem functionally equivalent to me! With a bit more work I'm sure I could make them identical, but they're close-enough for me for this experiment. Overall, I'd say it was a success!</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/converting-a-docker-compose-file-to-aspire/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I described .NET Aspire and the open-source mailing-list manager <a href=\"https://listmonk.app/\">listmonk</a>. Listmonk provides a <em>docker-compose.yml</em> file as a suggested approach to deployment, and I wanted to see how easy it would be to convert the project to run as a .NET Aspire app host instead. The listmonk app runs a PostgreSQL docker container as the database and a separate Docker container as the main app.</p> <p>After the conversion, I used the Aspire CLI and the Docker publisher to export the Aspire app as a <em>docker-compose.yml</em> file, to see how close the conversion was. Overall I think the experiment was a success, though I'm sure there are things I could do better in the Aspire app (let me know in the comments if you have suggestions!)</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/converting-a-docker-compose-file-to-aspire/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/",
      "Title": "Pushing a whole stack of branches with a single Git command",
      "PublishDate": "2025-05-20T09:00:00+00:00",
      "Summary": "In this post I show how you can push push a whole stack of branches with a single command using a Git alias: git push-stack",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/push_stack_banner.webp\" /><p>In this post I show how you can push a whole stack of branches with a single command. This is particularly useful when you're working with stacked branches, and want to push all the branches in the stack at once. In this post I show the git aliases I have created that make doing this a single, simple command.</p> <h2 id=\"what-are-stacked-branches-\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/#what-are-stacked-branches-\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">What are stacked branches?</a></h2> <p>I'm a big fan of creating small git commits. <em>Especially</em> when you're creating a big feature. I like to create a \"story\" with my commits, adding bits of a larger feature commit by commit. The idea is to make it as simple as possible for <em>others</em> to review by walking through a commit at a time.</p> <p>As an extension to that, I often create separate PRs for each couple of commits in a feature. This, again, is to make it easier for people to review. GitHub's PR review pages really don't cope well with large PRs, even if you have \"incremental\" commits. Creating separate branches and PRs for each unit of functionality makes it easier for people to consume and follow the \"story\" of the commits.</p> <blockquote> <p>To be clear, creating small commits and PRs is often <em>harder</em> than just creating a big PR at the end. Nevertheless, I argue it's worth the effort. Small PRs are easier to review, therefore you're likely to get <em>better</em> reviews than for big commits. Also, it's just polite, as it optimizes the <em>reviewer's</em> time over your own.</p> </blockquote> <p>This approach, where you have lots of separate branches/PRs which build on top of one another, is called <em>stacked branches/PRs</em>. This makes sense when you think of the git graph of the branches: each branch is \"stacked\" on top of the previous one.</p> <p>For example, in the following repo I have 6 commits as part of a feature, <code>feature-xyz</code>, and have broken those down into 3 logical units, with a branch for each. I can then create a PR for each of those branches:</p> <p><img src=\"https://andrewlock.net/content/images/2022/stacked_branches.png\" alt=\"Stacked branches in a feature\"></p> <p>For the first PR, for branch <code>andrew/feature-xyz/part-1</code>, I would create a PR requesting to merge to <code>dev</code> (in this example). For the second PR, for branch <code>andrew/feature-xyz/part-2</code>, I would create a PR requesting to merge to <code>andrew/feature-xyz/part-1</code>, and for the <code>part-3</code> branch the PR would request to merge into <code>part-2</code>:</p> <p><img src=\"https://andrewlock.net/content/images/2022/stacked_branches_02.png\" alt=\"Stacked branches in a feature\"></p> <p>Each PR only includes the commits specific to that branch, which makes for a much nicer reviewing experience.</p> <p>I firmly believe working with stacked branches for medium-large features is the best way to work if you're optimizing for reviewability and for remaining unblocked. However, there's no denying working with stacked branches requires more Git finesse than typical single-branch workflows.</p> <h2 id=\"pushing-a-whole-stack-of-branches-with-a-single-git-command\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/#pushing-a-whole-stack-of-branches-with-a-single-git-command\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Pushing a whole stack of branches with a single Git command</a></h2> <p>One of the pain points typically comes up shortly after espousing stacked branches to my teammates. The problem is how to handle the case where you have made changes to multiple branches in a stack and you want to push <em>all</em> the branches in the stack to a remote repository. The sad truth is that I didn't have a good way until recently. My solution was simply doing something like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> push origin --force-with-lease feature/part-1<span class=\"token punctuation\">;</span>\n<span class=\"token function\">git</span> push origin --force-with-lease feature/part-2<span class=\"token punctuation\">;</span>\n<span class=\"token function\">git</span> push origin --force-with-lease feature/part-3<span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Pretty ugly, but I just lived with it 😅</p> <blockquote> <p>Actually, I had an alias <code>pof</code> configured to make this <em>slightly</em> less ugly using <code>git config --global alias.pof \"push origin --force-with-lease\"</code>. That way I could type <code>git pof &lt;BRANCH&gt;</code> which at least saves some key strokes.</p> </blockquote> <p>Recently I was working with a particularly big stack of branches, and this finally irritated me enough to actually look into it further. This was also partially inspired <a href=\"https://github.com/andrewlock/blog-comments/discussions/75#discussioncomment-12876326\">by a discussion</a> in the comments section of <a href=\"https://andrewlock.net/working-with-stacked-branches-in-git-is-easier-with-update-refs/\">another of my posts</a> about stacked branches.</p> <p>As a toy example, imagine we have the following stack of branches:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_08.png\" alt=\"The initial stack of branches\"></p> <p>The repository currently has the following features:</p> <ul><li>The default branch is <code>main</code> and it tracks the default branch on the default remote <code>origin</code>.</li> <li>There is a stack of three branches that make up the <code>feature/</code> stack.</li> <li>The <code>feature/*</code> stack has not yet been pushed to the upstream.</li> <li>The <code>feature/part-3</code> branch at the top of the stack is currently checked out.</li></ul> <p>Our goal is to push <code>feature/part-1</code>, <code>feature/part-2</code>, and <code>feature/part-3</code> to the remote repository as simply as possible. We'll start by running <code>git stack</code>, which simply lists <em>which</em> branches are part of the stack and will be pushed:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">git</span> stack\nfeature/part-3\nfeature/part-2\nfeature/part-1\n</code></pre></div> <p>This lists all of the branches to be pushed. This looks correct, so we run <code>git push-stack</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">git</span> push-stack\nEnumerating objects: <span class=\"token number\">5</span>, done.\nCounting objects: <span class=\"token number\">100</span>% <span class=\"token punctuation\">(</span><span class=\"token number\">5</span>/5<span class=\"token punctuation\">)</span>, done.\nDelta compression using up to <span class=\"token number\">20</span> threads\nCompressing objects: <span class=\"token number\">100</span>% <span class=\"token punctuation\">(</span><span class=\"token number\">5</span>/5<span class=\"token punctuation\">)</span>, done.\nWriting objects: <span class=\"token number\">100</span>% <span class=\"token punctuation\">(</span><span class=\"token number\">5</span>/5<span class=\"token punctuation\">)</span>, <span class=\"token number\">1.14</span> KiB <span class=\"token operator\">|</span> <span class=\"token number\">1.14</span> MiB/s, done.\nTotal <span class=\"token number\">5</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">4</span><span class=\"token punctuation\">)</span>, reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, pack-reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>from <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nTo C:<span class=\"token punctuation\">\\</span>repos<span class=\"token punctuation\">\\</span>temp<span class=\"token punctuation\">\\</span>temp69\n * <span class=\"token punctuation\">[</span>new branch<span class=\"token punctuation\">]</span>      feature/part-3 -<span class=\"token operator\">&gt;</span> feature/part-3\nTotal <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, pack-reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>from <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nTo C:<span class=\"token punctuation\">\\</span>repos<span class=\"token punctuation\">\\</span>temp<span class=\"token punctuation\">\\</span>temp69\n * <span class=\"token punctuation\">[</span>new branch<span class=\"token punctuation\">]</span>      feature/part-2 -<span class=\"token operator\">&gt;</span> feature/part-2\nTotal <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>delta <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>, pack-reused <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span>from <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nTo C:<span class=\"token punctuation\">\\</span>repos<span class=\"token punctuation\">\\</span>temp<span class=\"token punctuation\">\\</span>temp69\n * <span class=\"token punctuation\">[</span>new branch<span class=\"token punctuation\">]</span>      feature/part-1 -<span class=\"token operator\">&gt;</span> feature/part-1\n</code></pre></div> <p>This pushes all the branches in our stack to our remote repository:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_09.png\" alt=\"All the branches pushed to the remote repository\"></p> <p>And voila, it works! This basic functionality is what I've wanted for a long time, but there's a few extra \"features\" available for the command too.</p> <h2 id=\"pushing-part-of-the-stack-with-git-push-stack\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/#pushing-part-of-the-stack-with-git-push-stack\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Pushing part of the stack with <code>git push-stack</code></a></h2> <p>We'll look in detail at how <code>git push-stack</code> is implemented shortly, but first we'll look at a couple of different ways you can use it.</p> <p>The simplest approach, <code>git push-stack</code> you've already seen, and is used when you already have the top-most branch of the stack checked out, <code>feature/part-3</code> in the example above.</p> <p>If you only wanted to push <em>part</em> of the stack, you have a couple of options</p> <ul><li>Checkout the top-most branch of the stack that you wish to push, or</li> <li>Explicitly specify the top-most branch of the stack that you wish to push</li></ul> <p>For example, imagine you <em>only</em> want to push <code>feature/part-1</code> and <code>feature/part-2</code>, but not <code>feature/part-3</code>. You have two options:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Checkout feature/part-2</span>\n<span class=\"token function\">git</span> checkout feature/part-2\n<span class=\"token comment\"># List the branches that would be pushed</span>\n<span class=\"token function\">git</span> stack\n<span class=\"token comment\"># Prints:</span>\n<span class=\"token comment\">#  feature/part-2</span>\n<span class=\"token comment\">#  feature/part-1</span>\n</code></pre></div> <p>Alternatively:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Specify the top-most branch explicitly</span>\n<span class=\"token function\">git</span> stack feature/part-2\n<span class=\"token comment\"># Prints:</span>\n<span class=\"token comment\">#  feature/part-2</span>\n<span class=\"token comment\">#  feature/part-1</span>\n</code></pre></div> <p>Which of these options is the most useful depends on what you're doing: if you already have <code>feature/part-2</code> checked out, then the first option is easier, otherwise use the second option.</p> <blockquote> <p>I have used <code>git stack</code> here simply to show what <em>would</em> be pushed. Using <code>git push-stack</code> instead would directly push these branches instead of just printing the branches to push.</p> </blockquote> <p>Another aspect to acknowledge is that <code>git stack</code> \"intelligently\" determines which branches to push based on the remote default branch, i.e. <code>origin/main</code>. So for example, imagine we now have the following local repository:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_10.png\" alt=\"The repository after feature/part-1 was merged\"></p> <p>In this scenario</p> <ul><li>The <code>feature/part-1</code> branch was merged to <code>origin/main</code> (likely via a pull request) and the remote branch has been deleted.</li> <li>The local branch <code>feature/part-1</code> has not yet been deleted.</li> <li>The local default branch <code>main</code> has not yet been updated to track <code>origin/main</code>.</li></ul> <p>If we run <code>git stack</code> in this scenario then we get the expected results:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># We don't need to specify the head branch, but specified for clarity</span>\n<span class=\"token function\">git</span> stack feature/part-3\n<span class=\"token comment\"># Prints:</span>\n<span class=\"token comment\">#  feature/part-3</span>\n<span class=\"token comment\">#  feature/part-2</span>\n</code></pre></div> <p>We only push the branches which <em>need</em> to be, and we rely on the <em>remote</em> default branch <code>origin/main</code> for that calculation, rather than the <em>local</em> default <code>main</code>.</p> <p>I'm sure there's more features we could add, but this has been sufficient for me for now. For the rest of the post, I'll describe how you can create the <code>git push-stack</code> command.</p> <h2 id=\"implementing-git-push-stack\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/#implementing-git-push-stack\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Implementing <code>git push-stack</code></a></h2> <p>The <code>git-push stack</code> command consists of four steps:</p> <ul><li>Calculate the default branch (<code>origin/main</code>).</li> <li>Calculate the \"merge base\" of the stack i.e. the bottom of the stack.</li> <li>Calculate the branches between the merge base and the tip of the stack.</li> <li>Push all the branches calculated in the previous step.</li></ul> <p>To make things easy to test and more composable, I created a Git alias for each of these steps, so we'll walk through them one by one.</p> <h3 id=\"assumptions\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/#assumptions\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Assumptions</a></h3> <p>Before we start, it's worth highlighting a couple of assumptions in these aliases:</p> <ul><li><code>origin</code> is the default remote.</li> <li>You cloned the local repository from a remote, <em>or</em> you have set the default remote branch.</li></ul> <p>These days, the default remote is almost always called <code>origin</code>, but it <em>could</em> be called <code>upstream</code> or anything else. In the aliases I provide here, I assume that you're using <code>origin</code>. Tweaking these to assume <code>origin</code> by default but allowing you to change them would not be difficult, but I haven't done it, for simplicity.</p> <blockquote> <p>That's mostly because I dislike having more than one positional-parameter—would it be <code>git stack origin mybranch</code> or <code>git stack mybranch origin</code>🤔—and it's not at all easy to have <em>named</em> parameters in git aliases as far as I know. I'm happy to share updated scripts if this is something you <em>do</em> want.</p> </blockquote> <p>The second point won't <em>normally</em> be a problem. If you cloned a repository from GitHub for example, then you're probably fine. However, if the remote does <em>not</em> set it for some reason, you can set the default branch using:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> remote set-head origin <span class=\"token parameter variable\">--auto</span>\n</code></pre></div> <p>I discuss this more in the following section, so let's look at the various steps we need to create the <code>git push-stack</code> command.</p> <h3 id=\"calculating-the-default-branch\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/#calculating-the-default-branch\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Calculating the default branch</a></h3> <p>When you create a new Git repository, whether locally or on GitHub, you need to specify the default branch. This was <code>master</code> for a long time, but these days it's typically <code>main</code>. Technically though it could be anything. Rather than make assumptions, I have a command that tries to determine the <em>actual</em> default branch used by the remote repository.</p> <blockquote> <p>This isn't revelatory, a lot of people creating custom Git aliases create a similar alias. I most recently saw this approach in <a href=\"https://haacked.com/archive/2025/04/17/git-gone/\">a post by Phil Haack</a>.</p> </blockquote> <p>When you clone a repository, Git automatically checks out the \"default\" branch (unless you explicitly specify a different branch). Git creates a <code>symbolic-ref</code> in the local repository at <code>refs/remotes/origin/HEAD</code> to point to the default branch of the remote. This ref is updated based on what the remote defines as its <code>HEAD</code>—for GitHub, that’s the branch shown as \"default\" in the UI.</p> <p>You can read the value of this reference with <code>git symbolic-ref refs/remotes/origin/HEAD</code> which prints the remote reference:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">git</span> symbolic-ref refs/remotes/origin/HEAD\nrefs/remotes/origin/main\n</code></pre></div> <p>We only need the final <code>main</code> part of the output, so we create an alias to extract that using <code>sed</code>. I call the alias <code>git default-branch</code>, and define it like this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">alias</span><span class=\"token punctuation\">]</span></span>\n    <span class=\"token key attr-name\">default-branch</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">!git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@'</span>\"</span>\n</code></pre></div> <p>If you run this in a repository it should print the remote you expect:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">git</span> default-branch\nmain\n</code></pre></div> <p>In some cases, you <em>may</em> get an error when you run this:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">fatal: ref refs/remotes/origin/HEAD is not a symbolic ref\n</code></pre></div> <p>This indicates that the default branch for <code>origin</code> hasn't been set. This generally won't happen if you cloned the repository from GitHub, but it could happen if you have only setup the repository locally, or for some configurations. To fix it, run:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> remote set-head origin <span class=\"token parameter variable\">--auto</span>\n</code></pre></div> <p>This queries the remote and updates the local symbolic link to point to the correct branch. Now we know the default remote branch, we can calculate the <code>merge-base</code> for the stack</p> <h3 id=\"calculating-the-merge-base-for-the-stack\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/#calculating-the-merge-base-for-the-stack\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Calculating the <code>merge-base</code> for the stack</a></h3> <p>Per the documentation, the <code>merge-base</code> between two commits is:</p> <blockquote> <p>…the best common ancestor(s) between two commits to use in a three-way merge. One common ancestor is <strong>better</strong> than another common ancestor if the latter is an ancestor of the former. A common ancestor that does not have any better common ancestor is a <strong>best common ancestor</strong>, i.e. a <strong>merge base</strong>.</p> </blockquote> <p>I think <code>merge-base</code> is easiest to visualize, so considering this simple graph:</p> <div class=\"pre-code-wrapper\"><pre><code>         o---o---o---B---o---o---C\n        /\n---o---1---o---o---o---o---o---A\n</code></pre></div> <p>The merge base of commits <code>A</code> and <code>B</code> is marked <code>1</code>. Similarly, the merge base of commits <code>A</code> and <code>C</code> is <code>1</code>. The merge base of <code>B</code> and <code>C</code> is is <code>B</code>.</p> <p>When we're calculating our stack, we don't want to require that you've already rebased your stack on top of <code>origin/main</code>, so instead we need to calculate the <code>merge-base</code> between the top-most branch of our stack and the default branch. Luckily Git already has the <code>git merge-base</code> command that does this for us:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> merge-base <span class=\"token operator\">&lt;</span>commit<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&gt;</span> <span class=\"token operator\">&lt;</span>commit<span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>&gt;</span> \n</code></pre></div> <p>We define an alias called <code>merge-base-origin</code> that runs the above command using the <code>default-branch</code> and <em>either</em> the <code>HEAD</code> (for the currently-checked branch) or a parameter specified by the caller, which prints out the commit. For example, if we had checked out branch <code>C</code> and <code>A</code> was <code>origin/main</code>, then <code>git merge-base-origin</code> would print out the SHA of commit <code>1</code></p> <p>The Git configuration below shows the <code>merge-base-origin</code> command, and how we embed a call to the <code>git default-branch</code> alias in there:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">alias</span><span class=\"token punctuation\">]</span></span>\n    <span class=\"token key attr-name\">merge-base-origin</span> <span class=\"token punctuation\">=</span><span class=\"token value attr-value\">\"<span class=\"token inner-value\">!f() { git merge-base ${1-HEAD} origin/$(git default-branch); };f </span>\"</span>\n</code></pre></div> <p>An interesting part of this command is the bash <code>${1-HEAD}</code>. This says:</p> <ul><li>If there is a user-supplied parameter, place it here.</li> <li>If not, use <code>HEAD</code>.</li></ul> <p>That means we can do things like:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Use HEAD and origin/main</span>\n$ <span class=\"token function\">git</span> merge-base-origin\n7257e92c016e017fc95e763302ac31c32d78c2b8\n\n<span class=\"token comment\"># Use feature/part-2 and origin/main</span>\n$ <span class=\"token function\">git</span> merge-base-origin feature/part-2\n7257e92c016e017fc95e763302ac31c32d78c2b8\n</code></pre></div> <p>The next step is the hard one: listing all the branches between the merge-base and our target branch.</p> <h3 id=\"listing-the-branches\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/#listing-the-branches\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Listing the branches</a></h3> <p>The next step, listing all the branches to push, is the tricky part, and I was <em>heavily</em> inspired <a href=\"https://github.com/andrewlock/blog-comments/discussions/75#discussioncomment-12876326\">by the discussion</a> on my previous post! The general approach is to use <code>git log</code> to list all the branches between two commits, but it requires quite a bit of playing with the format. I'll build it up bit-by-bit in this section to get to the final command.</p> <p>We start by running <code>git log --pretty=%D</code> and passing in the two commits we want to compare (manually set to <code>HEAD</code> and <code>main</code> at the moment for simplicity). I'm running these commands on the repository we saw previously:</p> <p><img src=\"https://andrewlock.net/content/images/2025/gitstack_10.png\" alt=\"The repository after feature/part-1 was merged\"></p> <p>The <code>%D</code> format ensures that for each commit, we only print out the references pointed to:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">git</span> log <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>%D main<span class=\"token punctuation\">..</span>HEAD\nHEAD -<span class=\"token operator\">&gt;</span> feature/part-3, origin/feature/part-3\n\norigin/feature/part-2, feature/part-2\norigin/main, origin/HEAD, feature/part-1\n\n</code></pre></div> <p>OK, you can see the outline of what we need there. There's a lot of extra noise by way of the <em>remote</em> branches (<code>origin/feature/part-3</code> etc) and the <code>HEAD</code>, plus empty commits, but it's a good start.</p> <p>We'll start by getting rid of the empty lines. We can do that using <code>--simplify-by-decoration</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">git</span> log <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>%D --simplify-by-decoration main<span class=\"token punctuation\">..</span>HEAD\nHEAD -<span class=\"token operator\">&gt;</span> feature/part-3, origin/feature/part-3\norigin/feature/part-2, feature/part-2\norigin/main, origin/HEAD, feature/part-1\n</code></pre></div> <p>Great. Now we need to get rid of the remote references and the <code>HEAD</code>. We'll use <code>--decorate-refs</code> for that, and specify only the refs we care about, local branches:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token variable\">$git</span> log <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>%D --simplify-by-decoration --decorate-refs<span class=\"token operator\">=</span>refs/heads main<span class=\"token punctuation\">..</span>HEAD\nfeature/part-3\nfeature/part-2\nfeature/part-1\n</code></pre></div> <p>Perfect! This almost looks perfect, but there's a slight issue that's not obviously apparent. We can see this if we create another branch:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Just for clarity</span>\n<span class=\"token function\">git</span> checkout feature/part-3\n<span class=\"token comment\"># Create a new branch on the same commit as feature/part-3</span>\n<span class=\"token comment\"># but don't add any commits</span>\n<span class=\"token function\">git</span> branch feature/part-4\n</code></pre></div> <p>If we run the above command again, we get:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">git</span> log <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>%D --simplify-by-decoration --decorate-refs<span class=\"token operator\">=</span>refs/heads main<span class=\"token punctuation\">..</span>HEAD\nfeature/part-4, feature/part-3\nfeature/part-2\nfeature/part-1\n</code></pre></div> <p>This shows the problem: the <code>%D</code> pretty format places the two branches on the same line, separated by a comma. We want each branch to be listed on its own line, so we define our own pretty format instead, using <code>%n</code> as the separator to place each branch on its own line.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">git</span> log <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>format:<span class=\"token string\">\"%(decorate:prefix=,suffix=,tag=,separator=%n)\"</span> --simplify-by-decoration --decorate-refs<span class=\"token operator\">=</span>refs/heads main<span class=\"token punctuation\">..</span>HEAD\nfeature/part-4\nfeature/part-3\nfeature/part-2\nfeature/part-1\n</code></pre></div> <p>And there we have it, success! All that remains is to update the hardcoded <code>main</code> and <code>HEAD</code> to support providing a specific branch, and to calculate the <code>merge-base</code> dynamically, and our alias is complete.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">alias</span><span class=\"token punctuation\">]</span></span>\n  <span class=\"token key attr-name\">stack</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"!f() { \\</span>\n    <span class=\"token key attr-name\">BRANCH</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">${1-HEAD}; \\</span>\n    <span class=\"token key attr-name\">MERGE_BASE</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">$(git merge-base-origin $BRANCH); \\</span>\n    <span class=\"token key attr-name\">git log --decorate-refs</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">refs/heads --simplify-by-decoration --pretty=format:\\\"%(decorate:prefix=,suffix=,tag=,separator=%n)\\\" $MERGE_BASE..$BRANCH; \\</span>\n  };f \"\n</code></pre></div> <p>For simplicity, I separated the <code>BRANCH</code> and <code>MERGE_BASE</code> variables out. As in the <code>merge-base-orgin</code> alias, <code>BRANCH</code> is defined as either <code>HEAD</code> or the user-provided branch. <code>MERGE_BASE</code> is the output of running <code>git merge-base-origin</code> with the calculated <code>$BRANCH</code>, and then finally, we run the <code>git log</code> command.</p> <p>With the <code>git stack</code> alias complete, we can now run</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">git</span> stack\nfeature/part-4\nfeature/part-3\nfeature/part-2\n\n<span class=\"token comment\"># or, for example</span>\n$ <span class=\"token function\">git</span> stack feature/part-2\nfeature/part-2\n</code></pre></div> <p>All that remains is to implement the <code>git push-stack</code> command.</p> <h3 id=\"pushing-all-the-branches\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/#pushing-all-the-branches\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Pushing all the branches</a></h3> <p>With the <code>git stack</code> command implemented, <code>git push-stack</code> simply needs to invoke <code>git stack</code> and then call <code>git push origin --force-with-lease</code> for each of the values returned. The easiest way to do this is with <code>xargs</code>. We can simply pipe the output of <code>git stack</code> to <code>xargs</code>, and it will run the command for each of the provided branches:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> stack <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> <span class=\"token parameter variable\">-I</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token function\">git</span> push --force-with-lease origin <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The <code>-I {}</code> part means \"replace <code>{}</code> in the following command with the actual parameter\", where the parameter is the value returned from <code>git stack</code>, split by lines. So this runs <code>git push</code> on each of the branches returned by <code>git stack</code>.</p> <p>The definition in git is almost as simple as this, I just defined the <code>$BRANCH</code> variable again to allow passing a different value down to <code>git stack</code></p> <div class=\"pre-code-wrapper\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">alias</span><span class=\"token punctuation\">]</span></span>\n\t<span class=\"token key attr-name\">push-stack</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"!f() { \\</span>\n\t\t<span class=\"token key attr-name\">BRANCH</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">${1-HEAD}; \\</span>\n\t\tgit stack $BRANCH | xargs -I {} git push --force-with-lease origin {}; \\\n\t};f \"\n</code></pre></div> <p>That's the final piece of the puzzle, so now we can put it all together and look at our final set of aliases.</p> <h3 id=\"putting-it-all-together\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/#putting-it-all-together\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Putting it all together</a></h3> <p>The final set of aliases, as defined in my <em>.gitconfig</em> file is as follows:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">alias</span><span class=\"token punctuation\">]</span></span>\n\t<span class=\"token key attr-name\">default-branch</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"<span class=\"token inner-value\">!git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@'</span>\"</span>\n\t<span class=\"token key attr-name\">merge-base-origin</span> <span class=\"token punctuation\">=</span><span class=\"token value attr-value\">\"<span class=\"token inner-value\">!f() { git merge-base ${1-HEAD} origin/$(git default-branch); };f </span>\"</span>\n\t<span class=\"token key attr-name\">stack</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"!f() { \\</span>\n\t\t<span class=\"token key attr-name\">BRANCH</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">${1-HEAD}; \\</span>\n\t\t<span class=\"token key attr-name\">MERGE_BASE</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">$(git merge-base-origin $BRANCH); \\</span>\n\t\t<span class=\"token key attr-name\">git log --decorate-refs</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">refs/heads --simplify-by-decoration --pretty=format:\\\"%(decorate:prefix=,suffix=,tag=,separator=%n)\\\" $MERGE_BASE..$BRANCH; \\</span>\n\t};f \"\n\t<span class=\"token key attr-name\">push-stack</span> <span class=\"token punctuation\">=</span> <span class=\"token value attr-value\">\"!f() { \\</span>\n\t\t<span class=\"token key attr-name\">BRANCH</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">${1-HEAD}; \\</span>\n\t\tgit stack $BRANCH | xargs -I {} git push --force-with-lease origin {}; \\\n\t};f \"\n</code></pre></div> <p>You can simply copy-paste those into your own Git config (e.g. by running <code>git config --global --edit</code> to open your editor).</p> <blockquote> <p>One thing you might wonder is why there are so many cases of <code>${1-HEAD}</code> duplicated throughout. This is primarily so that each of these aliases can be called independently.</p> </blockquote> <p>Alternatively, you can run the following at the command line to add them automatically:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> alias.default-branch <span class=\"token string\">\"!git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@'\"</span>\n<span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> alias.merge-base-origin <span class=\"token string\">'!f() { git merge-base ${1-HEAD} origin/$(git default-branch); };f '</span>\n<span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> alias.stack <span class=\"token string\">'!f() { BRANCH=${1-HEAD}; MERGE_BASE=$(git merge-base-origin $BRANCH); git log --decorate-refs=refs/heads --simplify-by-decoration --pretty=format:\\\"%(decorate:prefix=,suffix=,tag=,separator=%n)\\\" $MERGE_BASE..$BRANCH; };f '</span>\n<span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> alias.push-stack <span class=\"token string\">'!f() { BRANCH=${1-HEAD};  git stack $BRANCH | xargs -I {} git push --force-with-lease origin {}; };f '</span>\n</code></pre></div> <p>And there you have it: simple pushing of an entire Git stack of branches with a single command. If you've been handling this manually like I was for years, then I hope this helps! If not, then I'd be interested to see what scripts you're using: reply in the comments if you're happy sharing!</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I described stacked branches in Git and how they can simplify the review process for PRs. However, it can be a pain when you need to push a whole stack of PRs to a remote. In this post I showed how I created a Git alias that allows you to run <code>git push-stack</code> to push an entire stack of branches in a single command. I showed how I built this alias out of multiple other aliases, such as <code>git stack</code>, and added customisation options. I hope this makes managing stacks of branches easier for everyone!</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/pushing-a-whole-stack-of-branches-with-a-single-git-command/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/",
      "Title": "Using the new AI template to create a chatbot about a website",
      "PublishDate": "2025-05-13T09:00:00+00:00",
      "Summary": "In this post I use the new Microsoft's new .NET AI template to ingest the contents of a website and create a chatbot that can answer questions with citations",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/githubmodels_banner.png\" /><p>In this post I use <a href=\"https://devblogs.microsoft.com/dotnet/announcing-dotnet-ai-template-preview2/\">the new .NET AI Chat Web App template (currently in preview)</a> to create a chat application that ingests the contents of a website (<a href=\"https://dotnetcore.show/\">The Modern .NET Show</a>) and uses that data to answer questions in the chat.</p> <p>This post was partly inspired by a conversation I had with <a href=\"https://bsky.app/profile/gaprogman.com\">Jamie Taylor</a> at the MVP summit in which he was exploring ways to do exactly this: have a chatbot for discussing the contents of his podcast, <a href=\"https://dotnetcore.show/\">The Modern .NET Show</a>. Seeing as Jamie already has full transcripts for the podcast on his website, this scenario seemed like a perfect use case for the new AI template!</p> <h2 id=\"the-new-net-ai-chat-web-app-template\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/#the-new-net-ai-chat-web-app-template\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The new .NET AI Chat Web App template</a></h2> <p>In <a href=\"https://andrewlock.net/exploring-the-new-ai-chat-template/\">the previous post</a>, I explored <a href=\"https://devblogs.microsoft.com/dotnet/announcing-dotnet-ai-template-preview2/\">the new .NET AI Chat Web App template (currently in preview)</a>, walked through the getting started experience, and explored the code it includes.</p> <p>To install the AI template, you can run the following command</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet new <span class=\"token function\">install</span> Microsoft.Extensions.AI.Templates\n</code></pre></div> <p>You can then create the template by running <code>aichatweb</code>, and providing the required parameters:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet new aichatweb <span class=\"token punctuation\">\\</span>\n    -- output ModernDotNetShowChat\n    <span class=\"token parameter variable\">--provider</span> githubmodels <span class=\"token punctuation\">\\</span>\n    --vector-store <span class=\"token builtin class-name\">local</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--aspire</span> <span class=\"token boolean\">true</span>\n</code></pre></div> <p>I describe these various options in the previous post, as well as how to configure GitHub models to allow free access for prototyping applications using large language models (LLMs) from OpenAI and others. The generated solution looks like the following:</p> <p><img src=\"https://andrewlock.net/content/images/2025/githubmodels_01.png\" alt=\"The solution layout\"></p> <p>Inside the solution folder is a <em>README.md</em> file that describes the remaining configuration, such as how to configure the required connection string for GitHub Models:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> ModernDotNetShowChat.AppHost\ndotnet user-secrets <span class=\"token builtin class-name\">set</span> ConnectionStrings:openai <span class=\"token string\">\"Endpoint=https://models.inference.ai.azure.com;Key=YOUR-API-KEY\"</span>\n</code></pre></div> <p>Finally, I showed the working chat application. You run the app by running the Aspire AppHost project. This starts the web app (and passes in all the required connection strings). The web app then runs an \"ingestion\" process against 2 pdf files (about watches) that are available in the content folder. More on this later.</p> <p>The web app is a \"traditional\" chat application, just like you've seen with ChatGPT or GitHub Copilot Chat. This interface lets you ask questions about the PDFs that were ingested. In the example below I asked the question \"Which watches are available\":</p> <p><img src=\"https://andrewlock.net/content/images/2025/githubmodels_02.png\" alt=\"Trying out the default template\"></p> <p>The chat assistant interprets your question and decides what phrases to search for in the documents. It then answers your question based on the details it finds in the documents, and even provides a link to the file that contains the answer.</p> <blockquote> <p>This general technique of providing \"sources\" for the LLM to use, instead of relying on the built-in knowledge is called retrieval-augmented generation (RAG), and is one way to try to ensure that the LLM provides answers grounded in facts. It involves ingesting source data, encoding it as vectors in a vector store, and making this store available to the LLM.</p> </blockquote> <p>In <a href=\"https://andrewlock.net/exploring-the-new-ai-chat-template/\">the previous post</a> I explore the template in more detail, but in this post I take a different approach and customise the template for a slightly different purpose.</p> <h2 id=\"modifying-the-website-to-chat-about-a-website\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/#modifying-the-website-to-chat-about-a-website\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Modifying the website to chat about a website</a></h2> <p>As I mentioned at the start of this post, when I saw this template, I immediately thought of a conversation I had with <a href=\"https://bsky.app/profile/gaprogman.com\">Jamie Taylor</a> at the MVP summit in which he was exploring ways to do exactly this: have a chatbot for discussing the contents of his podcast, <a href=\"https://dotnetcore.show/\">The Modern .NET Show</a>. Jamie already has full transcripts for the podcast on his website, so all we should need to do is tweak the data ingestion details.</p> <blockquote> <p>I also had to make various tweaks to the UI to show links to URLs instead of PDFs, but those are less interesting so I don't discuss them here. You can see the updated project <a href=\"https://github.com/andrewlock/ModernDotNetShowChat\">on GitHub</a> (the modifications are all <a href=\"https://github.com/andrewlock/ModernDotNetShowChat/commit/a2e9b4fe3b9e2dbef4dceecd62b53bca7393ecbf\">in this commit</a>).</p> </blockquote> <h3 id=\"creating-a-new-ingestion-source\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/#creating-a-new-ingestion-source\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Creating a new ingestion source</a></h3> <p>Other than UI changes, the main change needed is to the ingestion code. Instead of ingesting PDF files, the app will ingest web pages from <a href=\"https://dotnetcore.show/\">The Modern .NET Show</a> website. To do that, you can implement the <code>IIngestionSource</code> interface which is part of the template:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IIngestionSource</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> SourceId <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>IEnumerable<span class=\"token punctuation\">&lt;</span>IngestedDocument<span class=\"token punctuation\">&gt;</span><span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">GetNewOrModifiedDocumentsAsync</span><span class=\"token punctuation\">(</span>\n        <span class=\"token class-name\">IQueryable<span class=\"token punctuation\">&lt;</span>IngestedDocument<span class=\"token punctuation\">&gt;</span></span> existingDocuments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>IEnumerable<span class=\"token punctuation\">&lt;</span>IngestedDocument<span class=\"token punctuation\">&gt;</span><span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">GetDeletedDocumentsAsync</span><span class=\"token punctuation\">(</span>\n        <span class=\"token class-name\">IQueryable<span class=\"token punctuation\">&lt;</span>IngestedDocument<span class=\"token punctuation\">&gt;</span></span> existingDocuments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>IEnumerable<span class=\"token punctuation\">&lt;</span>SemanticSearchRecord<span class=\"token punctuation\">&gt;</span><span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">CreateRecordsForDocumentAsync</span><span class=\"token punctuation\">(</span>\n        <span class=\"token class-name\">IEmbeddingGenerator<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> Embedding<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">&gt;</span><span class=\"token punctuation\">&gt;</span></span> embeddingGenerator<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> documentId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>As you can see, there are three methods that need implementing, and a property that gives the ingestion source a unique ID. The property is the easy part, so we'll start there. We'll also create an <code>HttpClient</code> instance that we'll use to retrieve data from the website:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WebIngestionSource</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IIngestionSource</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">HttpClient</span> _httpClient<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">WebIngestionSource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> url<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Create a unique source ID based on the type name and the provided URL</span>\n        SourceId <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\"><span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>WebIngestionSource<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">url</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">;</span>\n        _httpClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">HttpClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            BaseAddress <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Uri</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> SourceId <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>We have the initial basis of our type, so now we can start implementing the required methods. We'll start by implementing the function that lists all the possible pages of the site.</p> <h3 id=\"finding-all-the-pages-in-the-site\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/#finding-all-the-pages-in-the-site\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Finding all the pages in the site</a></h3> <p>To find all the pages on a website you can basically take two options:</p> <ul><li>Crawl the website to find all possible pages.</li> <li>Use a <em>sitemap.xml</em> file if the site provides one.</li></ul> <p>Luckily for us, the Modern .NET show site includes <a href=\"https://dotnetcore.show/sitemap.xml\">a <em>sitemap.xml</em> file</a>, so we can take the easy route and parse that. The following basic code parses the sitemap.xml file using the <code>XmlSerializer</code>, parsing out only the values we're interested in (the location (url) and the date it was last modified):</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>Sitemap<span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">GetSitemap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> serializer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">XmlSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">Sitemap</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> stream <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> _httpClient<span class=\"token punctuation\">.</span><span class=\"token function\">GetStreamAsync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sitemap.xml\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sitemap <span class=\"token operator\">=</span> serializer<span class=\"token punctuation\">.</span><span class=\"token function\">Deserialize</span><span class=\"token punctuation\">(</span>stream<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token class-name\">Sitemap</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sitemap <span class=\"token keyword\">is</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Exception</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unable to read sitemap\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> sitemap<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">XmlRoot</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"urlset\"</span><span class=\"token punctuation\">,</span> Namespace <span class=\"token operator\">=</span> <span class=\"token string\">\"http://www.sitemaps.org/schemas/sitemap/0.9\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Sitemap</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">XmlElement</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> required <span class=\"token return-type class-name\">List<span class=\"token punctuation\">&lt;</span>Entry<span class=\"token punctuation\">&gt;</span></span> Entries <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Entry</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">XmlElement</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"loc\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">public</span> required <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Location <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n        <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">XmlElement</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"lastmod\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">public</span> required <span class=\"token return-type class-name\">DateTime</span> LastModified <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>From this method we get a <code>SiteMap</code> object, that includes all the pages available on the site. We'll use that in the <code>GetNewOrModifiedDocumentsAsync()</code> method that is called by the data ingestion code. This method is provided a collection of <code>IngestedDocument</code> which are the previously ingested pages from previous executions of the app. Any <code>IngestedDocument</code> that you return from the method are queued for subsequent ingestion; this method doesn't do the ingestion itself, it's just finding <em>which</em> pages to ingest:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>IEnumerable<span class=\"token punctuation\">&lt;</span>IngestedDocument<span class=\"token punctuation\">&gt;</span><span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">GetNewOrModifiedDocumentsAsync</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">IQueryable<span class=\"token punctuation\">&lt;</span>IngestedDocument<span class=\"token punctuation\">&gt;</span></span> existingDocuments<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Fetch the sitemap for the website</span>\n    <span class=\"token class-name\">Sitemap</span> sitemap <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">GetSitemap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> results <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>IngestedDocument<span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Loop through all of the entries in the sitemap</span>\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> entry <span class=\"token keyword\">in</span> sitemap<span class=\"token punctuation\">.</span>Entries<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// The \"ID\" for the page, which is the URL of the page</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> sourceFileId <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span>Location<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// The \"version\" for the page, which is the last modified time</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> sourceFileVersion <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span>LastModified<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"o\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Try to see if we have ingested this page before</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> existingDocument <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> existingDocuments\n            <span class=\"token punctuation\">.</span><span class=\"token function\">Where</span><span class=\"token punctuation\">(</span>d <span class=\"token operator\">=&gt;</span> d<span class=\"token punctuation\">.</span>SourceId <span class=\"token operator\">==</span> SourceId <span class=\"token operator\">&amp;&amp;</span> d<span class=\"token punctuation\">.</span>Id <span class=\"token operator\">==</span> sourceFileId<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">FirstOrDefaultAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existingDocument <span class=\"token keyword\">is</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// If there's no matching document, add this page to the ingestion list</span>\n            results<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> Id <span class=\"token operator\">=</span> sourceFileId<span class=\"token punctuation\">,</span> Version <span class=\"token operator\">=</span> sourceFileVersion<span class=\"token punctuation\">,</span> SourceId <span class=\"token operator\">=</span> SourceId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existingDocument<span class=\"token punctuation\">.</span>Version <span class=\"token operator\">!=</span> sourceFileVersion<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// If we have already ingested this page, but the last modified date has changed,</span>\n            <span class=\"token comment\">// then update the version and add it to the ingestion list</span>\n            existingDocument<span class=\"token punctuation\">.</span>Version <span class=\"token operator\">=</span> sourceFileVersion<span class=\"token punctuation\">;</span>\n            results<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>existingDocument<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// Otherwise we have already ingested this version of the document</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> results<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>After the method is called, all the documents returned are ready to be ingested.</p> <h3 id=\"ingesting-new-and-modified-pages\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/#ingesting-new-and-modified-pages\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Ingesting new and modified pages</a></h3> <p>Ingesting a page involves several steps:</p> <ol><li>Download the page from the website</li> <li>Parse the HTML for the page</li> <li>Convert the HTML into plain-text, so that it can be more easily understood by the LLM</li> <li>Split the page into paragraphs</li> <li>Generate vector-embeddings for performing RAG for each paragraph</li></ol> <p>Step 1 is easy, as we can use <code>HttpClient</code>. For step 2, I chose to use <a href=\"https://github.com/AngleSharp/AngleSharp\">AngleSharp</a>, a .NET library for parsing HTML, and my go-to for this kind of thing. For step 3, converting the HTML to plain-text, a quick bit of googling found <a href=\"https://github.com/matteocontrini/Textify\">this small package called Textify</a> which seemed to do exactly what I needed, converting an AngleSharp <code>IDocument</code> to markdown.</p> <p>Step 4 comes courtesy of a utility called <code>TextChunker</code> that's currently built into the <a href=\"https://learn.microsoft.com/en-us/semantic-kernel/overview/\">Semantic Kernel</a> packages (though I expect these will end up pushed to other abstraction libraries in the future). Step 5 is handled by the template and abstraction libraries provided by Microsoft and OpenAI, in particular the <em>Microsoft.Extensions.AI.Abstractions</em> and implementation libraries.</p> <p>The code below shows how we I achieved all this relatively simply using the abstractions provided by the template:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>IEnumerable<span class=\"token punctuation\">&lt;</span>SemanticSearchRecord<span class=\"token punctuation\">&gt;</span><span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">CreateRecordsForDocumentAsync</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">IEmbeddingGenerator<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> Embedding<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">&gt;</span><span class=\"token punctuation\">&gt;</span></span> embeddingGenerator<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> documentId<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Request the page body for the provided ID (url)</span>\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> stream <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> _httpClient<span class=\"token punctuation\">.</span><span class=\"token function\">GetStreamAsync</span><span class=\"token punctuation\">(</span>documentId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Use AngleSharp to read and parse the HTML document </span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> config <span class=\"token operator\">=</span> Configuration<span class=\"token punctuation\">.</span>Default<span class=\"token punctuation\">.</span><span class=\"token function\">WithDefaultLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> context <span class=\"token operator\">=</span> BrowsingContext<span class=\"token punctuation\">.</span><span class=\"token function\">New</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">IDocument</span> document <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">OpenAsync</span><span class=\"token punctuation\">(</span>documentId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Use Textify to convert the HTML to a markdown document </span>\n    <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> pageText <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">HtmlToTextConverter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Convert</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Split the document into paragraphs using the experimental type from SemanticKernel</span>\n<span class=\"token preprocessor property\">#<span class=\"token directive keyword\">pragma</span> warning disable SKEXP0050 </span><span class=\"token comment\">// Type is for evaluation purposes only</span>\n    <span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> IndexOnPage<span class=\"token punctuation\">,</span> <span class=\"token keyword\">string</span> Text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&gt;</span></span> paragraphs <span class=\"token operator\">=</span>\n        TextChunker<span class=\"token punctuation\">.</span><span class=\"token function\">SplitPlainTextParagraphs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">pageText</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">maxTokensPerParagraph</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">ToList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token preprocessor property\">#<span class=\"token directive keyword\">pragma</span> warning restore SKEXP0050 </span><span class=\"token comment\">// Type is for evaluation purposes only</span>\n\n    <span class=\"token comment\">// Generate embeddings for all the paragraphs</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> embeddings <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> embeddingGenerator<span class=\"token punctuation\">.</span><span class=\"token function\">GenerateAsync</span><span class=\"token punctuation\">(</span>paragraphs<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">=&gt;</span> c<span class=\"token punctuation\">.</span>Text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Combine the paragraphs and embeddings, to return a collection of SemanticSearchRecords</span>\n    <span class=\"token keyword\">return</span> paragraphs<span class=\"token punctuation\">.</span><span class=\"token function\">Zip</span><span class=\"token punctuation\">(</span>embeddings<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pair<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SemanticSearchRecord</span>\n    <span class=\"token punctuation\">{</span>\n        Key <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">documentId</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">_</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">pair<span class=\"token punctuation\">.</span>First<span class=\"token punctuation\">.</span>IndexOnPage</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span>\n        Url <span class=\"token operator\">=</span> documentId<span class=\"token punctuation\">,</span>\n        Text <span class=\"token operator\">=</span> pair<span class=\"token punctuation\">.</span>First<span class=\"token punctuation\">.</span>Text<span class=\"token punctuation\">,</span>\n        Vector <span class=\"token operator\">=</span> pair<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">.</span>Vector<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>That's the most complex method, the final required implementation is handling record deletion.</p> <h3 id=\"finding-records-to-delete\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/#finding-records-to-delete\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Finding records to delete</a></h3> <p>The final method we need to implement is <code>GetDeletedDocumentsAsync()</code> which returns a list of documents that we previously ingested, which we should remove from the dataset. In the implementation below we again read the <em>sitemap.xml</em> and extract all the URLs to a <code>HashSet</code>. We then loop through all the existing documents; if the document ID is not in the set, we keep it, and return it from the method. These documents will be removed from the vector store.</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>IEnumerable<span class=\"token punctuation\">&lt;</span>IngestedDocument<span class=\"token punctuation\">&gt;</span><span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">GetDeletedDocumentsAsync</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">IQueryable<span class=\"token punctuation\">&lt;</span>IngestedDocument<span class=\"token punctuation\">&gt;</span></span> existingDocuments<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Sitemap</span> sitemap <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">GetSitemap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> urls <span class=\"token operator\">=</span> sitemap<span class=\"token punctuation\">.</span>Entries<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=&gt;</span> x<span class=\"token punctuation\">.</span>Location<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToHashSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> existingDocuments\n        <span class=\"token punctuation\">.</span><span class=\"token function\">Where</span><span class=\"token punctuation\">(</span>doc <span class=\"token operator\">=&gt;</span> <span class=\"token operator\">!</span>urls<span class=\"token punctuation\">.</span><span class=\"token function\">Contains</span><span class=\"token punctuation\">(</span>doc<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">ToListAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>And with that, we've tackled the majority of the implementation. Note that I made a couple of tweaks to the <code>SemanticSearchRecord</code> type to replace the <code>Filename</code> property with <code>Url</code> and removed the <code>PageNumber</code> property, to better match our case of ingesting webpages instead of files.</p> <h3 id=\"configuring-the-app-to-use-the-new-ingestion-source\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/#configuring-the-app-to-use-the-new-ingestion-source\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Configuring the app to use the new ingestion source</a></h3> <p>The final step we need to take is to update the actual ingestion. This occurs in <em>Program.cs</em> of the web app, just before calling <code>app.Run()</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// ... existing setup</span>\n\n<span class=\"token comment\">// Use the provided DataIngestor, but pass in </span>\n<span class=\"token comment\">// our custom IIngestionSource, the WebIngestionSource</span>\n<span class=\"token keyword\">await</span> DataIngestor<span class=\"token punctuation\">.</span><span class=\"token function\">IngestDataAsync</span><span class=\"token punctuation\">(</span>\n    app<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">WebIngestionSource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://dotnetcore.show\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>With that, we're finished. Time to take it for a spin!</p> <h2 id=\"trying-out-the-new-chat-app\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/#trying-out-the-new-chat-app\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Trying out the new chat app</a></h2> <p>We can try out our new app by hitting F5, or running <code>dotnet run</code> on the aspire app. This starts the ingestion process, first running <code>GetNewOrModifiedDocumentsAsync()</code> and <code>GetDeletedDocumentsAsync()</code> to find the pages to ingest, and then running <code>CreateRecordsForDocumentAsync()</code> to ingest the pages, for example:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">info: ModernDotNetShowChat.Web.Services.Ingestion.DataIngestor<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n      Processing https://dotnetcore.show/episodes/\ninfo: ModernDotNetShowChat.Web.Services.Ingestion.DataIngestor<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n      Processing https://dotnetcore.show/season-7/jonathan-peppers-unleashes-code-chaos-how-dotnet-meets-the-nes/\ninfo: ModernDotNetShowChat.Web.Services.Ingestion.DataIngestor<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n      Processing https://dotnetcore.show/\ninfo: ModernDotNetShowChat.Web.Services.Ingestion.DataIngestor<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n      Processing https://dotnetcore.show/season-7/google-gemini-in-net-the-ultimate-guide-with-jochen-kirstaetter/\n<span class=\"token punctuation\">..</span>.\n</code></pre></div> <p>This takes a <em>long</em> time (more on that later) but once it's finished, the app starts and we can ask questions about The Modern .NET Show:</p> <p><img src=\"https://andrewlock.net/content/images/2025/githubmodels_04.png\" alt=\"Trying out the new app\"></p> <p>Just as for the original template, the chatbot includes citations for its answers, including links to the page that contained the answer, and a quote from the page.</p> <p>There are obviously a lot of tweaks that you could make to the template and the site in general. For example, I increased the size of the quote that the chatbot can include in it's citations. I didn't play around with the template much more than that, as the proof of concept seemed to work!</p> <h2 id=\"ingesting-web-pages-is-slow\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/#ingesting-web-pages-is-slow\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Ingesting web pages is slow</a></h2> <p>One observation I found is that the ingestion process was <em>very</em> slow. It took an average of about 10 seconds to ingest a <em>single</em> page. And when there's ~250 pages to ingest, that adds up to roughly 40 minutes of ingestion time! 😅 I haven't dug into this too deeply to understand where it's so slow, but I'd be willing to put money on it being the actual embedding step. We generate an embedding for every paragraph in the page, and seeing as that requires a network call, it seems reasonable to think that's the source of the problem.</p> <p>Another aspect that's a little annoying is that the <code>DataIngestor</code> that ships with the template calls <code>CreateRecordsForDocumentAsync()</code> for all of the pages but doesn't <em>save</em> the results until after it's run for <em>every</em> document. That means that if you interrupt the process for some reason (because it's taking 40 mins perhaps 😉) then you have to start from the beginning again the next time you run the app. To work around that I made a small change to the <code>DataIngestor</code> to save after every 20 documents instead.</p> <p>The final issue is that by default, the template uses a random file path for the SQLite ingestion cache every time the app starts up. That means it redoes <em>all</em> that ingestion work every time it starts up. The simple solution to that is to provide a path and filename for the database file. That way the database isn't re-created every time your app starts, and you can instead incrementally update the embeddings:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> ingestionCache <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddSqlite</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"ingestionCache\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token named-parameter punctuation\">databasePath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">@\"D:\\repos\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token named-parameter punctuation\">databaseFileName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"modern_dotnetshow_embeddings.db\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>That simple change makes the app much more usable. Obviously, for production you likely wouldn't be using a SQLite database and JSON file for your vectors, so it wouldn't be a problem anyway.</p> <p>Overall, I think this makes an interesting proof of concept, although how useful it is in practice will remain to be seen I think.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I showed how you can use <a href=\"https://devblogs.microsoft.com/dotnet/announcing-dotnet-ai-template-preview2/\">the new .NET AI Chat Web App template (currently in preview)</a> to create a custom <code>IIngestionSource</code> to ingest data about a website, so that you can chat with an LLM about the site. The resulting chat app provides quotes and citations from the website when answering your questions. You can find the source code for this demo app <a href=\"https://github.com/andrewlock/ModernDotNetShowChat\">on GitHub</a>.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/using-the-new-ai-template-to-create-a-chatbot-about-a-website/"
    },
    {
      "FeedId": "https://andrewlock.net/rss/",
      "ItemId": "https://andrewlock.net/exploring-the-new-ai-chat-template/",
      "Title": "Exploring the new AI chat template",
      "PublishDate": "2025-05-06T09:00:00+00:00",
      "Summary": "In this post I explore the new .NET AI Chat Web App template (currently in preview) and take a brief look at the implementation it provides",
      "Content": "<img src=\"https://andrewlock.net/content/images/2025/ai_banner.png\" /><p>In this post I explore <a href=\"https://devblogs.microsoft.com/dotnet/announcing-dotnet-ai-template-preview2/\">the new .NET AI Chat Web App template (currently in preview)</a> to create a chat application and take a brief look at everything it provides. In the next post I then customize the app so that instead of ingesting PDFs, it ingests the contents of a website and uses that data to answer questions in the chat.</p> <h2 id=\"getting-started-with-the-new-net-ai-chat-web-app-template\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-the-new-ai-chat-template/#getting-started-with-the-new-net-ai-chat-web-app-template\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Getting started with the new .NET AI Chat Web App template</a></h2> <p>The .NET AI Chat Web App is a new template that shows how to get started building a chat style application backed by a large language model (LLM). Chat apps are one of the most prolific use cases for AI (obviously heavily popularised by ChatGPT), and while they're not always the best way to \"add AI\" to your app, they can have their uses.</p> <p>To install the AI template, you can run the following command</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet new <span class=\"token function\">install</span> Microsoft.Extensions.AI.Templates\n</code></pre></div> <p>This installs the template, making the AI Chat Web App template available using name <code>aichatweb</code>:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&gt;</span> dotnet new <span class=\"token function\">install</span> Microsoft.Extensions.AI.Templates\nThe following template packages will be installed:\n   Microsoft.Extensions.AI.Templates\n\nSuccess: Microsoft.Extensions.AI.Templates::9.4.0-preview.2.25216.9 installed the following templates:\nTemplate Name    Short Name  Language  Tags\n---------------  ----------  --------  --------------------------------\nAI Chat Web App  aichatweb   <span class=\"token punctuation\">[</span>C<span class=\"token comment\">#]      Common/AI/Web/Blazor/.NET Aspire</span>\n</code></pre></div> <p>The template includes various options to control how it works, but there are three main aspects to consider:</p> <ul><li>Do you want the app configured to use Aspire? Yes, of course you do 😉</li> <li>Which LLM provider do you want to use to power the chat interface: <ul><li><a href=\"https://docs.github.com/en/github-models\"><strong>GitHub Models</strong></a>. This is a great getting-started option, as it's free for developers, and is what I use in this post.</li> <li><strong>OpenAI</strong>. Uses the <a href=\"https://openai.com/api/\">OpenAI API Platform</a>.</li> <li><strong>Azure OpenAI</strong>. Uses the <a href=\"https://azure.microsoft.com/en-us/products/ai-services/openai-service\">Azure OpenAI Service</a>.</li> <li><strong>Ollama</strong>. Runs locally on your machine, using <a href=\"https://ollama.com/\">Ollama</a> with the llama3.2 and all-minilm models.</li></ul> </li> <li>Which vector embedding store do you want to use for ingesting the data: <ul><li><strong>Local</strong>. Uses a JSON file on disk, which is great for prototyping.</li> <li><strong>Azure AI Search</strong>. Uses Azure AI Search, which manages the data ingestion automatically.</li> <li><strong>Qdrant</strong>. Runs the <a href=\"https://qdrant.tech/\">Qdrant</a> vector database in a docker container.</li></ul> </li></ul> <p>If you're new to LLMs and AI then that might all be a bit overwhelming, but there's basically two different concepts to understand here:</p> <ul><li>The LLM provider is what provides the AI interface that powers the chat.</li> <li>The Vector embedding is how the LLM model \"ingests\" data. For each document you provide it, the LLM provides an array of numbers that you store in a database (or in a JSON file in the <code>local</code> case). The LLM can then run queries against the database and find \"similar\" data.</li></ul> <p>For this post, I chose to use GitHub Models for the LLM provider, as it's free and very easy to get up and running (as I'll show shortly). For the vector store I chose to store the data locally.</p> <blockquote> <p>These are the default values for the template for good reason, as they're pretty much the quickest way to get up and running. You wouldn't choose these options for production, but they're ideal for prototyping.</p> </blockquote> <p>To install the template, you can either use your IDE, or you can use the .NET CLI like so:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet new aichatweb <span class=\"token punctuation\">\\</span>\n    -- output ModernDotNetShowChat\n    <span class=\"token parameter variable\">--provider</span> githubmodels <span class=\"token punctuation\">\\</span>\n    --vector-store <span class=\"token builtin class-name\">local</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token parameter variable\">--aspire</span> <span class=\"token boolean\">true</span>\n</code></pre></div> <p>This creates a full solution consisting of:</p> <ul><li>A Web project containing the chat app</li> <li>A \"Service Defaults\" project—A suggested best practice for creating Aspire applications these days</li> <li>An \"App Host\" project—The Aspire host project, that wires up the dependencies</li></ul> <p>There's also a <em>.sln</em> file you can open in your IDE:</p> <p><img src=\"https://andrewlock.net/content/images/2025/githubmodels_01.png\" alt=\"The solution layout\"></p> <p>Inside the solution folder is a <em>README.md</em> file that describes the remaining configuration. For our setup, there's just one step we need to take: configuring GitHub Models.</p> <h2 id=\"using-github-models\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-the-new-ai-chat-template/#using-github-models\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Using GitHub Models</a></h2> <p>The <em>README.md</em> file contains instructions for getting started with GitHub Models:</p> <blockquote> <p>To use models hosted by GitHub Models, you will need to create a GitHub personal access token. The token should not have any scopes or permissions. See <a href=\"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens\">Managing your personal access tokens</a>.</p> </blockquote> <p><a href=\"https://docs.github.com/en/github-models/prototyping-with-ai-models\">GitHub Models</a> is a service from GitHub that provides developers an easy way to prototype with LLMs and Generative AI. All that you need is a GitHub account, and you can be running against all the latest models from OpenAI and others <em>without</em> having to sign up to those services directly.</p> <blockquote> <p>GitHub Models is strictly for \"prototyping\" so it comes with some hefty usage limits and <a href=\"https://azure.microsoft.com/en-us/products/ai-services/ai-content-safety\">content filters</a>.</p> </blockquote> <p>To get started with GitHub models you just need to choose a model and retrieve a token:</p> <ol><li>Go to <a href=\"https://github.com/marketplace/models\">github.com/marketplace/models</a>.</li> <li>Click <strong>Model: Select a Model</strong> at the top left of the page.</li> <li>Choose a model from the dropdown menu.</li></ol> <p>After selecting a model, you'll see the screen below. As you can see, you can get SDK details and see various other configuration options:</p> <p><img src=\"https://andrewlock.net/content/images/2025/githubmodels.png\" alt=\"The getting started page from GitHub models\"></p> <p>We don't need any to worry about any of that SDK information, as that's already handled by the .NET NuGet packages and the template. All you need is a personal access token (PAT):</p> <ul><li>Click <strong>Get developer key</strong> on the above screen</li> <li>This redirects to GitHub's token management page: <a href=\"https://github.com/settings/tokens\">https://github.com/settings/tokens</a></li> <li>Click <strong>Generate new token</strong>, and generate a fine grained token (not classic)</li> <li>Enter a name for the token, and an expiry ~~but do not add any permissions or roles.~~ Note that <a href=\"https://github.blog/changelog/2025-05-15-modelsread-now-required-for-github-models-access/\">as of May 15 2025</a>, your fine-grained GitHub Models tokens must now have the <code>model:read</code> permission.</li></ul> <p>After creating the token, you can add it as a secret to your application. You need to add the token as a connection string inside the Aspire AppHost project. You can do that using the IDE editor integration in Visual Studio or Rider, or you can use the command line. For example, for my app, I ran the following (replacing <code>YOUR-API-KEY</code> with the token value):</p> <div class=\"pre-code-wrapper\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> ModernDotNetShowChat.AppHost\ndotnet user-secrets <span class=\"token builtin class-name\">set</span> ConnectionStrings:openai <span class=\"token string\">\"Endpoint=https://models.inference.ai.azure.com;Key=YOUR-API-KEY\"</span>\n</code></pre></div> <p>As you can probably tell from the above setting, GitHub Models runs using <a href=\"https://azure.microsoft.com/en-us/products/ai-services/openai-service\">Azure OpenAI Service</a>, hence the reference to Azure in the connection string. If you choose a different LLM provider then these settings will be different.</p> <p>With the secret added, everything is ready to take the template for a spin.</p> <h2 id=\"briefly-trying-out-the-template\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-the-new-ai-chat-template/#briefly-trying-out-the-template\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Briefly trying out the template</a></h2> <p>Before we dig in further, we'll take the standard template for a spin.</p> <blockquote> <p>You can read more about getting started in <a href=\"https://devblogs.microsoft.com/dotnet/announcing-dotnet-ai-template-preview2/\">the Preview 2 announcement post</a> for the template.</p> </blockquote> <p>You run the app by running the Aspire AppHost project. This starts the web app (and passes in all the required connection strings). The web app then runs an \"ingestion\" process against 2 pdf files (about watches) that are available in the content folder. More on this later.</p> <p>The web app is a \"traditional\" chat application, just like you've seen with ChatGPT or GitHub Copilot Chat. This interface lets you ask questions about the PDFs that were ingested. In the example below I asked the question \"Which watches are available\":</p> <p><img src=\"https://andrewlock.net/content/images/2025/githubmodels_02.png\" alt=\"Trying out the default template\"></p> <p>The chat assistant interprets your question and decides what phrases to search for in the documents. It then answers your question based on the details it finds in the documents, and even provides a link to the file that contains the answer.</p> <blockquote> <p>This general technique of providing \"sources\" for the LLM to use, instead of relying on the built-in knowledge is called retrieval-augmented generation (RAG), and is one way to try to ensure that the LLM provides answers grounded in facts. It involves ingesting source data, encoding it as vectors in a vector store, and making this store available to the LLM.</p> </blockquote> <p>That's pretty much all there is to the app, but it provides a powerful template that you can extend and modify to work for your own application. For the remainder of the post I look at a couple of points of interest about the template.</p> <h2 id=\"the-aspire-app-host\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-the-new-ai-chat-template/#the-aspire-app-host\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The Aspire App Host</a></h2> <p>We'll start by looking at the Aspire App Host. This is where the general architecture of the app is defined, and which reveals that there are essentially three components:</p> <ul><li>The OpenAI (via GitHub models) connection</li> <li>The Blazor web app</li> <li>A SQLite database as a cache for the generated embeddings</li></ul> <p>You can see all this configured in the <em>Program.cs</em> file:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> DistributedApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> openai <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddConnectionString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"openai\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> ingestionCache <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddSqlite</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ingestionCache\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> webApp <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddProject</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Projects<span class=\"token punctuation\">.</span>ModernDotNetShowChat_Web<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aichatweb-app\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwebApp<span class=\"token punctuation\">.</span><span class=\"token function\">WithReference</span><span class=\"token punctuation\">(</span>openai<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwebApp\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WithReference</span><span class=\"token punctuation\">(</span>ingestionCache<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">WaitFor</span><span class=\"token punctuation\">(</span>ingestionCache<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nbuilder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>When you run the AppHost, Aspire initializes the SQLite database and starts the web app, passing in the connection strings.</p> <h2 id=\"the-web-app\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-the-new-ai-chat-template/#the-web-app\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The web app</a></h2> <p>The main application is a Blazor Server app. In addition to the standard Blazor and ASP.NET Core services, it contains three main components:</p> <ul><li>The GitHub Models/OpenAI chat client. This is the core infrastructure for interacting with the OpenAI service using the OpenAI NuGet package and Microsoft.Extensions.AI abstractions. This also registers an embedding generator for OpenAI for converting the ingested documents into vectors that can later be serialised.</li> <li>The vector store is responsible for persisting the generated embeddings, and for providing the mechanism for OpenAI to search the store as required.</li> <li>The ingestion cache is an EF Core <code>DbContext</code> that keeps track of which documents have been ingested into the vector store. This allows the app to avoid ingesting the same documents multiple times as well as to remove documents that are no longer available.</li></ul> <p>The configuration of these services all happens in the <em>Program.cs</em> file of the web app, as shown below. I haven't reproduced the whole file here, just the configuration related to the above components:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> WebApplication<span class=\"token punctuation\">.</span><span class=\"token function\">CreateBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Add the OpenAI chat client to the container</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> openai <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">AddAzureOpenAIClient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"openai\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nopenai<span class=\"token punctuation\">.</span><span class=\"token function\">AddChatClient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gpt-4o-mini\"</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Use the ChatGPT 4o mini model</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">UseFunctionInvocation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// Allow the LLM to call local functions in your app</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">UseOpenTelemetry</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">configure</span><span class=\"token punctuation\">:</span> c <span class=\"token operator\">=&gt;</span> <span class=\"token comment\">// Configure OTel for </span>\n        c<span class=\"token punctuation\">.</span>EnableSensitiveData <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span>Environment<span class=\"token punctuation\">.</span><span class=\"token function\">IsDevelopment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nopenai<span class=\"token punctuation\">.</span><span class=\"token function\">AddEmbeddingGenerator</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"text-embedding-3-small\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Allow generating text embeddings</span>\n\n<span class=\"token comment\">// Add an IVectorStore implementation that stores the embeddings in a JSON file</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> vectorStore <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">JsonVectorStore</span><span class=\"token punctuation\">(</span>Path<span class=\"token punctuation\">.</span><span class=\"token function\">Combine</span><span class=\"token punctuation\">(</span>AppContext<span class=\"token punctuation\">.</span>BaseDirectory<span class=\"token punctuation\">,</span> <span class=\"token string\">\"vector-store\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>IVectorStore<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span>vectorStore<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddScoped</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>DataIngestor<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Used to ingest embeddings</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>SemanticSearch<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Used to search embeddings</span>\n\n<span class=\"token comment\">// Add the EF Core DbContext for tracking which files have been ingested</span>\nbuilder<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSqliteDbContext</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>IngestionCacheDbContext<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ingestionCache\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>When the app starts, it ensures the SQLite database has been created, starts the web app, and then starts the data ingestion:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">await</span> DataIngestor<span class=\"token punctuation\">.</span><span class=\"token function\">IngestDataAsync</span><span class=\"token punctuation\">(</span>\n    app<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PDFDirectorySource</span><span class=\"token punctuation\">(</span>Path<span class=\"token punctuation\">.</span><span class=\"token function\">Combine</span><span class=\"token punctuation\">(</span>builder<span class=\"token punctuation\">.</span>Environment<span class=\"token punctuation\">.</span>WebRootPath<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Data\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div> <p>Much of the chat application uses standard NuGet packages for interacting with the LLM, however the <code>DataIngestor</code> and <code>PdfDirectorySource</code> implementations are specific to the template, and show a general approach to generating text embeddings.</p> <h2 id=\"ingesting-data-and-generating-embeddings\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-the-new-ai-chat-template/#ingesting-data-and-generating-embeddings\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Ingesting data and generating embeddings</a></h2> <p>The <code>DataIngestor</code> implementation defined in the template manages the storing of text embedding vectors in an <code>IVectorStore</code> based on the implementation in an <code>IIngestionSource</code>, using the <code>IngestionCacheDbContext</code> to track which documents have been previously ingested.</p> <p>The implementation, reproduced below, is pretty self-explanatory, but I've added a few extra comments for clarity:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DataIngestor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">ILogger<span class=\"token punctuation\">&lt;</span>DataIngestor<span class=\"token punctuation\">&gt;</span></span> logger<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">IEmbeddingGenerator<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> Embedding<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">&gt;</span><span class=\"token punctuation\">&gt;</span></span> embeddingGenerator<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">IVectorStore</span> vectorStore<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">IngestionCacheDbContext</span> ingestionCacheDb<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">IngestDataAsync</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IIngestionSource</span> source<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Get or create the \"collection\" for holding the embeddings in the vector store</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> vectorCollection <span class=\"token operator\">=</span> vectorStore<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetCollection</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> SemanticSearchRecord<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data-moderndotnetshowchat-ingested\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">await</span> vectorCollection<span class=\"token punctuation\">.</span><span class=\"token function\">CreateCollectionIfNotExistsAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Read which documents have already been ingested from the SQLite cache</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> documentsForSource <span class=\"token operator\">=</span> ingestionCacheDb<span class=\"token punctuation\">.</span>Documents\n            <span class=\"token punctuation\">.</span><span class=\"token function\">Where</span><span class=\"token punctuation\">(</span>d <span class=\"token operator\">=&gt;</span> d<span class=\"token punctuation\">.</span>SourceId <span class=\"token operator\">==</span> source<span class=\"token punctuation\">.</span>SourceId<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">Include</span><span class=\"token punctuation\">(</span>d <span class=\"token operator\">=&gt;</span> d<span class=\"token punctuation\">.</span>Records<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Ask the IIngestionSource for a list of files to delete</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> deletedFiles <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> source<span class=\"token punctuation\">.</span><span class=\"token function\">GetDeletedDocumentsAsync</span><span class=\"token punctuation\">(</span>documentsForSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Delete the removed files from the IVectorStore and the SQLite cache</span>\n        <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> deletedFile <span class=\"token keyword\">in</span> deletedFiles<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            logger<span class=\"token punctuation\">.</span><span class=\"token function\">LogInformation</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Removing ingested data for {file}\"</span><span class=\"token punctuation\">,</span> deletedFile<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">await</span> vectorCollection<span class=\"token punctuation\">.</span><span class=\"token function\">DeleteBatchAsync</span><span class=\"token punctuation\">(</span>deletedFile<span class=\"token punctuation\">.</span>Records<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>r <span class=\"token operator\">=&gt;</span> r<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            ingestionCacheDb<span class=\"token punctuation\">.</span>Documents<span class=\"token punctuation\">.</span><span class=\"token function\">Remove</span><span class=\"token punctuation\">(</span>deletedFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">await</span> ingestionCacheDb<span class=\"token punctuation\">.</span><span class=\"token function\">SaveChangesAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Ask the IIngestionSource for a list of new or modified files to ingest</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> modifiedDocs <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> source<span class=\"token punctuation\">.</span><span class=\"token function\">GetNewOrModifiedDocumentsAsync</span><span class=\"token punctuation\">(</span>documentsForSource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// For each new/modified document:</span>\n        <span class=\"token comment\">// - Delete the embeddings if they already exist (changed files)</span>\n        <span class=\"token comment\">// - Generate the embeddings for the document</span>\n        <span class=\"token comment\">// - Save the embeddings in the IVectorStore</span>\n        <span class=\"token comment\">// - Record the updated status in the SQLite cache</span>\n        <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> modifiedDoc <span class=\"token keyword\">in</span> modifiedDocs<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            logger<span class=\"token punctuation\">.</span><span class=\"token function\">LogInformation</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Processing {file}\"</span><span class=\"token punctuation\">,</span> modifiedDoc<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>modifiedDoc<span class=\"token punctuation\">.</span>Records<span class=\"token punctuation\">.</span>Count <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">await</span> vectorCollection<span class=\"token punctuation\">.</span><span class=\"token function\">DeleteBatchAsync</span><span class=\"token punctuation\">(</span>modifiedDoc<span class=\"token punctuation\">.</span>Records<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>r <span class=\"token operator\">=&gt;</span> r<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newRecords <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> source<span class=\"token punctuation\">.</span><span class=\"token function\">CreateRecordsForDocumentAsync</span><span class=\"token punctuation\">(</span>embeddingGenerator<span class=\"token punctuation\">,</span> modifiedDoc<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> id <span class=\"token keyword\">in</span> vectorCollection<span class=\"token punctuation\">.</span><span class=\"token function\">UpsertBatchAsync</span><span class=\"token punctuation\">(</span>newRecords<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n            modifiedDoc<span class=\"token punctuation\">.</span>Records<span class=\"token punctuation\">.</span><span class=\"token function\">Clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            modifiedDoc<span class=\"token punctuation\">.</span>Records<span class=\"token punctuation\">.</span><span class=\"token function\">AddRange</span><span class=\"token punctuation\">(</span>newRecords<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>r <span class=\"token operator\">=&gt;</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">IngestedRecord</span> <span class=\"token punctuation\">{</span> Id <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span>Key<span class=\"token punctuation\">,</span> DocumentId <span class=\"token operator\">=</span> modifiedDoc<span class=\"token punctuation\">.</span>Id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ingestionCacheDb<span class=\"token punctuation\">.</span><span class=\"token function\">Entry</span><span class=\"token punctuation\">(</span>modifiedDoc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>State <span class=\"token operator\">==</span> EntityState<span class=\"token punctuation\">.</span>Detached<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                ingestionCacheDb<span class=\"token punctuation\">.</span>Documents<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>modifiedDoc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">await</span> ingestionCacheDb<span class=\"token punctuation\">.</span><span class=\"token function\">SaveChangesAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        logger<span class=\"token punctuation\">.</span><span class=\"token function\">LogInformation</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Ingestion is up-to-date\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>I won't dive into the <code>IIngestionSource</code> implementation in this post, as I'll take a closer look at an alternative implementation in the next post. At a high level, the <code>PDFDirectorySource</code>:</p> <ul><li>Reads the list of <em>.pdf</em> files available in the source directory.</li> <li>Uses the last write time for the file to determine whether it has been modified or not.</li> <li>Uses <a href=\"https://github.com/UglyToad/PdfPig\">the PdfPig library</a> to read the text of the PDF document.</li> <li>Generates an embedding for each paragraph, of each file.</li></ul> <h2 id=\"the-chat-flow-and-embeddings\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-the-new-ai-chat-template/#the-chat-flow-and-embeddings\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">The chat flow and embeddings</a></h2> <p>So how does this all come together?</p> <p>The core of the implementation is in the <code>Chat.razor</code> component. This component configures the <code>IChatClient</code> with a system prompt and a tool/function invocator which the LLM can use to search the local embeddings by invoking <code>SearchAsync()</code>.</p> <p>The system prompt and tool are provided as follows:</p> <div class=\"pre-code-wrapper\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> SystemPrompt <span class=\"token operator\">=</span> <span class=\"token string\">@\"\n    You are an assistant who answers questions about information you retrieve.\n    Do not answer questions about anything else.\n    Use only simple markdown to format your responses.\n\n    Use the search tool to find relevant information. When you do this, end your\n    reply with citations in the special XML format:\n\n    &lt;citation filename='string' page_number='number'&gt;exact quote here&lt;/citation&gt;\n\n    Always include the citation in your response if there are results.\n\n    The quote must be max 5 words, taken word-for-word from the search result, and is the basis for why the citation is relevant.\n    Don't refer to the presence of citations; just emit these tags right at the end, with no surrounding text.\n    \"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">ChatOptions</span> chatOptions <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">List<span class=\"token punctuation\">&lt;</span>ChatMessage<span class=\"token punctuation\">&gt;</span></span> messages <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnInitialized</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    messages<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span>ChatRole<span class=\"token punctuation\">.</span>System<span class=\"token punctuation\">,</span> SystemPrompt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    chatOptions<span class=\"token punctuation\">.</span>Tools <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">AIFunctionFactory<span class=\"token punctuation\">.</span>Create</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span>SearchAsync<span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Description</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"Searches for information using a phrase or keyword\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>IEnumerable<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">&gt;</span><span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">SearchAsync</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Description</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"The phrase to search for.\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> searchPhrase<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Description</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"If possible, specify the filename to search that file only. If not provided or empty, the search includes all files.\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">?</span></span> filenameFilter <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">InvokeAsync</span><span class=\"token punctuation\">(</span>StateHasChanged<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">IReadOnlyList<span class=\"token punctuation\">&lt;</span>SemanticSearchRecord<span class=\"token punctuation\">&gt;</span></span> results <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Search<span class=\"token punctuation\">.</span><span class=\"token function\">SearchAsync</span><span class=\"token punctuation\">(</span>searchPhrase<span class=\"token punctuation\">,</span> filenameFilter<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">maxResults</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> results<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>result <span class=\"token operator\">=&gt;</span>\n        <span class=\"token interpolation-string\"><span class=\"token string\">$\"&lt;result filename=\\\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">result<span class=\"token punctuation\">.</span>FileName</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\\\" page_number=\\\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">result<span class=\"token punctuation\">.</span>PageNumber</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\\\"&gt;</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">result<span class=\"token punctuation\">.</span>Text</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">&lt;/result&gt;\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div> <p>The system prompt here is interesting; it shows how the prompt tries very hard to restrict the LLM to <em>only</em> producing facts based on the files provided rather than the inherent \"knowledge\" it has. From what I've seen from my testing, this seems to work pretty well!</p> <p>That's as far as I'm going to go in this post. In the next post I describe an experiment which starts from this template and modifies it to ingest data from a website instead, so that you can chat and ask questions about the website instead.</p> <h2 id=\"summary\" class=\"heading-with-anchor\"><a href=\"https://andrewlock.net/exploring-the-new-ai-chat-template/#summary\" class=\"relative text-zinc-800 dark:text-white no-underline hover:underline\">Summary</a></h2> <p>In this post I introduced <a href=\"https://devblogs.microsoft.com/dotnet/announcing-dotnet-ai-template-preview2/\">the new .NET AI Chat Web App template (currently in preview)</a> and showed the default experience of chatting about PDF files. I then described the basic mechanics of the template, and showed some of the code and services around the core features of data ingestion and embedding generation. In the next post I show how you can modify the template to ingest data from a website instead.</p> ",
      "Language": null,
      "Link": "https://andrewlock.net/exploring-the-new-ai-chat-template/"
    }
  ]
}
