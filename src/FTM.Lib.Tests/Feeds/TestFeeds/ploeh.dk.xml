<?xml version="1.0"?>
<rss version="2.0">

  <channel>
    <title>ploeh blog</title>
    <link>https://blog.ploeh.dk</link>
    <description>danish software design</description>
    <language>en-us</language>
    <copyright>Mark Seemann</copyright>
    <pubDate>Mon, 09 Jun 2025 14:03:02 UTC</pubDate>
    <lastBuildDate>Mon, 09 Jun 2025 14:03:02 UTC</lastBuildDate>

    
      <item>
        <title>Song recommendations from combinators</title>
        <link>https://blog.ploeh.dk/2025/06/09/song-recommendations-from-combinators/</link>
        <pubDate>Mon, 09 Jun 2025 14:02:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;Interleaving impure actions with pure functions. Not really functional programming.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This article is part of a larger article series about &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;alternative ways to design with functional programming&lt;/a&gt;, particularly when faced with massive data loads. In the previous few articles, you saw &lt;a href=&quot;/2018/11/19/functional-architecture-a-definition&quot;&gt;functional architecture&lt;/a&gt; at its apparent limit. With sufficiently large data sizes, the &lt;a href=&quot;/2020/03/02/impureim-sandwich&quot;&gt;Impureim Sandwich&lt;/a&gt; pattern starts to buckle. That&apos;s really not an indictment of that pattern; only an observation that no design pattern applies universally.
    &lt;/p&gt;
    &lt;p&gt;
        In this and the next few articles, we&apos;ll instead look at a more pragmatic option. In this article I&apos;ll discuss the general idea, and follow up in other articles with examples in three different languages.
    &lt;/p&gt;
    &lt;p&gt;
        In this overall article series, I&apos;m using &lt;a href=&quot;https://tyrrrz.me/&quot;&gt;Oleksii Holub&lt;/a&gt;&apos;s inspiring article &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle&quot;&gt;Pure-Impure Segregation Principle&lt;/a&gt; as an outset for the code example. Previous articles in this article series have already covered the basics, but the gist of it is a song recommendation service that uses past play information (&apos;scrobbles&apos;) to suggest new songs to a user.
    &lt;/p&gt;
    &lt;h3 id=&quot;ae576d7ff83c4cf8b5ce96b861d3cad0&quot;&gt;
        Separating pure functions from impure composition &lt;a href=&quot;#ae576d7ff83c4cf8b5ce96b861d3cad0&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        In the original article, Oleksii Holub suggests a way to separate &lt;a href=&quot;https://en.wikipedia.org/wiki/Pure_function&quot;&gt;pure functions&lt;/a&gt; from impure actions: We may extract as much pure code from the overall algorithm as possible, but we&apos;re still left with pure functions and impure actions mixed together.
    &lt;/p&gt;
    &lt;p&gt;
        Here&apos;s my reproduction of that suggestion, with trivial modifications:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyList&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;HandleOwnScrobbles&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Scrobble&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OrderByDescending&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.ScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Take&lt;/span&gt;(100)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song.Id)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToArray&lt;/span&gt;();
 
&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyList&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;HandleOtherListeners&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;User&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;users&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;users&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Where&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.TotalScrobbleCount&amp;nbsp;&amp;gt;=&amp;nbsp;10_000)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OrderByDescending&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.TotalScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Take&lt;/span&gt;(20)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.UserName)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToArray&lt;/span&gt;();
 
&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyList&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;HandleOtherScrobbles&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Scrobble&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Where&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song.IsVerifiedArtist)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OrderByDescending&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song.Rating)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Take&lt;/span&gt;(10)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToArray&lt;/span&gt;();
 
&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyList&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;FinalizeRecommendations&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyList&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songs&lt;/span&gt;)&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songs&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;OrderByDescending&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Rating)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Take&lt;/span&gt;(200)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ToArray&lt;/span&gt;();
 
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyList&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetRecommendationsAsync&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;_songService.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopScrobblesAsync&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songIds&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;HandleOwnScrobbles&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;&amp;gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;foreach&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songId&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songIds&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListeners&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;_songService
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopListenersAsync&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songId&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherUserNames&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;HandleOtherListeners&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListeners&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;foreach&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherUserName&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherUserNames&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobbles&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;_songService
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopScrobblesAsync&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherUserName&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songsToRecommend&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;HandleOtherScrobbles&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobbles&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddRange&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songsToRecommend&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;FinalizeRecommendations&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        As Oleksii Holub writes,
    &lt;/p&gt;
    &lt;blockquote&gt;
        &lt;p&gt;
            &quot;However, instead of having one cohesive element to reason about, we ended up with multiple fragments, each having no meaning or value of their own. While unit testing of individual parts may have become easier, the benefit is very questionable, as it provides no confidence in the correctness of the algorithm as a whole.&quot;
        &lt;/p&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;
        I agree with that assessment, but still find it warranted to pursue the idea a little further. After all, my goal with this overall article series isn&apos;t to be prescriptive, but rather descriptive. By presenting and comparing alternatives, we become aware of more options. This, hopefully, helps us choose the &apos;right tool for the job&apos;.
    &lt;/p&gt;
    &lt;h3 id=&quot;eba5c36720814300b4a4127359569b46&quot;&gt;
        Triple-decker sandwich? &lt;a href=&quot;#eba5c36720814300b4a4127359569b46&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        If we look closer at this alternative, however, we find that we only need to deal with three impure actions. We might, then, postulate that this is an &lt;a href=&quot;/2023/10/09/whats-a-sandwich&quot;&gt;expanded sandwich&lt;/a&gt; - a triple-decker sandwich, if you will.
    &lt;/p&gt;
    &lt;p&gt;
        To be clear, I don&apos;t find this a reasonable argument. Even if you accept expanding the sandwich metaphor to add a pure validation step, the number of layers, and the structure of the sandwich would still be known at compile time. You may start at the impure boundary, then phase into pure validation, return to another impure step to gather data, call your &apos;main&apos; pure function, and finally write the result to some kind of output. To borrow a figure from the &lt;a href=&quot;/2023/10/09/whats-a-sandwich&quot;&gt;What&apos;s a sandwich?&lt;/a&gt; article:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/pure-impure-pure-impure-box.png&quot; alt=&quot;A box with green, red, green, and red horizontal tiers.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        On the other hand, this isn&apos;t what the above code suggestion does. The problem with the song recommendation algorithm is that the impure actions cascade. While we start with a single impure out-of-process query, we then use the result of that to loop over, and perform &lt;em&gt;n&lt;/em&gt; more queries. This, in fact, happens again, nested in the outer loop, so in terms of network calls, we&apos;re looking at an &lt;em&gt;O(n&lt;sup&gt;2&lt;/sup&gt;)&lt;/em&gt; algorithm.
    &lt;/p&gt;
    &lt;p&gt;
        We can actually be more precise than that, because the &apos;outer&apos; queries actually limit their result sets. The first query only considers the top 100 results, so we know that &lt;code&gt;GetTopListenersAsync&lt;/code&gt; is going to be called at most 100 times. The result of this call is again limited to the top 20, so that the inner calls to &lt;code&gt;GetTopScrobblesAsync&lt;/code&gt; run at most 20 * 100 = 2,000 times. In all, the upper limit is 1 + 100 + 2,000 = 2,101 network calls. (Okay, so really, this is just an &lt;em&gt;O(1)&lt;/em&gt; algorithm, although &lt;em&gt;1 ~ 2,101&lt;/em&gt;.)
    &lt;/p&gt;
    &lt;p&gt;
        Not that that isn&apos;t going to take a bit of time.
    &lt;/p&gt;
    &lt;p&gt;
        All that said, it&apos;s not execution time that concerns me in this context. Assume that the algorithm is already as optimal as possible, and that those 2,101 network calls are necessary. What rather concerns me here is how to organize the code in a way that&apos;s as maintainable as possible. As usual, when that&apos;s the main concern, I&apos;ll remind the reader to consider the example problem as a stand-in for a more complicated problem. Even Oleksii Holub&apos;s original code example is only some fifty-odd lines of code, which in itself hardly warrants all the hand-wringing we&apos;re currently subjecting it to.
    &lt;/p&gt;
    &lt;p&gt;
        Rather, what I&apos;d like to address is the dynamic back-and-forth between pure function and impure action. Each of these thousands of out-of-process calls are non-deterministic. If you&apos;re tasked with maintaining or editing this algorithm, your brain will be taxed by all that unpredictable behaviour. Many subtle bugs lurk there.
    &lt;/p&gt;
    &lt;p&gt;
        The more we can pull the code towards pure functions the better, because &lt;a href=&quot;/2021/07/28/referential-transparency-fits-in-your-head&quot;&gt;referential transparency fits in your head&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        So, to be explicit, I don&apos;t consider this kind of composition as an expanded Impureim Sandwich.
    &lt;/p&gt;
    &lt;h3 id=&quot;4903416bdf924a29a6f6043b178da4df&quot;&gt;
        Standard combinators &lt;a href=&quot;#4903416bdf924a29a6f6043b178da4df&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Is it possible to somehow improve, even just a little, on the above suggestion? Can we somehow make it look a little &apos;more functional&apos;?
    &lt;/p&gt;
    &lt;p&gt;
        We could use some standard combinators, like &lt;a href=&quot;/2022/03/28/monads&quot;&gt;monadic &lt;em&gt;bind&lt;/em&gt;&lt;/a&gt;, &lt;a href=&quot;/2024/11/11/traversals&quot;&gt;traversals&lt;/a&gt;, and so on.
    &lt;/p&gt;
    &lt;p&gt;
        To be honest, for the specific song-recommendations example, the benefit is marginal at best, but doing it would still demonstrate a particular technique. We&apos;d be able to get rid of the local mutation of &lt;code&gt;recommendationCandidates&lt;/code&gt;, but that&apos;s about it.
    &lt;/p&gt;
    &lt;p&gt;
        Even so, refactoring to self-contained expressions makes other refactoring easier. As a counter-example, imagine that you&apos;d like to extract the inner &lt;code&gt;foreach&lt;/code&gt; loop in the above code example to a helper method.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;CollectOtherUserTopScrobbles&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyList&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherUserNames&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;foreach&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherUserName&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherUserNames&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobbles&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;_songService
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopScrobblesAsync&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherUserName&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songsToRecommend&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;HandleOtherScrobbles&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobbles&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddRange&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songsToRecommend&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The call site would then look like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherUserNames&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;HandleOtherListeners&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListeners&lt;/span&gt;);
 
&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;CollectOtherUserTopScrobbles&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherUserNames&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        In this specific example, such a refactoring isn&apos;t too difficult, but it&apos;s more complicated than it could be. Because of state mutation, we have to pass the object to be modified, in this case &lt;code&gt;recommendationCandidates&lt;/code&gt;, along as a method argument. Here, there&apos;s only one, but if you have code where you change the state of two objects, you&apos;d have to pass two extra parameters, and so on.
    &lt;/p&gt;
    &lt;p&gt;
        You&apos;ve most likely worked in a real code base where you have tried to extract a helper method, only to discover that it&apos;s so incredibly tangled with the objects that it modifies that you need a long parameter list. What should have been a simplification is in danger of making everything worse.
    &lt;/p&gt;
    &lt;p&gt;
        On the other hand, self-contained expressions, even if, as in this case, they&apos;re non-deterministic, don&apos;t mutate state. In general, this tends to make it easier to extract subexpressions as helper methods, if only because they are less coupled to the rest of the code. They may required inputs as parameters, but at least you don&apos;t have to pass around objects to be modified.
    &lt;/p&gt;
    &lt;p&gt;
        Thus, the reason I find it worthwhile to include articles about this kind of refactoring is that, since it demonstrates how to refactor to a more expression-based style, you may be able to extrapolate to your own context. And who knows, you may encounter a context where more substantial improvements can be made by moving in this direction.
    &lt;/p&gt;
    &lt;p&gt;
        As usual in this article series, you&apos;ll see how to apply this technique in three different languages.
    &lt;/p&gt;
    &lt;ul&gt;
        &lt;li&gt;Song recommendations from C# combinators&lt;/li&gt;
        &lt;li&gt;Song recommendations from F# combinators&lt;/li&gt;
        &lt;li&gt;Song recommendations from Haskell combinators&lt;/li&gt;
    &lt;/ul&gt;
    &lt;p&gt;
        All that said, it&apos;s important to underscore that I don&apos;t consider this proper &lt;a href=&quot;/2018/11/19/functional-architecture-a-definition&quot;&gt;functional architecture&lt;/a&gt;. Even the Haskell example is too non-deterministic to my tastes.
    &lt;/p&gt;
    &lt;h3 id=&quot;d470d8b3fd2344788be43691aac8a29c&quot;&gt;
        Conclusion &lt;a href=&quot;#d470d8b3fd2344788be43691aac8a29c&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Perhaps the most pragmatic approach to a problem like the song-recommendations example is to allow the impure actions and pure functions to interleave. I don&apos;t mean to insist that functional programming is the only way to make code maintainable. You can organize code according to other principles, and some of them may also leave you with a code base that can serve its mission well, now and in the future.
    &lt;/p&gt;
    &lt;p&gt;
        Another factor to take into account is the skill level of the team tasked with maintaining a code base. What are they comfortable with?
    &lt;/p&gt;
    &lt;p&gt;
        Not that I think you should settle for status quo. Progress can only be made if you &lt;a href=&quot;/2015/08/03/idiomatic-or-idiosyncratic&quot;&gt;push the envelop a little&lt;/a&gt;, but you can also come up with a code base so alien to your colleagues that they can&apos;t work with it at all.
    &lt;/p&gt;
    &lt;p&gt;
        I could easily imagine a team where the solution in the next three articles is the only style they&apos;d be able to maintain.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; Song recommendations from C# combinators.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2025/06/09/song-recommendations-from-combinators</guid>
      </item>
    
      <item>
        <title>Testing races with a slow Decorator</title>
        <link>https://blog.ploeh.dk/2025/06/02/testing-races-with-a-slow-decorator/</link>
        <pubDate>Mon, 02 Jun 2025 08:03:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;Delaying database interactions for test purposes.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        In chapter 12 in &lt;a href=&quot;/2021/06/14/new-book-code-that-fits-in-your-head&quot;&gt;Code That Fits in Your Head&lt;/a&gt;, I cover a typical &lt;a href=&quot;https://en.wikipedia.org/wiki/Race_condition&quot;&gt;race condition&lt;/a&gt; and how to test for it. The book comes with a pedagogical explanation of the problem, including a diagram in the style of &lt;a href=&quot;/ref/ddia&quot;&gt;Designing Data-Intensive Applications&lt;/a&gt;. In short, the problem occurs when two or more clients are competing for the last remaining seats in a particular time slot.
    &lt;/p&gt;
    &lt;p&gt;
        In my two-day workshop based on the book, I also cover this scenario. The goal is to show how to write automated tests for this kind of non-deterministic behaviour. In the book, and in the workshop, my approach is to rely on the &lt;a href=&quot;https://en.wikipedia.org/wiki/Law_of_large_numbers&quot;&gt;law of large numbers&lt;/a&gt;. An automated test attempts to trigger the race condition by trying &apos;enough&apos; times. A timeout on the test assumes that if the test does not trigger the condition in the allotted time window, then the bug is addressed.
    &lt;/p&gt;
    &lt;p&gt;
        At one of my workshops, one participant told me of a more efficient and elegant way to test for this. I wish I could remember exactly at which workshop it was, and who the gentleman was, but alas, it escapes me.
    &lt;/p&gt;
    &lt;h3 id=&quot;05f24d2c08e34c5fbbd7e91dc8667969&quot;&gt;
        Reproducing the condition &lt;a href=&quot;#05f24d2c08e34c5fbbd7e91dc8667969&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        How do you deterministically reproduce non-deterministic behaviour? The default answer is almost tautological. You can&apos;t, since it&apos;s non-deterministic.
    &lt;/p&gt;
    &lt;p&gt;
        The irony, however, is that in the workshop, I deterministically demonstrate the problem. The problem, in short, is that in order to decide whether or not to accept a reservation request, the system first reads data from its database, runs a fairly complex piece of decision logic, and finally writes the reservation to the database - if it decides to accept it, based on what it read. When competing processes vie for the last remaining seats, a race may occur where both (or all) base their decision on the same data, so they all come to the conclusion that they still have enough remaining capacity. Again, refer to the book, and its accompanying code base, for the details.
    &lt;/p&gt;
    &lt;p&gt;
        How do I demonstrate this condition in the workshop? I go into the Controller code and insert a temporary, human-scale delay after reading from the database, but before making the decision:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservations&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservations&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;.At);
 
&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Delay&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;TimeSpan&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromSeconds&lt;/span&gt;(10));
 
&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(!MaitreD.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WillAccept&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;DateTime&lt;/span&gt;.Now,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservations&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;r&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;NoTables500InternalServerError&lt;/span&gt;();

&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Create&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;.Id,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Then I open two windows, from which I, within a couple of seconds of each other, try to make competing reservations. When the bug is present, both reservations are accepted, although, according to business rules, only one should be.
    &lt;/p&gt;
    &lt;p&gt;
        So that&apos;s how to deterministically demonstrate the problem. Just insert a long enough delay.
    &lt;/p&gt;
    &lt;p&gt;
        We can&apos;t, however, leave such delays in the production code, so I never even considered that this simple technique could be used for automated testing.
    &lt;/p&gt;
    &lt;h3 id=&quot;d908cad4489642babb34a58a37c678c7&quot;&gt;
        Slowing things down with a Decorator &lt;a href=&quot;#d908cad4489642babb34a58a37c678c7&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        That&apos;s until my workshop participant told me his trick: Why don&apos;t you slow down the database interactions for test-purposes only? At first, I thought he had in mind some nasty compiler pragmas or environment hacks, but no. Why don&apos;t you use a &lt;a href=&quot;https://en.wikipedia.org/wiki/Decorator_pattern&quot;&gt;Decorator&lt;/a&gt; to slow things down?
    &lt;/p&gt;
    &lt;p&gt;
        Indeed, why not?
    &lt;/p&gt;
    &lt;p&gt;
        Fortunately, all database interaction already takes place behind an &lt;code&gt;IReservationsRepository&lt;/code&gt; interface. Adding a test-only, delaying Decorator is straightforward.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;class&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SlowReservationsRepository&lt;/span&gt;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReservationsRepository&lt;/span&gt;
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;readonly&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TimeSpan&lt;/span&gt;&amp;nbsp;halfDelay;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SlowReservationsRepository&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TimeSpan&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;delay&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReservationsRepository&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;inner&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Delay&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;delay&lt;/span&gt;;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;halfDelay&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;delay&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;/&lt;/span&gt;&amp;nbsp;2;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Inner&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;inner&lt;/span&gt;;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TimeSpan&lt;/span&gt;&amp;nbsp;Delay&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;get&lt;/span&gt;;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReservationsRepository&lt;/span&gt;&amp;nbsp;Inner&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;get&lt;/span&gt;;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Create&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Delay&lt;/span&gt;(halfDelay);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Inner.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Create&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Delay&lt;/span&gt;(halfDelay);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Delete&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Guid&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Delay&lt;/span&gt;(halfDelay);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Inner.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Delete&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Delay&lt;/span&gt;(halfDelay);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;?&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservation&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Guid&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Delay&lt;/span&gt;(halfDelay);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Inner.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservation&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Delay&lt;/span&gt;(halfDelay);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservations&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;DateTime&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;min&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;DateTime&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;max&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Delay&lt;/span&gt;(halfDelay);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Inner.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservations&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;min&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;max&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Delay&lt;/span&gt;(halfDelay);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;result&lt;/span&gt;;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Update&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Delay&lt;/span&gt;(halfDelay);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Inner.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Update&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurantId&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Delay&lt;/span&gt;(halfDelay);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This one uniformly slows down all operations. I arbitrarily decided to split the &lt;code&gt;Delay&lt;/code&gt; in half, in order to apply half of it before each action, and the other half after. Honestly, I didn&apos;t mull this over too much; I just thought that if I did it that way, I wouldn&apos;t have to speculate whether it would make a difference if the delay happened before or after the action in question.
    &lt;/p&gt;
    &lt;h3 id=&quot;a0e3b21e6def42b781e47a98b19f2294&quot;&gt;
        Slowing down tests &lt;a href=&quot;#a0e3b21e6def42b781e47a98b19f2294&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        I added a few helper methods to the &lt;code&gt;RestaurantService&lt;/code&gt; class that inherits from &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1&quot;&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;WebApplicationFactory&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Startup&lt;/span&gt;&amp;gt;&lt;/a&gt;, mainly to enable decoration of the injected Repository. With those changes, I could now rewrite my test like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&lt;span style=&quot;color:#2b91af;&quot;&gt;Fact&lt;/span&gt;]
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;NoOverbookingRace&lt;/span&gt;()
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;date&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;DateTime&lt;/span&gt;.Now.Date.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddDays&lt;/span&gt;(1).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddHours&lt;/span&gt;(18.5);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;using&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RestaurantService&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;CreateWith&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;repo&lt;/span&gt;&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SlowReservationsRepository&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TimeSpan&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromMilliseconds&lt;/span&gt;(100),&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;repo&lt;/span&gt;));
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task1&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;PostReservation&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ReservationDtoBuilder&lt;/span&gt;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithDate&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;date&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithQuantity&lt;/span&gt;(10)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Build&lt;/span&gt;());
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task2&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;PostReservation&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ReservationDtoBuilder&lt;/span&gt;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithDate&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;date&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithQuantity&lt;/span&gt;(10)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Build&lt;/span&gt;());
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;actual&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;WhenAll&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task1&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task2&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Assert&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Single&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;actual&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;.StatusCode&amp;nbsp;==&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;HttpStatusCode&lt;/span&gt;.InternalServerError);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ok&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Assert&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Single&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;actual&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;.IsSuccessStatusCode);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Check&amp;nbsp;that&amp;nbsp;the&amp;nbsp;reservation&amp;nbsp;was&amp;nbsp;actually&amp;nbsp;created:&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetReservation&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ok&lt;/span&gt;.Headers.Location);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;EnsureSuccessStatusCode&lt;/span&gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ParseJsonContent&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ReservationDto&lt;/span&gt;&amp;gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Assert&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Equal&lt;/span&gt;(10,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;.Quantity);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The restaurant being tested has a maximum capacity of ten guests, so while it can accommodate either of the two requests, it can&apos;t make room for both.
    &lt;/p&gt;
    &lt;p&gt;
        For this example, I arbitrarily chose to configure the Decorator with a 100-millisecond delay. Every interaction with the database caused by that test gets a built-in 100-millisecond delay. 50 ms before each action, and 50 ms after.
    &lt;/p&gt;
    &lt;p&gt;
        The test starts both tasks, &lt;code&gt;task1&lt;/code&gt; and &lt;code&gt;task2&lt;/code&gt;, without awaiting them. This allows them to run concurrently. After starting both tasks, the test awaits both of them with &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.threading.tasks.task.whenall&quot;&gt;Task.WhenAll&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;a href=&quot;/2013/06/24/a-heuristic-for-formatting-code-according-to-the-aaa-pattern&quot;&gt;assertion phase&lt;/a&gt; of the test is more involved than you may be used to see. The reason is that it deals with more than one possible failure scenario.
    &lt;/p&gt;
    &lt;p&gt;
        The first two assertions (&lt;code&gt;Assert.Single&lt;/code&gt;) deal with the complete absence of transaction control in the application. In that case, both &lt;code&gt;POST&lt;/code&gt; requests succeed, which they aren&apos;t supposed to. If the system works properly, it should accept one request and reject the other.
    &lt;/p&gt;
    &lt;p&gt;
        The rest of the assertions check that the successful reservation was actually created. That&apos;s another failure scenario.
    &lt;/p&gt;
    &lt;p&gt;
        The way I chose to deal with the race condition is standard in .NET. I used a &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.transactions.transactionscope&quot;&gt;TransactionScope&lt;/a&gt;. This is peculiar and, in my opinion, questionable API that enables you to start a transaction &lt;em&gt;anywhere&lt;/em&gt; in your code, and then complete when you you&apos;re done. In the code base that accompanies &lt;a href=&quot;/code-that-fits-in-your-head&quot;&gt;Code That Fits in Your Head&lt;/a&gt;, it looks like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ActionResult&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;TryCreate&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Restaurant&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Reservation&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;using&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scope&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TransactionScope&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;TransactionScopeAsyncFlowOption&lt;/span&gt;.Enabled);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservations&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ReadReservations&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;.Id,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;.At)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;now&lt;/span&gt;&amp;nbsp;=&amp;nbsp;Clock.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetCurrentDateTime&lt;/span&gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(!&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;.MaitreD.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WillAccept&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;now&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservations&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;NoTables500InternalServerError&lt;/span&gt;();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Repository.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Create&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;.Id,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ConfigureAwait&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scope&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Complete&lt;/span&gt;();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;Reservation201Created&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;restaurant&lt;/span&gt;.Id,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Notice the &lt;code&gt;scope.Complete()&lt;/code&gt; statement towards the end.
    &lt;/p&gt;
    &lt;p&gt;
        What happens if someone forgets to call &lt;code&gt;scope.Complete()&lt;/code&gt;?
    &lt;/p&gt;
    &lt;p&gt;
        In that case, the thread that wins the race returns &lt;code&gt;201 Created&lt;/code&gt;, but when the &lt;code&gt;scope&lt;/code&gt; goes out of scope, it&apos;s disposed of. If &lt;code&gt;Complete()&lt;/code&gt; wasn&apos;t called, the transaction is rolled back, but the HTTP response code remains &lt;code&gt;201&lt;/code&gt;. Thus, the two assertions that inspect the response codes aren&apos;t enough to catch this particular kind of defect.
    &lt;/p&gt;
    &lt;p&gt;
        Instead, the test subsequently queries the System Under Test to verify that the resource was, indeed, created.
    &lt;/p&gt;
    &lt;h3 id=&quot;064b9e4646544b60b47b25e2cc4cc8a5&quot;&gt;
        Wait time &lt;a href=&quot;#064b9e4646544b60b47b25e2cc4cc8a5&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The original test shown in the book times out after 30 seconds if it can&apos;t produce the race condition. Compared to that, the refactored test shown here is &lt;em&gt;fast&lt;/em&gt;. Even so, we may fear that it spends too much time doing nothing. How much time might that be?
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;TryCreate&lt;/code&gt; helper method shown above is the only part of a &lt;code&gt;POST&lt;/code&gt; request that interacts with the Repository. As you can see, it calls it twice: Once to read, and once to write, if it decides to do that. With a 100 ms delay, that&apos;s 200 ms.
    &lt;/p&gt;
    &lt;p&gt;
        And while the test issues two &lt;code&gt;POST&lt;/code&gt; requests, they run in parallel. That&apos;s the whole point. It means that they&apos;ll still run in approximately 200 ms.
    &lt;/p&gt;
    &lt;p&gt;
        The test then issues a &lt;code&gt;GET&lt;/code&gt; request to verify that the resource was created. That triggers another database read, which takes another 100 ms.
    &lt;/p&gt;
    &lt;p&gt;
        That&apos;s 300 ms in all. Given that these tests are part of a second-level test suite, and not your default developer test suite, that may be good enough.
    &lt;/p&gt;
    &lt;p&gt;
        Still, that&apos;s the &lt;code&gt;POST&lt;/code&gt; scenario. I also wrote a test that checks for a race condition when doing &lt;code&gt;PUT&lt;/code&gt; requests, and it performs more work.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&lt;span style=&quot;color:#2b91af;&quot;&gt;Fact&lt;/span&gt;]
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;NoOverbookingPutRace&lt;/span&gt;()
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;date&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;DateTime&lt;/span&gt;.Now.Date.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddDays&lt;/span&gt;(1).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddHours&lt;/span&gt;(18.5);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;using&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RestaurantService&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;CreateWith&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;repo&lt;/span&gt;&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SlowReservationsRepository&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TimeSpan&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromMilliseconds&lt;/span&gt;(100),&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;repo&lt;/span&gt;));
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;address1&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto1&lt;/span&gt;)&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;PostReservation&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;date&lt;/span&gt;,&amp;nbsp;4);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;address2&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto2&lt;/span&gt;)&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;PostReservation&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;date&lt;/span&gt;,&amp;nbsp;4);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto1&lt;/span&gt;.Quantity&amp;nbsp;+=&amp;nbsp;2;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto2&lt;/span&gt;.Quantity&amp;nbsp;+=&amp;nbsp;2;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task1&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;PutReservation&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;address1&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto1&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task2&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;PutReservation&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;address2&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;dto2&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;actual&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;WhenAll&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task1&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task2&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Assert&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Single&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;actual&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;.StatusCode&amp;nbsp;==&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;HttpStatusCode&lt;/span&gt;.InternalServerError);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ok&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Assert&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Single&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;actual&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;.IsSuccessStatusCode);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Check&amp;nbsp;that&amp;nbsp;the&amp;nbsp;reservations&amp;nbsp;now&amp;nbsp;have&amp;nbsp;consistent&amp;nbsp;values:&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;client&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;CreateClient&lt;/span&gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp1&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;client&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetAsync&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;address1&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp2&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;client&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetAsync&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;address2&lt;/span&gt;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp1&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;EnsureSuccessStatusCode&lt;/span&gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp2&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;EnsureSuccessStatusCode&lt;/span&gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;body1&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp1&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ParseJsonContent&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ReservationDto&lt;/span&gt;&amp;gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;body2&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp2&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ParseJsonContent&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ReservationDto&lt;/span&gt;&amp;gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Assert&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Single&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;[]&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;body1&lt;/span&gt;.Quantity,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;body2&lt;/span&gt;.Quantity&amp;nbsp;},&amp;nbsp;6);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Assert&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Single&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;[]&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;body1&lt;/span&gt;.Quantity,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;body2&lt;/span&gt;.Quantity&amp;nbsp;},&amp;nbsp;4);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This test first has to create two reservations in a nice, sequential manner. Then it attempts to perform two concurrent updates, and finally it tests that all is as it should be: That both reservations still exist, but only one had its &lt;code&gt;Quantity&lt;/code&gt; increased to &lt;code&gt;6&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        This test first makes two &lt;code&gt;POST&lt;/code&gt; requests, nicely serialized so as to avoid a race condition. That&apos;s 400 ms.
    &lt;/p&gt;
    &lt;p&gt;
        Each &lt;code&gt;PUT&lt;/code&gt; request triggers three Repository actions, for a total of 300 ms (since they run in parallel).
    &lt;/p&gt;
    &lt;p&gt;
        Finally, the test issues two &lt;code&gt;GET&lt;/code&gt; requests for verification, for another 2 times 100 ms. Now that I&apos;m writing this, I realize that I could also have parallelized these two calls, but as you read on, you&apos;ll see why that&apos;s not necessary.
    &lt;/p&gt;
    &lt;p&gt;
        In all, this test waits for 900 ms. That&apos;s almost a second.
    &lt;/p&gt;
    &lt;p&gt;
        Can we improve on that?
    &lt;/p&gt;
    &lt;h3 id=&quot;b5c26b0e8a80487db636d47cd408cf3a&quot;&gt;
        Decreasing unnecessary wait time &lt;a href=&quot;#b5c26b0e8a80487db636d47cd408cf3a&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        In the latter example, the 300 ms wait time for the parallel &lt;code&gt;PUT&lt;/code&gt; requests are necessary to trigger the race condition, but the rest of the test&apos;s actions don&apos;t need slowing down. We can remove the unwarranted wait time by setting up two services: One slow, and one normal.
    &lt;/p&gt;
    &lt;p&gt;
        To be honest, I could have modelled this by just instantiating two service objects, but why do something as pedestrian as that when you can turn &lt;code&gt;RestaurantService&lt;/code&gt; into a &lt;a href=&quot;/2020/10/19/monomorphic-functors&quot;&gt;monomorphic functor&lt;/a&gt;?
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;internal&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RestaurantService&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Select&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Func&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReservationsRepository&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReservationsRepository&lt;/span&gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;is&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;throw&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ArgumentNullException&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;nameof&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;));
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RestaurantService&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;selector&lt;/span&gt;(repository));
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Granted, this is verging on the frivolous, but when writing code for a blog post, I think I&apos;m allowed a little fun.
    &lt;/p&gt;
    &lt;p&gt;
        In any case, this now enables me to rewrite the test like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&lt;span style=&quot;color:#2b91af;&quot;&gt;Fact&lt;/span&gt;]
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;NoOverbookingRace&lt;/span&gt;()
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;date&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;DateTime&lt;/span&gt;.Now.Date.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddDays&lt;/span&gt;(1).&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddHours&lt;/span&gt;(18.5);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;using&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RestaurantService&lt;/span&gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;using&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;slowService&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;repo&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;select&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SlowReservationsRepository&lt;/span&gt;(&lt;span style=&quot;color:#2b91af;&quot;&gt;TimeSpan&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;FromMilliseconds&lt;/span&gt;(100),&amp;nbsp;repo);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task1&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;slowService&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;PostReservation&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ReservationDtoBuilder&lt;/span&gt;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithDate&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;date&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithQuantity&lt;/span&gt;(10)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Build&lt;/span&gt;());
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task2&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;slowService&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;PostReservation&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ReservationDtoBuilder&lt;/span&gt;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithDate&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;date&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;WithQuantity&lt;/span&gt;(10)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Build&lt;/span&gt;());
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;actual&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;WhenAll&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task1&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;task2&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Assert&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Single&lt;/span&gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;actual&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;.StatusCode&amp;nbsp;==&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;HttpStatusCode&lt;/span&gt;.InternalServerError);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ok&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Assert&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Single&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;actual&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;msg&lt;/span&gt;.IsSuccessStatusCode);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Check&amp;nbsp;that&amp;nbsp;the&amp;nbsp;reservation&amp;nbsp;was&amp;nbsp;actually&amp;nbsp;created:&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;service&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetReservation&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ok&lt;/span&gt;.Headers.Location);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;EnsureSuccessStatusCode&lt;/span&gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#8f08c4;&quot;&gt;await&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;resp&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ParseJsonContent&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;ReservationDto&lt;/span&gt;&amp;gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Assert&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;Equal&lt;/span&gt;(10,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;reservation&lt;/span&gt;.Quantity);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Notice how only the parallel execution of &lt;code&gt;task1&lt;/code&gt; and &lt;code&gt;task2&lt;/code&gt; run on the slow system. The rest runs as fast as it can. It&apos;s as if the client was hitting two different servers that just happen to connect to the same database. Now the test only waits for the 200 ms described above. The &lt;code&gt;PUT&lt;/code&gt; test, likewise, only idles for 300 ms instead of 900 ms.
    &lt;/p&gt;
    &lt;h3 id=&quot;90a4897a10b24d2c98d09129884f7e13&quot;&gt;
        Near-deterministic tests &lt;a href=&quot;#90a4897a10b24d2c98d09129884f7e13&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Does this deterministically reproduce the race condition? In practice, it may move us close enough, but theoretically the race is still on. With the increased wait time, it&apos;s now much more unlikely that the race condition does &lt;em&gt;not&lt;/em&gt; happen, but it still could.
    &lt;/p&gt;
    &lt;p&gt;
        Imagine that &lt;code&gt;task1&lt;/code&gt; queries the Repository. Just as it&apos;s received a response, but before &lt;code&gt;task2&lt;/code&gt; starts its query, execution is paused, perhaps because of garbage collection. Once the program resumes, &lt;code&gt;task1&lt;/code&gt; runs to completion before &lt;code&gt;task2&lt;/code&gt; reads from the database. In that case, &lt;code&gt;task2&lt;/code&gt; ends up making the right decision, rejecting the reservation. Even if no transaction control were in place.
    &lt;/p&gt;
    &lt;p&gt;
        This may not be a particularly realistic scenario, but I suppose it could happen if the computer is stressed in general. Even so, you might decide to make such &lt;a href=&quot;https://en.wikipedia.org/wiki/False_positives_and_false_negatives&quot;&gt;false-negative&lt;/a&gt; scenarios even more unlikely by increasing the delay time. Of course, the downside is that tests take even longer to run.
    &lt;/p&gt;
    &lt;p&gt;
        Another potential problem is that there&apos;s no &lt;em&gt;guarantee&lt;/em&gt; that &lt;code&gt;task1&lt;/code&gt; and &lt;code&gt;task2&lt;/code&gt; run in parallel. Even if the test doesn&apos;t &lt;code&gt;await&lt;/code&gt; any of the tasks, both start executing immediately. There&apos;s an (unlikely) chance that &lt;code&gt;task1&lt;/code&gt; completes before &lt;code&gt;task2&lt;/code&gt; starts. Again, I don&apos;t consider this likely, but I suppose it could happen because of thread starvation, generation 2 garbage collection, the disk running full, etc. The point is that the test shown here is still playing the odds, even if the odds are really good.
    &lt;/p&gt;
    &lt;h3 id=&quot;335493859fd0494488353e60de46c9c3&quot;&gt;
        Conclusion &lt;a href=&quot;#335493859fd0494488353e60de46c9c3&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Instead of running a scenario &apos;enough&apos; times that reproducing a race condition is likely, you can increase the odds to near-certainty by slowing down the race. In this example, the race involves a database, but you might also encounter race conditions internally in multi-threaded code. I&apos;m not insisting that the technique described in this article applies universally, but if you can slow down certain interactions in the right way, you may be able reproduce problems as automated tests.
    &lt;/p&gt;
    &lt;p&gt;
        If you&apos;ve ever troubleshot a race condition, you&apos;ve probably tried inserting sleeps into the code in various places to understand the problem. As described above, a single, strategically-placed &lt;code&gt;Task.Delay&lt;/code&gt; may be all you need to reproduce a problem. What escaped me for a long time, however, was that I didn&apos;t realize that I could cleanly insert such pauses into production code. Until my workshop participant suggested using a Decorator.
    &lt;/p&gt;
    &lt;p&gt;
        A delaying Decorator slows interactions with the database down sufficiently to reproduce the race condition as an automated test.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2025/06/02/testing-races-with-a-slow-decorator</guid>
      </item>
    
      <item>
        <title>Song recommendations as a Haskell Impureim Sandwich</title>
        <link>https://blog.ploeh.dk/2025/05/26/song-recommendations-as-a-haskell-impureim-sandwich/</link>
        <pubDate>Mon, 26 May 2025 07:15:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;A pure function on potentially massive data.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This article is part of a larger article series called &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;Alternative ways to design with functional programming&lt;/a&gt;. As the title suggests, these articles discuss various ways to apply functional-programming principles to a particular problem. All the articles engage with the same problem. In short, the task is to calculate song recommendations for a user, based on massive data sets. Earlier articles in this series give you detailed explanation of the problem.
    &lt;/p&gt;
    &lt;p&gt;
        In the &lt;a href=&quot;/2025/05/19/song-recommendations-as-an-f-impureim-sandwich&quot;&gt;previous article&lt;/a&gt;, you saw how to refactor the &apos;base&apos; &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt; code base to a &lt;a href=&quot;https://en.wikipedia.org/wiki/Pure_function&quot;&gt;pure function&lt;/a&gt;. In this article, you&apos;ll see the same refactoring applied to the &apos;base&apos; &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt; code base shown in &lt;a href=&quot;/2025/04/21/porting-song-recommendations-to-haskell&quot;&gt;Porting song recommendations to Haskell&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The Git branch discussed in this article is the &lt;em&gt;pure-function&lt;/em&gt; branch in the Haskell Git repository.
    &lt;/p&gt;
    &lt;h3 id=&quot;0ed27ab7abea4417918789c4e30e1204&quot;&gt;
        Collecting all the data &lt;a href=&quot;#0ed27ab7abea4417918789c4e30e1204&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Like in the previous articles, we may start by adding two more methods to the &lt;code&gt;SongService&lt;/code&gt; type class, which will enable us to enumerate all songs and all users. The full type class, with all four methods, then looks like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;class&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SongService&lt;/span&gt;&amp;nbsp;a&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;where&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;getAllSongs&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;a&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IO&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Song&lt;/span&gt;]
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;getAllUsers&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;a&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IO&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;User&lt;/span&gt;]
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;getTopListeners&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;a&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IO&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;User&lt;/span&gt;]
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;getTopScrobbles&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;a&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IO&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Scrobble&lt;/span&gt;]&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        If you compare with the type class definition shown in the article &lt;a href=&quot;/2025/04/21/porting-song-recommendations-to-haskell&quot;&gt;Porting song recommendations to Haskell&lt;/a&gt;, you&apos;ll see that &lt;code&gt;getAllSongs&lt;/code&gt; and &lt;code&gt;getAllUsers&lt;/code&gt; are the new methods.
    &lt;/p&gt;
    &lt;p&gt;
        They enable you to collect all top listeners, and all top scrobbles, even though it may take some time. To gather all the top listeners, we may add this &lt;code&gt;collectAllTopListeners&lt;/code&gt; action:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;collectAllTopListeners&amp;nbsp;srvc&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;songs&amp;nbsp;&amp;lt;-&amp;nbsp;getAllSongs&amp;nbsp;srvc
&amp;nbsp;&amp;nbsp;listeners&amp;nbsp;&amp;lt;-&amp;nbsp;newIORef&amp;nbsp;Map.empty
&amp;nbsp;&amp;nbsp;forM_&amp;nbsp;songs&amp;nbsp;$&amp;nbsp;\song&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;topListeners&amp;nbsp;&amp;lt;-&amp;nbsp;getTopListeners&amp;nbsp;srvc&amp;nbsp;$&amp;nbsp;songId&amp;nbsp;song
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;modifyIORef&amp;nbsp;listeners&amp;nbsp;(Map.insert&amp;nbsp;(songId&amp;nbsp;song)&amp;nbsp;topListeners)
&amp;nbsp;&amp;nbsp;readIORef&amp;nbsp;listeners&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Likewise, you can amass all the top scrobbles with a similar action:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;collectAllTopScrobbles&amp;nbsp;srvc&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;users&amp;nbsp;&amp;lt;-&amp;nbsp;getAllUsers&amp;nbsp;srvc
&amp;nbsp;&amp;nbsp;scrobbles&amp;nbsp;&amp;lt;-&amp;nbsp;newIORef&amp;nbsp;Map.empty
&amp;nbsp;&amp;nbsp;forM_&amp;nbsp;users&amp;nbsp;$&amp;nbsp;\user&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;topScrobbles&amp;nbsp;&amp;lt;-&amp;nbsp;getTopScrobbles&amp;nbsp;srvc&amp;nbsp;$&amp;nbsp;userName&amp;nbsp;user
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;modifyIORef&amp;nbsp;scrobbles&amp;nbsp;(Map.insert&amp;nbsp;(userName&amp;nbsp;user)&amp;nbsp;topScrobbles)
&amp;nbsp;&amp;nbsp;readIORef&amp;nbsp;scrobbles&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        As you may have noticed, they&apos;re so similar that, had there been &lt;a href=&quot;https://en.wikipedia.org/wiki/Rule_of_three_(computer_programming)&quot;&gt;more than two&lt;/a&gt;, we might consider extracting the similar parts to a reusable operation.
    &lt;/p&gt;
    &lt;p&gt;
        In both cases, we start with the action that enables us to enumerate all the resources (songs or scrobbles) that we&apos;re interested in. For each of these, we then invoke the action to get the &apos;top&apos; resources for that song or scrobble. There&apos;s a massive &lt;em&gt;n+1&lt;/em&gt; problem here, but you could conceivably parallelize all these queries, as they&apos;re independent. Still, it&apos;s bound to take much time, possibly hours.
    &lt;/p&gt;
    &lt;p&gt;
        You may be wondering why I chose to use &lt;code&gt;IORef&lt;/code&gt; values for both actions, instead of more &lt;a href=&quot;/2015/08/03/idiomatic-or-idiosyncratic&quot;&gt;idiomatic&lt;/a&gt; combinator-based expressions. Indeed, that is what I would usually do, but in this case, these two actions are heavily IO-bound already, and it makes the Haskell code more similar to the F# code. Not that that is normally a goal, but here I thought it might help you, the reader, to compare the different code bases.
    &lt;/p&gt;
    &lt;p&gt;
        All the data is kept in a &lt;a href=&quot;https://hackage.haskell.org/package/containers/docs/Data-Map-Strict.html&quot;&gt;Map&lt;/a&gt; per action, so two massive maps in all. Once these two actions return, we&apos;re done with the &lt;em&gt;read&lt;/em&gt; phase of the &lt;a href=&quot;/2025/01/13/recawr-sandwich&quot;&gt;Recawr Sandwich&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;5378c29512584cab95d484b1bdd97fd9&quot;&gt;
        Referentially transparent function with local mutation &lt;a href=&quot;#5378c29512584cab95d484b1bdd97fd9&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        As a first step, we may wish to turn the &lt;code&gt;getRecommendations&lt;/code&gt; action into a &lt;a href=&quot;https://en.wikipedia.org/wiki/Referential_transparency&quot;&gt;referentially transparent&lt;/a&gt; function. If you look through the commits in the Git repository, you can see that I actually did this through a series of &lt;a href=&quot;https://www.industriallogic.com/blog/whats-this-about-micro-commits/&quot;&gt;micro-commits&lt;/a&gt;, but here I only present a more coarse-grained version of the changes I made.
    &lt;/p&gt;
    &lt;p&gt;
        In this version, I&apos;ve removed the &lt;code&gt;srvc&lt;/code&gt; (&lt;code&gt;SongService&lt;/code&gt;) parameter, and instead added the two maps &lt;code&gt;topScrobbles&lt;/code&gt; and &lt;code&gt;topListeners&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;getRecommendations&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Map&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Scrobble&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Map&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Int&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;User&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IO&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Song&lt;/span&gt;]
getRecommendations&amp;nbsp;topScrobbles&amp;nbsp;topListeners&amp;nbsp;un&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;1.&amp;nbsp;Get&amp;nbsp;user&amp;#39;s&amp;nbsp;own&amp;nbsp;top&amp;nbsp;scrobbles
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;2.&amp;nbsp;Get&amp;nbsp;other&amp;nbsp;users&amp;nbsp;who&amp;nbsp;listened&amp;nbsp;to&amp;nbsp;the&amp;nbsp;same&amp;nbsp;songs
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;3.&amp;nbsp;Get&amp;nbsp;top&amp;nbsp;scrobbles&amp;nbsp;of&amp;nbsp;those&amp;nbsp;users
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;4.&amp;nbsp;Aggregate&amp;nbsp;the&amp;nbsp;songs&amp;nbsp;into&amp;nbsp;recommendations
&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;scrobbles&amp;nbsp;=&amp;nbsp;Map.findWithDefault&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;[]&lt;/span&gt;&amp;nbsp;un&amp;nbsp;topScrobbles
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;scrobblesSnapshot&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;100&amp;nbsp;$&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;scrobbleCount)&amp;nbsp;scrobbles
 
&amp;nbsp;&amp;nbsp;recommendationCandidates&amp;nbsp;&amp;lt;-&amp;nbsp;newIORef&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;[]&lt;/span&gt;
&amp;nbsp;&amp;nbsp;forM_&amp;nbsp;scrobblesSnapshot&amp;nbsp;$&amp;nbsp;\scrobble&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;otherListeners&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Map.findWithDefault&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;[]&lt;/span&gt;&amp;nbsp;(songId&amp;nbsp;$&amp;nbsp;scrobbledSong&amp;nbsp;scrobble)&amp;nbsp;topListeners
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;otherListenersSnapshot&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;20&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;userScrobbleCount)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;((10_000&amp;nbsp;&amp;lt;=)&amp;nbsp;.&amp;nbsp;userScrobbleCount)&amp;nbsp;otherListeners
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;forM_&amp;nbsp;otherListenersSnapshot&amp;nbsp;$&amp;nbsp;\otherListener&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;otherScrobbles&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Map.findWithDefault&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;[]&lt;/span&gt;&amp;nbsp;(userName&amp;nbsp;otherListener)&amp;nbsp;topScrobbles
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;otherScrobblesSnapshot&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;10&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;songRating&amp;nbsp;.&amp;nbsp;scrobbledSong)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(songHasVerifiedArtist&amp;nbsp;.&amp;nbsp;scrobbledSong)&amp;nbsp;otherScrobbles
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;forM_&amp;nbsp;otherScrobblesSnapshot&amp;nbsp;$&amp;nbsp;\otherScrobble&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;song&amp;nbsp;=&amp;nbsp;scrobbledSong&amp;nbsp;otherScrobble
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;modifyIORef&amp;nbsp;recommendationCandidates&amp;nbsp;(song&amp;nbsp;:)
 
&amp;nbsp;&amp;nbsp;recommendations&amp;nbsp;&amp;lt;-&amp;nbsp;readIORef&amp;nbsp;recommendationCandidates
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;$&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;200&amp;nbsp;$&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;songRating)&amp;nbsp;recommendations&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        You&apos;ve probably noticed that this action still looks impure, since it returns &lt;code&gt;IO [Song]&lt;/code&gt;. Even so, it&apos;s referentially transparent, since it&apos;s fully deterministic and without side effects.
    &lt;/p&gt;
    &lt;p&gt;
        The way I refactored the action, this order of changes was what made most sense to me. Getting rid of the &lt;code&gt;SongService&lt;/code&gt; parameter was more important to me than getting rid of the &lt;code&gt;IO&lt;/code&gt; wrapper.
    &lt;/p&gt;
    &lt;p&gt;
        In any case, this is only an interim state towards a more idiomatic pure Haskell function.
    &lt;/p&gt;
    &lt;h3 id=&quot;5eba5b02d8724403b8ea6f26054fc9af&quot;&gt;
        A single expression &lt;a href=&quot;#5eba5b02d8724403b8ea6f26054fc9af&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        A curious property of expression-based languages is that you can conceivably write functions in &apos;one line of code&apos;. Granted, it would often be a terribly wide line, not at all readable, a beast to maintain, and often with poor performance, so not something you&apos;d want to alway do.
    &lt;/p&gt;
    &lt;p&gt;
        In this case, however, we &lt;em&gt;can&lt;/em&gt; do that, although in order to stay within an &lt;a href=&quot;/2019/11/04/the-80-24-rule&quot;&gt;80x24 box&lt;/a&gt;, we break the expression over multiple lines.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;getRecommendations&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Map&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Scrobble&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Map&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Int&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;User&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Song&lt;/span&gt;]
getRecommendations&amp;nbsp;topScrobbles&amp;nbsp;topListeners&amp;nbsp;un&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;1.&amp;nbsp;Get&amp;nbsp;user&amp;#39;s&amp;nbsp;own&amp;nbsp;top&amp;nbsp;scrobbles
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;2.&amp;nbsp;Get&amp;nbsp;other&amp;nbsp;users&amp;nbsp;who&amp;nbsp;listened&amp;nbsp;to&amp;nbsp;the&amp;nbsp;same&amp;nbsp;songs
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;3.&amp;nbsp;Get&amp;nbsp;top&amp;nbsp;scrobbles&amp;nbsp;of&amp;nbsp;those&amp;nbsp;users
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;4.&amp;nbsp;Aggregate&amp;nbsp;the&amp;nbsp;songs&amp;nbsp;into&amp;nbsp;recommendations
&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;200&amp;nbsp;$
&amp;nbsp;&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;songRating)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fmap&lt;/span&gt;&amp;nbsp;scrobbledSong&amp;nbsp;$
&amp;nbsp;&amp;nbsp;(\otherListener&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;10&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;songRating&amp;nbsp;.&amp;nbsp;scrobbledSong)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(songHasVerifiedArtist&amp;nbsp;.&amp;nbsp;scrobbledSong)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Map.findWithDefault&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;[]&lt;/span&gt;&amp;nbsp;(userName&amp;nbsp;otherListener)&amp;nbsp;topScrobbles)&amp;nbsp;=&amp;lt;&amp;lt;
&amp;nbsp;&amp;nbsp;(\scrobble&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;20&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;userScrobbleCount)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;((10_000&amp;nbsp;&amp;lt;=)&amp;nbsp;.&amp;nbsp;userScrobbleCount)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Map.findWithDefault&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;[]&lt;/span&gt;&amp;nbsp;(songId&amp;nbsp;$&amp;nbsp;scrobbledSong&amp;nbsp;scrobble)&amp;nbsp;topListeners)&amp;nbsp;=&amp;lt;&amp;lt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;100
&amp;nbsp;&amp;nbsp;(sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;scrobbleCount)&amp;nbsp;$&amp;nbsp;Map.findWithDefault&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;[]&lt;/span&gt;&amp;nbsp;un&amp;nbsp;topScrobbles)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This snapshot also got rid of the &lt;code&gt;IORef&lt;/code&gt; value, and &lt;code&gt;IO&lt;/code&gt; in general. The function is still referentially transparent, but now Haskell can also see that.
    &lt;/p&gt;
    &lt;p&gt;
        Even so, this looks dense and confusing. It doesn&apos;t help that Haskell should usually be read right-to-left, and bottom-to-top. Is it possible to improve the readability of this function?
    &lt;/p&gt;
    &lt;h3 id=&quot;c621ff8635bd4eabaa085b7b7d4a8c75&quot;&gt;
        Composition from smaller functions &lt;a href=&quot;#c621ff8635bd4eabaa085b7b7d4a8c75&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        To improve readability and maintainability, we may now extract helper functions. The first one easily suggests itself.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;getUsersOwnTopScrobbles&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Ord&lt;/span&gt;&amp;nbsp;k&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;=&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Map&lt;/span&gt;&amp;nbsp;k&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Scrobble&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;k&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Scrobble&lt;/span&gt;]
getUsersOwnTopScrobbles&amp;nbsp;topScrobbles&amp;nbsp;un&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;100&amp;nbsp;$
&amp;nbsp;&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;scrobbleCount)&amp;nbsp;$&amp;nbsp;Map.findWithDefault&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;[]&lt;/span&gt;&amp;nbsp;un&amp;nbsp;topScrobbles&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Each of the subexpressions in the above code listing are candidates for the same kind of treatment, like this one:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;getOtherUsersWhoListenedToTheSameSongs&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Map&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Int&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;User&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Scrobble&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;User&lt;/span&gt;]
getOtherUsersWhoListenedToTheSameSongs&amp;nbsp;topListeners&amp;nbsp;scrobble&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;20&amp;nbsp;$
&amp;nbsp;&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;userScrobbleCount)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;((10_000&amp;nbsp;&amp;lt;=)&amp;nbsp;.&amp;nbsp;userScrobbleCount)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;Map.findWithDefault&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;[]&lt;/span&gt;&amp;nbsp;(songId&amp;nbsp;$&amp;nbsp;scrobbledSong&amp;nbsp;scrobble)&amp;nbsp;topListeners&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        You can&apos;t see it from the code listings themselves, but the module doesn&apos;t export these functions. They remain implementation details.
    &lt;/p&gt;
    &lt;p&gt;
        With a few more helper functions, you can now implement the &lt;code&gt;getRecommendations&lt;/code&gt; function by composing the helpers.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;getRecommendations&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Map&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Scrobble&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Map&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Int&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;User&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Song&lt;/span&gt;]
getRecommendations&amp;nbsp;topScrobbles&amp;nbsp;topListeners&amp;nbsp;un&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;1.&amp;nbsp;Get&amp;nbsp;user&amp;#39;s&amp;nbsp;own&amp;nbsp;top&amp;nbsp;scrobbles
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;2.&amp;nbsp;Get&amp;nbsp;other&amp;nbsp;users&amp;nbsp;who&amp;nbsp;listened&amp;nbsp;to&amp;nbsp;the&amp;nbsp;same&amp;nbsp;songs
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;3.&amp;nbsp;Get&amp;nbsp;top&amp;nbsp;scrobbles&amp;nbsp;of&amp;nbsp;those&amp;nbsp;users
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;4.&amp;nbsp;Aggregate&amp;nbsp;the&amp;nbsp;songs&amp;nbsp;into&amp;nbsp;recommendations
&lt;/span&gt;
&amp;nbsp;&amp;nbsp;aggregateSongsIntoRecommendations&amp;nbsp;$
&amp;nbsp;&amp;nbsp;getTopSongsOfOtherUser&amp;nbsp;topScrobbles&amp;nbsp;=&amp;lt;&amp;lt;
&amp;nbsp;&amp;nbsp;getOtherUsersWhoListenedToTheSameSongs&amp;nbsp;topListeners&amp;nbsp;=&amp;lt;&amp;lt;
&amp;nbsp;&amp;nbsp;getUsersOwnTopScrobbles&amp;nbsp;topScrobbles&amp;nbsp;un&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Since Haskell by default composes from right to left, when you break such a composition over multiple lines (in order to stay within a &lt;a href=&quot;/2019/11/04/the-80-24-rule&quot;&gt;80x24&lt;/a&gt; box), it should be read bottom-up.
    &lt;/p&gt;
    &lt;p&gt;
        You can remedy this situation by importing the &lt;code&gt;&amp;&lt;/code&gt; operator from &lt;a href=&quot;https://hackage.haskell.org/package/base-4.21.0.0/docs/Data-Function.html&quot;&gt;Data.Function&lt;/a&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;getRecommendations&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Map&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Scrobble&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Map&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Int&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;User&lt;/span&gt;]&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Song&lt;/span&gt;]
getRecommendations&amp;nbsp;topScrobbles&amp;nbsp;topListeners&amp;nbsp;un&amp;nbsp;=&amp;nbsp;
&amp;nbsp;&amp;nbsp;getUsersOwnTopScrobbles&amp;nbsp;topScrobbles&amp;nbsp;un&amp;nbsp;&amp;gt;&amp;gt;=
&amp;nbsp;&amp;nbsp;getOtherUsersWhoListenedToTheSameSongs&amp;nbsp;topListeners&amp;nbsp;&amp;gt;&amp;gt;=
&amp;nbsp;&amp;nbsp;getTopSongsOfOtherUser&amp;nbsp;topScrobbles&amp;nbsp;&amp;amp;
&amp;nbsp;&amp;nbsp;aggregateSongsIntoRecommendations&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Notice that I&apos;ve named each of the helper functions after the code comments that accompanied the previous incarnations of this function. If we consider &lt;a href=&quot;http://butunclebob.com/ArticleS.TimOttinger.ApologizeIncode&quot;&gt;code comments apologies for not properly organizing the code&lt;/a&gt;, we&apos;ve now managed to structure it in such a way that those apologies are no longer required.
    &lt;/p&gt;
    &lt;h3 id=&quot;b934bca9ccf5403491d86a418d0ca8a3&quot;&gt;
        Conclusion &lt;a href=&quot;#b934bca9ccf5403491d86a418d0ca8a3&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        If you accept the (perhaps preposterous) assumption that it&apos;s possible to fit the required data in &lt;a href=&quot;https://en.wikipedia.org/wiki/Persistent_data_structure&quot;&gt;persistent data structures&lt;/a&gt;, refactoring the recommendation algorithm to a pure function isn&apos;t that difficult. That&apos;s the pure part of a Recawr Sandwich. While I haven&apos;t shown the actual sandwich here, it&apos;s quite straightforward. You can find it in the tests in the Haskell Git repository. Also, once you&apos;ve moved all the data collection to the boundary of the application, you may no longer need the &lt;code&gt;SongService&lt;/code&gt; type class.
    &lt;/p&gt;
    &lt;p&gt;
        I find the final incarnation of the code shown here to be quite attractive. While I&apos;ve kept the helper functions private to the module, it&apos;s always an option to export them if you find that warranted. This could improve testability of the overall code base, albeit at the risk of increasing the surface area of the API that you have to maintain and secure.
    &lt;/p&gt;
    &lt;p&gt;
        There are always trade-offs to be considered. Even if you, eventually, find that for this particular example, the input data size is just &lt;em&gt;too&lt;/em&gt; big to make this alternative viable, there are, in my experience, many other situations when this kind of architecture is a good solution. Even if the input size is a decent amount of megabytes, the simplification offered by an &lt;a href=&quot;/2020/03/02/impureim-sandwich&quot;&gt;Impureim Sandwich&lt;/a&gt; may trump the larger memory footprint. As always, if you&apos;re concerned about performance, &lt;a href=&quot;https://ericlippert.com/2012/12/17/performance-rant/&quot;&gt;measure it&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        This article concludes the overview of using an Recawr Sandwich to address the problem. Since it&apos;s, admittedly, a bit of a stretch to imagine running a program that uses terabytes (or more) of memory, we now turn to alternative architectures.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2025/06/09/song-recommendations-from-combinators&quot;&gt;Song recommendations from combinators&lt;/a&gt;.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2025/05/26/song-recommendations-as-a-haskell-impureim-sandwich</guid>
      </item>
    
      <item>
        <title>Song recommendations as an F# Impureim Sandwich</title>
        <link>https://blog.ploeh.dk/2025/05/19/song-recommendations-as-an-f-impureim-sandwich/</link>
        <pubDate>Mon, 19 May 2025 08:06:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;A pure function on potentially massive data.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This article is part of a larger article series titled &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;Alternative ways to design with functional programming&lt;/a&gt;. In the &lt;a href=&quot;/2025/05/05/song-recommendations-as-a-c-impureim-sandwich&quot;&gt;previous article&lt;/a&gt;, you saw an example of applying the &lt;a href=&quot;/2020/03/02/impureim-sandwich&quot;&gt;Impureim Sandwich&lt;/a&gt; pattern to the problem at hand: A song recommendation engine that sifts through much historical data.
    &lt;/p&gt;
    &lt;p&gt;
        As already covered in &lt;a href=&quot;/2025/04/28/song-recommendations-as-an-impureim-sandwich&quot;&gt;Song recommendations as an Impureim Sandwich&lt;/a&gt;, the drawback, if you will, of a &lt;a href=&quot;/2025/01/13/recawr-sandwich&quot;&gt;Recawr Sandwich&lt;/a&gt; is that you need to collect all data from impure sources before you can pass it to a &lt;a href=&quot;https://en.wikipedia.org/wiki/Pure_function&quot;&gt;pure function&lt;/a&gt;. It may happen that you need so much data that this strategy becomes untenable. &lt;a href=&quot;/2025/05/12/song-recommendations-proof-of-concept-memory-measurements&quot;&gt;This may be the case here&lt;/a&gt;, but surprisingly often, what strikes us humans as being vast amounts are peanuts for computers.
    &lt;/p&gt;
    &lt;p&gt;
        So even if you don&apos;t find this particular example realistic, I&apos;ll forge ahead and show how to apply the Recawr Sandwich pattern to this problem. This is essentially a port to &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt; of the C# code from the previous article. If you rather want to see some more realistic architectures to deal with the overall problem, you can always go back to the table of contents in the &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;first article of the series&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        In this article, I&apos;m working with the &lt;em&gt;fsharp-pure-function&lt;/em&gt; branch of the Git repository.
    &lt;/p&gt;
    &lt;h3 id=&quot;090279ba52c044c1b9a38d6d29ce26f1&quot;&gt;
        Collecting all the data &lt;a href=&quot;#090279ba52c044c1b9a38d6d29ce26f1&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Like in the previous article, we may start by adding two more members to the &lt;code&gt;SongService&lt;/code&gt; interface, which will enable us to enumerate all songs and all users. The full interface, with all four methods, then looks like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;type&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SongService&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;abstract&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetAllSongs&lt;/span&gt;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;unit&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;&amp;gt;&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;abstract&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetAllUsers&lt;/span&gt;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;unit&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IEnumerable&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;User&lt;/span&gt;&amp;gt;&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;abstract&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopListenersAsync&lt;/span&gt;&amp;nbsp;:&amp;nbsp;songId&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;User&lt;/span&gt;&amp;gt;&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;abstract&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopScrobblesAsync&lt;/span&gt;&amp;nbsp;:&amp;nbsp;userName&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;string&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Scrobble&lt;/span&gt;&amp;gt;&amp;gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        If you compare with the interface definition shown in the article &lt;a href=&quot;/2025/04/14/porting-song-recommendations-to-f&quot;&gt;Porting song recommendations to F#&lt;/a&gt;, you&apos;ll see that &lt;code&gt;GetAllSongs&lt;/code&gt; and &lt;code&gt;GetAllUsers&lt;/code&gt; are the new methods.
    &lt;/p&gt;
    &lt;p&gt;
        They enable you to collect all top listeners, and all top scrobbles, even though it may take some time. To gather all the top listeners, we may add this &lt;code&gt;collectAllTopListeners&lt;/code&gt; action:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;collectAllTopListeners&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songService&lt;/span&gt;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SongService&lt;/span&gt;)&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;task&lt;/span&gt;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;d&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Dictionary&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;User&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songs&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songService&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetAllSongs&lt;/span&gt;&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songs&lt;/span&gt;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TaskSeq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;iter&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;task&lt;/span&gt;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topListeners&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songService&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopListenersAsync&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Id
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;d&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Add&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Id,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topListeners&lt;/span&gt;)&amp;nbsp;}&amp;nbsp;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;d&lt;/span&gt;&amp;nbsp;:&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyDictionary&lt;/span&gt;&amp;lt;_,&amp;nbsp;_&amp;gt;&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Likewise, you can amass all the top scrobbles with a similar action:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;collectAllTopScrobbles&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songService&lt;/span&gt;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SongService&lt;/span&gt;)&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;task&lt;/span&gt;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;d&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Dictionary&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Scrobble&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;users&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songService&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetAllUsers&lt;/span&gt;&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;users&lt;/span&gt;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TaskSeq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;iter&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;task&lt;/span&gt;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songService&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopScrobblesAsync&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.UserName
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;d&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Add&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.UserName,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;)&amp;nbsp;}&amp;nbsp;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;d&lt;/span&gt;&amp;nbsp;:&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyDictionary&lt;/span&gt;&amp;lt;_,&amp;nbsp;_&amp;gt;&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        As you may have noticed, they&apos;re so similar that, had there been &lt;a href=&quot;https://en.wikipedia.org/wiki/Rule_of_three_(computer_programming)&quot;&gt;more than two&lt;/a&gt;, we might consider extracting the similar parts to a reusable operation.
    &lt;/p&gt;
    &lt;p&gt;
        In both cases, we start with the action that enables us to enumerate all the resources (songs or scrobbles) that we&apos;re interested in. For each of these, we then invoke the action to get the &apos;top&apos; resources for that song or scrobble. There&apos;s a massive &lt;em&gt;n+1&lt;/em&gt; problem here, but you could conceivably parallelize all these queries, as they&apos;re independent. Still, it&apos;s bound to take much time, possibly hours.
    &lt;/p&gt;
    &lt;p&gt;
        All the data is kept in a dictionary per action, so two massive dictionaries in all. Once these two actions return, we&apos;re done with the &lt;em&gt;read&lt;/em&gt; phase of the Recawr Sandwich.
    &lt;/p&gt;
    &lt;h3 id=&quot;5194a0ec946046068d42c086f7fd2697&quot;&gt;
        Traversals &lt;a href=&quot;#5194a0ec946046068d42c086f7fd2697&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        You may have wondered about the above &lt;code&gt;TaskSeq.iter&lt;/code&gt; action. That&apos;s not part of the standard library. What is it, and where does it come from?
    &lt;/p&gt;
    &lt;p&gt;
        It&apos;s a specialized &lt;a href=&quot;/2024/11/11/traversals&quot;&gt;traversal&lt;/a&gt;, designed to make asynchronous &lt;a href=&quot;https://en.wikipedia.org/wiki/Command%E2%80%93query_separation&quot;&gt;Commands&lt;/a&gt; more streamlined.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;iter&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;f&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;xs&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;task&lt;/span&gt;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;units&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;traverse&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;f&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;xs&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;iter&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;id&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;units&lt;/span&gt;&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        If you&apos;ve ever wondered why the &lt;em&gt;identity function&lt;/em&gt; (&lt;code&gt;id&lt;/code&gt;) is useful, here&apos;s an example. In the first line of code, &lt;code&gt;units&lt;/code&gt; is a &lt;code&gt;unit seq&lt;/code&gt; value; i.e. a sequence of &lt;code&gt;unit&lt;/code&gt; values. To make &lt;code&gt;TaskSeq.iter&lt;/code&gt; as easy to use as possible, it should turn that multitude of &lt;code&gt;unit&lt;/code&gt; values into a single &lt;code&gt;unit&lt;/code&gt; value. There&apos;s more than one way to do that, but I found that using &lt;code&gt;Seq.iter&lt;/code&gt; was about the most succinct option I could think of. Be that as it may, &lt;code&gt;Seq.iter&lt;/code&gt; requires as an argument a function that returns &lt;code&gt;unit&lt;/code&gt;, and since we already have &lt;code&gt;unit&lt;/code&gt; values, &lt;code&gt;id&lt;/code&gt; does the job.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;iter&lt;/code&gt; action uses the &lt;code&gt;TaskSeq&lt;/code&gt; module&apos;s &lt;code&gt;traverse&lt;/code&gt; function, which is defined like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;traverse&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;f&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;xs&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;go&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;acc&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;x&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;task&lt;/span&gt;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&amp;#39;&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;x&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;acc&amp;#39;&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#1f377f;&quot;&gt;acc&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;append&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;acc&amp;#39;&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;x&amp;#39;&lt;/span&gt;]&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;xs&lt;/span&gt;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;map&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;f&lt;/span&gt;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;fold&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;go&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;task&lt;/span&gt;&amp;nbsp;{&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;[]&amp;nbsp;})&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The type of &lt;code&gt;traverse&lt;/code&gt; is &lt;code&gt;(&amp;#39;a&amp;nbsp;-&amp;gt;&amp;nbsp;#Task&amp;lt;&amp;#39;c&amp;gt;)&amp;nbsp;-&amp;gt;&amp;nbsp;&amp;#39;a&amp;nbsp;seq&amp;nbsp;-&amp;gt;&amp;nbsp;Task&amp;lt;&amp;#39;c&amp;nbsp;seq&amp;gt;&lt;/code&gt;; that is, it applies an asynchronous action to each of a sequence of &lt;code&gt;&apos;a&lt;/code&gt; values, and returns an asynchronous workflow that contains a sequence of &lt;code&gt;&apos;c&lt;/code&gt; values.
    &lt;/p&gt;
    &lt;h3 id=&quot;16c034285a8d41b39923e27c6b81788e&quot;&gt;
        Dictionary lookups &lt;a href=&quot;#16c034285a8d41b39923e27c6b81788e&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        In .NET, queries that may fail are &lt;a href=&quot;/2015/08/03/idiomatic-or-idiosyncratic&quot;&gt;idiomatically&lt;/a&gt; modelled with methods that take &lt;code&gt;out&lt;/code&gt; parameters. This is also true for dictionary lookups. Since that kind of design doesn&apos;t compose well, it&apos;s useful to add a little helper function that instead may return an empty value. While you&apos;d &lt;a href=&quot;/2019/07/15/tester-doer-isomorphisms&quot;&gt;generally do that by returning an option value&lt;/a&gt;, in this case, an empty collection is more appropriate.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;findOrEmpty&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;key&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;d&lt;/span&gt;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyDictionary&lt;/span&gt;&amp;lt;_,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;_&amp;gt;&amp;gt;)&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;match&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;d&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;TryGetValue&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;key&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;with&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;true&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;v&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;v&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;nbsp;_&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;.empty&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        You may have noticed that I also added a similar helper function in &lt;a href=&quot;/2025/05/05/song-recommendations-as-a-c-impureim-sandwich&quot;&gt;the C# example&lt;/a&gt;, although there I called it &lt;code&gt;GetOrEmpty&lt;/code&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;cddd7cc72cf748b995fc0b58b0971c78&quot;&gt;
        Pure function with local mutation &lt;a href=&quot;#cddd7cc72cf748b995fc0b58b0971c78&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        As a first step, we may wish to turn the &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; method into a pure function. If you look through the commits in the Git repository, you can see that I actually did this through a series of &lt;a href=&quot;https://www.industriallogic.com/blog/whats-this-about-micro-commits/&quot;&gt;micro-commits&lt;/a&gt;, but here I only present a more coarse-grained version of the changes I made.
    &lt;/p&gt;
    &lt;p&gt;
        Instead of a method on a class, we now have a self-contained function that takes, as arguments, two dictionaries, but no &lt;code&gt;SongService&lt;/code&gt; dependency.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;getRecommendations&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topListeners&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;1.&amp;nbsp;Get&amp;nbsp;user&amp;#39;s&amp;nbsp;own&amp;nbsp;top&amp;nbsp;scrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;2.&amp;nbsp;Get&amp;nbsp;other&amp;nbsp;users&amp;nbsp;who&amp;nbsp;listened&amp;nbsp;to&amp;nbsp;the&amp;nbsp;same&amp;nbsp;songs&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;3.&amp;nbsp;Get&amp;nbsp;top&amp;nbsp;scrobbles&amp;nbsp;of&amp;nbsp;those&amp;nbsp;users&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;4.&amp;nbsp;Aggregate&amp;nbsp;the&amp;nbsp;songs&amp;nbsp;into&amp;nbsp;recommendations&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Dict&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;findOrEmpty&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobblesSnapshot&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.ScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;100
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;toList&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ResizeArray&lt;/span&gt;&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobble&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobblesSnapshot&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListeners&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topListeners&lt;/span&gt;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Dict&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;findOrEmpty&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobble&lt;/span&gt;.Song.Id
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListenersSnapshot&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListeners&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.TotalScrobbleCount&amp;nbsp;&amp;gt;=&amp;nbsp;10_000)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.TotalScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;20
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;toList&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListener&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListenersSnapshot&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobbles&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Dict&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;findOrEmpty&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListener&lt;/span&gt;.UserName
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobblesSnapshot&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song.IsVerifiedArtist)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song.Rating)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;10
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;toList&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobblesSnapshot&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;map&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddRange&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendations&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Rating)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;200
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;toList&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;:&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;_&amp;gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendations&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Since this is now a pure function, there&apos;s no need to run as an asynchronous workflow. The function no longer returns a &lt;code&gt;Task&lt;/code&gt;, and I&apos;ve also dispensed with the &lt;em&gt;Async&lt;/em&gt; suffix.
    &lt;/p&gt;
    &lt;p&gt;
        The implementation still has imperative remnants. It initializes an empty &lt;code&gt;ResizeArray&lt;/code&gt; (AKA &lt;code&gt;List&amp;lt;T&amp;gt;&lt;/code&gt;), and loops through nested loops to repeatedly call &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.collections.generic.list-1.addrange&quot;&gt;AddRange&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Even though the function contains local state mutation, none of it escapes the function&apos;s scope. The function is &lt;a href=&quot;https://en.wikipedia.org/wiki/Referential_transparency&quot;&gt;referentially transparent&lt;/a&gt; because it always returns the same result when given the same input, and it has no side effects.
    &lt;/p&gt;
    &lt;p&gt;
        You might still wish that it was &apos;more functional&apos;, which is certainly possible.
    &lt;/p&gt;
    &lt;h3 id=&quot;dda1233fb2ff4bc3b21d49d910fabf6f&quot;&gt;
        A single expression &lt;a href=&quot;#dda1233fb2ff4bc3b21d49d910fabf6f&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        A curious property of expression-based languages is that you can conceivably write functions in &apos;one line of code&apos;. Granted, it would often be a terribly wide line, not at all readable, a beast to maintain, and often with poor performance, so not something you&apos;d want to alway do.
    &lt;/p&gt;
    &lt;p&gt;
        In this case, however, we &lt;em&gt;can&lt;/em&gt; do that, although in order to stay within an &lt;a href=&quot;/2019/11/04/the-80-24-rule&quot;&gt;80x24 box&lt;/a&gt;, we break the expression over multiple lines.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;getRecommendations&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topListeners&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;1.&amp;nbsp;Get&amp;nbsp;user&amp;#39;s&amp;nbsp;own&amp;nbsp;top&amp;nbsp;scrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;2.&amp;nbsp;Get&amp;nbsp;other&amp;nbsp;users&amp;nbsp;who&amp;nbsp;listened&amp;nbsp;to&amp;nbsp;the&amp;nbsp;same&amp;nbsp;songs&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;3.&amp;nbsp;Get&amp;nbsp;top&amp;nbsp;scrobbles&amp;nbsp;of&amp;nbsp;those&amp;nbsp;users&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;4.&amp;nbsp;Aggregate&amp;nbsp;the&amp;nbsp;songs&amp;nbsp;into&amp;nbsp;recommendations&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Dict&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;findOrEmpty&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.ScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;100
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;collect&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobble&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topListeners&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Dict&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;findOrEmpty&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobble&lt;/span&gt;.Song.Id
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.TotalScrobbleCount&amp;nbsp;&amp;gt;=&amp;nbsp;10_000)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.TotalScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;20
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;collect&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListener&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Dict&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;findOrEmpty&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListener&lt;/span&gt;.UserName
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song.IsVerifiedArtist)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song.Rating)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;10
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;map&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song)))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Rating)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;200
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;toList&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;:&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;_&amp;gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        To be honest, the four lines of comments push the function definition over the edge of 24 lines of code, but without them, this variation actually does fit an 80x24 box. Even so, I&apos;m not arguing that this is the best possible way to organize and lay out this function.
    &lt;/p&gt;
    &lt;p&gt;
        You may rightly complain that it&apos;s too dense. Perhaps you&apos;re also concerned about the &lt;a href=&quot;https://wiki.c2.com/?ArrowAntiPattern&quot;&gt;arrow code&lt;/a&gt; tendency.
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;m not disagreeing, but at least this represents a milestone where the function is not only referentially transparent, but also implemented without local mutation. Not that that really should be the most important criterion, but once you have an entirely expression-based implementation, it&apos;s usually easier to break it up into smaller building blocks.
    &lt;/p&gt;
    &lt;h3 id=&quot;7d81ce38521b406fa306d4bfa79a44bb&quot;&gt;
        Composition from smaller functions &lt;a href=&quot;#7d81ce38521b406fa306d4bfa79a44bb&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        To improve readability and maintainability, we may now extract helper functions. The first one easily suggests itself.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;getUsersOwnTopScrobbles&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Dict&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;findOrEmpty&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.ScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;100&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Each of the subexpressions in the above code listing are candidates for the same kind of treatment, like this one:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;getOtherUsersWhoListenedToTheSameSongs&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topListeners&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobble&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topListeners&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Dict&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;findOrEmpty&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobble&lt;/span&gt;.Song.Id
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.TotalScrobbleCount&amp;nbsp;&amp;gt;=&amp;nbsp;10_000)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.TotalScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;20&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Notice that these helper methods are marked &lt;code&gt;private&lt;/code&gt; so that they remain implementation details within the module that exports the &lt;code&gt;getRecommendations&lt;/code&gt; function.
    &lt;/p&gt;
    &lt;p&gt;
        With a few more helper functions, you can now implement the &lt;code&gt;getRecommendations&lt;/code&gt; function by composing the helpers.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;getRecommendations&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topListeners&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;getUsersOwnTopScrobbles&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;collect&lt;/span&gt;&amp;nbsp;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;getOtherUsersWhoListenedToTheSameSongs&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topListeners&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;collect&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#74531f;&quot;&gt;getTopSongsOfOtherUser&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;topScrobbles&lt;/span&gt;))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;gt;&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;aggregateSongsIntoRecommendations&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Notice that I&apos;ve named each of the helper functions after the code comments that accompanied the previous incarnations of this function. If we consider &lt;a href=&quot;http://butunclebob.com/ArticleS.TimOttinger.ApologizeIncode&quot;&gt;code comments apologies for not properly organizing the code&lt;/a&gt;, we&apos;ve now managed to structure it in such a way that those apologies are no longer required.
    &lt;/p&gt;
    &lt;h3 id=&quot;7467fbb8e803446ea3dff035e7388301&quot;&gt;
        Conclusion &lt;a href=&quot;#7467fbb8e803446ea3dff035e7388301&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        If you accept the (perhaps preposterous) assumption that it&apos;s possible to fit the required data in &lt;a href=&quot;https://en.wikipedia.org/wiki/Persistent_data_structure&quot;&gt;persistent data structures&lt;/a&gt;, refactoring the recommendation algorithm to a pure function isn&apos;t that difficult. That&apos;s the pure part of a Recawr Sandwich. While I haven&apos;t shown the actual sandwich here, it&apos;s identical to the example shown in &lt;a href=&quot;/2025/05/05/song-recommendations-as-a-c-impureim-sandwich&quot;&gt;Song recommendations as a C# Impureim Sandwich&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        I find the final incarnation of the code shown here to be quite attractive. While I&apos;ve kept the helper functions &lt;code&gt;private&lt;/code&gt;, it&apos;s always an option to promote them to &lt;code&gt;public&lt;/code&gt; functions if you find that warranted. This could improve testability of the overall code base, albeit at the risk of increasing the surface area of the API that you have to maintain and secure.
    &lt;/p&gt;
    &lt;p&gt;
        There are always trade-offs to be considered. Even if you, eventually, find that for this particular example, the input data size is just &lt;em&gt;too&lt;/em&gt; big to make this alternative viable, there are, in my experience, many other situations when this kind of architecture is a good solution. Even if the input size is a decent amount of megabytes, the simplification offered by an Impureim Sandwich may trump the larger memory footprint. As always, if you&apos;re concerned about performance, &lt;a href=&quot;https://ericlippert.com/2012/12/17/performance-rant/&quot;&gt;measure it&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Before we turn to alternative architectures, we&apos;ll survey how this variation looks in &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt;. As is generally the case in this article series, if you don&apos;t care about Haskell, you can always go back to the table of contents in the &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;first article in the series&lt;/a&gt; and instead navigate to the next article that interests you.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2025/05/26/song-recommendations-as-a-haskell-impureim-sandwich&quot;&gt;Song recommendations as a Haskell Impureim Sandwich&lt;/a&gt;.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2025/05/19/song-recommendations-as-an-f-impureim-sandwich</guid>
      </item>
    
      <item>
        <title>Song recommendations proof-of-concept memory measurements</title>
        <link>https://blog.ploeh.dk/2025/05/12/song-recommendations-proof-of-concept-memory-measurements/</link>
        <pubDate>Mon, 12 May 2025 07:52:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;An attempt at measurement, and some results.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This is an article in a &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;larger series about functional programming design alternatives&lt;/a&gt;, and a direct continuation of the &lt;a href=&quot;/2025/05/05/song-recommendations-as-a-c-impureim-sandwich&quot;&gt;previous article&lt;/a&gt;. The question lingering after the &lt;a href=&quot;/2020/03/02/impureim-sandwich&quot;&gt;Impureim Sandwich&lt;/a&gt; proof of concept is: What are the memory requirements of front-loading all users, songs, and scrobbles?
    &lt;/p&gt;
    &lt;p&gt;
        One can guess, as I&apos;ve &lt;a href=&quot;/2025/04/28/song-recommendations-as-an-impureim-sandwich&quot;&gt;already done&lt;/a&gt;, but it&apos;s safer to measure. In this article, you&apos;ll find a description of the experiment, as well as some results.
    &lt;/p&gt;
    &lt;h3 id=&quot;6f88f7533af54936a2a923903171c831&quot;&gt;
        Test program &lt;a href=&quot;#6f88f7533af54936a2a923903171c831&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Since I don&apos;t measure application memory profiles that often, I searched the web to learn how, and found &lt;a href=&quot;https://stackoverflow.com/a/28514434/126014&quot;&gt;this answer&lt;/a&gt; by &lt;a href=&quot;https://stackoverflow.com/users/22656/jon-skeet&quot;&gt;Jon Skeet&lt;/a&gt;. That&apos;s a reputable source, so I&apos;m assuming that the described approach is appropriate.
    &lt;/p&gt;
    &lt;p&gt;
        I added a new command-line executable to the source code and made this the entry point:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;size&amp;nbsp;=&amp;nbsp;100_000;
 
&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;Task&amp;nbsp;Main()
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;before&amp;nbsp;=&amp;nbsp;GC.GetTotalMemory(&lt;span style=&quot;color:blue;&quot;&gt;true&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;var&amp;nbsp;(listeners,&amp;nbsp;scrobbles)&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;Populate();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;after&amp;nbsp;=&amp;nbsp;GC.GetTotalMemory(&lt;span style=&quot;color:blue;&quot;&gt;true&lt;/span&gt;);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;diff&amp;nbsp;=&amp;nbsp;after&amp;nbsp;-&amp;nbsp;before;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Console.WriteLine(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Total&amp;nbsp;memory:&amp;nbsp;{0:N0}B.&amp;quot;&lt;/span&gt;,&amp;nbsp;diff);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;GC.KeepAlive(listeners);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;GC.KeepAlive(scrobbles);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        &lt;code&gt;listeners&lt;/code&gt; and &lt;code&gt;scrobbles&lt;/code&gt; are two dictionaries of data, as described in the &lt;a href=&quot;/2025/05/05/song-recommendations-as-a-c-impureim-sandwich&quot;&gt;previous article&lt;/a&gt;. Together, they contain the data that we measure. Both are populated by this method:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;Task&amp;lt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;)&amp;gt;&amp;nbsp;Populate()
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;service&amp;nbsp;=&amp;nbsp;PopulateService();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;listeners&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;service.CollectAllTopListeners();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;scrobbles&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;service.CollectAllTopScrobbles();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;(listeners,&amp;nbsp;scrobbles);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;service&lt;/code&gt; variable is a &lt;code&gt;FakeSongService&lt;/code&gt; object populated with randomly generated data. The &lt;code&gt;CollectAllTopListeners&lt;/code&gt; and &lt;code&gt;CollectAllTopScrobbles&lt;/code&gt; methods are the same as described in the previous article. When the method returns the two dictionaries, the &lt;code&gt;service&lt;/code&gt; object goes out of scope and can be garbage-collected. When the program measures the memory load, it measures the size of the two dictionaries, but not &lt;code&gt;service&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;ve reused the &lt;a href=&quot;https://fscheck.github.io/FsCheck/&quot;&gt;FsCheck&lt;/a&gt; generators for random data generation:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;SongService&amp;nbsp;PopulateService()
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;users&amp;nbsp;=&amp;nbsp;RecommendationsProviderTests.Gen.UserName.Sample(size);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;songs&amp;nbsp;=&amp;nbsp;RecommendationsProviderTests.Gen.Song.Sample(size);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;scrobbleGen&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;user&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;Gen.Elements(users)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;song&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;Gen.Elements(songs)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;scrobbleCount&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;Gen.Choose(1,&amp;nbsp;10)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;select&lt;/span&gt;&amp;nbsp;(user,&amp;nbsp;song,&amp;nbsp;scrobbleCount);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;service&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;FakeSongService();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;foreach&lt;/span&gt;&amp;nbsp;(var&amp;nbsp;(user,&amp;nbsp;song,&amp;nbsp;scrobbleCount)&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;scrobbleGen.Sample(size))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;service.Scrobble(user,&amp;nbsp;song,&amp;nbsp;scrobbleCount);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;service;
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        A &lt;code&gt;Gen&amp;lt;T&amp;gt;&lt;/code&gt; object comes with a &lt;code&gt;Sample&lt;/code&gt; method you can use to request a specified number of randomly generated values.
    &lt;/p&gt;
    &lt;p&gt;
        In order to keep the code simple, I used the &lt;code&gt;size&lt;/code&gt; value for both the number of songs, number of users, and number of scrobbles. This probably creates too few scrobbles; a topic that requires further discussion later.
    &lt;/p&gt;
    &lt;h3 id=&quot;2759c45eda984c02871d99ff21d9936d&quot;&gt;
        Measurements &lt;a href=&quot;#2759c45eda984c02871d99ff21d9936d&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        I ran the above program with various &lt;code&gt;size&lt;/code&gt; values; &lt;em&gt;100,000&lt;/em&gt; up to &lt;em&gt;1,000,000&lt;/em&gt; in &lt;em&gt;100,000&lt;/em&gt; increments, and from there up to &lt;em&gt;1,000,000&lt;/em&gt; (one million) in &lt;em&gt;500,000&lt;/em&gt; increments. At the higher values, it took a good ten minutes to run the program.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/song-recommendations-memory-costs.png&quot; alt=&quot;Song recommendations memory cost line chart.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        As the chart indicates, I ran the program with various data representations (more on that below). While there are four distinct data series, they overlap pairwise so perfectly that the graph doesn&apos;t show the difference. The &lt;em&gt;record&lt;/em&gt; and &lt;em&gt;struct record&lt;/em&gt; data series are so identical that you can&apos;t visibly see the difference. The same is true for the &lt;em&gt;bitmasked class&lt;/em&gt; and the &lt;em&gt;bitmasked struct&lt;/em&gt; data series, which only go to &lt;code&gt;size&lt;/code&gt; &lt;em&gt;500,000&lt;/em&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        There are small, but noticeable jumps from &lt;em&gt;4,500,000&lt;/em&gt; to &lt;em&gt;5,000,000&lt;/em&gt; and again from &lt;em&gt;8,500,000&lt;/em&gt; to &lt;em&gt;9,000,000&lt;/em&gt;, but the overall impression is that the relationship is linear. It seems safe to conclude that the solution scales linearly with the data size.
    &lt;/p&gt;
    &lt;p&gt;
        The number of bytes per size is almost constant and averages to 178 bytes. How does that compare to &lt;a href=&quot;/2025/04/28/song-recommendations-as-an-impureim-sandwich&quot;&gt;my previous memory size estimates&lt;/a&gt;? There, I estimated a song and a scrobble to require 8 bytes each, and a user less than 32 bytes. The way the above simulation runs, it generates one song, one user, and one scrobble per size unit. Therefore, I&apos;d expect the average memory cost per experiment size to be around &lt;em&gt;8 + 8 + 32 = 48&lt;/em&gt;, plus some overhead from the dictionaries.
    &lt;/p&gt;
    &lt;p&gt;
        Given that the number I measure is 178, that&apos;s 130 bytes of overhead. Honestly, that&apos;s more than I expected. I expect a dictionary to maintain an array of keys, perhaps hashed with a bucket per hash value. Perhaps, had I picked another data structure than a plain old &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.collections.generic.dictionary-2&quot;&gt;Dictionary&lt;/a&gt;, it&apos;s possible that the overhead would be different. Or perhaps I just don&apos;t understand .NET&apos;s memory model, when push comes to shove.
    &lt;/p&gt;
    &lt;p&gt;
        I then tried to split the single &lt;code&gt;size&lt;/code&gt; parameter into three that would control the number of users, songs, and scrobbles independently. Setting both the number of users and songs to ten million, I then ran a series of simulations with increasing scrobble counts.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/song-recommendations-scrobble-memory-costs.png&quot; alt=&quot;Scrobble memory cost line chart.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The relationship still looks linear, and at a hundred million scrobbles (and ten million users and ten million songs), the simulation uses 8.3 GB of memory.
    &lt;/p&gt;
    &lt;p&gt;
        I admit that I&apos;m still a bit puzzled by the measurements, compared to my previous estimates. I would have expected those sizes to require about 1,2 GB, plus overhead, so the actual measurements are off by a factor of 7. Not quite an order of magnitude, but close.
    &lt;/p&gt;
    &lt;h3 id=&quot;b1a0539a274f49ef937b15fc07090990&quot;&gt;
        Realism &lt;a href=&quot;#b1a0539a274f49ef937b15fc07090990&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        How useful are these measurements? How realistic are the experiments&apos; parameters? Most streaming audio services report having catalogues with around 100 million songs, which is ten times more than what I&apos;ve measured here. Such services may also have significantly more users than ten million, but what is going to make or break this architecture option (keeping all data in memory) is how many scrobbles users have, and how many times they listen to each song.
    &lt;/p&gt;
    &lt;p&gt;
        Even if we naively still believe that a scrobble only takes up 8 bytes, it doesn&apos;t follow automatically that 100 scrobbles take up 800 bytes. It depends on how many repeats there are. Recall how we may model a scrobble:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Scrobble&lt;/span&gt;(Song&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Song&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ScrobbleCount&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        If a user listens to the same song ten times, we don&apos;t have to create ten &lt;code&gt;Scrobble&lt;/code&gt; objects; we can create one and set the &lt;code&gt;ScrobbleCount&lt;/code&gt; to &lt;code&gt;10&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        The memory requirement to store users&apos; scrobbles depend on the average listening pattern. Even with millions of users, we may be able to store scrobbles in memory if users listen to relatively few songs. On the other hand, if they only listen to each song once, it&apos;s probably not going to fit in memory.
    &lt;/p&gt;
    &lt;p&gt;
        Still, we&apos;re dangerously close to the edge of what we can fit in memory. Shouldn&apos;t I just declare bankruptcy on that idea and move on?
    &lt;/p&gt;
    &lt;p&gt;
        The purpose of this &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;overall article series&lt;/a&gt; is to demonstrate &lt;em&gt;alternatives&lt;/em&gt; to the &lt;a href=&quot;/2020/03/02/impureim-sandwich&quot;&gt;Impureim Sandwich&lt;/a&gt; pattern, so I&apos;m ultimately going to do exactly that: Move on.
    &lt;/p&gt;
    &lt;p&gt;
        But not yet.
    &lt;/p&gt;
    &lt;h3 id=&quot;a5fce68a31c7414386c451ea2fe219be&quot;&gt;
        Sharding &lt;a href=&quot;#a5fce68a31c7414386c451ea2fe219be&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Some applications are truly global in nature, and when that&apos;s the case, keeping everything in memory may not be &apos;web scale&apos;.
    &lt;/p&gt;
    &lt;p&gt;
        Still, I&apos;ve seen more than one international company treat geographic areas as separate entities. This may be for legal reasons, or other business concerns that are unrelated to technology constraints.
    &lt;/p&gt;
    &lt;p&gt;
        As a programmer, you may think that a song recommendations service ought to be truly global. After all, more data produces more accurate results, right?
    &lt;/p&gt;
    &lt;p&gt;
        Your business owners may not think so. They may be concerned that regional music tastes may &apos;bleed over&apos; market boundaries, and that this could ultimately scare customers away.
    &lt;/p&gt;
    &lt;p&gt;
        Even if you can technically prove that this isn&apos;t a relevant concern, because you can write an algorithm that takes this into account, you may get a direct order that, say, Southeast Asian scrobbles may not be used in North America, or vice verse.
    &lt;/p&gt;
    &lt;p&gt;
        It&apos;s worth investigating whether such business or legal constraints are already in place, because if they are, this may mean that you can shard the data, and that each shard still fits in memory.
    &lt;/p&gt;
    &lt;p&gt;
        You may still think that I&apos;m trying to salvage a bad idea, but that&apos;s not my agenda. I discuss these topics because in my experience, many programmers don&apos;t consider them. Understanding the wider context of a problem may suggest solutions that you might otherwise dismiss.
    &lt;/p&gt;
    &lt;p&gt;
        But what if the business constraints change in the future? Shouldn&apos;t we be ready for that?
    &lt;/p&gt;
    &lt;p&gt;
        Yes and no. You should consider how such changes would impact the architecture. Then you discuss the advantages and disadvantages with other stakeholders.
    &lt;/p&gt;
    &lt;p&gt;
        Keep in mind that the reason to consider an Impureim Sandwich is because it&apos;s &lt;em&gt;simple&lt;/em&gt; and easy to implement and maintain. Other alternatives may be more &apos;scalable&apos;, but also riskier to implement. You should involve other stakeholders in such decisions.
    &lt;/p&gt;
    &lt;h3 id=&quot;2dee0af02fbb4ac9b9176685ecb2cc3a&quot;&gt;
        Song representations &lt;a href=&quot;#2dee0af02fbb4ac9b9176685ecb2cc3a&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The first of the above charts draws graphs for four data series:
    &lt;/p&gt;
    &lt;ul&gt;
        &lt;li&gt;struct record&lt;/li&gt;
        &lt;li&gt;record&lt;/li&gt;
        &lt;li&gt;bitmasked struct&lt;/li&gt;
        &lt;li&gt;bitmasked class&lt;/li&gt;
    &lt;/ul&gt;
    &lt;p&gt;
        These measure four different ways to model data; here more specifically a song.
    &lt;/p&gt;
    &lt;p&gt;
        My initial model of a song was a &lt;code&gt;record&lt;/code&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Id&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;bool&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;IsVerifiedArtist&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;byte&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Rating&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Then I thought that perhaps, since the type only contains &lt;a href=&quot;https://learn.microsoft.com/dotnet/csharp/language-reference/builtin-types/value-types&quot;&gt;value types&lt;/a&gt;, it might be better to turn the above &lt;code&gt;record&lt;/code&gt; into a &lt;code&gt;record struct&lt;/code&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;struct&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Id&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;bool&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;IsVerifiedArtist&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;byte&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;Rating&lt;/span&gt;);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        It turns out that it makes no visible difference. In the chart, the two data series are so close to each other that you can&apos;t distinguish them.
    &lt;/p&gt;
    &lt;p&gt;
        Then I thought that instead of an &lt;code&gt;int&lt;/code&gt;, a &lt;code&gt;bool&lt;/code&gt;, and a &lt;code&gt;byte&lt;/code&gt;, I could use a single bitmask to model all three values.
    &lt;/p&gt;
    &lt;p&gt;
        After all, I was only guessing when it came to data types anyway. It&apos;s likely that &lt;code&gt;Rating&lt;/code&gt; is only a five-point or ten-point scale, but I still used a &lt;code&gt;byte&lt;/code&gt; to model it. This suggests that I&apos;m not using 96% of the data type&apos;s range. Perhaps I could use one of those redundant bits for &lt;code&gt;IsVerifiedArtist&lt;/code&gt;, instead of an entire &lt;code&gt;bool&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Taking this further, modelling the &lt;code&gt;Id&lt;/code&gt; as an &lt;code&gt;int&lt;/code&gt; suggests that you may have 4,294,967,295 unique songs. That&apos;s 4.3 &lt;em&gt;billion&lt;/em&gt; songs - at least an order of magnitude more than those 100 million songs that we hear about. In reality though, most systems that use &lt;code&gt;int&lt;/code&gt; for IDs only do so because &lt;code&gt;int&lt;/code&gt; is CLS-compliant, and &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.uint32&quot;&gt;uint is not&lt;/a&gt;. In other words, most systems that use &lt;code&gt;int&lt;/code&gt; for IDs most likely only use the positive half, which means there are 16 bytes to use for other purposes. Enter the &lt;em&gt;bitmasked song:&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;readonly&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;struct&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;uint&lt;/span&gt;&amp;nbsp;idMask&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;0b0000_0111_1111_1111_1111_1111_1111_1111;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;uint&lt;/span&gt;&amp;nbsp;isVerifiedArtistMask&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;0b1000_0000_0000_0000_0000_0000_0000_0000;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;uint&lt;/span&gt;&amp;nbsp;ratingMask&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;0b0111_1000_0000_0000_0000_0000_0000_0000;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;readonly&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;uint&lt;/span&gt;&amp;nbsp;bits;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;bool&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;isVerifiedArtist&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;byte&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rating&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;idBits&lt;/span&gt;&amp;nbsp;=&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;uint&lt;/span&gt;)id&amp;nbsp;&amp;amp;&amp;nbsp;idMask;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;isVerifiedArtistBits&lt;/span&gt;&amp;nbsp;=&amp;nbsp;isVerifiedArtist&amp;nbsp;?&amp;nbsp;isVerifiedArtistMask&amp;nbsp;:&amp;nbsp;0u;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;ratingBits&lt;/span&gt;&amp;nbsp;=&amp;nbsp;((&lt;span style=&quot;color:blue;&quot;&gt;uint&lt;/span&gt;)rating&amp;nbsp;&amp;lt;&amp;lt;&amp;nbsp;27)&amp;nbsp;&amp;amp;&amp;nbsp;ratingMask;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;bits&amp;nbsp;=&amp;nbsp;idBits&amp;nbsp;|&amp;nbsp;isVerifiedArtistBits&amp;nbsp;|&amp;nbsp;ratingBits;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;Id&amp;nbsp;=&amp;gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;)(bits&amp;nbsp;&amp;amp;&amp;nbsp;idMask);
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;bool&lt;/span&gt;&amp;nbsp;IsVerifiedArtist&amp;nbsp;=&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(bits&amp;nbsp;&amp;amp;&amp;nbsp;isVerifiedArtistMask)&amp;nbsp;==&amp;nbsp;isVerifiedArtistMask;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;byte&lt;/span&gt;&amp;nbsp;Rating&amp;nbsp;=&amp;gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;byte&lt;/span&gt;)((bits&amp;nbsp;&amp;amp;&amp;nbsp;ratingMask)&amp;nbsp;&amp;gt;&amp;gt;&amp;nbsp;27);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        In this representation, I&apos;ve set aside the lower 27 bits for the ID, enabling IDs to range between 0 and 134,217,727. The top bit is used for &lt;code&gt;IsVerifiedArtist&lt;/code&gt;, and the remaining four bits for &lt;code&gt;Rating&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        This data structure only holds a single &lt;code&gt;uint&lt;/code&gt;, and since I made it a &lt;code&gt;struct&lt;/code&gt;, I thought it&apos;d have minimal overhead.
    &lt;/p&gt;
    &lt;p&gt;
        As you can see in the above chart, that&apos;s not the case. When I run the experiment, this representation requires &lt;em&gt;more&lt;/em&gt; memory.
    &lt;/p&gt;
    &lt;p&gt;
        Just to make sure I wasn&apos;t missing anything obvious, I tried making the bitmasked &lt;code&gt;Song&lt;/code&gt; a &lt;code&gt;class&lt;/code&gt; instead. No visible difference.
    &lt;/p&gt;
    &lt;p&gt;
        If you&apos;re wondering why the bitmasked data series only go to 500,000, it&apos;s because this change made the experiments glacial. It took somewhere between 12 and 24 hours to run the experiment with a &lt;code&gt;size&lt;/code&gt; of 500,000.
    &lt;/p&gt;
    &lt;p&gt;
        For what it&apos;s worth, I don&apos;t think the slowdown is directly related to the data representation, but rather to the change I had to make to the &lt;a href=&quot;https://fscheck.github.io/FsCheck/&quot;&gt;FsCheck&lt;/a&gt;-based data generator:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;songParams&amp;nbsp;=&amp;nbsp;gen&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;maxId&amp;nbsp;=&amp;nbsp;0b0111_1111_1111_1111_1111_1111_1111
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;songId&amp;nbsp;=&amp;nbsp;Gen.choose&amp;nbsp;(1,&amp;nbsp;maxId)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;isVerified&amp;nbsp;=&amp;nbsp;ArbMap.generate&amp;nbsp;ArbMap.defaults
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;rating&amp;nbsp;=&amp;nbsp;Gen.choose&amp;nbsp;(0,&amp;nbsp;10)&amp;nbsp;|&amp;gt;&amp;nbsp;Gen.map&amp;nbsp;byte
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;songId,&amp;nbsp;isVerified,&amp;nbsp;rating&amp;nbsp;}
 
[&amp;lt;CompiledName&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Song&amp;quot;&lt;/span&gt;&amp;gt;]
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;song&amp;nbsp;=&amp;nbsp;gen&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;(id,&amp;nbsp;isVerifiedArtist,&amp;nbsp;rating)&amp;nbsp;=&amp;nbsp;songParams
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;Song&amp;nbsp;(id,&amp;nbsp;isVerifiedArtist,&amp;nbsp;rating)&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I can&apos;t explain why the bitmasked representation requires more memory, but I&apos;m increasingly having a nagging feeling that I&apos;ve made a mistake somewhere. If you can spot a mistake, please let me know by leaving a comment.
    &lt;/p&gt;
    &lt;h3 id=&quot;90e12771e0214d239cc2bc1c6a540c0a&quot;&gt;
        Other data representations &lt;a href=&quot;#90e12771e0214d239cc2bc1c6a540c0a&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        I also considered whether it&apos;d make sense to represent the entire data set as a huge matrix. One could, for example, let rows represent users, and columns songs, and let each element represent the number of times a user has listened to a particular song:
    &lt;/p&gt;
    &lt;table&gt;
        &lt;tr&gt;
            &lt;td&gt;User&lt;/td&gt;
            &lt;td&gt;Song 1&lt;/td&gt;
            &lt;td&gt;Song 2&lt;/td&gt;
            &lt;td&gt;Song 3&lt;/td&gt;
            &lt;td&gt;...&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;123&lt;/td&gt;
            &lt;td&gt;0&lt;/td&gt;
            &lt;td&gt;0&lt;/td&gt;
            &lt;td&gt;4&lt;/td&gt;
            &lt;td&gt;...&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;456&lt;/td&gt;
            &lt;td&gt;2&lt;/td&gt;
            &lt;td&gt;0&lt;/td&gt;
            &lt;td&gt;4&lt;/td&gt;
            &lt;td&gt;...&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td colspan=&quot;5&quot;&gt;...&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;
    &lt;p&gt;
        Let&apos;s say that you may expect some users to listen to a song more than 255 times, but probably not more than 65,535 times. Thus, you could store each play count as a &lt;a href=&quot;https://learn.microsoft.com/dotnet/api/system.uint16&quot;&gt;ushort&lt;/a&gt;. Still, you would need &lt;em&gt;users x songs&lt;/em&gt; values, so if you have 100 million songs and 10 million users, that implies 2 PB of memory. That doesn&apos;t sound useful.
    &lt;/p&gt;
    &lt;p&gt;
        On the other hand, most of those elements are going to be &lt;em&gt;0&lt;/em&gt;, so perhaps one could use an &lt;a href=&quot;https://en.wikipedia.org/wiki/Adjacency_list&quot;&gt;adjacency list&lt;/a&gt; instead. That is, however, essentially what an &lt;code&gt;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;&lt;/code&gt; is, so we&apos;re now back where we started.
    &lt;/p&gt;
    &lt;h3 id=&quot;80eaf0d1dd9848cb875f74b94cb64054&quot;&gt;
        Conclusion &lt;a href=&quot;#80eaf0d1dd9848cb875f74b94cb64054&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        This article reports on some measurements I&apos;ve made of memory requirements, assuming that we keep all scrobble data in memory. While I suspect that I&apos;ve made a mistake, it still seems reasonable to conclude that the &lt;em&gt;song recommendations&lt;/em&gt; scenario is on the edge of what&apos;s possible with the Impureim Sandwich pattern.
    &lt;/p&gt;
    &lt;p&gt;
        That&apos;s okay. I&apos;m interested in understanding the limitations of solutions.
    &lt;/p&gt;
    &lt;p&gt;
        I do think, however, that it&apos;s worth taking note of just how massive amounts of data are required before the Impureim Sandwich pattern becomes untenable.
    &lt;/p&gt;
    &lt;p&gt;
        When I describe the pattern, the most common reaction is that it doesn&apos;t scale. And, as this article has explored, it&apos;s true that it doesn&apos;t scale. But it scales much, much better than you think. You may have billions of entities in your system, and they may still fit in a few gigabytes. Don&apos;t dismiss the Impureim Sandwich before you&apos;ve made a real effort to understand the memory implications of it. Your intuition is likely to work against you.
    &lt;/p&gt;
    &lt;p&gt;
        I&apos;ll round off this part of the article series by showing how the Impureim Sandwich looks in other, more functional languages.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2025/05/19/song-recommendations-as-an-f-impureim-sandwich&quot;&gt;Song recommendations as an F# Impureim Sandwich&lt;/a&gt;.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2025/05/12/song-recommendations-proof-of-concept-memory-measurements</guid>
      </item>
    
      <item>
        <title>Song recommendations as a C# Impureim Sandwich</title>
        <link>https://blog.ploeh.dk/2025/05/05/song-recommendations-as-a-c-impureim-sandwich/</link>
        <pubDate>Mon, 05 May 2025 06:23:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;A refactoring example.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This is an article in a &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;larger series about functional programming design alternatives&lt;/a&gt;. I&apos;m assuming that you&apos;ve read the previous articles, but briefly told, I&apos;m considering an example presented by &lt;a href=&quot;https://tyrrrz.me/&quot;&gt;Oleksii Holub&lt;/a&gt; in the article &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle&quot;&gt;Pure-Impure Segregation Principle&lt;/a&gt;. The example gathers song recommendations for a user in &lt;a href=&quot;https://twitter.com/Tyrrrz/status/1493369905869213700&quot;&gt;a long-running process&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        In &lt;a href=&quot;/2025/04/28/song-recommendations-as-an-impureim-sandwich&quot;&gt;the previous article&lt;/a&gt; I argued that while the memory requirements for this problem seem so vast that an &lt;a href=&quot;/2020/03/02/impureim-sandwich&quot;&gt;Impureim Sandwich&lt;/a&gt; appears out of the question, it&apos;s nonetheless worthwhile to at least try it out. The refactoring isn&apos;t that difficult, and it turns out that it does simplify the code.
    &lt;/p&gt;
    &lt;h3 id=&quot;1fa2f097e260439fbc0bafb67a35a394&quot;&gt;
        Enumeration API &lt;a href=&quot;#1fa2f097e260439fbc0bafb67a35a394&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The data access API is a web service:
    &lt;/p&gt;
    &lt;blockquote&gt;
        &lt;p&gt;
            &quot;I don&apos;t own the database, those are requests to an external API service (think Spotify API) that provides the data.&quot;
        &lt;/p&gt;
        &lt;footer&gt;&lt;cite&gt;&lt;a href=&quot;https://twitter.com/Tyrrrz/status/1495465374179119105&quot;&gt;Tweet&lt;/a&gt;&lt;/cite&gt;, Oleksii Holub, 2022&lt;/footer&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;
        In order to read all data, we&apos;ll have to assume that there&apos;s a way to enumerate all songs and all users. With that assumption, I add the &lt;code&gt;GetAllSongs&lt;/code&gt; and &lt;code&gt;GetAllUsers&lt;/code&gt; methods to the &lt;code&gt;SongService&lt;/code&gt; interface:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;interface&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SongService&lt;/span&gt;
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Task&amp;lt;IEnumerable&amp;lt;Song&amp;gt;&amp;gt;&amp;nbsp;GetAllSongs();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Task&amp;lt;IEnumerable&amp;lt;User&amp;gt;&amp;gt;&amp;nbsp;GetAllUsers();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Task&amp;lt;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;&amp;nbsp;GetTopListenersAsync(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;songId);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Task&amp;lt;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;&amp;nbsp;GetTopScrobblesAsync(&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;userName);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        It is, of course, a crucial assumption, and it&apos;s possible that no such API exists. On the other hand, a REST API could expose such functionality as a paged feed. Leafing through potentially hundreds (or thousands) such pages is bound to take some time, so it&apos;s good to know that this is a background process. As I briefly mentioned in &lt;a href=&quot;/2025/04/28/song-recommendations-as-an-impureim-sandwich&quot;&gt;the previous article&lt;/a&gt;, we could imagine that we have a dedicated indexing server for this kind purpose. While we may rightly expect the initial data load to take some time (hours, even), once it&apos;s in memory, we should be able to reuse it to calculate song recommendations for all users, instead of just one user.
    &lt;/p&gt;
    &lt;p&gt;
        In the previous article I estimated that it should be possible to keep all songs in memory with less than a gigabyte. Users, without scrobbles, also take up surprisingly little space, to the degree that a million users fit in a few dozen megabytes. Even if, eventually, we may be concerned about memory, we don&apos;t have to be concerned about this part.
    &lt;/p&gt;
    &lt;p&gt;
        In any case, the addition of these two new methods doesn&apos;t break the existing example code, although I did have to implement the method in the &lt;code&gt;FakeSongService&lt;/code&gt; class that I introduced in the article &lt;a href=&quot;/2025/04/10/characterising-song-recommendations&quot;&gt;Characterising song recommendations&lt;/a&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;Task&amp;lt;IEnumerable&amp;lt;Song&amp;gt;&amp;gt;&amp;nbsp;GetAllSongs()
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;Task.FromResult&amp;lt;IEnumerable&amp;lt;Song&amp;gt;&amp;gt;(songs.Values);
}
 
&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;Task&amp;lt;IEnumerable&amp;lt;User&amp;gt;&amp;gt;&amp;nbsp;GetAllUsers()
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;Task.FromResult(users.Select(kvp&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;User(kvp.Key,&amp;nbsp;kvp.Value.Values.Sum())));
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        With those additions, we can load all data as the first layer (&lt;em&gt;phase&lt;/em&gt;, really) of the sandwich.
    &lt;/p&gt;
    &lt;h3 id=&quot;9e69e4d3be8f4562b0cf9369610f6ebb&quot;&gt;
        Front-loading the data &lt;a href=&quot;#9e69e4d3be8f4562b0cf9369610f6ebb&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Loading all the data is the responsibility of this &lt;code&gt;DataCollector&lt;/code&gt; module:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;class&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;DataCollector&lt;/span&gt;
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;Task&amp;lt;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;CollectAllTopListeners(&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;SongService&amp;nbsp;songService)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;dict&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;Dictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;foreach&lt;/span&gt;&amp;nbsp;(var&amp;nbsp;song&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;songService.GetAllSongs())
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;topListeners&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;songService.GetTopListenersAsync(song.Id);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;dict.Add(song.Id,&amp;nbsp;topListeners);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;dict;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;Task&amp;lt;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;CollectAllTopScrobbles(&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;SongService&amp;nbsp;songService)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;dict&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;Dictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;foreach&lt;/span&gt;&amp;nbsp;(var&amp;nbsp;user&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;songService.GetAllUsers())
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;topScrobbles&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;songService.GetTopScrobblesAsync(user.UserName);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;dict.Add(user.UserName,&amp;nbsp;topScrobbles);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;dict;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        These two methods work with any &lt;code&gt;SongService&lt;/code&gt; implementation, so while the code base will work with &lt;code&gt;FakeSongService&lt;/code&gt;, real &apos;production code&apos; might as well use an HTTP-based implementation that pages through the implied web API.
    &lt;/p&gt;
    &lt;p&gt;
        The dictionaries returned by the methods are likely to be huge. That&apos;s a major point of this exercise. Once the change is implemented and &lt;a href=&quot;https://en.wikipedia.org/wiki/Characterization_test&quot;&gt;Characterisation Tests&lt;/a&gt; show that it still works, it makes sense to generate data to get a sense of the memory footprint.
    &lt;/p&gt;
    &lt;h3 id=&quot;cad69cb800a146e9ac2556c7deaac655&quot;&gt;
        Table-driven methods &lt;a href=&quot;#cad69cb800a146e9ac2556c7deaac655&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Perhaps you wonder why the above &lt;code&gt;CollectAllTopListeners&lt;/code&gt; and &lt;code&gt;CollectAllTopScrobbles&lt;/code&gt; methods return dictionaries of exactly that shape.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;a href=&quot;http://amzn.to/1dLYr0r&quot;&gt;Code Complete&lt;/a&gt; describes a programming technique called &lt;em&gt;table-driven methods&lt;/em&gt;. The idea is to replace branching instructions such as &lt;code&gt;if&lt;/code&gt;, &lt;code&gt;else&lt;/code&gt;, and &lt;code&gt;switch&lt;/code&gt; with a lookup table. The overall point, however, is that you can replace function calls with table lookups.
    &lt;/p&gt;
    &lt;p&gt;
        Consider the &lt;code&gt;GetTopListenersAsync&lt;/code&gt; method. It takes an &lt;code&gt;int&lt;/code&gt; as input, and returns a &lt;code&gt;Task&amp;lt;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;
        &lt;/code&gt; as output. If you ignore the &lt;code&gt;Task&lt;/code&gt;, that&apos;s an &lt;code&gt;IReadOnlyCollection&amp;lt;User&amp;gt;&lt;/code&gt;. In other words, you can exchange an &lt;code&gt;int&lt;/code&gt; for an &lt;code&gt;IReadOnlyCollection&amp;lt;User&amp;gt;&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        If you have an &lt;code&gt;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;&lt;/code&gt; you can &lt;em&gt;also&lt;/em&gt; exchange an &lt;code&gt;int&lt;/code&gt; for an &lt;code&gt;IReadOnlyCollection&amp;lt;User&amp;gt;&lt;/code&gt;. These two APIs are functionally equivalent - although, of course, they have very different memory and run-time profiles.
    &lt;/p&gt;
    &lt;p&gt;
        The same goes for the &lt;code&gt;GetTopScrobblesAsync&lt;/code&gt; method: It takes a &lt;code&gt;string&lt;/code&gt; as input and returns an &lt;code&gt;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&lt;/code&gt; as output (if you ignore the &lt;code&gt;Task&lt;/code&gt;). An &lt;code&gt;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;&lt;/code&gt; is equivalent.
    &lt;/p&gt;
    &lt;p&gt;
        To make it practical, it turns out that we also need a little helper method to deal with the case where the dictionary has no entry for a given key:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;internal&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;IReadOnlyCollection&amp;lt;T&amp;gt;&amp;nbsp;GetOrEmpty&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;T&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;TKey&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;this&lt;/span&gt;&amp;nbsp;IReadOnlyDictionary&amp;lt;TKey,&amp;nbsp;IReadOnlyCollection&amp;lt;T&amp;gt;&amp;gt;&amp;nbsp;dict,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;TKey&amp;nbsp;key)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;if&lt;/span&gt;&amp;nbsp;(dict.TryGetValue(key,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;out&lt;/span&gt;&amp;nbsp;var&amp;nbsp;result))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;result;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;Array.Empty&amp;lt;T&amp;gt;();
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        If there&apos;s no entry for a key, this function instead returns an empty array.
    &lt;/p&gt;
    &lt;p&gt;
        That should make it as easy as possible to replace calls to &lt;code&gt;GetTopListenersAsync&lt;/code&gt; and &lt;code&gt;GetTopScrobblesAsync&lt;/code&gt; with dictionary lookups.
    &lt;/p&gt;
    &lt;h3 id=&quot;43b6cc924db64320a41f0a4093c65e29&quot;&gt;
        Adding method parameters &lt;a href=&quot;#43b6cc924db64320a41f0a4093c65e29&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        When refactoring, it&apos;s a good idea to proceed in small, controlled steps. You can see each of my &lt;a href=&quot;https://www.industriallogic.com/blog/whats-this-about-micro-commits/&quot;&gt;micro-commits&lt;/a&gt; in the Git repository&apos;s &lt;em&gt;refactor-to-function&lt;/em&gt; branch. Here, I&apos;ll give an overview.
    &lt;/p&gt;
    &lt;p&gt;
        First, I added two dictionaries as parameters to the &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; method. You may recall that the method used to look like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;Task&amp;lt;IReadOnlyList&amp;lt;Song&amp;gt;&amp;gt;&amp;nbsp;GetRecommendationsAsync(&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;userName)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        After I added the two dictionaries, it looks like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;async&lt;/span&gt;&amp;nbsp;Task&amp;lt;IReadOnlyList&amp;lt;Song&amp;gt;&amp;gt;&amp;nbsp;GetRecommendationsAsync(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;userName,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;&amp;nbsp;topScrobbles,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;&amp;nbsp;topListeners)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        At this point, the &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; method uses neither the &lt;code&gt;topScrobbles&lt;/code&gt; nor the &lt;code&gt;topListeners&lt;/code&gt; parameter. Still, I consider this a &lt;a href=&quot;https://stackoverflow.blog/2022/12/19/use-git-tactically/&quot;&gt;distinct checkpoint that I commit to Git&lt;/a&gt;. As I&apos;ve outlined in my book &lt;a href=&quot;/2021/06/14/new-book-code-that-fits-in-your-head&quot;&gt;Code That Fits in Your Head&lt;/a&gt;, it&apos;s safest to either refactor production code while keeping test code untouched, or refactor test code without editing the production code. An API change like the current is an example of a situation where that separation is impossible. This is the reason I want to keep it small and isolated. While the change does touch both production code and test code, I&apos;m not editing the behaviour of the System Under Test.
    &lt;/p&gt;
    &lt;p&gt;
        Tests now look like this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&amp;lt;Property&amp;gt;]
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;``No&amp;nbsp;data``&amp;nbsp;()&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Gen.userName&amp;nbsp;|&amp;gt;&amp;nbsp;Arb.fromGen&amp;nbsp;|&amp;gt;&amp;nbsp;Prop.forAll&amp;nbsp;&amp;lt;|&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;userName&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;task&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;srvc&amp;nbsp;=&amp;nbsp;FakeSongService&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;sut&amp;nbsp;=&amp;nbsp;RecommendationsProvider&amp;nbsp;srvc
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;topScrobbles&amp;nbsp;=&amp;nbsp;DataCollector.CollectAllTopScrobbles&amp;nbsp;srvc
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;topListeners&amp;nbsp;=&amp;nbsp;DataCollector.CollectAllTopListeners&amp;nbsp;srvc
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;actual&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sut.GetRecommendationsAsync&amp;nbsp;(userName,&amp;nbsp;topScrobbles,&amp;nbsp;topListeners)
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Assert.Empty&amp;nbsp;actual&amp;nbsp;}&amp;nbsp;:&amp;gt;&amp;nbsp;Task&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The test now uses the &lt;code&gt;DataCollector&lt;/code&gt; to front-load data into dictionaries that it then passes to &lt;code&gt;GetRecommendationsAsync&lt;/code&gt;. Keep in mind that &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; doesn&apos;t yet use that data, but it&apos;s available to it once I make a change to that effect.
    &lt;/p&gt;
    &lt;p&gt;
        You may wish to compare this version of the &lt;code&gt;No data&lt;/code&gt; test with the previous version shown in the article &lt;a href=&quot;/2025/04/10/characterising-song-recommendations&quot;&gt;Characterising song recommendations&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;02c3e9706d044528ad1d5acec6865385&quot;&gt;
        Refactoring to function &lt;a href=&quot;#02c3e9706d044528ad1d5acec6865385&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The code is now ready for refactoring &lt;a href=&quot;/2017/01/27/from-dependency-injection-to-dependency-rejection&quot;&gt;from dependency injection to dependency rejection&lt;/a&gt;. It&apos;s even possible to do it one method call at a time, because the data in the &lt;code&gt;FakeSongService&lt;/code&gt; is the same as the data in the two dictionaries. It&apos;s just two different representations of the same data.
    &lt;/p&gt;
    &lt;p&gt;
        Since, as described above, the dictionaries are equivalent to the &lt;code&gt;SongService&lt;/code&gt; queries, each is easily replaced with the other. The first impure action in &lt;code&gt;GetRecommendationsAsync&lt;/code&gt;, for example, is this one:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;scrobbles&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;await&lt;/span&gt;&amp;nbsp;_songService.GetTopScrobblesAsync(userName);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The equivalent dictionary lookup enables us to change that line of code to this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;scrobbles&amp;nbsp;=&amp;nbsp;topScrobbles.GetOrEmpty(userName);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Notice that the dictionary lookup is a &lt;a href=&quot;https://en.wikipedia.org/wiki/Pure_function&quot;&gt;pure function&lt;/a&gt; that the method need not &lt;code&gt;await&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Even though the rest of &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; still queries the injected &lt;code&gt;SongService&lt;/code&gt;, all tests pass, and I can commit this small, isolated change to Git.
    &lt;/p&gt;
    &lt;p&gt;
        Proceeding in a similar fashion enables us to eliminate the &lt;code&gt;SongService&lt;/code&gt; queries one by one. There are only three method calls, so this can be done in three controlled steps. Once the last impure query has been replaced, the C# compiler complains about the &lt;code&gt;async&lt;/code&gt; keyword in the declaration of the &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; method.
    &lt;/p&gt;
    &lt;p&gt;
        Not only is the &lt;code&gt;async&lt;/code&gt; keyword no longer required, the method is no longer asynchronous. There&apos;s no reason to return a &lt;code&gt;Task&lt;/code&gt;, and the &lt;code&gt;Async&lt;/code&gt; method name suffix is also misleading.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;IReadOnlyList&amp;lt;Song&amp;gt;&amp;nbsp;GetRecommendations(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;userName,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;&amp;nbsp;topScrobbles,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;&amp;nbsp;topListeners)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;GetRecommendations&lt;/code&gt; method no longer uses the injected &lt;code&gt;SongService&lt;/code&gt;, and since it&apos;s is the only method of the &lt;code&gt;RecommendationsProvider&lt;/code&gt; class, we can now (r)eject the dependency.
    &lt;/p&gt;
    &lt;p&gt;
        This furthermore means that the class no longer has any class fields; we might as well make it (and the &lt;code&gt;GetRecommendations&lt;/code&gt; function) &lt;code&gt;static&lt;/code&gt;. Here&apos;s the final function in its entirety:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;IReadOnlyList&amp;lt;Song&amp;gt;&amp;nbsp;GetRecommendations(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;userName,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;&amp;nbsp;topScrobbles,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;IReadOnlyDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;&amp;nbsp;topListeners)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;1.&amp;nbsp;Get&amp;nbsp;user&amp;#39;s&amp;nbsp;own&amp;nbsp;top&amp;nbsp;scrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;2.&amp;nbsp;Get&amp;nbsp;other&amp;nbsp;users&amp;nbsp;who&amp;nbsp;listened&amp;nbsp;to&amp;nbsp;the&amp;nbsp;same&amp;nbsp;songs&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;3.&amp;nbsp;Get&amp;nbsp;top&amp;nbsp;scrobbles&amp;nbsp;of&amp;nbsp;those&amp;nbsp;users&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;4.&amp;nbsp;Aggregate&amp;nbsp;the&amp;nbsp;songs&amp;nbsp;into&amp;nbsp;recommendations&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;scrobbles&amp;nbsp;=&amp;nbsp;topScrobbles.GetOrEmpty(userName);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;scrobblesSnapshot&amp;nbsp;=&amp;nbsp;scrobbles
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.OrderByDescending(s&amp;nbsp;=&amp;gt;&amp;nbsp;s.ScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Take(100)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.ToArray();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;recommendationCandidates&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;List&amp;lt;Song&amp;gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;foreach&lt;/span&gt;&amp;nbsp;(var&amp;nbsp;scrobble&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;scrobblesSnapshot)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;otherListeners&amp;nbsp;=&amp;nbsp;topListeners.GetOrEmpty(scrobble.Song.Id);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;otherListenersSnapshot&amp;nbsp;=&amp;nbsp;otherListeners
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Where(u&amp;nbsp;=&amp;gt;&amp;nbsp;u.TotalScrobbleCount&amp;nbsp;&amp;gt;=&amp;nbsp;10_000)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.OrderByDescending(u&amp;nbsp;=&amp;gt;&amp;nbsp;u.TotalScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Take(20)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.ToArray();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;foreach&lt;/span&gt;&amp;nbsp;(var&amp;nbsp;otherListener&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;otherListenersSnapshot)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;otherScrobbles&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;topScrobbles.GetOrEmpty(otherListener.UserName);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;otherScrobblesSnapshot&amp;nbsp;=&amp;nbsp;otherScrobbles
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Where(s&amp;nbsp;=&amp;gt;&amp;nbsp;s.Song.IsVerifiedArtist)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.OrderByDescending(s&amp;nbsp;=&amp;gt;&amp;nbsp;s.Song.Rating)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Take(10)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.ToArray();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;recommendationCandidates.AddRange(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;otherScrobblesSnapshot.Select(s&amp;nbsp;=&amp;gt;&amp;nbsp;s.Song)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;recommendations&amp;nbsp;=&amp;nbsp;recommendationCandidates
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.OrderByDescending(s&amp;nbsp;=&amp;gt;&amp;nbsp;s.Rating)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Take(200)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.ToArray();
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;recommendations;
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The overall structure is similar to &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle&quot;&gt;the original version&lt;/a&gt;. Now that the code is simpler (because there&apos;s no longer any asynchrony) you could keep refactoring. With this C# code example, I&apos;m going to stop here, but when I port it to &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt; I&apos;m going to refactor more aggressively.
    &lt;/p&gt;
    &lt;h3 id=&quot;b421654127ca4580995e008d4c01e3ab&quot;&gt;
        Sandwich &lt;a href=&quot;#b421654127ca4580995e008d4c01e3ab&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        One point of the whole exercise is to demonstrate how to refactor to an Impureim Sandwich. The &lt;code&gt;GetRecommendations&lt;/code&gt; method shown above constitutes the pure filling of the sandwich, but what does the entire sandwich look like?
    &lt;/p&gt;
    &lt;p&gt;
        In this code base, the sandwiches only exist as unit tests, the simplest of which is still the &lt;code&gt;No data&lt;/code&gt; test:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&amp;lt;Property&amp;gt;]
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;``No&amp;nbsp;data``&amp;nbsp;()&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Gen.userName&amp;nbsp;|&amp;gt;&amp;nbsp;Arb.fromGen&amp;nbsp;|&amp;gt;&amp;nbsp;Prop.forAll&amp;nbsp;&amp;lt;|&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;user&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;task&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;srvc&amp;nbsp;=&amp;nbsp;FakeSongService&amp;nbsp;()
 
&lt;span style=&quot;background-color: lightsalmon;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;topScrobbles&amp;nbsp;=&amp;nbsp;DataCollector.CollectAllTopScrobbles&amp;nbsp;srvc
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;topListeners&amp;nbsp;=&amp;nbsp;DataCollector.CollectAllTopListeners&amp;nbsp;srvc&lt;/span&gt;
&lt;span style=&quot;background-color: palegreen;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;actual&amp;nbsp;=&amp;nbsp;RecommendationsProvider.GetRecommendations&amp;nbsp;(user,&amp;nbsp;topScrobbles,&amp;nbsp;topListeners)&lt;/span&gt;
 
&lt;span style=&quot;background-color: lightsalmon;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Assert.Empty&amp;nbsp;actual&lt;/span&gt;&amp;nbsp;}&amp;nbsp;:&amp;gt;&amp;nbsp;Task&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        In the above code snippet, I&apos;ve coloured in the relevant part of the test. I admit that it&apos;s a stretch to colour the last line red, since &lt;code&gt;Assert.Empty&lt;/code&gt; is, at least, deterministic. One could argue that since it throws an exception on failure, it&apos;s not strictly free of side effects, but that&apos;s really a weak argument. It would be easy to refactor &lt;a href=&quot;/2022/11/07/applicative-assertions&quot;&gt;assertions to pure functions&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Instead, you may consider the bottom layer of the sandwich as a placeholder where something impure might happen. The background service that updates the song recommendations may, for example, save the result as a (CQRS-style) materialised view.
    &lt;/p&gt;
    &lt;p&gt;
        The above test snippet, then, is more of a sketch of how the Impureim Sandwich may look: First, front-load data using the &lt;code&gt;DataCollector&lt;/code&gt; methods; second, call &lt;code&gt;GetRecommendations&lt;/code&gt;; third, do something with the result.
    &lt;/p&gt;
    &lt;h3 id=&quot;26a74728792d494e814b8d86f2ad8531&quot;&gt;
        Conclusion &lt;a href=&quot;#26a74728792d494e814b8d86f2ad8531&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The changes demonstrated in this article serve two purposes. One is to show how to refactor an impure action to a pure function, pursuing the notion of an Impureim Sandwich. The second is to evaluate a proof-of-concept: If we do, indeed, front-load all of the data, is it realistic that all &lt;a href=&quot;https://yourdatafitsinram.net/&quot;&gt;data fits in RAM&lt;/a&gt;?
    &lt;/p&gt;
    &lt;p&gt;
        We have yet to address that question, but since the present article is already substantial, I&apos;ll address that in a separate article.
    &lt;/p&gt;
    &lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2025/05/12/song-recommendations-proof-of-concept-memory-measurements&quot;&gt;Song recommendations proof-of-concept memory measurements&lt;/a&gt;.
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2025/05/05/song-recommendations-as-a-c-impureim-sandwich</guid>
      </item>
    
      <item>
        <title>Song recommendations as an Impureim Sandwich</title>
        <link>https://blog.ploeh.dk/2025/04/28/song-recommendations-as-an-impureim-sandwich/</link>
        <pubDate>Mon, 28 Apr 2025 07:16:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;Does your data fit in RAM?&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This article is part of &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;a series on functional programming design alternatives&lt;/a&gt;. In a &lt;a href=&quot;/2025/04/10/characterising-song-recommendations&quot;&gt;previous article&lt;/a&gt; you saw how to add enough &lt;a href=&quot;https://en.wikipedia.org/wiki/Characterization_test&quot;&gt;Characterisation Tests&lt;/a&gt; to capture the intended behaviour of the example song recommendations system originally presented by &lt;a href=&quot;https://tyrrrz.me/&quot;&gt;Oleksii Holub&lt;/a&gt; in the article &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle&quot;&gt;Pure-Impure Segregation Principle&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;572693e6fb56455a958ca0d62aa13319&quot;&gt;
        Problem statement &lt;a href=&quot;#572693e6fb56455a958ca0d62aa13319&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        After showing how one problem can be refactored to &lt;a href=&quot;https://en.wikipedia.org/wiki/Pure_function&quot;&gt;pure functions&lt;/a&gt;, Oleksii Holub writes:
    &lt;/p&gt;
    &lt;blockquote&gt;
        &lt;p&gt;
            &quot;Although very useful, the type of &quot;lossless&quot; refactoring shown earlier only works if the data required by the function can be easily encapsulated within its input parameters. Unfortunately, this is not always the case.
        &lt;/p&gt;
        &lt;p&gt;
            &quot;Often a function may need to dynamically resolve data from an external API or a database, with no way of knowing about it beforehand. This typically results in an implementation where pure and impure concerns are interleaved with each other, creating a tightly coupled cohesive structure.&quot;
        &lt;/p&gt;
        &lt;footer&gt;&lt;cite&gt;Oleksii Holub, &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle&quot;&gt;Pure-Impure Segregation Principle&lt;/a&gt;&lt;/cite&gt;&lt;/footer&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;
        The article then proceeds to present the &lt;em&gt;song recommendations&lt;/em&gt; example. It&apos;s a single C# method that queries a data store or third-party service to recommend songs. I&apos;m imagining that it queries a third-party web service that contains usages data for a system like &lt;a href=&quot;https://en.wikipedia.org/wiki/Spotify&quot;&gt;Spotify&lt;/a&gt;.
    &lt;/p&gt;
    &lt;blockquote&gt;
        &lt;p&gt;
            &quot;The above algorithm works by retrieving the user&apos;s most listened songs, finding other people who have also listened to the same titles, and then extracting their top songs as well. Those songs are then aggregated into a list of recommendations and returned to the caller.
        &lt;/p&gt;
        &lt;p&gt;
            &quot;It&apos;s quite clear that this function would benefit greatly from being pure, seeing how much business logic is encapsulated within it. Unfortunately, the technique we relied upon earlier won&apos;t work here.
        &lt;/p&gt;
        &lt;p&gt;
            &quot;In order to fully isolate &lt;code&gt;GetRecommendationsAsync(...)&lt;/code&gt; from its impure dependencies, we would have to somehow supply the function with an entire list of songs, users, and their scrobbles upfront. If we assume that we&apos;re dealing with data on millions of users, it&apos;s obvious that this would be completely impractical and likely even impossible.&quot;
        &lt;/p&gt;
        &lt;footer&gt;&lt;cite&gt;Oleksii Holub, &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle&quot;&gt;Pure-Impure Segregation Principle&lt;/a&gt;&lt;/cite&gt;&lt;/footer&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;
        It does, indeed, sound impractical.
    &lt;/p&gt;
    &lt;h3 id=&quot;ca5fdd1711554b3eb1ae7d516c003959&quot;&gt;
        Data sizes &lt;a href=&quot;#ca5fdd1711554b3eb1ae7d516c003959&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Can you, however, trust your intuition? Research suggests that the human brain is ill-equipped to think about randomness and probabilities, and I&apos;ve observed something similar when it comes to data sizes.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;img src=&quot;/content/binary/dr-evil-one-million.jpg&quot; alt=&quot;Dr. Evil: One million.&quot;&gt;
    &lt;/p&gt;
    &lt;p&gt;
        In the real world, a million of anything countable is an almost incomprehensible amount, so it&apos;s no wonder if our intuition fails us. &lt;em&gt;A million records&lt;/em&gt; sounds like a lot, but if it&apos;s only a few integers, is it really that bad?
    &lt;/p&gt;
    &lt;p&gt;
        Many systems use 32-bit integers for various IDs. A million IDs, then, is 32 million bits, or approximately 4 MB. As I&apos;m writing this, the smallest Azure instance (&lt;em&gt;Free F1&lt;/em&gt;) has 1 GB of memory, and while the OS takes a big bite out of that, 4 MB is nothing.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;em&gt;song recommendations&lt;/em&gt; problem implies larger memory pressure. It may not fit on every machine, but it&apos;s worth considering if, after all, it doesn&apos;t fit in RAM.
    &lt;/p&gt;
    &lt;h3 id=&quot;0579cae8c684409f8a43eaf2baa1d5b0&quot;&gt;
        My real-life experience with developing streaming services &lt;a href=&quot;#0579cae8c684409f8a43eaf2baa1d5b0&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        It just so happens that I have professional experience developing REST APIs for a white-label audio streaming service. Back in the early 2010s I helped design and implement the company&apos;s online music catalogue, user system, and a few other services. The catalogue is particularly interesting in this regard, since it only changed nightly, and we were planning on relying on HTTP for caching.
    &lt;/p&gt;
    &lt;p&gt;
        I vividly recall a meeting we had with the IT operations specialist responsible for the new catalogue service. We explained that we&apos;d set HTTP cache timeouts to 6 hours, and asked if he&apos;d be able to set up a &lt;a href=&quot;https://en.wikipedia.org/wiki/Reverse_proxy&quot;&gt;reverse proxy&lt;/a&gt; so that we didn&apos;t have to implement caching in our code base.
    &lt;/p&gt;
    &lt;p&gt;
        He asked how much cache space we needed.
    &lt;/p&gt;
    &lt;p&gt;
        We knew the size of a typical HTTP response, and the number of tracks, artists, and albums in the system, so after a back-of-the-envelope calculation, we told him: 18 GB.
    &lt;/p&gt;
    &lt;p&gt;
        He just shrugged and said &lt;em&gt;&quot;OK&quot;&lt;/em&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        In 2012 I though that 18 GB was a fair amount of data (I actually still think that). Even so, the operations team had plenty of servers with that capacity.
    &lt;/p&gt;
    &lt;p&gt;
        Later, I did more work for that company, but most of it is less relevant to the &lt;em&gt;song recommendations&lt;/em&gt; example. What does turn out to be relevant to the topic is something I learned the first few days of my engagement.
    &lt;/p&gt;
    &lt;p&gt;
        Early on, before I was involved, the company needed a recommendation system, but hadn&apos;t been able to find any off-the-shelf component. This was in the early 2000s and before &lt;a href=&quot;https://en.wikipedia.org/wiki/Apache_Solr&quot;&gt;Solr&lt;/a&gt;, but after &lt;a href=&quot;https://en.wikipedia.org/wiki/Apache_Lucene&quot;&gt;Lucene&lt;/a&gt;. I&apos;m not aware of all the forces that affected my then future client, but in the end, they decided to write their own search and recommendations engine.
    &lt;/p&gt;
    &lt;p&gt;
        Essentially, during the night a beefy server would read all relevant data from the database, crunch it, create data structures, and keep all data in memory. Like the reverse proxy, it required a server with more RAM than a normal &lt;a href=&quot;https://en.wikipedia.org/wiki/Pizza_box_form_factor&quot;&gt;pizza box&lt;/a&gt;, but not prohibitively so.
    &lt;/p&gt;
    &lt;h3 id=&quot;8fa70bcec92b4b8681af7ca819e82a22&quot;&gt;
        Costs &lt;a href=&quot;#8fa70bcec92b4b8681af7ca819e82a22&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Consider the cost of hardware, compared to developer time. A few specialised servers may set your organisation back a few thousand of dollars/pounds/euros. That&apos;s an amount you can easily burn through in salary if the code is too complicated, or has too many bugs.
    &lt;/p&gt;
    &lt;p&gt;
        You may argue that if you already have programmers on staff, they don&apos;t cost extra, but a too-complicated code base is still going to slow them down. Thus, the wrong software design could incur an &lt;a href=&quot;https://en.wikipedia.org/wiki/Opportunity_cost&quot;&gt;opportunity cost&lt;/a&gt; greater than the cost of a server.
    &lt;/p&gt;
    &lt;p&gt;
        One of many reasons I&apos;m interested in functional programming (FP) is its potential to make code bases simpler. The &lt;a href=&quot;/2020/03/02/impureim-sandwich&quot;&gt;Impureim Sandwich&lt;/a&gt; is a wonderfully simple design, so it&apos;s worth pursuing; not only for some FP ideal, but because of its simplifying potential.
    &lt;/p&gt;
    &lt;p&gt;
        Intuition may tell us that the &lt;em&gt;song recommendations&lt;/em&gt; scenario is prohibitively big, and therefore, an Impureim Sandwich is out of the question. As this overall article series explores, it&apos;s not the only alternative, but given its advantages, its worth giving it a second chance.
    &lt;/p&gt;
    &lt;h3 id=&quot;ac5d135ca06a472e88971ad6a8960aac&quot;&gt;
        Analysis &lt;a href=&quot;#ac5d135ca06a472e88971ad6a8960aac&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; method from &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle#interleaved-impurities&quot;&gt;the example&lt;/a&gt; makes a lot of external calls, with its nested loops. The method uses the first call to &lt;code&gt;GetTopScrobblesAsync&lt;/code&gt; to produce the &lt;code&gt;scrobblesSnapshot&lt;/code&gt; variable, which is capped at 100 objects. If we assume that this method call returns at least 100 objects, the outer &lt;code&gt;foreach&lt;/code&gt; loop will make 100 calls to &lt;code&gt;GetTopListenersAsync&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        If we again assume that each of these return enough data, the inner &lt;code&gt;foreach&lt;/code&gt; loop will make 20 calls to &lt;code&gt;GetTopScrobblesAsync&lt;/code&gt;, for each object in the outer loop. That&apos;s 2,000 external calls, plus the 100 calls in the outer loop, plus the initial call to &lt;code&gt;GetTopScrobblesAsync&lt;/code&gt;, for a total of 2,101.
    &lt;/p&gt;
    &lt;p&gt;
        When I first saw the example, I didn&apos;t know much about the overall context. I didn&apos;t know if these impure actions were database queries or web service calls, so I asked Oleksii Holub.
    &lt;/p&gt;
    &lt;p&gt;
        It turns out that it&apos;s all web service calls, and as I interpret the response, &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; is being invoked from a background maintenance process.
    &lt;/p&gt;
    &lt;blockquote&gt;
        &lt;p&gt;
            &quot;It takes around 10 min in total while maintaining it.&quot;
        &lt;/p&gt;
        &lt;footer&gt;&lt;cite&gt;&lt;a href=&quot;https://twitter.com/Tyrrrz/status/1493369905869213700&quot;&gt;Tweet&lt;/a&gt;, Oleksii Holub, 2022&lt;/cite&gt;&lt;/footer&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;
        That&apos;s good to know, because if we&apos;re going to consider an Impureim Sandwich, it implies reading gigabytes of data in the first phase. That&apos;s going to take some time, but if this is a background process, we &lt;em&gt;do&lt;/em&gt; have time.
    &lt;/p&gt;
    &lt;h3 id=&quot;2160fbaf60434edd9554ff585de5df2b&quot;&gt;
        Memory estimates &lt;a href=&quot;#2160fbaf60434edd9554ff585de5df2b&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        One thing is to load an entire song catalogue into memory. That&apos;s what required 18 GB in 2012. Another thing is to load all scrobbles; i.e. statistics about plays. Fortunately, in order to produce song recommendations, we only need IDs. Consider again the data structures from the &lt;a href=&quot;/2025/04/10/characterising-song-recommendations&quot;&gt;previous article&lt;/a&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;Id,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;bool&lt;/span&gt;&amp;nbsp;IsVerifiedArtist,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;byte&lt;/span&gt;&amp;nbsp;Rating);

&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Scrobble&lt;/span&gt;(Song&amp;nbsp;Song,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;ScrobbleCount);

&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;User&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;UserName,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;TotalScrobbleCount);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Apart from the &lt;code&gt;UserName&lt;/code&gt; all values are small predictable values: &lt;code&gt;int&lt;/code&gt;, &lt;code&gt;byte&lt;/code&gt;, and &lt;code&gt;bool&lt;/code&gt;, and while a &lt;code&gt;string&lt;/code&gt; may be arbitrarily long, we can make a guess at the average size of a user name. In the &lt;a href=&quot;/2025/04/10/characterising-song-recommendations&quot;&gt;previous article&lt;/a&gt;, I assumed that the user name would be an alphanumeric string between one and twenty characters.
    &lt;/p&gt;
    &lt;p&gt;
        How many songs might a system contain? Some numbers thrown around for a system like Spotify suggest a number on the order of 100 million. With an &lt;code&gt;int&lt;/code&gt;, a &lt;code&gt;bool&lt;/code&gt;, and a &lt;code&gt;byte&lt;/code&gt;, we can estimate that a song requires 6 bytes, plus some overhead. Let&apos;s guess 8 bytes. A 100 million songs would then require 800 million bytes, or around 800 MB. That eliminates the smallest cloud instances, but is in itself easily within reach for all modern computers. Your phone has more memory than that.
    &lt;/p&gt;
    &lt;p&gt;
        How about scrobbles? While I don&apos;t use Spotify, &lt;a href=&quot;https://www.last.fm/user/ploeh&quot;&gt;I do scrobble plays to Last.fm&lt;/a&gt;. At the moment I have around 114,000 scrobbles, and while I don&apos;t listen to music as much as I used to when I was younger, I have, on the other hand, been at it for a long time: Since 2007. If we assume that each user has 200,000 scrobbles, and a scrobble requires 8 bytes, that&apos;s 1,600,000 bytes, or 1.6 MB. Practically nothing.
    &lt;/p&gt;
    &lt;p&gt;
        The size of a &lt;code&gt;User&lt;/code&gt; object depends on how long the user name is, but will probably, on average, be less than 32 bytes. Compared to the user&apos;s scrobbles, we can ignore the memory pressure of the user object itself.
    &lt;/p&gt;
    &lt;p&gt;
        As the number of users grow, it will dominate the memory requirements for the catalogue. How many users should we assume?
    &lt;/p&gt;
    &lt;p&gt;
        A million is probably too few, but for a frame of reference, that would require 1,6 TB. This is where it starts to sound unfeasible to keep all data in RAM. Even though servers with that much RAM exist, they&apos;re so expensive (still) that the above cost consideration no longer applies.
    &lt;/p&gt;
    &lt;p&gt;
        Still, there are some naive assumptions above. Instead of storing each scrobble in a separate &lt;code&gt;Scrobble&lt;/code&gt; object, you could store repeated plays as a single object with the appropriate &lt;code&gt;ScrobbleCount&lt;/code&gt; value. If you&apos;ve listened to the same song 50 times, it doesn&apos;t require 400 bytes of storage, but only 8 bytes. That is, after all, orders of magnitude less.
    &lt;/p&gt;
    &lt;p&gt;
        In the end, back-of-the-envelope calculations are fine, but measurements are better. It might be worthwhile to develop a proof of concept and measure how much memory it requires.
    &lt;/p&gt;
    &lt;p&gt;
        In three articles, I&apos;ll explore how a &lt;em&gt;song recommendations&lt;/em&gt; Impureim Sandwich looks in various constellations:
    &lt;/p&gt;
    &lt;ul&gt;
        &lt;li&gt;&lt;a href=&quot;/2025/05/05/song-recommendations-as-a-c-impureim-sandwich&quot;&gt;Song recommendations as a C# Impureim Sandwich&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;Song recommendations as an F# Impureim Sandwich&lt;/li&gt;
        &lt;li&gt;Song recommendations as a Haskell Impureim Sandwich&lt;/li&gt;
    &lt;/ul&gt;
    &lt;p&gt;
        In the end, it may turn out that for this particular system, an Impureim Sandwich truly is unfeasible. Keep in mind, though, that the purpose of this article series is to demonstrate alternative designs. The &lt;em&gt;song recommendations&lt;/em&gt; problem is just a placeholder example. Perhaps you have another system where, intuitively, an Impureim Sandwich sounds impossible, but once you run the numbers, it might actually be not only possible, but desirable.
    &lt;/p&gt;
    &lt;h3 id=&quot;d38416a3535743159ba26abb4a78948b&quot;&gt;
        Conclusion &lt;a href=&quot;#d38416a3535743159ba26abb4a78948b&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Modern computers have so vast storage capacities that intuition often fails us. We may think that billions of data points sounds like something that can&apos;t possibly fit in RAM. When you run the numbers, however, it may turn out that the required data fits on a normal server.
    &lt;/p&gt;
    &lt;p&gt;
        If so, an Impureim Sandwich may still be an option. Load data into memory, pass it as argument to a pure function, and handle the return value.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;em&gt;song recommendations&lt;/em&gt; scenario is interesting because an Impureim Sandwich seems to be pushing the envelope. It probably &lt;em&gt;is&lt;/em&gt; impractical, but still worth a proof of concept. On the other hand, if it&apos;s impractical, it&apos;s worthwhile to also explore alternatives. Later articles will do that, but first, if you&apos;re interested, the next articles look at the proofs of concept in three languages.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2025/05/05/song-recommendations-as-a-c-impureim-sandwich&quot;&gt;Song recommendations as a C# Impureim Sandwich&lt;/a&gt;.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2025/04/28/song-recommendations-as-an-impureim-sandwich</guid>
      </item>
    
      <item>
        <title>Porting song recommendations to Haskell</title>
        <link>https://blog.ploeh.dk/2025/04/21/porting-song-recommendations-to-haskell/</link>
        <pubDate>Mon, 21 Apr 2025 10:19:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;An F# code base translated to Haskell.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This article is part of a &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;larger article series&lt;/a&gt; that examines variations of how to take on a non-trivial problem using &lt;a href=&quot;/2018/11/19/functional-architecture-a-definition&quot;&gt;functional architecture&lt;/a&gt;. In a &lt;a href=&quot;/2025/04/10/characterising-song-recommendations&quot;&gt;previous article&lt;/a&gt; we established a baseline C# code base. Future articles are going to use that C# code base as a starting point for refactored code. On the other hand, I also want to demonstrate what such solutions may look like in languages like &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt; or &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt;. In this article, you&apos;ll see how to port the baseline to Haskell. To be honest, I first &lt;a href=&quot;/2025/04/14/porting-song-recommendations-to-f&quot;&gt;ported the C# code to F#&lt;/a&gt;, and then used the F# code as a guide to implement equivalent Haskell code.
    &lt;/p&gt;
    &lt;p&gt;
        If you&apos;re following along in the Git repositories, this is a repository separate from the .NET repositories. The code shown here is from its &lt;em&gt;master&lt;/em&gt; branch.
    &lt;/p&gt;
    &lt;p&gt;
        If you don&apos;t care about Haskell, you can always go back to the table of contents in &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;the &apos;root&apos; article&lt;/a&gt; and proceed to the next topic that interests you.
    &lt;/p&gt;
    &lt;h3 id=&quot;2c7511eb050b4d399f7e7fb154c5d990&quot;&gt;
        Data structures &lt;a href=&quot;#2c7511eb050b4d399f7e7fb154c5d990&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        When working with statically typed functional languages like Haskell, it often makes most sense to start by declaring data structures.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;data&lt;/span&gt;&amp;nbsp;User&amp;nbsp;=&amp;nbsp;User
&amp;nbsp;&amp;nbsp;{&amp;nbsp;userName&amp;nbsp;::&amp;nbsp;String
&amp;nbsp;&amp;nbsp;,&amp;nbsp;userScrobbleCount&amp;nbsp;::&amp;nbsp;Int&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;deriving&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Show&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Eq&lt;/span&gt;)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This is much like an F# or C# record declaration, and this one echoes the corresponding types in F# and C#. The most significant difference is that here, a user&apos;s total count of scrobbles is called &lt;code&gt;userScrobbleCount&lt;/code&gt; rather than &lt;code&gt;TotalScrobbleCount&lt;/code&gt;. The motivation behind that variation is that Haskell data &apos;getters&apos; are actually top-level functions, so it&apos;s usually a good idea to prefix them with the name of the data structure they work on. Since the data structure is called &lt;code&gt;User&lt;/code&gt;, both &apos;getter&apos; functions get the &lt;code&gt;user&lt;/code&gt; prefix.
    &lt;/p&gt;
    &lt;p&gt;
        I found &lt;code&gt;userTotalScrobbleCount&lt;/code&gt; a bit too verbose to my tastes, so I dropped the &lt;code&gt;Total&lt;/code&gt; part. Whether or not that&apos;s appropriate remains to be seen. Naming in programming is always hard, and there&apos;s a risk that you don&apos;t get it right the first time around. Unless you&apos;re publishing a reusable library, however, the option to rename it later remains.
    &lt;/p&gt;
    &lt;p&gt;
        The other two data structures are quite similar:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;data&lt;/span&gt;&amp;nbsp;Song&amp;nbsp;=&amp;nbsp;Song
&amp;nbsp;&amp;nbsp;{&amp;nbsp;songId&amp;nbsp;::&amp;nbsp;Int
&amp;nbsp;&amp;nbsp;,&amp;nbsp;songHasVerifiedArtist&amp;nbsp;::&amp;nbsp;Bool
&amp;nbsp;&amp;nbsp;,&amp;nbsp;songRating&amp;nbsp;::&amp;nbsp;Word8&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;deriving&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Show&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Eq&lt;/span&gt;)
 
&lt;span style=&quot;color:blue;&quot;&gt;data&lt;/span&gt;&amp;nbsp;Scrobble&amp;nbsp;=&amp;nbsp;Scrobble
&amp;nbsp;&amp;nbsp;{&amp;nbsp;scrobbledSong&amp;nbsp;::&amp;nbsp;Song
&amp;nbsp;&amp;nbsp;,&amp;nbsp;scrobbleCount&amp;nbsp;::&amp;nbsp;Int&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;deriving&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Show&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Eq&lt;/span&gt;)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I thought that &lt;code&gt;scrobbledSong&lt;/code&gt; was more descriptive than &lt;code&gt;scrobbleSong&lt;/code&gt;, so I allowed myself that little deviation from the &lt;a href=&quot;/2015/08/03/idiomatic-or-idiosyncratic&quot;&gt;idiomatic&lt;/a&gt; naming convention. It didn&apos;t cause any problems, but I&apos;m still not sure if that was a good decision.
    &lt;/p&gt;
    &lt;p&gt;
        How does one translate a C# interface to Haskell? Although type classes aren&apos;t quite the same as C# or Java interfaces, this language feature is close enough that I can use it in that role. I don&apos;t consider such a type class idiomatic in Haskell, but as an counterpart to the C# interface, it works well enough.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;class&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SongService&lt;/span&gt;&amp;nbsp;a&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;where&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;getTopListeners&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;a&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IO&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;User&lt;/span&gt;]
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;getTopScrobbles&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;a&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IO&lt;/span&gt;&amp;nbsp;[&lt;span style=&quot;color:blue;&quot;&gt;Scrobble&lt;/span&gt;]&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Any instance of the &lt;code&gt;SongService&lt;/code&gt; class supports queries for top listeners of a particular song, as well as for top scrobbles for a user.
    &lt;/p&gt;
    &lt;p&gt;
        To reiterate, I don&apos;t intend to keep this type class around if I can help it, but for didactic reasons, it&apos;ll remain in some of the future refactorings, so that you can contrast and compare the Haskell code to its C# and F# peers.
    &lt;/p&gt;
    &lt;h3 id=&quot;83350f6a8a484249b466fcb72978c64d&quot;&gt;
        Test Double &lt;a href=&quot;#83350f6a8a484249b466fcb72978c64d&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        To support tests, I needed a &lt;a href=&quot;https://martinfowler.com/bliki/TestDouble.html&quot;&gt;Test Double&lt;/a&gt;, so I defined the following &lt;a href=&quot;http://xunitpatterns.com/Fake%20Object.html&quot;&gt;Fake&lt;/a&gt; service, which is nothing but a deterministic in-memory instance. The type itself is just a wrapper of two maps.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;data&lt;/span&gt;&amp;nbsp;FakeSongService&amp;nbsp;=&amp;nbsp;FakeSongService
&amp;nbsp;&amp;nbsp;{&amp;nbsp;fakeSongs&amp;nbsp;::&amp;nbsp;Map&amp;nbsp;Int&amp;nbsp;Song
&amp;nbsp;&amp;nbsp;,&amp;nbsp;fakeUsers&amp;nbsp;::&amp;nbsp;Map&amp;nbsp;String&amp;nbsp;(Map&amp;nbsp;Int&amp;nbsp;Int)&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;deriving&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Show&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Eq&lt;/span&gt;)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Like the equivalent C# class, &lt;code&gt;fakeSongs&lt;/code&gt; is a map from song ID to &lt;code&gt;Song&lt;/code&gt;, while &lt;code&gt;fakeUsers&lt;/code&gt; is a bit more complex. It&apos;s a map keyed on user name, but the value is another map. The keys of that inner map are song IDs, while the values are the number of times each song was scrobbled by that user.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;FakeSongService&lt;/code&gt; data structure is a &lt;code&gt;SongService&lt;/code&gt; instance by explicit implementation:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;instance&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;SongService&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;FakeSongService&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;where&lt;/span&gt;
&amp;nbsp;&amp;nbsp;getTopListeners&amp;nbsp;srvc&amp;nbsp;sid&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;uncurry&lt;/span&gt;&amp;nbsp;User&amp;nbsp;&amp;lt;$&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Map.toList&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;sum&lt;/span&gt;&amp;nbsp;&amp;lt;$&amp;gt;&amp;nbsp;Map.&lt;span style=&quot;color:blue;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(Map.member&amp;nbsp;sid)&amp;nbsp;(fakeUsers&amp;nbsp;srvc))
&amp;nbsp;&amp;nbsp;getTopScrobbles&amp;nbsp;srvc&amp;nbsp;userName&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fmap&lt;/span&gt;&amp;nbsp;(\(sid,&amp;nbsp;c)&amp;nbsp;-&amp;gt;&amp;nbsp;Scrobble&amp;nbsp;(fakeSongs&amp;nbsp;srvc&amp;nbsp;!&amp;nbsp;sid)&amp;nbsp;c)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Map.toList&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Map.findWithDefault&amp;nbsp;Map.empty&amp;nbsp;userName&amp;nbsp;(fakeUsers&amp;nbsp;srvc)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        In order to find all the top listeners of a song, it finds all the &lt;code&gt;fakeUsers&lt;/code&gt; who have the song ID (&lt;code&gt;sid&lt;/code&gt;) in their inner map, sum all of those users&apos; scrobble counts together and creates &lt;code&gt;User&lt;/code&gt; values from that data.
    &lt;/p&gt;
    &lt;p&gt;
        To find the top scrobbles of a user, the instance finds the user in the &lt;code&gt;fakeUsers&lt;/code&gt; map, looks each of that user&apos;s scrobbled song up in &lt;code&gt;fakeSongs&lt;/code&gt;, and creates &lt;code&gt;Scrobble&lt;/code&gt; values from that information.
    &lt;/p&gt;
    &lt;p&gt;
        Finally, test code needs a way to add data to a &lt;code&gt;FakeSongService&lt;/code&gt; value, which this &lt;a href=&quot;http://xunitpatterns.com/Test%20Utility%20Method.html&quot;&gt;test-specific helper function&lt;/a&gt; accomplishes:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;scrobble&amp;nbsp;userName&amp;nbsp;s&amp;nbsp;c&amp;nbsp;(FakeSongService&amp;nbsp;ss&amp;nbsp;us)&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;sid&amp;nbsp;=&amp;nbsp;songId&amp;nbsp;s
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ss&amp;#39;&amp;nbsp;=&amp;nbsp;Map.insertWith&amp;nbsp;(\_&amp;nbsp;_&amp;nbsp;-&amp;gt;&amp;nbsp;s)&amp;nbsp;sid&amp;nbsp;s&amp;nbsp;ss
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;us&amp;#39;&amp;nbsp;=&amp;nbsp;Map.insertWith&amp;nbsp;(Map.unionWith&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;(+)&lt;/span&gt;)&amp;nbsp;userName&amp;nbsp;(Map.singleton&amp;nbsp;sid&amp;nbsp;c)&amp;nbsp;us
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;FakeSongService&amp;nbsp;ss&amp;#39;&amp;nbsp;us&amp;#39;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Given a user name, a song, a scrobble count, and a &lt;code&gt;FakeSongService&lt;/code&gt;, this function returns a new &lt;code&gt;FakeSongService&lt;/code&gt; value with the new data added to the data already there.
    &lt;/p&gt;
    &lt;h3 id=&quot;1e89e2737f3e4fe1849f840052f305e2&quot;&gt;
        QuickCheck Arbitraries &lt;a href=&quot;#1e89e2737f3e4fe1849f840052f305e2&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        In the F# test code I used &lt;a href=&quot;https://fscheck.github.io/FsCheck/&quot;&gt;FsCheck&lt;/a&gt; to get good coverage of the code. For Haskell, I&apos;ll use &lt;a href=&quot;https://hackage.haskell.org/package/QuickCheck&quot;&gt;QuickCheck&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Porting the ideas from the F# tests, I define a QuickCheck generator for user names:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#2b91af;&quot;&gt;alphaNum&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Gen&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Char&lt;/span&gt;
alphaNum&amp;nbsp;=&amp;nbsp;elements&amp;nbsp;([&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;a&amp;#39;&lt;/span&gt;..&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;z&amp;#39;&lt;/span&gt;]&amp;nbsp;++&amp;nbsp;[&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;A&amp;#39;&lt;/span&gt;..&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;Z&amp;#39;&lt;/span&gt;]&amp;nbsp;++&amp;nbsp;[&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;..&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;9&amp;#39;&lt;/span&gt;])
 
&lt;span style=&quot;color:#2b91af;&quot;&gt;userName&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;::&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Gen&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;String&lt;/span&gt;
userName&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;len&amp;nbsp;&amp;lt;-&amp;nbsp;choose&amp;nbsp;(1,&amp;nbsp;19)
&amp;nbsp;&amp;nbsp;first&amp;nbsp;&amp;lt;-&amp;nbsp;elements&amp;nbsp;$&amp;nbsp;[&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;a&amp;#39;&lt;/span&gt;..&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;z&amp;#39;&lt;/span&gt;]&amp;nbsp;++&amp;nbsp;[&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;A&amp;#39;&lt;/span&gt;..&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;Z&amp;#39;&lt;/span&gt;]
&amp;nbsp;&amp;nbsp;rest&amp;nbsp;&amp;lt;-&amp;nbsp;vectorOf&amp;nbsp;len&amp;nbsp;alphaNum
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;$&amp;nbsp;first&amp;nbsp;:&amp;nbsp;rest&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        It&apos;s not that the algorithm only works if usernames are alphanumeric strings that start with a letter and are no longer than twenty characters, but whenever a property is falsified, I&apos;d rather look at a user name like &lt;code&gt;&quot;Yvj0D1I&quot;&lt;/code&gt; or &lt;code&gt;&quot;tyD9P1eOqwMMa1Q6u&quot;&lt;/code&gt; (which are already bad enough), than something with line breaks and unprintable characters.
    &lt;/p&gt;
    &lt;p&gt;
        Working with QuickCheck, it&apos;s often &lt;a href=&quot;/2019/09/02/naming-newtypes-for-quickcheck-arbitraries&quot;&gt;useful to wrap types from the System Under Test in test-specific Arbitrary wrappers&lt;/a&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;newtype&lt;/span&gt;&amp;nbsp;ValidUserName&amp;nbsp;=&amp;nbsp;ValidUserName&amp;nbsp;{&amp;nbsp;getUserName&amp;nbsp;::&amp;nbsp;String&amp;nbsp;}&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;deriving&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Show&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Eq&lt;/span&gt;)
 
&lt;span style=&quot;color:blue;&quot;&gt;instance&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;Arbitrary&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;ValidUserName&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;where&lt;/span&gt;
&amp;nbsp;&amp;nbsp;arbitrary&amp;nbsp;=&amp;nbsp;ValidUserName&amp;nbsp;&amp;lt;$&amp;gt;&amp;nbsp;userName&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        I also defined a (simpler) &lt;code&gt;Arbitrary&lt;/code&gt; instance for &lt;code&gt;Song&lt;/code&gt; called &lt;code&gt;AnySong&lt;/code&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;fd6ddacfd3c34430abb30288f5fb37a6&quot;&gt;
        A few properties &lt;a href=&quot;#fd6ddacfd3c34430abb30288f5fb37a6&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        With &lt;code&gt;FakeSongService&lt;/code&gt; in place, I proceeded to add the test code, starting from the top of the F# test code, and translating each as faithfully as possible. The first one is an &lt;a href=&quot;https://agileotter.blogspot.com/2008/12/unit-test-ice-breakers.html&quot;&gt;Ice Breaker Test&lt;/a&gt; that only verifies that the System Under Test exists and doesn&apos;t crash when called.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;testProperty&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;No&amp;nbsp;data&amp;quot;&lt;/span&gt;&amp;nbsp;$&amp;nbsp;\&amp;nbsp;(ValidUserName&amp;nbsp;un)&amp;nbsp;-&amp;gt;&amp;nbsp;ioProperty&amp;nbsp;$&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;actual&amp;nbsp;&amp;lt;-&amp;nbsp;getRecommendations&amp;nbsp;emptyService&amp;nbsp;un
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;$&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;&amp;nbsp;actual&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        As I&apos;ve done since at least 2019, &lt;a href=&quot;/2019/03/11/an-example-of-state-based-testing-in-haskell&quot;&gt;it seems&lt;/a&gt;, I&apos;ve &lt;a href=&quot;/2018/05/07/inlined-hunit-test-lists&quot;&gt;inlined test cases as anonymous functions&lt;/a&gt;; this time as QuickCheck properties. This one just creates a &lt;code&gt;FakeSongService&lt;/code&gt; that contains no data, and asks for recommendations. The expected result is that &lt;code&gt;actual&lt;/code&gt; is empty (&lt;code&gt;null&lt;/code&gt;), since there&apos;s nothing to recommend.
    &lt;/p&gt;
    &lt;p&gt;
        A slightly more involved property adds some data to the service before requesting recommendations:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;testProperty&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;One&amp;nbsp;user,&amp;nbsp;some&amp;nbsp;songs&amp;quot;&lt;/span&gt;&amp;nbsp;$&amp;nbsp;\
&amp;nbsp;&amp;nbsp;(ValidUserName&amp;nbsp;user)
&amp;nbsp;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fmap&lt;/span&gt;&amp;nbsp;getSong&amp;nbsp;-&amp;gt;&amp;nbsp;songs)
&amp;nbsp;&amp;nbsp;-&amp;gt;&amp;nbsp;monadicIO&amp;nbsp;$&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;scrobbleCounts&amp;nbsp;&amp;lt;-&amp;nbsp;pick&amp;nbsp;$&amp;nbsp;vectorOf&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;length&lt;/span&gt;&amp;nbsp;songs)&amp;nbsp;$&amp;nbsp;choose&amp;nbsp;(1,&amp;nbsp;100)
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;scrobbles&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;zip&lt;/span&gt;&amp;nbsp;songs&amp;nbsp;scrobbleCounts
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;srvc&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;foldr&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;uncurry&lt;/span&gt;&amp;nbsp;(scrobble&amp;nbsp;user))&amp;nbsp;emptyService&amp;nbsp;scrobbles
 
&amp;nbsp;&amp;nbsp;actual&amp;nbsp;&amp;lt;-&amp;nbsp;run&amp;nbsp;$&amp;nbsp;getRecommendations&amp;nbsp;srvc&amp;nbsp;user
 
&amp;nbsp;&amp;nbsp;assertWith&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;&amp;nbsp;actual)&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Should&amp;nbsp;be&amp;nbsp;empty&amp;quot;&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        A couple of things are worthy of note. First, the property &lt;a href=&quot;/2018/05/14/project-arbitraries-with-view-patterns&quot;&gt;uses a view pattern to project a list of songs from a list of Arbitraries&lt;/a&gt;, where &lt;code&gt;getSong&lt;/code&gt; is the &apos;getter&apos; that belongs to the &lt;code&gt;AnySong&lt;/code&gt; &lt;code&gt;newtype&lt;/code&gt; wrapper.
    &lt;/p&gt;
    &lt;p&gt;
        I find view patterns quite useful as a declarative way to &apos;promote&apos; a single &lt;code&gt;Arbitrary&lt;/code&gt; instance to a list. In a third property, I take it a step further:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;(&lt;span style=&quot;color:blue;&quot;&gt;fmap&lt;/span&gt;&amp;nbsp;getUserName&amp;nbsp;-&amp;gt;&amp;nbsp;NonEmpty&amp;nbsp;users)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This not only turns the singular &lt;code&gt;ValidUserName&lt;/code&gt; wrapper into a list, but by projecting it into &lt;code&gt;NonEmpty&lt;/code&gt;, the test declares that &lt;code&gt;users&lt;/code&gt; is a non-empty list. QuickCheck picks all that up and generates values accordingly.
    &lt;/p&gt;
    &lt;p&gt;
        If you&apos;re interested in seeing this more advanced view pattern in context, you may consult the Git repository.
    &lt;/p&gt;
    &lt;p&gt;
        Secondly, the &lt;code&gt;&quot;One user, some songs&quot;&lt;/code&gt; test runs in &lt;code&gt;monadicIO&lt;/code&gt;, which I didn&apos;t know existed before I wrote these tests. Together with &lt;code&gt;pick&lt;/code&gt;, &lt;code&gt;run&lt;/code&gt;, and &lt;code&gt;assertWith&lt;/code&gt;, &lt;code&gt;monadicIO&lt;/code&gt; is defined in &lt;a href=&quot;https://hackage.haskell.org/package/QuickCheck/docs/Test-QuickCheck-Monadic.html&quot;&gt;Test.QuickCheck.Monadic&lt;/a&gt;. It enables you to write properties that run in &lt;code&gt;IO&lt;/code&gt;, which these properties need to do, because &lt;code&gt;getRecommendations&lt;/code&gt; is &lt;code&gt;IO&lt;/code&gt;-bound.
    &lt;/p&gt;
    &lt;p&gt;
        There&apos;s one more QuickCheck property in the code base, but it mostly repeats techniques already shown here. See the Git repository for all the details, if necessary.
    &lt;/p&gt;
    &lt;h3 id=&quot;76fa24be614e460e9af82b2652c82c07&quot;&gt;
        Examples &lt;a href=&quot;#76fa24be614e460e9af82b2652c82c07&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        In addition to the properties, I also ported the F# examples; that is, &apos;normal&apos; unit tests. Here&apos;s one of them:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;One&amp;nbsp;verified&amp;nbsp;recommendation&amp;quot;&lt;/span&gt;&amp;nbsp;~:&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;srvc&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;scrobble&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;ana&amp;quot;&lt;/span&gt;&amp;nbsp;(Song&amp;nbsp;2&amp;nbsp;True&amp;nbsp;5)&amp;nbsp;9_9990&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;scrobble&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;ana&amp;quot;&lt;/span&gt;&amp;nbsp;(Song&amp;nbsp;1&amp;nbsp;False&amp;nbsp;5)&amp;nbsp;10&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;scrobble&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;cat&amp;quot;&lt;/span&gt;&amp;nbsp;(Song&amp;nbsp;1&amp;nbsp;False&amp;nbsp;6)&amp;nbsp;10&amp;nbsp;emptyService
 
&amp;nbsp;&amp;nbsp;actual&amp;nbsp;&amp;lt;-&amp;nbsp;getRecommendations&amp;nbsp;srvc&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;cat&amp;quot;&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;[Song&amp;nbsp;2&amp;nbsp;True&amp;nbsp;5]&amp;nbsp;@=?&amp;nbsp;actual&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This one is straightforward, but as I already discussed when &lt;a href=&quot;/2025/04/10/characterising-song-recommendations&quot;&gt;characterizing the original code&lt;/a&gt;, some of the examples essentially document quirks in the implementation. Here&apos;s the relevant test, translated to Haskell:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Only&amp;nbsp;top-rated&amp;nbsp;songs&amp;quot;&lt;/span&gt;&amp;nbsp;~:&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;Scale&amp;nbsp;ratings&amp;nbsp;to&amp;nbsp;keep&amp;nbsp;them&amp;nbsp;less&amp;nbsp;than&amp;nbsp;or&amp;nbsp;equal&amp;nbsp;to&amp;nbsp;10.
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;srvc&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;foldr&lt;/span&gt;&amp;nbsp;(\i&amp;nbsp;-&amp;gt;&amp;nbsp;scrobble&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;hyle&amp;quot;&lt;/span&gt;&amp;nbsp;(Song&amp;nbsp;i&amp;nbsp;True&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;toEnum&lt;/span&gt;&amp;nbsp;i&amp;nbsp;`div`&amp;nbsp;2))&amp;nbsp;500)&amp;nbsp;emptyService&amp;nbsp;[1..20]
 
&amp;nbsp;&amp;nbsp;actual&amp;nbsp;&amp;lt;-&amp;nbsp;getRecommendations&amp;nbsp;srvc&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;hyle&amp;quot;&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;assertBool&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Should&amp;nbsp;not&amp;nbsp;be&amp;nbsp;empty&amp;quot;&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;not&lt;/span&gt;&amp;nbsp;$&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;null&lt;/span&gt;&amp;nbsp;actual)
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;Since&amp;nbsp;there&amp;#39;s&amp;nbsp;only&amp;nbsp;one&amp;nbsp;user,&amp;nbsp;but&amp;nbsp;with&amp;nbsp;20&amp;nbsp;songs,&amp;nbsp;the&amp;nbsp;implementation
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;loops&amp;nbsp;over&amp;nbsp;the&amp;nbsp;same&amp;nbsp;songs&amp;nbsp;20&amp;nbsp;times,&amp;nbsp;so&amp;nbsp;400&amp;nbsp;songs&amp;nbsp;in&amp;nbsp;total&amp;nbsp;(with
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;duplicates).&amp;nbsp;Ordering&amp;nbsp;on&amp;nbsp;rating,&amp;nbsp;only&amp;nbsp;the&amp;nbsp;top-rated&amp;nbsp;200&amp;nbsp;remains,&amp;nbsp;that
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;is,&amp;nbsp;those&amp;nbsp;rated&amp;nbsp;5-10.&amp;nbsp;Note&amp;nbsp;that&amp;nbsp;this&amp;nbsp;is&amp;nbsp;a&amp;nbsp;Characterization&amp;nbsp;Test,&amp;nbsp;so&amp;nbsp;not
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;necessarily&amp;nbsp;reflective&amp;nbsp;of&amp;nbsp;how&amp;nbsp;a&amp;nbsp;real&amp;nbsp;recommendation&amp;nbsp;system&amp;nbsp;should&amp;nbsp;work.
&lt;/span&gt;&amp;nbsp;&amp;nbsp;assertBool&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;Should&amp;nbsp;have&amp;nbsp;5+&amp;nbsp;rating&amp;quot;&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;all&lt;/span&gt;&amp;nbsp;((&amp;gt;=&amp;nbsp;5)&amp;nbsp;.&amp;nbsp;songRating)&amp;nbsp;actual)&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This test creates twenty scrobbles for one user: One with a zero rating, two with rating &lt;em&gt;1&lt;/em&gt;, two with rating &lt;em&gt;2&lt;/em&gt;, and so on, up to a single song with rating &lt;em&gt;10&lt;/em&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle#interleaved-impurities&quot;&gt;The implementation of GetRecommendationsAsync&lt;/a&gt; uses these twenty songs to find &apos;other users&apos; who have these top songs as well. In this case, there&apos;s only one user, so for every of those twenty songs, you get the same twenty songs, for a total of 400.
    &lt;/p&gt;
    &lt;p&gt;
        There are more unit tests than these. You can see them in the Git repository.
    &lt;/p&gt;
    &lt;h3 id=&quot;29a2c5558184424eaaba9db49dc30368&quot;&gt;
        Implementation &lt;a href=&quot;#29a2c5558184424eaaba9db49dc30368&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The most direct translation of the C# and F# &apos;reference implementation&apos; that I could think of was this:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;getRecommendations&amp;nbsp;srvc&amp;nbsp;un&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;1.&amp;nbsp;Get&amp;nbsp;user&amp;#39;s&amp;nbsp;own&amp;nbsp;top&amp;nbsp;scrobbles
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;2.&amp;nbsp;Get&amp;nbsp;other&amp;nbsp;users&amp;nbsp;who&amp;nbsp;listened&amp;nbsp;to&amp;nbsp;the&amp;nbsp;same&amp;nbsp;songs
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;3.&amp;nbsp;Get&amp;nbsp;top&amp;nbsp;scrobbles&amp;nbsp;of&amp;nbsp;those&amp;nbsp;users
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;4.&amp;nbsp;Aggregate&amp;nbsp;the&amp;nbsp;songs&amp;nbsp;into&amp;nbsp;recommendations
&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;Impure
&lt;/span&gt;&amp;nbsp;&amp;nbsp;scrobbles&amp;nbsp;&amp;lt;-&amp;nbsp;getTopScrobbles&amp;nbsp;srvc&amp;nbsp;un
 
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;Pure
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;scrobblesSnapshot&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;100&amp;nbsp;$&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;scrobbleCount)&amp;nbsp;scrobbles
 
&amp;nbsp;&amp;nbsp;recommendationCandidates&amp;nbsp;&amp;lt;-&amp;nbsp;newIORef&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;[]&lt;/span&gt;
&amp;nbsp;&amp;nbsp;forM_&amp;nbsp;scrobblesSnapshot&amp;nbsp;$&amp;nbsp;\scrobble&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;Impure
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;otherListeners&amp;nbsp;&amp;lt;-&amp;nbsp;getTopListeners&amp;nbsp;srvc&amp;nbsp;$&amp;nbsp;songId&amp;nbsp;$&amp;nbsp;scrobbledSong&amp;nbsp;scrobble
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;Pure
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;otherListenersSnapshot&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;20&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;userScrobbleCount)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;((10_000&amp;nbsp;&amp;lt;=)&amp;nbsp;.&amp;nbsp;userScrobbleCount)&amp;nbsp;otherListeners
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;forM_&amp;nbsp;otherListenersSnapshot&amp;nbsp;$&amp;nbsp;\otherListener&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;Impure
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;otherScrobbles&amp;nbsp;&amp;lt;-&amp;nbsp;getTopScrobbles&amp;nbsp;srvc&amp;nbsp;$&amp;nbsp;userName&amp;nbsp;otherListener
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;Pure
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;otherScrobblesSnapshot&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;10&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;songRating&amp;nbsp;.&amp;nbsp;scrobbledSong)&amp;nbsp;$
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(songHasVerifiedArtist&amp;nbsp;.&amp;nbsp;scrobbledSong)&amp;nbsp;otherScrobbles
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;forM_&amp;nbsp;otherScrobblesSnapshot&amp;nbsp;$&amp;nbsp;\otherScrobble&amp;nbsp;-&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;song&amp;nbsp;=&amp;nbsp;scrobbledSong&amp;nbsp;otherScrobble
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;modifyIORef&amp;nbsp;recommendationCandidates&amp;nbsp;(song&amp;nbsp;:)
 
&amp;nbsp;&amp;nbsp;recommendations&amp;nbsp;&amp;lt;-&amp;nbsp;readIORef&amp;nbsp;recommendationCandidates
&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;--&amp;nbsp;Pure
&lt;/span&gt;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;$&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;take&lt;/span&gt;&amp;nbsp;200&amp;nbsp;$&amp;nbsp;sortOn&amp;nbsp;(Down&amp;nbsp;.&amp;nbsp;songRating)&amp;nbsp;recommendations&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        In order to mirror &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle#interleaved-impurities&quot;&gt;the original implementation&lt;/a&gt; as closely as possible, I declare &lt;code&gt;recommendationCandidates&lt;/code&gt; as an &lt;a href=&quot;https://hackage.haskell.org/package/base/docs/Data-IORef.html&quot;&gt;IORef&lt;/a&gt; so that I can incrementally add to it as the action goes through its nested loops. Notice the &lt;code&gt;modifyIORef&lt;/code&gt; towards the end of the code listing, which adds a single song to the list.
    &lt;/p&gt;
    &lt;p&gt;
        Once all the looping is done, the action uses &lt;code&gt;readIORef&lt;/code&gt; to pull the &lt;code&gt;recommendations&lt;/code&gt; out of the &lt;code&gt;IORef&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        As you can see, I also ported the comments from the original C# code.
    &lt;/p&gt;
    &lt;p&gt;
        I don&apos;t consider this idiomatic Haskell code, but the goal in this article was to mirror the C# code as closely as possible. Once I start refactoring, you&apos;ll see some more idiomatic implementations.
    &lt;/p&gt;
    &lt;h3 id=&quot;8192c1e94add4e56b95dad78d4eda818&quot;&gt;
        Conclusion &lt;a href=&quot;#8192c1e94add4e56b95dad78d4eda818&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Together with the previous two articles in this article series, this establishes a baseline from which I can refactor the code. While we might consider the original C# code idiomatic, this port to Haskell isn&apos;t. It is, on the other hand, similar enough to both its C# and F# peers that we can compare and contrast all three.
    &lt;/p&gt;
    &lt;p&gt;
        Particularly two design choices make this Haskell implementation less than idiomatic. One is the use of &lt;code&gt;IORef&lt;/code&gt; to update a list of songs. The other is using a type class to model an external dependency.
    &lt;/p&gt;
    &lt;p&gt;
        As I cover various alternative architectures in this article series, you&apos;ll see how to get rid of both.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2025/04/28/song-recommendations-as-an-impureim-sandwich&quot;&gt;Song recommendations as an Impureim Sandwich&lt;/a&gt;.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2025/04/21/porting-song-recommendations-to-haskell</guid>
      </item>
    
      <item>
        <title>Porting song recommendations to F#</title>
        <link>https://blog.ploeh.dk/2025/04/14/porting-song-recommendations-to-f/</link>
        <pubDate>Mon, 14 Apr 2025 08:54:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;A C# code base translated to F#.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This article is part of a &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;larger article series&lt;/a&gt; that examines variations of how to take on a non-trivial problem using &lt;a href=&quot;/2018/11/19/functional-architecture-a-definition&quot;&gt;functional architecture&lt;/a&gt;. In the &lt;a href=&quot;/2025/04/10/characterising-song-recommendations&quot;&gt;previous article&lt;/a&gt; we established a baseline C# code base. Future articles are going to use that C# code base as a starting point for refactored code. On the other hand, I also want to demonstrate what such solutions may look like in languages like &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt; or &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt;. In this article, you&apos;ll see how to port the C# baseline to F#.
    &lt;/p&gt;
    &lt;p&gt;
        The code shown in this article is from the &lt;em&gt;fsharp-port&lt;/em&gt; branch of the accompanying Git repository.
    &lt;/p&gt;
    &lt;h3 id=&quot;075d8dc2f6ad4baca4f815137193f814&quot;&gt;
        Data structures &lt;a href=&quot;#075d8dc2f6ad4baca4f815137193f814&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        We may start by defining the required data structures. All are going to be &lt;a href=&quot;https://learn.microsoft.com/dotnet/fsharp/language-reference/records&quot;&gt;records&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;type&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;User&lt;/span&gt;&amp;nbsp;=&amp;nbsp;{&amp;nbsp;UserName&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;string&lt;/span&gt;;&amp;nbsp;TotalScrobbleCount&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;int&lt;/span&gt;&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Just like the equivalent C# code, a &lt;code&gt;User&lt;/code&gt; is just a &lt;code&gt;string&lt;/code&gt; and an &lt;code&gt;int&lt;/code&gt;. 
    &lt;/p&gt;
    &lt;p&gt;
        When creating new values, record syntax can sometimes be awkward, so I also define a curried function to create &lt;code&gt;User&lt;/code&gt; values:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;user&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;totalScrobbleCount&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{&amp;nbsp;UserName&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;;&amp;nbsp;TotalScrobbleCount&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;totalScrobbleCount&lt;/span&gt;&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Likewise, I define &lt;code&gt;Song&lt;/code&gt; and &lt;code&gt;Scrobble&lt;/code&gt; in the same way:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;type&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;&amp;nbsp;=&amp;nbsp;{&amp;nbsp;Id&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;int&lt;/span&gt;;&amp;nbsp;IsVerifiedArtist&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;bool&lt;/span&gt;;&amp;nbsp;Rating&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;byte&lt;/span&gt;&amp;nbsp;}
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;song&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;isVerfiedArtist&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rating&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{&amp;nbsp;Id&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;id&lt;/span&gt;;&amp;nbsp;IsVerifiedArtist&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;isVerfiedArtist&lt;/span&gt;;&amp;nbsp;Rating&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;rating&lt;/span&gt;&amp;nbsp;}
 
&lt;span style=&quot;color:blue;&quot;&gt;type&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Scrobble&lt;/span&gt;&amp;nbsp;=&amp;nbsp;{&amp;nbsp;Song&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;;&amp;nbsp;ScrobbleCount&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;int&lt;/span&gt;&amp;nbsp;}
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;scrobble&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;song&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbleCount&lt;/span&gt;&amp;nbsp;=&amp;nbsp;{&amp;nbsp;Song&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;song&lt;/span&gt;;&amp;nbsp;ScrobbleCount&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbleCount&lt;/span&gt;&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        To be honest, I only use those curried functions sparingly, so they&apos;re somewhat redundant. Perhaps I should consider getting rid of them. For now, however, they stay.
    &lt;/p&gt;
    &lt;p&gt;
        Since I&apos;m moving all the code to F#, I also have to translate the interface.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;type&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SongService&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;abstract&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopListenersAsync&lt;/span&gt;&amp;nbsp;:&amp;nbsp;songId&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;int&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;User&lt;/span&gt;&amp;gt;&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;abstract&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopScrobblesAsync&lt;/span&gt;&amp;nbsp;:&amp;nbsp;userName&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;string&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;Scrobble&lt;/span&gt;&amp;gt;&amp;gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The syntax is different from C#, but otherwise, this is the same interface.
    &lt;/p&gt;
    &lt;h3 id=&quot;4102e5ed7f394f48ac28f4b4a8af55e8&quot;&gt;
        Implementation &lt;a href=&quot;#4102e5ed7f394f48ac28f4b4a8af55e8&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        Those are all the supporting types required to implement the &lt;code&gt;RecommendationsProvider&lt;/code&gt;. This is the most direct translation of the C# code that I could think of:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;type&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RecommendationsProvider&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songService&lt;/span&gt;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SongService&lt;/span&gt;)&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;member&lt;/span&gt;&amp;nbsp;_.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetRecommendationsAsync&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;task&lt;/span&gt;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;1.&amp;nbsp;Get&amp;nbsp;user&amp;#39;s&amp;nbsp;own&amp;nbsp;top&amp;nbsp;scrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;2.&amp;nbsp;Get&amp;nbsp;other&amp;nbsp;users&amp;nbsp;who&amp;nbsp;listened&amp;nbsp;to&amp;nbsp;the&amp;nbsp;same&amp;nbsp;songs&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;3.&amp;nbsp;Get&amp;nbsp;top&amp;nbsp;scrobbles&amp;nbsp;of&amp;nbsp;those&amp;nbsp;users&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;4.&amp;nbsp;Aggregate&amp;nbsp;the&amp;nbsp;songs&amp;nbsp;into&amp;nbsp;recommendations&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songService&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopScrobblesAsync&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobblesSnapshot&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.ScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;100
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;toList&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ResizeArray&lt;/span&gt;&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobble&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobblesSnapshot&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListeners&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songService&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopListenersAsync&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobble&lt;/span&gt;.Song.Id
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListenersSnapshot&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListeners&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.TotalScrobbleCount&amp;nbsp;&amp;gt;=&amp;nbsp;10_000)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;u&lt;/span&gt;.TotalScrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;20
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;toList&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;for&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListener&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListenersSnapshot&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;do&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Impure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobbles&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songService&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopScrobblesAsync&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherListener&lt;/span&gt;.UserName
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobblesSnapshot&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobbles&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song.IsVerifiedArtist)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song.Rating)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;10
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;toList&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;otherScrobblesSnapshot&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;List&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;map&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Song)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddRange&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Pure&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendations&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendationCandidates&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sortByDescending&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;s&lt;/span&gt;.Rating)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;truncate&lt;/span&gt;&amp;nbsp;200
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;toList&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;:&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;IReadOnlyCollection&lt;/span&gt;&amp;lt;_&amp;gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;recommendations&lt;/span&gt;&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        As you can tell, I&apos;ve kept the comments from &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle&quot;&gt;the original&lt;/a&gt;, too.
    &lt;/p&gt;
    &lt;h3 id=&quot;efa00ed5a67641e18b6fec772f2e6aa7&quot;&gt;
        Test Double &lt;a href=&quot;#efa00ed5a67641e18b6fec772f2e6aa7&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        In &lt;a href=&quot;/2025/04/10/characterising-song-recommendations&quot;&gt;the previous article&lt;/a&gt;, I&apos;d written the &lt;a href=&quot;http://xunitpatterns.com/Fake%20Object.html&quot;&gt;Fake&lt;/a&gt; &lt;code&gt;SongService&lt;/code&gt; in C#. Since, in this article, I&apos;m translating everything to F#, I need to translate the Fake, too.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;type&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;FakeSongService&lt;/span&gt;&amp;nbsp;()&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songs&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ConcurrentDictionary&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;&amp;gt;&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;users&lt;/span&gt;&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ConcurrentDictionary&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ConcurrentDictionary&lt;/span&gt;&amp;lt;&lt;span style=&quot;color:#2b91af;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;()
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;interface&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SongService&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;with&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;member&lt;/span&gt;&amp;nbsp;_.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopListenersAsync&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songId&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;listeners&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;users&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;filter&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;kvp&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;kvp&lt;/span&gt;.Value.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;ContainsKey&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songId&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;map&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;kvp&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;user&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;kvp&lt;/span&gt;.Key&amp;nbsp;(&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;sum&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;kvp&lt;/span&gt;.Value.Values))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;toList&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;FromResult&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;listeners&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;member&lt;/span&gt;&amp;nbsp;_.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetTopScrobblesAsync&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;users&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;GetOrAdd&lt;/span&gt;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ConcurrentDictionary&lt;/span&gt;&amp;lt;_,&amp;nbsp;_&amp;gt;&amp;nbsp;())
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;map&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;kvp&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;scrobble&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songs&lt;/span&gt;[&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;kvp&lt;/span&gt;.Key]&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;kvp&lt;/span&gt;.Value)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Seq&lt;/span&gt;.&lt;span style=&quot;color:#74531f;&quot;&gt;toList&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Task&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;FromResult&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;member&lt;/span&gt;&amp;nbsp;_.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Scrobble&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;song&lt;/span&gt;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbleCount&lt;/span&gt;)&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;addScrobbles&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;&amp;nbsp;:&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ConcurrentDictionary&lt;/span&gt;&amp;lt;_,&amp;nbsp;_&amp;gt;)&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddOrUpdate&lt;/span&gt;&amp;nbsp;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;song&lt;/span&gt;.Id,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbleCount&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;_&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;oldCount&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;oldCount&lt;/span&gt;&amp;nbsp;+&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbleCount&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;ignore&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;users&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddOrUpdate&lt;/span&gt;&amp;nbsp;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;userName&lt;/span&gt;,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;ConcurrentDictionary&lt;/span&gt;&amp;lt;_,&amp;nbsp;_&amp;gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;[&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;KeyValuePair&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;Create&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;song&lt;/span&gt;.Id,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbleCount&lt;/span&gt;)&amp;nbsp;],
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;_&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;addScrobbles&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;scrobbles&lt;/span&gt;)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;ignore&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;songs&lt;/span&gt;.&lt;span style=&quot;font-weight:bold;color:#74531f;&quot;&gt;AddOrUpdate&lt;/span&gt;&amp;nbsp;(&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;song&lt;/span&gt;.Id,&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;song&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;_&amp;nbsp;_&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;font-weight:bold;color:#1f377f;&quot;&gt;song&lt;/span&gt;)&amp;nbsp;|&amp;gt;&amp;nbsp;&lt;span style=&quot;color:#74531f;&quot;&gt;ignore&lt;/span&gt;&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Apart from the code shown here, only minor changes were required for the tests, such as using those curried creation functions instead of constructors, a cast to &lt;code&gt;SongService&lt;/code&gt;, and a few other non-behavioural things like that. All tests still pass, so I consider this a faithful translation of the C# code base.
    &lt;/p&gt;
    &lt;h3 id=&quot;28c7110824e941098e791aa66e2ed5c4&quot;&gt;
        Conclusion &lt;a href=&quot;#28c7110824e941098e791aa66e2ed5c4&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        This article does more groundwork. Since it may be illuminating to see one problem represented in more than one programming language, I present it in both C#, F#, and Haskell. The next article does exactly that: Translates this F# code to Haskell. Once all three bases are established, we can start introducing solution variations.
    &lt;/p&gt;
    &lt;p&gt;
        If you don&apos;t care about the Haskell examples, you can always go back to the &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;first article in this article series&lt;/a&gt; and use the table of contents to jump to the next C# example.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2025/04/21/porting-song-recommendations-to-haskell&quot;&gt;Porting song recommendations to Haskell&lt;/a&gt;.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2025/04/14/porting-song-recommendations-to-f</guid>
      </item>
    
      <item>
        <title>Characterising song recommendations</title>
        <link>https://blog.ploeh.dk/2025/04/10/characterising-song-recommendations/</link>
        <pubDate>Thu, 10 Apr 2025 08:05:00 UTC</pubDate>
        <description>


&lt;div id=&quot;post&quot;&gt;
    &lt;p&gt;
        &lt;em&gt;Using characterisation tests and mutation testing to describe existing behaviour. An example.&lt;/em&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This article is part of an &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;article series that presents multiple design alternatives&lt;/a&gt; for a given problem that I call the &lt;em&gt;song recommendations&lt;/em&gt; problem. In short, the problem is to recommend songs to a user based on a vast repository of scrobbles. The problem was &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle&quot;&gt;originally proposed&lt;/a&gt; by &lt;a href=&quot;https://tyrrrz.me/&quot;&gt;Oleksii Holub&lt;/a&gt; as a an example of a problem that may not be a good fit for functional programming (FP).
    &lt;/p&gt;
    &lt;p&gt;
        As I&apos;ve outlined in the &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;introductory article&lt;/a&gt;, I&apos;d like to use the opportunity to demonstrate alternative FP designs. Before I can do that, however, I need a working example of Oleksii Holub&apos;s code example, as well as a trustworthy test suite. That&apos;s what this article is about.
    &lt;/p&gt;
    &lt;p&gt;
        The code in this article mostly come from the &lt;code&gt;master&lt;/code&gt; branch of the .NET repository that accompanies this article series, although some of the code is taken from intermediate commits on that branch.
    &lt;/p&gt;
    &lt;h3 id=&quot;28085f8e8de44964823dfc4b13edcca6&quot;&gt;
        Inferred details &lt;a href=&quot;#28085f8e8de44964823dfc4b13edcca6&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle&quot;&gt;original article&lt;/a&gt; only shows code, but doesn&apos;t link to an existing code base. While I suppose I could have asked Oleksii Holub if he had a copy he would share, the existence of such a code base isn&apos;t a given. In any case, inferring an entire code base from a comprehensive snippet is an interesting exercise in its own right.
    &lt;/p&gt;
    &lt;p&gt;
        The first step was to copy the example code into a code base. Initially it didn&apos;t compile because of some missing dependencies that I had to infer. It was only three &lt;a href=&quot;https://en.wikipedia.org/wiki/Value_object&quot;&gt;Value Objects&lt;/a&gt; and an interface:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Song&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;Id,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;bool&lt;/span&gt;&amp;nbsp;IsVerifiedArtist,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;byte&lt;/span&gt;&amp;nbsp;Rating);

&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;Scrobble&lt;/span&gt;(Song&amp;nbsp;Song,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;ScrobbleCount);

&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;record&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;User&lt;/span&gt;(&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;UserName,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;TotalScrobbleCount);

&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;interface&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;SongService&lt;/span&gt;
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Task&amp;lt;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;&amp;nbsp;GetTopListenersAsync(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;songId);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Task&amp;lt;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;&amp;nbsp;GetTopScrobblesAsync(&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;userName);
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        These type declarations are straightforward, but still warrant a few comments. First, &lt;code&gt;Song&lt;/code&gt;, &lt;code&gt;Scrobble&lt;/code&gt;, and &lt;code&gt;User&lt;/code&gt; are C# &lt;a href=&quot;https://learn.microsoft.com/dotnet/csharp/language-reference/builtin-types/record&quot;&gt;records&lt;/a&gt;, which is a more recent addition to the language. If you&apos;re reading along here, but using another C-based language, or an older version of C#, you can implement such immutable Value Objects with normal language constructs; it just takes more code, instead of the one-liner syntax. &lt;a href=&quot;https://fsharp.org/&quot;&gt;F#&lt;/a&gt; developers will, of course, be familiar with the concept of &lt;a href=&quot;https://learn.microsoft.com/dotnet/fsharp/language-reference/records&quot;&gt;records&lt;/a&gt;, and &lt;a href=&quot;https://www.haskell.org/&quot;&gt;Haskell&lt;/a&gt; also has them.
    &lt;/p&gt;
    &lt;p&gt;
        Another remark about the above type declarations is that while &lt;code&gt;SongService&lt;/code&gt; is an interface, it has no &lt;code&gt;I&lt;/code&gt; prefix. This is syntactically legal, but not &lt;a href=&quot;/2015/08/03/idiomatic-or-idiosyncratic&quot;&gt;idiomatic&lt;/a&gt; in C#. I&apos;ve used the name from &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle#interleaved-impurities&quot;&gt;the original code sample&lt;/a&gt; verbatim, so that&apos;s the immediate explanation. It&apos;s possible that Oleksii Holub intended the type to be a base class, but for various reasons I prefer interfaces, although in this particular example I don&apos;t think it would have made much of a difference. I&apos;m only pointing it out because there&apos;s a risk that it might confuse some readers who are used to the C# naming convention. Java programmers, on the other hand, should feel at home.
    &lt;/p&gt;
    &lt;p&gt;
        As far as I remember, the only other change I had to make to the code in order to make it compile was to give the &lt;code&gt;RecommendationsProvider&lt;/code&gt; class a constructor:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;RecommendationsProvider&lt;/span&gt;(SongService&amp;nbsp;songService)
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;_songService&amp;nbsp;=&amp;nbsp;songService;
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This is just basic Constructor Injection, and while &lt;a href=&quot;/2021/05/17/against-consistency&quot;&gt;I find the underscore prefix redundant&lt;/a&gt;, I&apos;ve kept it in order to stay as faithful to the original example as possible.
    &lt;/p&gt;
    &lt;p&gt;
        At this point the code compiles.
    &lt;/p&gt;
    &lt;h3 id=&quot;fb05d3091d2c449ab151b60b2ff5b606&quot;&gt;
        Test Double &lt;a href=&quot;#fb05d3091d2c449ab151b60b2ff5b606&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The goal of this article series is to present several alternative designs that implement the same behaviour. This means that as I refactor the code, I need to know that I didn&apos;t break existing functionality.
    &lt;/p&gt;
    &lt;blockquote&gt;
        &lt;p&gt;
            &quot;to refactor, the essential precondition is [...] solid tests&quot;
        &lt;/p&gt;
        &lt;footer&gt;&lt;cite&gt;&lt;a href=&quot;/ref/refactoring&quot;&gt;Refactoring&lt;/a&gt;&lt;/cite&gt;, Martin Fowler, 1999&lt;/footer&gt;
    &lt;/blockquote&gt;
    &lt;p&gt;
        Currently, I have no tests, so I&apos;ll have to add some. Since &lt;code&gt;RecommendationsProvider&lt;/code&gt; makes heavy use of its injected &lt;code&gt;SongService&lt;/code&gt;, tests must supply that dependency in order to do meaningful work. Since &lt;a href=&quot;/2022/10/17/stubs-and-mocks-break-encapsulation&quot;&gt;Stubs and Mocks break encapsulation&lt;/a&gt; I instead &lt;a href=&quot;/2019/02/18/from-interaction-based-to-state-based-testing&quot;&gt;favour state-based testing&lt;/a&gt; with &lt;a href=&quot;http://xunitpatterns.com/Fake%20Object.html&quot;&gt;Fake Objects&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        After some experimentation, I arrived at this &lt;code&gt;FakeSongService&lt;/code&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;sealed&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;class&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;FakeSongService&lt;/span&gt;&amp;nbsp;:&amp;nbsp;SongService
{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;readonly&lt;/span&gt;&amp;nbsp;ConcurrentDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;Song&amp;gt;&amp;nbsp;songs;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;readonly&lt;/span&gt;&amp;nbsp;ConcurrentDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;ConcurrentDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;&amp;nbsp;users;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:#2b91af;&quot;&gt;FakeSongService&lt;/span&gt;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;songs&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;ConcurrentDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;Song&amp;gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;users&amp;nbsp;=&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;ConcurrentDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;,&amp;nbsp;ConcurrentDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;();
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;Task&amp;lt;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;&amp;nbsp;GetTopListenersAsync(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;songId)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;listeners&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;from&lt;/span&gt;&amp;nbsp;kvp&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;in&lt;/span&gt;&amp;nbsp;users
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;where&lt;/span&gt;&amp;nbsp;kvp.Value.ContainsKey(songId)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;select&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;User(kvp.Key,&amp;nbsp;kvp.Value.Values.Sum());
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;Task.FromResult&amp;lt;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;(listeners.ToList());
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;Task&amp;lt;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;&amp;nbsp;GetTopScrobblesAsync(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;userName)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;var&lt;/span&gt;&amp;nbsp;scrobbles&amp;nbsp;=&amp;nbsp;users
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.GetOrAdd(userName,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;ConcurrentDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;())
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;.Select(kvp&amp;nbsp;=&amp;gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;Scrobble(songs[kvp.Key],&amp;nbsp;kvp.Value));
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;Task.FromResult&amp;lt;IReadOnlyCollection&amp;lt;Scrobble&amp;gt;&amp;gt;(scrobbles.ToList());
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;public&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;void&lt;/span&gt;&amp;nbsp;Scrobble(&lt;span style=&quot;color:blue;&quot;&gt;string&lt;/span&gt;&amp;nbsp;userName,&amp;nbsp;Song&amp;nbsp;song,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;scrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;users.AddOrUpdate(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;userName,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;&amp;nbsp;ConcurrentDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;new&lt;/span&gt;[]&amp;nbsp;{&amp;nbsp;KeyValuePair.Create(song.Id,&amp;nbsp;scrobbleCount)&amp;nbsp;}),
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(_,&amp;nbsp;scrobbles)&amp;nbsp;=&amp;gt;&amp;nbsp;AddScrobbles(scrobbles,&amp;nbsp;song,&amp;nbsp;scrobbleCount));
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;songs.AddOrUpdate(song.Id,&amp;nbsp;song,&amp;nbsp;(_,&amp;nbsp;_)&amp;nbsp;=&amp;gt;&amp;nbsp;song);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;private&lt;/span&gt;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;static&lt;/span&gt;&amp;nbsp;ConcurrentDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;nbsp;AddScrobbles(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ConcurrentDictionary&amp;lt;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;nbsp;scrobbles,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Song&amp;nbsp;song,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;scrobbleCount)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;scrobbles.AddOrUpdate(
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;song.Id,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;scrobbleCount,
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(_,&amp;nbsp;oldCount)&amp;nbsp;=&amp;gt;&amp;nbsp;oldCount&amp;nbsp;+&amp;nbsp;scrobbleCount);
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;scrobbles;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        If you&apos;re wondering about the use of concurrent dictionaries, I use them because it made it easier to write the implementation, and not because I need the implementation to be thread-safe. In fact, I&apos;m fairly sure that it&apos;s not thread-safe. That&apos;s not an issue. The tests aren&apos;t going to use shared mutable state.
    &lt;/p&gt;
    &lt;p&gt;
        The &lt;code&gt;GetTopListenersAsync&lt;/code&gt; and &lt;code&gt;GetTopScrobblesAsync&lt;/code&gt; methods implement the interface, and the &lt;code&gt;Scrobble&lt;/code&gt; method (here, &lt;em&gt;scrobble&lt;/em&gt; is a verb: &lt;em&gt;to scrobble&lt;/em&gt;) is a &lt;a href=&quot;http://xunitpatterns.com/Back%20Door%20Manipulation.html&quot;&gt;back door&lt;/a&gt; that enables tests to populate the &lt;code&gt;FakeSongService&lt;/code&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;4055e47cf8a5409db41c95bb8099cae6&quot;&gt;
        Icebreaker Test &lt;a href=&quot;#4055e47cf8a5409db41c95bb8099cae6&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        While the &apos;production code&apos; is in C#, I decided to write the tests in F# for two reasons.
    &lt;/p&gt;
    &lt;p&gt;
        The first reason was that I wanted to be able to present the various FP designs in both C# and F#. Writing the tests in F# would make it easier to replace the C# code base with an F# alternative.
    &lt;/p&gt;
    &lt;p&gt;
        The second reason was that I wanted to leverage a property-based testing framework&apos;s ability to produce many randomly-generated test cases. I considered this important to build confidence that my tests weren&apos;t just a few specific examples that wouldn&apos;t catch errors when I made changes. Since the &lt;code&gt;RecommendationsProvider&lt;/code&gt; API is asynchronous, the only .NET property-based framework I knew of that can run &lt;code&gt;Task&lt;/code&gt;-valued properties is &lt;a href=&quot;https://fscheck.github.io/FsCheck/&quot;&gt;FsCheck&lt;/a&gt;. While it&apos;s possible to use FsCheck from C#, the F# API is more powerful.
    &lt;/p&gt;
    &lt;p&gt;
        In order to get started, however, I first wrote an Icebreaker Test without FsCheck:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&amp;lt;Fact&amp;gt;]
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;``No&amp;nbsp;data``&amp;nbsp;()&amp;nbsp;=&amp;nbsp;task&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;srvc&amp;nbsp;=&amp;nbsp;FakeSongService&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;sut&amp;nbsp;=&amp;nbsp;RecommendationsProvider&amp;nbsp;srvc
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;actual&amp;nbsp;=&amp;nbsp;sut.GetRecommendationsAsync&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Assert.Empty&amp;nbsp;actual&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This is both a trivial case and an edge case, but clearly, if there&apos;s no data in the &lt;code&gt;SongService&lt;/code&gt;, the &lt;code&gt;RecommendationsProvider&lt;/code&gt; can&apos;t recommend any songs.
    &lt;/p&gt;
    &lt;p&gt;
        As I usually do with &lt;a href=&quot;https://en.wikipedia.org/wiki/Characterization_test&quot;&gt;Characterisation Tests&lt;/a&gt;, I temporarily sabotage the System Under Test so that the test fails. This is to ensure that I didn&apos;t write a &lt;a href=&quot;/2019/10/14/tautological-assertion&quot;&gt;tautological assertion&lt;/a&gt;. Once I&apos;ve &lt;a href=&quot;/2019/10/21/a-red-green-refactor-checklist&quot;&gt;seen the test fail for the appropriate reason&lt;/a&gt;, I undo the sabotage and &lt;a href=&quot;https://stackoverflow.blog/2022/12/19/use-git-tactically/&quot;&gt;check in the code&lt;/a&gt;.
    &lt;/p&gt;
    &lt;h3 id=&quot;cf9aa5f1f470468da943f1c8bbd98698&quot;&gt;
        Refactor to property &lt;a href=&quot;#cf9aa5f1f470468da943f1c8bbd98698&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        In the above &lt;code&gt;No data&lt;/code&gt; test, the specific input value &lt;code&gt;&quot;foo&quot;&lt;/code&gt; is irrelevant. It might as well have been any other string, so why not make it a property?
    &lt;/p&gt;
    &lt;p&gt;
        In this particular case, the &lt;code&gt;userName&lt;/code&gt; could be any string, but it might be appropriate to write a custom generator that produces &apos;realistic&apos; user names. Just to make things simple, I&apos;m going to assume that user names are between one and twenty characters and assembled from alphanumeric characters, and that the fist character must be a letter:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;module&lt;/span&gt;&amp;nbsp;Gen&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;alphaNumeric&amp;nbsp;=&amp;nbsp;Gen.elements&amp;nbsp;([&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;a&amp;#39;&lt;/span&gt;..&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;z&amp;#39;&lt;/span&gt;]&amp;nbsp;@&amp;nbsp;[&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;A&amp;#39;&lt;/span&gt;..&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;Z&amp;#39;&lt;/span&gt;]&amp;nbsp;@&amp;nbsp;[&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;..&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;9&amp;#39;&lt;/span&gt;])
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;userName&amp;nbsp;=&amp;nbsp;gen&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;length&amp;nbsp;=&amp;nbsp;Gen.choose&amp;nbsp;(1,&amp;nbsp;19)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;firstLetter&amp;nbsp;=&amp;nbsp;Gen.elements&amp;nbsp;&amp;lt;|&amp;nbsp;[&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;a&amp;#39;&lt;/span&gt;..&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;z&amp;#39;&lt;/span&gt;]&amp;nbsp;@&amp;nbsp;[&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;A&amp;#39;&lt;/span&gt;..&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;#39;Z&amp;#39;&lt;/span&gt;]
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;rest&amp;nbsp;=&amp;nbsp;alphaNumeric&amp;nbsp;|&amp;gt;&amp;nbsp;Gen.listOfLength&amp;nbsp;length
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;firstLetter&amp;nbsp;::&amp;nbsp;rest&amp;nbsp;|&amp;gt;&amp;nbsp;List.toArray&amp;nbsp;|&amp;gt;&amp;nbsp;String&amp;nbsp;}&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        Strictly speaking, as long as user names are distinct, the code ought to work, so this generator may be more conservative than necessary. Why am I constraining the generator? For two reasons: First, when FsCheck finds a counter-example, it displays the values that caused the property to fail. A twenty-character alphanumeric string is easier to relate to than some arbitrary string with line breaks and unprintable characters. The second reason is that I&apos;m later going to measure memory load for some of the alternatives, and I wanted data to have realistic size. If user names are chosen by humans, they&apos;re unlikely to be longer than twenty characters on average (I&apos;ve decided).
    &lt;/p&gt;
    &lt;p&gt;
        I can now rewrite the above &lt;code&gt;No data&lt;/code&gt; test as an FsCheck property:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&amp;lt;Property&amp;gt;]
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;``No&amp;nbsp;data``&amp;nbsp;()&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Gen.userName&amp;nbsp;|&amp;gt;&amp;nbsp;Arb.fromGen&amp;nbsp;|&amp;gt;&amp;nbsp;Prop.forAll&amp;nbsp;&amp;lt;|&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;userName&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;task&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;srvc&amp;nbsp;=&amp;nbsp;FakeSongService&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;sut&amp;nbsp;=&amp;nbsp;RecommendationsProvider&amp;nbsp;srvc
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;actual&amp;nbsp;=&amp;nbsp;sut.GetRecommendationsAsync&amp;nbsp;userName
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Assert.Empty&amp;nbsp;actual&amp;nbsp;}&amp;nbsp;:&amp;gt;&amp;nbsp;Task&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        You may think that this is overkill just to be able to supply random user names to the &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; method. In isolation, I&apos;d be inclined to agree, but this edit was an occasion to get my FsCheck infrastructure in place. I can now use that to add more properties.
    &lt;/p&gt;
    &lt;h3 id=&quot;ea6e29adf0a9458e98309a0f66394b32&quot;&gt;
        Full coverage &lt;a href=&quot;#ea6e29adf0a9458e98309a0f66394b32&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        The cyclomatic complexity of the &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; method is only &lt;em&gt;3&lt;/em&gt;, so it doesn&apos;t require many tests to attain full code coverage. &lt;a href=&quot;/2015/11/16/code-coverage-is-a-useless-target-measure&quot;&gt;Not that 100% code coverage should be a goal in itself&lt;/a&gt;, but when adding tests to an untested code base, it can be useful as an indicator of confidence. Despite its low cyclomatic complexity, the method, with all of its filtering and sorting, is actually quite involved. 100% coverage strikes me as a low bar.
    &lt;/p&gt;
    &lt;p&gt;
        The above &lt;code&gt;No data&lt;/code&gt; test exercises one of the three branches. &lt;a href=&quot;/2019/12/09/put-cyclomatic-complexity-to-good-use&quot;&gt;At most two more tests are required&lt;/a&gt; to attain full coverage. I&apos;ll just show the simplest of them here.
    &lt;/p&gt;
    &lt;p&gt;
        The next test case requires a new FsCheck generator, in addition to &lt;code&gt;Gen.userName&lt;/code&gt; already shown.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;song&amp;nbsp;=&amp;nbsp;ArbMap.generate&amp;nbsp;ArbMap.defaults&amp;nbsp;|&amp;gt;&amp;nbsp;Gen.map&amp;nbsp;Song&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        As a fairly simple one-liner, this seems close to the &lt;a href=&quot;https://wiki.haskell.org/Fairbairn_threshold&quot;&gt;Fairbairn threshold&lt;/a&gt;, but I think that giving this generator a name makes the test easier to read.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&amp;lt;Property&amp;gt;]
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;``One&amp;nbsp;user,&amp;nbsp;some&amp;nbsp;songs``&amp;nbsp;()&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;gen&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;user&amp;nbsp;=&amp;nbsp;Gen.userName
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;songs&amp;nbsp;=&amp;nbsp;Gen.arrayOf&amp;nbsp;Gen.song
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;scrobbleCounts&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Gen.choose&amp;nbsp;(1,&amp;nbsp;100)&amp;nbsp;|&amp;gt;&amp;nbsp;Gen.arrayOfLength&amp;nbsp;songs.Length
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;return&lt;/span&gt;&amp;nbsp;(user,&amp;nbsp;Array.zip&amp;nbsp;songs&amp;nbsp;scrobbleCounts)&amp;nbsp;}
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;|&amp;gt;&amp;nbsp;Arb.fromGen&amp;nbsp;|&amp;gt;&amp;nbsp;Prop.forAll&amp;nbsp;&amp;lt;|&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;(user,&amp;nbsp;scrobbles)&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;task&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;srvc&amp;nbsp;=&amp;nbsp;FakeSongService&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;scrobbles&amp;nbsp;|&amp;gt;&amp;nbsp;Array.iter&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;(s,&amp;nbsp;c)&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;srvc.Scrobble&amp;nbsp;(user,&amp;nbsp;s,&amp;nbsp;c))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;sut&amp;nbsp;=&amp;nbsp;RecommendationsProvider&amp;nbsp;srvc
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;actual&amp;nbsp;=&amp;nbsp;sut.GetRecommendationsAsync&amp;nbsp;user
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Assert.Empty&amp;nbsp;actual&amp;nbsp;}&amp;nbsp;:&amp;gt;&amp;nbsp;Task&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This test creates scrobbles for a single user and adds them to the Fake data store. It uses &lt;a href=&quot;/2016/05/17/tie-fighter-fscheck-properties&quot;&gt;TIE-fighter syntax&lt;/a&gt; to connect the generators to the test body. 
    &lt;/p&gt;
    &lt;p&gt;
        Since all the scrobble counts are generated between &lt;em&gt;1&lt;/em&gt; and &lt;em&gt;100&lt;/em&gt;, none of them are greater than or equal to &lt;em&gt;10,000&lt;/em&gt; and thus the test expects no recommendations.
    &lt;/p&gt;
    &lt;p&gt;
        You may think that I&apos;m cheating - after all, why didn&apos;t I choose another range for the scrobble count? To be honest, I was still in an exploratory phase, trying to figure out how to express the tests, and as a first step, I was aiming for full code coverage. Even though this test&apos;s assertion is weak, it &lt;em&gt;does&lt;/em&gt; exercise another branch of the &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; method.
    &lt;/p&gt;
    &lt;p&gt;
        I had to write only one more test to fully cover the System Under Test. That method is more complicated, so I&apos;ll spare you the details. If you&apos;re interested, you may consider consulting the example source code repository.
    &lt;/p&gt;
    &lt;h3 id=&quot;1fcf0b78bfa94dd8b1b3cd1810068dc8&quot;&gt;
        Mutation testing &lt;a href=&quot;#1fcf0b78bfa94dd8b1b3cd1810068dc8&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        While I don&apos;t think that code coverage is useful as a &lt;em&gt;target&lt;/em&gt; measure, it can be illuminating as a tool. In this case, knowing that I&apos;ve now attained full coverage tells me that I need to resort to other techniques if I want another goal to aim for.
    &lt;/p&gt;
    &lt;p&gt;
        I chose &lt;a href=&quot;https://en.wikipedia.org/wiki/Mutation_testing&quot;&gt;mutation testing&lt;/a&gt; as my new technique. The &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; method makes heavy use of LINQ methods such as &lt;code&gt;OrderByDescending&lt;/code&gt;, &lt;code&gt;Take&lt;/code&gt;, and &lt;code&gt;Where&lt;/code&gt;. &lt;a href=&quot;https://stryker-mutator.io/&quot;&gt;Stryker&lt;/a&gt; for .NET knows about LINQ, so among all the automated sabotage is does, it tries to see what happens if it removes e.g. &lt;code&gt;Where&lt;/code&gt; or &lt;code&gt;Take&lt;/code&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Although I find the Stryker jargon childish, I set myself the goal to see if I could &apos;kill mutants&apos; to a degree that I&apos;d at least get a green rating.
    &lt;/p&gt;
    &lt;p&gt;
        I found that I could edge closer to that goal by a combination of appending assertions (thus &lt;a href=&quot;/2021/12/13/backwards-compatibility-as-a-profunctor&quot;&gt;strengthening postconditions&lt;/a&gt;) and adding tests. While I sometimes find it &lt;a href=&quot;/2021/02/15/when-properties-are-easier-than-examples&quot;&gt;easier to define properties than examples&lt;/a&gt;, at other times, it&apos;s the other way around. In this case, I found it easier to add single examples, like this one:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&amp;lt;Fact&amp;gt;]
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;``One&amp;nbsp;verified&amp;nbsp;recommendation``&amp;nbsp;()&amp;nbsp;=&amp;nbsp;task&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;srvc&amp;nbsp;=&amp;nbsp;FakeSongService&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;srvc.Scrobble&amp;nbsp;(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;cat&amp;quot;&lt;/span&gt;,&amp;nbsp;Song&amp;nbsp;(1,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;,&amp;nbsp;6uy),&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;10)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;srvc.Scrobble&amp;nbsp;(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;ana&amp;quot;&lt;/span&gt;,&amp;nbsp;Song&amp;nbsp;(1,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;false&lt;/span&gt;,&amp;nbsp;5uy),&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;10)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;srvc.Scrobble&amp;nbsp;(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;ana&amp;quot;&lt;/span&gt;,&amp;nbsp;Song&amp;nbsp;(2,&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;true&lt;/span&gt;,&amp;nbsp;5uy),&amp;nbsp;9_9990)
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;sut&amp;nbsp;=&amp;nbsp;RecommendationsProvider&amp;nbsp;srvc
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;actual&amp;nbsp;=&amp;nbsp;sut.GetRecommendationsAsync&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;cat&amp;quot;&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Assert.Equal&amp;lt;Song&amp;gt;&amp;nbsp;([&amp;nbsp;Song&amp;nbsp;(2,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;true&lt;/span&gt;,&amp;nbsp;5uy)&amp;nbsp;],&amp;nbsp;actual)&amp;nbsp;}&amp;nbsp;:&amp;gt;&amp;nbsp;Task&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        It adds three scrobbles to the data store, but only one of them is verified (which is what the &lt;code&gt;true&lt;/code&gt; value indicates), so this is the only recommendation the test expects to see.
    &lt;/p&gt;
    &lt;p&gt;
        Notice that although song number &lt;code&gt;2&lt;/code&gt; &apos;only&apos; has &lt;em&gt;9,9990&lt;/em&gt; plays, the user &lt;em&gt;ana&lt;/em&gt; has exactly &lt;em&gt;10,000&lt;/em&gt; plays in all, so barely makes the cut. By carefully adding five examples like this one, I was able to &apos;kill all mutants&apos;.
    &lt;/p&gt;
    &lt;p&gt;
        In all, I have eight tests; three FsCheck properties and five normal &lt;a href=&quot;https://xunit.net/&quot;&gt;xUnit.net&lt;/a&gt; &lt;em&gt;facts&lt;/em&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        All tests work exclusively by supplying direct and &lt;a href=&quot;http://xunitpatterns.com/indirect%20input.html&quot;&gt;indirect input&lt;/a&gt; to the System Under Test (SUT), and verify the return value of &lt;code&gt;GetRecommendationsAsync&lt;/code&gt;. No &lt;a href=&quot;http://xunitpatterns.com/Mock%20Object.html&quot;&gt;Mocks&lt;/a&gt; or &lt;a href=&quot;http://xunitpatterns.com/Test%20Stub.html&quot;&gt;Stubs&lt;/a&gt; have opinions about how the SUT interacts with the injected &lt;code&gt;SongService&lt;/code&gt;. This gives me confidence that the tests constitute a trustworthy regression test suite, and that they&apos;re still sufficiently decoupled from implementation details to enable me to completely rewrite the SUT.
    &lt;/p&gt;
    &lt;h3 id=&quot;ab6808bbac564477b6c1fd1751eafd48&quot;&gt;
        Quirks &lt;a href=&quot;#ab6808bbac564477b6c1fd1751eafd48&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        When you add tests to an existing code base, you may discover edge cases that the original programmer overlooked. The &lt;code&gt;GetRecommendationsAsync&lt;/code&gt; method is only a code example, so I don&apos;t blame Oleksii Holub for some casual coding, but it turns out that the code has some quirks.
    &lt;/p&gt;
    &lt;p&gt;
        For example, there&apos;s no deduplication, so I had to &lt;a href=&quot;http://butunclebob.com/ArticleS.TimOttinger.ApologizeIncode&quot;&gt;apologise in my test code&lt;/a&gt;:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;[&amp;lt;Fact&amp;gt;]
&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;``Only&amp;nbsp;top-rated&amp;nbsp;songs``&amp;nbsp;()&amp;nbsp;=&amp;nbsp;task&amp;nbsp;{
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;srvc&amp;nbsp;=&amp;nbsp;FakeSongService&amp;nbsp;()
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Scale&amp;nbsp;ratings&amp;nbsp;to&amp;nbsp;keep&amp;nbsp;them&amp;nbsp;less&amp;nbsp;than&amp;nbsp;or&amp;nbsp;equal&amp;nbsp;to&amp;nbsp;10.&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;[1..20]&amp;nbsp;|&amp;gt;&amp;nbsp;List.iter&amp;nbsp;(&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;i&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;srvc.Scrobble&amp;nbsp;(&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;hyle&amp;quot;&lt;/span&gt;,&amp;nbsp;Song&amp;nbsp;(i,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;true&lt;/span&gt;,&amp;nbsp;byte&amp;nbsp;i&amp;nbsp;/&amp;nbsp;2uy),&amp;nbsp;500))
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let&lt;/span&gt;&amp;nbsp;sut&amp;nbsp;=&amp;nbsp;RecommendationsProvider&amp;nbsp;srvc
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;let!&lt;/span&gt;&amp;nbsp;actual&amp;nbsp;=&amp;nbsp;sut.GetRecommendationsAsync&amp;nbsp;&lt;span style=&quot;color:#a31515;&quot;&gt;&amp;quot;hyle&amp;quot;&lt;/span&gt;
 
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Assert.NotEmpty&amp;nbsp;actual
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Since&amp;nbsp;there&amp;#39;s&amp;nbsp;only&amp;nbsp;one&amp;nbsp;user,&amp;nbsp;but&amp;nbsp;with&amp;nbsp;20&amp;nbsp;songs,&amp;nbsp;the&amp;nbsp;implementation&amp;nbsp;loops&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;over&amp;nbsp;the&amp;nbsp;same&amp;nbsp;songs&amp;nbsp;20&amp;nbsp;times,&amp;nbsp;so&amp;nbsp;400&amp;nbsp;songs&amp;nbsp;in&amp;nbsp;total&amp;nbsp;(with&amp;nbsp;duplicates).&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;Ordering&amp;nbsp;on&amp;nbsp;rating,&amp;nbsp;only&amp;nbsp;the&amp;nbsp;top-rated&amp;nbsp;200&amp;nbsp;remains,&amp;nbsp;that&amp;nbsp;is,&amp;nbsp;those&amp;nbsp;rated&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;5-10.&amp;nbsp;Note&amp;nbsp;that&amp;nbsp;this&amp;nbsp;is&amp;nbsp;a&amp;nbsp;Characterization&amp;nbsp;Test,&amp;nbsp;so&amp;nbsp;not&amp;nbsp;necessarily&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style=&quot;color:green;&quot;&gt;//&amp;nbsp;reflective&amp;nbsp;of&amp;nbsp;how&amp;nbsp;a&amp;nbsp;real&amp;nbsp;recommendation&amp;nbsp;system&amp;nbsp;should&amp;nbsp;work.&lt;/span&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Assert.All&amp;nbsp;(actual,&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;fun&lt;/span&gt;&amp;nbsp;s&amp;nbsp;&lt;span style=&quot;color:blue;&quot;&gt;-&amp;gt;&lt;/span&gt;&amp;nbsp;Assert.True&amp;nbsp;(5uy&amp;nbsp;&amp;lt;=&amp;nbsp;s.Rating))&amp;nbsp;}&amp;nbsp;:&amp;gt;&amp;nbsp;Task&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        This test creates twenty scrobbles for one user: One with a zero rating, two with rating &lt;em&gt;1&lt;/em&gt;, two with rating &lt;em&gt;2&lt;/em&gt;, and so on, up to a single song with rating &lt;em&gt;10&lt;/em&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;a href=&quot;https://tyrrrz.me/blog/pure-impure-segregation-principle#interleaved-impurities&quot;&gt;The implementation of GetRecommendationsAsync&lt;/a&gt; uses these twenty songs to find &apos;other users&apos; who have these top songs as well. In this case, there&apos;s only one user, so for every of those twenty songs, you get the same twenty songs, for a total of 400.
    &lt;/p&gt;
    &lt;p&gt;
        You might protest that this is because my &lt;code&gt;FakeSongService&lt;/code&gt; implementation is too unsophisticated. &lt;em&gt;Obviously&lt;/em&gt;, it should not return the &apos;original&apos; user&apos;s songs! Do, however, consider the implied signature of the &lt;code&gt;GetTopListenersAsync&lt;/code&gt; method:
    &lt;/p&gt;
    &lt;p&gt;
        &lt;pre&gt;Task&amp;lt;IReadOnlyCollection&amp;lt;User&amp;gt;&amp;gt;&amp;nbsp;GetTopListenersAsync(&lt;span style=&quot;color:blue;&quot;&gt;int&lt;/span&gt;&amp;nbsp;songId);&lt;/pre&gt;
    &lt;/p&gt;
    &lt;p&gt;
        The method only accepts a &lt;code&gt;songId&lt;/code&gt; as input, and if we assume that the service is stateless, it doesn&apos;t know who the &apos;original&apos; user is.
    &lt;/p&gt;
    &lt;p&gt;
        Should I fix the quirks? In a real system, it might be appropriate, but in this context I find it better to keep the them. Real systems often have quirks in the shape of legacy business rules and the like, so I only find it realistic that the system may exhibit some weird behaviour. The goal of this set of articles isn&apos;t to refactor &lt;em&gt;this particular system&lt;/em&gt;, but rather to showcase alternative designs for a system sufficiently complicated to warrant refactorings. Simplifying the code might defeat that purpose.
    &lt;/p&gt;
    &lt;p&gt;
        As shown, I have an automated test that requires me to keep that behaviour. I think I&apos;m in a good position to make sweeping changes to the code.
    &lt;/p&gt;
    &lt;h3 id=&quot;c114e6c5e6cd4d4fa1c682daf8ed3169&quot;&gt;
        Conclusion &lt;a href=&quot;#c114e6c5e6cd4d4fa1c682daf8ed3169&quot;&gt;#&lt;/a&gt;
    &lt;/h3&gt;
    &lt;p&gt;
        As &lt;a href=&quot;https://martinfowler.com/&quot;&gt;Martin Fowler&lt;/a&gt; writes, an essential precondition for refactoring is a trustworthy test suite. On a daily basis, millions of developers prove him wrong by deploying untested changes to production. There &lt;em&gt;are&lt;/em&gt; other ways to make changes, including manual testing, &lt;a href=&quot;https://en.wikipedia.org/wiki/A/B_testing&quot;&gt;A/B testing&lt;/a&gt;, testing in production, etc. Some of them may even work in some contexts.
    &lt;/p&gt;
    &lt;p&gt;
        In contrast to such real-world concerns, I don&apos;t have a production system with real users. Neither do I have a product owner or a department of manual testers. The best I can do is to add enough Characterisation Tests that I feel confident that I&apos;ve described &lt;em&gt;the behaviour&lt;/em&gt;, rather than the implementation, in enough detail to hold it in place. A &lt;em&gt;Software Vise&lt;/em&gt;, as &lt;a href=&quot;https://michaelfeathers.silvrback.com/bio&quot;&gt;Michael Feathers&lt;/a&gt; calls it in &lt;a href=&quot;/ref/wewlc&quot;&gt;Working Effectively with Legacy Code&lt;/a&gt;.
    &lt;/p&gt;
    &lt;p&gt;
        Most systems in &apos;the real world&apos; have too few automated tests. Adding tests to a legacy code base is a difficult discipline, so I found it worthwhile to document this work before embarking on the actual design changes promised by this article series. Now that this is out of the way, we can proceed.
    &lt;/p&gt;
    &lt;p&gt;
        The next two articles do more groundwork to establish equivalent code bases in F# and Haskell. If you only care about the C# examples, you can go back to the &lt;a href=&quot;/2025/04/07/alternative-ways-to-design-with-functional-programming&quot;&gt;first article in this article series&lt;/a&gt; and use the table of contents to jump to the next C# example.
    &lt;/p&gt;
    &lt;p&gt;
        &lt;strong&gt;Next:&lt;/strong&gt; &lt;a href=&quot;/2025/04/14/porting-song-recommendations-to-f&quot;&gt;Porting song recommendations to F#&lt;/a&gt;.
    &lt;/p&gt;
&lt;/div&gt;&lt;hr&gt;
      This blog is totally free, but if you like it, please consider &lt;a href="https://blog.ploeh.dk/support"&gt;supporting it&lt;/a&gt;.</description>
        <author>Mark Seemann</author>
        <guid isPermaLink="false">https://blog.ploeh.dk/2025/04/10/characterising-song-recommendations</guid>
      </item>
    

  </channel>
</rss>
