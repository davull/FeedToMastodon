[
  {
    "itemId": "https://blog.ploeh.dk/2025/03/10/appeal-to-aithority",
    "raw": "\n\n\n<div id=\"post\">\n    <p>\n        <em>No, it's not a typo.</em>\n    </p>\n    <p>\n        A few months ago, I was listening to a semi-serious programme from the <a href=\"https://en.wikipedia.org/wiki/DR_P1\">Danish public service radio</a>. This is a weekly programme about language that I always listen to as a podcast. The host is the backbone of the show, but in addition to new guests each week, he's flanked by a regular expert who is highly qualified to answer questions about etymology, grammar, semantics, etc.\n    </p>\n    <p>\n        In the episode I'm describing, the expert got a question that a listener had previously emailed. To answer, (s)he started like this (and I'm paraphrasing): <em>I don't actually know the answer to this question, so I did what everyone does these days, when they don't know the answer: I asked ChatGPT.</em>\n    </p>\n    <p>\n        (S)he then proceeded to read aloud what ChatGPT had answered, and concluded with some remarks along the lines that that answer sounded quite plausible.\n    </p>\n    <p>\n        If I used ten to twenty hours of my time re-listening to every episode from the past few months, I could find the particular episode, link to it, transcribe the exact words, and translate them to English to the best of my abilities. I am, however, not going to do that. First, I'm not inclined to use that much time writing an essay on which I make no income. Second, my aim is not to point fingers at anyone in particular, so I'm being deliberately vague. As you may have noticed, I've even masked the person's sex. Not because I don't remember, but to avoid singling out anyone.\n    </p>\n    <p>\n        The expert in question is a regular of the programme, and I've heard him or her give good and knowledgeable answers to many tricky questions. As far as I could tell, this particular question was unanswerable, along the lines of <em>why is 'table' called 'table' rather than 'griungth'?</em>\n    </p>\n    <p>\n        The correct answer would have been <em>I don't know, and I don't think anyone else does.</em>\n    </p>\n    <p>\n        Being a veteran of the programme, (s)he must have realized on beforehand that this wouldn't be good radio, and instead decided to keep it light-hearted.\n    </p>\n    <p>\n        I get that, and I wouldn't be writing about it now if it doesn't look like an example of an increasing trend.\n    </p>\n    <p>\n        People are using large language models (LLMs) to advocate for their positions.\n    </p>\n    <h3 id=\"27bb7d65cc8746f09d92f650f0a612eb\">\n        Appeal to authority <a href=\"#27bb7d65cc8746f09d92f650f0a612eb\">#</a>\n    </h3>\n    <p>\n        <a href=\"https://en.wikipedia.org/wiki/Argument_from_authority\">Appeal to authority</a> is no new technique in discourse.\n    </p>\n    <blockquote>\n        <p>\n            \"You may also, should it be necessary, not only twist your authorities, but actually falsify them, or quote something which you have invented entirely yourself. As a rule, your opponent has no books at hand, and could not use them if he had.\"\n        </p>\n        <footer><cite><a href=\"https://en.wikipedia.org/wiki/The_Art_of_Being_Right\">The Art of Being Right</a></cite>, <a href=\"https://en.wikipedia.org/wiki/Arthur_Schopenhauer\">Arthur Schopenhauer</a>, 1831</footer>\n    </blockquote>\n    <p>\n        This seems similar to how people have begun using so-called artificial intelligence (AI) to do their arguing for them. We may, instead, call this <em>appeal to aithority</em>.\n    </p>\n    <h3 id=\"535b5c4b352241f9bfd089677757b18f\">\n        Epistemological cul-de-sac <a href=\"#535b5c4b352241f9bfd089677757b18f\">#</a>\n    </h3>\n    <p>\n        We've all seen plenty of examples of LLMs being wrong. I'm not going to tire you with any of those here, but I did outline <a href=\"/2022/12/05/github-copilot-preliminary-experience-report\">my experience with GitHub Copilot in 2022</a>. While these technologies may have made some advances since then, they still make basic mistakes.\n    </p>\n    <p>\n        Not only that. They're also non-deterministic. Ask a system a question once, and you get one answer. Ask the same question later, and you may get a variation of the same answer, or perhaps even a contradictory answer. If someone exhibits an answer they got from an LLM as an argument in their favour, consider that they may have been asking it five or six times before they received an answer they liked.\n    </p>\n    <p>\n        Finally, you can easily ask leading questions. Even if someone shows you a screen shot of a chat with an LLM, they may have clipped prior instructions that nudge the system towards a particular bias.\n    </p>\n    <p>\n        I've seen people post screen shots that an LLM claims that <a href=\"https://fsharp.org/\">F#</a> is a better programming language than C#. While I'm sympathetic to that claim, that's not an argument. Just like <a href=\"/2020/10/12/subjectivity\">how you feel about something isn't an argument</a>.\n    </p>\n    <p>\n        This phenomenon seems to be a new trend. People use answers from LLMs as evidence that they are right. I consider this an epistemological dead end.\n    </p>\n    <h3 id=\"3a509e32ddc74ecb8dc0c7bf8048156a\">\n        Real authority <a href=\"#3a509e32ddc74ecb8dc0c7bf8048156a\">#</a>\n    </h3>\n    <p>\n        Regular readers of this blog may have noticed that I often go to great lengths to track down appropriate sources to cite. I do this for several reasons. One is simply out of respect for the people who figured out things before us. Another reason is to strengthen my own arguments.\n    </p>\n    <p>\n        It may seem that I, too, appeal to authority. Indeed, I do. When not used in in the way Schopenhauer describes, citing authority is a necessary epistemological shortcut. If someone who knows much about a particular subject has reached a conclusion based on his or her work, we may (tentatively) accept the conclusion without going through all the same work. As Carl Sagan said, \"If you wish to make an apple pie from scratch, you must first invent the universe.\" You can't do <em>all</em> basic research by yourself. At some point, you'll have to take expert assertions at face value, because you don't have the time, the education, or the money to build your own <a href=\"https://en.wikipedia.org/wiki/Large_Hadron_Collider\">Large Hadron Collider</a>.\n    </p>\n    <p>\n        Don't blindly accept an argument on the only grounds that someone famous said something, but on the other hand, there's no reason to dismiss out of hand what <a href=\"https://en.wikipedia.org/wiki/Albert_Einstein\">Albert Einstein</a> had to say about gravity, just because you've heard that you shouldn't accept an argument based on appeal to authority.\n    </p>\n    <h3 id=\"8dbb3f507d8d49b2aa2f322d80fb4031\">\n        Conclusion <a href=\"#8dbb3f507d8d49b2aa2f322d80fb4031\">#</a>\n    </h3>\n    <p>\n        I'm concerned that people increasingly seem to resort to LLMs to argue a case. The LLMs says this, so it must be right.\n    </p>\n    <p>\n        Sometimes, people will follow up their arguments with <em>of course, it's just an AI, but...</em> and then proceed to unfold their preferred argument. Even if this seems as though the person is making a 'real' argument, starting from an LLM answer establishes a baseline to a discussion. It still lends an aura of truth to something that may be false.\n    </p>\n</div><hr>\n      This blog is totally free, but if you like it, please consider <a href=\"https://blog.ploeh.dk/support\">supporting it</a>.",
    "sanitized": "No, it's not a typo.\n    \n    \n        A few months ago, I was listening to a semi-serious programme from the Danish public service radio. This is a weekly programme about language that I always listen to as a podcast. The host is the backbone of the show, but in addition to new guests each week, he's flanked by a regular expert who is highly qualified to answer questions about etymology, grammar, semantics, etc.\n    \n    \n        In the episode I'm describing, the expert got a question that a listener had previously emailed. To answer, (s)he started like this (and I'm paraphrasing): I don't actually know the answer to this question, so I did what everyone does these days, when they don't know the answer: I asked ChatGPT.\n    \n    \n        (S)he then proceeded to read aloud what ChatGPT had answered, and concluded with some remarks along the lines that that answer sounded quite plausible.\n    \n    \n        If I used ten to twenty hours of my time re-listening to every episode from the past few months, I could find the particular episode, link to it, transcribe the exact words, and translate them to English to the best of my abilities. I am, however, not going to do that. First, I'm not inclined to use that much time writing an essay on which I make no income. Second, my aim is not to point fingers at anyone in particular, so I'm being deliberately vague. As you may have noticed, I've even masked the person's sex. Not because I don't remember, but to avoid singling out anyone.\n    \n    \n        The expert in question is a regular of the programme, and I've heard him or her give good and knowledgeable answers to many tricky questions. As far as I could tell, this particular question was unanswerable, along the lines of why is 'table' called 'table' rather than 'griungth'?\n    \n    \n        The correct answer would have been I don't know, and I don't think anyone else does.\n    \n    \n        Being a veteran of the programme, (s)he must have realized on beforehand that this wouldn't be good radio, and instead decided to keep it light-hearted.\n    \n    \n        I get that, and I wouldn't be writing about it now if it doesn't look like an example of an increasing trend.\n    \n    \n        People are using large language models (LLMs) to advocate for their positions.\n    \n    \n        Appeal to authority #\n    \n    \n        Appeal to authority is no new technique in discourse.\n    \n    \n        \n            \"You may also, should it be necessary, not only twist your authorities, but actually falsify them, or quote something which you have invented entirely yourself. As a rule, your opponent has no books at hand, and could not use them if he had.\"\n        \n        The Art of Being Right, Arthur Schopenhauer, 1831\n    \n    \n        This seems similar to how people have begun using so-called artificial intelligence (AI) to do their arguing for them. We may, instead, call this appeal to aithority.\n    \n    \n        Epistemological cul-de-sac #\n    \n    \n        We've all seen plenty of examples of LLMs being wrong. I'm not going to tire you with any of those here, but I did outline my experience with GitHub Copilot in 2022. While these technologies may have made some advances since then, they still make basic mistakes.\n    \n    \n        Not only that. They're also non-deterministic. Ask a system a question once, and you get one answer. Ask the same question later, and you may get a variation of the same answer, or perhaps even a contradictory answer. If someone exhibits an answer they got from an LLM as an argument in their favour, consider that they may have been asking it five or six times before they received an answer they liked.\n    \n    \n        Finally, you can easily ask leading questions. Even if someone shows you a screen shot of a chat with an LLM, they may have clipped prior instructions that nudge the system towards a particular bias.\n    \n    \n        I've seen people post screen shots that an LLM claims that F# is a better programming language than C#. While I'm sympathetic to that claim, that's not an argument. Just like how you feel about something isn't an argument.\n    \n    \n        This phenomenon seems to be a new trend. People use answers from LLMs as evidence that they are right. I consider this an epistemological dead end.\n    \n    \n        Real authority #\n    \n    \n        Regular readers of this blog may have noticed that I often go to great lengths to track down appropriate sources to cite. I do this for several reasons. One is simply out of respect for the people who figured out things before us. Another reason is to strengthen my own arguments.\n    \n    \n        It may seem that I, too, appeal to authority. Indeed, I do. When not used in in the way Schopenhauer describes, citing authority is a necessary epistemological shortcut. If someone who knows much about a particular subject has reached a conclusion based on his or her work, we may (tentatively) accept the conclusion without going through all the same work. As Carl Sagan said, \"If you wish to make an apple pie from scratch, you must first invent the universe.\" You can't do all basic research by yourself. At some point, you'll have to take expert assertions at face value, because you don't have the time, the education, or the money to build your own Large Hadron Collider.\n    \n    \n        Don't blindly accept an argument on the only grounds that someone famous said something, but on the other hand, there's no reason to dismiss out of hand what Albert Einstein had to say about gravity, just because you've heard that you shouldn't accept an argument based on appeal to authority.\n    \n    \n        Conclusion #\n    \n    \n        I'm concerned that people increasingly seem to resort to LLMs to argue a case. The LLMs says this, so it must be right.\n    \n    \n        Sometimes, people will follow up their arguments with of course, it's just an AI, but... and then proceed to unfold their preferred argument. Even if this seems as though the person is making a 'real' argument, starting from an LLM answer establishes a baseline to a discussion. It still lends an aura of truth to something that may be false.\n    \n\n      This blog is totally free, but if you like it, please consider supporting it."
  },
  {
    "itemId": "https://blog.ploeh.dk/2025/03/03/reactive-monad",
    "raw": "\n\n\n<div id=\"post\">\n    <p>\n        <em>IObservable&lt;T&gt; is (also) a monad.</em>\n    </p>\n    <p>\n        This article is an instalment in <a href=\"/2022/03/28/monads\">an article series about monads</a>. While the previous articles showed, in great detail, how to turn various classes into monads, this article mostly serves as a place-holder. The purpose is only to point out that you don't have to create all monads yourself. Sometimes, they come as part of a reusable library.\n    </p>\n    <p>\n        <a href=\"http://reactivex.io\">Rx</a> define such libraries, and <code>IObservable&lt;T&gt;</code> forms a monad. <a href=\"https://github.com/dotnet/reactive\">Reactive Extensions for .NET</a> define a <code>SelectMany</code> method for <code>IObservable&lt;T&gt;</code>, so if <code>source</code> is an <code><span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:blue;\">int</span>&gt;</code>, you can translate it to <code><span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:blue;\">char</span>&gt;</code> like this:\n    </p>\n    <p>\n        <pre><span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:blue;\">char</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">dest</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">source</span>.<span style=\"font-weight:bold;color:#74531f;\">SelectMany</span>(<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&gt;&nbsp;<span style=\"color:#2b91af;\">Observable</span>.<span style=\"color:#74531f;\">Repeat</span>(<span style=\"color:#a31515;\">&#39;x&#39;</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>));</pre>\n    </p>\n    <p>\n        Since the <code>SelectMany</code> method is, indeed, called <code>SelectMany</code> and has the signature\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:#2b91af;\">TResult</span>&gt;&nbsp;<span style=\"color:#74531f;\">SelectMany</span>&lt;<span style=\"color:#2b91af;\">TSource</span>,&nbsp;<span style=\"color:#2b91af;\">TResult</span>&gt;(\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">this</span>&nbsp;<span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:#2b91af;\">TSource</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">source</span>,\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Func</span>&lt;<span style=\"color:#2b91af;\">TSource</span>,&nbsp;<span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:#2b91af;\">TResult</span>&gt;&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">selector</span>)</pre>\n    </p>\n    <p>\n        you can also use C#'s query syntax:\n    </p>\n    <p>\n        <pre><span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:blue;\">char</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">dest</span>&nbsp;=&nbsp;<span style=\"color:blue;\">from</span>&nbsp;i&nbsp;<span style=\"color:blue;\">in</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">source</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">from</span>&nbsp;x&nbsp;<span style=\"color:blue;\">in</span>&nbsp;<span style=\"color:#2b91af;\">Observable</span>.<span style=\"color:#74531f;\">Repeat</span>(<span style=\"color:#a31515;\">&#39;x&#39;</span>,&nbsp;i)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">select</span>&nbsp;x;</pre>\n    </p>\n    <p>\n        In both of the above examples, I've explicitly declared the type of <code>dest</code> instead of using the <code>var</code> keyword. There's no practical reason to do this; I only did it to make the type clear to you.\n    </p>\n    <h3 id=\"2de8539dd63d4b1699e6656866e9615d\">\n        Left identity <a href=\"#2de8539dd63d4b1699e6656866e9615d\">#</a>\n    </h3>\n    <p>\n        As I've already written time and again, a few test cases don't prove that any of the <a href=\"/2022/04/11/monad-laws\">monad laws</a> hold, but they can help illustrate what they imply. For example, here's an illustration of the left-identity law, written as a parametrized <a href=\"https://xunit.net/\">xUnit.net</a> test:\n    </p>\n    <p>\n        <pre>[<span style=\"color:#2b91af;\">Theory</span>]\n[<span style=\"color:#2b91af;\">InlineData</span>(1)]\n[<span style=\"color:#2b91af;\">InlineData</span>(2)]\n[<span style=\"color:#2b91af;\">InlineData</span>(3)]\n<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">async</span>&nbsp;<span style=\"color:#2b91af;\">Task</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">LeftIdentity</span>(<span style=\"color:blue;\">int</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">a</span>)\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:blue;\">char</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#74531f;\">h</span>(<span style=\"color:blue;\">int</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)&nbsp;=&gt;&nbsp;<span style=\"color:#2b91af;\">Observable</span>.<span style=\"color:#74531f;\">Repeat</span>(<span style=\"color:#a31515;\">&#39;x&#39;</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>);\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IList</span>&lt;<span style=\"color:blue;\">char</span>&gt;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">left</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">await</span>&nbsp;<span style=\"color:#2b91af;\">Observable</span>.<span style=\"color:#74531f;\">Return</span>(<span style=\"font-weight:bold;color:#1f377f;\">a</span>).<span style=\"font-weight:bold;color:#74531f;\">SelectMany</span>(<span style=\"font-weight:bold;color:#74531f;\">h</span>).<span style=\"font-weight:bold;color:#74531f;\">ToList</span>();\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IList</span>&lt;<span style=\"color:blue;\">char</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">right</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">await</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">h</span>(<span style=\"font-weight:bold;color:#1f377f;\">a</span>).<span style=\"font-weight:bold;color:#74531f;\">ToList</span>();\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Assert</span>.<span style=\"color:#74531f;\">Equal</span>(<span style=\"font-weight:bold;color:#1f377f;\">left</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">right</span>);\n}</pre>\n    </p>\n    <p>\n        Not only does the <a href=\"https://www.nuget.org/packages/System.Reactive/\">System.Reactive</a> library define <em>monadic bind</em> in the form of <code>SelectMany</code>, but also <em>return</em>, with the aptly named <code>Observable.Return</code> function. .NET APIs often forget to do so explicitly, which means that I often have to go hunting for it, or guessing what the developers may have called it. Not here; thank you, Rx team.\n    </p>\n    <h3 id=\"04c23a87f0534e4495ef3d644793e1aa\">\n        Right identity <a href=\"#04c23a87f0534e4495ef3d644793e1aa\">#</a>\n    </h3>\n    <p>\n        In the same spirit, we may write another test to illustrate the right-identity law:\n    </p>\n    <p>\n        <pre>[<span style=\"color:#2b91af;\">Theory</span>]\n[<span style=\"color:#2b91af;\">InlineData</span>(<span style=\"color:#a31515;\">&quot;foo&quot;</span>)]\n[<span style=\"color:#2b91af;\">InlineData</span>(<span style=\"color:#a31515;\">&quot;bar&quot;</span>)]\n[<span style=\"color:#2b91af;\">InlineData</span>(<span style=\"color:#a31515;\">&quot;baz&quot;</span>)]\n<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">async</span>&nbsp;<span style=\"color:#2b91af;\">Task</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">RightIdentity</span>(<span style=\"color:blue;\">string</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">a</span>)\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:blue;\">char</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#74531f;\">f</span>(<span style=\"color:blue;\">string</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>)&nbsp;=&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>.<span style=\"font-weight:bold;color:#74531f;\">ToObservable</span>();\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:blue;\">char</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">m</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#74531f;\">f</span>(<span style=\"font-weight:bold;color:#1f377f;\">a</span>);\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IList</span>&lt;<span style=\"color:blue;\">char</span>&gt;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">left</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">await</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">m</span>.<span style=\"font-weight:bold;color:#74531f;\">SelectMany</span>(<span style=\"color:#2b91af;\">Observable</span>.<span style=\"color:#74531f;\">Return</span>).<span style=\"font-weight:bold;color:#74531f;\">ToList</span>();\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IList</span>&lt;<span style=\"color:blue;\">char</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">right</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">await</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">m</span>.<span style=\"font-weight:bold;color:#74531f;\">ToList</span>();\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Assert</span>.<span style=\"color:#74531f;\">Equal</span>(<span style=\"font-weight:bold;color:#1f377f;\">left</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">right</span>);\n}</pre>\n    </p>\n    <p>\n        In both this and the previous test, you can see that the test has to <code>await</code> the observables in order to verify that the resulting collections are identical. Clearly, if you're instead dealing with infinite streams of data, you can't rely on such a simplifying assumption. For the general case, you must instead turn to other (proof) techniques to convince yourself that the laws hold. That's not my agenda here, so I'll skip that part.\n    </p>\n    <h3 id=\"8b5017e1aa3942ee8693e56eec6c060d\">\n        Associativity <a href=\"#8b5017e1aa3942ee8693e56eec6c060d\">#</a>\n    </h3>\n    <p>\n        Finally, we may illustrate the associativity law like this:\n    </p>\n    <p>\n        <pre>[<span style=\"color:#2b91af;\">Theory</span>]\n[<span style=\"color:#2b91af;\">InlineData</span>(<span style=\"color:#a31515;\">&quot;foo&quot;</span>)]\n[<span style=\"color:#2b91af;\">InlineData</span>(<span style=\"color:#a31515;\">&quot;123&quot;</span>)]\n[<span style=\"color:#2b91af;\">InlineData</span>(<span style=\"color:#a31515;\">&quot;4t2&quot;</span>)]\n<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">async</span>&nbsp;<span style=\"color:#2b91af;\">Task</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Associativity</span>(<span style=\"color:blue;\">string</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">a</span>)\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:blue;\">char</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#74531f;\">f</span>(<span style=\"color:blue;\">string</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>)&nbsp;=&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>.<span style=\"font-weight:bold;color:#74531f;\">ToObservable</span>();\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:blue;\">byte</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#74531f;\">g</span>(<span style=\"color:blue;\">char</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">c</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">if</span>&nbsp;(<span style=\"color:blue;\">byte</span>.<span style=\"color:#74531f;\">TryParse</span>(<span style=\"font-weight:bold;color:#1f377f;\">c</span>.<span style=\"font-weight:bold;color:#74531f;\">ToString</span>(),&nbsp;<span style=\"color:blue;\">out</span>&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">b</span>))\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"color:#2b91af;\">Observable</span>.<span style=\"color:#74531f;\">Return</span>(<span style=\"font-weight:bold;color:#1f377f;\">b</span>);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">else</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"color:#2b91af;\">Observable</span>.<span style=\"color:#74531f;\">Empty</span>&lt;<span style=\"color:blue;\">byte</span>&gt;();\n&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:blue;\">bool</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#74531f;\">h</span>(<span style=\"color:blue;\">byte</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">b</span>)&nbsp;=&gt;&nbsp;<span style=\"color:#2b91af;\">Observable</span>.<span style=\"color:#74531f;\">Repeat</span>(<span style=\"font-weight:bold;color:#1f377f;\">b</span>&nbsp;%&nbsp;2&nbsp;==&nbsp;0,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">b</span>);\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IObservable</span>&lt;<span style=\"color:blue;\">char</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">m</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#74531f;\">f</span>(<span style=\"font-weight:bold;color:#1f377f;\">a</span>);\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IList</span>&lt;<span style=\"color:blue;\">bool</span>&gt;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">left</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">await</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">m</span>.<span style=\"font-weight:bold;color:#74531f;\">SelectMany</span>(<span style=\"font-weight:bold;color:#74531f;\">g</span>).<span style=\"font-weight:bold;color:#74531f;\">SelectMany</span>(<span style=\"font-weight:bold;color:#74531f;\">h</span>).<span style=\"font-weight:bold;color:#74531f;\">ToList</span>();\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IList</span>&lt;<span style=\"color:blue;\">bool</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">right</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">await</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">m</span>.<span style=\"font-weight:bold;color:#74531f;\">SelectMany</span>(<span style=\"font-weight:bold;color:#1f377f;\">x</span>&nbsp;=&gt;&nbsp;<span style=\"font-weight:bold;color:#74531f;\">g</span>(<span style=\"font-weight:bold;color:#1f377f;\">x</span>).<span style=\"font-weight:bold;color:#74531f;\">SelectMany</span>(<span style=\"font-weight:bold;color:#74531f;\">h</span>)).<span style=\"font-weight:bold;color:#74531f;\">ToList</span>();\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Assert</span>.<span style=\"color:#74531f;\">Equal</span>(<span style=\"font-weight:bold;color:#1f377f;\">left</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">right</span>);\n}</pre>\n    </p>\n    <p>\n        This test composes three observable-producing functions in two different ways, to verify that they produce the same values.\n    </p>\n    <p>\n        The first function, <code>f</code>, simply turns a string into an observable stream. The string <code>\"foo\"</code> becomes the stream of characters <code>'f'</code>, <code>'o'</code>, <code>'o'</code>, and so on.\n    </p>\n    <p>\n        The next function, <code>g</code>, tries to parse the incoming character as a number. I've chosen <code>byte</code> as the data type, since there's no reason trying to parse a value that can, at best, be one of the digits <code>0</code> to <code>9</code> into a full 32-bit integer. A <code>byte</code> is already too large. If the character can be parsed, it's published as a byte value; if not, an empty stream of data is returned. For example, the character stream <code>'f'</code>, <code>'o'</code>, <code>'o'</code> results in three empty streams, whereas the stream <code>4</code>, <code>t</code>, <code>2</code> produces one singleton stream containing the <code>byte</code> <code>4</code>, followed by an empty stream, followed again by a stream containing the single number <code>2</code>.\n    </p>\n    <p>\n        The third and final function, <code>h</code>, turns a number into a stream of Boolean values; <code>true</code> if the number is even, and <code>false</code> if it's odd. The number of values is equal to the number itself. Thus, when composed together, <code>\"123\"</code> becomes the stream <code>false</code>, <code>true</code>, <code>true</code>, <code>false</code>, <code>false</code>, <code>false</code>. This is true for both the <code>left</code> and the <code>right</code> list, even though they're results of two different compositions.\n    </p>\n    <h3 id=\"e4efefbebe564e30a27720fdd3f65f7f\">\n        Conclusion <a href=\"#e4efefbebe564e30a27720fdd3f65f7f\">#</a>\n    </h3>\n    <p>\n        The point of this article is mostly that monads are commonplace. While you may discover them in your own code, they may also come in a reusable library. If you already know C# LINQ based off <code>IEnumerable&lt;T&gt;</code>, parts of Rx will be easy for you to learn. After all, it's the same abstraction, and <em>familiar abstractions make code readable</em>.\n    </p>\n    <p>\n        <strong>Next:</strong> <a href=\"/2023/01/09/the-io-monad\">The IO monad</a>.\n    </p>\n</div><hr>\n      This blog is totally free, but if you like it, please consider <a href=\"https://blog.ploeh.dk/support\">supporting it</a>.",
    "sanitized": "IObservable<T> is (also) a monad.\n    \n    \n        This article is an instalment in an article series about monads. While the previous articles showed, in great detail, how to turn various classes into monads, this article mostly serves as a place-holder. The purpose is only to point out that you don't have to create all monads yourself. Sometimes, they come as part of a reusable library.\n    \n    \n        Rx define such libraries, and IObservable<T> forms a monad. Reactive Extensions for .NET define a SelectMany method for IObservable<T>, so if source is an IObservable<int>, you can translate it to IObservable<char> like this:\n    \n    \n        IObservable<char> dest = source.SelectMany(i => Observable.Repeat('x', i));\n    \n    \n        Since the SelectMany method is, indeed, called SelectMany and has the signature\n    \n    \n        public static IObservable<TResult> SelectMany<TSource, TResult>(\n    this IObservable<TSource> source,\n    Func<TSource, IObservable<TResult>> selector)\n    \n    \n        you can also use C#'s query syntax:\n    \n    \n        IObservable<char> dest = from i in source\n                         from x in Observable.Repeat('x', i)\n                         select x;\n    \n    \n        In both of the above examples, I've explicitly declared the type of dest instead of using the var keyword. There's no practical reason to do this; I only did it to make the type clear to you.\n    \n    \n        Left identity #\n    \n    \n        As I've already written time and again, a few test cases don't prove that any of the monad laws hold, but they can help illustrate what they imply. For example, here's an illustration of the left-identity law, written as a parametrized xUnit.net test:\n    \n    \n        [Theory]\n[InlineData(1)]\n[InlineData(2)]\n[InlineData(3)]\npublic async Task LeftIdentity(int a)\n{\n    IObservable<char> h(int i) => Observable.Repeat('x', i);\n \n    IList<char>  left = await Observable.Return(a).SelectMany(h).ToList();\n    IList<char> right = await h(a).ToList();\n \n    Assert.Equal(left, right);\n}\n    \n    \n        Not only does the System.Reactive library define monadic bind in the form of SelectMany, but also return, with the aptly named Observable.Return function. .NET APIs often forget to do so explicitly, which means that I often have to go hunting for it, or guessing what the developers may have called it. Not here; thank you, Rx team.\n    \n    \n        Right identity #\n    \n    \n        In the same spirit, we may write another test to illustrate the right-identity law:\n    \n    \n        [Theory]\n[InlineData(\"foo\")]\n[InlineData(\"bar\")]\n[InlineData(\"baz\")]\npublic async Task RightIdentity(string a)\n{\n    IObservable<char> f(string s) => s.ToObservable();\n \n    IObservable<char> m = f(a);\n    IList<char>  left = await m.SelectMany(Observable.Return).ToList();\n    IList<char> right = await m.ToList();\n \n    Assert.Equal(left, right);\n}\n    \n    \n        In both this and the previous test, you can see that the test has to await the observables in order to verify that the resulting collections are identical. Clearly, if you're instead dealing with infinite streams of data, you can't rely on such a simplifying assumption. For the general case, you must instead turn to other (proof) techniques to convince yourself that the laws hold. That's not my agenda here, so I'll skip that part.\n    \n    \n        Associativity #\n    \n    \n        Finally, we may illustrate the associativity law like this:\n    \n    \n        [Theory]\n[InlineData(\"foo\")]\n[InlineData(\"123\")]\n[InlineData(\"4t2\")]\npublic async Task Associativity(string a)\n{\n    IObservable<char> f(string s) => s.ToObservable();\n    IObservable<byte> g(char c)\n    {\n        if (byte.TryParse(c.ToString(), out var b))\n            return Observable.Return(b);\n        else\n            return Observable.Empty<byte>();\n    }\n    IObservable<bool> h(byte b) => Observable.Repeat(b % 2 == 0, b);\n \n    IObservable<char> m = f(a);\n    IList<bool>  left = await m.SelectMany(g).SelectMany(h).ToList();\n    IList<bool> right = await m.SelectMany(x => g(x).SelectMany(h)).ToList();\n \n    Assert.Equal(left, right);\n}\n    \n    \n        This test composes three observable-producing functions in two different ways, to verify that they produce the same values.\n    \n    \n        The first function, f, simply turns a string into an observable stream. The string \"foo\" becomes the stream of characters 'f', 'o', 'o', and so on.\n    \n    \n        The next function, g, tries to parse the incoming character as a number. I've chosen byte as the data type, since there's no reason trying to parse a value that can, at best, be one of the digits 0 to 9 into a full 32-bit integer. A byte is already too large. If the character can be parsed, it's published as a byte value; if not, an empty stream of data is returned. For example, the character stream 'f', 'o', 'o' results in three empty streams, whereas the stream 4, t, 2 produces one singleton stream containing the byte 4, followed by an empty stream, followed again by a stream containing the single number 2.\n    \n    \n        The third and final function, h, turns a number into a stream of Boolean values; true if the number is even, and false if it's odd. The number of values is equal to the number itself. Thus, when composed together, \"123\" becomes the stream false, true, true, false, false, false. This is true for both the left and the right list, even though they're results of two different compositions.\n    \n    \n        Conclusion #\n    \n    \n        The point of this article is mostly that monads are commonplace. While you may discover them in your own code, they may also come in a reusable library. If you already know C# LINQ based off IEnumerable<T>, parts of Rx will be easy for you to learn. After all, it's the same abstraction, and familiar abstractions make code readable.\n    \n    \n        Next: The IO monad.\n    \n\n      This blog is totally free, but if you like it, please consider supporting it."
  },
  {
    "itemId": "https://blog.ploeh.dk/2025/02/24/easier-encapsulation-with-static-types",
    "raw": "\n\n\n<div id=\"post\">\n    <p>\n        <em>A metaphor.</em>\n    </p>\n    <p>\n        While I'm still <a href=\"/2021/08/09/am-i-stuck-in-a-local-maximum\">struggling</a> with the notion that <a href=\"/2024/12/09/implementation-and-usage-mindsets\">dynamically typed languages may have compelling advantages</a>, I keep coming back to the benefits of statically typed languages. One such benefit is how it enables the communication of contracts, as I recently discussed in <a href=\"/2025/01/06/encapsulating-rod-cutting\">Encapsulating rod-cutting</a>.\n    </p>\n    <p>\n        As usual, I base my treatment of <a href=\"/encapsulation-and-solid\">encapsulation</a> on my reading of <a href=\"https://en.wikipedia.org/wiki/Bertrand_Meyer\">Bertrand Meyer</a>'s seminal <a href=\"/ref/oosc\">Object-Oriented Software Construction</a>. A major aspect of encapsulation is the explicit establishment of <em>contracts</em>. What is expected of client code before it can invoke an operation (preconditions)? What is guaranteed to be true after the operation completes (postconditions)? And what is always true of a particular data structure (invariants)?\n    </p>\n    <p>\n        Contracts constitute the practical part of encapsulation. A contract can give you a rough sense of how well-encapsulated an API is: The more statements you can utter about the contract, the better encapsulation. You may even be able to take all those assertions about the contract and implement them as property-based tests. In other words, if you can think of many properties to write as tests, the API in question probably has good encapsulation. If, on the other hand, you can't think of a single precondition, postcondition, or invariant, this may indicate that encapsulation is lacking.\n    </p>\n    <p>\n        Contracts are the practical part of encapsulation. The overall notion provides guidance of <em>how</em> to achieve encapsulation. Specific contracts describe <em>what</em> is possible, and <em>how</em> to successfully interact with an API. Clearly, the <em>what</em> and <em>how</em>.\n    </p>\n    <p>\n        They don't, however, explain <em>why</em> encapsulation is valuable.\n    </p>\n    <h3 id=\"1a06496713174bba99d05dad211205c2\">\n        Why encapsulate? <a href=\"#1a06496713174bba99d05dad211205c2\">#</a>\n    </h3>\n    <p>\n        Successful code bases are big. Such a code base rarely <a href=\"/code-that-fits-in-your-head\">fits in your head</a> in its entirety. And the situation is only exacerbated by multiple programmers working concurrently on the code. Even if you knew most of the code base by heart, your team members are changing it, and you aren't going to be aware of all the modifications.\n    </p>\n    <p>\n        Encapsulation offers a solution to this problem. Instead of knowing every detail of the entire code base, encapsulation should enable you to interact with an API (originally, an <em>object</em>) <em>without</em> knowing all the implementation details. This is the raison d'être of contracts. Ideally, knowing the contract and the purpose of an object and its methods should be enough.\n    </p>\n    <p>\n        Imagine that you've designed an API with a strong contract. Is your work done? Not yet. Somehow, you'll have to communicate the contract to all present and future client developers.\n    </p>\n    <p>\n        How do you convey a contract to potential users? I can think of a few ways. Good names are important, but <a href=\"/2020/11/23/good-names-are-skin-deep\">only skin-deep</a>. You can also publish documentation, or use the type system. The following metaphor explores those two alternatives.\n    </p>\n    <h3 id=\"5ad0b635686f436d80a753622d6e4f22\">\n        Doing a puzzle <a href=\"#5ad0b635686f436d80a753622d6e4f22\">#</a>\n    </h3>\n    <p>\n        When I was a boy, I had a puzzle called <em>Das verflixte Hunde-Spiel</em>, which roughly translates to <em>the confounded dog game</em>. I've <a href=\"/2024/10/03/das-verflixte-hunde-spiel\">previously described the game and an algorithm for solving it</a>, but that's not my concern here. Rather, I'd like to discuss how one might abstract the information carried by each tile.\n    </p>\n    <p>\n        <img src=\"/content/binary/hunde-spiel.jpg\" alt=\"A picture of the box of the puzzle, together with the tiles spread out in unordered fashion.\">\n    </p>\n    <p>\n        As the picture suggests, the game consists of nine square tiles, each with two dog heads and two tails. The objective of the puzzle is to lay all nine tiles in a three-by-three grid such that all the heads fit the opposing tails. The dogs come in four different colour patterns, and each head must fit a tail of the same pattern.\n    </p>\n    <p>\n        It turns out that there are umpteen variations of this kind of puzzle. This one has cartoon dogs, but you can find similar games with frogs, cola bottles, <a href=\"https://en.wikipedia.org/wiki/Playing_card_suit\">playing card suits</a>, trains, ladybirds, fast food, flowers, baseball players, owls, etc. This suggests that a <em>generalization</em> may exist. Perhaps an abstraction, even.\n    </p>\n\t<blockquote>\n\t\t<p>\n\t\t\t\"Abstraction is the elimination of the irrelevant and the amplification of the essential\"\n\t\t</p>\n\t\t<footer><cite>Robert C. Martin, <a href=\"/ref/doocautbm\">Designing Object-Oriented C++ Applications Using The Booch Method</a>, ch. 00</cite></footer>\n\t</blockquote>\n    <p>\n        How to eliminate the irrelevant and amplify the essential of a tile?\n    </p>\n    <p>\n        To recapitulate, a single tile looks like this:\n    </p>\n    <p>\n        <img src=\"/content/binary/hundespiel-tile1.jpg\" width=\"200\" alt=\"One of the tiles of the Hunde-Spiel.\">\n    </p>\n    <p>\n        In a sense, we may regard most of the information on such a tile as 'implementation details'. In a code metaphor, imagine looking at a tile like this as being equivalent to looking at the source code of a method or function (i.e. API). That's not the <em>essence</em> we need to correctly assemble the puzzle.\n    </p>\n    <p>\n        Imagine that you have to lay down the tiles according to <a href=\"/2024/10/03/das-verflixte-hunde-spiel\">a known solution</a>. Since you already know the solution, this task only involves locating and placing each of the nine tiles. In this case, there are only nine tiles, each with four possible rotations, so if you already know what you're looking for, that is, of course, a tractable endeavour.\n    </p>\n    <p>\n        Now imagine that you'd like to undertake putting together the tiles <em>without</em> having to navigate by the full information content of each tile. In programming, we often need to do this. We have to identify objects that are likely to perform some subtask for us, and we have to figure out how to interact with such an object to achieve our goals. Preferably, we'd like to be able to do this <em>without</em> having to read all the source code of the candidate object. <em>Encapsulation</em> promises that this should be possible.\n    </p>\n    <h3 id=\"f87bc2bd17584b63808bb0581eeb1523\">\n        The backside of the tiles <a href=\"#f87bc2bd17584b63808bb0581eeb1523\">#</a>\n    </h3>\n    <p>\n        If we want to eliminate the irrelevant, we have to hide the information on each tile. As a first step, consider what happens if we flip the tiles around so that we only see their backs.\n    </p>\n    <p>\n        <img src=\"/content/binary/empty-tile-backside.png\" alt=\"An empty square, symbolizing the backside of a tile.\" width=\"200\">\n    </p>\n    <p>\n        Obviously, each backside is entirely devoid of information, which means that we're now flying blind. Even if we know how to solve the puzzle, our only recourse is to blindly pick and rotate each of the nine tiles. As the <a href=\"/2024/10/03/das-verflixte-hunde-spiel\">previous article</a> calculated, when picking at random, the odds of arriving at any valid solution is 1 to 5,945,425,920. Not surprisingly, total absence of information doesn't work.\n    </p>\n    <p>\n        We already knew that, because, while we want to eliminate the irrelevant, we also must amplify the essential. Thus, we need to figure out what that might be.\n    </p>\n    <p>\n        Perhaps we could write the essential information on the back of each tile. In the metaphor, this would correspond to writing documentation for an API.\n    </p>\n    <h3 id=\"86c6695ffa884ec28be560309779ab98\">\n        Documentation <a href=\"#86c6695ffa884ec28be560309779ab98\">#</a>\n    </h3>\n    <p>\n        To continue the metaphor, I asked various acquaintances to each 'document' a title. I deliberately only gave them the instruction that they should enable me to assemble the puzzle based on what was on the back of each tile. Some asked for additional directions, as to format, etc., but I refused to give any. People document code in various different ways, and I wanted to capture similar variation. Let's review some of the documentation I received.\n    </p>\n    <p>\n        <img src=\"/content/binary/tile2-doc.jpg\" alt=\"The back of a tile, with written documentation and some arrows.\" width=\"200\">\n    </p>\n    <p>\n        Since I asked around among acquaintances, all respondents were Danes, and some chose to write the documentation in Danish, as is the case with this one.\n    </p>\n    <p>\n        Unless you have an explicit, enforced policy, you might run into a similar situation in software documentation. I've seen more than one example of software documentation written in Danish, simply because the programmer who wrote it didn't consider anything else than his or her native language. I'm sure most Europeans have similar experiences.\n    </p>\n    <p>\n        The text on the tile says, from the top and clockwise:\n    </p>\n    <ul>\n        <li>light brown dog/light snout/dark ears</li>\n        <li>dark brown, white/snout</li>\n        <li>orange tail/brown spots on/back</li>\n        <li>orange tail/orange back</li>\n    </ul>\n    <p>\n        Notice the disregard for capitalization rules or punctuation, a tendency among programmers that I've commented upon in <a href=\"/2021/06/14/new-book-code-that-fits-in-your-head\">Code That Fits in Your Head</a>.\n    </p>\n    <p>\n        In addition to the text, the back of the above tile also includes six arrows. Four of them ought to be self-evident, but can you figure out what the two larger arrows indicate?\n    </p>\n    <p>\n        It turns out that the person writing this piece of documentation eventually realized that the description should be mirrored, because it was on the backside of the tile. To be fair to that person, I'd asked everyone to write with a permanent marker or pen, so correcting a mistake involved either a 'hack' like the two arrows, or starting over from scratch.\n    </p>\n    <p>\n        Let's look at some more 'documentation'. Another tile looks like this:\n    </p>\n    <p>\n        <img src=\"/content/binary/tile3-doc.jpg\" alt=\"The back of a tile, with some fairly cryptic symbols in the corners.\" width=\"200\">\n    </p>\n    <p>\n        At first glance, I thought those symbols were Greek letters, but once you look at it, you start to realize what's going on. In the upper right corner, you see a stylized back and tail. Likewise, the lower left corner has a stylized face in the form of a smiley. The lines then indicate that the sides indicated by a corner has a head or tail.\n    </p>\n    <p>\n        Additionally, each side is encoded with a letter. I'll leave it as an exercise for the reader to figure out what <em>G</em> and <em>B</em> indicate, but also notice the two examples of a modified <em>R</em>. The one to the right indicates <em>red with spots</em>, and the other one uses the minus symbol to indicate <em>red without spots</em>.\n    </p>\n    <p>\n        On the one hand, this example does an admirable job of eliminating the irrelevant, but you may also find that it errs on the side of terseness. At the very least, it demands of the reader that he or she is already intimately familiar with the overall problem domain. You have to know the game well enough to be able to figure out that <em>R-</em> probably means <em>red without spots</em>.\n    </p>\n    <p>\n        Had this been software documentation, we might have been less than happy with this level of information. It may meet formal requirements, but is perhaps too idiosyncratic or esoteric.\n    </p>\n    <p>\n        Be that as it may, it's also possible to err on the other side.\n    </p>\n    <p>\n        <img src=\"/content/binary/Tile5-doc.jpg\" alt=\"The back of a tile, this time with an almost one-to-one replica of the picture on the front.\" width=\"200\">\n    </p>\n    <p>\n        In this example, the person writing the documentation essentially copied and described every detail on the front of the tile. Having no colours available, the person instead chose to describe in words the colour of each dog. Metaphorically speaking, the documentation replicates the implementation. It doesn't eliminate any irrelevant detail, and thereby it also fails to amplify the essential.\n    </p>\n    <p>\n        Here's another interesting example:\n    </p>\n    <p>\n        <img src=\"/content/binary/tile8-doc.jpg\" alt=\"The back of a tile, with text along all four sides.\" width=\"200\">\n    </p>\n    <p>\n        The text is in Danish. From the top clockwise, it says:\n    </p>\n    <ul>\n        <li>dark brown dog with blue collar</li>\n        <li>light brown dog with red collar</li>\n        <li>brown dog with small spots on back</li>\n        <li>Brown dog with big spots on back</li>\n    </ul>\n    <p>\n        Notice how the person writing this were aware that a tile has no natural up or down. Instead, each side is described with letters facing up when that side is up. You have to rotate the documentation in order to read all four sides. You may find that impractical, but I actually consider that to represent something essential about each tile. To me, this is positive.\n    </p>\n    <p>\n        Even so, an important piece of information is missing. It doesn't say which sides have heads, and which ones have tails.\n    </p>\n    <p>\n        Finally, here's one that, in my eyes, amplifies the essential and eliminates the irrelevant:\n    </p>\n    <p>\n        <img src=\"/content/binary/tile6-doc.jpg\" alt=\"The back of a tile, with text along all four sides.\" width=\"200\">\n    </p>\n    <p>\n        Like the previous example, you have to rotate the documentation in order to read all four sides, but the text is much terser. If you ask me, <em>Grey head</em>, <em>Burnt umber tail</em>, <em>Brown tail</em>, and <em>Spotted head</em> amplifies the essential and eliminates everything else.\n    </p>\n    <p>\n        Notice, however, how inconsistent the documentation is. People chose various different ways in their attempt to communicate what they found important. Some people inadvertently left out essential information. Other people provided too much information. Some people never came through, so in a few cases, documentation was entirely absent. And finally, I've hinted at this already, most people forgot to 'mirror' the information, but a few did remember.\n    </p>\n    <p>\n        All of this has direct counterparts in software documentation. The level of detail you get from documentation varies greatly, and often, the information that I actually care about is absent: Can I call this method with a negative number? Does the input string need to be formatted in a particular way? Does the method ever return null? Which exceptions may it throw?\n    </p>\n    <p>\n        I'm not against documentation, but it has limitations. As far as I can tell, though, that's your only option if you're working in a dynamically typed language.\n    </p>\n    <h3 id=\"dfb325aa94c6490b8ecbb36107d8be32\">\n        Static types with limited expression <a href=\"#dfb325aa94c6490b8ecbb36107d8be32\">#</a>\n    </h3>\n    <p>\n        Can you think of a way to constrain which puzzle pieces fit together with other pieces?\n    </p>\n    <p>\n        That's how <a href=\"https://en.wikipedia.org/wiki/Jigsaw_puzzle\">jigsaw puzzles</a> work. As a first attempt, we may try to cut out out the pieces like this:\n    </p>\n    <p>\n        <img src=\"/content/binary/one-jigsaw-tile.png\" alt=\"An anonymous jigsaw puzzle piece\" width=\"226\">\n    </p>\n    <p>\n        This does help some, because when presented with the subtask of having to locate and find the next piece, at least we can't rotate the next piece in four different positions. Instead, we have only two options. Perhaps we'll choose to lay down the next piece like this:\n    </p>\n    <p>\n        <img src=\"/content/binary/two-jigsaw-tiles.png\" alt=\"Two anonymous jigsaw pieces fit together\" width=\"426\">\n    </p>\n    <p>\n        You may also decide to rotate the right piece ninety degrees clockwise, but those are your only two rotation options.\n    </p>\n    <p>\n        We may decide to encode the shape of the pieces so that, say, the tabs indicate heads and the indentations indicate tails. This, at least, prevents us from joining head with head, or tail with tail.\n    </p>\n    <p>\n        This strikes me as an apt metaphor for <a href=\"https://en.wikipedia.org/wiki/C_(programming_language)\">C</a>, or how many programmers use the type systems of C# or <a href=\"https://www.java.com/\">Java</a>. It does prevent some easily preventable mistakes, but the types still don't carry enough information to enable you to identify exactly the pieces you need.\n    </p>\n    <h3 id=\"2196a52cce924b1ab0998f6a840a3e6c\">\n        More expressive static types <a href=\"#2196a52cce924b1ab0998f6a840a3e6c\">#</a>\n    </h3>\n    <p>\n        Static type systems come in various forms, and some are more expressive than others. To be honest, C#'s type system does come with good expressive powers, although it tends to <a href=\"/2019/12/16/zone-of-ceremony\">require much ceremony</a>. As far as I can tell, Java's type system is on par with C#. Let's assume that we either take the time to jump through the hoops that make these type systems expressive, or that we're using a language with a more expressive type system.\n    </p>\n    <p>\n        In the puzzle metaphor, we may decide to give a tile this shape:\n    </p>\n    <p>\n        <img src=\"/content/binary/strongly-typed-tile.png\" alt=\"A jigsaw puzzle piece with four distinct tab and indentation shapes.\" width=\"225\">\n    </p>\n    <p>\n        Such a shape encodes all the information that we need, because each tab or indentation has a unique shape. We may not even have to remember exactly what a square indentation represents. If we're presented with the above tile and asked to lay down a compatible tile, we have to find one with a square tab.\n    </p>\n    <p>\n        <img src=\"/content/binary/strongly-typed-tile-pair.png\" alt=\"Two jigsaw puzzle pieces with distinct tab and indentation shapes, arranged so that they fit together.\" width=\"425\">\n    </p>\n    <p>\n        Encoding the essential information into tile <em>shapes</em> enables us to not only prevent mistakes, but identify the correct composition of all the tiles.\n    </p>\n    <p>\n        <img src=\"/content/binary/strongly-typed-completed-puzzle.png\" alt=\"Completed puzzle with nine distinctly shaped pieces.\" width=\"625\">\n    </p>\n    <p>\n        For years, I've thought about static types as <em>shapes</em> of objects or functions. For practical purposes, <a href=\"/2022/08/22/can-types-replace-validation\">static types can't express everything</a> an operation may do, but I find it useful to use a good type system to my advantage.\n    </p>\n    <h3 id=\"5342222c3624472ab9b638aff7ecc65e\">\n        Code examples <a href=\"#5342222c3624472ab9b638aff7ecc65e\">#</a>\n    </h3>\n    <p>\n        You may find this a nice metaphor, and still fail to see how it translates to actual code. I'm not going to go into details here, but rather point to existing articles that give some introductions.\n    </p>\n    <p>\n        One place to start is to refactor <a href=\"/2015/01/19/from-primitive-obsession-to-domain-modelling\">from primitive obsession to domain models</a>. Just wrapping a string or an integer in a <a href=\"https://www.hillelwayne.com/post/constructive/\">predicative type</a> helps communicate the purpose and constraints of a data type. Consider a constructor like this:\n    </p>\n\t<p>\n\t\t<pre><span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:#2b91af;\">Reservation</span>(\n&nbsp;&nbsp;&nbsp;&nbsp;Guid&nbsp;id,\n&nbsp;&nbsp;&nbsp;&nbsp;DateTime&nbsp;at,\n&nbsp;&nbsp;&nbsp;&nbsp;Email&nbsp;email,\n&nbsp;&nbsp;&nbsp;&nbsp;Name&nbsp;name,\n&nbsp;&nbsp;&nbsp;&nbsp;NaturalNumber&nbsp;quantity)</pre>\n\t</p>\n    <p>\n        While hardly sophisticated, it already communicates much information about preconditions for creating a <code>Reservation</code> object. Some of the constituent types (<code>Guid</code> and <code>DateTime</code>) are built in, so likely well-known to any developer working on a relevant code base. If you're wondering whether you can create a reservation with a negative <code>quantity</code>, the types already answer that.\n    </p>\n    <p>\n        Languages with native support for <a href=\"https://en.wikipedia.org/wiki/Tagged_union\">sum types</a> let you easily model mutually exclusive, heterogeneous closed type hierarchies, as shown in <a href=\"/2016/11/28/easy-domain-modelling-with-types\">this example</a>:\n    </p>\n\t<p>\n\t\t<pre><span style=\"color:blue;\">type</span>&nbsp;<span style=\"color:teal;\">PaymentService</span>&nbsp;=&nbsp;{&nbsp;Name&nbsp;:&nbsp;<span style=\"color:teal;\">string</span>;&nbsp;Action&nbsp;:&nbsp;<span style=\"color:teal;\">string</span>&nbsp;}\n \n<span style=\"color:blue;\">type</span>&nbsp;<span style=\"color:teal;\">PaymentType</span>&nbsp;=\n|&nbsp;<span style=\"color:navy;\">Individual</span>&nbsp;<span style=\"color:blue;\">of</span>&nbsp;<span style=\"color:teal;\">PaymentService</span>\n|&nbsp;<span style=\"color:navy;\">Parent</span>&nbsp;<span style=\"color:blue;\">of</span>&nbsp;<span style=\"color:teal;\">PaymentService</span>\n|&nbsp;<span style=\"color:navy;\">Child</span>&nbsp;<span style=\"color:blue;\">of</span>&nbsp;originalTransactionKey&nbsp;:&nbsp;<span style=\"color:teal;\">string</span>&nbsp;*&nbsp;paymentService&nbsp;:&nbsp;<span style=\"color:teal;\">PaymentService</span></pre>\n\t</p>\n    <p>\n        And if your language doesn't natively support sum types, you can <a href=\"/2018/06/25/visitor-as-a-sum-type\">emulate them with the Visitor design pattern</a>.\n    </p>\n    <p>\n        You can, in fact, do some <a href=\"/2025/02/03/modelling-data-relationships-with-c-types\">quite sophisticated tricks even with .NET's type system</a>.\n    </p>\n    <h3 id=\"783cb14749b64aafac68d97a0096b349\">\n        Conclusion <a href=\"#783cb14749b64aafac68d97a0096b349\">#</a>\n    </h3>\n    <p>\n        People often argue about static types with the assumption that their main use is to prevent mistakes. They can help do that, too, but I also find static types an excellent communication medium. The benefits of using a static type system to model contracts is that, when a type system is already part of a language, it's a consistent, formalized framework for communication. Instead of inconsistent and idiosyncratic documentation, you can embed much information about a contract in the types of an API.\n    </p>\n    <p>\n        And indeed, not only can the types help communicate pre- and postconditions. The type checker <em>also</em> prevents errors.\n    </p>\n    <p>\n        A sufficiently sophisticated type system carries more information that most people realize. When I write <a href=\"https://www.haskell.org/\">Haskell</a> code, I often need to look up a function that I need. Contrary to other languages, I don't try to search for a function by guessing what name it might have. Rather, the <a href=\"https://hoogle.haskell.org/\">Hoogle</a> search engine enables you to search for a function <em>by type</em>.\n    </p>\n    <p>\n        Types are shapes, and shapes are like outlines of objects. Used well, they enable you to eliminate the irrelevant, and amplify the essential information about an API.\n    </p>\n</div><hr>\n      This blog is totally free, but if you like it, please consider <a href=\"https://blog.ploeh.dk/support\">supporting it</a>.",
    "sanitized": "A metaphor.\n    \n    \n        While I'm still struggling with the notion that dynamically typed languages may have compelling advantages, I keep coming back to the benefits of statically typed languages. One such benefit is how it enables the communication of contracts, as I recently discussed in Encapsulating rod-cutting.\n    \n    \n        As usual, I base my treatment of encapsulation on my reading of Bertrand Meyer's seminal Object-Oriented Software Construction. A major aspect of encapsulation is the explicit establishment of contracts. What is expected of client code before it can invoke an operation (preconditions)? What is guaranteed to be true after the operation completes (postconditions)? And what is always true of a particular data structure (invariants)?\n    \n    \n        Contracts constitute the practical part of encapsulation. A contract can give you a rough sense of how well-encapsulated an API is: The more statements you can utter about the contract, the better encapsulation. You may even be able to take all those assertions about the contract and implement them as property-based tests. In other words, if you can think of many properties to write as tests, the API in question probably has good encapsulation. If, on the other hand, you can't think of a single precondition, postcondition, or invariant, this may indicate that encapsulation is lacking.\n    \n    \n        Contracts are the practical part of encapsulation. The overall notion provides guidance of how to achieve encapsulation. Specific contracts describe what is possible, and how to successfully interact with an API. Clearly, the what and how.\n    \n    \n        They don't, however, explain why encapsulation is valuable.\n    \n    \n        Why encapsulate? #\n    \n    \n        Successful code bases are big. Such a code base rarely fits in your head in its entirety. And the situation is only exacerbated by multiple programmers working concurrently on the code. Even if you knew most of the code base by heart, your team members are changing it, and you aren't going to be aware of all the modifications.\n    \n    \n        Encapsulation offers a solution to this problem. Instead of knowing every detail of the entire code base, encapsulation should enable you to interact with an API (originally, an object) without knowing all the implementation details. This is the raison d'être of contracts. Ideally, knowing the contract and the purpose of an object and its methods should be enough.\n    \n    \n        Imagine that you've designed an API with a strong contract. Is your work done? Not yet. Somehow, you'll have to communicate the contract to all present and future client developers.\n    \n    \n        How do you convey a contract to potential users? I can think of a few ways. Good names are important, but only skin-deep. You can also publish documentation, or use the type system. The following metaphor explores those two alternatives.\n    \n    \n        Doing a puzzle #\n    \n    \n        When I was a boy, I had a puzzle called Das verflixte Hunde-Spiel, which roughly translates to the confounded dog game. I've previously described the game and an algorithm for solving it, but that's not my concern here. Rather, I'd like to discuss how one might abstract the information carried by each tile.\n    \n    \n        \n    \n    \n        As the picture suggests, the game consists of nine square tiles, each with two dog heads and two tails. The objective of the puzzle is to lay all nine tiles in a three-by-three grid such that all the heads fit the opposing tails. The dogs come in four different colour patterns, and each head must fit a tail of the same pattern.\n    \n    \n        It turns out that there are umpteen variations of this kind of puzzle. This one has cartoon dogs, but you can find similar games with frogs, cola bottles, playing card suits, trains, ladybirds, fast food, flowers, baseball players, owls, etc. This suggests that a generalization may exist. Perhaps an abstraction, even.\n    \n\t\n\t\t\n\t\t\t\"Abstraction is the elimination of the irrelevant and the amplification of the essential\"\n\t\t\n\t\tRobert C. Martin, Designing Object-Oriented C++ Applications Using The Booch Method, ch. 00\n\t\n    \n        How to eliminate the irrelevant and amplify the essential of a tile?\n    \n    \n        To recapitulate, a single tile looks like this:\n    \n    \n        \n    \n    \n        In a sense, we may regard most of the information on such a tile as 'implementation details'. In a code metaphor, imagine looking at a tile like this as being equivalent to looking at the source code of a method or function (i.e. API). That's not the essence we need to correctly assemble the puzzle.\n    \n    \n        Imagine that you have to lay down the tiles according to a known solution. Since you already know the solution, this task only involves locating and placing each of the nine tiles. In this case, there are only nine tiles, each with four possible rotations, so if you already know what you're looking for, that is, of course, a tractable endeavour.\n    \n    \n        Now imagine that you'd like to undertake putting together the tiles without having to navigate by the full information content of each tile. In programming, we often need to do this. We have to identify objects that are likely to perform some subtask for us, and we have to figure out how to interact with such an object to achieve our goals. Preferably, we'd like to be able to do this without having to read all the source code of the candidate object. Encapsulation promises that this should be possible.\n    \n    \n        The backside of the tiles #\n    \n    \n        If we want to eliminate the irrelevant, we have to hide the information on each tile. As a first step, consider what happens if we flip the tiles around so that we only see their backs.\n    \n    \n        \n    \n    \n        Obviously, each backside is entirely devoid of information, which means that we're now flying blind. Even if we know how to solve the puzzle, our only recourse is to blindly pick and rotate each of the nine tiles. As the previous article calculated, when picking at random, the odds of arriving at any valid solution is 1 to 5,945,425,920. Not surprisingly, total absence of information doesn't work.\n    \n    \n        We already knew that, because, while we want to eliminate the irrelevant, we also must amplify the essential. Thus, we need to figure out what that might be.\n    \n    \n        Perhaps we could write the essential information on the back of each tile. In the metaphor, this would correspond to writing documentation for an API.\n    \n    \n        Documentation #\n    \n    \n        To continue the metaphor, I asked various acquaintances to each 'document' a title. I deliberately only gave them the instruction that they should enable me to assemble the puzzle based on what was on the back of each tile. Some asked for additional directions, as to format, etc., but I refused to give any. People document code in various different ways, and I wanted to capture similar variation. Let's review some of the documentation I received.\n    \n    \n        \n    \n    \n        Since I asked around among acquaintances, all respondents were Danes, and some chose to write the documentation in Danish, as is the case with this one.\n    \n    \n        Unless you have an explicit, enforced policy, you might run into a similar situation in software documentation. I've seen more than one example of software documentation written in Danish, simply because the programmer who wrote it didn't consider anything else than his or her native language. I'm sure most Europeans have similar experiences.\n    \n    \n        The text on the tile says, from the top and clockwise:\n    \n    \n        light brown dog/light snout/dark ears\n        dark brown, white/snout\n        orange tail/brown spots on/back\n        orange tail/orange back\n    \n    \n        Notice the disregard for capitalization rules or punctuation, a tendency among programmers that I've commented upon in Code That Fits in Your Head.\n    \n    \n        In addition to the text, the back of the above tile also includes six arrows. Four of them ought to be self-evident, but can you figure out what the two larger arrows indicate?\n    \n    \n        It turns out that the person writing this piece of documentation eventually realized that the description should be mirrored, because it was on the backside of the tile. To be fair to that person, I'd asked everyone to write with a permanent marker or pen, so correcting a mistake involved either a 'hack' like the two arrows, or starting over from scratch.\n    \n    \n        Let's look at some more 'documentation'. Another tile looks like this:\n    \n    \n        \n    \n    \n        At first glance, I thought those symbols were Greek letters, but once you look at it, you start to realize what's going on. In the upper right corner, you see a stylized back and tail. Likewise, the lower left corner has a stylized face in the form of a smiley. The lines then indicate that the sides indicated by a corner has a head or tail.\n    \n    \n        Additionally, each side is encoded with a letter. I'll leave it as an exercise for the reader to figure out what G and B indicate, but also notice the two examples of a modified R. The one to the right indicates red with spots, and the other one uses the minus symbol to indicate red without spots.\n    \n    \n        On the one hand, this example does an admirable job of eliminating the irrelevant, but you may also find that it errs on the side of terseness. At the very least, it demands of the reader that he or she is already intimately familiar with the overall problem domain. You have to know the game well enough to be able to figure out that R- probably means red without spots.\n    \n    \n        Had this been software documentation, we might have been less than happy with this level of information. It may meet formal requirements, but is perhaps too idiosyncratic or esoteric.\n    \n    \n        Be that as it may, it's also possible to err on the other side.\n    \n    \n        \n    \n    \n        In this example, the person writing the documentation essentially copied and described every detail on the front of the tile. Having no colours available, the person instead chose to describe in words the colour of each dog. Metaphorically speaking, the documentation replicates the implementation. It doesn't eliminate any irrelevant detail, and thereby it also fails to amplify the essential.\n    \n    \n        Here's another interesting example:\n    \n    \n        \n    \n    \n        The text is in Danish. From the top clockwise, it says:\n    \n    \n        dark brown dog with blue collar\n        light brown dog with red collar\n        brown dog with small spots on back\n        Brown dog with big spots on back\n    \n    \n        Notice how the person writing this were aware that a tile has no natural up or down. Instead, each side is described with letters facing up when that side is up. You have to rotate the documentation in order to read all four sides. You may find that impractical, but I actually consider that to represent something essential about each tile. To me, this is positive.\n    \n    \n        Even so, an important piece of information is missing. It doesn't say which sides have heads, and which ones have tails.\n    \n    \n        Finally, here's one that, in my eyes, amplifies the essential and eliminates the irrelevant:\n    \n    \n        \n    \n    \n        Like the previous example, you have to rotate the documentation in order to read all four sides, but the text is much terser. If you ask me, Grey head, Burnt umber tail, Brown tail, and Spotted head amplifies the essential and eliminates everything else.\n    \n    \n        Notice, however, how inconsistent the documentation is. People chose various different ways in their attempt to communicate what they found important. Some people inadvertently left out essential information. Other people provided too much information. Some people never came through, so in a few cases, documentation was entirely absent. And finally, I've hinted at this already, most people forgot to 'mirror' the information, but a few did remember.\n    \n    \n        All of this has direct counterparts in software documentation. The level of detail you get from documentation varies greatly, and often, the information that I actually care about is absent: Can I call this method with a negative number? Does the input string need to be formatted in a particular way? Does the method ever return null? Which exceptions may it throw?\n    \n    \n        I'm not against documentation, but it has limitations. As far as I can tell, though, that's your only option if you're working in a dynamically typed language.\n    \n    \n        Static types with limited expression #\n    \n    \n        Can you think of a way to constrain which puzzle pieces fit together with other pieces?\n    \n    \n        That's how jigsaw puzzles work. As a first attempt, we may try to cut out out the pieces like this:\n    \n    \n        \n    \n    \n        This does help some, because when presented with the subtask of having to locate and find the next piece, at least we can't rotate the next piece in four different positions. Instead, we have only two options. Perhaps we'll choose to lay down the next piece like this:\n    \n    \n        \n    \n    \n        You may also decide to rotate the right piece ninety degrees clockwise, but those are your only two rotation options.\n    \n    \n        We may decide to encode the shape of the pieces so that, say, the tabs indicate heads and the indentations indicate tails. This, at least, prevents us from joining head with head, or tail with tail.\n    \n    \n        This strikes me as an apt metaphor for C, or how many programmers use the type systems of C# or Java. It does prevent some easily preventable mistakes, but the types still don't carry enough information to enable you to identify exactly the pieces you need.\n    \n    \n        More expressive static types #\n    \n    \n        Static type systems come in various forms, and some are more expressive than others. To be honest, C#'s type system does come with good expressive powers, although it tends to require much ceremony. As far as I can tell, Java's type system is on par with C#. Let's assume that we either take the time to jump through the hoops that make these type systems expressive, or that we're using a language with a more expressive type system.\n    \n    \n        In the puzzle metaphor, we may decide to give a tile this shape:\n    \n    \n        \n    \n    \n        Such a shape encodes all the information that we need, because each tab or indentation has a unique shape. We may not even have to remember exactly what a square indentation represents. If we're presented with the above tile and asked to lay down a compatible tile, we have to find one with a square tab.\n    \n    \n        \n    \n    \n        Encoding the essential information into tile shapes enables us to not only prevent mistakes, but identify the correct composition of all the tiles.\n    \n    \n        \n    \n    \n        For years, I've thought about static types as shapes of objects or functions. For practical purposes, static types can't express everything an operation may do, but I find it useful to use a good type system to my advantage.\n    \n    \n        Code examples #\n    \n    \n        You may find this a nice metaphor, and still fail to see how it translates to actual code. I'm not going to go into details here, but rather point to existing articles that give some introductions.\n    \n    \n        One place to start is to refactor from primitive obsession to domain models. Just wrapping a string or an integer in a predicative type helps communicate the purpose and constraints of a data type. Consider a constructor like this:\n    \n\t\n\t\tpublic Reservation(\n    Guid id,\n    DateTime at,\n    Email email,\n    Name name,\n    NaturalNumber quantity)\n\t\n    \n        While hardly sophisticated, it already communicates much information about preconditions for creating a Reservation object. Some of the constituent types (Guid and DateTime) are built in, so likely well-known to any developer working on a relevant code base. If you're wondering whether you can create a reservation with a negative quantity, the types already answer that.\n    \n    \n        Languages with native support for sum types let you easily model mutually exclusive, heterogeneous closed type hierarchies, as shown in this example:\n    \n\t\n\t\ttype PaymentService = { Name : string; Action : string }\n \ntype PaymentType =\n| Individual of PaymentService\n| Parent of PaymentService\n| Child of originalTransactionKey : string * paymentService : PaymentService\n\t\n    \n        And if your language doesn't natively support sum types, you can emulate them with the Visitor design pattern.\n    \n    \n        You can, in fact, do some quite sophisticated tricks even with .NET's type system.\n    \n    \n        Conclusion #\n    \n    \n        People often argue about static types with the assumption that their main use is to prevent mistakes. They can help do that, too, but I also find static types an excellent communication medium. The benefits of using a static type system to model contracts is that, when a type system is already part of a language, it's a consistent, formalized framework for communication. Instead of inconsistent and idiosyncratic documentation, you can embed much information about a contract in the types of an API.\n    \n    \n        And indeed, not only can the types help communicate pre- and postconditions. The type checker also prevents errors.\n    \n    \n        A sufficiently sophisticated type system carries more information that most people realize. When I write Haskell code, I often need to look up a function that I need. Contrary to other languages, I don't try to search for a function by guessing what name it might have. Rather, the Hoogle search engine enables you to search for a function by type.\n    \n    \n        Types are shapes, and shapes are like outlines of objects. Used well, they enable you to eliminate the irrelevant, and amplify the essential information about an API.\n    \n\n      This blog is totally free, but if you like it, please consider supporting it."
  },
  {
    "itemId": "https://blog.ploeh.dk/2025/02/17/in-defence-of-multiple-wip",
    "raw": "\n\n\n<div id=\"post\">\n    <p>\n        <em>Programming isn't like factory work.</em>\n    </p>\n    <p>\n        I was recently stuck on a programming problem. Specifically, <a href=\"https://adventofcode.com/2024/day/19\">part two of an Advent of Code puzzle</a>, if you must know. As is my routine, I went for a run, which always helps to get unstuck. During the few hours away from the keyboard, I'd had a new idea. When I returned to the computer, I had my new algorithm implemented in about an hour, and it calculated the correct result in sub-second time.\n    </p>\n    <p>\n        I'm not writing this to brag. On the contrary, I suck at Advent of Code (which is a major <a href=\"/2020/01/13/on-doing-katas\">reason that I do it</a>). The point is rather that programming is fundamentally non-linear in effort. Not only are some algorithms orders of magnitudes faster than other algorithms, but it's also the case that the amount of time you put into solving a problem doesn't always correlate with the outcome.\n    </p>\n    <p>\n        Sometimes, the most productive way to solve a problem is to let it rest and <em>go do something else</em>.\n    </p>\n    <h3 id=\"007252aeb07e4b0c9c514185a7f9699f\">\n        One-piece flow <a href=\"#007252aeb07e4b0c9c514185a7f9699f\">#</a>\n    </h3>\n    <p>\n        Doesn't this conflict with the ideal of one-piece flow? That is, that you should only have one piece of work in progress (WiP).\n    </p>\n    <p>\n        Yes, it does.\n    </p>\n    <p>\n        It's not that I don't understand basic queue theory, haven't read <a href=\"/ref/the-goal\">The Goal</a>, or that I'm unaware of the <a href=\"https://youtu.be/Yqi9Gwt-OEA?si=9qLo77p3iJZKBwcx\">compelling explanations given by, among other people, Henrik Kniberg</a>. I do, myself, <a href=\"/2023/01/23/agilean\">lean (pun intended) towards lean software development</a>.\n    </p>\n    <p>\n        I only offer the following as a counterpoint to other voices. As I've described before, when I seem to disagree with the mainstream view on certain topics, the explanation may rather be that <a href=\"/2021/08/09/am-i-stuck-in-a-local-maximum\">I'm concerned with a different problem than other people are</a>. If your problem is a dysfunctional organization where everyone have dozens of tasks in progress, nothing ever gets done because it's considered more important to start new work items than completing ongoing work, where 'utilization' is at 100% because of 'efficiency', then yes, I'd also recommend limiting WiP.\n    </p>\n    <p>\n        The idea in one-piece flow is that you're only working on one thing at a time.\n    </p>\n    <p>\n        <img src=\"/content/binary/one-piece-flow2.png\" alt=\"One-piece flow illustrated as a series of boxes in a row.\">\n    </p>\n    <p>\n        Perhaps you can divide the task into subtasks, but you're only supposed to start something new when you're done with the current job. Compared to the alternative of starting a lot concurrent tasks in order to deal with wait times in the system, I agree with the argument that this is often better. One-piece flow often prompts you to take a good, hard look at where and how delays occur in your process.\n    </p>\n    <p>\n        Even so, I find it ironic that most of 'the Lean squad' is so busy blaming <a href=\"https://en.wikipedia.org/wiki/Scientific_management\">Taylorism</a> for everything that's wrong with many software development organizations, only to go advocate for another management style rooted in factory work.\n    </p>\n    <p>\n        Programming isn't manufacturing.\n    </p>\n    <h3 id=\"28c7eb05dd1342d7a3140aae5618db4f\">\n        Urgent or important <a href=\"#28c7eb05dd1342d7a3140aae5618db4f\">#</a>\n    </h3>\n    <p>\n        As <a href=\"https://en.wikipedia.org/wiki/Dwight_D._Eisenhower\">Eisenhower</a> quoted an unnamed college president:\n    </p>\n    <blockquote>\n        <p>\n            \"I have two kinds of problems, the urgent and the important. The urgent are not important, and the important are never urgent.\"\n        </p>\n    </blockquote>\n    <p>\n        It's hard to overstate how liberating it can be to ignore the urgent and focus on the important. Over decades, I keep returning to the realization that you often reach the best solutions to software problems by letting them stew.\n    </p>\n    <p>\n        I'm sure I've already told the following story elsewhere, but it bears repeating. Back in 2009 I started an open-source project called <a href=\"https://github.com/AutoFixture/AutoFixture\">AutoFixture</a> and also managed to convince my then-employer, <a href=\"https://www.safewhere.com/\">Safewhere</a>, to use it in our code base.\n    </p>\n    <p>\n        Maintaining or evolving AutoFixture wasn't my job, though. It was a work-related hobby, so nothing related to it was urgent. When in the office, I worked on Safewhere code, but biking back and forth between home and work, I thought about AutoFixture problems. Often, these problems would be informed by how we used it in Safewhere. My point is that the problems I was thinking about were real problems that I'd encountered in my day job, not just something I'd dreamt up for fun.\n    </p>\n    <p>\n        I was mostly thinking about API designs. Given that this was ideally a general-purpose open-source project, I didn't want to solve narrow problems with specific solutions. I wanted to find general designs that would address not only the immediate concerns, but also other problems that I had yet to discover.\n    </p>\n    <p>\n        Many an evening I spent trying out an idea I'd had on my bicycle. Often, it turned out that the idea wouldn't work. While that might be, in one sense, dismaying, on the other hand, it only meant that I'd <a href=\"https://quoteinvestigator.com/2012/07/31/edison-lot-results/\">learned about yet another way that didn't work</a>.\n    </p>\n    <p>\n        Because there was no pressure to release a new version of AutoFixture, I could take the time to get it right. (After a fashion. You may disagree with the notion that AutoFixture is well-designed. I designed its APIs to the best of my abilities during the decade I lead the project. And when I discovered property-based testing, I <a href=\"https://github.com/AutoFixture/AutoFixture/issues/703\">passed on the reins</a>.)\n    </p>\n    <h3 id=\"ae07d9022e714de689fc1900d68a866d\">\n        Get there earlier by starting later <a href=\"#ae07d9022e714de689fc1900d68a866d\">#</a>\n    </h3>\n    <p>\n        There's a 1944 science fiction short story by <a href=\"https://en.wikipedia.org/wiki/A._E._van_Vogt\">A. E. van Vogt</a> called <a href=\"https://en.wikipedia.org/wiki/Far_Centaurus\">Far Centaurus</a> that I'm now going to spoil.\n    </p>\n    <p>\n        In it, four astronauts embark on a 500-year journey to <a href=\"https://en.wikipedia.org/wiki/Alpha_Centauri\">Alpha Centauri</a>, using <a href=\"https://en.wikipedia.org/wiki/Suspended_animation_in_fiction\">suspended animation</a>. When they arrive, they discover that the system is long settled, from Earth.\n    </p>\n    <p>\n        During their 500 years en route, humans invented faster space travel. Even though later generations started later, they arrived earlier. They discovered a better way to get from a to b.\n    </p>\n    <p>\n        Compared to one-piece flow, we may illustrate this metaphor like this:\n    </p>\n    <p>\n        <img src=\"/content/binary/one-piece-flow-vs-thinking.png\" alt=\"A row of boxes above another row of thinner boxes that are more spread out, but indicates an earlier finish.\">\n    </p>\n    <p>\n        When presented with a problem, we don't start working on it right away. Or, we do, but the work we do is <em>thinking</em> rather than typing. We may even do some prototyping at that stage, but if no good solution presents itself, we put away the problem for a while.\n    </p>\n    <p>\n        We may return to the problem from time to time, and what may happen is that we realize that there's a much better, quicker way of accomplishing the goal than we first believed (as, again, <a href=\"/2025/02/10/geographic-hulls\">recently happened to me</a>). Once we have that realization, we may initiate the work, and it it may even turn out that we're done earlier than if we'd immediately started hacking at the problem.\n    </p>\n    <p>\n        By starting later, we've learned more. Like much knowledge work, software development is a profoundly non-linear endeavour. You may find a new way of doing things that are orders of magnitudes faster than what you originally had in mind. Not only in terms of <a href=\"https://en.wikipedia.org/wiki/Big_O_notation\">big-O notation</a>, but also in terms of implementation effort.\n    </p>\n    <p>\n        When doing Advent of Code, I've repeatedly been struck how the more efficient algorithm is often also simpler to implement.\n    </p>\n    <h3 id=\"95ed780f2c3b496383f1af9b68aa2b1b\">\n        Multiple WiP <a href=\"#95ed780f2c3b496383f1af9b68aa2b1b\">#</a>\n    </h3>\n    <p>\n        As the above figure suggests, you're probably not going to spend all your time thinking or doing. The figure has plenty of air in between the activities.\n    </p>\n    <p>\n        This may seem wasteful to efficiency nerds, but again: Knowledge work isn't factory work.\n    </p>\n    <p>\n        You can't think by command. If you've ever tried meditating, you'll know just how hard it is to empty your mind, or in any way control what goes on in your head. Focus on your breath. Indeed, and a few minutes later you snap out of a reverie about what to make for dinner, only to discover that you were able to focus on your breath for all of ten seconds.\n    </p>\n    <p>\n        As I already alluded to in the introduction, I regularly exercise during the work day. I also go grocery shopping, or do other chores. I've consistently found that I solve all hard problems when I'm <em>away</em> from the computer, not while I'm at it. I think <a href=\"https://en.wikipedia.org/wiki/Rich_Hickey\">Rich Hickey</a> calls it hammock-driven development.\n    </p>\n    <p>\n        When presented with an interesting problem, I usually can't help thinking about it. What often happens, however, is that I'm mulling over multiple interesting problems during my day.\n    </p>\n    <p>\n        <img src=\"/content/binary/multiple-thinking-processes-interleaved.png\" alt=\"Same diagram as above, but now with more boxes representing thinking activities interleaved among each other.\">\n    </p>\n    <p>\n        You could say that I actually have multiple pieces of work in progress. Some of them lie dormant for a long time, only to occasionally pop up and be put away again. Even so, I've had problems that I'd essentially given up on, only to resurface later when I'd learned a sufficient amount of new things. At that time, then, I sometimes realize that what I previously thought was impossible is actually quite simple.\n    </p>\n    <p>\n        It's amazing what you can accomplish when you focus on the things that are important, rather than the things that are urgent.\n    </p>\n    <h3 id=\"216b1e2dee074e249ad8044a6ad88a97\">\n        One size doesn't fit all <a href=\"#216b1e2dee074e249ad8044a6ad88a97\">#</a>\n    </h3>\n    <p>\n        How do I know that this will always work? How can I be sure that an orders-of-magnitude insight will occur if I just wait long enough?\n    </p>\n    <p>\n        There are no guarantees. My point is rather that this happens with surprising regularity. To me, at least.\n    </p>\n    <p>\n        Your software organization may include tasks that represent truly menial work. Yet, if you have too much of that, why haven't you automated it away?\n    </p>\n    <p>\n        Still, I'm not going to tell anyone how to run their development team. I'm only pointing out a weakness with the common one-piece narrative: It treats work as mostly a result of effort, and as if it were somehow interchangeable with other development tasks.\n    </p>\n    <p>\n        Most crucially, it models the amount of time required to complete a task as being independent of time: Whether you start a job today or in a month, it'll take <em>x</em> days to complete.\n    </p>\n    <p>\n        What if, instead, the effort was an function of time (as well as other factors)? The later you start, the simpler the work might be.\n    </p>\n    <p>\n        This of course doesn't happen automatically. Even if I have all my good ideas <em>away</em> from the keyboard, I still spend quite a bit of time <em>at</em> the keyboard. You need to work enough with a problem before inspiration can strike.\n    </p>\n    <p>\n        I'd recommend more slack time, more walks in the park, more grocery shopping, more doing the dishes.\n    </p>\n    <h3 id=\"ea87f59e4b014bb4861e71d8b6264394\">\n        Conclusion <a href=\"#ea87f59e4b014bb4861e71d8b6264394\">#</a>\n    </h3>\n    <p>\n        Programming is knowledge work. We may even consider it creative work. And while you can nurture creativity, you can't force it.\n    </p>\n    <p>\n        I find it useful to have multiple things going on at the same time, because concurrent tasks often cross-pollinate. What I learn from engaging with one task may produce a significant insight into another, otherwise unrelated problem. The lack of urgency, the lack of deadlines, foster this approach to problem-solving.\n    </p>\n    <p>\n        But I'm not going to tell you how to run your software development process. If you want to treat it as an assembly line, that's your decision.\n    </p>\n    <p>\n        You'll probably get work done anyway. Months of work can save days of thinking.\n    </p>\n</div>\n<hr>\n      This blog is totally free, but if you like it, please consider <a href=\"https://blog.ploeh.dk/support\">supporting it</a>.",
    "sanitized": "Programming isn't like factory work.\n    \n    \n        I was recently stuck on a programming problem. Specifically, part two of an Advent of Code puzzle, if you must know. As is my routine, I went for a run, which always helps to get unstuck. During the few hours away from the keyboard, I'd had a new idea. When I returned to the computer, I had my new algorithm implemented in about an hour, and it calculated the correct result in sub-second time.\n    \n    \n        I'm not writing this to brag. On the contrary, I suck at Advent of Code (which is a major reason that I do it). The point is rather that programming is fundamentally non-linear in effort. Not only are some algorithms orders of magnitudes faster than other algorithms, but it's also the case that the amount of time you put into solving a problem doesn't always correlate with the outcome.\n    \n    \n        Sometimes, the most productive way to solve a problem is to let it rest and go do something else.\n    \n    \n        One-piece flow #\n    \n    \n        Doesn't this conflict with the ideal of one-piece flow? That is, that you should only have one piece of work in progress (WiP).\n    \n    \n        Yes, it does.\n    \n    \n        It's not that I don't understand basic queue theory, haven't read The Goal, or that I'm unaware of the compelling explanations given by, among other people, Henrik Kniberg. I do, myself, lean (pun intended) towards lean software development.\n    \n    \n        I only offer the following as a counterpoint to other voices. As I've described before, when I seem to disagree with the mainstream view on certain topics, the explanation may rather be that I'm concerned with a different problem than other people are. If your problem is a dysfunctional organization where everyone have dozens of tasks in progress, nothing ever gets done because it's considered more important to start new work items than completing ongoing work, where 'utilization' is at 100% because of 'efficiency', then yes, I'd also recommend limiting WiP.\n    \n    \n        The idea in one-piece flow is that you're only working on one thing at a time.\n    \n    \n        \n    \n    \n        Perhaps you can divide the task into subtasks, but you're only supposed to start something new when you're done with the current job. Compared to the alternative of starting a lot concurrent tasks in order to deal with wait times in the system, I agree with the argument that this is often better. One-piece flow often prompts you to take a good, hard look at where and how delays occur in your process.\n    \n    \n        Even so, I find it ironic that most of 'the Lean squad' is so busy blaming Taylorism for everything that's wrong with many software development organizations, only to go advocate for another management style rooted in factory work.\n    \n    \n        Programming isn't manufacturing.\n    \n    \n        Urgent or important #\n    \n    \n        As Eisenhower quoted an unnamed college president:\n    \n    \n        \n            \"I have two kinds of problems, the urgent and the important. The urgent are not important, and the important are never urgent.\"\n        \n    \n    \n        It's hard to overstate how liberating it can be to ignore the urgent and focus on the important. Over decades, I keep returning to the realization that you often reach the best solutions to software problems by letting them stew.\n    \n    \n        I'm sure I've already told the following story elsewhere, but it bears repeating. Back in 2009 I started an open-source project called AutoFixture and also managed to convince my then-employer, Safewhere, to use it in our code base.\n    \n    \n        Maintaining or evolving AutoFixture wasn't my job, though. It was a work-related hobby, so nothing related to it was urgent. When in the office, I worked on Safewhere code, but biking back and forth between home and work, I thought about AutoFixture problems. Often, these problems would be informed by how we used it in Safewhere. My point is that the problems I was thinking about were real problems that I'd encountered in my day job, not just something I'd dreamt up for fun.\n    \n    \n        I was mostly thinking about API designs. Given that this was ideally a general-purpose open-source project, I didn't want to solve narrow problems with specific solutions. I wanted to find general designs that would address not only the immediate concerns, but also other problems that I had yet to discover.\n    \n    \n        Many an evening I spent trying out an idea I'd had on my bicycle. Often, it turned out that the idea wouldn't work. While that might be, in one sense, dismaying, on the other hand, it only meant that I'd learned about yet another way that didn't work.\n    \n    \n        Because there was no pressure to release a new version of AutoFixture, I could take the time to get it right. (After a fashion. You may disagree with the notion that AutoFixture is well-designed. I designed its APIs to the best of my abilities during the decade I lead the project. And when I discovered property-based testing, I passed on the reins.)\n    \n    \n        Get there earlier by starting later #\n    \n    \n        There's a 1944 science fiction short story by A. E. van Vogt called Far Centaurus that I'm now going to spoil.\n    \n    \n        In it, four astronauts embark on a 500-year journey to Alpha Centauri, using suspended animation. When they arrive, they discover that the system is long settled, from Earth.\n    \n    \n        During their 500 years en route, humans invented faster space travel. Even though later generations started later, they arrived earlier. They discovered a better way to get from a to b.\n    \n    \n        Compared to one-piece flow, we may illustrate this metaphor like this:\n    \n    \n        \n    \n    \n        When presented with a problem, we don't start working on it right away. Or, we do, but the work we do is thinking rather than typing. We may even do some prototyping at that stage, but if no good solution presents itself, we put away the problem for a while.\n    \n    \n        We may return to the problem from time to time, and what may happen is that we realize that there's a much better, quicker way of accomplishing the goal than we first believed (as, again, recently happened to me). Once we have that realization, we may initiate the work, and it it may even turn out that we're done earlier than if we'd immediately started hacking at the problem.\n    \n    \n        By starting later, we've learned more. Like much knowledge work, software development is a profoundly non-linear endeavour. You may find a new way of doing things that are orders of magnitudes faster than what you originally had in mind. Not only in terms of big-O notation, but also in terms of implementation effort.\n    \n    \n        When doing Advent of Code, I've repeatedly been struck how the more efficient algorithm is often also simpler to implement.\n    \n    \n        Multiple WiP #\n    \n    \n        As the above figure suggests, you're probably not going to spend all your time thinking or doing. The figure has plenty of air in between the activities.\n    \n    \n        This may seem wasteful to efficiency nerds, but again: Knowledge work isn't factory work.\n    \n    \n        You can't think by command. If you've ever tried meditating, you'll know just how hard it is to empty your mind, or in any way control what goes on in your head. Focus on your breath. Indeed, and a few minutes later you snap out of a reverie about what to make for dinner, only to discover that you were able to focus on your breath for all of ten seconds.\n    \n    \n        As I already alluded to in the introduction, I regularly exercise during the work day. I also go grocery shopping, or do other chores. I've consistently found that I solve all hard problems when I'm away from the computer, not while I'm at it. I think Rich Hickey calls it hammock-driven development.\n    \n    \n        When presented with an interesting problem, I usually can't help thinking about it. What often happens, however, is that I'm mulling over multiple interesting problems during my day.\n    \n    \n        \n    \n    \n        You could say that I actually have multiple pieces of work in progress. Some of them lie dormant for a long time, only to occasionally pop up and be put away again. Even so, I've had problems that I'd essentially given up on, only to resurface later when I'd learned a sufficient amount of new things. At that time, then, I sometimes realize that what I previously thought was impossible is actually quite simple.\n    \n    \n        It's amazing what you can accomplish when you focus on the things that are important, rather than the things that are urgent.\n    \n    \n        One size doesn't fit all #\n    \n    \n        How do I know that this will always work? How can I be sure that an orders-of-magnitude insight will occur if I just wait long enough?\n    \n    \n        There are no guarantees. My point is rather that this happens with surprising regularity. To me, at least.\n    \n    \n        Your software organization may include tasks that represent truly menial work. Yet, if you have too much of that, why haven't you automated it away?\n    \n    \n        Still, I'm not going to tell anyone how to run their development team. I'm only pointing out a weakness with the common one-piece narrative: It treats work as mostly a result of effort, and as if it were somehow interchangeable with other development tasks.\n    \n    \n        Most crucially, it models the amount of time required to complete a task as being independent of time: Whether you start a job today or in a month, it'll take x days to complete.\n    \n    \n        What if, instead, the effort was an function of time (as well as other factors)? The later you start, the simpler the work might be.\n    \n    \n        This of course doesn't happen automatically. Even if I have all my good ideas away from the keyboard, I still spend quite a bit of time at the keyboard. You need to work enough with a problem before inspiration can strike.\n    \n    \n        I'd recommend more slack time, more walks in the park, more grocery shopping, more doing the dishes.\n    \n    \n        Conclusion #\n    \n    \n        Programming is knowledge work. We may even consider it creative work. And while you can nurture creativity, you can't force it.\n    \n    \n        I find it useful to have multiple things going on at the same time, because concurrent tasks often cross-pollinate. What I learn from engaging with one task may produce a significant insight into another, otherwise unrelated problem. The lack of urgency, the lack of deadlines, foster this approach to problem-solving.\n    \n    \n        But I'm not going to tell you how to run your software development process. If you want to treat it as an assembly line, that's your decision.\n    \n    \n        You'll probably get work done anyway. Months of work can save days of thinking.\n    \n\n\n      This blog is totally free, but if you like it, please consider supporting it."
  },
  {
    "itemId": "https://blog.ploeh.dk/2025/02/10/geographic-hulls",
    "raw": "\n\n\n<div id=\"post\">\n    <p>\n        <em>Seven lines of Python code.</em>\n    </p>\n    <p>\n        Can you tell what this is?\n    </p>\n    <p>\n        <img src=\"/content/binary/dk-hull.svg\" alt=\"Convex hulls of each of the major Danish islands, as well as Jutland.\">\n    </p>\n    <p>\n        I showed this to both my wife and my son, and they immediately recognized it for what it is. On the other hand, they're also both culturally primed for it.\n    </p>\n    <p>\n        After all, it's a map of <a href=\"https://en.wikipedia.org/wiki/Denmark\">Denmark</a>, although I've transformed each of the major islands, as well as the peninsula of <a href=\"https://en.wikipedia.org/wiki/Jutland\">Jutland</a> to their <a href=\"https://en.wikipedia.org/wiki/Convex_hull\">convex hulls</a>.\n    </p>\n    <p>\n        Here's the original map I used for the transformation:\n    </p>\n    <p>\n        <img src=\"/content/binary/dk-outline.svg\" alt=\"Map of Denmark.\">\n    </p>\n    <p>\n        I had a reason to do this, having to do with <a href=\"https://en.wikipedia.org/wiki/Coastline_paradox\">the coastline paradox</a>, but my underlying motivation isn't really that important for this article, since I rather want to discuss how I did it.\n    </p>\n    <p>\n        The short answer is that I used <a href=\"https://www.python.org/\">Python</a>. You have to admit that Python has a fabulous ecosystem for all kinds of data crunching, including visualizations. I'd actually geared up to implementing a <a href=\"https://en.wikipedia.org/wiki/Graham_scan\">Graham scan</a> myself, but that turned out not to be necessary.\n    </p>\n    <h3 id=\"2c60300f58f645d7b45cad678b076ad4\">\n        GeoPandas to the rescue <a href=\"#2c60300f58f645d7b45cad678b076ad4\">#</a>\n    </h3>\n    <p>\n        I'm a novice Python programmer, but I've used <a href=\"https://matplotlib.org/\">Matplotlib</a> before to visualize data, so I found it natural to start with a few web searches to figure out how to get to grips with the problem.\n    </p>\n    <p>\n        I quickly found <a href=\"https://geopandas.org/\">GeoPandas</a>, which works on top of Matplotlib to render and visualize geographical data.\n    </p>\n    <p>\n        My next problem was to find a data set for Denmark, which <a href=\"https://simplemaps.com/gis/country/dk#all\">I found on SimpleMaps</a>. I chose to download and work with the <a href=\"https://geojson.org/\">GeoJSON</a> format.\n    </p>\n    <p>\n        Originally, I'd envisioned implementing a Graham scan myself. After all, <a href=\"/2015/10/19/visual-value-verification\">I'd done that before in F#</a>, and it's a compelling <a href=\"/2020/01/13/on-doing-katas\">exercise</a>. It turned out, however, that this function is already available in the GeoPandas API.\n    </p>\n    <p>\n        I had trouble separating the data file's multi-part geometry into multiple single geometries. This meant that when I tried to find the convex hull, I got the hull of the entire map, instead of each island individually. The solution was to use the <a href=\"https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.explode.html\">explode</a> function.\n    </p>\n    <p>\n        Once I figured that out, it turned out that all I needed was seven lines of Python code, including imports and a blank line:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">import</span>&nbsp;geopandas&nbsp;<span style=\"color:blue;\">as</span>&nbsp;gpd\n<span style=\"color:blue;\">import</span>&nbsp;matplotlib.pyplot&nbsp;<span style=\"color:blue;\">as</span>&nbsp;plt\n \n<span style=\"color:blue;\">map</span>&nbsp;=&nbsp;gpd.read_file(<span style=\"color:#a31515;\">&#39;dk.json&#39;</span>)\n<span style=\"color:blue;\">map</span>.explode().boundary.plot(edgecolor=<span style=\"color:#a31515;\">&#39;green&#39;</span>).set_axis_off()\n<span style=\"color:blue;\">map</span>.explode().convex_hull.boundary.plot().set_axis_off()\nplt.show()</pre>\n    </p>\n    <p>\n        In this script, I display the unmodified <code>map</code> before the convex hulls. This is only an artefact of my process. As I've already admitted, this is new ground for me, and I initially wanted to verify that I could even read in and display a GeoJSON file.\n    </p>\n    <p>\n        For both maps I use the <code>boundary</code> property to draw only the outline of the map, rather than filled polygons.\n    </p>\n    <h3 id=\"2b5f206417b542f386497d43d1bde322\">\n        Enveloping the map parts <a href=\"#2b5f206417b542f386497d43d1bde322\">#</a>\n    </h3>\n    <p>\n        Mostly for fun, but also to illustrate what a convex hull is, we can layer the two visualizations in a single image. In order to do that, a few changes to the code are required.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">import</span>&nbsp;geopandas&nbsp;<span style=\"color:blue;\">as</span>&nbsp;gpd\n<span style=\"color:blue;\">import</span>&nbsp;matplotlib.pyplot&nbsp;<span style=\"color:blue;\">as</span>&nbsp;plt\n \n<span style=\"color:blue;\">map</span>&nbsp;=&nbsp;gpd.read_file(<span style=\"color:#a31515;\">&#39;dk.json&#39;</span>)\n_,&nbsp;ax&nbsp;=&nbsp;plt.subplots()\n<span style=\"color:blue;\">map</span>.explode().boundary.plot(ax=ax,&nbsp;edgecolor=<span style=\"color:#a31515;\">&#39;green&#39;</span>).set_axis_off()\n<span style=\"color:blue;\">map</span>.explode().convex_hull.boundary.plot(ax=ax).set_axis_off()\nplt.show()</pre>\n    </p>\n    <p>\n        This little script now produces this image:\n    </p>\n    <p>\n        <img src=\"/content/binary/dk-outlines-in-hulls.svg\" alt=\"Map of Denmark, with each island, as well as the Jutland peninsula, enveloped in their convex hulls.\">\n    </p>\n    <p>\n        Those readers who know Danish geography may wonder what's going on with <a href=\"https://en.wikipedia.org/wiki/Falster\">Falster</a>. Since it's the sixth-largest Island in Denmark, shouldn't it have its own convex hull? Yes, it should, yet here it's connected to <a href=\"https://en.wikipedia.org/wiki/Zealand\">Zealand</a>. Granted, two bridges connect the two, but that's hardly sufficient to consider them one island. There are plenty of bridges in Denmark, so according to that criterion, most of Denmark is connected. In fact, on the above map, only <a href=\"https://en.wikipedia.org/wiki/Bornholm\">Bornholm</a>, <a href=\"https://en.wikipedia.org/wiki/Sams%C3%B8\">Samsø</a>, <a href=\"https://en.wikipedia.org/wiki/L%C3%A6s%C3%B8\">Læsø</a>, <a href=\"https://en.wikipedia.org/wiki/%C3%86r%C3%B8\">Ærø</a>, <a href=\"https://en.wikipedia.org/wiki/Fan%C3%B8\">Fanø</a>, and <a href=\"https://en.wikipedia.org/wiki/Anholt_(Denmark)\">Anholt</a> would then remain as islands.\n    </p>\n    <p>\n        Rather, this only highlights the quality, or lack thereof, of the data set. I don't want to complain about a free resource, and the data set has served my purposes well enough. I mostly point this out in case readers were puzzled about this. In fact, a similar case applies to <a href=\"https://en.wikipedia.org/wiki/North_Jutlandic_Island\">Nørrejyske Ø</a>, which in the GeoJSON map is connected to Jutland at <a href=\"https://en.wikipedia.org/wiki/Aalborg\">Aalborg</a>. Yes, there's a bridge there. No, that shouldn't qualify as a land connection.\n    </p>\n    <h3 id=\"92812a33519c47d3a90b20a447ddb7dc\">\n        Other countries <a href=\"#92812a33519c47d3a90b20a447ddb7dc\">#</a>\n    </h3>\n    <p>\n        As you may have noticed, apart from the hard-coded file name, nothing in the code is specific to Denmark. This means that you can play around with other countries. Here I've downloaded various GeoJSON data sets from <a href=\"https://geojson-maps.kyd.au/\">GeoJSON Maps of the globe</a>, which seems to be using the same source data set that the Danish data set is also based on. In other words, if I download the file for Denmark from that site, it looks exactly as above.\n    </p>\n    <p>\n        Can you guess which country this is?\n    </p>\n    <p>\n        <img src=\"/content/binary/gr-outline.svg\" alt=\"Convex hull of the Greek mainland, and hulls of many Greek islands.\" title=\"Convex hull of the Greek mainland, and hulls of many Greek islands.\">\n    </p>\n    <p>\n        Or this one?\n    </p>\n    <p>\n        <img src=\"/content/binary/jp-outline.svg\" alt=\"Convex hull of each larger island of Japan.\" title=\"Convex hull of each larger island of Japan.\">\n    </p>\n    <p>\n        While this is all good fun, not all countries have interesting convex hull:\n    </p>\n    <p>\n        <img src=\"/content/binary/ch-outline.svg\" alt=\"Convex hull of Switzerland.\" title=\"Convex hull of Switzerland.\">\n    </p>\n    <p>\n        While I'll let you have a bit of fun guessing, you can hover your cursor over each image to reveal which country it is.\n    </p>\n    <h3 id=\"ad89b110fca040ebb37db7788ddcf6d6\">\n        Conclusion <a href=\"#ad89b110fca040ebb37db7788ddcf6d6\">#</a>\n    </h3>\n    <p>\n        Your default position when working with Python should probably be: <em>There's already a library for that.</em>\n    </p>\n    <p>\n        In this article, I've described how I wanted to show Denmark, but only the convex hull of each of the larger islands, as well as the Jutland peninsula. Of course, there was already a library for that, so that I only needed to write seven lines of code to produce the figures I wanted.\n    </p>\n    <p>\n        Granted, it took a few hours of research to put those seven lines together, but I'm only a novice Python programmer, and I'm sure an old hand could do it much faster.\n    </p>\n</div><hr>\n      This blog is totally free, but if you like it, please consider <a href=\"https://blog.ploeh.dk/support\">supporting it</a>.",
    "sanitized": "Seven lines of Python code.\n    \n    \n        Can you tell what this is?\n    \n    \n        \n    \n    \n        I showed this to both my wife and my son, and they immediately recognized it for what it is. On the other hand, they're also both culturally primed for it.\n    \n    \n        After all, it's a map of Denmark, although I've transformed each of the major islands, as well as the peninsula of Jutland to their convex hulls.\n    \n    \n        Here's the original map I used for the transformation:\n    \n    \n        \n    \n    \n        I had a reason to do this, having to do with the coastline paradox, but my underlying motivation isn't really that important for this article, since I rather want to discuss how I did it.\n    \n    \n        The short answer is that I used Python. You have to admit that Python has a fabulous ecosystem for all kinds of data crunching, including visualizations. I'd actually geared up to implementing a Graham scan myself, but that turned out not to be necessary.\n    \n    \n        GeoPandas to the rescue #\n    \n    \n        I'm a novice Python programmer, but I've used Matplotlib before to visualize data, so I found it natural to start with a few web searches to figure out how to get to grips with the problem.\n    \n    \n        I quickly found GeoPandas, which works on top of Matplotlib to render and visualize geographical data.\n    \n    \n        My next problem was to find a data set for Denmark, which I found on SimpleMaps. I chose to download and work with the GeoJSON format.\n    \n    \n        Originally, I'd envisioned implementing a Graham scan myself. After all, I'd done that before in F#, and it's a compelling exercise. It turned out, however, that this function is already available in the GeoPandas API.\n    \n    \n        I had trouble separating the data file's multi-part geometry into multiple single geometries. This meant that when I tried to find the convex hull, I got the hull of the entire map, instead of each island individually. The solution was to use the explode function.\n    \n    \n        Once I figured that out, it turned out that all I needed was seven lines of Python code, including imports and a blank line:\n    \n    \n        import geopandas as gpd\nimport matplotlib.pyplot as plt\n \nmap = gpd.read_file('dk.json')\nmap.explode().boundary.plot(edgecolor='green').set_axis_off()\nmap.explode().convex_hull.boundary.plot().set_axis_off()\nplt.show()\n    \n    \n        In this script, I display the unmodified map before the convex hulls. This is only an artefact of my process. As I've already admitted, this is new ground for me, and I initially wanted to verify that I could even read in and display a GeoJSON file.\n    \n    \n        For both maps I use the boundary property to draw only the outline of the map, rather than filled polygons.\n    \n    \n        Enveloping the map parts #\n    \n    \n        Mostly for fun, but also to illustrate what a convex hull is, we can layer the two visualizations in a single image. In order to do that, a few changes to the code are required.\n    \n    \n        import geopandas as gpd\nimport matplotlib.pyplot as plt\n \nmap = gpd.read_file('dk.json')\n_, ax = plt.subplots()\nmap.explode().boundary.plot(ax=ax, edgecolor='green').set_axis_off()\nmap.explode().convex_hull.boundary.plot(ax=ax).set_axis_off()\nplt.show()\n    \n    \n        This little script now produces this image:\n    \n    \n        \n    \n    \n        Those readers who know Danish geography may wonder what's going on with Falster. Since it's the sixth-largest Island in Denmark, shouldn't it have its own convex hull? Yes, it should, yet here it's connected to Zealand. Granted, two bridges connect the two, but that's hardly sufficient to consider them one island. There are plenty of bridges in Denmark, so according to that criterion, most of Denmark is connected. In fact, on the above map, only Bornholm, Samsø, Læsø, Ærø, Fanø, and Anholt would then remain as islands.\n    \n    \n        Rather, this only highlights the quality, or lack thereof, of the data set. I don't want to complain about a free resource, and the data set has served my purposes well enough. I mostly point this out in case readers were puzzled about this. In fact, a similar case applies to Nørrejyske Ø, which in the GeoJSON map is connected to Jutland at Aalborg. Yes, there's a bridge there. No, that shouldn't qualify as a land connection.\n    \n    \n        Other countries #\n    \n    \n        As you may have noticed, apart from the hard-coded file name, nothing in the code is specific to Denmark. This means that you can play around with other countries. Here I've downloaded various GeoJSON data sets from GeoJSON Maps of the globe, which seems to be using the same source data set that the Danish data set is also based on. In other words, if I download the file for Denmark from that site, it looks exactly as above.\n    \n    \n        Can you guess which country this is?\n    \n    \n        \n    \n    \n        Or this one?\n    \n    \n        \n    \n    \n        While this is all good fun, not all countries have interesting convex hull:\n    \n    \n        \n    \n    \n        While I'll let you have a bit of fun guessing, you can hover your cursor over each image to reveal which country it is.\n    \n    \n        Conclusion #\n    \n    \n        Your default position when working with Python should probably be: There's already a library for that.\n    \n    \n        In this article, I've described how I wanted to show Denmark, but only the convex hull of each of the larger islands, as well as the Jutland peninsula. Of course, there was already a library for that, so that I only needed to write seven lines of code to produce the figures I wanted.\n    \n    \n        Granted, it took a few hours of research to put those seven lines together, but I'm only a novice Python programmer, and I'm sure an old hand could do it much faster.\n    \n\n      This blog is totally free, but if you like it, please consider supporting it."
  },
  {
    "itemId": "https://blog.ploeh.dk/2025/02/03/modelling-data-relationships-with-c-types",
    "raw": "\n\n\n<div id=\"post\">\n    <p>\n        <em>A C# example implementation of Ghosts of Departed Proofs.</em>\n    </p>\n    <p>\n        This article continues where <a href=\"/2025/01/20/modelling-data-relationships-with-f-types\">Modelling data relationships with F# types</a> left off. It ports the <a href=\"https://fsharp.org/\">F#</a> example code to C#. If you don't read F# source code, you may instead want to read <a href=\"/2024/12/23/implementing-rod-cutting\">Implementing rod-cutting</a> to get a sense of the problem being addressed.\n    </p>\n    <p>\n        I'm going to assume that you've read enough of the previous articles to get a sense of the example, but in short, this article examines if it's possible to use the type system to model data relationships. Specifically, we have methods that operate on a collection and a number. The precondition for calling these methods is that the number is a valid (one-based) index into the collection.\n    </p>\n    <p>\n        While you would typically implement such a precondition with a <a href=\"https://en.wikipedia.org/wiki/Guard_(computer_science)\">Guard Clause</a> and communicate it via documentation, you can also use the <em>Ghosts of Departed Proofs</em> technique to instead leverage the type system. Please see <a href=\"/2025/01/20/modelling-data-relationships-with-f-types\">the previous article for an overview</a>.\n    </p>\n    <p>\n        That said, I'll repeat one point here: The purpose of these articles is to showcase a technique, using a simple example to make it, I hope, sufficiently clear what's going on. All this machinery is hardly warranted for an example as simple as this. All of this is a demonstration, not a recommendation.\n    </p>\n    <h3 id=\"24f5e14404424695aca0a2c7e049b0a5\">\n        Size proofs <a href=\"#24f5e14404424695aca0a2c7e049b0a5\">#</a>\n    </h3>\n    <p>\n        As in the previous article, we may start by defining what a 'size proof' looks like. In C#, it may <a href=\"/2015/08/03/idiomatic-or-idiosyncratic\">idiomatically</a> be a class with an <code>internal</code> constructor.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">sealed</span>&nbsp;<span style=\"color:blue;\">class</span>&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">int</span>&nbsp;Value&nbsp;{&nbsp;<span style=\"color:blue;\">get</span>;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">internal</span>&nbsp;<span style=\"color:#2b91af;\">Size</span>(<span style=\"color:blue;\">int</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">value</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">value</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Also&nbsp;override&nbsp;ToString,&nbsp;Equals,&nbsp;and&nbsp;GetHashCode...</span>\n}</pre>\n    </p>\n    <p>\n        Since the constructor is <code>internal</code> it means that client code can't create <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> instances, and thereby client code can't decide a concrete type for the phantom type <code>T</code>.\n    </p>\n    <h3 id=\"0f22adf378da484b8dc85e372f82a0d6\">\n        Issuing size proofs <a href=\"#0f22adf378da484b8dc85e372f82a0d6\">#</a>\n    </h3>\n    <p>\n        How may client code create <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> objects? It may ask a <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> object to issue a proof:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">sealed</span>&nbsp;<span style=\"color:blue;\">class</span>&nbsp;<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:#2b91af;\">IReadOnlyCollection</span>&lt;<span style=\"color:blue;\">int</span>&gt;&nbsp;Prices&nbsp;{&nbsp;<span style=\"color:blue;\">get</span>;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">internal</span>&nbsp;<span style=\"color:#2b91af;\">PriceList</span>(<span style=\"color:#2b91af;\">IReadOnlyCollection</span>&lt;<span style=\"color:blue;\">int</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Prices&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;?&nbsp;<span style=\"font-weight:bold;color:#74531f;\">TryCreateSize</span>(<span style=\"color:blue;\">int</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">if</span>&nbsp;(0&nbsp;&lt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>&nbsp;&amp;&amp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>&nbsp;&lt;=&nbsp;Prices.Count)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;(<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">else</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"color:blue;\">null</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;More&nbsp;members&nbsp;go&nbsp;here...</span></pre>\n    </p>\n    <p>\n        If the requested <code>candidate</code> integer represents a valid (one-indexed) position in the <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> object, the return value is a <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> object that contains the <code>candidate</code>. If, on the other hand, the <code>candidate</code> isn't in the valid range, no object is returned.\n    </p>\n    <p>\n        Since both <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> and <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> classes are immutable, once a 'size proof' has been issued, it remains valid. As I've previously argued, <a href=\"/2024/06/12/simpler-encapsulation-with-immutability\">immutability makes encapsulation simpler</a>.\n    </p>\n    <p>\n        This kind of API does, however, look like it's <a href=\"https://en.wikipedia.org/wiki/Turtles_all_the_way_down\">turtles all the way down</a>. After all, the <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> constructor is also <code>internal</code>. Now the question becomes: How does client code create <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> objects?\n    </p>\n    <p>\n        The short answer is that it doesn't. Instead, it'll be given an object by the library API. You'll see how that works later, but first, let's review what such an API enables us to express.\n    </p>\n    <h3 id=\"079355423c6d4a7d8daaeffc08661adb\">\n        Proof-based Cut API <a href=\"#079355423c6d4a7d8daaeffc08661adb\">#</a>\n    </h3>\n    <p>\n        As described in <a href=\"/2025/01/06/encapsulating-rod-cutting\">Encapsulating rod-cutting</a>, returning a collection of 'cut' objects better communicates postconditions than returning a tuple of two arrays, as <a href=\"/2024/12/23/implementing-rod-cutting\">the original algorithm suggested</a>. In other words, we're going to need a type for that.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">sealed</span>&nbsp;<span style=\"color:blue;\">record</span>&nbsp;<span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;(<span style=\"color:blue;\">int</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">Revenue</span>,&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">Size</span>);</pre>\n    </p>\n    <p>\n        In this case we can get by with a simple <a href=\"https://learn.microsoft.com/dotnet/csharp/language-reference/builtin-types/record\">record type</a>. Since one of the properties is of the type <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code>, client code can't create <code><span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> instances, just like it can't create <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> or <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> objects. This is what we want, because a <code><span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> object encapsulates a proof that it's valid, related to the original collection of prices.\n    </p>\n    <p>\n        We can now define the <code>Cut</code> method as an instance method on <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code>. Notice how all the <code>T</code> type arguments line up. As input, the <code>Cut</code> method only accepts <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> proofs issued by a compatible price list. This is enforced at compile time, not at run time.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:#2b91af;\">IReadOnlyCollection</span>&lt;<span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&gt;&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Cut</span>(<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>)\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;=&nbsp;Prices.<span style=\"font-weight:bold;color:#74531f;\">Prepend</span>(0).<span style=\"font-weight:bold;color:#74531f;\">ToArray</span>();\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:blue;\">int</span>[<span style=\"font-weight:bold;color:#1f377f;\">n</span>.Value&nbsp;+&nbsp;1];\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:blue;\">int</span>[<span style=\"font-weight:bold;color:#1f377f;\">n</span>.Value&nbsp;+&nbsp;1];\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[0]&nbsp;=&nbsp;0;\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">for</span>&nbsp;(<span style=\"color:blue;\">int</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;=&nbsp;1;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;&lt;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>.Value;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>++)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">q</span>&nbsp;=&nbsp;<span style=\"color:blue;\">int</span>.MinValue;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">for</span>&nbsp;(<span style=\"color:blue;\">int</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;1;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;&lt;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>++)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>];\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">if</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">q</span>&nbsp;&lt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">q</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">q</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">List</span>&lt;<span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&gt;();\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">for</span>&nbsp;(<span style=\"color:blue;\">int</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;1;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;&lt;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>.Value;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>++)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenue</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>];\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">size</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;(<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>.<span style=\"font-weight:bold;color:#74531f;\">Add</span>(<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;(<span style=\"font-weight:bold;color:#1f377f;\">revenue</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">size</span>));\n&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>;\n}</pre>\n    </p>\n    <p>\n        For good measure, I'm showing the entire implementation, but you only need to pay attention to the method signature. The point is that <code>n</code> is constrained <em>by the type system</em> to be in a valid range.\n    </p>\n    <h3 id=\"ce55a32904434bd99c7f42d896fa7102\">\n        Proof-based Solve API <a href=\"#ce55a32904434bd99c7f42d896fa7102\">#</a>\n    </h3>\n    <p>\n        The same technique can be applied to the <code>Solve</code> method. Just align the <code>T</code>s.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:#2b91af;\">IReadOnlyCollection</span>&lt;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&gt;&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Solve</span>(<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>)\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Cut</span>(<span style=\"font-weight:bold;color:#1f377f;\">n</span>).<span style=\"font-weight:bold;color:#74531f;\">ToArray</span>();\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">sizes</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">List</span>&lt;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&gt;();\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">size</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">while</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">size</span>.Value&nbsp;&gt;&nbsp;0)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">sizes</span>.<span style=\"font-weight:bold;color:#74531f;\">Add</span>(<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>[<span style=\"font-weight:bold;color:#1f377f;\">size</span>.Value&nbsp;-&nbsp;1].Size);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">size</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;(<span style=\"font-weight:bold;color:#1f377f;\">size</span>.Value&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>[<span style=\"font-weight:bold;color:#1f377f;\">size</span>.Value&nbsp;-&nbsp;1].Size.Value);\n&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">sizes</span>;\n}</pre>\n    </p>\n    <p>\n        This is another instance method on <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code>, which is where <code>T</code> is defined.\n    </p>\n    <h3 id=\"57994590468c40fa87ba24f0d158720b\">\n        Proof-based revenue API <a href=\"#57994590468c40fa87ba24f0d158720b\">#</a>\n    </h3>\n    <p>\n        Finally, we may also implement a method to calculate the revenue from a given sequence of cuts.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">int</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">CalculateRevenue</span>(<span style=\"color:#2b91af;\">IReadOnlyCollection</span>&lt;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>)\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">arr</span>&nbsp;=&nbsp;Prices.<span style=\"font-weight:bold;color:#74531f;\">ToArray</span>();\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>.<span style=\"font-weight:bold;color:#74531f;\">Sum</span>(<span style=\"font-weight:bold;color:#1f377f;\">c</span>&nbsp;=&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">arr</span>[<span style=\"font-weight:bold;color:#1f377f;\">c</span>.Value&nbsp;-&nbsp;1]);\n}</pre>\n    </p>\n    <p>\n        Not surprisingly, I hope, <code>CalculateRevenue</code> is another instance method on <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code>. The <code>cuts</code> will typically come from a call to <code>Solve</code>, but it's entirely possible for client code to create an ad-hoc collection of <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> objects by repeatedly calling <code>TryCreateSize</code>.\n    </p>\n    <h3 id=\"97eba480d25e4ed8a5f7b8b0efb3a528\">\n        Running client code <a href=\"#97eba480d25e4ed8a5f7b8b0efb3a528\">#</a>\n    </h3>\n    <p>\n        How does client code use this API? It calls an <code>Accept</code> method with an implementation of this interface:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">interface</span>&nbsp;<span style=\"color:#2b91af;\">IPriceListVisitor</span>&lt;<span style=\"color:#2b91af;\">TResult</span>&gt;\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">TResult</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Visit</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;(<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList</span>);\n}</pre>\n    </p>\n    <p>\n        Why 'visitor'? This doesn't quite look like a <a href=\"https://en.wikipedia.org/wiki/Visitor_pattern\">Visitor</a>, and yet, it still does.\n    </p>\n    <p>\n        Imagine, for a moment, that we could enumerate all types that <code>T</code> could inhabit.\n    </p>\n    <p>\n        <pre><span style=\"color:#2b91af;\">TResult</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Visit</span>(<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">Type1</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList</span>);\n<span style=\"color:#2b91af;\">TResult</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Visit</span>(<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">Type2</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList</span>);\n<span style=\"color:#2b91af;\">TResult</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Visit</span>(<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">Type3</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList</span>);\n<span style=\"color:green;\">//&nbsp;⋮</span>\n<span style=\"color:#2b91af;\">TResult</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Visit</span>(<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">TypeN</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList</span>);</pre>\n    </p>\n    <p>\n        Clearly we can't do that, since <code>T</code> is infinite, but <em>if</em> we could, the interface would look like a Visitor.\n    </p>\n    <p>\n        I find the situation sufficiently similar to name the interface with the <em>Visitor</em> suffix. Now we only need a class with an <code>Accept</code> method.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">sealed</span>&nbsp;<span style=\"color:blue;\">class</span>&nbsp;<span style=\"color:#2b91af;\">RodCutter</span>(<span style=\"color:#2b91af;\">IReadOnlyCollection</span>&lt;<span style=\"color:blue;\">int</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>)\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:#2b91af;\">TResult</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Accept</span>&lt;<span style=\"color:#2b91af;\">TResult</span>&gt;(<span style=\"color:#2b91af;\">IPriceListVisitor</span>&lt;<span style=\"color:#2b91af;\">TResult</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">visitor</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">visitor</span>.<span style=\"font-weight:bold;color:#74531f;\">Visit</span>(<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:blue;\">object</span>&gt;(<span style=\"font-weight:bold;color:#1f377f;\">prices</span>));\n&nbsp;&nbsp;&nbsp;&nbsp;}\n}</pre>\n    </p>\n    <p>\n        Client code may create a <code>RodCutter</code> object, as well as one or more classes that implement <code><span style=\"color:#2b91af;\">IPriceListVisitor</span>&lt;<span style=\"color:#2b91af;\">TResult</span>&gt;</code>, and in this way interact with the library API.\n    </p>\n    <p>\n        Let's see some examples. We'll start with the original <a href=\"/ref/clrs\">CLRS</a> example, written as an <a href=\"https://xunit.net/\">xUnit.net</a> test.\n    </p>\n    <p>\n        <pre>[<span style=\"color:#2b91af;\">Fact</span>]\n<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">void</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">ClrsExample</span>()\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">sut</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">RodCutter</span>([1,&nbsp;5,&nbsp;8,&nbsp;9,&nbsp;10,&nbsp;17,&nbsp;17,&nbsp;20,&nbsp;24,&nbsp;30]);\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">actual</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">sut</span>.<span style=\"font-weight:bold;color:#74531f;\">Accept</span>(<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">CutRodVisitor</span>(10));\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">expected</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>[]&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;1,&nbsp;&nbsp;1),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;5,&nbsp;&nbsp;2),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;8,&nbsp;&nbsp;3),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(10,&nbsp;&nbsp;2),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(13,&nbsp;&nbsp;2),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(17,&nbsp;&nbsp;6),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(18,&nbsp;&nbsp;1),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(22,&nbsp;&nbsp;2),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(25,&nbsp;&nbsp;3),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(30,&nbsp;10)\n&nbsp;&nbsp;&nbsp;&nbsp;};\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Assert</span>.<span style=\"color:#74531f;\">Equal</span>(<span style=\"font-weight:bold;color:#1f377f;\">expected</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">actual</span>);\n}</pre>\n    </p>\n    <p>\n        <code>CutRodVisitor</code> is a nested class that implements the <code><span style=\"color:#2b91af;\">IPriceListVisitor</span>&lt;<span style=\"color:#2b91af;\">TResult</span>&gt;</code> interface:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">class</span>&nbsp;<span style=\"color:#2b91af;\">CutRodVisitor</span>(<span style=\"color:blue;\">int</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)&nbsp;:\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IPriceListVisitor</span>&lt;<span style=\"color:#2b91af;\">IReadOnlyCollection</span>&lt;(<span style=\"color:blue;\">int</span>,&nbsp;<span style=\"color:blue;\">int</span>)&gt;&gt;\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:#2b91af;\">IReadOnlyCollection</span>&lt;(<span style=\"color:blue;\">int</span>,&nbsp;<span style=\"color:blue;\">int</span>)&gt;&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Visit</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;(<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList</span>.<span style=\"font-weight:bold;color:#74531f;\">TryCreateSize</span>(<span style=\"font-weight:bold;color:#1f377f;\">i</span>);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">if</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;<span style=\"color:blue;\">is</span>&nbsp;<span style=\"color:blue;\">null</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;[];\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">else</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList</span>.<span style=\"font-weight:bold;color:#74531f;\">Cut</span>(<span style=\"font-weight:bold;color:#1f377f;\">n</span>);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>.<span style=\"font-weight:bold;color:#74531f;\">Select</span>(<span style=\"font-weight:bold;color:#1f377f;\">c</span>&nbsp;=&gt;&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">c</span>.Revenue,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">c</span>.Size.Value)).<span style=\"font-weight:bold;color:#74531f;\">ToArray</span>();\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;}\n}</pre>\n    </p>\n    <p>\n        The <code>CutRodVisitor</code> class returns a collection of tuples. Why doesn't it just return <code>cuts</code> directly?\n    </p>\n    <p>\n        It can't, because it wouldn't type-check. Think about it for a moment. When you implement the interface, you need to pick a type for <code>TResult</code>. You can't, however, declare it to implement <code><span style=\"color:#2b91af;\">IPriceListVisitor</span>&lt;<span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&gt;</code> (where <code>T</code> would be the <code>T</code> from <code><span style=\"font-weight:bold;color:#74531f;\">Visit</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code>), because at the class level, you don't know what <code>T</code> is. Neither does the compiler.\n    </p>\n    <p>\n        Your <code><span style=\"font-weight:bold;color:#74531f;\">Visit</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> implementation must work for <em>any</em> <code>T</code>.\n    </p>\n    <h3 id=\"39d9ed0b81044e5a8f7ac990cd457fad\">\n        Preventing misalignment <a href=\"#39d9ed0b81044e5a8f7ac990cd457fad\">#</a>\n    </h3>\n    <p>\n        Finally, here's a demonstration of how the phantom type prevents confusing or mixing up two (or more) different price lists. Consider this rather artificial example:\n    </p>\n    <p>\n        <pre>[<span style=\"color:#2b91af;\">Fact</span>]\n<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">void</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">NestTwoSolutions</span>()\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">sut</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">RodCutter</span>([1,&nbsp;2,&nbsp;2]);\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">inner</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">RodCutter</span>([1]);\n \n&nbsp;&nbsp;&nbsp;&nbsp;(<span style=\"color:blue;\">int</span>,&nbsp;<span style=\"color:blue;\">int</span>)?&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">actual</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">sut</span>.<span style=\"font-weight:bold;color:#74531f;\">Accept</span>(<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">NestedRevenueVisitor</span>(<span style=\"font-weight:bold;color:#1f377f;\">inner</span>));\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Assert</span>.<span style=\"color:#74531f;\">Equal</span>((3,&nbsp;1),&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">actual</span>);\n}</pre>\n    </p>\n    <p>\n        This unit test creates two price arrays and calls <code>Accept</code> on one of them (the 'outer' one, you may say), while passing the <code>inner</code> one to the Visitor, which at first glance just looks like this:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">class</span>&nbsp;<span style=\"color:#2b91af;\">NestedRevenueVisitor</span>(<span style=\"color:#2b91af;\">RodCutter</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">inner</span>)&nbsp;:\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IPriceListVisitor</span>&lt;(<span style=\"color:blue;\">int</span>,&nbsp;<span style=\"color:blue;\">int</span>)?&gt;\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">public</span>&nbsp;(<span style=\"color:blue;\">int</span>,&nbsp;<span style=\"color:blue;\">int</span>)?&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Visit</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;(<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">inner</span>.<span style=\"font-weight:bold;color:#74531f;\">Accept</span>(<span style=\"color:blue;\">new</span>&nbsp;InnerRevenueVisitor&lt;<span style=\"color:#2b91af;\">T</span>&gt;(<span style=\"font-weight:bold;color:#1f377f;\">priceList</span>));\n&nbsp;&nbsp;&nbsp;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Inner&nbsp;visitor&nbsp;goes&nbsp;here...</span>\n}</pre>\n    </p>\n    <p>\n        Notice that it only delegates to yet another Visitor, passing the 'outer' <code>priceList</code> as a constructor parameter to the next Visitor. The purpose of this is to bring two <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;</code> objects in scope at the same time. This will enable us to examine what happens if we make a programming mistake.\n    </p>\n    <p>\n        First, however, here's the proper, working implementation <em>without</em> mistakes:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">class</span>&nbsp;<span style=\"color:#2b91af;\">InnerRevenueVisitor</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;(<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList1</span>)&nbsp;:&nbsp;<span style=\"color:#2b91af;\">IPriceListVisitor</span>&lt;(<span style=\"color:blue;\">int</span>,&nbsp;<span style=\"color:blue;\">int</span>)?&gt;\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">public</span>&nbsp;(<span style=\"color:blue;\">int</span>,&nbsp;<span style=\"color:blue;\">int</span>)?&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Visit</span>&lt;<span style=\"color:#2b91af;\">T1</span>&gt;(<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">T1</span>&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList2</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n1</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList1</span>.<span style=\"font-weight:bold;color:#74531f;\">TryCreateSize</span>(3);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">if</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n1</span>&nbsp;<span style=\"color:blue;\">is</span>&nbsp;<span style=\"color:blue;\">null</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"color:blue;\">null</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">else</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts1</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList1</span>.<span style=\"font-weight:bold;color:#74531f;\">Solve</span>(<span style=\"font-weight:bold;color:#1f377f;\">n1</span>);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenue1</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList1</span>.<span style=\"font-weight:bold;color:#74531f;\">CalculateRevenue</span>(<span style=\"font-weight:bold;color:#1f377f;\">cuts1</span>);\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n2</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList2</span>.<span style=\"font-weight:bold;color:#74531f;\">TryCreateSize</span>(1);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">if</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n2</span>&nbsp;<span style=\"color:blue;\">is</span>&nbsp;<span style=\"color:blue;\">null</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"color:blue;\">null</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">else</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts2</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList2</span>.<span style=\"font-weight:bold;color:#74531f;\">Solve</span>(<span style=\"font-weight:bold;color:#1f377f;\">n2</span>);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenue2</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">priceList2</span>.<span style=\"font-weight:bold;color:#74531f;\">CalculateRevenue</span>(<span style=\"font-weight:bold;color:#1f377f;\">cuts2</span>);\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">revenue1</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenue2</span>);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;}\n}</pre>\n    </p>\n    <p>\n        Notice how both <code>priceList1</code> and <code>priceList2</code> are now both in scope. So far, they're <em>not</em> mixed up, so the <code>Visit</code> implementation queries first one and then another for the optimal revenue. If all works well (which it does), it returns a tuple with the two revenues.\n    </p>\n    <p>\n        What happens if I make a mistake? What if, for example, I write <code>priceList2.Solve(n1)</code>? It shouldn't be possible to use <code>n1</code>, which was issued by <code>pricelist1</code>, with <code>priceList2</code>. And indeed this isn't possible. With that mistake, the code doesn't compile. The compiler error is:\n    </p>\n    <blockquote>\n        <p>\n            Argument 1: cannot convert from 'Ploeh.Samples.RodCutting.Size&lt;T&gt;' to 'Ploeh.Samples.RodCutting.Size&lt;T1&gt;'\n        </p>\n    </blockquote>\n    <p>\n        When you look at the types, that makes sense. After all, there's no guarantee that <code>T</code> is equal to <code>T1</code>.\n    </p>\n    <p>\n        You'll run into similar problems if you mix up the two 'contexts' in other ways. The code doesn't compile. Which is what you want.\n    </p>\n    <h3 id=\"1075e4f3ff6548cf8806ae9f419910b1\">\n        Conclusion <a href=\"#1075e4f3ff6548cf8806ae9f419910b1\">#</a>\n    </h3>\n    <p>\n        This article demonstrates how to use the <em>Ghosts of Departed Proofs</em> technique in C#. In some ways, I find that it comes across as more idiomatic in C# than in F#. I think this is because rank-2 polymorphism is only possible in F# when using its object-oriented features. Since F# is a functional-first programming language, it seems a little out of place there, whereas it looks more at home in C#.\n    </p>\n    <p>\n        Perhaps I should have designed the F# code to make use of objects to the same degree as I've done here in C#.\n    </p>\n    <p>\n        I think I actually like how the C# API turned out, although having to define and implement a class every time you need to supply a Visitor may feel a bit cumbersome. Even so, <a href=\"/2024/05/13/gratification\">developer experience shouldn't be exclusively about saving a few keystrokes</a>. After all, <a href=\"/2018/09/17/typing-is-not-a-programming-bottleneck\">typing isn't a bottleneck</a>.\n    </p>\n</div><hr>\n      This blog is totally free, but if you like it, please consider <a href=\"https://blog.ploeh.dk/support\">supporting it</a>.",
    "sanitized": "A C# example implementation of Ghosts of Departed Proofs.\n    \n    \n        This article continues where Modelling data relationships with F# types left off. It ports the F# example code to C#. If you don't read F# source code, you may instead want to read Implementing rod-cutting to get a sense of the problem being addressed.\n    \n    \n        I'm going to assume that you've read enough of the previous articles to get a sense of the example, but in short, this article examines if it's possible to use the type system to model data relationships. Specifically, we have methods that operate on a collection and a number. The precondition for calling these methods is that the number is a valid (one-based) index into the collection.\n    \n    \n        While you would typically implement such a precondition with a Guard Clause and communicate it via documentation, you can also use the Ghosts of Departed Proofs technique to instead leverage the type system. Please see the previous article for an overview.\n    \n    \n        That said, I'll repeat one point here: The purpose of these articles is to showcase a technique, using a simple example to make it, I hope, sufficiently clear what's going on. All this machinery is hardly warranted for an example as simple as this. All of this is a demonstration, not a recommendation.\n    \n    \n        Size proofs #\n    \n    \n        As in the previous article, we may start by defining what a 'size proof' looks like. In C#, it may idiomatically be a class with an internal constructor.\n    \n    \n        public sealed class Size<T>\n{\n    public int Value { get; }\n \n    internal Size(int value)\n    {\n        Value = value;\n    }\n \n    // Also override ToString, Equals, and GetHashCode...\n}\n    \n    \n        Since the constructor is internal it means that client code can't create Size<T> instances, and thereby client code can't decide a concrete type for the phantom type T.\n    \n    \n        Issuing size proofs #\n    \n    \n        How may client code create Size<T> objects? It may ask a PriceList<T> object to issue a proof:\n    \n    \n        public sealed class PriceList<T>\n{\n    public IReadOnlyCollection<int> Prices { get; }\n \n    internal PriceList(IReadOnlyCollection<int> prices)\n    {\n        Prices = prices;\n    }\n \n    public Size<T>? TryCreateSize(int candidate)\n    {\n        if (0 < candidate && candidate <= Prices.Count)\n            return new Size<T>(candidate);\n        else\n            return null;\n    }\n \n    // More members go here...\n    \n    \n        If the requested candidate integer represents a valid (one-indexed) position in the PriceList<T> object, the return value is a Size<T> object that contains the candidate. If, on the other hand, the candidate isn't in the valid range, no object is returned.\n    \n    \n        Since both PriceList<T> and Size<T> classes are immutable, once a 'size proof' has been issued, it remains valid. As I've previously argued, immutability makes encapsulation simpler.\n    \n    \n        This kind of API does, however, look like it's turtles all the way down. After all, the PriceList<T> constructor is also internal. Now the question becomes: How does client code create PriceList<T> objects?\n    \n    \n        The short answer is that it doesn't. Instead, it'll be given an object by the library API. You'll see how that works later, but first, let's review what such an API enables us to express.\n    \n    \n        Proof-based Cut API #\n    \n    \n        As described in Encapsulating rod-cutting, returning a collection of 'cut' objects better communicates postconditions than returning a tuple of two arrays, as the original algorithm suggested. In other words, we're going to need a type for that.\n    \n    \n        public sealed record Cut<T>(int Revenue, Size<T> Size);\n    \n    \n        In this case we can get by with a simple record type. Since one of the properties is of the type Size<T>, client code can't create Cut<T> instances, just like it can't create Size<T> or PriceList<T> objects. This is what we want, because a Cut<T> object encapsulates a proof that it's valid, related to the original collection of prices.\n    \n    \n        We can now define the Cut method as an instance method on PriceList<T>. Notice how all the T type arguments line up. As input, the Cut method only accepts Size<T> proofs issued by a compatible price list. This is enforced at compile time, not at run time.\n    \n    \n        public IReadOnlyCollection<Cut<T>> Cut(Size<T> n)\n{\n    var p = Prices.Prepend(0).ToArray();\n    var r = new int[n.Value + 1];\n    var s = new int[n.Value + 1];\n    r[0] = 0;\n    for (int j = 1; j <= n.Value; j++)\n    {\n        var q = int.MinValue;\n        for (int i = 1; i <= j; i++)\n        {\n            var candidate = p[i] + r[j - i];\n            if (q < candidate)\n            {\n                q = candidate;\n                s[j] = i;\n            }\n        }\n        r[j] = q;\n    }\n \n    var cuts = new List<Cut<T>>();\n    for (int i = 1; i <= n.Value; i++)\n    {\n        var revenue = r[i];\n        var size = new Size<T>(s[i]);\n        cuts.Add(new Cut<T>(revenue, size));\n    }\n    return cuts;\n}\n    \n    \n        For good measure, I'm showing the entire implementation, but you only need to pay attention to the method signature. The point is that n is constrained by the type system to be in a valid range.\n    \n    \n        Proof-based Solve API #\n    \n    \n        The same technique can be applied to the Solve method. Just align the Ts.\n    \n    \n        public IReadOnlyCollection<Size<T>> Solve(Size<T> n)\n{\n    var cuts = Cut(n).ToArray();\n    var sizes = new List<Size<T>>();\n    var size = n;\n    while (size.Value > 0)\n    {\n        sizes.Add(cuts[size.Value - 1].Size);\n        size = new Size<T>(size.Value - cuts[size.Value - 1].Size.Value);\n    }\n    return sizes;\n}\n    \n    \n        This is another instance method on PriceList<T>, which is where T is defined.\n    \n    \n        Proof-based revenue API #\n    \n    \n        Finally, we may also implement a method to calculate the revenue from a given sequence of cuts.\n    \n    \n        public int CalculateRevenue(IReadOnlyCollection<Size<T>> cuts)\n{\n    var arr = Prices.ToArray();\n    return cuts.Sum(c => arr[c.Value - 1]);\n}\n    \n    \n        Not surprisingly, I hope, CalculateRevenue is another instance method on PriceList<T>. The cuts will typically come from a call to Solve, but it's entirely possible for client code to create an ad-hoc collection of Size<T> objects by repeatedly calling TryCreateSize.\n    \n    \n        Running client code #\n    \n    \n        How does client code use this API? It calls an Accept method with an implementation of this interface:\n    \n    \n        public interface IPriceListVisitor<TResult>\n{\n    TResult Visit<T>(PriceList<T> priceList);\n}\n    \n    \n        Why 'visitor'? This doesn't quite look like a Visitor, and yet, it still does.\n    \n    \n        Imagine, for a moment, that we could enumerate all types that T could inhabit.\n    \n    \n        TResult Visit(PriceList<Type1> priceList);\nTResult Visit(PriceList<Type2> priceList);\nTResult Visit(PriceList<Type3> priceList);\n// ⋮\nTResult Visit(PriceList<TypeN> priceList);\n    \n    \n        Clearly we can't do that, since T is infinite, but if we could, the interface would look like a Visitor.\n    \n    \n        I find the situation sufficiently similar to name the interface with the Visitor suffix. Now we only need a class with an Accept method.\n    \n    \n        public sealed class RodCutter(IReadOnlyCollection<int> prices)\n{\n    public TResult Accept<TResult>(IPriceListVisitor<TResult> visitor)\n    {\n        return visitor.Visit(new PriceList<object>(prices));\n    }\n}\n    \n    \n        Client code may create a RodCutter object, as well as one or more classes that implement IPriceListVisitor<TResult>, and in this way interact with the library API.\n    \n    \n        Let's see some examples. We'll start with the original CLRS example, written as an xUnit.net test.\n    \n    \n        [Fact]\npublic void ClrsExample()\n{\n    var sut = new RodCutter([1, 5, 8, 9, 10, 17, 17, 20, 24, 30]);\n \n    var actual = sut.Accept(new CutRodVisitor(10));\n \n    var expected = new[] {\n        ( 1,  1),\n        ( 5,  2),\n        ( 8,  3),\n        (10,  2),\n        (13,  2),\n        (17,  6),\n        (18,  1),\n        (22,  2),\n        (25,  3),\n        (30, 10)\n    };\n    Assert.Equal(expected, actual);\n}\n    \n    \n        CutRodVisitor is a nested class that implements the IPriceListVisitor<TResult> interface:\n    \n    \n        private class CutRodVisitor(int i) :\n    IPriceListVisitor<IReadOnlyCollection<(int, int)>>\n{\n    public IReadOnlyCollection<(int, int)> Visit<T>(PriceList<T> priceList)\n    {\n        var n = priceList.TryCreateSize(i);\n        if (n is null)\n            return [];\n        else\n        {\n            var cuts = priceList.Cut(n);\n            return cuts.Select(c => (c.Revenue, c.Size.Value)).ToArray();\n        }\n    }\n}\n    \n    \n        The CutRodVisitor class returns a collection of tuples. Why doesn't it just return cuts directly?\n    \n    \n        It can't, because it wouldn't type-check. Think about it for a moment. When you implement the interface, you need to pick a type for TResult. You can't, however, declare it to implement IPriceListVisitor<Cut<T>> (where T would be the T from Visit<T>), because at the class level, you don't know what T is. Neither does the compiler.\n    \n    \n        Your Visit<T> implementation must work for any T.\n    \n    \n        Preventing misalignment #\n    \n    \n        Finally, here's a demonstration of how the phantom type prevents confusing or mixing up two (or more) different price lists. Consider this rather artificial example:\n    \n    \n        [Fact]\npublic void NestTwoSolutions()\n{\n    var sut = new RodCutter([1, 2, 2]);\n    var inner = new RodCutter([1]);\n \n    (int, int)? actual = sut.Accept(new NestedRevenueVisitor(inner));\n \n    Assert.Equal((3, 1), actual);\n}\n    \n    \n        This unit test creates two price arrays and calls Accept on one of them (the 'outer' one, you may say), while passing the inner one to the Visitor, which at first glance just looks like this:\n    \n    \n        private class NestedRevenueVisitor(RodCutter inner) :\n    IPriceListVisitor<(int, int)?>\n{\n    public (int, int)? Visit<T>(PriceList<T> priceList)\n    {\n        return inner.Accept(new InnerRevenueVisitor<T>(priceList));\n    }\n \n    // Inner visitor goes here...\n}\n    \n    \n        Notice that it only delegates to yet another Visitor, passing the 'outer' priceList as a constructor parameter to the next Visitor. The purpose of this is to bring two PriceList<T> objects in scope at the same time. This will enable us to examine what happens if we make a programming mistake.\n    \n    \n        First, however, here's the proper, working implementation without mistakes:\n    \n    \n        private class InnerRevenueVisitor<T>(PriceList<T> priceList1) : IPriceListVisitor<(int, int)?>\n{\n    public (int, int)? Visit<T1>(PriceList<T1> priceList2)\n    {\n        var n1 = priceList1.TryCreateSize(3);\n        if (n1 is null)\n            return null;\n        else\n        {\n            var cuts1 = priceList1.Solve(n1);\n            var revenue1 = priceList1.CalculateRevenue(cuts1);\n \n            var n2 = priceList2.TryCreateSize(1);\n            if (n2 is null)\n                return null;\n            else\n            {\n                var cuts2 = priceList2.Solve(n2);\n                var revenue2 = priceList2.CalculateRevenue(cuts2);\n \n                return (revenue1, revenue2);\n            }\n        }\n    }\n}\n    \n    \n        Notice how both priceList1 and priceList2 are now both in scope. So far, they're not mixed up, so the Visit implementation queries first one and then another for the optimal revenue. If all works well (which it does), it returns a tuple with the two revenues.\n    \n    \n        What happens if I make a mistake? What if, for example, I write priceList2.Solve(n1)? It shouldn't be possible to use n1, which was issued by pricelist1, with priceList2. And indeed this isn't possible. With that mistake, the code doesn't compile. The compiler error is:\n    \n    \n        \n            Argument 1: cannot convert from 'Ploeh.Samples.RodCutting.Size<T>' to 'Ploeh.Samples.RodCutting.Size<T1>'\n        \n    \n    \n        When you look at the types, that makes sense. After all, there's no guarantee that T is equal to T1.\n    \n    \n        You'll run into similar problems if you mix up the two 'contexts' in other ways. The code doesn't compile. Which is what you want.\n    \n    \n        Conclusion #\n    \n    \n        This article demonstrates how to use the Ghosts of Departed Proofs technique in C#. In some ways, I find that it comes across as more idiomatic in C# than in F#. I think this is because rank-2 polymorphism is only possible in F# when using its object-oriented features. Since F# is a functional-first programming language, it seems a little out of place there, whereas it looks more at home in C#.\n    \n    \n        Perhaps I should have designed the F# code to make use of objects to the same degree as I've done here in C#.\n    \n    \n        I think I actually like how the C# API turned out, although having to define and implement a class every time you need to supply a Visitor may feel a bit cumbersome. Even so, developer experience shouldn't be exclusively about saving a few keystrokes. After all, typing isn't a bottleneck.\n    \n\n      This blog is totally free, but if you like it, please consider supporting it."
  },
  {
    "itemId": "https://blog.ploeh.dk/2025/01/27/dependency-inversion-without-inversion-of-control",
    "raw": "\n\n\n<div id=\"post\">\n    <p>\n        <em>Here, have a sandwich.</em>\n    </p>\n    <p>\n        For years I've been thinking about the <a href=\"https://en.wikipedia.org/wiki/Dependency_inversion_principle\">Dependency Inversion Principle</a> (DIP) and <a href=\"https://en.wikipedia.org/wiki/Inversion_of_control\">Inversion of Control</a> (IoC) as two different things. While there's some overlap, they're not the same. To make matters more confusing, most people seem to consider IoC and Dependency Injection (DI) as interchangeable synonyms. As <a href=\"https://blogs.cuttingedge.it/\">Steven van Deursen</a> and I explain in <a href=\"/dippp\">DIPPP</a>, they're not the same.\n    </p>\n    <p>\n        I recently found myself in a discussion on Stack Overflow where I was <a href=\"https://stackoverflow.com/a/78796558/126014\">trying to untangle that confusion</a> for a fellow Stack Overflow user. While I hadn't included a pedagogical Venn diagram, perhaps I should have.\n    </p>\n    <p>\n        <img src=\"/content/binary/dip-ioc-venn.png\" alt=\"Venn diagram with DIP to the left and IoC to the right. The intersection is substantial, but not overwhelming.\">\n    </p>\n    <p>\n        This figure suggests that the sets are of equal size, which doesn't have to be the case. The point, rather, is that while the intersection may be substantial, each <a href=\"https://en.wikipedia.org/wiki/Complement_(set_theory)\">relative complement</a> is not only not empty, but richly populated.\n    </p>\n    <p>\n        In this article, I'm not going to spend more time on the complement IoC without DIP. Rather, I'll expand on how to apply the DIP without IoC.\n    </p>\n    <h3 id=\"a51dd63df2474002b81bee601c86eb8d\">\n        Appeal to authority? <a href=\"#a51dd63df2474002b81bee601c86eb8d\">#</a>\n    </h3>\n    <p>\n        While writing the Stack Overflow answer, I'd tried to keep citations to 'original sources'. Sometimes, when a problem is technically concrete, it makes sense for me to link to one of my own works, but I've found that when the discussion is more abstract, that rarely helps convincing people. That's understandable. I'd also be sceptical if I were to run into some rando that immediately proceeded to argue a case by linking to his or her own blog.\n    </p>\n    <p>\n        This strategy, however elicited this response:\n    </p>\n    <blockquote>\n        <p>\n            \"Are you aware of any DIP-compliant example from Robert Martin that does not utilize polymorphism? The <a href=\"https://web.archive.org/web/20110714224327/http://www.objectmentor.com/resources/articles/dip.pdf\">original paper</a> along with some of Martin's <a href=\"https://www.youtube.com/watch?v=1XRTvj__ZPY\">lectures</a> certainly seem to imply the DIP requires polymorphism.\"\n        </p>\n        <p>\n        <footer><cite><a href=\"https://stackoverflow.com/questions/78796242/does-the-dependency-inversion-principle-apply-within-application-layers/78796558#comment138931008_78796558\">comment</a>, jaco0646</footer>\n    </blockquote>\n    <p>\n        That's a fair question, and once I started looking for such examples, I had to admit that I couldn't find any. Eventually, I asked <a href=\"https://en.wikipedia.org/wiki/Robert_C._Martin\">Robert C. Martin</a> directly.\n    </p>\n    <blockquote>\n        <p>\n            \"Does the DIP require polymorphism? I argue that it does't, but I've managed to entangle myself in a debate where original sources count. Could you help us out?\"\n        </p>\n        <footer><cite><a href=\"https://x.com/ploeh/status/1817141831500542202\">Tweet</a>, me</cite></footer>\n    </blockquote>\n    <p>\n        To which he answered in much detail, but of which the essential response was:\n    </p>\n    <blockquote>\n        <p>\n            \"The DIP does not require polymorphism. Polymorphism is just one of several mechanisms to achieve dependency inversion.\"\n        </p>\n        <footer><cite><a href=\"https://x.com/unclebobmartin/status/1817263979774816379\">Tweet</a>, Robert C. Martin</cite></footer>\n    </blockquote>\n    <p>\n        While this was the answer I'd hoped for, it's easy to dismiss this exchange as an <a href=\"https://en.wikipedia.org/wiki/Argument_from_authority\">appeal to authority</a>. On the other hand, as Carl Sagan said, \"If you wish to make an apple pie from scratch, you must first invent the universe,\" which obviously isn't practical, and so we instead <a href=\"https://en.wikipedia.org/wiki/Standing_on_the_shoulders_of_giants\">stand on the shoulders of giants</a>.\n    </p>\n    <p>\n        In this context, asking Robert C. Martin was relevant because he's the original author of works that introduce the DIP. It's reasonable to assume that he has relevant insights on the topic.\n    </p>\n    <p>\n        It's not that I can't argue my case independently, but rather that I didn't think that the comments section of a Stack Overflow question was the right place to do that. This blog, on the other hand, is mine, I can use all the words I'd like, and I'll now proceed to do so.\n    </p>\n    <h3 id=\"bfe353d609ea45e48ffb0efe939f4c01\">\n        Kernel of the idea <a href=\"#bfe353d609ea45e48ffb0efe939f4c01\">#</a>\n    </h3>\n    <p>\n        All of Robert C. Martin's treatments of the DIP that I've found starts with the general idea and then proceeds to show examples of implementing it in code. As I've already mentioned, I haven't found a text of Martin's where the <em>example</em> doesn't utilize IoC.\n    </p>\n    <p>\n        The central idea, however, says nothing about IoC.\n    </p>\n    <blockquote>\n        <p>\n            \"A. High-level modules should not depend on low-level modules. Both should depend on abstractions.\n        </p>\n        <p>\n            \"B. Abstractions should not depend on details. Details should depend upon abstractions.\"\n        </p>\n        <footer><cite><a href=\"/ref/appp\">APPP</a>, Robert C. Martin</cite></footer>\n    </blockquote>\n    <p>\n        While only Martin knows what he actually meant, I can attempt a congenial reading of the work. What is most important here, I think, is that the word <em>abstraction</em> doesn't have to denote a particular kind of language construct, such as an abstract class or interface. Rather,\n    </p>\n    <blockquote>\n        <p>\n            \"Abstraction is <em>the elimination of the irrelevant and the amplification of the essential.</em>\"\n        </p>\n        <footer><cite><a href=\"/ref/doocautbm\">Designing Object-Oriented C++ Applications Using The Booch Method</a>, ch. 00, Robert C. Martin, his emphasis</cite></footer>\n    </blockquote>\n    <p>\n        The same connotation of <em>abstraction</em> seems to apply to the definition of the DIP. If, for example, we imagine that we consider a Domain Model, the business logic, as the essence we'd like to amplify, we may rightfully consider a particular persistence mechanism a detail. Even more concretely, if you want to take restaurant reservations via a <a href=\"https://en.wikipedia.org/wiki/REST\">REST</a> API, the <a href=\"/2020/01/27/the-maitre-d-kata\">business rules that determine whether or not you can accept a reservation</a> shouldn't depend on a particular database technology.\n    </p>\n    <p>\n        While code examples are useful, there's evidently a risk that if the examples are too much alike, it may constrain readers' thinking. All Martin's examples seem to involve IoC, but for years now, I've mostly been interested in the Dependency Inversion <em>Principle</em> itself. Abstractions should not depend on details. That's the kernel of the idea.\n    </p>\n    <h3 id=\"cd07b6543fda4612bb0cce38c098cfbc\">\n        IoC isn't functional <a href=\"#cd07b6543fda4612bb0cce38c098cfbc\">#</a>\n    </h3>\n    <p>\n        My thinking was probably helped along by exploring functional programming (FP). A natural question arises when one embarks on learning FP: How does IoC fit with FP? The short answer, it turns out, is that <a href=\"/2017/01/27/from-dependency-injection-to-dependency-rejection\">it doesn't</a>. DI, at least, <a href=\"/2017/01/30/partial-application-is-dependency-injection\">makes everything impure</a>.\n    </p>\n    <p>\n        Does this mean, then, that FP precludes the DIP? That would be a problem, since the notion that abstractions shouldn't depend on details seems important. Doing FP shouldn't entail giving up on important architectural rules. And fortunately, it turns out not being the case. Quite the contrary, a consistent application of <a href=\"/2018/11/19/functional-architecture-a-definition\">functional architecture</a> seems to <a href=\"/2016/03/18/functional-architecture-is-ports-and-adapters\">lead to Ports and Adapters</a>. It'd go against the grain of FP to have a Domain Model query a relational database. Even if abstracted away, a database exists outside the process space of an application, and is inherently impure. IoC doesn't address that concern.\n    </p>\n    <p>\n        In FP, there are other ways to address such problems.\n    </p>\n    <h3 id=\"53b158bd928e4883992c578be989baf5\">\n        DIP sandwich <a href=\"#53b158bd928e4883992c578be989baf5\">#</a>\n    </h3>\n    <p>\n        While you can always model <a href=\"/2017/07/10/pure-interactions\">pure interactions</a> with free <a href=\"/2022/03/28/monads\">monads</a>, it's usually not necessary. In most cases, an <a href=\"/2020/03/02/impureim-sandwich\">Impureim Sandwich</a> suffices.\n    </p>\n    <p>\n        The sample code base that accompanies <a href=\"/2021/06/14/new-book-code-that-fits-in-your-head\">Code That Fits in Your Head</a> takes a similar approach. While it's <a href=\"/2024/12/16/a-restaurant-sandwich\">possible to refactor it to an explicit Impureim Sandwich</a>, the code presented in the book follows the kindred notion of <a href=\"https://www.destroyallsoftware.com/screencasts/catalog/functional-core-imperative-shell\">Functional Core, Imperative Shell</a>.\n    </p>\n    <p>\n        The code base implements an online restaurant reservation system, and the Domain Model is a set of data structures and pure functions that operate on them. The central and most complex function is the <code>WillAccept</code> method <a href=\"/2020/11/30/name-by-role\">shown here</a>. It decides whether to accept a reservation request, based on restaurant table configurations, existing reservations, business rules related to seating durations, etc. It does this without depending on details. It doesn't know about databases, the application's configuration system, or how to send emails in case it decides to accept a reservation.\n    </p>\n    <p>\n        All of this is handled by the application's HTTP Model, using the demarcation shown in <a href=\"/2023/09/04/decomposing-ctfiyhs-sample-code-base\">Decomposing CTFiYH's sample code base</a>. The HTTP Model defines Controllers, <a href=\"https://en.wikipedia.org/wiki/Data_transfer_object\">Data Transfer Objects</a> (DTOs), middleware, and other building blocks required to drive the actual REST API.\n    </p>\n    <p>\n        The <code>ReservationsController</code> class contains, among many other methods, this helper method that illustrates the point:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">async</span>&nbsp;Task&lt;ActionResult&gt;&nbsp;<span style=\"font-weight:bold;color:#74531f;\">TryCreate</span>(Restaurant&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">restaurant</span>,&nbsp;Reservation&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">reservation</span>)\n{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">using</span>&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">scope</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;TransactionScope(TransactionScopeAsyncFlowOption.Enabled);\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">reservations</span>&nbsp;=&nbsp;<span style=\"color:blue;\">await</span>&nbsp;Repository.ReadReservations(restaurant.Id,&nbsp;reservation.At);\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">now</span>&nbsp;=&nbsp;Clock.GetCurrentDateTime();\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">if</span>&nbsp;(!restaurant.MaitreD.WillAccept(now,&nbsp;reservations,&nbsp;reservation))\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;NoTables500InternalServerError();\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">await</span>&nbsp;Repository.Create(restaurant.Id,&nbsp;reservation);\n \n&nbsp;&nbsp;&nbsp;&nbsp;scope.Complete();\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;Reservation201Created(restaurant.Id,&nbsp;reservation);\n}</pre>\n    </p>\n    <p>\n        Notice the call to <code>restaurant.MaitreD.WillAccept</code>. The Controller gathers all data required to call the <a href=\"https://en.wikipedia.org/wiki/Pure_function\">pure function</a> and subsequently acts on the return value. This keeps the abstraction (<code>MaitreD</code>) free of implementation details.\n    </p>\n    <h3 id=\"cb60ef67d81e4754b959ff93d213ed80\">\n        DI addressing another concern <a href=\"#cb60ef67d81e4754b959ff93d213ed80\">#</a>\n    </h3>\n    <p>\n        You may be wondering what exactly <code>Repository</code> is. If you've bought the book, you also have access to the sample code base, in which case you'd be able to look it up. It turns out that it's an injected dependency. While this may seem a bit contradictory, it also gives me the opportunity to discuss that this isn't an all-or-nothing proposition.\n    </p>\n    <p>\n        Consider the architecture diagram from <a href=\"/2023/09/04/decomposing-ctfiyhs-sample-code-base\">Decomposing CTFiYH's sample code base</a>, repeated here for convenience:\n    </p>\n    <p>\n        <img src=\"/content/binary/ctfiyh-decomposed-architecture.png\" alt=\"Ports-and-adapters architecture diagram.\">\n    </p>\n    <p>\n        In the context of this diagram, the DIP is being applied in two different ways. From the outer Web Host to the HTTP Model, the decomposed code base uses ordinary DI. From the HTTP Model to the Domain Model, there's no inversion of control, but rather the important essence of the DIP: That the Domain Model doesn't depend on any of the details that surrounds it. Even so, the dependencies remain inverted, as indicated by the arrows.\n    </p>\n    <p>\n        What little DI that's left remains to support automated testing. Injecting <code>Repository</code> and a few other <a href=\"https://stackoverflow.blog/2022/01/03/favor-real-dependencies-for-unit-testing/\">real dependencies</a> enabled me to test-drive the externally visible behaviour of the system with <a href=\"/2019/02/18/from-interaction-based-to-state-based-testing\">state-based</a> <a href=\"/2021/01/25/self-hosted-integration-tests-in-aspnet\">self-hosted tests</a>.\n    </p>\n    <p>\n        If I hadn't cared about that, I could have hard-coded the <code>SqlReservationsRepository</code> object directly into the Controller and merged the Web Host with the HTTP Module. The Web Host is quite minimal anyway. This would, of course, have meant that the DIP no longer applied at that level, but even so, the interaction between the HTTP Model and the Domain Model would still follow the principle.\n    </p>\n    <p>\n        One important point about the above figure is that it's not to scale. The Web Host is in reality just six small classes, and the SQL and SMTP libraries each only contain a single class.\n    </p>\n    <h3 id=\"4f8fe34378a34bf4b3a6ebe9188c8d9b\">\n        Conclusion <a href=\"#4f8fe34378a34bf4b3a6ebe9188c8d9b\">#</a>\n    </h3>\n    <p>\n        Despite the name similarity, the Dependency Inversion Principle isn't equivalent with Inversion of Control or Dependency Injection. There's a sizeable intersection between the two, but the DIP doesn't <em>require</em> IoC.\n    </p>\n    <p>\n        I often use the Functional Core, Imperative Shell architecture, or the Impureim Sandwich pattern to invert the dependencies without inverting control. This keeps most of my code more functional, which also means that it <a href=\"/2021/07/28/referential-transparency-fits-in-your-head\">fits better in my head</a> and is <a href=\"/2015/05/07/functional-design-is-intrinsically-testable\">intrinsically testable</a>.\n    </p>\n</div><hr>\n      This blog is totally free, but if you like it, please consider <a href=\"https://blog.ploeh.dk/support\">supporting it</a>.",
    "sanitized": "Here, have a sandwich.\n    \n    \n        For years I've been thinking about the Dependency Inversion Principle (DIP) and Inversion of Control (IoC) as two different things. While there's some overlap, they're not the same. To make matters more confusing, most people seem to consider IoC and Dependency Injection (DI) as interchangeable synonyms. As Steven van Deursen and I explain in DIPPP, they're not the same.\n    \n    \n        I recently found myself in a discussion on Stack Overflow where I was trying to untangle that confusion for a fellow Stack Overflow user. While I hadn't included a pedagogical Venn diagram, perhaps I should have.\n    \n    \n        \n    \n    \n        This figure suggests that the sets are of equal size, which doesn't have to be the case. The point, rather, is that while the intersection may be substantial, each relative complement is not only not empty, but richly populated.\n    \n    \n        In this article, I'm not going to spend more time on the complement IoC without DIP. Rather, I'll expand on how to apply the DIP without IoC.\n    \n    \n        Appeal to authority? #\n    \n    \n        While writing the Stack Overflow answer, I'd tried to keep citations to 'original sources'. Sometimes, when a problem is technically concrete, it makes sense for me to link to one of my own works, but I've found that when the discussion is more abstract, that rarely helps convincing people. That's understandable. I'd also be sceptical if I were to run into some rando that immediately proceeded to argue a case by linking to his or her own blog.\n    \n    \n        This strategy, however elicited this response:\n    \n    \n        \n            \"Are you aware of any DIP-compliant example from Robert Martin that does not utilize polymorphism? The original paper along with some of Martin's lectures certainly seem to imply the DIP requires polymorphism.\"\n        \n        \n        comment, jaco0646\n    \n    \n        That's a fair question, and once I started looking for such examples, I had to admit that I couldn't find any. Eventually, I asked Robert C. Martin directly.\n    \n    \n        \n            \"Does the DIP require polymorphism? I argue that it does't, but I've managed to entangle myself in a debate where original sources count. Could you help us out?\"\n        \n        Tweet, me\n    \n    \n        To which he answered in much detail, but of which the essential response was:\n    \n    \n        \n            \"The DIP does not require polymorphism. Polymorphism is just one of several mechanisms to achieve dependency inversion.\"\n        \n        Tweet, Robert C. Martin\n    \n    \n        While this was the answer I'd hoped for, it's easy to dismiss this exchange as an appeal to authority. On the other hand, as Carl Sagan said, \"If you wish to make an apple pie from scratch, you must first invent the universe,\" which obviously isn't practical, and so we instead stand on the shoulders of giants.\n    \n    \n        In this context, asking Robert C. Martin was relevant because he's the original author of works that introduce the DIP. It's reasonable to assume that he has relevant insights on the topic.\n    \n    \n        It's not that I can't argue my case independently, but rather that I didn't think that the comments section of a Stack Overflow question was the right place to do that. This blog, on the other hand, is mine, I can use all the words I'd like, and I'll now proceed to do so.\n    \n    \n        Kernel of the idea #\n    \n    \n        All of Robert C. Martin's treatments of the DIP that I've found starts with the general idea and then proceeds to show examples of implementing it in code. As I've already mentioned, I haven't found a text of Martin's where the example doesn't utilize IoC.\n    \n    \n        The central idea, however, says nothing about IoC.\n    \n    \n        \n            \"A. High-level modules should not depend on low-level modules. Both should depend on abstractions.\n        \n        \n            \"B. Abstractions should not depend on details. Details should depend upon abstractions.\"\n        \n        APPP, Robert C. Martin\n    \n    \n        While only Martin knows what he actually meant, I can attempt a congenial reading of the work. What is most important here, I think, is that the word abstraction doesn't have to denote a particular kind of language construct, such as an abstract class or interface. Rather,\n    \n    \n        \n            \"Abstraction is the elimination of the irrelevant and the amplification of the essential.\"\n        \n        Designing Object-Oriented C++ Applications Using The Booch Method, ch. 00, Robert C. Martin, his emphasis\n    \n    \n        The same connotation of abstraction seems to apply to the definition of the DIP. If, for example, we imagine that we consider a Domain Model, the business logic, as the essence we'd like to amplify, we may rightfully consider a particular persistence mechanism a detail. Even more concretely, if you want to take restaurant reservations via a REST API, the business rules that determine whether or not you can accept a reservation shouldn't depend on a particular database technology.\n    \n    \n        While code examples are useful, there's evidently a risk that if the examples are too much alike, it may constrain readers' thinking. All Martin's examples seem to involve IoC, but for years now, I've mostly been interested in the Dependency Inversion Principle itself. Abstractions should not depend on details. That's the kernel of the idea.\n    \n    \n        IoC isn't functional #\n    \n    \n        My thinking was probably helped along by exploring functional programming (FP). A natural question arises when one embarks on learning FP: How does IoC fit with FP? The short answer, it turns out, is that it doesn't. DI, at least, makes everything impure.\n    \n    \n        Does this mean, then, that FP precludes the DIP? That would be a problem, since the notion that abstractions shouldn't depend on details seems important. Doing FP shouldn't entail giving up on important architectural rules. And fortunately, it turns out not being the case. Quite the contrary, a consistent application of functional architecture seems to lead to Ports and Adapters. It'd go against the grain of FP to have a Domain Model query a relational database. Even if abstracted away, a database exists outside the process space of an application, and is inherently impure. IoC doesn't address that concern.\n    \n    \n        In FP, there are other ways to address such problems.\n    \n    \n        DIP sandwich #\n    \n    \n        While you can always model pure interactions with free monads, it's usually not necessary. In most cases, an Impureim Sandwich suffices.\n    \n    \n        The sample code base that accompanies Code That Fits in Your Head takes a similar approach. While it's possible to refactor it to an explicit Impureim Sandwich, the code presented in the book follows the kindred notion of Functional Core, Imperative Shell.\n    \n    \n        The code base implements an online restaurant reservation system, and the Domain Model is a set of data structures and pure functions that operate on them. The central and most complex function is the WillAccept method shown here. It decides whether to accept a reservation request, based on restaurant table configurations, existing reservations, business rules related to seating durations, etc. It does this without depending on details. It doesn't know about databases, the application's configuration system, or how to send emails in case it decides to accept a reservation.\n    \n    \n        All of this is handled by the application's HTTP Model, using the demarcation shown in Decomposing CTFiYH's sample code base. The HTTP Model defines Controllers, Data Transfer Objects (DTOs), middleware, and other building blocks required to drive the actual REST API.\n    \n    \n        The ReservationsController class contains, among many other methods, this helper method that illustrates the point:\n    \n    \n        private async Task<ActionResult> TryCreate(Restaurant restaurant, Reservation reservation)\n{\n    using var scope = new TransactionScope(TransactionScopeAsyncFlowOption.Enabled);\n \n    var reservations = await Repository.ReadReservations(restaurant.Id, reservation.At);\n    var now = Clock.GetCurrentDateTime();\n    if (!restaurant.MaitreD.WillAccept(now, reservations, reservation))\n        return NoTables500InternalServerError();\n \n    await Repository.Create(restaurant.Id, reservation);\n \n    scope.Complete();\n \n    return Reservation201Created(restaurant.Id, reservation);\n}\n    \n    \n        Notice the call to restaurant.MaitreD.WillAccept. The Controller gathers all data required to call the pure function and subsequently acts on the return value. This keeps the abstraction (MaitreD) free of implementation details.\n    \n    \n        DI addressing another concern #\n    \n    \n        You may be wondering what exactly Repository is. If you've bought the book, you also have access to the sample code base, in which case you'd be able to look it up. It turns out that it's an injected dependency. While this may seem a bit contradictory, it also gives me the opportunity to discuss that this isn't an all-or-nothing proposition.\n    \n    \n        Consider the architecture diagram from Decomposing CTFiYH's sample code base, repeated here for convenience:\n    \n    \n        \n    \n    \n        In the context of this diagram, the DIP is being applied in two different ways. From the outer Web Host to the HTTP Model, the decomposed code base uses ordinary DI. From the HTTP Model to the Domain Model, there's no inversion of control, but rather the important essence of the DIP: That the Domain Model doesn't depend on any of the details that surrounds it. Even so, the dependencies remain inverted, as indicated by the arrows.\n    \n    \n        What little DI that's left remains to support automated testing. Injecting Repository and a few other real dependencies enabled me to test-drive the externally visible behaviour of the system with state-based self-hosted tests.\n    \n    \n        If I hadn't cared about that, I could have hard-coded the SqlReservationsRepository object directly into the Controller and merged the Web Host with the HTTP Module. The Web Host is quite minimal anyway. This would, of course, have meant that the DIP no longer applied at that level, but even so, the interaction between the HTTP Model and the Domain Model would still follow the principle.\n    \n    \n        One important point about the above figure is that it's not to scale. The Web Host is in reality just six small classes, and the SQL and SMTP libraries each only contain a single class.\n    \n    \n        Conclusion #\n    \n    \n        Despite the name similarity, the Dependency Inversion Principle isn't equivalent with Inversion of Control or Dependency Injection. There's a sizeable intersection between the two, but the DIP doesn't require IoC.\n    \n    \n        I often use the Functional Core, Imperative Shell architecture, or the Impureim Sandwich pattern to invert the dependencies without inverting control. This keeps most of my code more functional, which also means that it fits better in my head and is intrinsically testable.\n    \n\n      This blog is totally free, but if you like it, please consider supporting it."
  },
  {
    "itemId": "https://blog.ploeh.dk/2025/01/20/modelling-data-relationships-with-f-types",
    "raw": "\n\n\n<div id=\"post\">\n    <p>\n        <em>An F# example implementation of Ghosts of Departed Proofs.</em>\n    </p>\n    <p>\n        In a previous article, <a href=\"/2025/01/06/encapsulating-rod-cutting\">Encapsulating rod-cutting</a>, I used a code example to discuss how to communicate an API's contract to client developers; that is, users of the API. In the article, I wrote\n    </p>\n    <blockquote>\n        <p>\n            \"All this said, however, it's also possible that I'm missing an obvious design alternative. If you can think of a way to model this relationship in a non-<a href=\"https://www.hillelwayne.com/post/constructive/\">predicative</a> way, please <a href=\"https://github.com/ploeh/ploeh.github.com?tab=readme-ov-file#comments\">write a comment</a>.\"\n        </p>\n    </blockquote>\n    <p>\n        And indeed, a reader helpfully offered an alternative:\n    </p>\n    <blockquote>\n        <p>\n            \"Regarding the relation between the array and the index, you will find the paper called \"Ghosts of departed proofs\" interesting. Maybe an overkill in this case, maybe not, but a very interesting and useful technique in general.\"\n        </p>\n        <footer><cite><a href=\"https://x.com/Savlambda/status/1876227452886012014\">borar</a></cite></footer>\n    </blockquote>\n    <p>\n        I wouldn't call it 'an <em>obvious</em> design alternative', but nonetheless find it interesting. In this article, I'll pick up the code from <a href=\"/2025/01/06/encapsulating-rod-cutting\">Encapsulating rod-cutting</a> and show how the 'Ghosts of Departed Proofs' (GDP) technique may be applied.\n    </p>\n    <h3 id=\"c43d4e8c8e414b46bf65817e7b00e85e\">\n        Problem review <a href=\"#c43d4e8c8e414b46bf65817e7b00e85e\">#</a>\n    </h3>\n    <p>\n        Before we start with the GDP technique, a brief review of the problem is in order. For the complete overview, you should read the <a href=\"/2025/01/06/encapsulating-rod-cutting\">Encapsulating rod-cutting</a> article. In the present article, however, we'll focus on one particular problem related to <a href=\"/2022/10/24/encapsulation-in-functional-programming\">encapsulation</a>:\n    </p>\n    <p>\n        Ideally, the <code>cut</code> function should take two input arguments. The first argument, <code>p</code>, is an array or list of prices. The second argument, <code>n</code>, is the size of a rod to cut optimally. One precondition states that <code>n</code> must be less than or equal to the length of <code>p</code>. This is because the algorithm needs to look up the price of a rod of size <code>n</code>, and it can't do that if <code>n</code> is greater than the length of <code>p</code>. The implied relationship is that <code>p</code> is indexed by rod size, so that if you want to find the price of a rod of size <code>n</code>, you look at the nth element in <code>p</code>.\n    </p>\n    <p>\n        How may we model such a relationship in a way that protects the precondition?\n    </p>\n    <p>\n        An obvious choice, particularly in object-oriented design, is to use a <a href=\"https://en.wikipedia.org/wiki/Guard_(computer_science)\">Guard Clause</a>. In the <a href=\"https://fsharp.org/\">F#</a> code base, it might look like this:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;:&nbsp;_&nbsp;<span style=\"color:#2b91af;\">array</span>)&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>.Length&nbsp;&lt;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">then</span>&nbsp;<span style=\"color:blue;\">raise</span>&nbsp;(<span style=\"color:#2b91af;\">ArgumentOutOfRangeException</span>&nbsp;<span style=\"color:#a31515;\">&quot;n&nbsp;must&nbsp;be&nbsp;less&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;p&quot;</span>)\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;The&nbsp;rest&nbsp;of&nbsp;the&nbsp;function&nbsp;body...</span></pre>\n    </p>\n    <p>\n        You might argue that in F# and other functional programming languages, throwing exceptions isn't <a href=\"/2015/08/03/idiomatic-or-idiosyncratic\">idiomatic</a>. Instead, you ought to return <code>Result</code> or <code>Option</code> values, here the latter:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;:&nbsp;_&nbsp;<span style=\"color:#2b91af;\">array</span>)&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>.Length&nbsp;&lt;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">then</span>&nbsp;<span style=\"color:#2b91af;\">None</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">else</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;The&nbsp;rest&nbsp;of&nbsp;the&nbsp;function&nbsp;body...</span></pre>\n    </p>\n    <p>\n        To be clear, in most code bases, this is exactly what I would do. What follows is rather exotic, and hardly suitable for all use cases.\n    </p>\n    <h3 id=\"9457df27904b4b9ea65b4713dea20fbd\">\n        Proofs as values <a href=\"#9457df27904b4b9ea65b4713dea20fbd\">#</a>\n    </h3>\n    <p>\n        It's not too hard to model the lower boundary of the <code>n</code> parameter. As is often the case, it turns out that the number must be a natural number. I already covered that in the <a href=\"/2025/01/06/encapsulating-rod-cutting\">previous article</a>. It's much harder, however, to model the upper boundary of the value, because it depends on the size of <code>p</code>.\n    </p>\n    <p>\n        The following is based on the paper <a href=\"https://dl.acm.org/doi/10.1145/3242744.3242755\">Ghosts of Departed Proofs</a>, as well as <a href=\"https://gist.github.com/Savelenko/9f21c63fdc00b52a64739122176b7453\">a helpful Gist</a> also provided by Borar. (The link to the paper is to what I believe is the 'official' page for it, and since it's part of the ACM digital library, it's behind a paywall. Even so, as is the case with most academic papers, it's easy enough to find a PDF of it somewhere else. Not that I endorse content piracy, but it's my impression that academic papers are usually disseminated by the authors themselves.)\n    </p>\n    <p>\n        The idea is to enable a library to issue a 'proof' about a certain condition. In the example I'm going to use here, the proof is that a certain number is in the valid range for a given list of prices.\n    </p>\n    <p>\n        We actually can't entirely escape the need for a run-time check, but we do gain two other benefits. The first is that we're now using the type system to communicate a relationship that otherwise would have to be described in written documentation. The second is that once the proof has been issued, there's no need to perform additional run-time checks.\n    </p>\n    <p>\n        This can help move an API towards a more total, as opposed to <a href=\"https://en.wikipedia.org/wiki/Partial_function\">partial</a>, definition, which again moves towards what Michael Feathers calls <a href=\"https://youtu.be/AnZ0uTOerUI?si=1gJXYFoVlNTSbjEt\">unconditional code</a>. This is particularly useful if the alternative is an API that 'forgets' which run-time guarantees have already been checked. The paper has some examples. I've also recently encountered similar situations when doing <a href=\"https://adventofcode.com/2024\">Advent of Code 2024</a>. Many days my solution involved immutable maps (like hash tables) that I'd recurse over. In many cases I'd write an algorithm where I with absolute certainty knew that a particular key was in the map (if, for example, I'd just put it there three lines earlier). In such cases, you don't want a total function that returns an option or <a href=\"/2022/04/25/the-maybe-monad\">Maybe</a> value. You want a partial function. Or a type-level guarantee that the value is, indeed, in the map.\n    </p>\n    <p>\n        For the example in this article, it's overkill, so you may wonder what the point is. On the other hand, a simple example makes it easier to follow what's going on. Hopefully, once you understand the technique, you can extrapolate it to situations where it might be more warranted.\n    </p>\n    <h3 id=\"46bc8e47a37f43b3b126946ac29239b0\">\n        Proof contexts <a href=\"#46bc8e47a37f43b3b126946ac29239b0\">#</a>\n    </h3>\n    <p>\n        The overall idea should look familiar to practitioners of statically-typed functional programming. Instead of plain functions and data structures, we introduce a special 'context' in which we have to run our computations. This is similar to how <a href=\"/2023/01/09/the-io-monad\">the IO monad</a> works, or, in fact, most monads. You're not supposed to <a href=\"/2019/02/04/how-to-get-the-value-out-of-the-monad\">get the value out of the monad</a>. Rather, you should inject the desired behaviour <em>into</em> the monad.\n    </p>\n    <p>\n        We find a similar design with existential types, or with the <a href=\"https://hackage.haskell.org/package/base/docs/Control-Monad-ST.html\">ST monad</a>, on which the ideas in the GDP paper are acknowledged to be based. We even see a mutation-based variation in the article <a href=\"/2024/06/24/a-mutable-priority-collection\">A mutable priority collection</a>, where we may think of the <code>Edit</code> API as a variation of the ST monad, since it allows 'localized' state mutation.\n    </p>\n    <p>\n        I'll attempt to illustrate it like this:\n    </p>\n    <p>\n        <img src=\"/content/binary/library-with-computation-context.png\" alt=\"A box labelled 'library' with a 'sandbox' area inside. To its left, another box labelled 'Client code' with an arrow to the library box, as well as an arrow to a box inside the sandbox area labelled 'Client computation'.\">\n    </p>\n    <p>\n        A library offers a set of functions and data structures for immediate use. In addition, it also provides a <a href=\"https://en.wikipedia.org/wiki/Higher-order_function\">higher-oder function</a> that enables client code to embed a computation into a special 'sandbox' area where special rules apply. The paper calls such a context a 'name', which it does because it's trying to be as general as possible. As I'm writing this, I find it easier to think of this 'sandbox' as a 'proof context'. It's a context in which proof values exist. Crucially, as we shall see, they don't exist outside of this context.\n    </p>\n    <h3 id=\"50d1ba9968d04529be3cbccfd6b05061\">\n        Size proofs <a href=\"#50d1ba9968d04529be3cbccfd6b05061\">#</a>\n    </h3>\n    <p>\n        In the rod-cutting example, we particularly care about proving that a given number <code>n</code> is within the size of the price list. We do this by representing the proof as a value:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">type</span>&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;&nbsp;=&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:#2b91af;\">Size</span>&nbsp;<span style=\"color:blue;\">of</span>&nbsp;<span style=\"color:#2b91af;\">int</span>&nbsp;<span style=\"color:blue;\">with</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">member</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>.Value&nbsp;=&nbsp;<span style=\"color:blue;\">let</span>&nbsp;(<span style=\"color:#2b91af;\">Size</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>&nbsp;<span style=\"color:blue;\">in</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">override</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>.<span style=\"font-weight:bold;color:#74531f;\">ToString</span>&nbsp;()&nbsp;=&nbsp;<span style=\"color:blue;\">let</span>&nbsp;(<span style=\"color:#2b91af;\">Size</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>&nbsp;<span style=\"color:blue;\">in</span>&nbsp;<span style=\"color:#74531f;\">string</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span></pre>\n    </p>\n    <p>\n        Two things are special about this type definition:\n    </p>\n    <ul>\n        <li>The constructor is <code>private</code>.</li>\n        <li>It has a phantom type <code>'a</code>.</li>\n    </ul>\n    <p>\n        A phantom type is a generic type parameter that has no run-time value. Notice that <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> contains no value of the type <code>'a</code>. The type only exists at compile-time.\n    </p>\n    <p>\n        You can think of the type parameter as similar to a security token. The issuer of the proof associates a particular security token to vouch for its validity. Usually, when we talk about security tokens, they do have a run-time representation (typically a byte array) because we need to exchange them with other processes. This is, for example, how claims-based authentication works.\n    </p>\n    <p>\n        <img src=\"/content/binary/claim-with-certificate.png\" alt=\"A box labelled 'claim'. The box has a ribboned seal in the lower right corner.\" width=\"200\">\n    </p>\n    <p>\n        In this case, our concern isn't security. Rather, we wish to communicate and enforce certain relationships. Since we wish to leverage the type system, we use a type as a token.\n    </p>\n    <p>\n        <img src=\"/content/binary/size-with-phantom-type.png\" alt=\"A box labelled 'size'. The box has another label in the lower right corner with the generic type argument 'a.\" width=\"200\">\n    </p>\n    <p>\n        Since the <code>Size</code> constructor is <code>private</code>, the library controls how it issues proofs, a bit like a claims issuer can sign a claim with its private key.\n    </p>\n    <p>\n        Okay, but how are <code>Size</code> proofs issued?\n    </p>\n    <h3 id=\"28af8638928c4327b0c3a43d6c36711f\">\n        Issuing size proofs <a href=\"#28af8638928c4327b0c3a43d6c36711f\">#</a>\n    </h3>\n    <p>\n        As you'll see later, more than one API may issue <code>Size</code> proofs, but the most fundamental is that you can query a price list for such a proof:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">type</span>&nbsp;<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;&nbsp;=&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:#2b91af;\">PriceList</span>&nbsp;<span style=\"color:blue;\">of</span>&nbsp;<span style=\"color:#2b91af;\">int</span>&nbsp;<span style=\"color:#2b91af;\">list</span>&nbsp;<span style=\"color:blue;\">with</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">member</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>.Length&nbsp;=&nbsp;<span style=\"color:blue;\">let</span>&nbsp;(<span style=\"color:#2b91af;\">PriceList</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>)&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>&nbsp;<span style=\"color:blue;\">in</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>.Length\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">member</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>.<span style=\"font-weight:bold;color:#74531f;\">trySize</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>&nbsp;:&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;&nbsp;<span style=\"color:#2b91af;\">option</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>&nbsp;0&nbsp;&lt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>&nbsp;&amp;&amp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>&nbsp;&lt;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>.Length\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">then</span>&nbsp;<span style=\"color:#2b91af;\">Some</span>&nbsp;(<span style=\"color:#2b91af;\">Size</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">else</span>&nbsp;<span style=\"color:#2b91af;\">None</span></pre>\n    </p>\n    <p>\n        The <code>trySize</code> member function issues a <code><span style=\"color:#2b91af;\">Some</span> <span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> value if the <code>candidate</code> is within the size of the price array. As discussed above, we can't completely avoid a run-time check, but now that we have the proof, we don't need to <em>repeat</em> that run-time check if we wanted to use a particular <code>Size</code> value with the same <code>PriceList</code>.\n    </p>\n    <p>\n        Notice how immutability is an essential part of this design. If, in the object-oriented manner, we allow a price list to change, we could make it shorter. This could invalidate some proof that we previously issued. Since, however, the price list is immutable, we can trust that once we've checked a size, it remains valid. You can also think of this as a sort of <a href=\"/encapsulation-and-solid\">encapsulation</a>, in the sense that once we've assured ourselves that an object, or here rather a value, is valid, it remains valid. Indeed, <a href=\"/2024/06/12/simpler-encapsulation-with-immutability\">encapsulation is simpler with immutability</a>.\n    </p>\n    <p>\n        You probably still have some questions. For instance, how do we ensure that a size proof issued by one price list can't be used against another price list? Imagine that you have two price lists. One has ten prices, the other twenty. You could have the larger one issue a proof that <em>size 17</em> is valid. What prevents you from using that proof with the smaller price list?\n    </p>\n    <p>\n        That's the job of that phantom type. Notice how a <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> issues a <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> proof. It's the same generic type argument.\n    </p>\n    <p>\n        Usually, I <a href=\"/2024/11/04/pendulum-swing-no-haskell-type-annotation-by-default\">extol F#'s type inference</a>. I prefer not having to use type annotations unless I have to. When it comes to GDP, however, type annotations are necessary, because we need these phantom types to line up. Without the type annotations, they wouldn't do that.\n    </p>\n    <p>\n        In the above example, the smaller price list might have the type <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> and the larger one the type <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;b</span>&gt;</code>. The smaller would issue proofs of the type <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code>, and the larger one proofs of the type <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;b</span>&gt;</code>. As you'll see, you can't use a <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> where a <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;b</span>&gt;</code> is required, or vice versa.\n    </p>\n    <p>\n        You may still wonder how one then creates <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> values. After all, that type also has a <code>private</code> constructor.\n    </p>\n    <p>\n        We'll get back to that later.\n    </p>\n    <h3 id=\"193350b5b4ab4327b021ac42403dab11\">\n        Proof-based cut API <a href=\"#193350b5b4ab4327b021ac42403dab11\">#</a>\n    </h3>\n    <p>\n        Before we look at how client code may consume APIs based on proofs such as <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code>, we should review their expressive power. What does this design enable us to say?\n    </p>\n    <p>\n        While the first example above, with the Guard Clause alternative, was based on the initial imperative implementation shown in the article <a href=\"/2024/12/23/implementing-rod-cutting\">Implementing rod-cutting</a>, the rest of the present article builds on the refactored code from <a href=\"/2025/01/06/encapsulating-rod-cutting\">Encapsulating rod-cutting</a>.\n    </p>\n    <p>\n        The first change I need to introduce is to the <code>Cut</code> record type:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">type</span>&nbsp;<span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;&nbsp;=&nbsp;{&nbsp;Revenue&nbsp;:&nbsp;<span style=\"color:#2b91af;\">int</span>;&nbsp;Size&nbsp;:&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;&nbsp;}</pre>\n    </p>\n    <p>\n        Notice that I've changed the type of the <code>Size</code> property to <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code>. This has the implication that <code><span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> now also has a phantom type, and since client code can't create <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> values, by transitivity it means that neither can client code create <code><span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> values. These values can only be issued as proofs.\n    </p>\n    <p>\n        This enables us to change the type definition of the <code>cut</code> function:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;(<span style=\"color:#2b91af;\">PriceList</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;:&nbsp;<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;)&nbsp;(<span style=\"color:#2b91af;\">Size</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;:&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;)&nbsp;:&nbsp;<span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;&nbsp;<span style=\"color:#2b91af;\">list</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Implementation&nbsp;follows&nbsp;here...</span></pre>\n    </p>\n    <p>\n        Notice how all the phantom types line up. In order to call the function, client code must supply a <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> value issued by a compatible <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> value. Upon a valid call, the function returns a list of <code><span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> values.\n    </p>\n    <p>\n        Pay attention to what is being communicated. You may find this strange and impenetrable, but for a reader who understands GDP, much about the contract is communicated through the types. We can see that <code>n</code> relates to <code>prices</code>, because the 'proof token' (the generic type parameter <code>'a</code>) is the same for both arguments. A reader who understands how <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> proofs are issued will now understand what the preconditions is: The <code>n</code> argument must be valid according to the size of the <code>prices</code> argument.\n    </p>\n    <p>\n        The type of the <code>cut</code> function also communicates a postcondition: It guarantees that the <code>Size</code> values of each <code><span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> returned is valid according to the supplied <code>prices</code>. In other words, it means that no <a href=\"/2013/07/08/defensive-coding\">defensive coding</a> is necessary. Client code doesn't have to check whether or not the price of each indicated cut can actually be found in <code>prices</code>. The types guarantee that they can.\n    </p>\n    <p>\n        You may consider the <code>cut</code> function a 'secondary' issuer of <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> proofs, since it returns such values. If you wanted to call <code>cut</code> again with one of those values, you could.\n    </p>\n    <p>\n        Compared to the previous article, I don't think I changed much else in the <code>cut</code> function, besides the initial function declaration, and the last line of code, but for good measure, here's the entire function:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;(<span style=\"color:#2b91af;\">PriceList</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;:&nbsp;<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;)&nbsp;(<span style=\"color:#2b91af;\">Size</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;:&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;)&nbsp;:&nbsp;<span style=\"color:#2b91af;\">Cut</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;&nbsp;<span style=\"color:#2b91af;\">list</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Implementation&nbsp;follows&nbsp;here...</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;=&nbsp;0&nbsp;<span style=\"color:#2b91af;\">::</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">ofList</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">findBestCut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[1..<span style=\"font-weight:bold;color:#1f377f;\">j</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">map</span>&nbsp;(<span style=\"color:blue;\">fun</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"color:#2b91af;\">Map</span>.<span style=\"color:#74531f;\">find</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">maxBy</span>&nbsp;<span style=\"color:#74531f;\">fst</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">aggregate</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">acc</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">snd</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">acc</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">q</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">findBestCut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cuts</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">fst</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">acc</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#74531f;\">cuts</span>&nbsp;&lt;&lt;&nbsp;(<span style=\"color:#74531f;\">cons</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">q</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)),&nbsp;<span style=\"color:#2b91af;\">Map</span>.<span style=\"color:#74531f;\">add</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>.Count&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">q</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;[1..<span style=\"font-weight:bold;color:#1f377f;\">n</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">fold</span>&nbsp;<span style=\"color:#74531f;\">aggregate</span>&nbsp;(<span style=\"color:#74531f;\">id</span>,&nbsp;<span style=\"color:#2b91af;\">Map</span>.<span style=\"color:#74531f;\">add</span>&nbsp;0&nbsp;0&nbsp;<span style=\"color:#2b91af;\">Map</span>.empty)\n&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style=\"color:#74531f;\">fst</span>&nbsp;&lt;|&nbsp;[]&nbsp;<span style=\"color:green;\">//&nbsp;Evaluate&nbsp;Hughes&nbsp;list</span>\n&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">map</span>&nbsp;(<span style=\"color:blue;\">fun</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">r</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;{&nbsp;Revenue&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>;&nbsp;Size&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Size</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;})</pre>\n    </p>\n    <p>\n        The <code>cut</code> function is part of the same module as <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code>, so even though the constructor is <code>private</code>, the <code>cut</code> function can still use it.\n    </p>\n    <p>\n        Thus, the entire proof mechanism is for external use. Internally, the library code may take shortcuts, so it's up to the library author to convince him- or herself that the contract holds. In this case, I'm quite confident that the function only issues valid proofs. After all, I've lifted the algorithm from <a href=\"/ref/clrs\">an acclaimed text book</a>, and this particular implementation is covered by more than 10,000 test cases.\n    </p>\n    <h3 id=\"dcbcbee557a54a8aaa701484ad89e90f\">\n        Proof-based solve API <a href=\"#dcbcbee557a54a8aaa701484ad89e90f\">#</a>\n    </h3>\n    <p>\n        The <code>solve</code> code hasn't changed, I believe:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">solve</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:blue;\">rec</span>&nbsp;<span style=\"color:#74531f;\">imp</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;&lt;=&nbsp;0&nbsp;<span style=\"color:blue;\">then</span>&nbsp;[]&nbsp;<span style=\"color:blue;\">else</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">idx</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;-&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>[<span style=\"font-weight:bold;color:#1f377f;\">idx</span>].Size\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;<span style=\"color:#2b91af;\">::</span>&nbsp;<span style=\"color:#74531f;\">imp</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>.Value)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#74531f;\">imp</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>.Value</pre>\n    </p>\n    <p>\n        While the code hasn't changed, the type has. In this case, no explicit type annotations are necessary, because the types are already correctly inferred from the use of <code>cut</code>:\n    </p>\n    <p>\n        <pre>solve:&nbsp;prices:&nbsp;PriceList&lt;&#39;a&gt;&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;n:&nbsp;Size&lt;&#39;a&gt;&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;Size&lt;&#39;a&gt;&nbsp;list</pre>\n    </p>\n    <p>\n        Again, the phantom types line up as desired.\n    </p>\n    <h3 id=\"f2e9d4cab42b4d74bb472c3aee2e45ef\">\n        Proof-based revenue calculation <a href=\"#f2e9d4cab42b4d74bb472c3aee2e45ef\">#</a>\n    </h3>\n    <p>\n        Although I didn't show it in the previous article, I also included a function to calculate the revenue from a list of cuts. It gets the same treatment as the other functions:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">calculateRevenue</span>&nbsp;(<span style=\"color:#2b91af;\">PriceList</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;:&nbsp;<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;)&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>&nbsp;:&nbsp;<span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;&nbsp;<span style=\"color:#2b91af;\">list</span>)&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">sumBy</span>&nbsp;(<span style=\"color:blue;\">fun</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>[<span style=\"font-weight:bold;color:#1f377f;\">s</span>.Value&nbsp;-&nbsp;1])</pre>\n    </p>\n    <p>\n        Again we see how the GDP-based API communicates a precondition: The <code>cuts</code> must be valid according to the <code>prices</code>; that is, each cut, indicated by its <code>Size</code> property, must be guaranteed to be within the range defined by the price list. This makes the function total; or, unconditional code, as Michael Feathers would put it. The function can't fail at run time.\n    </p>\n    <p>\n        (I am, once more, deliberately ignoring the entirely independent problem of potential integer overflows.)\n    </p>\n    <p>\n        While you could repeatedly call <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;.<span style=\"font-weight:bold;color:#74531f;\">trySize</span></code> to produce a list of cuts, the most natural way to produce such a list of cuts is to first call <code>cut</code>, and then pass its result to <code>calculateRevenue</code>.\n    </p>\n    <p>\n        The function returns <code>int</code>.\n    </p>\n    <h3 id=\"0a22569816ad4b179a365d2dc3ad81f4\">\n        Proof-based printing <a href=\"#0a22569816ad4b179a365d2dc3ad81f4\">#</a>\n    </h3>\n    <p>\n        Finally, here's <code>printSolution</code>:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">printSolution</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">solve</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">iter</span>&nbsp;(<span style=\"color:#74531f;\">printfn</span>&nbsp;<span style=\"color:#a31515;\">&quot;</span><span style=\"color:#2b91af;\">%O</span><span style=\"color:#a31515;\">&quot;</span>)</pre>\n    </p>\n    <p>\n        It hasn't changed much since the previous incarnation, but the type is now <code>PriceList&lt;&#39;a&gt;&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;Size&lt;&#39;a&gt;&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;unit</code>. Again, the precondition is the same as for <code>cut</code>.\n    </p>\n    <h3 id=\"2216067c41c44ade8855e4c6f8216d6d\">\n        Running client code <a href=\"#2216067c41c44ade8855e4c6f8216d6d\">#</a>\n    </h3>\n    <p>\n        How in the world do you write client code against this API? After all, the types all have <code>private</code> constructors, so we can't create any values.\n    </p>\n    <p>\n        If you trace the code dependencies, you'll notice that <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> sits at the heart of the API. If you have a <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code>, you'd be able to produce the other values, too.\n    </p>\n    <p>\n        So how do you create a <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> value?\n    </p>\n    <p>\n        You don't. You call the following <code>runPrices</code> function, and give it a <code>PriceListRunner</code> that it'll embed and run in the 'sandbox' illustrated above.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">type</span>&nbsp;<span style=\"color:#2b91af;\">PriceListRunner</span>&lt;<span style=\"color:#2b91af;\">&#39;r</span>&gt;&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">abstract</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">Run</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;&nbsp;:&nbsp;<span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;<span style=\"color:#2b91af;\">&#39;r</span>\n \n<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">runPrices</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">ctx</span>&nbsp;:&nbsp;<span style=\"color:#2b91af;\">PriceListRunner</span>&lt;<span style=\"color:#2b91af;\">&#39;r</span>&gt;)&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">ctx</span>.<span style=\"font-weight:bold;color:#74531f;\">Run</span>&nbsp;(<span style=\"color:#2b91af;\">PriceList</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl</span>)</pre>\n    </p>\n    <p>\n        As the paper describes, the GDP trick hinges on rank-2 polymorphism, and the only way (that I know of) this is supported in F# is on methods. An object is therefore required, and we define the abstract <code><span style=\"color:#2b91af;\">PriceListRunner</span>&lt;<span style=\"color:#2b91af;\">&#39;r</span>&gt;</code> class for that purpose.\n    </p>\n    <p>\n        Client code must implement the abstract class to call the <code>runPrices</code> function. Fortunately, since F# has <a href=\"https://learn.microsoft.com/dotnet/fsharp/language-reference/object-expressions\">object expressions</a>, client code might look like this:\n    </p>\n    <p>\n        <pre>[&lt;<span style=\"color:#2b91af;\">Fact</span>&gt;]\n<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">``CLRS&nbsp;example``</span>&nbsp;()&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;=&nbsp;[1;&nbsp;5;&nbsp;8;&nbsp;9;&nbsp;10;&nbsp;17;&nbsp;17;&nbsp;20;&nbsp;24;&nbsp;30]\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">actual</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Rod</span>.<span style=\"color:#74531f;\">runPrices</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;{&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">PriceListRunner</span>&lt;_&gt;&nbsp;<span style=\"color:blue;\">with</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">member</span>&nbsp;__.<span style=\"font-weight:bold;color:#74531f;\">Run</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl</span>&nbsp;=&nbsp;<span style=\"color:blue;\">option</span>&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let!</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl</span>.<span style=\"font-weight:bold;color:#74531f;\">trySize</span>&nbsp;10\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Rod</span>.<span style=\"color:#74531f;\">cut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">return</span>&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">map</span>&nbsp;(<span style=\"color:blue;\">fun</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">c</span>&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">c</span>.Revenue,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">c</span>.Size.Value))&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>&nbsp;}&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;[\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;1,&nbsp;&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;5,&nbsp;&nbsp;2)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;8,&nbsp;&nbsp;3)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(10,&nbsp;&nbsp;2)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(13,&nbsp;&nbsp;2)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(17,&nbsp;&nbsp;6)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(18,&nbsp;&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(22,&nbsp;&nbsp;2)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(25,&nbsp;&nbsp;3)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(30,&nbsp;10)\n&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">Some</span>&nbsp;=!&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">actual</span></pre>\n    </p>\n    <p>\n        This is an <a href=\"https://xunit.net/\">xUnit.net</a> test where <code>actual</code> is produced by <code>runPrices</code> and an object expression that defines the code to run in the proof context. When the <code>Run</code> method runs, it runs with a concrete type that the compiler picked for <code>'a</code>. This type is only in scope within that method, and can't escape it.\n    </p>\n    <p>\n        The implementing class is given a <code><span style=\"color:#2b91af;\">PriceList</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> as an input argument. In this example, it tries to create a size of 10, which succeeds because the price list has ten elements.\n    </p>\n    <p>\n        Notice that the <code>Run</code> method transforms the <code>cuts</code> to tuples. Why doesn't it return <code>cuts</code> directly?\n    </p>\n    <p>\n        It can't. It's part of the deal. If I change the last line of <code>Run</code> to <code>return cuts</code>, the code no longer compiles. The compiler error is:\n    </p>\n    <blockquote>\n        <p>\n            This code is not sufficiently generic. The type variable 'a could not be generalized because it would escape its scope.\n        </p>\n    </blockquote>\n    <p>\n        Remember I wrote that <code>'a</code> can't escape the scope of <code>Run</code>? This is enforced by the type system.\n    </p>\n    <h3 id=\"6583d683c77c4bfba53f3f2c1195603e\">\n        Preventing misalignment <a href=\"#6583d683c77c4bfba53f3f2c1195603e\">#</a>\n    </h3>\n    <p>\n        You may already consider it a benefit that this kind of API design uses the type system to communicate pre- and postconditions. Perhaps you also wonder how it prevents errors. As already discussed, if you're dealing with multiple price lists, it shouldn't be possible to use a size proof issued by one, with another. Let's see how that might look. We'll start with a correctly coded unit test:\n    </p>\n    <p>\n        <pre>[&lt;<span style=\"color:#2b91af;\">Fact</span>&gt;]\n<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">``Nest&nbsp;two&nbsp;solutions``</span>&nbsp;()&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p1</span>&nbsp;=&nbsp;[1;&nbsp;2;&nbsp;2]\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p2</span>&nbsp;=&nbsp;[1]\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">actual</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Rod</span>.<span style=\"color:#74531f;\">runPrices</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p1</span>&nbsp;{&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">PriceListRunner</span>&lt;_&gt;&nbsp;<span style=\"color:blue;\">with</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">member</span>&nbsp;__.<span style=\"font-weight:bold;color:#74531f;\">Run</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl1</span>&nbsp;=&nbsp;<span style=\"color:blue;\">option</span>&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let!</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n1</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl1</span>.<span style=\"font-weight:bold;color:#74531f;\">trySize</span>&nbsp;3\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts1</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Rod</span>.<span style=\"color:#74531f;\">solve</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl1</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n1</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Rod</span>.<span style=\"color:#74531f;\">calculateRevenue</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl1</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts1</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let!</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">inner</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Rod</span>.<span style=\"color:#74531f;\">runPrices</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p2</span>&nbsp;{&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">PriceListRunner</span>&lt;_&gt;&nbsp;<span style=\"color:blue;\">with</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">member</span>&nbsp;__.<span style=\"font-weight:bold;color:#74531f;\">Run</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl2</span>&nbsp;=&nbsp;<span style=\"color:blue;\">option</span>&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let!</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n2</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl2</span>.<span style=\"font-weight:bold;color:#74531f;\">trySize</span>&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts2</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Rod</span>.<span style=\"color:#74531f;\">solve</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl2</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n2</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">return</span>&nbsp;<span style=\"color:#2b91af;\">Rod</span>.<span style=\"color:#74531f;\">calculateRevenue</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl2</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts2</span>&nbsp;}&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">return</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">r</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">inner</span>)&nbsp;}&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Some</span>&nbsp;(3,&nbsp;1)&nbsp;=!&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">actual</span></pre>\n    </p>\n    <p>\n        This code compiles because I haven't mixed up the <code>Size</code> or <code>Cut</code> values. What happens if I 'accidentally' change the 'inner' <code>Rod.solve</code> call to <code><span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts2</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Rod</span>.<span style=\"color:#74531f;\">solve</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">pl2</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n1</span></code>?\n    </p>\n    <p>\n        The code doesn't compile:\n    </p>\n    <blockquote>\n        <p>\n            Type mismatch. Expecting a     'Size&lt;'a&gt;'     but given a     'Size&lt;'b&gt;'     The type ''a' does not match the type ''b'\n        </p>\n    </blockquote>\n    <p>\n        This is fortunate, because <code>n1</code> wouldn't work with <code>pl2</code>. Consider that <code>n1</code> contains the number <code>3</code>, which is valid for the larger list <code>pl1</code>, but not the shorter list <code>pl2</code>.\n    </p>\n    <p>\n        Proofs are issued with a particular generic type argument - the type-level 'token', if you will. It's possible for a library API to explicitly propagate such proofs; you see a hint of that in <code>cut</code>, which not only takes as input a <code><span style=\"color:#2b91af;\">Size</span>&lt;<span style=\"color:#2b91af;\">&#39;a</span>&gt;</code> value, but also issues new proofs as a result.\n    </p>\n    <p>\n        At the same time, this design prevents proofs from being mixed up. Each set of proofs belongs to a particular proof context.\n    </p>\n    <p>\n        You get the same compiler error if you accidentally mix up some of the other terms.\n    </p>\n    <h3 id=\"d143cd141fc143c49e14d8e600492dc0\">\n        Conclusion <a href=\"#d143cd141fc143c49e14d8e600492dc0\">#</a>\n    </h3>\n    <p>\n        One goal in the GDP paper is to introduce a type-safe API design that's also <em>ergonomic</em>. Matt Noonan, the author, defines <em>ergonomic</em> as a design where correct use of the API doesn't place an undue burden on the client developer. The paper's example language is <a href=\"https://www.haskell.org/\">Haskell</a> where <a href=\"https://wiki.haskell.org/Rank-N_types\">rank-2 polymorphism</a> has a low impact on the user.\n    </p>\n    <p>\n        F# only supports rank-2 polymorphism in method definitions, which makes consuming a GDP API more awkward than in Haskell. The need to create a new type, and the few lines of boilerplate that entails, is a drawback.\n    </p>\n    <p>\n        Even so, the GDP trick is a nice addition to your functional tool belt. You'll hardly need it every day, but I personally like having some specialized tools lying around together with the everyday ones.\n    </p>\n    <p>\n        But wait! The reason that F# has support for rank-2 polymorphism through object methods is because C# has that language feature. This must mean that the GDP technique works in C# as well, doesn't it? Indeed it does.\n    </p>\n    <p>\n        <strong>Next:</strong> <a href=\"/2025/02/03/modelling-data-relationships-with-c-types\">Modelling data relationships with C# types</a>.\n    </p>\n</div><hr>\n      This blog is totally free, but if you like it, please consider <a href=\"https://blog.ploeh.dk/support\">supporting it</a>.",
    "sanitized": "An F# example implementation of Ghosts of Departed Proofs.\n    \n    \n        In a previous article, Encapsulating rod-cutting, I used a code example to discuss how to communicate an API's contract to client developers; that is, users of the API. In the article, I wrote\n    \n    \n        \n            \"All this said, however, it's also possible that I'm missing an obvious design alternative. If you can think of a way to model this relationship in a non-predicative way, please write a comment.\"\n        \n    \n    \n        And indeed, a reader helpfully offered an alternative:\n    \n    \n        \n            \"Regarding the relation between the array and the index, you will find the paper called \"Ghosts of departed proofs\" interesting. Maybe an overkill in this case, maybe not, but a very interesting and useful technique in general.\"\n        \n        borar\n    \n    \n        I wouldn't call it 'an obvious design alternative', but nonetheless find it interesting. In this article, I'll pick up the code from Encapsulating rod-cutting and show how the 'Ghosts of Departed Proofs' (GDP) technique may be applied.\n    \n    \n        Problem review #\n    \n    \n        Before we start with the GDP technique, a brief review of the problem is in order. For the complete overview, you should read the Encapsulating rod-cutting article. In the present article, however, we'll focus on one particular problem related to encapsulation:\n    \n    \n        Ideally, the cut function should take two input arguments. The first argument, p, is an array or list of prices. The second argument, n, is the size of a rod to cut optimally. One precondition states that n must be less than or equal to the length of p. This is because the algorithm needs to look up the price of a rod of size n, and it can't do that if n is greater than the length of p. The implied relationship is that p is indexed by rod size, so that if you want to find the price of a rod of size n, you look at the nth element in p.\n    \n    \n        How may we model such a relationship in a way that protects the precondition?\n    \n    \n        An obvious choice, particularly in object-oriented design, is to use a Guard Clause. In the F# code base, it might look like this:\n    \n    \n        let cut (p : _ array) n =\n    if p.Length <= n\n    then raise (ArgumentOutOfRangeException \"n must be less than the length of p\")\n \n    // The rest of the function body...\n    \n    \n        You might argue that in F# and other functional programming languages, throwing exceptions isn't idiomatic. Instead, you ought to return Result or Option values, here the latter:\n    \n    \n        let cut (p : _ array) n =\n    if p.Length <= n\n    then None\n    else\n        // The rest of the function body...\n    \n    \n        To be clear, in most code bases, this is exactly what I would do. What follows is rather exotic, and hardly suitable for all use cases.\n    \n    \n        Proofs as values #\n    \n    \n        It's not too hard to model the lower boundary of the n parameter. As is often the case, it turns out that the number must be a natural number. I already covered that in the previous article. It's much harder, however, to model the upper boundary of the value, because it depends on the size of p.\n    \n    \n        The following is based on the paper Ghosts of Departed Proofs, as well as a helpful Gist also provided by Borar. (The link to the paper is to what I believe is the 'official' page for it, and since it's part of the ACM digital library, it's behind a paywall. Even so, as is the case with most academic papers, it's easy enough to find a PDF of it somewhere else. Not that I endorse content piracy, but it's my impression that academic papers are usually disseminated by the authors themselves.)\n    \n    \n        The idea is to enable a library to issue a 'proof' about a certain condition. In the example I'm going to use here, the proof is that a certain number is in the valid range for a given list of prices.\n    \n    \n        We actually can't entirely escape the need for a run-time check, but we do gain two other benefits. The first is that we're now using the type system to communicate a relationship that otherwise would have to be described in written documentation. The second is that once the proof has been issued, there's no need to perform additional run-time checks.\n    \n    \n        This can help move an API towards a more total, as opposed to partial, definition, which again moves towards what Michael Feathers calls unconditional code. This is particularly useful if the alternative is an API that 'forgets' which run-time guarantees have already been checked. The paper has some examples. I've also recently encountered similar situations when doing Advent of Code 2024. Many days my solution involved immutable maps (like hash tables) that I'd recurse over. In many cases I'd write an algorithm where I with absolute certainty knew that a particular key was in the map (if, for example, I'd just put it there three lines earlier). In such cases, you don't want a total function that returns an option or Maybe value. You want a partial function. Or a type-level guarantee that the value is, indeed, in the map.\n    \n    \n        For the example in this article, it's overkill, so you may wonder what the point is. On the other hand, a simple example makes it easier to follow what's going on. Hopefully, once you understand the technique, you can extrapolate it to situations where it might be more warranted.\n    \n    \n        Proof contexts #\n    \n    \n        The overall idea should look familiar to practitioners of statically-typed functional programming. Instead of plain functions and data structures, we introduce a special 'context' in which we have to run our computations. This is similar to how the IO monad works, or, in fact, most monads. You're not supposed to get the value out of the monad. Rather, you should inject the desired behaviour into the monad.\n    \n    \n        We find a similar design with existential types, or with the ST monad, on which the ideas in the GDP paper are acknowledged to be based. We even see a mutation-based variation in the article A mutable priority collection, where we may think of the Edit API as a variation of the ST monad, since it allows 'localized' state mutation.\n    \n    \n        I'll attempt to illustrate it like this:\n    \n    \n        \n    \n    \n        A library offers a set of functions and data structures for immediate use. In addition, it also provides a higher-oder function that enables client code to embed a computation into a special 'sandbox' area where special rules apply. The paper calls such a context a 'name', which it does because it's trying to be as general as possible. As I'm writing this, I find it easier to think of this 'sandbox' as a 'proof context'. It's a context in which proof values exist. Crucially, as we shall see, they don't exist outside of this context.\n    \n    \n        Size proofs #\n    \n    \n        In the rod-cutting example, we particularly care about proving that a given number n is within the size of the price list. We do this by representing the proof as a value:\n    \n    \n        type Size<'a> = private Size of int with\n    member this.Value = let (Size i) = this in i\n    override this.ToString () = let (Size i) = this in string i\n    \n    \n        Two things are special about this type definition:\n    \n    \n        The constructor is private.\n        It has a phantom type 'a.\n    \n    \n        A phantom type is a generic type parameter that has no run-time value. Notice that Size<'a> contains no value of the type 'a. The type only exists at compile-time.\n    \n    \n        You can think of the type parameter as similar to a security token. The issuer of the proof associates a particular security token to vouch for its validity. Usually, when we talk about security tokens, they do have a run-time representation (typically a byte array) because we need to exchange them with other processes. This is, for example, how claims-based authentication works.\n    \n    \n        \n    \n    \n        In this case, our concern isn't security. Rather, we wish to communicate and enforce certain relationships. Since we wish to leverage the type system, we use a type as a token.\n    \n    \n        \n    \n    \n        Since the Size constructor is private, the library controls how it issues proofs, a bit like a claims issuer can sign a claim with its private key.\n    \n    \n        Okay, but how are Size proofs issued?\n    \n    \n        Issuing size proofs #\n    \n    \n        As you'll see later, more than one API may issue Size proofs, but the most fundamental is that you can query a price list for such a proof:\n    \n    \n        type PriceList<'a> = private PriceList of int list with\n    member this.Length = let (PriceList prices) = this in prices.Length\n    member this.trySize candidate : Size<'a> option =\n        if 0 < candidate && candidate <= this.Length\n        then Some (Size candidate)\n        else None\n    \n    \n        The trySize member function issues a Some Size<'a> value if the candidate is within the size of the price array. As discussed above, we can't completely avoid a run-time check, but now that we have the proof, we don't need to repeat that run-time check if we wanted to use a particular Size value with the same PriceList.\n    \n    \n        Notice how immutability is an essential part of this design. If, in the object-oriented manner, we allow a price list to change, we could make it shorter. This could invalidate some proof that we previously issued. Since, however, the price list is immutable, we can trust that once we've checked a size, it remains valid. You can also think of this as a sort of encapsulation, in the sense that once we've assured ourselves that an object, or here rather a value, is valid, it remains valid. Indeed, encapsulation is simpler with immutability.\n    \n    \n        You probably still have some questions. For instance, how do we ensure that a size proof issued by one price list can't be used against another price list? Imagine that you have two price lists. One has ten prices, the other twenty. You could have the larger one issue a proof that size 17 is valid. What prevents you from using that proof with the smaller price list?\n    \n    \n        That's the job of that phantom type. Notice how a PriceList<'a> issues a Size<'a> proof. It's the same generic type argument.\n    \n    \n        Usually, I extol F#'s type inference. I prefer not having to use type annotations unless I have to. When it comes to GDP, however, type annotations are necessary, because we need these phantom types to line up. Without the type annotations, they wouldn't do that.\n    \n    \n        In the above example, the smaller price list might have the type PriceList<'a> and the larger one the type PriceList<'b>. The smaller would issue proofs of the type Size<'a>, and the larger one proofs of the type Size<'b>. As you'll see, you can't use a Size<'a> where a Size<'b> is required, or vice versa.\n    \n    \n        You may still wonder how one then creates PriceList<'a> values. After all, that type also has a private constructor.\n    \n    \n        We'll get back to that later.\n    \n    \n        Proof-based cut API #\n    \n    \n        Before we look at how client code may consume APIs based on proofs such as Size<'a>, we should review their expressive power. What does this design enable us to say?\n    \n    \n        While the first example above, with the Guard Clause alternative, was based on the initial imperative implementation shown in the article Implementing rod-cutting, the rest of the present article builds on the refactored code from Encapsulating rod-cutting.\n    \n    \n        The first change I need to introduce is to the Cut record type:\n    \n    \n        type Cut<'a> = { Revenue : int; Size : Size<'a> }\n    \n    \n        Notice that I've changed the type of the Size property to Size<'a>. This has the implication that Cut<'a> now also has a phantom type, and since client code can't create Size<'a> values, by transitivity it means that neither can client code create Cut<'a> values. These values can only be issued as proofs.\n    \n    \n        This enables us to change the type definition of the cut function:\n    \n    \n        let cut (PriceList prices : PriceList<'a>) (Size n : Size<'a>) : Cut<'a> list =\n    // Implementation follows here...\n    \n    \n        Notice how all the phantom types line up. In order to call the function, client code must supply a Size<'a> value issued by a compatible PriceList<'a> value. Upon a valid call, the function returns a list of Cut<'a> values.\n    \n    \n        Pay attention to what is being communicated. You may find this strange and impenetrable, but for a reader who understands GDP, much about the contract is communicated through the types. We can see that n relates to prices, because the 'proof token' (the generic type parameter 'a) is the same for both arguments. A reader who understands how Size<'a> proofs are issued will now understand what the preconditions is: The n argument must be valid according to the size of the prices argument.\n    \n    \n        The type of the cut function also communicates a postcondition: It guarantees that the Size values of each Cut<'a> returned is valid according to the supplied prices. In other words, it means that no defensive coding is necessary. Client code doesn't have to check whether or not the price of each indicated cut can actually be found in prices. The types guarantee that they can.\n    \n    \n        You may consider the cut function a 'secondary' issuer of Size<'a> proofs, since it returns such values. If you wanted to call cut again with one of those values, you could.\n    \n    \n        Compared to the previous article, I don't think I changed much else in the cut function, besides the initial function declaration, and the last line of code, but for good measure, here's the entire function:\n    \n    \n        let cut (PriceList prices : PriceList<'a>) (Size n : Size<'a>) : Cut<'a> list =\n    // Implementation follows here...\n    let p = 0 :: prices |> Array.ofList\n \n    let findBestCut revenues j =\n        [1..j]\n        |> List.map (fun i -> p[i] + Map.find (j - i) revenues, i)\n        |> List.maxBy fst\n \n    let aggregate acc j =\n        let revenues = snd acc\n        let q, i = findBestCut revenues j\n        let cuts = fst acc\n        cuts << (cons (q, i)), Map.add revenues.Count q revenues\n \n    [1..n]\n    |> List.fold aggregate (id, Map.add 0 0 Map.empty)\n    |> fst <| [] // Evaluate Hughes list\n    |> List.map (fun (r, i) -> { Revenue = r; Size = Size i })\n    \n    \n        The cut function is part of the same module as Size<'a>, so even though the constructor is private, the cut function can still use it.\n    \n    \n        Thus, the entire proof mechanism is for external use. Internally, the library code may take shortcuts, so it's up to the library author to convince him- or herself that the contract holds. In this case, I'm quite confident that the function only issues valid proofs. After all, I've lifted the algorithm from an acclaimed text book, and this particular implementation is covered by more than 10,000 test cases.\n    \n    \n        Proof-based solve API #\n    \n    \n        The solve code hasn't changed, I believe:\n    \n    \n        let solve prices n =\n    let cuts = cut prices n\n    let rec imp n =\n        if n <= 0 then [] else\n            let idx = n - 1\n            let s = cuts[idx].Size\n            s :: imp (n - s.Value)\n    imp n.Value\n    \n    \n        While the code hasn't changed, the type has. In this case, no explicit type annotations are necessary, because the types are already correctly inferred from the use of cut:\n    \n    \n        solve: prices: PriceList<'a> -> n: Size<'a> -> Size<'a> list\n    \n    \n        Again, the phantom types line up as desired.\n    \n    \n        Proof-based revenue calculation #\n    \n    \n        Although I didn't show it in the previous article, I also included a function to calculate the revenue from a list of cuts. It gets the same treatment as the other functions:\n    \n    \n        let calculateRevenue (PriceList prices : PriceList<'a>) (cuts : Size<'a> list) =\n    cuts |> List.sumBy (fun s -> prices[s.Value - 1])\n    \n    \n        Again we see how the GDP-based API communicates a precondition: The cuts must be valid according to the prices; that is, each cut, indicated by its Size property, must be guaranteed to be within the range defined by the price list. This makes the function total; or, unconditional code, as Michael Feathers would put it. The function can't fail at run time.\n    \n    \n        (I am, once more, deliberately ignoring the entirely independent problem of potential integer overflows.)\n    \n    \n        While you could repeatedly call PriceList<'a>.trySize to produce a list of cuts, the most natural way to produce such a list of cuts is to first call cut, and then pass its result to calculateRevenue.\n    \n    \n        The function returns int.\n    \n    \n        Proof-based printing #\n    \n    \n        Finally, here's printSolution:\n    \n    \n        let printSolution p n = solve p n |> List.iter (printfn \"%O\")\n    \n    \n        It hasn't changed much since the previous incarnation, but the type is now PriceList<'a> -> Size<'a> -> unit. Again, the precondition is the same as for cut.\n    \n    \n        Running client code #\n    \n    \n        How in the world do you write client code against this API? After all, the types all have private constructors, so we can't create any values.\n    \n    \n        If you trace the code dependencies, you'll notice that PriceList<'a> sits at the heart of the API. If you have a PriceList<'a>, you'd be able to produce the other values, too.\n    \n    \n        So how do you create a PriceList<'a> value?\n    \n    \n        You don't. You call the following runPrices function, and give it a PriceListRunner that it'll embed and run in the 'sandbox' illustrated above.\n    \n    \n        type PriceListRunner<'r> =\n    abstract Run<'a> : PriceList<'a> -> 'r\n \nlet runPrices pl (ctx : PriceListRunner<'r>) = ctx.Run (PriceList pl)\n    \n    \n        As the paper describes, the GDP trick hinges on rank-2 polymorphism, and the only way (that I know of) this is supported in F# is on methods. An object is therefore required, and we define the abstract PriceListRunner<'r> class for that purpose.\n    \n    \n        Client code must implement the abstract class to call the runPrices function. Fortunately, since F# has object expressions, client code might look like this:\n    \n    \n        [<Fact>]\nlet ``CLRS example`` () =\n    let p = [1; 5; 8; 9; 10; 17; 17; 20; 24; 30]\n    let actual = Rod.runPrices p { new PriceListRunner<_> with\n        member __.Run pl = option {\n            let! n = pl.trySize 10\n            let cuts = Rod.cut pl n\n            return List.map (fun c -> (c.Revenue, c.Size.Value)) cuts } }\n    [\n        ( 1,  1)\n        ( 5,  2)\n        ( 8,  3)\n        (10,  2)\n        (13,  2)\n        (17,  6)\n        (18,  1)\n        (22,  2)\n        (25,  3)\n        (30, 10)\n    ] |> Some =! actual\n    \n    \n        This is an xUnit.net test where actual is produced by runPrices and an object expression that defines the code to run in the proof context. When the Run method runs, it runs with a concrete type that the compiler picked for 'a. This type is only in scope within that method, and can't escape it.\n    \n    \n        The implementing class is given a PriceList<'a> as an input argument. In this example, it tries to create a size of 10, which succeeds because the price list has ten elements.\n    \n    \n        Notice that the Run method transforms the cuts to tuples. Why doesn't it return cuts directly?\n    \n    \n        It can't. It's part of the deal. If I change the last line of Run to return cuts, the code no longer compiles. The compiler error is:\n    \n    \n        \n            This code is not sufficiently generic. The type variable 'a could not be generalized because it would escape its scope.\n        \n    \n    \n        Remember I wrote that 'a can't escape the scope of Run? This is enforced by the type system.\n    \n    \n        Preventing misalignment #\n    \n    \n        You may already consider it a benefit that this kind of API design uses the type system to communicate pre- and postconditions. Perhaps you also wonder how it prevents errors. As already discussed, if you're dealing with multiple price lists, it shouldn't be possible to use a size proof issued by one, with another. Let's see how that might look. We'll start with a correctly coded unit test:\n    \n    \n        [<Fact>]\nlet ``Nest two solutions`` () =\n    let p1 = [1; 2; 2]\n    let p2 = [1]\n \n    let actual = Rod.runPrices p1 { new PriceListRunner<_> with\n        member __.Run pl1 = option {\n            let! n1 = pl1.trySize 3\n            let cuts1 = Rod.solve pl1 n1\n            let r = Rod.calculateRevenue pl1 cuts1\n \n            let! inner = Rod.runPrices p2 { new PriceListRunner<_> with\n                member __.Run pl2 = option {\n                    let! n2 = pl2.trySize 1\n                    let cuts2 = Rod.solve pl2 n2\n                    return Rod.calculateRevenue pl2 cuts2 } }\n \n            return (r, inner) } }\n \n    Some (3, 1) =! actual\n    \n    \n        This code compiles because I haven't mixed up the Size or Cut values. What happens if I 'accidentally' change the 'inner' Rod.solve call to let cuts2 = Rod.solve pl2 n1?\n    \n    \n        The code doesn't compile:\n    \n    \n        \n            Type mismatch. Expecting a     'Size<'a>'     but given a     'Size<'b>'     The type ''a' does not match the type ''b'\n        \n    \n    \n        This is fortunate, because n1 wouldn't work with pl2. Consider that n1 contains the number 3, which is valid for the larger list pl1, but not the shorter list pl2.\n    \n    \n        Proofs are issued with a particular generic type argument - the type-level 'token', if you will. It's possible for a library API to explicitly propagate such proofs; you see a hint of that in cut, which not only takes as input a Size<'a> value, but also issues new proofs as a result.\n    \n    \n        At the same time, this design prevents proofs from being mixed up. Each set of proofs belongs to a particular proof context.\n    \n    \n        You get the same compiler error if you accidentally mix up some of the other terms.\n    \n    \n        Conclusion #\n    \n    \n        One goal in the GDP paper is to introduce a type-safe API design that's also ergonomic. Matt Noonan, the author, defines ergonomic as a design where correct use of the API doesn't place an undue burden on the client developer. The paper's example language is Haskell where rank-2 polymorphism has a low impact on the user.\n    \n    \n        F# only supports rank-2 polymorphism in method definitions, which makes consuming a GDP API more awkward than in Haskell. The need to create a new type, and the few lines of boilerplate that entails, is a drawback.\n    \n    \n        Even so, the GDP trick is a nice addition to your functional tool belt. You'll hardly need it every day, but I personally like having some specialized tools lying around together with the everyday ones.\n    \n    \n        But wait! The reason that F# has support for rank-2 polymorphism through object methods is because C# has that language feature. This must mean that the GDP technique works in C# as well, doesn't it? Indeed it does.\n    \n    \n        Next: Modelling data relationships with C# types.\n    \n\n      This blog is totally free, but if you like it, please consider supporting it."
  },
  {
    "itemId": "https://blog.ploeh.dk/2025/01/13/recawr-sandwich",
    "raw": "\n\n\n<div id=\"post\">\n    <p>\n        <em>A pattern variation.</em>\n    </p>\n    <p>\n        After writing the articles <a href=\"/2024/11/18/collecting-and-handling-result-values\">Collecting and handling result values</a> and <a href=\"/2024/12/02/short-circuiting-an-asynchronous-traversal\">Short-circuiting an asynchronous traversal</a>, I realized that it might be valuable to describe a more disciplined variation of the <a href=\"/2020/03/02/impureim-sandwich\">Impureim Sandwich</a> pattern.\n    </p>\n    <p>\n        The book <a href=\"/ref/dp\">Design Patterns</a> describes each pattern over a number of sections. There's a description of the overall motivation, the structure of the pattern, UML diagrams, examples code, and more. One section discusses various implementation variations. I find it worthwhile, too, to explicitly draw attention to a particular variation of the more overall Impureim Sandwich pattern.\n    </p>\n    <p>\n        This variation imposes an additional constraint to the general pattern. While this may, at first glance, seem limiting, <a href=\"https://www.dotnetrocks.com/details/1542\">constraints liberate</a>.\n    </p>\n    <p>\n        <img src=\"/content/binary/impureim-superset-of-recawr.png\" alt=\"A subset labeled 'Recawr Sandwiches' contained in a superset labeled 'Impureim Sandwiches'.\">\n    </p>\n    <p>\n        As a specialization, you may consider Recawr Sandwiches as a subset of all Impureim Sandwiches.\n    </p>\n    <h3 id=\"7b076cc0cc9148b9ba464bf41feb6128\">\n        Read, calculate, write <a href=\"#7b076cc0cc9148b9ba464bf41feb6128\">#</a>\n    </h3>\n    <p>\n        In short, the constraint is that the Sandwich should be organized in the following order:\n    </p>\n    <ul>\n        <li>Read data. This step is impure.</li>\n        <li>Calculate a result from the data. This step is a <a href=\"https://en.wikipedia.org/wiki/Pure_function\">pure function</a>.</li>\n        <li>Write data. This step is impure.</li>\n    </ul>\n    <p>\n        If the sandwich has <a href=\"/2023/10/09/whats-a-sandwich\">more than three layers</a>, this order should still be maintained. Once you start writing data to the network, to disk, to a database, or to the user interface, you shouldn't go back to reading in more data.\n    </p>\n    <h3 id=\"12089f0da99644849da33faf7dd8ffa4\">\n        Naming <a href=\"#12089f0da99644849da33faf7dd8ffa4\">#</a>\n    </h3>\n    <p>\n        The name <em>Recawr Sandwich</em> is made from the first letters of <em>REad CAlculate WRite</em>. It's pronounced <em>recover sandwich</em>.\n    </p>\n    <p>\n        When the idea of naming this variation originally came to me, I first thought of the name <em>read/write sandwich</em>, but then I thought that the most important ingredient, the pure function, was missing. I've considered some other variations, such as <em>read, pure, write sandwich</em> or <em>input, referential transparency, output sandwich</em>, but none of them quite gets the point across, I think, in the same way as <em>read, calculate, write</em>.\n    </p>\n    <h3 id=\"954558da563244edbb98a6685b3f9460\">\n        Precipitating example <a href=\"#954558da563244edbb98a6685b3f9460\">#</a>\n    </h3>\n    <p>\n        To be clear, I've been applying the Recawr Sandwich pattern for years, but it sometimes takes a counter-example before you realize that some implicit, tacit knowledge should be made explicit. This happened to me as I was discussing <a href=\"/2024/11/18/collecting-and-handling-result-values\">this implementation</a> of Impureim Sandwich:\n    </p>\n    <p>\n        <pre><span style=\"color:green;\">//&nbsp;Impure</span>\n<span style=\"color:#2b91af;\">IEnumerable</span>&lt;<span style=\"color:#2b91af;\">OneOf</span>&lt;<span style=\"color:#2b91af;\">ShoppingListItem</span>,&nbsp;<span style=\"color:#2b91af;\">NotFound</span>&lt;<span style=\"color:#2b91af;\">ShoppingListItem</span>&gt;,&nbsp;<span style=\"color:#2b91af;\">Error</span>&gt;&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">results</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">await</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">itemsToUpdate</span>.<span style=\"font-weight:bold;color:#74531f;\">Traverse</span>(<span style=\"font-weight:bold;color:#1f377f;\">item</span>&nbsp;=&gt;&nbsp;<span style=\"color:#74531f;\">UpdateItem</span>(<span style=\"font-weight:bold;color:#1f377f;\">item</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">dbContext</span>));\n \n<span style=\"color:green;\">//&nbsp;Pure</span>\n<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">results</span>.<span style=\"font-weight:bold;color:#74531f;\">Aggregate</span>(\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">BulkUpdateResult</span>([],&nbsp;[],&nbsp;[]),\n&nbsp;&nbsp;&nbsp;&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">state</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>)&nbsp;=&gt;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>.<span style=\"font-weight:bold;color:#74531f;\">Match</span>(\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">storedItem</span>&nbsp;=&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">state</span>.<span style=\"font-weight:bold;color:#74531f;\">Store</span>(<span style=\"font-weight:bold;color:#1f377f;\">storedItem</span>),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">notFound</span>&nbsp;=&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">state</span>.<span style=\"font-weight:bold;color:#74531f;\">Fail</span>(<span style=\"font-weight:bold;color:#1f377f;\">notFound</span>.Item),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">error</span>&nbsp;=&gt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">state</span>.<span style=\"font-weight:bold;color:#74531f;\">Error</span>(<span style=\"font-weight:bold;color:#1f377f;\">error</span>)));\n \n<span style=\"color:green;\">//&nbsp;Impure</span>\n<span style=\"color:blue;\">await</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">dbContext</span>.<span style=\"font-weight:bold;color:#74531f;\">SaveChangesAsync</span>();\n<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">OkResult</span>(<span style=\"font-weight:bold;color:#1f377f;\">result</span>);</pre>\n    </p>\n    <p>\n        Notice that the top impure step traverses a collection of items to apply each to an action called <code>UpdateItem</code>. As I discussed in the article, I don't actually know what <code>UpdateItem</code> does, but the name strongly suggests that it updates a particular database row. Even if the actual write doesn't happen until <code>SaveChangesAsync</code> is called, this still seems off.\n    </p>\n    <p>\n        To be honest, I didn't realize this until I started thinking about how I'd go about solving the implied problem, if I had to do it from scratch. Because I probably wouldn't do it like that at all.\n    </p>\n    <p>\n        It strikes me that doing the update 'too early' makes the code more complicated than it has to be.\n    </p>\n    <p>\n        What would a Recawr Sandwich look like?\n    </p>\n    <h3 id=\"e599dadd006a4d179289ba72a1978c1f\">\n        Recawr example <a href=\"#e599dadd006a4d179289ba72a1978c1f\">#</a>\n    </h3>\n    <p>\n        Perhaps one could instead start by querying the database about which items are actually in it, then prepare the result, and finally make the update.\n    </p>\n    <p>\n        <pre><span style=\"color:green;\">//&nbsp;Read</span>\n<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">existing</span>&nbsp;=&nbsp;<span style=\"color:blue;\">await</span>&nbsp;<span style=\"color:#74531f;\">FilterExisting</span>(<span style=\"font-weight:bold;color:#1f377f;\">itemsToUpdate</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">dbContext</span>);\n \n<span style=\"color:green;\">//&nbsp;Calculate</span>\n<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">BulkUpdateResult</span>([..&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">existing</span>],&nbsp;[..&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">itemsToUpdate</span>.<span style=\"font-weight:bold;color:#74531f;\">Except</span>(<span style=\"font-weight:bold;color:#1f377f;\">existing</span>)],&nbsp;[]);\n \n<span style=\"color:green;\">//&nbsp;Write</span>\n<span style=\"color:blue;\">var</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">results</span>&nbsp;=&nbsp;<span style=\"color:blue;\">await</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">existing</span>.<span style=\"font-weight:bold;color:#74531f;\">Traverse</span>(<span style=\"font-weight:bold;color:#1f377f;\">item</span>&nbsp;=&gt;&nbsp;<span style=\"color:#74531f;\">UpdateItem</span>(<span style=\"font-weight:bold;color:#1f377f;\">item</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">dbContext</span>));\n<span style=\"color:blue;\">await</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">dbContext</span>.<span style=\"font-weight:bold;color:#74531f;\">SaveChangesAsync</span>();\n<span style=\"font-weight:bold;color:#8f08c4;\">return</span>&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">OkResult</span>(<span style=\"font-weight:bold;color:#1f377f;\">result</span>);</pre>\n    </p>\n    <p>\n        To be honest, this variation has different behaviour when <code>Error</code> values occur, but then again, I wasn't entirely sure what was even the purpose of the error value. If it's to <a href=\"/2024/01/29/error-categories-and-category-errors\">model errors that client code can't recover from</a>, throw an exception instead.\n    </p>\n    <p>\n        In any case, the example is typical of many <a href=\"https://en.wikipedia.org/wiki/Input/output\">I/O</a>-heavy operations, which veer dangerously close to the degenerate. There really isn't a lot of logic required, so one may reasonably ask whether the example is useful. It was, however, the example that got me thinking about giving the Recawr Sandwich an explicit name.\n    </p>\n    <h3 id=\"ef69b33222b44b3e889fc0c861537d48\">\n        Other examples <a href=\"#ef69b33222b44b3e889fc0c861537d48\">#</a>\n    </h3>\n    <p>\n        All the examples in the original <a href=\"/2020/03/02/impureim-sandwich\">Impureim Sandwich</a> article are actually Recawr Sandwiches. Other articles with clear Recawr Sandwich examples are:\n    </p>\n    <ul>\n        <li><a href=\"/2019/09/09/picture-archivist-in-haskell\">Picture archivist in Haskell</a></li>\n        <li><a href=\"/2019/09/16/picture-archivist-in-f\">Picture archivist in F#</a></li>\n        <li><a href=\"/2021/09/06/the-command-handler-contravariant-functor\">The Command Handler contravariant functor</a></li>\n        <li><a href=\"/2024/12/16/a-restaurant-sandwich\">A restaurant sandwich</a></li>\n    </ul>\n    <p>\n        In other words, I'm just retroactively giving these examples a more specific label.\n    </p>\n    <p>\n        What's an example of an Impureim Sandwich which is <em>not</em> a Recawr Sandwich? Ironically, the first example in this article.\n    </p>\n    <h3 id=\"95dbd8e6364d429db7f040835d89e8e7\">\n        Conclusion <a href=\"#95dbd8e6364d429db7f040835d89e8e7\">#</a>\n    </h3>\n    <p>\n        A Recawr Sandwich is a specialization of the slightly more general Impureim Sandwich pattern. It specializes by assigning roles to the two impure layers of the sandwich. In the first, the code reads data. In the second impure layer, it writes data. In between, it performs referentially transparent calculations.\n    </p>\n    <p>\n        While more constraining, this specialization offers a good rule of thumb. Most well-designed sandwiches follow this template.\n    </p>\n</div><hr>\n      This blog is totally free, but if you like it, please consider <a href=\"https://blog.ploeh.dk/support\">supporting it</a>.",
    "sanitized": "A pattern variation.\n    \n    \n        After writing the articles Collecting and handling result values and Short-circuiting an asynchronous traversal, I realized that it might be valuable to describe a more disciplined variation of the Impureim Sandwich pattern.\n    \n    \n        The book Design Patterns describes each pattern over a number of sections. There's a description of the overall motivation, the structure of the pattern, UML diagrams, examples code, and more. One section discusses various implementation variations. I find it worthwhile, too, to explicitly draw attention to a particular variation of the more overall Impureim Sandwich pattern.\n    \n    \n        This variation imposes an additional constraint to the general pattern. While this may, at first glance, seem limiting, constraints liberate.\n    \n    \n        \n    \n    \n        As a specialization, you may consider Recawr Sandwiches as a subset of all Impureim Sandwiches.\n    \n    \n        Read, calculate, write #\n    \n    \n        In short, the constraint is that the Sandwich should be organized in the following order:\n    \n    \n        Read data. This step is impure.\n        Calculate a result from the data. This step is a pure function.\n        Write data. This step is impure.\n    \n    \n        If the sandwich has more than three layers, this order should still be maintained. Once you start writing data to the network, to disk, to a database, or to the user interface, you shouldn't go back to reading in more data.\n    \n    \n        Naming #\n    \n    \n        The name Recawr Sandwich is made from the first letters of REad CAlculate WRite. It's pronounced recover sandwich.\n    \n    \n        When the idea of naming this variation originally came to me, I first thought of the name read/write sandwich, but then I thought that the most important ingredient, the pure function, was missing. I've considered some other variations, such as read, pure, write sandwich or input, referential transparency, output sandwich, but none of them quite gets the point across, I think, in the same way as read, calculate, write.\n    \n    \n        Precipitating example #\n    \n    \n        To be clear, I've been applying the Recawr Sandwich pattern for years, but it sometimes takes a counter-example before you realize that some implicit, tacit knowledge should be made explicit. This happened to me as I was discussing this implementation of Impureim Sandwich:\n    \n    \n        // Impure\nIEnumerable<OneOf<ShoppingListItem, NotFound<ShoppingListItem>, Error>> results =\n    await itemsToUpdate.Traverse(item => UpdateItem(item, dbContext));\n \n// Pure\nvar result = results.Aggregate(\n    new BulkUpdateResult([], [], []),\n    (state, result) =>\n        result.Match(\n            storedItem => state.Store(storedItem),\n            notFound => state.Fail(notFound.Item),\n            error => state.Error(error)));\n \n// Impure\nawait dbContext.SaveChangesAsync();\nreturn new OkResult(result);\n    \n    \n        Notice that the top impure step traverses a collection of items to apply each to an action called UpdateItem. As I discussed in the article, I don't actually know what UpdateItem does, but the name strongly suggests that it updates a particular database row. Even if the actual write doesn't happen until SaveChangesAsync is called, this still seems off.\n    \n    \n        To be honest, I didn't realize this until I started thinking about how I'd go about solving the implied problem, if I had to do it from scratch. Because I probably wouldn't do it like that at all.\n    \n    \n        It strikes me that doing the update 'too early' makes the code more complicated than it has to be.\n    \n    \n        What would a Recawr Sandwich look like?\n    \n    \n        Recawr example #\n    \n    \n        Perhaps one could instead start by querying the database about which items are actually in it, then prepare the result, and finally make the update.\n    \n    \n        // Read\nvar existing = await FilterExisting(itemsToUpdate, dbContext);\n \n// Calculate\nvar result = new BulkUpdateResult([.. existing], [.. itemsToUpdate.Except(existing)], []);\n \n// Write\nvar results = await existing.Traverse(item => UpdateItem(item, dbContext));\nawait dbContext.SaveChangesAsync();\nreturn new OkResult(result);\n    \n    \n        To be honest, this variation has different behaviour when Error values occur, but then again, I wasn't entirely sure what was even the purpose of the error value. If it's to model errors that client code can't recover from, throw an exception instead.\n    \n    \n        In any case, the example is typical of many I/O-heavy operations, which veer dangerously close to the degenerate. There really isn't a lot of logic required, so one may reasonably ask whether the example is useful. It was, however, the example that got me thinking about giving the Recawr Sandwich an explicit name.\n    \n    \n        Other examples #\n    \n    \n        All the examples in the original Impureim Sandwich article are actually Recawr Sandwiches. Other articles with clear Recawr Sandwich examples are:\n    \n    \n        Picture archivist in Haskell\n        Picture archivist in F#\n        The Command Handler contravariant functor\n        A restaurant sandwich\n    \n    \n        In other words, I'm just retroactively giving these examples a more specific label.\n    \n    \n        What's an example of an Impureim Sandwich which is not a Recawr Sandwich? Ironically, the first example in this article.\n    \n    \n        Conclusion #\n    \n    \n        A Recawr Sandwich is a specialization of the slightly more general Impureim Sandwich pattern. It specializes by assigning roles to the two impure layers of the sandwich. In the first, the code reads data. In the second impure layer, it writes data. In between, it performs referentially transparent calculations.\n    \n    \n        While more constraining, this specialization offers a good rule of thumb. Most well-designed sandwiches follow this template.\n    \n\n      This blog is totally free, but if you like it, please consider supporting it."
  },
  {
    "itemId": "https://blog.ploeh.dk/2025/01/06/encapsulating-rod-cutting",
    "raw": "\n\n\n<div id=\"post\">\n    <p>\n        <em>Focusing on usage over implementation.</em>\n    </p>\n    <p>\n        This article is a part of a small article series about <a href=\"/2024/12/09/implementation-and-usage-mindsets\">implementation and usage mindsets</a>. The hypothesis is that programmers who approach a problem with an implementation mindset may gravitate toward dynamically typed languages, whereas developers concerned with long-term maintenance and sustainability of a code base may be more inclined toward statically typed languages. This could be wrong, and is almost certainly too simplistic, but is still, I hope, worth thinking about. In the <a href=\"/2024/12/23/implementing-rod-cutting\">previous article</a> you saw examples of an implementation-centric approach to problem-solving. In this article, I'll discuss what a usage-first perspective entails.\n    </p>\n    <p>\n        A usage perspective indicates that you're first and foremost concerned with how useful a programming interface is. It's what you do when you take advantage of test-driven development (TDD). First, you write a test, which furnishes an example of what a usage scenario looks like. Only then do you figure out how to implement the desired API.\n    </p>\n    <p>\n        In this article I didn't use TDD since I already had a particular implementation. Even so, while I didn't mention it in the previous article, I did add tests to verify that the code works as intended. In fact, because I wrote a few <a href=\"https://github.com/hedgehogqa/fsharp-hedgehog/\">Hedgehog</a> properties, I have more than 10.000 test cases covering my implementation.\n    </p>\n    <p>\n        I bring this up because TDD is only one way to focus on sustainability and <a href=\"/encapsulation-and-solid\">encapsulation</a>. It's the most scientific methodology that I know of, but you can employ more ad-hoc, ex-post analysis processes. I'll do that here.\n    </p>\n    <h3 id=\"03ca7a9c8c8146b6b7f0c1275ae9abcc\">\n        Imperative origin <a href=\"#03ca7a9c8c8146b6b7f0c1275ae9abcc\">#</a>\n    </h3>\n    <p>\n        In the <a href=\"/2024/12/23/implementing-rod-cutting\">previous article</a> you saw how the <code>Extended-Bottom-Up-Cut-Rod</code> pseudocode was translated to this <a href=\"https://fsharp.org/\">F#</a> function:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;:&nbsp;_&nbsp;<span style=\"color:#2b91af;\">array</span>)&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">zeroCreate</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;+&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">zeroCreate</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;+&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[0]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;0\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;=&nbsp;1&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:blue;\">mutable</span>&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Int32</span>.MinValue\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;1&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;&lt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;<span style=\"color:blue;\">then</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"color:#a08000;\">q</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span></pre>\n    </p>\n    <p>\n        In case anyone is wondering: This is a bona-fide <a href=\"https://en.wikipedia.org/wiki/Pure_function\">pure function</a>, even if the implementation is as imperative as can be. Given the same input, <code>cut</code> always returns the same output, and there are no side effects. We may wish to implement the function in a more <a href=\"/2015/08/03/idiomatic-or-idiosyncratic\">idiomatic</a> way, but that's not our first concern. <em>My</em> first concern, at least, is to make sure that preconditions, invariants, and postconditions are properly communicated.\n    </p>\n    <p>\n        The same goal applies to the <code>printSolution</code> action, also repeated here for your convenience.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">printSolution</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;_,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:blue;\">mutable</span>&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">while</span>&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;&gt;&nbsp;0&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#74531f;\">printfn</span>&nbsp;<span style=\"color:#a31515;\">&quot;</span><span style=\"color:#2b91af;\">%i</span><span style=\"color:#a31515;\">&quot;</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"color:#a08000;\">n</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"color:#a08000;\">n</span>]</pre>\n    </p>\n    <p>\n        Not that I'm not interested in more idiomatic implementations, but after all, they're <em>by definition</em> just implementation details, so first, I'll discuss encapsulation. Or, if you will, the usage perspective.\n    </p>\n    <h3 id=\"bb978144e56743639e83448c9b1d4f01\">\n        Names and types <a href=\"#bb978144e56743639e83448c9b1d4f01\">#</a>\n    </h3>\n    <p>\n        Based on the above two code snippets, we're given two artefacts: <code>cut</code> and <code>printSolution</code>. Since F# is a statically typed language, each operation also has a type.\n    </p>\n    <p>\n        The type of <code>cut</code> is <code>int array -&gt; int -&gt; int array * int array</code>. If you're not super-comfortable with F# type signatures, this means that <code>cut</code> is a function that takes an integer array and an integer as inputs, and returns a tuple as output. The output tuple is a pair; that is, it contains two elements, and in this particular case, both elements have the same type: They are both integer arrays.\n    </p>\n    <p>\n        Likewise, the type of <code>printSolution</code> is <code>int array -&gt; int -&gt; unit</code>, which again indicates that inputs must be an integer array and an integer. In this case the output is <code>unit</code>, which, in a sense, corresponds to <code>void</code> in many <a href=\"https://en.wikipedia.org/wiki/C_(programming_language)\">C</a>-based languages.\n    </p>\n    <p>\n        Both operations belong to a module called <code>Rod</code>, so their slightly longer, more formal names are <code>Rod.cut</code> and <code>Rod.printSolution</code>. Even so, <a href=\"/2020/11/23/good-names-are-skin-deep\">good names are only skin-deep</a>, and I'm not even convinced that these are particularly good names. To be fair to myself, I adopted the names from the pseudocode from <a href=\"/ref/clrs\">Introduction to Algorithms</a>. Had I been freer to name function and design APIs, I might have chosen different names. As it is, currently, there's no documentation, so the types are the only source of additional information.\n    </p>\n    <p>\n        Can we infer proper usage from these types? Do they sufficiently well communicate preconditions, invariants, and postconditions? In other words, do the types satisfactorily indicate the <em>contract</em> of each operation? Do the functions exhibit good <a href=\"/encapsulation-and-solid\">encapsulation</a>?\n    </p>\n    <p>\n        We may start with the <code>cut</code> function. It takes as inputs an integer array and an integer. Are empty arrays allowed? Are all integers valid, or perhaps only natural numbers? What about zeroes? Are duplicates allowed? Does the array need to be sorted? Is there a relationship between the array and the integer? Can the single integer parameter be negative?\n    </p>\n    <p>\n        And what about the return value? Are the two integer arrays related in any way? Can one be empty, but the other large? Can they both be empty? May negative numbers or zeroes be present?\n    </p>\n    <p>\n        Similar questions apply to the <code>printSolution</code> action.\n    </p>\n    <p>\n        <a href=\"/2022/08/22/can-types-replace-validation\">Not all such questions can be answered by types</a>, but since we already have a type system at our disposal, we might as well use it to address those questions that are easily modelled.\n    </p>\n    <h3 id=\"2a9f41707fb9425da8078a7181f6e7d6\">\n        Encapsulating the relationship between price array and rod length <a href=\"#2a9f41707fb9425da8078a7181f6e7d6\">#</a>\n    </h3>\n    <p>\n        The first question I decided to answer was this: <em>Is there a relationship between the array and the integer?</em>\n    </p>\n    <p>\n        The array, you may recall, is an array of prices. The integer is the length of the rod to cut up.\n    </p>\n    <p>\n        A relationship clearly exists. The length of the rod must not exceed the length of the array. If it does, <code>cut</code> throws an <a href=\"https://learn.microsoft.com/dotnet/api/system.indexoutofrangeexception\">IndexOutOfRangeException</a>. We can't calculate the optimal cuts if we lack price information.\n    </p>\n    <p>\n        Likewise, we can already infer that the length must be a non-negative number.\n    </p>\n    <p>\n        While we could choose to enforce this relationship with Guard Clauses, we may also consider a simpler API. Let the function infer the rod length from the array length.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;:&nbsp;_&nbsp;<span style=\"color:#2b91af;\">array</span>)&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>.Length&nbsp;-&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">zeroCreate</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;+&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">zeroCreate</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;+&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[0]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;0\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;=&nbsp;1&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:blue;\">mutable</span>&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Int32</span>.MinValue\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;1&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;&lt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;<span style=\"color:blue;\">then</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"color:#a08000;\">q</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span></pre>\n    </p>\n    <p>\n        You may argue that this API is more implicit, which <a href=\"https://peps.python.org/pep-0020/\">we generally don't like</a>. The implication is that the rod length is determined by the array length. If you have a (one-indexed) price array of length <em>10</em>, then how do you calculate the optimal cuts for a rod of length <em>7?</em>\n    </p>\n    <p>\n        By shortening the price array:\n    </p>\n    <p>\n        <pre>&gt; let p = [|0; 1; 5; 8; 9; 10; 17; 17; 20; 24; 30|];;\nval p: int array = [|0; 1; 5; 8; 9; 10; 17; 17; 20; 24; 30|]\n\n&gt; cut (p |&gt; Array.take (7 + 1));;\nval it: int array * int array =\n  ([|0; 1; 5; 8; 10; 13; 17; 18|], [|0; 1; 2; 3; 2; 2; 6; 1|])</pre>\n    </p>\n    <p>\n        This is clearly still sub-optimal. Notice, for example, how you need to add <code>1</code> to <code>7</code> in order to deal with the prefixed <code>0</code>. On the other hand, we're not done with the redesign, so it may be worth pursuing this course a little further.\n    </p>\n    <p>\n        (To be honest, while this is the direction I ultimately choose, I'm not blind to the disadvantages of this implicit design. It makes it less clear to a client developer how to indicate a rod length. An alternative design would keep the price array and the rod length as two separate parameters, but then introduce a Guard Clause to check that the rod length doesn't exceed the length of the price array. Outside of <a href=\"https://en.wikipedia.org/wiki/Dependent_type\">dependent types</a> I can't think of a way to model such a relationship between two values, and I admit to having no practical experience with dependent types. All this said, however, it's also possible that I'm missing an obvious design alternative. If you can think of a way to model this relationship in a non-<a href=\"https://www.hillelwayne.com/post/constructive/\">predicative</a> way, please <a href=\"https://github.com/ploeh/ploeh.github.com?tab=readme-ov-file#comments\">write a comment</a>.)\n    </p>\n    <p>\n        I gave the <code>printSolution</code> the same treatment, after first having extracted a <code>solve</code> function in order to <a href=\"/2016/09/26/decoupling-decisions-from-effects\">separate decisions from effects</a>.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">solve</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;_,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">l</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">ResizeArray</span>&nbsp;()\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:blue;\">mutable</span>&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>.Length&nbsp;-&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">while</span>&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;&gt;&nbsp;0&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">l</span>.<span style=\"font-weight:bold;color:#74531f;\">Add</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"color:#a08000;\">n</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"color:#a08000;\">n</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">l</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">ofSeq</span>\n \n<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">printSolution</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">solve</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">iter</span>&nbsp;(<span style=\"color:#74531f;\">printfn</span>&nbsp;<span style=\"color:#a31515;\">&quot;</span><span style=\"color:#2b91af;\">%i</span><span style=\"color:#a31515;\">&quot;</span>)</pre>\n    </p>\n    <p>\n        The <em>implementation</em> of the <code>solve</code> function is still imperative, but if you view it as a black box, it's <a href=\"https://en.wikipedia.org/wiki/Referential_transparency\">referentially transparent</a>. We'll get back to the implementation later.\n    </p>\n    <h3 id=\"01d4ef562a9d4552870ef093ae907f45\">\n        Returning a list of cuts <a href=\"#01d4ef562a9d4552870ef093ae907f45\">#</a>\n    </h3>\n    <p>\n        Let's return to all the questions I enumerated above, particularly the questions about the return value. Are the two integer arrays related?\n    </p>\n    <p>\n        Indeed they are! In fact, they have the same length.\n    </p>\n    <p>\n        As explained in the <a href=\"/2024/12/23/implementing-rod-cutting\">previous article</a>, in the original pseudocode, the <code>r</code> array is supposed to be zero-indexed, but non-empty and containing <code>0</code> as the first element. The <code>s</code> array is supposed to be one-indexed, and be exactly one element shorter than the <code>r</code> array. In practice, in all three implementations shown in that article, I made both arrays zero-indexed, non-empty, and of the exact same length. This is also true for the F# implementation.\n    </p>\n    <p>\n        We can communicate this relationship much better to client developers by changing the return type of the <code>cut</code> function. Currently, the return type is <code>int array * int array</code>, indicating a pair of arrays. Instead, we can change the return type to an array of pairs, thereby indicating that the values are related two-and-two.\n    </p>\n    <p>\n        That would be a decent change, but we can further improve the API. A pair of integers are still implicit, because it isn't clear which integer represents the revenue and which one represents the size. Instead, we introduce a custom type with clear labels:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">type</span>&nbsp;<span style=\"color:#2b91af;\">Cut</span>&nbsp;=&nbsp;{&nbsp;Revenue&nbsp;:&nbsp;<span style=\"color:#2b91af;\">int</span>;&nbsp;Size&nbsp;:&nbsp;<span style=\"color:#2b91af;\">int</span>&nbsp;}</pre>\n    </p>\n    <p>\n        Then we change the <code>cut</code> function to return a collection of <code>Cut</code> values:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;:&nbsp;_&nbsp;<span style=\"color:#2b91af;\">array</span>)&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>.Length&nbsp;-&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">zeroCreate</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;+&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">zeroCreate</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;+&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[0]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;0\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;=&nbsp;1&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:blue;\">mutable</span>&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Int32</span>.MinValue\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;1&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;&lt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;<span style=\"color:blue;\">then</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"color:#a08000;\">q</span>\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">ResizeArray</span>&nbsp;()\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;0&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>.<span style=\"font-weight:bold;color:#74531f;\">Add</span>&nbsp;{&nbsp;Revenue&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>];&nbsp;Size&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">ofSeq</span></pre>\n    </p>\n    <p>\n        The type of <code>cut</code> is now <code>int array -&gt; Cut list</code>. Notice that I decided to return a linked list rather than an array. This is mostly because I consider linked lists to be more idiomatic than arrays in a context of functional programming (FP), but to be honest, I'm not sure that it makes much difference as a return value.\n    </p>\n    <p>\n        In any case, you'll observe that the implementation is still imperative. The main topic of this article is how to give an API good encapsulation, so I treat the actual code as an implementation detail. It's not the most important thing.\n    </p>\n    <h3 id=\"8dca0872ab584d0ebefc10200877adde\">\n        Linked list input <a href=\"#8dca0872ab584d0ebefc10200877adde\">#</a>\n    </h3>\n    <p>\n        Although I wrote that I'm not sure it makes much difference whether <code>cut</code> returns an array or a list, it does matter when it comes to input values. Currently, <code>cut</code> takes an <code>int array</code> as input.\n    </p>\n    <p>\n        As the implementation so amply demonstrates, F# arrays are mutable; you can mutate the cells of an array. A client developer may worry, then, whether <code>cut</code> modifies the input array.\n    </p>\n    <p>\n        From the implementation code we know that it doesn't, but encapsulation is all about sparing client developers the burden of having to read the implementation. Rather, an API should communicate its contract in as succinct a way as possible, either via documentation or the type system.\n    </p>\n    <p>\n        In this case, we can use the type system to communicate this postcondition. Changing the input type to a linked list effectively communicates to all users of the API that <code>cut</code> doesn't mutate the input. This is because F# linked lists are truly immutable.\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">ofList</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>.Length&nbsp;-&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">zeroCreate</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;+&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">zeroCreate</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;+&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[0]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;0\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;=&nbsp;1&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:blue;\">mutable</span>&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Int32</span>.MinValue\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;1&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;&lt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;<span style=\"color:blue;\">then</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"color:#a08000;\">q</span>\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">ResizeArray</span>&nbsp;()\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;0&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>.<span style=\"font-weight:bold;color:#74531f;\">Add</span>&nbsp;{&nbsp;Revenue&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>];&nbsp;Size&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">ofSeq</span></pre>\n    </p>\n    <p>\n        The type of the <code>cut</code> function is now <code>int list -&gt; Cut list</code>, which informs client developers of an invariant. You can trust that <code>cut</code> will not change the input arguments.\n    </p>\n    <h3 id=\"fe67c3b6121e4be780bc3d7f3b166a00\">\n        Natural numbers <a href=\"#fe67c3b6121e4be780bc3d7f3b166a00\">#</a>\n    </h3>\n    <p>\n        You've probably gotten the point by now, so let's move a bit quicker. There are still issues that we'd like to document. Perhaps the worst part of the current API is that client code is required to supply a <code>prices</code> list where the first element <em>must</em> be zero. That's a very specific requirement. It's easy to forget, and if you do, the <code>cut</code> function just silently fails. It doesn't throw an exception; it just gives you a wrong answer.\n    </p>\n    <p>\n        We may choose to add a Guard Clause, but why are we even putting that responsibility on the client developer? Why can't the <code>cut</code> function add that prefix itself? It can, and it turns out that once you do that, and also remove the initial zero element from the output, you're now working with natural numbers.\n    </p>\n    <p>\n        First, add a <code>NaturalNumber</code> wrapper of integers:\n    </p>\n    <p>\n        <pre>type&nbsp;<span style=\"color:#2b91af;\">NaturalNumber</span>&nbsp;=&nbsp;private&nbsp;<span style=\"color:#2b91af;\">NaturalNumber</span>&nbsp;of&nbsp;<span style=\"color:#2b91af;\">int</span>&nbsp;with\n&nbsp;&nbsp;&nbsp;&nbsp;member&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>.Value&nbsp;=&nbsp;let&nbsp;(<span style=\"color:#2b91af;\">NaturalNumber</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>&nbsp;in&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>\n&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;member&nbsp;<span style=\"font-weight:bold;color:#74531f;\">tryCreate</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>&nbsp;&lt;&nbsp;1&nbsp;then&nbsp;<span style=\"color:#2b91af;\">None</span>&nbsp;else&nbsp;<span style=\"color:#2b91af;\">Some</span>&nbsp;&lt;|&nbsp;<span style=\"color:#2b91af;\">NaturalNumber</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">candidate</span>\n&nbsp;&nbsp;&nbsp;&nbsp;override&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>.<span style=\"font-weight:bold;color:#74531f;\">ToString</span>&nbsp;()&nbsp;=&nbsp;let&nbsp;(<span style=\"color:#2b91af;\">NaturalNumber</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">this</span>&nbsp;in&nbsp;<span style=\"color:#74531f;\">string</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span></pre>\n    </p>\n    <p>\n        Since the case constructor is <code>private</code>, external code can only <em>try</em> to create values. Once you have a <code>NaturalNumber</code> value, you know that it's valid, but creation requires a run-time check. In other words, this is what Hillel Wayne calls <a href=\"https://www.hillelwayne.com/post/constructive/\">predicative data</a>.\n    </p>\n    <p>\n        Armed with this new type, however, we can now strengthen the definition of the <code>Cut</code> record type:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">type</span>&nbsp;<span style=\"color:#2b91af;\">Cut</span>&nbsp;=&nbsp;{&nbsp;Revenue&nbsp;:&nbsp;<span style=\"color:#2b91af;\">int</span>;&nbsp;Size&nbsp;:&nbsp;<span style=\"color:#2b91af;\">NaturalNumber</span>&nbsp;}&nbsp;<span style=\"color:blue;\">with</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">member</span>&nbsp;<span style=\"font-weight:bold;color:#74531f;\">tryCreate</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenue</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">size</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">NaturalNumber</span>.<span style=\"font-weight:bold;color:#74531f;\">tryCreate</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">size</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">Option</span>.<span style=\"color:#74531f;\">map</span>&nbsp;(<span style=\"color:blue;\">fun</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">size</span>&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;{&nbsp;Revenue&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenue</span>;&nbsp;Size&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">size</span>&nbsp;})</pre>\n    </p>\n    <p>\n        The <code>Revenue</code> may still be any integer, because it turns out that the algorithm also works with negative prices. (For a book that's very meticulous in its analysis of algorithms, <a href=\"/ref/clrs\">CLRS</a> is surprisingly silent on this topic. Thorough testing with <a href=\"https://github.com/hedgehogqa/fsharp-hedgehog\">Hedgehog</a>, however, indicates that this is so.) On the other hand, the <code>Size</code> of the <code>Cut</code> must be a <code>NaturalNumber</code>. Since, again, we don't have any constructive way (outside of using <a href=\"https://en.wikipedia.org/wiki/Refinement_type\">refinement types</a>) of modelling this requirement, we also supply a <code>tryCreate</code> function.\n    </p>\n    <p>\n        This enables us to define the <code>cut</code> function like this:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">append</span>&nbsp;[0]&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">ofList</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>.Length&nbsp;-&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">zeroCreate</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;+&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">zeroCreate</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;+&nbsp;1)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[0]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;0\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;=&nbsp;1&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:blue;\">mutable</span>&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Int32</span>.MinValue\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;1&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;&lt;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;<span style=\"color:blue;\">then</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#a08000;\">q</span>&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">j</span>]&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"color:#a08000;\">q</span>\n&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">ResizeArray</span>&nbsp;()\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">for</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;1&nbsp;<span style=\"color:blue;\">to</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Cut</span>.<span style=\"font-weight:bold;color:#74531f;\">tryCreate</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">Option</span>.<span style=\"color:#74531f;\">iter</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>.<span style=\"font-weight:bold;color:#74531f;\">Add</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">result</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">ofSeq</span></pre>\n    </p>\n    <p>\n        It still has the type <code>int list -&gt; Cut list</code>, but the <code>Cut</code> type is now more restrictively designed. In other words, we've provided a more conservative definition of what we return, in keeping with <a href=\"https://en.wikipedia.org/wiki/Robustness_principle\">Postel's law</a>.\n    </p>\n    <p>\n        Furthermore, notice that the first line prepends <code>0</code> to the <code>p</code> array, so that the client developer doesn't have to do that. Likewise, when returning the result, the <code>for</code> loop goes from <code>1</code> to <code>n</code>, which means that it omits the first zero cut.\n    </p>\n    <p>\n        These changes ripple through and also improves encapsulation of the <code>solve</code> function:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">solve</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">l</span>&nbsp;=&nbsp;<span style=\"color:#2b91af;\">ResizeArray</span>&nbsp;()\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:blue;\">mutable</span>&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>.Length\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">while</span>&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;&gt;&nbsp;0&nbsp;<span style=\"color:blue;\">do</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">idx</span>&nbsp;=&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;-&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>.[<span style=\"font-weight:bold;color:#1f377f;\">idx</span>].Size\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">l</span>.<span style=\"font-weight:bold;color:#74531f;\">Add</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;<span style=\"color:blue;\">&lt;-</span>&nbsp;<span style=\"color:#a08000;\">n</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>.Value\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">l</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">ofSeq</span></pre>\n    </p>\n    <p>\n        The type of <code>solve</code> is now <code>int list -&gt; NaturalNumber list</code>.\n    </p>\n    <p>\n        This is about as strong as I can think of making the API using F#'s type system. A type like <code>int list -&gt; NaturalNumber list</code> tells you something about what you're allowed to do, what you're expected to do, and what you can expect in return. You can provide (almost) any list of integers, both positive, zero, or negative. You may also give an empty list. If we had wanted to prevent that, we could have used a <code>NonEmpty</code> list, as seen (among other places) in the article <a href=\"/2024/05/06/conservative-codomain-conjecture\">Conservative codomain conjecture</a>.\n    </p>\n    <p>\n        Okay, to be perfectly honest, there's one more change that might be in order, but this is where I ran out of steam.  One remaining precondition that I haven't yet discussed is that the input list must not contain 'too big' numbers. The problem is that the algorithm adds numbers together, and since 32-bit integers are bounded, you could run into overflow situations. Ask me how I know.\n    </p>\n    <p>\n        Changing the types to use 64-bit integers doesn't solve that problem (it only moves the boundary of where overflow happens), but consistently changing the API to work with <a href=\"https://learn.microsoft.com/dotnet/api/system.numerics.biginteger\">BigInteger</a> values might. To be honest, I haven't tried.\n    </p>\n    <h3 id=\"641bc16e730542a1a4a231886d208f24\">\n        Functional programming <a href=\"#641bc16e730542a1a4a231886d208f24\">#</a>\n    </h3>\n    <p>\n        From an encapsulation perspective, we're done now. By using the type system, we've emphasized how to <em>use</em> the API, rather than how it's implemented. Along the way, we even hid away some warts that came with the implementation. If I wanted to take this further, I would seriously consider making the <code>cut</code> function a <code>private</code> helper function, because it doesn't really return a solution. It only returns an intermediary value that makes it easier for the <code>solve</code> function to return the actual solution.\n    </p>\n    <p>\n        If you're even just a little bit familiar with F# or functional programming, you may have found it painful to read this far. <em>All that imperative code. My eyes! For the love of God, please rewrite the implementation with proper FP idioms and patterns.</em>\n    </p>\n    <p>\n        Well, the point of the whole article is that the implementation doesn't really matter. It's how client code may <em>use</em> the API that's important.\n    </p>\n    <p>\n        That is, of course, until you have to go and change the implementation code. In any case, as a little consolation prize for those brave FP readers who've made it all this way, here follows more functional implementations of the functions.\n    </p>\n    <p>\n        The <code>NaturalNumber</code> and <code>Cut</code> types haven't changed, so the first change comes with the <code>cut</code> function:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:#74531f;\">cons</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">x</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">xs</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">x</span>&nbsp;<span style=\"color:#2b91af;\">::</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">xs</span>\n \n<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>&nbsp;=&nbsp;0&nbsp;<span style=\"color:#2b91af;\">::</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">Array</span>.<span style=\"color:#74531f;\">ofList</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>.Length&nbsp;-&nbsp;1\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">findBestCut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[1..<span style=\"font-weight:bold;color:#1f377f;\">j</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">map</span>&nbsp;(<span style=\"color:blue;\">fun</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">p</span>[<span style=\"font-weight:bold;color:#1f377f;\">i</span>]&nbsp;+&nbsp;<span style=\"color:#2b91af;\">Map</span>.<span style=\"color:#74531f;\">find</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">maxBy</span>&nbsp;<span style=\"color:#74531f;\">fst</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">aggregate</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">acc</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">snd</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">acc</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">q</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">findBestCut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">j</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">cuts</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">fst</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">acc</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#74531f;\">cuts</span>&nbsp;&lt;&lt;&nbsp;(<span style=\"color:#74531f;\">cons</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">q</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)),&nbsp;<span style=\"color:#2b91af;\">Map</span>.<span style=\"color:#74531f;\">add</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>.Count&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">q</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">revenues</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;[1..<span style=\"font-weight:bold;color:#1f377f;\">n</span>]\n&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">fold</span>&nbsp;<span style=\"color:#74531f;\">aggregate</span>&nbsp;(<span style=\"color:#74531f;\">id</span>,&nbsp;<span style=\"color:#2b91af;\">Map</span>.<span style=\"color:#74531f;\">add</span>&nbsp;0&nbsp;0&nbsp;<span style=\"color:#2b91af;\">Map</span>.empty)\n&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style=\"color:#74531f;\">fst</span>&nbsp;&lt;|&nbsp;[]&nbsp;<span style=\"color:green;\">//&nbsp;Evaluate&nbsp;Hughes&nbsp;list</span>\n&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style=\"color:#2b91af;\">List</span>.<span style=\"color:#74531f;\">choose</span>&nbsp;(<span style=\"color:blue;\">fun</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">r</span>,&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)&nbsp;<span style=\"color:blue;\">-&gt;</span>&nbsp;<span style=\"color:#2b91af;\">Cut</span>.<span style=\"font-weight:bold;color:#74531f;\">tryCreate</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">r</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">i</span>)</pre>\n    </p>\n    <p>\n        Even here, however, some implementation choices are dubious at best. For instance, I decided to use a Hughes list or difference list (see <a href=\"/2015/12/22/tail-recurse\">Tail Recurse</a> for a detailed explanation of how this works in F#) without measuring whether or not it was better than just using normal <em>list consing</em> followed by <code>List.rev</code> (which is, in fact, often faster). That's one of the advantages of writing code for articles; such things don't really matter that much in that context.\n    </p>\n    <p>\n        Another choice that may leave you scratching your head is that I decided to model the <code>revenues</code> as a map (that is, an immutable dictionary) rather than an array. I did this because I was concerned that with the move towards immutable code, I'd have <code>n</code> reallocations of arrays. Perhaps, I thought, adding incrementally to a <code>Map</code> structure would be more efficient.\n    </p>\n    <p>\n        But really, all of that is just wanking, because I haven't measured.\n    </p>\n    <p>\n        The FP-style implementation of <code>solve</code> is, I believe, less controversial:\n    </p>\n    <p>\n        <pre><span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:#74531f;\">solve</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>&nbsp;=&nbsp;<span style=\"color:#74531f;\">cut</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"color:blue;\">rec</span>&nbsp;<span style=\"color:#74531f;\">imp</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;=\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;&lt;=&nbsp;0&nbsp;<span style=\"color:blue;\">then</span>&nbsp;[]&nbsp;<span style=\"color:blue;\">else</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">idx</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;-&nbsp;1\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">let</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;=&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">cuts</span>[<span style=\"font-weight:bold;color:#1f377f;\">idx</span>].Size\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>&nbsp;<span style=\"color:#2b91af;\">::</span>&nbsp;<span style=\"color:#74531f;\">imp</span>&nbsp;(<span style=\"font-weight:bold;color:#1f377f;\">n</span>&nbsp;-&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">s</span>.Value)\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#74531f;\">imp</span>&nbsp;<span style=\"font-weight:bold;color:#1f377f;\">prices</span>.Length</pre>\n    </p>\n    <p>\n        This is a fairly standard implementation using a local recursive helper function.\n    </p>\n    <p>\n        Both <code>cut</code> and <code>solve</code> have the types previously reported. In other words, this final refactoring to functional implementations didn't change their types.\n    </p>\n    <h3 id=\"c009b6e42470466c9556f52a7c5af175\">\n        Conclusion <a href=\"#c009b6e42470466c9556f52a7c5af175\">#</a>\n    </h3>\n    <p>\n        This article goes through a series of code improvements to illustrate how a static type system can make it easier to use an API. Use it <em>correctly</em>, that is.\n    </p>\n    <p>\n        There's a common misconception about ease of use that it implies typing fewer characters, or getting instant <a href=\"/2024/05/13/gratification\">gratification</a>. That's not my position. <a href=\"/2018/09/17/typing-is-not-a-programming-bottleneck\">Typing is not a bottleneck</a>, and in any case, not much is gained if you make it easier for client developers to get the wrong answers from your API.\n    </p>\n    <p>\n        Static types gives you a consistent vocabulary you can use to communicate an API's contract to client developers. What must client code do in order to make a valid method or function call? What guarantees can client code rely on? <a href=\"/encapsulation-and-solid\">Encapsulation</a>, in other words.\n    </p>\n    <ins datetime=\"2025-01-20\">\n        <p>\n            <strong>P.S. 2025-01-20:</strong>\n        </p>\n        <p>\n            For a type-level technique for modelling the relationship between rod size and price list, see <a href=\"/2025/01/20/modelling-data-relationships-with-f-types\">Modelling data relationships with F# types</a>.\n        </p>\n    </ins>\n</div>\n<hr>\n      This blog is totally free, but if you like it, please consider <a href=\"https://blog.ploeh.dk/support\">supporting it</a>.",
    "sanitized": "Focusing on usage over implementation.\n    \n    \n        This article is a part of a small article series about implementation and usage mindsets. The hypothesis is that programmers who approach a problem with an implementation mindset may gravitate toward dynamically typed languages, whereas developers concerned with long-term maintenance and sustainability of a code base may be more inclined toward statically typed languages. This could be wrong, and is almost certainly too simplistic, but is still, I hope, worth thinking about. In the previous article you saw examples of an implementation-centric approach to problem-solving. In this article, I'll discuss what a usage-first perspective entails.\n    \n    \n        A usage perspective indicates that you're first and foremost concerned with how useful a programming interface is. It's what you do when you take advantage of test-driven development (TDD). First, you write a test, which furnishes an example of what a usage scenario looks like. Only then do you figure out how to implement the desired API.\n    \n    \n        In this article I didn't use TDD since I already had a particular implementation. Even so, while I didn't mention it in the previous article, I did add tests to verify that the code works as intended. In fact, because I wrote a few Hedgehog properties, I have more than 10.000 test cases covering my implementation.\n    \n    \n        I bring this up because TDD is only one way to focus on sustainability and encapsulation. It's the most scientific methodology that I know of, but you can employ more ad-hoc, ex-post analysis processes. I'll do that here.\n    \n    \n        Imperative origin #\n    \n    \n        In the previous article you saw how the Extended-Bottom-Up-Cut-Rod pseudocode was translated to this F# function:\n    \n    \n        let cut (p : _ array) n =\n    let r = Array.zeroCreate (n + 1)\n    let s = Array.zeroCreate (n + 1)\n    r[0] <- 0\n    for j = 1 to n do\n        let mutable q = Int32.MinValue\n        for i = 1 to j do\n            if q < p[i] + r[j - i] then\n                q <- p[i] + r[j - i]\n                s[j] <- i\n        r[j] <- q\n    r, s\n    \n    \n        In case anyone is wondering: This is a bona-fide pure function, even if the implementation is as imperative as can be. Given the same input, cut always returns the same output, and there are no side effects. We may wish to implement the function in a more idiomatic way, but that's not our first concern. My first concern, at least, is to make sure that preconditions, invariants, and postconditions are properly communicated.\n    \n    \n        The same goal applies to the printSolution action, also repeated here for your convenience.\n    \n    \n        let printSolution p n =\n    let _, s = cut p n\n    let mutable n = n\n    while n > 0 do\n        printfn \"%i\" s[n]\n        n <- n - s[n]\n    \n    \n        Not that I'm not interested in more idiomatic implementations, but after all, they're by definition just implementation details, so first, I'll discuss encapsulation. Or, if you will, the usage perspective.\n    \n    \n        Names and types #\n    \n    \n        Based on the above two code snippets, we're given two artefacts: cut and printSolution. Since F# is a statically typed language, each operation also has a type.\n    \n    \n        The type of cut is int array -> int -> int array * int array. If you're not super-comfortable with F# type signatures, this means that cut is a function that takes an integer array and an integer as inputs, and returns a tuple as output. The output tuple is a pair; that is, it contains two elements, and in this particular case, both elements have the same type: They are both integer arrays.\n    \n    \n        Likewise, the type of printSolution is int array -> int -> unit, which again indicates that inputs must be an integer array and an integer. In this case the output is unit, which, in a sense, corresponds to void in many C-based languages.\n    \n    \n        Both operations belong to a module called Rod, so their slightly longer, more formal names are Rod.cut and Rod.printSolution. Even so, good names are only skin-deep, and I'm not even convinced that these are particularly good names. To be fair to myself, I adopted the names from the pseudocode from Introduction to Algorithms. Had I been freer to name function and design APIs, I might have chosen different names. As it is, currently, there's no documentation, so the types are the only source of additional information.\n    \n    \n        Can we infer proper usage from these types? Do they sufficiently well communicate preconditions, invariants, and postconditions? In other words, do the types satisfactorily indicate the contract of each operation? Do the functions exhibit good encapsulation?\n    \n    \n        We may start with the cut function. It takes as inputs an integer array and an integer. Are empty arrays allowed? Are all integers valid, or perhaps only natural numbers? What about zeroes? Are duplicates allowed? Does the array need to be sorted? Is there a relationship between the array and the integer? Can the single integer parameter be negative?\n    \n    \n        And what about the return value? Are the two integer arrays related in any way? Can one be empty, but the other large? Can they both be empty? May negative numbers or zeroes be present?\n    \n    \n        Similar questions apply to the printSolution action.\n    \n    \n        Not all such questions can be answered by types, but since we already have a type system at our disposal, we might as well use it to address those questions that are easily modelled.\n    \n    \n        Encapsulating the relationship between price array and rod length #\n    \n    \n        The first question I decided to answer was this: Is there a relationship between the array and the integer?\n    \n    \n        The array, you may recall, is an array of prices. The integer is the length of the rod to cut up.\n    \n    \n        A relationship clearly exists. The length of the rod must not exceed the length of the array. If it does, cut throws an IndexOutOfRangeException. We can't calculate the optimal cuts if we lack price information.\n    \n    \n        Likewise, we can already infer that the length must be a non-negative number.\n    \n    \n        While we could choose to enforce this relationship with Guard Clauses, we may also consider a simpler API. Let the function infer the rod length from the array length.\n    \n    \n        let cut (p : _ array) =\n    let n = p.Length - 1\n    let r = Array.zeroCreate (n + 1)\n    let s = Array.zeroCreate (n + 1)\n    r[0] <- 0\n    for j = 1 to n do\n        let mutable q = Int32.MinValue\n        for i = 1 to j do\n            if q < p[i] + r[j - i] then\n                q <- p[i] + r[j - i]\n                s[j] <- i\n        r[j] <- q\n    r, s\n    \n    \n        You may argue that this API is more implicit, which we generally don't like. The implication is that the rod length is determined by the array length. If you have a (one-indexed) price array of length 10, then how do you calculate the optimal cuts for a rod of length 7?\n    \n    \n        By shortening the price array:\n    \n    \n        > let p = [|0; 1; 5; 8; 9; 10; 17; 17; 20; 24; 30|];;\nval p: int array = [|0; 1; 5; 8; 9; 10; 17; 17; 20; 24; 30|]\n\n> cut (p |> Array.take (7 + 1));;\nval it: int array * int array =\n  ([|0; 1; 5; 8; 10; 13; 17; 18|], [|0; 1; 2; 3; 2; 2; 6; 1|])\n    \n    \n        This is clearly still sub-optimal. Notice, for example, how you need to add 1 to 7 in order to deal with the prefixed 0. On the other hand, we're not done with the redesign, so it may be worth pursuing this course a little further.\n    \n    \n        (To be honest, while this is the direction I ultimately choose, I'm not blind to the disadvantages of this implicit design. It makes it less clear to a client developer how to indicate a rod length. An alternative design would keep the price array and the rod length as two separate parameters, but then introduce a Guard Clause to check that the rod length doesn't exceed the length of the price array. Outside of dependent types I can't think of a way to model such a relationship between two values, and I admit to having no practical experience with dependent types. All this said, however, it's also possible that I'm missing an obvious design alternative. If you can think of a way to model this relationship in a non-predicative way, please write a comment.)\n    \n    \n        I gave the printSolution the same treatment, after first having extracted a solve function in order to separate decisions from effects.\n    \n    \n        let solve p =\n    let _, s = cut p\n    let l = ResizeArray ()\n    let mutable n = p.Length - 1\n    while n > 0 do\n        l.Add s[n]\n        n <- n - s[n]\n    l |> List.ofSeq\n \nlet printSolution p = solve p |> List.iter (printfn \"%i\")\n    \n    \n        The implementation of the solve function is still imperative, but if you view it as a black box, it's referentially transparent. We'll get back to the implementation later.\n    \n    \n        Returning a list of cuts #\n    \n    \n        Let's return to all the questions I enumerated above, particularly the questions about the return value. Are the two integer arrays related?\n    \n    \n        Indeed they are! In fact, they have the same length.\n    \n    \n        As explained in the previous article, in the original pseudocode, the r array is supposed to be zero-indexed, but non-empty and containing 0 as the first element. The s array is supposed to be one-indexed, and be exactly one element shorter than the r array. In practice, in all three implementations shown in that article, I made both arrays zero-indexed, non-empty, and of the exact same length. This is also true for the F# implementation.\n    \n    \n        We can communicate this relationship much better to client developers by changing the return type of the cut function. Currently, the return type is int array * int array, indicating a pair of arrays. Instead, we can change the return type to an array of pairs, thereby indicating that the values are related two-and-two.\n    \n    \n        That would be a decent change, but we can further improve the API. A pair of integers are still implicit, because it isn't clear which integer represents the revenue and which one represents the size. Instead, we introduce a custom type with clear labels:\n    \n    \n        type Cut = { Revenue : int; Size : int }\n    \n    \n        Then we change the cut function to return a collection of Cut values:\n    \n    \n        let cut (p : _ array) =\n    let n = p.Length - 1\n    let r = Array.zeroCreate (n + 1)\n    let s = Array.zeroCreate (n + 1)\n    r[0] <- 0\n    for j = 1 to n do\n        let mutable q = Int32.MinValue\n        for i = 1 to j do\n            if q < p[i] + r[j - i] then\n                q <- p[i] + r[j - i]\n                s[j] <- i\n        r[j] <- q\n \n    let result = ResizeArray ()\n    for i = 0 to n do\n        result.Add { Revenue = r[i]; Size = s[i] }\n    result |> List.ofSeq\n    \n    \n        The type of cut is now int array -> Cut list. Notice that I decided to return a linked list rather than an array. This is mostly because I consider linked lists to be more idiomatic than arrays in a context of functional programming (FP), but to be honest, I'm not sure that it makes much difference as a return value.\n    \n    \n        In any case, you'll observe that the implementation is still imperative. The main topic of this article is how to give an API good encapsulation, so I treat the actual code as an implementation detail. It's not the most important thing.\n    \n    \n        Linked list input #\n    \n    \n        Although I wrote that I'm not sure it makes much difference whether cut returns an array or a list, it does matter when it comes to input values. Currently, cut takes an int array as input.\n    \n    \n        As the implementation so amply demonstrates, F# arrays are mutable; you can mutate the cells of an array. A client developer may worry, then, whether cut modifies the input array.\n    \n    \n        From the implementation code we know that it doesn't, but encapsulation is all about sparing client developers the burden of having to read the implementation. Rather, an API should communicate its contract in as succinct a way as possible, either via documentation or the type system.\n    \n    \n        In this case, we can use the type system to communicate this postcondition. Changing the input type to a linked list effectively communicates to all users of the API that cut doesn't mutate the input. This is because F# linked lists are truly immutable.\n    \n    \n        let cut prices =\n    let p = prices |> Array.ofList\n    let n = p.Length - 1\n    let r = Array.zeroCreate (n + 1)\n    let s = Array.zeroCreate (n + 1)\n    r[0] <- 0\n    for j = 1 to n do\n        let mutable q = Int32.MinValue\n        for i = 1 to j do\n            if q < p[i] + r[j - i] then\n                q <- p[i] + r[j - i]\n                s[j] <- i\n        r[j] <- q\n \n    let result = ResizeArray ()\n    for i = 0 to n do\n        result.Add { Revenue = r[i]; Size = s[i] }\n    result |> List.ofSeq\n    \n    \n        The type of the cut function is now int list -> Cut list, which informs client developers of an invariant. You can trust that cut will not change the input arguments.\n    \n    \n        Natural numbers #\n    \n    \n        You've probably gotten the point by now, so let's move a bit quicker. There are still issues that we'd like to document. Perhaps the worst part of the current API is that client code is required to supply a prices list where the first element must be zero. That's a very specific requirement. It's easy to forget, and if you do, the cut function just silently fails. It doesn't throw an exception; it just gives you a wrong answer.\n    \n    \n        We may choose to add a Guard Clause, but why are we even putting that responsibility on the client developer? Why can't the cut function add that prefix itself? It can, and it turns out that once you do that, and also remove the initial zero element from the output, you're now working with natural numbers.\n    \n    \n        First, add a NaturalNumber wrapper of integers:\n    \n    \n        type NaturalNumber = private NaturalNumber of int with\n    member this.Value = let (NaturalNumber i) = this in i\n    static member tryCreate candidate =\n        if candidate < 1 then None else Some <| NaturalNumber candidate\n    override this.ToString () = let (NaturalNumber i) = this in string i\n    \n    \n        Since the case constructor is private, external code can only try to create values. Once you have a NaturalNumber value, you know that it's valid, but creation requires a run-time check. In other words, this is what Hillel Wayne calls predicative data.\n    \n    \n        Armed with this new type, however, we can now strengthen the definition of the Cut record type:\n    \n    \n        type Cut = { Revenue : int; Size : NaturalNumber } with\n    static member tryCreate revenue size =\n        NaturalNumber.tryCreate size\n        |> Option.map (fun size -> { Revenue = revenue; Size = size })\n    \n    \n        The Revenue may still be any integer, because it turns out that the algorithm also works with negative prices. (For a book that's very meticulous in its analysis of algorithms, CLRS is surprisingly silent on this topic. Thorough testing with Hedgehog, however, indicates that this is so.) On the other hand, the Size of the Cut must be a NaturalNumber. Since, again, we don't have any constructive way (outside of using refinement types) of modelling this requirement, we also supply a tryCreate function.\n    \n    \n        This enables us to define the cut function like this:\n    \n    \n        let cut prices =\n    let p = prices |> List.append [0] |> Array.ofList\n    let n = p.Length - 1\n    let r = Array.zeroCreate (n + 1)\n    let s = Array.zeroCreate (n + 1)\n    r[0] <- 0\n    for j = 1 to n do\n        let mutable q = Int32.MinValue\n        for i = 1 to j do\n            if q < p[i] + r[j - i] then\n                q <- p[i] + r[j - i]\n                s[j] <- i\n        r[j] <- q\n \n    let result = ResizeArray ()\n    for i = 1 to n do\n        Cut.tryCreate r[i] s[i] |> Option.iter result.Add\n    result |> List.ofSeq\n    \n    \n        It still has the type int list -> Cut list, but the Cut type is now more restrictively designed. In other words, we've provided a more conservative definition of what we return, in keeping with Postel's law.\n    \n    \n        Furthermore, notice that the first line prepends 0 to the p array, so that the client developer doesn't have to do that. Likewise, when returning the result, the for loop goes from 1 to n, which means that it omits the first zero cut.\n    \n    \n        These changes ripple through and also improves encapsulation of the solve function:\n    \n    \n        let solve prices =\n    let cuts = cut prices\n    let l = ResizeArray ()\n    let mutable n = prices.Length\n    while n > 0 do\n        let idx = n - 1\n        let s = cuts.[idx].Size\n        l.Add s\n        n <- n - s.Value\n    l |> List.ofSeq\n    \n    \n        The type of solve is now int list -> NaturalNumber list.\n    \n    \n        This is about as strong as I can think of making the API using F#'s type system. A type like int list -> NaturalNumber list tells you something about what you're allowed to do, what you're expected to do, and what you can expect in return. You can provide (almost) any list of integers, both positive, zero, or negative. You may also give an empty list. If we had wanted to prevent that, we could have used a NonEmpty list, as seen (among other places) in the article Conservative codomain conjecture.\n    \n    \n        Okay, to be perfectly honest, there's one more change that might be in order, but this is where I ran out of steam.  One remaining precondition that I haven't yet discussed is that the input list must not contain 'too big' numbers. The problem is that the algorithm adds numbers together, and since 32-bit integers are bounded, you could run into overflow situations. Ask me how I know.\n    \n    \n        Changing the types to use 64-bit integers doesn't solve that problem (it only moves the boundary of where overflow happens), but consistently changing the API to work with BigInteger values might. To be honest, I haven't tried.\n    \n    \n        Functional programming #\n    \n    \n        From an encapsulation perspective, we're done now. By using the type system, we've emphasized how to use the API, rather than how it's implemented. Along the way, we even hid away some warts that came with the implementation. If I wanted to take this further, I would seriously consider making the cut function a private helper function, because it doesn't really return a solution. It only returns an intermediary value that makes it easier for the solve function to return the actual solution.\n    \n    \n        If you're even just a little bit familiar with F# or functional programming, you may have found it painful to read this far. All that imperative code. My eyes! For the love of God, please rewrite the implementation with proper FP idioms and patterns.\n    \n    \n        Well, the point of the whole article is that the implementation doesn't really matter. It's how client code may use the API that's important.\n    \n    \n        That is, of course, until you have to go and change the implementation code. In any case, as a little consolation prize for those brave FP readers who've made it all this way, here follows more functional implementations of the functions.\n    \n    \n        The NaturalNumber and Cut types haven't changed, so the first change comes with the cut function:\n    \n    \n        let private cons x xs = x :: xs\n \nlet cut prices =\n    let p = 0 :: prices |> Array.ofList\n    let n = p.Length - 1\n \n    let findBestCut revenues j =\n        [1..j]\n        |> List.map (fun i -> p[i] + Map.find (j - i) revenues, i)\n        |> List.maxBy fst\n \n    let aggregate acc j =\n        let revenues = snd acc\n        let q, i = findBestCut revenues j\n        let cuts = fst acc\n        cuts << (cons (q, i)), Map.add revenues.Count q revenues\n \n    [1..n]\n    |> List.fold aggregate (id, Map.add 0 0 Map.empty)\n    |> fst <| [] // Evaluate Hughes list\n    |> List.choose (fun (r, i) -> Cut.tryCreate r i)\n    \n    \n        Even here, however, some implementation choices are dubious at best. For instance, I decided to use a Hughes list or difference list (see Tail Recurse for a detailed explanation of how this works in F#) without measuring whether or not it was better than just using normal list consing followed by List.rev (which is, in fact, often faster). That's one of the advantages of writing code for articles; such things don't really matter that much in that context.\n    \n    \n        Another choice that may leave you scratching your head is that I decided to model the revenues as a map (that is, an immutable dictionary) rather than an array. I did this because I was concerned that with the move towards immutable code, I'd have n reallocations of arrays. Perhaps, I thought, adding incrementally to a Map structure would be more efficient.\n    \n    \n        But really, all of that is just wanking, because I haven't measured.\n    \n    \n        The FP-style implementation of solve is, I believe, less controversial:\n    \n    \n        let solve prices =\n    let cuts = cut prices\n    let rec imp n =\n        if n <= 0 then [] else\n            let idx = n - 1\n            let s = cuts[idx].Size\n            s :: imp (n - s.Value)\n    imp prices.Length\n    \n    \n        This is a fairly standard implementation using a local recursive helper function.\n    \n    \n        Both cut and solve have the types previously reported. In other words, this final refactoring to functional implementations didn't change their types.\n    \n    \n        Conclusion #\n    \n    \n        This article goes through a series of code improvements to illustrate how a static type system can make it easier to use an API. Use it correctly, that is.\n    \n    \n        There's a common misconception about ease of use that it implies typing fewer characters, or getting instant gratification. That's not my position. Typing is not a bottleneck, and in any case, not much is gained if you make it easier for client developers to get the wrong answers from your API.\n    \n    \n        Static types gives you a consistent vocabulary you can use to communicate an API's contract to client developers. What must client code do in order to make a valid method or function call? What guarantees can client code rely on? Encapsulation, in other words.\n    \n    \n        \n            P.S. 2025-01-20:\n        \n        \n            For a type-level technique for modelling the relationship between rod size and price list, see Modelling data relationships with F# types.\n        \n    \n\n\n      This blog is totally free, but if you like it, please consider supporting it."
  }
]
