[
  {
    "itemId": "https://www.thereformedprogrammer.net/?p=2970",
    "raw": "\n<p>Some developers used EF Core <a href=\"https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-7.0/whatsnew#json-columns\">JSON Columns</a> in their DbContext when using my <a href=\"https://github.com/JonPSmith/EfCore.SchemaCompare\">EfCore.SchemaCompare</a> library, then they had a problem. That’s because I hadn’t added support for <a href=\"https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-7.0/whatsnew#json-columns\">JSON Columns</a> to my <a href=\"https://github.com/JonPSmith/EfCore.SchemaCompare\">EfCore.SchemaCompare</a> library (this library compares a EF Core&#8217;s Model of the database against a database&#8217;s schema). When I added support for JSON Columns feature to the library, I found it had a rather complex internal design. In fact <a href=\"https://github.com/roji\">Shay Rojansky</a> talks about this complex design in the EF Core 9 release EF Core community standup (<a href=\"https://youtu.be/wG8D5HJMzjA?t=862\">click this</a> to hear what he says) and they want to improve it in EF Core 10.</p>\n\n\n\n<p>So the combination of a complex design, not much documentation, and my <a href=\"https://www.cdc.gov/aging/dementia/index.html\">dementia</a> (See the <a href=\"https://www.thereformedprogrammer.net/a-detailed-look-at-ef-cores-json-column-feature/#endnote-dementia-and-programming\"><em>ENDNOTE&nbsp;dementia and</em> programming</a> section at the end of this article) made it pretty hard for me to work out what to do. Thankfully the EF Core team responded to <a href=\"https://github.com/dotnet/efcore/issues/34568\">my issue</a>, which helped me a lot.</p>\n\n\n\n<p>So, I decided to create this article to provide more documentation to help other developers when using JSON Columns. The article compares the EF Core normal approach of using SQL Tables, columns, Indexes, etc., (shortened to “Tables/Indexes approach” in this article) against the JSON Columns approach so that you can compare / contrast the two approaches.</p>\n\n\n\n<h2 class=\"wp-block-heading\">TL;DR; – Summary of this article</h2>\n\n\n\n<ul class=\"wp-block-list\">\n<li>EF Core added a feature called <a href=\"https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-7.0/whatsnew#json-columns\">JSON Columns</a> in .NET 7, which stores data in an JSON string, and was also updated in EF Core’s .NET 8 release.</li>\n\n\n\n<li>This article compares the JSON Columns approach against the normal Tables/Indexes approach.</li>\n\n\n\n<li>I use a &#8220;list of books&#8221; app using both the JSON Columns approach and the Tables/Indexes approach</li>\n\n\n\n<li>The way relationships are configured and stored are different &#8211; The JSON Columns&#8217; relationships are held inside the its JSON string, while the the Tables/Indexes approach has multiple tables, linked by Indexes.</li>\n\n\n\n<li>The create and read of both approaches are (nearly) the same, while selecting particular entries is different in the two approaches.</li>\n\n\n\n<li>There is a large section looking at the performance of eight tasks with different numbers of the entities to give you an idea where JSON Columns would work in your application.</li>\n\n\n\n<li>At the end I give you my, and EF Core&#8217;s, view of what sort of data that works with JSON Columns: The data must be “Coherent”,&nbsp; i.e. there no links outside the data. Logging data is one example where JSON Columns would work well.</li>\n</ul>\n\n\n\n<h2 class=\"wp-block-heading\">Introduction of storing data in a database using JSON</h2>\n\n\n\n<p>JSON (Full name: JavaScript Object Notation) is a lightweight format for storing and transporting data in strings. The JSON’s format has a beautifully simple design, which makes it easy to understand and use. JSON is used everywhere, for instance Web Applications to send data from the server to the client and to send back inputs from the client.</p>\n\n\n\n<p>I also used JSON in my early use of EF Core by using the JsonSerializer.Serialize and JsonSerializer.Deserialize methods to store data in a database. But in the <a href=\"https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-7.0/whatsnew#json-columns\">.NET 7 release of EF Core</a> added dedicated code to convert data into a JSON string (this is known as “JSON Columns” in EF Core). In&nbsp; <a href=\"https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-8.0/whatsnew#enhancements-to-json-column-mapping\">.NET 8 release of EF Core</a> to improve its performance and added JSON Columns to SQLite. And <a href=\"https://github.com/roji\">Shay Rojansky</a>, who is part of the EF Core team, said they will improve how JSON Columns in .NET 10 EF Core.</p>\n\n\n\n<p>The JSON Columns feature allows you to put some code in your EF Core’s DbContext’s OnModelCreating method to automatically convert a class’s properties into a JSON string. It also allows multiple classes, including relationships, to be stored in one JSON string.</p>\n\n\n\n<p>The <a href=\"https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-7.0/whatsnew#json-columns\">.NET 7 what’s new JSON Columns section</a> says “JSON columns allow relational databases to take on some of the characteristics of document databases, creating a useful hybrid between the two.“ JSON Columns can contain any basic types: e.g., string, int, bool, DateTime and relationships, although JSON Columns’ relationships are handed differently to the normal Tables / Index approach.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Creating an example application</h2>\n\n\n\n<p>I wanted an example application that to covers relationships, configured, read/write and performance. I also I wanted an application that both the Tables/Indexes approach and JSON Columns approach can use. I choose a “list of books” app (think a very simple Amazon book app).</p>\n\n\n\n<p>I have to say that the “list of books” app is NOT something that I would build using JSON Columns, but it does show all the JSON Columns’ relationships. Also, the “list of books” app provides a good way to compare the JSON Columns’ performance against the Tables/Indexes approach.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: I used a “list of books” app in my <a href=\"https://bit.ly/EfCoreBookEd2\">Entity Framework Core in Action</a> (2nd. Edition). In chapter 2 I used the “list of books” app to show the main types of EF Core’s relations, and in <a href=\"https://www.thereformedprogrammer.net/five-levels-of-performance-tuning-for-an-ef-core-query/#the-book-app-and-its-features\">chapter 15 looked at performance</a> and <a href=\"https://www.thereformedprogrammer.net/an-in-depth-study-of-cosmos-db-and-ef-core-3-0-database-provider/\">chapter 16 using Cosmos DB</a>.</p>\n</blockquote>\n\n\n\n<p>I created a GitHub called&nbsp; <a href=\"https://github.com/JonPSmith/ExploringJsonColumns/tree/main\">ExploringJsonColumns</a> which holds the code to check that the code was correct, and also to run performance tests to compare the two approaches. The sections in this article are:</p>\n\n\n\n<ol class=\"wp-block-list\">\n<li><a href=\"https://www.thereformedprogrammer.net/a-detailed-look-at-ef-cores-json-column-feature/#1-an-overview-of-the-list-of-books-data\">An overview of the “list of books” data</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/a-detailed-look-at-ef-cores-json-column-feature/#2-the-relationships-and-how-they-are-configured\">The relationships and how they are configured</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/a-detailed-look-at-ef-cores-json-column-feature/#4-writing-into-the-database\">Writing into the database</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/a-detailed-look-at-ef-cores-json-column-feature/#5-selecting-data-from-the-database\">Selecting data from the database</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/a-detailed-look-at-ef-cores-json-column-feature/#6-reading-data-from-the-database\">Reading data from the database</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/a-detailed-look-at-ef-cores-json-column-feature/#4-performance-comparisons\">Performance comparisons</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/a-detailed-look-at-ef-cores-json-column-feature/#5-my-thoughts-on-where-json-columns-are-a-good-fit\">My thoughts on where JSON Columns are a good fit</a></li>\n</ol>\n\n\n\n<h2 class=\"wp-block-heading\">1. An overview of the “list of books” data</h2>\n\n\n\n<p>My <a href=\"https://github.com/JonPSmith/ExploringJsonColumns\">ExploringJsonColumns</a> solution holds two versions of the “list of books” app code: one using the normal Tables/Indexes approach and the other the JSON Columns approach, and provides the same output into common class called <a href=\"https://github.com/JonPSmith/ExploringJsonColumns/blob/main/Test/Dtos/BookListDto.cs\">BookListDto</a> (The BookListDto class contains all the data to show a book’s details, e.g., book title, author(s), price, star ratings, etc.. This ensures that we can compare their performances the results because both approaches are the same data. The screenshot below shows one (fictional) book showing the book&#8217;s data.</p>\n\n\n<div class=\"wp-block-image\">\n<figure class=\"aligncenter size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/BookDisplay.png\"><img fetchpriority=\"high\" decoding=\"async\" width=\"516\" height=\"154\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/BookDisplay.png\" alt=\"\" class=\"wp-image-2971\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/BookDisplay.png 516w, https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/BookDisplay-300x90.png 300w\" sizes=\"(max-width: 516px) 100vw, 516px\" /></a></figure></div>\n\n\n<h3 class=\"wp-block-heading\">2. The relationships and how they are configured</h3>\n\n\n\n<p>The “list of books” app has the three types of relationships, and the diagram below shows the Tables/Indexes approach on the left and the JSON Columns approach on the right.</p>\n\n\n\n<p class=\"has-text-align-center\"><strong><em>NOTE: click on the picture below to get a bigger picture.</em></strong></p>\n\n\n\n<figure class=\"wp-block-image size-large\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/Ef-Core-TwoWaysToStoreDate.png\"><img decoding=\"async\" width=\"1024\" height=\"382\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/Ef-Core-TwoWaysToStoreDate-1024x382.png\" alt=\"\" class=\"wp-image-2972\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/Ef-Core-TwoWaysToStoreDate-1024x382.png 1024w, https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/Ef-Core-TwoWaysToStoreDate-300x112.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/Ef-Core-TwoWaysToStoreDate-768x286.png 768w, https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/Ef-Core-TwoWaysToStoreDate.png 1368w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></a></figure>\n\n\n\n<figure class=\"wp-block-table\"><table class=\"has-fixed-layout\"><tbody><tr><td>See Tables/Indexes classes in <a href=\"https://github.com/JonPSmith/ExploringJsonColumns/tree/main/DataLayer/SqlBookClasses\">this folder</a>.</td><td>See JSON Columns classes in <a href=\"https://github.com/JonPSmith/ExploringJsonColumns/tree/main/DataLayer/JsonBookClasses\">this folder</a>.</td></tr></tbody></table></figure>\n\n\n\n<p>The JSON Columns part of the diagram above isn’t as clear as the Tables/Indexes approach, so the screenshot below shows the JSON in the BookData’s nvarchar(max) string.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/QuantumNetworkingJsonString-1.png\"><img decoding=\"async\" width=\"730\" height=\"585\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/QuantumNetworkingJsonString-1.png\" alt=\"\" class=\"wp-image-2974\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/QuantumNetworkingJsonString-1.png 730w, https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/QuantumNetworkingJsonString-1-300x240.png 300w\" sizes=\"(max-width: 730px) 100vw, 730px\" /></a></figure>\n\n\n\n<p>The configuring of JSON Columns is added in your DbContext’s OnModelCreating method – see the diagram below which shows the <a href=\"https://github.com/JonPSmith/ExploringJsonColumns/blob/main/DataLayer/JsonBookEfCore/BookJsonContext.cs\">BookJsonContext class</a> with comments about where the JSON Columns&#8217; OwnsOne and OwnsMany methods are used</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExampleJsonColumnsConfigure.png\"><img loading=\"lazy\" decoding=\"async\" width=\"611\" height=\"318\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExampleJsonColumnsConfigure.png\" alt=\"\" class=\"wp-image-2983\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExampleJsonColumnsConfigure.png 611w, https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExampleJsonColumnsConfigure-300x156.png 300w\" sizes=\"auto, (max-width: 611px) 100vw, 611px\" /></a></figure>\n\n\n\n<p>Here is a link to another the <a href=\"https://github.com/JonPSmith/EfCore.SchemaCompare/blob/master/DataLayer/JsonColumnDb/JsonCustomerContext.cs\">JsonCustomerContext</a> DbContext which I used in testing my JSON Columns code added to my <a href=\"https://github.com/JonPSmith/EfCore.SchemaCompare\">EfCore.SchemaCompare</a> library. This shows how you can configure multiple layers (e.g., grandfather, father, son) relationships and handing multiples JSON Columns’ entities.</p>\n\n\n\n<h3 class=\"wp-block-heading\">The differences between Tables/Indexes and JSON Columns version’s “many” relationships</h3>\n\n\n\n<p>When showing a book with multiple authors you must ensure the authors’ names are in the correct order. In the Tables/Indexes approach: the <a href=\"https://github.com/JonPSmith/ExploringJsonColumns/blob/main/DataLayer/SqlBookClasses/BookAuthor.cs\">BookAuthor class</a> has an byte “Order” column to make sure that Author’s Names are shown in the correct order.</p>\n\n\n\n<p>But in the JSON Columns approach the <a href=\"https://github.com/JonPSmith/ExploringJsonColumns/blob/main/DataLayer/JsonBookClasses/JsonAuthor.cs\">JsonAuthor class</a> doesn’t need a “Order” property because the List&lt;JsonAuthor&gt; holds the authors’ names in the order they were added. &nbsp;Therefore you don’t need a “Order” property.</p>\n\n\n\n<h3 class=\"wp-block-heading\">4. Writing into the database</h3>\n\n\n\n<p>From the developer’s perspective the writing of data to the database uses the same process for the Table / Index approach and JSON Columns &#8211; you put data into a class and EF Core will store it into the database. EF Core will store Table / Index data into tables and columns, while with JSON Columns EF Core will store the data in a JSON string.</p>\n\n\n\n<h3 class=\"wp-block-heading\">5. Selecting data from the database</h3>\n\n\n\n<p>In the first version (EF Core 7) of the JSON Columns the only way to select data is using the Table / Index approach, i.e. by using column(s) to in the top entity, for instance in the&nbsp; “lists of books” you could its Id (Index) in the <a href=\"https://github.com/JonPSmith/ExploringJsonColumns/blob/main/DataLayer/JsonBookClasses/BookTop.cs\">BookTop</a> class.</p>\n\n\n\n<p>But in EF Core 8 there was a new <a href=\"https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-8.0/whatsnew#enhancements-to-json-column-mapping\">Enhancements to JSON column mapping</a>” feature which enables you to filter each entry (i.e. book) using data point(s) in the JSON string. I use this feature in my performance tasks to find all the books that has a specific author’s name. You can find that <a href=\"https://github.com/JonPSmith/ExploringJsonColumns/blob/main/Test/MappingCode/MapJsonBooksByAuthor.cs\">code here</a>.</p>\n\n\n\n<h3 class=\"wp-block-heading\">6. Reading data from the database</h3>\n\n\n\n<p>The reading of JSON Columns’ data is very easy – you simply access the classes / properties just like the Table / Index approach. The only small difference is that any relationship in the JSON Columns is immediately available, so you don’t need to add code to load relationships (e.g., context.Books.Include(book =&gt; book.Reviews)… isn’t needed).</p>\n\n\n\n<p>NOTE: There are some rare situations when you need to a) read in many JSON Columns entities, and b) combine data, or you only need a subset of the data points, then using IEnumerable&lt;&gt; input and an IEnumerable&lt;&gt; out can make the process (a bit) quicker (see <a href=\"https://github.com/JonPSmith/ExploringJsonColumns/blob/main/Test/MappingCode/MapJsonBooks.cs\">MapJsonBooks</a> for an example). I found this when reading all the books ordered by each book’s star rating, because I had two ToList’s – using IEnumerable&lt;&gt; in/out removes one of the ToList method.</p>\n\n\n\n<h2 class=\"wp-block-heading\">4. Performance comparisons</h2>\n\n\n\n<p>I had a project called <a href=\"https://github.com/JonPSmith/ExploringJsonColumns/blob/main/Benchmark/ConsoleBenchmark.cs\">ConsoleBenchmark</a> in my ExploringJsonColumns solution which used &nbsp;<a href=\"https://github.com/dotnet/BenchmarkDotNet\">BenchmarkDotNet</a> to get the performance of the two approaches, i.e., the normal Tables/Indexes approach and the JSON Columns approach. There are four tasks to compare, with two types of data:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>Simple data: This has the least relationships, with each book having one Author’s Name and no reviews or promotions.</li>\n\n\n\n<li>Complex data: This has many relationships, with each book having two Author’s Name and many reviews and a few promotions.</li>\n</ul>\n\n\n\n<figure class=\"wp-block-table\"><table class=\"has-fixed-layout\"><tbody><tr><td><strong>Task name</strong></td><td><strong>What is does</strong></td></tr><tr><td>1. Add</td><td>Add N sample data to an empty SQL database</td></tr><tr><td>2. Read</td><td>Read N sample data from the SQL database</td></tr><tr><td>3. Order</td><td>Read N sample data and order the books using their star rating</td></tr><tr><td>4. Author</td><td>Find all the books that has a specific author’s name in the N sample data.</td></tr></tbody></table></figure>\n\n\n\n<p>The first two tasks (Add, Read) don’t favour either approach, but last two tasks (Order, Author) should favour the Tables/Indexes approach because it can use indexes to get to the information more easily. NOTE: that the “Order” and &nbsp;“Author” tasks don’t work in the Simple type.</p>\n\n\n\n<p>Below are the benchmark results for the two setups: Simple and Complex, with a performance summary after the BenchmarkDotNet’s results.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExploringJsonColumns-Simple-benchmark-28-12-24.png\"><img loading=\"lazy\" decoding=\"async\" width=\"542\" height=\"329\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExploringJsonColumns-Simple-benchmark-28-12-24.png\" alt=\"\" class=\"wp-image-2976\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExploringJsonColumns-Simple-benchmark-28-12-24.png 542w, https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExploringJsonColumns-Simple-benchmark-28-12-24-300x182.png 300w\" sizes=\"auto, (max-width: 542px) 100vw, 542px\" /></a></figure>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExploringJsonColumns-Complex-10-100-1000-28-12-24.png\"><img loading=\"lazy\" decoding=\"async\" width=\"556\" height=\"582\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExploringJsonColumns-Complex-10-100-1000-28-12-24.png\" alt=\"\" class=\"wp-image-2977\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExploringJsonColumns-Complex-10-100-1000-28-12-24.png 556w, https://www.thereformedprogrammer.net/wp-content/uploads/2025/01/ExploringJsonColumns-Complex-10-100-1000-28-12-24-287x300.png 287w\" sizes=\"auto, (max-width: 556px) 100vw, 556px\" /></a></figure>\n\n\n\n<p>From the performance of this “list of books” code of you can say:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><strong>Add tests</strong>: The JSON Columns is as good, or better than the Table / Index version, and the 1,000 books with JSON Columns is nearly half the time of the Table / Index code. I suspect the number of relationships will have some effect on the Table / Index version’s performance.</li>\n\n\n\n<li><strong>Read tests</strong>: The JSON Columns performance is near to the Table / Index version when there aren’t many books, i.e., 10, but once you get to 100 books takes 8 times longer, and with 1,000 test Columns takes 10 times longer.</li>\n\n\n\n<li><strong>Order tests</strong> (complex only): I thought the Table / Index version would win every time because it could use the LINQ Average method on all the review’s star rating, but in the “ten books” JSON Columns works well. However, compared against the Table / Index version the 100 books JSON Columns take 7 times longer, and 1,000 JSON Columns takes 7 times longer.</li>\n\n\n\n<li><strong>Author tests</strong> (complex only): &nbsp;This task finds all the books that have a specific author’s name. The JSON Columns approach was better than I expected, but it’s always slower than the Table/Index approach. The worse was 1,000 JSON Columns version, which was 8 times slower that the Table/Index approach.</li>\n</ul>\n\n\n\n<h2 class=\"wp-block-heading\">5. My thoughts on where JSON Columns are a good fit</h2>\n\n\n\n<p>I used the “list of books” code because it covers the JSON Columns’ relationships, configuration, types of reading, etc. which makes a good example. As I said earlier, I was sure that the normal Table / Index approach would have the best performance on the “list of books” tests, and I was right. But I was surprised that the JSON Columns did so well!</p>\n\n\n\n<p>So, what types of data is a good fit for using JSON Columns? My take is:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>The data has many parts.</li>\n\n\n\n<li>Each data point can be held in a built-in type, e.g. int, bool, string…</li>\n\n\n\n<li>The data points are “coherent”,&nbsp; i.e. there no links outside this data.</li>\n</ul>\n\n\n\n<p>This means the JSON Columns approach is good if you have lots of data about one thing that doesn’t need links to another entity. The <a href=\"https://learn.microsoft.com/en-us/ef/core/what-is-new/ef-core-7.0/whatsnew#json-columns\">.NET 7 release the EF Core</a> documentation gives you examples that work well with JSON Columns, for instance:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>Contact Details: name, phones, address, etc.</li>\n\n\n\n<li>Logging: what, where, when, who…</li>\n</ul>\n\n\n\n<p>The other thing to consider is the performance comparison where the JSON Columns approach is better that the Table / Index approach. The Performance comparisons section show that:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>Adding a lot of JSON Columns data is normally faster than the Table / Index approach (I think this because the Table / Index approach of the “”list of books” app has to create more indexing and relationships on adding).</li>\n\n\n\n<li>Do you need to read a lot of entities using JSON Columns, then a JSON Columns can be slow. For instance, “list of books”:<ul><li>JSON Columns: 10 takes the same as the Table / Index approach, but…</li></ul><ul><li>JSON Columns: 100 takes 2 times of the Table / Index approach</li></ul>\n<ul class=\"wp-block-list\">\n<li>JSON Columns: 1,000 takes 8 times of the Table / Index approach</li>\n</ul>\n</li>\n\n\n\n<li>If there are lookups (e.g., finding all the books for a specific Author) or ordering, then the Table / Index approach, with its links using Indexing, is likely to perform better that JSON Columns approach. For instance, in the Author task the JSON Columns approach has read every AuthorName in each entity, while the &nbsp;Table / Index approach only has to look at the at the links via the BookAuthor class, which are 10.</li>\n</ul>\n\n\n\n<h2 class=\"wp-block-heading\">Conclusion</h2>\n\n\n\n<p>I hope this article helps you to understand how to setup and use EF Core’s JSON Columns feature. Also the performance figures give you some idea of what JSON Columns will do in add, read, and filter tasks.</p>\n\n\n\n<p>Just to end, if your data fits a JSON Columns approach, but performance is critical, then I would recommend <a href=\"https://learn.microsoft.com/en-us/azure/cosmos-db/use-cases\">Cosmos DB</a>. I used Cosmos DB with the <a href=\"https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs\">CQRS pattern</a> in chapter 16 of my book <a href=\"https://bit.ly/EfCoreBookEd2\">Entity Framework Core in Action</a> (2nd. Edition) and I found it very fast. For instance, the Order task in this article was way faster than the normal Tables / Indexes approach.&nbsp;&nbsp;</p>\n\n\n\n<h2 class=\"wp-block-heading has-black-color has-text-color has-link-color wp-elements-1126ea8ae0024c5661ab855fd09a6d7b\"><em>ENDNOTE dementia and programming</em></h2>\n\n\n\n<p><em>I wrote an article in the end of May 2024 which had an </em><a href=\"https://www.thereformedprogrammer.net/how-to-update-a-nuget-library-once-the-author-isnt-available/#endnote-dementia-and-programming\"><em>endnote about my dementia</em></a><em>, talking about my diagnosis of Alzheimer&#8217;s disease in January 2024. Alzheimer&#8217;s disease is a progressive disease that worsens over time; this endnote talks about how I am in January 2025.</em></p>\n\n\n\n<p><em>I am very happy to say my programming skills are better! and that’s what this endnote talks abouts. However I have to say that there are a few negative symptoms as well, like something I call “sensory overload,” where if I do lots of different tasks one after another (or lots of people or sounds), then I feel overloaded. But I’m going to focus on how my programming skills got better, because developers will be reading this.</em></p>\n\n\n\n<p><em>In my first </em><a href=\"https://www.thereformedprogrammer.net/how-to-update-a-nuget-library-once-the-author-isnt-available/#endnote-dementia-and-programming\"><em>endnote about my dementia</em></a><em> I talked about using lists more to cover the problem of memory loss, and using my version </em><a href=\"https://neuraleffects.com/blog/cognitive-stimulation-therapy-activities/\"><em>Cognitive Stimulation Therapy</em></a><em> (CST) approach. The typical CST ‘s suggestions are to do crossword puzzles, Sudoku, Rubik’s Cube, etc. I do some of these but for me the best CST work is programming! I had to change my approach to programming to counter the dementia’s symptoms – and for me it works.</em></p>\n\n\n\n<p><em>It turns out in the last three months I have done a lot of programming:</em></p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><em>Added JSON Columns to my EfCore.SchemaCompare (very difficult!)</em></li>\n\n\n\n<li><em>Fixed a tricky problem my EfCore.SchemaCompare (complex)</em></li>\n\n\n\n<li><em>I updated five these libraries to .NET 9 (mostly easy)</em></li>\n\n\n\n<li><em>The </em><a href=\"https://github.com/JonPSmith/ExploringJsonColumns\"><em>ExploringJsonColumns </em></a><em>for this article (complex)</em></li>\n</ul>\n\n\n\n<p><em>Doing all this has helps me to regain some of my programming skills!, like my “holding all of parts of the code in my head” skill back (I talked about this in </em><a href=\"https://www.thereformedprogrammer.net/how-to-update-a-nuget-library-once-the-author-isnt-available/#endnote-dementia-and-programming\"><em>first endnote</em></a><em>). This skill gave a detailed understanding of design of any projects I was working on. This allows me to think about additions or improvements “in my head”, often after work without the code in front of me. I though everyone could do this, but when I lost this gift, I was devastated, but I also realised that my “in my head” skill might be rare. But now I have seen that I can get back my “in my head” skill, it makes it easier to do programming</em>!</p>\n\n\n\n<p><em>However dementia effects many parts of the brain, and the big ones for me are remembering words and spelling. Here are two that I have, with examples from my programming:</em></p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><strong><em>Correct name</em></strong><em>: For instance, when coding I usually know that I can do a task, but I can’t remember the name of the method I need. For instance, I knew I could select a subset of a list, but didn’t remember its name (it turns out is the LINQ’s Take method). This happened many times on my small ExploringJsonColumns project.</em></li>\n\n\n\n<li><strong><em>Correct spelling</em></strong><em>: The coding is bad, but the real problem is to remember how to spell a word, even when using Word to help me! I can’t put a number of the times I had to type a word, and it wasn’t correct, then I have to try different spelling or look up on the web (I found that Google Search is better that Word when figuring out what my incorrect version of a word should be).</em></li>\n</ul>\n\n\n\n<p><em>The other things I do when coding are:</em></p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><em><strong>Unit Tests: Indispensable</strong> : I have always used unit tests, but now I have dementia I need it more!</em></li>\n\n\n\n<li><em><strong>Task list: Now used:</strong> Before dementia I could handle many things in my head. Now I must create a task list to help me to not miss something. For this article I wrote the section names first, and then created the code for each section.</em></li>\n\n\n\n<li><em><strong>Use two monitors:</strong> If I am changing some code it’s useful to remember what the original code was, but my dementia removes the ability to remember things (short-term memory). Therefore I often have the original code on my second monitor while I updating the code using my main monitor.</em></li>\n</ul>\n\n\n\n<p>END</p>\n\n\n\n<p></p>\n",
    "sanitized": "Some developers used EF Core JSON Columns in their DbContext when using my EfCore.SchemaCompare library, then they had a problem. That’s because I hadn’t added support for JSON Columns to my EfCore.SchemaCompare library (this library compares a EF Core’s Model of the database against a database’s schema). When I added support for JSON Columns feature to the library, I found it had a rather complex internal design. In fact Shay Rojansky talks about this complex design in the EF Core 9 release EF Core community standup (click this to hear what he says) and they want to improve it in EF Core 10.\n\n\n\nSo the combination of a complex design, not much documentation, and my dementia (See the ENDNOTE dementia and programming section at the end of this article) made it pretty hard for me to work out what to do. Thankfully the EF Core team responded to my issue, which helped me a lot.\n\n\n\nSo, I decided to create this article to provide more documentation to help other developers when using JSON Columns. The article compares the EF Core normal approach of using SQL Tables, columns, Indexes, etc., (shortened to “Tables/Indexes approach” in this article) against the JSON Columns approach so that you can compare / contrast the two approaches.\n\n\n\nTL;DR; – Summary of this article\n\n\n\n\nEF Core added a feature called JSON Columns in .NET 7, which stores data in an JSON string, and was also updated in EF Core’s .NET 8 release.\n\n\n\nThis article compares the JSON Columns approach against the normal Tables/Indexes approach.\n\n\n\nI use a “list of books” app using both the JSON Columns approach and the Tables/Indexes approach\n\n\n\nThe way relationships are configured and stored are different – The JSON Columns’ relationships are held inside the its JSON string, while the the Tables/Indexes approach has multiple tables, linked by Indexes.\n\n\n\nThe create and read of both approaches are (nearly) the same, while selecting particular entries is different in the two approaches.\n\n\n\nThere is a large section looking at the performance of eight tasks with different numbers of the entities to give you an idea where JSON Columns would work in your application.\n\n\n\nAt the end I give you my, and EF Core’s, view of what sort of data that works with JSON Columns: The data must be “Coherent”,  i.e. there no links outside the data. Logging data is one example where JSON Columns would work well.\n\n\n\n\nIntroduction of storing data in a database using JSON\n\n\n\nJSON (Full name: JavaScript Object Notation) is a lightweight format for storing and transporting data in strings. The JSON’s format has a beautifully simple design, which makes it easy to understand and use. JSON is used everywhere, for instance Web Applications to send data from the server to the client and to send back inputs from the client.\n\n\n\nI also used JSON in my early use of EF Core by using the JsonSerializer.Serialize and JsonSerializer.Deserialize methods to store data in a database. But in the .NET 7 release of EF Core added dedicated code to convert data into a JSON string (this is known as “JSON Columns” in EF Core). In  .NET 8 release of EF Core to improve its performance and added JSON Columns to SQLite. And Shay Rojansky, who is part of the EF Core team, said they will improve how JSON Columns in .NET 10 EF Core.\n\n\n\nThe JSON Columns feature allows you to put some code in your EF Core’s DbContext’s OnModelCreating method to automatically convert a class’s properties into a JSON string. It also allows multiple classes, including relationships, to be stored in one JSON string.\n\n\n\nThe .NET 7 what’s new JSON Columns section says “JSON columns allow relational databases to take on some of the characteristics of document databases, creating a useful hybrid between the two.“ JSON Columns can contain any basic types: e.g., string, int, bool, DateTime and relationships, although JSON Columns’ relationships are handed differently to the normal Tables / Index approach.\n\n\n\nCreating an example application\n\n\n\nI wanted an example application that to covers relationships, configured, read/write and performance. I also I wanted an application that both the Tables/Indexes approach and JSON Columns approach can use. I choose a “list of books” app (think a very simple Amazon book app).\n\n\n\nI have to say that the “list of books” app is NOT something that I would build using JSON Columns, but it does show all the JSON Columns’ relationships. Also, the “list of books” app provides a good way to compare the JSON Columns’ performance against the Tables/Indexes approach.\n\n\n\n\nNOTE: I used a “list of books” app in my Entity Framework Core in Action (2nd. Edition). In chapter 2 I used the “list of books” app to show the main types of EF Core’s relations, and in chapter 15 looked at performance and chapter 16 using Cosmos DB.\n\n\n\n\nI created a GitHub called  ExploringJsonColumns which holds the code to check that the code was correct, and also to run performance tests to compare the two approaches. The sections in this article are:\n\n\n\n\nAn overview of the “list of books” data\n\n\n\nThe relationships and how they are configured\n\n\n\nWriting into the database\n\n\n\nSelecting data from the database\n\n\n\nReading data from the database\n\n\n\nPerformance comparisons\n\n\n\nMy thoughts on where JSON Columns are a good fit\n\n\n\n\n1. An overview of the “list of books” data\n\n\n\nMy ExploringJsonColumns solution holds two versions of the “list of books” app code: one using the normal Tables/Indexes approach and the other the JSON Columns approach, and provides the same output into common class called BookListDto (The BookListDto class contains all the data to show a book’s details, e.g., book title, author(s), price, star ratings, etc.. This ensures that we can compare their performances the results because both approaches are the same data. The screenshot below shows one (fictional) book showing the book’s data.\n\n\n\n\n\n\n2. The relationships and how they are configured\n\n\n\nThe “list of books” app has the three types of relationships, and the diagram below shows the Tables/Indexes approach on the left and the JSON Columns approach on the right.\n\n\n\nNOTE: click on the picture below to get a bigger picture.\n\n\n\n\n\n\n\nSee Tables/Indexes classes in this folder.See JSON Columns classes in this folder.\n\n\n\nThe JSON Columns part of the diagram above isn’t as clear as the Tables/Indexes approach, so the screenshot below shows the JSON in the BookData’s nvarchar(max) string.\n\n\n\n\n\n\n\nThe configuring of JSON Columns is added in your DbContext’s OnModelCreating method – see the diagram below which shows the BookJsonContext class with comments about where the JSON Columns’ OwnsOne and OwnsMany methods are used\n\n\n\n\n\n\n\nHere is a link to another the JsonCustomerContext DbContext which I used in testing my JSON Columns code added to my EfCore.SchemaCompare library. This shows how you can configure multiple layers (e.g., grandfather, father, son) relationships and handing multiples JSON Columns’ entities.\n\n\n\nThe differences between Tables/Indexes and JSON Columns version’s “many” relationships\n\n\n\nWhen showing a book with multiple authors you must ensure the authors’ names are in the correct order. In the Tables/Indexes approach: the BookAuthor class has an byte “Order” column to make sure that Author’s Names are shown in the correct order.\n\n\n\nBut in the JSON Columns approach the JsonAuthor class doesn’t need a “Order” property because the List<JsonAuthor> holds the authors’ names in the order they were added.  Therefore you don’t need a “Order” property.\n\n\n\n4. Writing into the database\n\n\n\nFrom the developer’s perspective the writing of data to the database uses the same process for the Table / Index approach and JSON Columns – you put data into a class and EF Core will store it into the database. EF Core will store Table / Index data into tables and columns, while with JSON Columns EF Core will store the data in a JSON string.\n\n\n\n5. Selecting data from the database\n\n\n\nIn the first version (EF Core 7) of the JSON Columns the only way to select data is using the Table / Index approach, i.e. by using column(s) to in the top entity, for instance in the  “lists of books” you could its Id (Index) in the BookTop class.\n\n\n\nBut in EF Core 8 there was a new Enhancements to JSON column mapping” feature which enables you to filter each entry (i.e. book) using data point(s) in the JSON string. I use this feature in my performance tasks to find all the books that has a specific author’s name. You can find that code here.\n\n\n\n6. Reading data from the database\n\n\n\nThe reading of JSON Columns’ data is very easy – you simply access the classes / properties just like the Table / Index approach. The only small difference is that any relationship in the JSON Columns is immediately available, so you don’t need to add code to load relationships (e.g., context.Books.Include(book => book.Reviews)… isn’t needed).\n\n\n\nNOTE: There are some rare situations when you need to a) read in many JSON Columns entities, and b) combine data, or you only need a subset of the data points, then using IEnumerable<> input and an IEnumerable<> out can make the process (a bit) quicker (see MapJsonBooks for an example). I found this when reading all the books ordered by each book’s star rating, because I had two ToList’s – using IEnumerable<> in/out removes one of the ToList method.\n\n\n\n4. Performance comparisons\n\n\n\nI had a project called ConsoleBenchmark in my ExploringJsonColumns solution which used  BenchmarkDotNet to get the performance of the two approaches, i.e., the normal Tables/Indexes approach and the JSON Columns approach. There are four tasks to compare, with two types of data:\n\n\n\n\nSimple data: This has the least relationships, with each book having one Author’s Name and no reviews or promotions.\n\n\n\nComplex data: This has many relationships, with each book having two Author’s Name and many reviews and a few promotions.\n\n\n\n\nTask nameWhat is does1. AddAdd N sample data to an empty SQL database2. ReadRead N sample data from the SQL database3. OrderRead N sample data and order the books using their star rating4. AuthorFind all the books that has a specific author’s name in the N sample data.\n\n\n\nThe first two tasks (Add, Read) don’t favour either approach, but last two tasks (Order, Author) should favour the Tables/Indexes approach because it can use indexes to get to the information more easily. NOTE: that the “Order” and  “Author” tasks don’t work in the Simple type.\n\n\n\nBelow are the benchmark results for the two setups: Simple and Complex, with a performance summary after the BenchmarkDotNet’s results.\n\n\n\n\n\n\n\n\n\n\n\nFrom the performance of this “list of books” code of you can say:\n\n\n\n\nAdd tests: The JSON Columns is as good, or better than the Table / Index version, and the 1,000 books with JSON Columns is nearly half the time of the Table / Index code. I suspect the number of relationships will have some effect on the Table / Index version’s performance.\n\n\n\nRead tests: The JSON Columns performance is near to the Table / Index version when there aren’t many books, i.e., 10, but once you get to 100 books takes 8 times longer, and with 1,000 test Columns takes 10 times longer.\n\n\n\nOrder tests (complex only): I thought the Table / Index version would win every time because it could use the LINQ Average method on all the review’s star rating, but in the “ten books” JSON Columns works well. However, compared against the Table / Index version the 100 books JSON Columns take 7 times longer, and 1,000 JSON Columns takes 7 times longer.\n\n\n\nAuthor tests (complex only):  This task finds all the books that have a specific author’s name. The JSON Columns approach was better than I expected, but it’s always slower than the Table/Index approach. The worse was 1,000 JSON Columns version, which was 8 times slower that the Table/Index approach.\n\n\n\n\n5. My thoughts on where JSON Columns are a good fit\n\n\n\nI used the “list of books” code because it covers the JSON Columns’ relationships, configuration, types of reading, etc. which makes a good example. As I said earlier, I was sure that the normal Table / Index approach would have the best performance on the “list of books” tests, and I was right. But I was surprised that the JSON Columns did so well!\n\n\n\nSo, what types of data is a good fit for using JSON Columns? My take is:\n\n\n\n\nThe data has many parts.\n\n\n\nEach data point can be held in a built-in type, e.g. int, bool, string…\n\n\n\nThe data points are “coherent”,  i.e. there no links outside this data.\n\n\n\n\nThis means the JSON Columns approach is good if you have lots of data about one thing that doesn’t need links to another entity. The .NET 7 release the EF Core documentation gives you examples that work well with JSON Columns, for instance:\n\n\n\n\nContact Details: name, phones, address, etc.\n\n\n\nLogging: what, where, when, who…\n\n\n\n\nThe other thing to consider is the performance comparison where the JSON Columns approach is better that the Table / Index approach. The Performance comparisons section show that:\n\n\n\n\nAdding a lot of JSON Columns data is normally faster than the Table / Index approach (I think this because the Table / Index approach of the “”list of books” app has to create more indexing and relationships on adding).\n\n\n\nDo you need to read a lot of entities using JSON Columns, then a JSON Columns can be slow. For instance, “list of books”:JSON Columns: 10 takes the same as the Table / Index approach, but…JSON Columns: 100 takes 2 times of the Table / Index approach\n\nJSON Columns: 1,000 takes 8 times of the Table / Index approach\n\n\n\n\n\nIf there are lookups (e.g., finding all the books for a specific Author) or ordering, then the Table / Index approach, with its links using Indexing, is likely to perform better that JSON Columns approach. For instance, in the Author task the JSON Columns approach has read every AuthorName in each entity, while the  Table / Index approach only has to look at the at the links via the BookAuthor class, which are 10.\n\n\n\n\nConclusion\n\n\n\nI hope this article helps you to understand how to setup and use EF Core’s JSON Columns feature. Also the performance figures give you some idea of what JSON Columns will do in add, read, and filter tasks.\n\n\n\nJust to end, if your data fits a JSON Columns approach, but performance is critical, then I would recommend Cosmos DB. I used Cosmos DB with the CQRS pattern in chapter 16 of my book Entity Framework Core in Action (2nd. Edition) and I found it very fast. For instance, the Order task in this article was way faster than the normal Tables / Indexes approach.  \n\n\n\nENDNOTE dementia and programming\n\n\n\nI wrote an article in the end of May 2024 which had an endnote about my dementia, talking about my diagnosis of Alzheimer’s disease in January 2024. Alzheimer’s disease is a progressive disease that worsens over time; this endnote talks about how I am in January 2025.\n\n\n\nI am very happy to say my programming skills are better! and that’s what this endnote talks abouts. However I have to say that there are a few negative symptoms as well, like something I call “sensory overload,” where if I do lots of different tasks one after another (or lots of people or sounds), then I feel overloaded. But I’m going to focus on how my programming skills got better, because developers will be reading this.\n\n\n\nIn my first endnote about my dementia I talked about using lists more to cover the problem of memory loss, and using my version Cognitive Stimulation Therapy (CST) approach. The typical CST ‘s suggestions are to do crossword puzzles, Sudoku, Rubik’s Cube, etc. I do some of these but for me the best CST work is programming! I had to change my approach to programming to counter the dementia’s symptoms – and for me it works.\n\n\n\nIt turns out in the last three months I have done a lot of programming:\n\n\n\n\nAdded JSON Columns to my EfCore.SchemaCompare (very difficult!)\n\n\n\nFixed a tricky problem my EfCore.SchemaCompare (complex)\n\n\n\nI updated five these libraries to .NET 9 (mostly easy)\n\n\n\nThe ExploringJsonColumns for this article (complex)\n\n\n\n\nDoing all this has helps me to regain some of my programming skills!, like my “holding all of parts of the code in my head” skill back (I talked about this in first endnote). This skill gave a detailed understanding of design of any projects I was working on. This allows me to think about additions or improvements “in my head”, often after work without the code in front of me. I though everyone could do this, but when I lost this gift, I was devastated, but I also realised that my “in my head” skill might be rare. But now I have seen that I can get back my “in my head” skill, it makes it easier to do programming!\n\n\n\nHowever dementia effects many parts of the brain, and the big ones for me are remembering words and spelling. Here are two that I have, with examples from my programming:\n\n\n\n\nCorrect name: For instance, when coding I usually know that I can do a task, but I can’t remember the name of the method I need. For instance, I knew I could select a subset of a list, but didn’t remember its name (it turns out is the LINQ’s Take method). This happened many times on my small ExploringJsonColumns project.\n\n\n\nCorrect spelling: The coding is bad, but the real problem is to remember how to spell a word, even when using Word to help me! I can’t put a number of the times I had to type a word, and it wasn’t correct, then I have to try different spelling or look up on the web (I found that Google Search is better that Word when figuring out what my incorrect version of a word should be).\n\n\n\n\nThe other things I do when coding are:\n\n\n\n\nUnit Tests: Indispensable : I have always used unit tests, but now I have dementia I need it more!\n\n\n\nTask list: Now used: Before dementia I could handle many things in my head. Now I must create a task list to help me to not miss something. For this article I wrote the section names first, and then created the code for each section.\n\n\n\nUse two monitors: If I am changing some code it’s useful to remember what the original code was, but my dementia removes the ability to remember things (short-term memory). Therefore I often have the original code on my second monitor while I updating the code using my main monitor.\n\n\n\n\nEND"
  },
  {
    "itemId": "https://www.thereformedprogrammer.net/?p=2938",
    "raw": "\n<p>I’m writing this article because I have an illness called <a href=\"https://www.cdc.gov/aging/dementia/index.html\">dementia</a>, which over time degrades a person&#8217;s ability to remember, think, and make decisions. This means at some point I won’t be able to build or update my open-source NuGet libraries, so this article shows you how to update my libraries when I’m not available.</p>\n\n\n\n<p>I detected that something had changed because it affected my programming, in a bad way! This gave me early detection of my dementia, and the ways to overcome some the loss of me programming skills that dementia had taken away. (See the <a href=\"https://www.thereformedprogrammer.net/how-to-update-a-nuget-library-once-the-author-isnt-available/#endnote-dementia-and-programming\"><em>ENDNOTE&nbsp; dementia and</em> programming</a> section at the end of this article)</p>\n\n\n\n<p>But my time is limited, so I have focused on making sure that users can still use my libraries before my dementia stops me from updating my libraries myself. Dementia works differently with each person so I won’t know if I can update my libraries to any new .NET, but I’m pretty sure I will be able to update my libraries to .NET 9, but I can’t say for sure on other years.<em></em></p>\n\n\n\n<p>The rest of this article tells you which of my libraries need to be updated when Microsoft creates a new .NET version, e.g. .NET 9. While <a href=\"https://www.nuget.org/profiles/jon%20smith\">I have 20 NuGets</a> in nuget.org, only seven of the NuGets use a specific .NET version &#8211; the others NuGets use NET Standard which doesn’t change.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: The approaches I describe in this article for updating my libraries also works on any NuGet libraries that aren’t being updated by their author(s).&nbsp;</p>\n</blockquote>\n\n\n\n<h2 class=\"wp-block-heading\">TL;DR; – Summary of this article</h2>\n\n\n\n<ul class=\"wp-block-list\">\n<li>In this article I use the following names:<ul><li><strong>Library</strong>: I refer to the source code of a library with the name “library”.</li></ul><ul><li><strong>NuGet</strong>: I refer to a library that has been turned into an easy-to-use file referred to as a&nbsp; NuGet. <a href=\"https://www.nuget.org\">https://www.nuget.org</a> is one place which holds NuGets. NuGet are normally managed by your development app, e.g. Visual Studio.</li></ul>\n<ul class=\"wp-block-list\">\n<li><strong>.nupkg file:</strong> When creating a new NuGet you might have to work with the file ending with&nbsp; .nupkg. Typically you will have to manually move / push a .nupkg file to code that handles NuGets.</li>\n</ul>\n</li>\n\n\n\n<li>Many of my libraries use the NET Standard versions which will work with any supported .NET version . This means that you don’t have to update these libraries. <a href=\"https://www.thereformedprogrammer.net/how-to-update-a-nuget-library-once-the-author-isnt-available/#my-libraries-that-dont-need-an-update-when-a-new-net-version-comes-out\">This section</a> covers this.</li>\n\n\n\n<li>The pros and cons of building libraries that needs a specific .NET version is covers in <a href=\"https://www.thereformedprogrammer.net/how-to-update-a-nuget-library-once-the-author-isnt-available/#the-pros-and-cons-of-using-full-net-version-nugets\">this section</a>.</li>\n\n\n\n<li>I have seven libraries that use a specific .NET version, e.g. going from .NET 8 to .NET 9 (I call this a <em>“NET-specific library”</em>). These libraries needs to be updated when a new .NET version comes out, and some point I won’t be there to update them. There are two things I have done to make it easier to update:<ul><li>I have made NET-specific libraries easier to update when a new .NET version comes out. <a href=\"https://www.thereformedprogrammer.net/how-to-update-a-nuget-library-once-the-author-isnt-available/#making-net-specific-libraries-easier-to-update\">This section</a> covers this.</li></ul>\n<ul class=\"wp-block-list\">\n<li>Then I detail how you can Clone the library’s code, update the library to a newer .NET version, and create a NuGet version. <a href=\"https://www.thereformedprogrammer.net/how-to-update-a-nuget-library-once-the-author-isnt-available/#how-to-upgrade-a-net-specific-library-to-a-new-net-version\">This section</a> covers this.</li>\n</ul>\n</li>\n\n\n\n<li>At the end of this article I have a section called <em><a href=\"https://www.thereformedprogrammer.net/how-to-update-a-nuget-library-once-the-author-isnt-available/#endnote-dementia-and-programming\">ENDNOTE dementia and programming</a></em>  covering my experience of dementia and programming, both good and bad.</li>\n</ul>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: I use Visual Studio Community to show you how to update a library because that what I use, but I expect other development tools can do this too.</p>\n</blockquote>\n\n\n\n<h2 class=\"wp-block-heading\">My libraries that don’t need an update when a new .NET version comes out</h2>\n\n\n\n<p>Libraries that only uses NET Standard NuGets don’t have to be updated when new .NET comes out, e.g. NET 9. NET Standard libraries contains a set of fundamental APIs (commonly referred to as base class library or BCL) that all .NET implementations must implement.</p>\n\n\n\n<p>Eight of my libraries uses NET Standard and they typically provide a basic specific feature that can be used anywhere. For instance, the NetCore.AutoRegisterDi library can automatically register your services into the Microsoft NET&#8217;s Dependency injection provider &#8211; this library has the most downloads at 3.1 million and is the smallest library with ~200 lines of code.</p>\n\n\n\n<p>The table below contains the eight libraries using NET Standard with links to the NuGet, documentation and an article which gives you an overview of each library.</p>\n\n\n\n<figure class=\"wp-block-table\"><table><tbody><tr><td><strong>NuGet Name</strong></td><td><strong>Docs link</strong></td><td><strong>Article link</strong></td></tr><tr><td><a href=\"https://www.nuget.org/packages/NetCore.AutoRegisterDi\">NetCore.AutoRegisterDi</a></td><td><a href=\"https://github.com/JonPSmith/NetCore.AutoRegisterDi/blob/master/README.md\">ReadMe</a></td><td><a href=\"https://www.thereformedprogrammer.net/asp-net-core-fast-and-automatic-dependency-injection-setup/\">Article</a></td></tr><tr><td><a href=\"https://www.nuget.org/packages/GenericServices.StatusGeneric\">GenericServices.StatusGeneric</a></td><td><a href=\"https://github.com/JonPSmith/GenericServices.StatusGeneric/blob/master/README.md\">ReadMe</a></td><td><a href=\"https://www.thereformedprogrammer.net/a-pattern-library-for-methods-that-return-a-status-including-localization/\">Article</a></td></tr><tr><td><a href=\"https://www.nuget.org/packages/EfCore.GenericBizRunner\">EfCore.GenericBizRunner</a></td><td><a href=\"https://github.com/JonPSmith/EfCore.GenericBizRunner/wiki\">Wiki</a></td><td><a href=\"https://www.thereformedprogrammer.net/a-library-to-run-your-business-logic-when-using-entity-framework-core/\">Article</a></td></tr><tr><td><a href=\"https://www.nuget.org/packages/Net.RunMethodsSequentially\">Net.RunMethodsSequentially</a></td><td><a href=\"https://github.com/JonPSmith/RunStartupMethodsSequentially/blob/main/README.md\">ReadMe</a></td><td><a href=\"https://www.thereformedprogrammer.net/how-to-safely-apply-an-ef-core-migrate-on-asp-net-core-startup/\">Article</a></td></tr><tr><td><a href=\"https://www.nuget.org/packages/EfCore.GenericServices.AspNetCore\">EfCore.GenericServices.AspNetCore</a></td><td><a href=\"https://github.com/JonPSmith/EfCore.GenericServices.AspNetCore/blob/master/README.md\">ReadMe</a></td><td><a href=\"https://www.thereformedprogrammer.net/how-to-write-good-testable-asp-net-core-web-api-code-quickly/\">Article</a></td></tr><tr><td><a href=\"https://www.nuget.org/packages/Net.DistributedFileStoreCache\">Net.DistributedFileStoreCache</a></td><td><a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache/wiki\">Wiki</a></td><td><a href=\"https://www.thereformedprogrammer.net/a-net-distributed-cache-with-a-25-nanosecond-read-time/\">Article</a></td></tr><tr><td><a href=\"https://www.nuget.org/packages/EfCore.GenericEventRunner\">EfCore.GenericEventRunner</a> and …<a href=\"https://www.nuget.org/packages/EfCore.GenericEventRunner.DomainParts\">DomainParts</a></td><td><a href=\"https://github.com/JonPSmith/EfCore.GenericEventRunner/wiki\">Wiki</a></td><td><a href=\"https://www.thereformedprogrammer.net/efcore-genericeventrunner-an-event-driven-library-that-works-with-ef-core/\">Article</a></td></tr></tbody></table></figure>\n\n\n\n<p>The rest of this article covers the libraries that works with a specific .NET version, e.g. .NET 9. These libraries are focused on EF Core and ASP.NET Core applications.</p>\n\n\n\n<h2 class=\"wp-block-heading\">The pros and cons of using full .NET version NuGets</h2>\n\n\n\n<p>Microsoft releases a new .NET version, e.g. .NET 9, every year. This has allowed Microsoft to add new features and improve performance of .NET applications. These yearly releases have allowed .NET to up to date and very fast. But the downside is if you want to update your application to a new .NET version, then you need to upgrade all the <em><u>NuGets that uses a NET-specific version</u></em>, e.g. NET 9.</p>\n\n\n\n<p>So, if you can’t get every NuGet for the .NET version you are moving to, then your application might not work!</p>\n\n\n\n<p>I have six libraries that uses NET-specific that need updating every year. These libraries are listed below, ordered by the most downloaded version coming first.</p>\n\n\n\n<figure class=\"wp-block-table\"><table><tbody><tr><td><strong>NuGet Name</strong></td><td><strong>Docs</strong></td><td><strong>Article</strong></td></tr><tr><td><a href=\"https://www.nuget.org/packages/EfCore.TestSupport#readme-body-tab\">EfCore.TestSupport</a></td><td><a href=\"https://github.com/JonPSmith/EfCore.TestSupport/wiki\">Wiki</a></td><td><a href=\"https://www.thereformedprogrammer.net/new-features-for-unit-testing-your-entity-framework-core-5-code/\">Article</a></td></tr><tr><td><a href=\"https://www.nuget.org/packages/EfCore.SchemaCompare#readme-body-tab\">EfCore.SchemaCompare</a></td><td><a href=\"https://github.com/JonPSmith/EfCore.SchemaCompare/blob/master/README.md\">ReadMe</a></td><td><a href=\"https://www.thereformedprogrammer.net/how-to-update-a-databases-schema-without-using-ef-cores-migrate-feature/\">Article</a></td></tr><tr><td><a href=\"https://www.nuget.org/packages/EfCore.GenericServices#readme-body-tab\">EfCore.GenericServices</a></td><td><a href=\"https://github.com/JonPSmith/EfCore.GenericServices/wiki\">Wiki</a></td><td><a href=\"https://www.thereformedprogrammer.net/genericservices-a-library-to-provide-crud-front-end-services-from-a-ef-core-database/\">Article</a></td></tr><tr><td><a href=\"https://www.nuget.org/packages/EfCore.SoftDeleteServices#readme-body-tab\">EfCore.SoftDeleteServices</a></td><td><a href=\"https://github.com/JonPSmith/EfCore.SoftDeleteServices/wiki\">Wiki</a></td><td><a href=\"https://www.thereformedprogrammer.net/introducing-the-efcore-softdeleteservices-library-to-automate-soft-deletes/\">Article</a></td></tr><tr><td><a href=\"https://www.nuget.org/packages/AuthPermissions.AspNetCore#readme-body-tab\">AuthPermissions.AspNetCore</a> and MultiProjPack</td><td><a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki\">Wiki</a></td><td><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part1-the-database/\">Article</a></td></tr><tr><td><a href=\"https://www.nuget.org/packages/Net.LocalizeMessagesAndErrors#readme-body-tab\">Net.LocalizeMessagesAndErrors</a></td><td><a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki\">Wiki</a></td><td><a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/\">Article</a></td></tr></tbody></table></figure>\n\n\n\n<p>Sometimes an older NET-specific NuGet version, e.g. .NET 8, will work for a new application using a higher .NET release, e.g. .NET 9. It depends on whether the new .NET version changes some part of the code that the older NuGet uses. I think most of my .NET 8 libraries will work with .NET 9 because my libraries typically use the basic features, <strong>but you can’t be sure it will work!</strong> If you have a lot of tests to check everything will work with the older NuGens, then it’s MUCH quicker.</p>\n\n\n\n<p>I’m assume that most people will want a new NuGet that supports the new .NET version and rest of the rest of the rest of article shows you how to update a library yourself. But first I talk about how I have changed my libraries so that it much easier to update my libraries.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Making NET-specific libraries easier to update</h2>\n\n\n\n<p>When I created NET-specific libraries I usually created a NuGet which supported multiple .NET versions, for instance <a href=\"https://www.nuget.org/packages/EfCore.TestSupport/6.0.2#supportedframeworks-body-tab\">EfCore.TestSupport version 6.0.2</a> supports .NET 6, 7 and 8. The upside of supporting multiple .NETs is that if I add a new feature or fix a bug, then I can release one NuGet with the features/bug fixes that covers multiple .NETs.</p>\n\n\n\n<p>But the downside is that it’s very hard to update to a new .NET release for three reasons:</p>\n\n\n\n<ol class=\"wp-block-list\">\n<li>You can’t use the Microsoft Visual Studio’s “NuGet Package Manager” features to update a library. Instead you must manually edit all the .csproj files in the library code. I have been doing this for years and it’s a pain to do.</li>\n\n\n\n<li>It’s harder to find / update NuGets with a vulnerability. I found this when .NET 8 had a vulnerability in the <a href=\"https://techcommunity.microsoft.com/t5/sql-server-blog/released-security-updates-for-microsoft-data-sqlclient-and/ba-p/4024264\">System.Data.SqlClient</a>. I had to go through my libraries to select the non-vulnerable replacement, including effected NuGets. You also can’t use the <a href=\"https://docs.github.com/en/code-security/dependabot/working-with-dependabot/managing-pull-requests-for-dependency-updates#about-dependabot-pull-requests\">GitHub’s useful dependabot PRs</a> to fix vulnerability, but you must manually edit the .csproj files.</li>\n\n\n\n<li>I found it’s harder to find depreciated NuGets because sometimes a NuGet is valid in an older .NET version but is depreciated in the latest .NET version.</li>\n</ol>\n\n\n\n<p>To make it easier for me, and you, I changed all my NET-specific libraries to only support one .NET version and fix any vulnerability and removed depreciated NuGets. I applied this to all of my NET-specific libraries and I released new versions of my NET-specific libraries that only support .NET 8.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p></p>\n<cite>NOTE: If you are still using .NET version below .NET 8, then the older versions of my libraries are still there for you.</cite></blockquote>\n\n\n\n<p>After making my NET-specific libraries simpler to update and cleaner, then the next part shows you how to create a new version of these NuGets if the author (e.g. me!) can’t update the library when another .NET is released.</p>\n\n\n\n<h2 class=\"wp-block-heading\">How to upgrade a NET-specific library to a new .NET version</h2>\n\n\n\n<p>This (long) section shows how you update a library that hasn’t been updated and the author(s) hasn’t updated to the new .NET version. I only assume you have access to the library’s code, e.g. GitHub, and you have a development application that can edit, compile and test the library’s code, e.g.&nbsp; Visual Studio.</p>\n\n\n\n<p>The steps are:</p>\n\n\n\n<p>1a. Get the NuGet’s code into your development app</p>\n\n\n\n<p>1b. Update the .NET TargetFramework of the library</p>\n\n\n\n<p>1c. Update the NuGets</p>\n\n\n\n<p>1d. Compile the changed code</p>\n\n\n\n<p>1e. Run the unit tests</p>\n\n\n\n<p>1f. Update the NuGets information</p>\n\n\n\n<p>1g. Create a local .nupkg file</p>\n\n\n\n<p>1h. Add a local NuGet source to your application</p>\n\n\n\n<h4 class=\"wp-block-heading\">1a. Get the NuGet’s code into your development app</h4>\n\n\n\n<p>Nowadays most Microsoft open-source libraries can be found in <a href=\"https://github.com/\">GitHub</a>, and that’s where my libraries are situated. You usually can find the NuGet’s source code by looking the NuGet via <a href=\"http://www.nuget.org\">www.nuget.org</a> and clicking the “Source repository” link found on the RHS. Then you need to “Clone” the source code into your Visual Studio app.</p>\n\n\n\n<p>Once you have cloned the library, I suggest you compile and run any unit tests before you change anything. This will let you know if something isn’t working, e.g. the unit tests need the database connection string changed to match your setup and give you a set of unit test results to compare with the unit test after you have updated to a new .NET version. See section ??LINK?? if your tests use databases.</p>\n\n\n\n<h4 class=\"wp-block-heading\">1b. Update the .NET TargetFramework of the library</h4>\n\n\n\n<p>Each CS project contains a file ending in .csproj which holds the version or versions that the project can work with. Because I have tidied-up libraries to only have one version, e.g., .NET 8, which means it’s very easy to change – you just have to update the &lt;TargetFramework&gt; line from the old .NET to the new .NET. This is simple to do via Visual Studio’s “Find and Replace&gt;Place in Files” feature, the screenshot below shows how to change a library using .NET 8 to .NET 9.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/VisualStudio-PlaceInFiles.png\"><img loading=\"lazy\" decoding=\"async\" width=\"542\" height=\"548\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/VisualStudio-PlaceInFiles.png\" alt=\"\" class=\"wp-image-2940\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/VisualStudio-PlaceInFiles.png 542w, https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/VisualStudio-PlaceInFiles-297x300.png 297w\" sizes=\"auto, (max-width: 542px) 100vw, 542px\" /></a></figure>\n\n\n\n<p>Once you have clicked the “Replace All” button then each project will be updated to the new .NET version. At this point Visual Studio will show an error (see screenshot below) because Visual Studio can’t handle this change automatically. Clicking the “Reload projects” normally fixes this, but in some cases I had to close Visual Studio and reopen the library again remove the errors.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/VIsualStudioReloadProjects.png\"><img loading=\"lazy\" decoding=\"async\" width=\"649\" height=\"41\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/VIsualStudioReloadProjects.png\" alt=\"\" class=\"wp-image-2941\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/VIsualStudioReloadProjects.png 649w, https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/VIsualStudioReloadProjects-300x19.png 300w\" sizes=\"auto, (max-width: 649px) 100vw, 649px\" /></a></figure>\n\n\n\n<h4 class=\"wp-block-heading\">1c. Update the NuGets</h4>\n\n\n\n<p>After the library has been updated to the new .NET, then you need to update all the NuGets in every project in the library. The simplest way to update all the projects’ NuGets is to use Visual Studio’s “Manage NuGets Packages” feature which is found by right-clicking the top “Solution” found in Solution Explorer window. The screenshot below shows the Manage NuGets Packages in Update mode &nbsp;(Note: the screenshot was taken before .NET 9 was released so I turned on “prerelease”, but normally you would have “prerelease” turned off).</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/NuGetPackagesForSolution.png\"><img loading=\"lazy\" decoding=\"async\" width=\"769\" height=\"419\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/NuGetPackagesForSolution.png\" alt=\"\" class=\"wp-image-2942\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/NuGetPackagesForSolution.png 769w, https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/NuGetPackagesForSolution-300x163.png 300w\" sizes=\"auto, (max-width: 769px) 100vw, 769px\" /></a></figure>\n\n\n\n<p></p>\n\n\n\n<p>The obvious way to update all the NuGets in the library is to select the “Updates” button and tick the “Select all packages” to select all the NuGets to be updated to the latest version. This is it quick and it works, but it’s worth checking that you are using the lowest valid versions of the NuGets in the library &#8211; typically the lowest valid version that ends with “0.0”, e.g. 9.0.0. Having higher versions, e.g. 9.0.1, can cause problems if your application has the same NuGet at a lower version (i.e. 9.0.0) but of the same NuGet in the library has. In this case it will show an error saying that NuGet SomeName needs a &gt;= 9.0.1, but your app is using SomeName 9.0.0.</p>\n\n\n\n<p>There are a couple of my libraries that have specific versions for some of its NuGets:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>EfCore.TestSupport: When updating my EfCore.TestSupport library you don’t want the highest versions of the xunit.core and xunit.assert NuGets. Thats because when Visual Studio creates a xUnit Test Project it doesn’t use the latest xunit versions. I suggest you create a xUnit Test Project via Visual Studio and find the xunit version it uses, then use the same version &nbsp;in EfCore.TestSupport xunit.core and xunit.assert NuGets.</li>\n\n\n\n<li>AuthPermissions.AspNetCore: the AuthP library uses Microsoft.Graph version 4, not version 5. Therefore you should select Microsoft.Graph 4.54.0, and NOT the latest 5.?.? versions.</li>\n</ul>\n\n\n\n<p>Also, you should look for vulnerable NuGets and select a non-vulnerable versions instead. Vulnerable NuGet packages are .NET packages with security weaknesses that can be exploited by attackers. Most vulnerable NuGets are normally are accidental flaws. Visual Studio has a &#8220;show only vulnerable&#8221; item in the Process &gt; Manage NuGet Packages &#8211; the screenshot below shows how to find vulnerable NuGets.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/image-1.png\"><img loading=\"lazy\" decoding=\"async\" width=\"772\" height=\"237\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/image-1.png\" alt=\"\" class=\"wp-image-3007\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/image-1.png 772w, https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/image-1-300x92.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/image-1-768x236.png 768w\" sizes=\"auto, (max-width: 772px) 100vw, 772px\" /></a></figure>\n\n\n\n<h4 class=\"wp-block-heading\">1d. Compile the changed code</h4>\n\n\n\n<p>Once you have changed the library’s .NET version (step 1b) and updated the NuGets (step 1c) then you are ready to compile the code. I recommend you use the Build&gt;Rebuild Solution to compile the code because changing the version and NuGets have a lot of effects.</p>\n\n\n\n<p>Normally the code compiles OK, but in some very rare cases the compile fails. In this case it’s likely that the new .NET version has changed, moved (e.g. changing the method’s name) or removed some code features. In this case you need to see what the problems are and decide what to do about it.</p>\n\n\n\n<p>NOTE: In my EfCore.TestSupport library I added a feature called EnsureClean which was faster, but used code that is not supported by Microsoft. In NET 9 version I changes the EnsureClean to use EnsureDeleted / EnsureCreated. It slower but works ever time.</p>\n\n\n\n<h4 class=\"wp-block-heading\">1e. Run the unit tests</h4>\n\n\n\n<p>All of my NET-specific &nbsp;libraries have a Test project which uses my EfCore.TestSupport library to test the library. You are looking for every test to be passed, but in some cases I have a failing test to say that a feature that doesn’t work (EfCore.SchemaCompare has one of those). That way I suggested you ran the unit tests on the original library in step 1a because you it will show you what a good run looks like.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: My EfCore.TestSupport library allows you <a href=\"https://github.com/JonPSmith/EfCore.TestSupport/wiki/Using-SQLite-in-memory-databases\">set up a SQLite in-memory database</a>, and a way to set SqlServer and PostgreSQL connections strings – see <a href=\"https://github.com/JonPSmith/EfCore.TestSupport/wiki/Creating-connection-strings\">this documentation</a> on how this.</p>\n</blockquote>\n\n\n\n<h4 class=\"wp-block-heading\">1f. Update the NuGets information</h4>\n\n\n\n<p>To define a NuGet there lots of values you need to provide to create a valid NuGet. For most of my libraries there is one project file (.csproj) in the code that contains the setting to create a NuGet file. For instance the EfCore.TestSupport NuGet has the NuGet information in the <a href=\"https://github.com/JonPSmith/EfCore.TestSupport/blob/master/TestSupport/TestSupport.csproj\">TestSupport.csproj file</a>. So before you compile the library you need to update three values to create a new version, as shown below.</p>\n\n\n\n<figure class=\"wp-block-table\"><table><tbody><tr><td><strong>Name</strong></td><td><strong>Example values</strong></td><td><strong>Notes</strong></td></tr><tr><td>PackageVersion and Version</td><td>9.0.0</td><td>Must be unique on your computer</td></tr><tr><td>PackageReleaseNotes</td><td>Updated to .NET 9</td><td>&nbsp;</td></tr></tbody></table></figure>\n\n\n\n<p>In the case of the AuthP library, which has multiple projects going into a NuGet, I had to create a dotnet tool called JonPSmith.MultiProjPack, <a href=\"https://www.nuget.org/packages/JonPSmith.MultiProjPack\">found in nuget.org</a>. This used a file called <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.AspNetCore/MultiProjPack.xml\">MultiProjPack.xml</a> in the AuthP and the values you need to change are:</p>\n\n\n\n<figure class=\"wp-block-table\"><table><tbody><tr><td><strong>Name</strong></td><td><strong>Example values</strong></td><td><strong>Notes</strong></td></tr><tr><td>version</td><td>9.0.0</td><td>Must be unique on your computer</td></tr><tr><td>releaseNotes</td><td>Updated to .NET 9</td><td>&nbsp;</td></tr></tbody></table></figure>\n\n\n\n<h4 class=\"wp-block-heading\">1g. Create a local .nupkg file</h4>\n\n\n\n<p>All my libraries, apart from AuthP, are designed create a NuGet .nupkg file on every compile. You want to be in “Release” mode when compiling to create a NuGet because it will create a smaller and faster NuGet file (“Debug” NuGets are useful if you want to see debug information from the NuGet).</p>\n\n\n\n<p>On compile in “Release” mode the NuGet file will be created in:</p>\n\n\n\n<p>…&lt;SolutionName&gt;\\&lt;PrimaryProjectName&gt;\\bin\\Release\\&lt;NuGetName&gt;. nupkg</p>\n\n\n\n<p>And here is a real example of my EfCore.TestSupport NuGet:</p>\n\n\n\n<p>…\\EfCore.TestSupport\\TestSupport\\bin\\Release\\EfCore.TestSupport.8.0.1.nupkg</p>\n\n\n\n<p>In the case of the AuthP library, which has multiple projects to create the NuGet, I created a dotnet tool called <a href=\"https://www.nuget.org/packages/JonPSmith.MultiProjPack#readme-body-tab\">JonPSmith.MultiProjPack</a> to create the .nupkg file. The “<a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/README.md#how-to-create-an-authpermissionsaspnetcore-nuget-package\">How to create an AuthPermissions.AspNetCore NuGet package</a>” in the AuthP’s ReadMe file shows how to install and run this dotnet tool.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: You can read about why I create the <a href=\"https://www.nuget.org/packages/JonPSmith.MultiProjPack#readme-body-tab\">JonPSmith.MultiProjPack</a> dotnet tool in the <a href=\"https://github.com/JonPSmith/MultiProgPackTool/blob/main/README.md\">ReadMe</a> of the code.</p>\n</blockquote>\n</blockquote>\n\n\n\n<p>TIP: I recommend using the <a href=\"https://apps.microsoft.com/detail/9wzdncrdmdm3\">NuGet Package Explorer</a> app to check that the NuGet Package you just created has the settings / information that you was expecting.</p>\n\n\n\n<h4 class=\"wp-block-heading\">1h. Add a local NuGet .nupkg file source to your application</h4>\n\n\n\n<p>The previous step created the NuGet .nupkg file, but to use this file you need to setup Visual Studio’s &nbsp;NuGet Package Manager to handle local .nupkg files. Typically you would get NuGets via the <a href=\"https://www.nuget.org\">https://www.nuget.org</a> app, but Visual Studio’s NuGet Package Manager has a way to find NuGet from a directory on your development computer.</p>\n\n\n\n<p>To use this “local NuGets” feature you need to:</p>\n\n\n\n<ol class=\"wp-block-list\">\n<li>Create a directory to hold the local NuGets. My local NuGet directory is called “LocalNuGet” in my user account, i.e. C:\\Users\\JonPSmith\\LocalNuGet.</li>\n\n\n\n<li>Then you manually copy the new .nupkg file in the Project &gt; bin &gt; Release directory to your local NuGet directory you set up in the last step.</li>\n\n\n\n<li>You need go into the Options&gt;NuGet Package Manager&gt;Package Sources and add a new source where source is a directory on your development computer – see the screenshot below.</li>\n</ol>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/SettingLocalNuGet.png\"><img loading=\"lazy\" decoding=\"async\" width=\"737\" height=\"429\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/SettingLocalNuGet.png\" alt=\"\" class=\"wp-image-2943\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/SettingLocalNuGet.png 737w, https://www.thereformedprogrammer.net/wp-content/uploads/2024/05/SettingLocalNuGet-300x175.png 300w\" sizes=\"auto, (max-width: 737px) 100vw, 737px\" /></a></figure>\n\n\n\n<p>After that you can click on the “Package source” and select the “Local NuGet” you can access to the local NuGet(s) you updated. That allows you to update your application’s NuGets using the normal NuGets via <a href=\"https://www.nuget.org\">https://www.nuget.org</a> and local NuGets you created yourself on your local computer.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: In the case of the AuthP library, the MultiProjPack dotnet tool automatically copies the new NuGet to the “{USERPROFILE}\\LocalNuGet” directory.</p>\n</blockquote>\n\n\n\n<h2 class=\"wp-block-heading\">Conclusion</h2>\n\n\n\n<p>It would be great if all the NET-specific NuGets you use are always updated when a new .NET version comes out, but sometimes they aren’t. That usually means the author(s) should update a NET-specific NuGet and then add it into the <a href=\"https://www.nuget.org\">https://www.nuget.org</a> application. But in my case, I know that some time I won’t be able update my libraries, which would be a pity for people who use my libraries.</p>\n\n\n\n<p>I hoped I’ll be able to still do programming for years, but when .NET 10 came out my dementia had taken my ability to do understand how to update my .NET apps. That’s why I created this article now while I’m doing well so that you‘re covered if I’m not around. The other reason for me to keep programming is that it helps me to counter dementia’s degrading of my brain – see the <em>ENDNOTE dementia and programming </em>after this conclusion.</p>\n\n\n\n<p>One thing I would say is please don’t try to help me by sending me random Pull Requests. Even before I had dementia, I found some Pull Requests with no information, and typically no test results, and it takes me time to work out what the PR does and is it useful. The really good improvements come from someone opening an issue or PR with a conversation with me to work out what is the best way to do this &#8211; <a href=\"https://github.com/JonPSmith/EfCore.SchemaCompare/pull/26\">this PR</a> as an example.</p>\n\n\n\n<h2 class=\"wp-block-heading\"><em>ENDNOTE dementia and programming</em></h2>\n\n\n\n<p><em>It was my programming that alerted me that something had changed. Normally I can hold all of parts of the code in my head, and I would instinctively know where to go and what to do, but in 2022 I found I couldn’t hold the code in my head, which was devastating! It took over a year to get the diagnosis of dementia in Alzheimer&#8217;s disease which I got in early 2024. NOTE: Currently there are no known cures for Alzheimer&#8217;s.</em></p>\n\n\n\n<p><em>Once I had the diagnosis there was no one to tell me what this means for me, so I googled “Alzheimer&#8217;s disease” and it wasn’t nice, or useful. Thankfully a friend who is a dementia nurse came over and talked about what is happening to me. They didn’t sugar-coat the future, but they said what will happen and what I could do to slow down my decline. Thankfully my programming changing meant that I caught the dementia early (most people are diagnosed in the middle stage of dementia) so had time to work on things.</em></p>\n\n\n\n<p><em>From my perspective the best suggestion my nurse friend gave me was Cognitive Stimulation Therapy (CST). The core of CST is that you tackle jobs that are hard, but ones you can complete. The typical suggestions to do crossword puzzles, Sudoku, Rubik&#8217;s Cube, etc. I do some of these but for me the best CST work is programming! I had to change my approach to programming to counter the dementia’s symptoms, for instance:</em></p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><em>Because dementia affects my memory I have to use lists of the things to do and tick them off when I have done them (I rarely used worklists before).</em></li>\n\n\n\n<li><em>Because dementia affects problem-solving I must accept that I will be slower when programming. I was very fast before (so my clients said) but now I’m five times slower or more.</em></li>\n\n\n\n<li><em>I also have to handle the frustrations when I can’t do something I could before, or it took longer than before. I have found that trying to something while I’m frustrated will usually fail and I will feel bad. I have to accept my situation and enjoy the things I can do. &nbsp;</em></li>\n</ul>\n\n\n\n<p><em>A concrete example of how this works can been in this article and the many months of thinking, coding, and writing. I starting my cleaning with my biggest library, </em><a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main\"><em>AuthP library</em></a><em>, which has 20 projects including seven example applications. During cleaning the AuthP library I felt I regained some of programming skills that I had before dementia, for instance I started get back a similar feeling that I could hold “the code is in my head” came back. That was a WONDERFUL feeling to see some of damage from dementia could be rolled back.</em></p>\n\n\n\n<p><em>But on the other hand I now do need a worklist to help me manage the whole cleanup and update process, which covers many months. And I had to accept that I’m slower at programming, but the good news I that I CAN still code.</em></p>\n\n\n\n<p><em>While I focused on dementia and programming because my blog is about programming, but I also have lots of other things outside programming, like talking to people to keep my speech up and using apps to make sure I remember things and dates. In fact writing this article is another CST’s “hard, but possible” job, especially as one part of dementia’s symptoms is not remembering words.</em></p>\n\n\n\n<p class=\"has-black-color has-text-color has-link-color wp-elements-8144f0e2feb71c073afe2a9c7cbe12d9\"><em>Thanks for reading this. &nbsp;&nbsp;&nbsp;</em></p>\n",
    "sanitized": "I’m writing this article because I have an illness called dementia, which over time degrades a person’s ability to remember, think, and make decisions. This means at some point I won’t be able to build or update my open-source NuGet libraries, so this article shows you how to update my libraries when I’m not available.\n\n\n\nI detected that something had changed because it affected my programming, in a bad way! This gave me early detection of my dementia, and the ways to overcome some the loss of me programming skills that dementia had taken away. (See the ENDNOTE  dementia and programming section at the end of this article)\n\n\n\nBut my time is limited, so I have focused on making sure that users can still use my libraries before my dementia stops me from updating my libraries myself. Dementia works differently with each person so I won’t know if I can update my libraries to any new .NET, but I’m pretty sure I will be able to update my libraries to .NET 9, but I can’t say for sure on other years.\n\n\n\nThe rest of this article tells you which of my libraries need to be updated when Microsoft creates a new .NET version, e.g. .NET 9. While I have 20 NuGets in nuget.org, only seven of the NuGets use a specific .NET version – the others NuGets use NET Standard which doesn’t change.\n\n\n\n\nNOTE: The approaches I describe in this article for updating my libraries also works on any NuGet libraries that aren’t being updated by their author(s). \n\n\n\n\nTL;DR; – Summary of this article\n\n\n\n\nIn this article I use the following names:Library: I refer to the source code of a library with the name “library”.NuGet: I refer to a library that has been turned into an easy-to-use file referred to as a  NuGet. https://www.nuget.org is one place which holds NuGets. NuGet are normally managed by your development app, e.g. Visual Studio.\n\n.nupkg file: When creating a new NuGet you might have to work with the file ending with  .nupkg. Typically you will have to manually move / push a .nupkg file to code that handles NuGets.\n\n\n\n\n\nMany of my libraries use the NET Standard versions which will work with any supported .NET version . This means that you don’t have to update these libraries. This section covers this.\n\n\n\nThe pros and cons of building libraries that needs a specific .NET version is covers in this section.\n\n\n\nI have seven libraries that use a specific .NET version, e.g. going from .NET 8 to .NET 9 (I call this a “NET-specific library”). These libraries needs to be updated when a new .NET version comes out, and some point I won’t be there to update them. There are two things I have done to make it easier to update:I have made NET-specific libraries easier to update when a new .NET version comes out. This section covers this.\n\nThen I detail how you can Clone the library’s code, update the library to a newer .NET version, and create a NuGet version. This section covers this.\n\n\n\n\n\nAt the end of this article I have a section called ENDNOTE dementia and programming  covering my experience of dementia and programming, both good and bad.\n\n\n\n\n\nNOTE: I use Visual Studio Community to show you how to update a library because that what I use, but I expect other development tools can do this too.\n\n\n\n\nMy libraries that don’t need an update when a new .NET version comes out\n\n\n\nLibraries that only uses NET Standard NuGets don’t have to be updated when new .NET comes out, e.g. NET 9. NET Standard libraries contains a set of fundamental APIs (commonly referred to as base class library or BCL) that all .NET implementations must implement.\n\n\n\nEight of my libraries uses NET Standard and they typically provide a basic specific feature that can be used anywhere. For instance, the NetCore.AutoRegisterDi library can automatically register your services into the Microsoft NET’s Dependency injection provider – this library has the most downloads at 3.1 million and is the smallest library with ~200 lines of code.\n\n\n\nThe table below contains the eight libraries using NET Standard with links to the NuGet, documentation and an article which gives you an overview of each library.\n\n\n\nNuGet NameDocs linkArticle linkNetCore.AutoRegisterDiReadMeArticleGenericServices.StatusGenericReadMeArticleEfCore.GenericBizRunnerWikiArticleNet.RunMethodsSequentiallyReadMeArticleEfCore.GenericServices.AspNetCoreReadMeArticleNet.DistributedFileStoreCacheWikiArticleEfCore.GenericEventRunner and …DomainPartsWikiArticle\n\n\n\nThe rest of this article covers the libraries that works with a specific .NET version, e.g. .NET 9. These libraries are focused on EF Core and ASP.NET Core applications.\n\n\n\nThe pros and cons of using full .NET version NuGets\n\n\n\nMicrosoft releases a new .NET version, e.g. .NET 9, every year. This has allowed Microsoft to add new features and improve performance of .NET applications. These yearly releases have allowed .NET to up to date and very fast. But the downside is if you want to update your application to a new .NET version, then you need to upgrade all the NuGets that uses a NET-specific version, e.g. NET 9.\n\n\n\nSo, if you can’t get every NuGet for the .NET version you are moving to, then your application might not work!\n\n\n\nI have six libraries that uses NET-specific that need updating every year. These libraries are listed below, ordered by the most downloaded version coming first.\n\n\n\nNuGet NameDocsArticleEfCore.TestSupportWikiArticleEfCore.SchemaCompareReadMeArticleEfCore.GenericServicesWikiArticleEfCore.SoftDeleteServicesWikiArticleAuthPermissions.AspNetCore and MultiProjPackWikiArticleNet.LocalizeMessagesAndErrorsWikiArticle\n\n\n\nSometimes an older NET-specific NuGet version, e.g. .NET 8, will work for a new application using a higher .NET release, e.g. .NET 9. It depends on whether the new .NET version changes some part of the code that the older NuGet uses. I think most of my .NET 8 libraries will work with .NET 9 because my libraries typically use the basic features, but you can’t be sure it will work! If you have a lot of tests to check everything will work with the older NuGens, then it’s MUCH quicker.\n\n\n\nI’m assume that most people will want a new NuGet that supports the new .NET version and rest of the rest of the rest of article shows you how to update a library yourself. But first I talk about how I have changed my libraries so that it much easier to update my libraries.\n\n\n\nMaking NET-specific libraries easier to update\n\n\n\nWhen I created NET-specific libraries I usually created a NuGet which supported multiple .NET versions, for instance EfCore.TestSupport version 6.0.2 supports .NET 6, 7 and 8. The upside of supporting multiple .NETs is that if I add a new feature or fix a bug, then I can release one NuGet with the features/bug fixes that covers multiple .NETs.\n\n\n\nBut the downside is that it’s very hard to update to a new .NET release for three reasons:\n\n\n\n\nYou can’t use the Microsoft Visual Studio’s “NuGet Package Manager” features to update a library. Instead you must manually edit all the .csproj files in the library code. I have been doing this for years and it’s a pain to do.\n\n\n\nIt’s harder to find / update NuGets with a vulnerability. I found this when .NET 8 had a vulnerability in the System.Data.SqlClient. I had to go through my libraries to select the non-vulnerable replacement, including effected NuGets. You also can’t use the GitHub’s useful dependabot PRs to fix vulnerability, but you must manually edit the .csproj files.\n\n\n\nI found it’s harder to find depreciated NuGets because sometimes a NuGet is valid in an older .NET version but is depreciated in the latest .NET version.\n\n\n\n\nTo make it easier for me, and you, I changed all my NET-specific libraries to only support one .NET version and fix any vulnerability and removed depreciated NuGets. I applied this to all of my NET-specific libraries and I released new versions of my NET-specific libraries that only support .NET 8.\n\n\n\n\n\nNOTE: If you are still using .NET version below .NET 8, then the older versions of my libraries are still there for you.\n\n\n\nAfter making my NET-specific libraries simpler to update and cleaner, then the next part shows you how to create a new version of these NuGets if the author (e.g. me!) can’t update the library when another .NET is released.\n\n\n\nHow to upgrade a NET-specific library to a new .NET version\n\n\n\nThis (long) section shows how you update a library that hasn’t been updated and the author(s) hasn’t updated to the new .NET version. I only assume you have access to the library’s code, e.g. GitHub, and you have a development application that can edit, compile and test the library’s code, e.g.  Visual Studio.\n\n\n\nThe steps are:\n\n\n\n1a. Get the NuGet’s code into your development app\n\n\n\n1b. Update the .NET TargetFramework of the library\n\n\n\n1c. Update the NuGets\n\n\n\n1d. Compile the changed code\n\n\n\n1e. Run the unit tests\n\n\n\n1f. Update the NuGets information\n\n\n\n1g. Create a local .nupkg file\n\n\n\n1h. Add a local NuGet source to your application\n\n\n\n1a. Get the NuGet’s code into your development app\n\n\n\nNowadays most Microsoft open-source libraries can be found in GitHub, and that’s where my libraries are situated. You usually can find the NuGet’s source code by looking the NuGet via www.nuget.org and clicking the “Source repository” link found on the RHS. Then you need to “Clone” the source code into your Visual Studio app.\n\n\n\nOnce you have cloned the library, I suggest you compile and run any unit tests before you change anything. This will let you know if something isn’t working, e.g. the unit tests need the database connection string changed to match your setup and give you a set of unit test results to compare with the unit test after you have updated to a new .NET version. See section ??LINK?? if your tests use databases.\n\n\n\n1b. Update the .NET TargetFramework of the library\n\n\n\nEach CS project contains a file ending in .csproj which holds the version or versions that the project can work with. Because I have tidied-up libraries to only have one version, e.g., .NET 8, which means it’s very easy to change – you just have to update the <TargetFramework> line from the old .NET to the new .NET. This is simple to do via Visual Studio’s “Find and Replace>Place in Files” feature, the screenshot below shows how to change a library using .NET 8 to .NET 9.\n\n\n\n\n\n\n\nOnce you have clicked the “Replace All” button then each project will be updated to the new .NET version. At this point Visual Studio will show an error (see screenshot below) because Visual Studio can’t handle this change automatically. Clicking the “Reload projects” normally fixes this, but in some cases I had to close Visual Studio and reopen the library again remove the errors.\n\n\n\n\n\n\n\n1c. Update the NuGets\n\n\n\nAfter the library has been updated to the new .NET, then you need to update all the NuGets in every project in the library. The simplest way to update all the projects’ NuGets is to use Visual Studio’s “Manage NuGets Packages” feature which is found by right-clicking the top “Solution” found in Solution Explorer window. The screenshot below shows the Manage NuGets Packages in Update mode  (Note: the screenshot was taken before .NET 9 was released so I turned on “prerelease”, but normally you would have “prerelease” turned off).\n\n\n\n\n\n\n\n\n\n\n\nThe obvious way to update all the NuGets in the library is to select the “Updates” button and tick the “Select all packages” to select all the NuGets to be updated to the latest version. This is it quick and it works, but it’s worth checking that you are using the lowest valid versions of the NuGets in the library – typically the lowest valid version that ends with “0.0”, e.g. 9.0.0. Having higher versions, e.g. 9.0.1, can cause problems if your application has the same NuGet at a lower version (i.e. 9.0.0) but of the same NuGet in the library has. In this case it will show an error saying that NuGet SomeName needs a >= 9.0.1, but your app is using SomeName 9.0.0.\n\n\n\nThere are a couple of my libraries that have specific versions for some of its NuGets:\n\n\n\n\nEfCore.TestSupport: When updating my EfCore.TestSupport library you don’t want the highest versions of the xunit.core and xunit.assert NuGets. Thats because when Visual Studio creates a xUnit Test Project it doesn’t use the latest xunit versions. I suggest you create a xUnit Test Project via Visual Studio and find the xunit version it uses, then use the same version  in EfCore.TestSupport xunit.core and xunit.assert NuGets.\n\n\n\nAuthPermissions.AspNetCore: the AuthP library uses Microsoft.Graph version 4, not version 5. Therefore you should select Microsoft.Graph 4.54.0, and NOT the latest 5.?.? versions.\n\n\n\n\nAlso, you should look for vulnerable NuGets and select a non-vulnerable versions instead. Vulnerable NuGet packages are .NET packages with security weaknesses that can be exploited by attackers. Most vulnerable NuGets are normally are accidental flaws. Visual Studio has a “show only vulnerable” item in the Process > Manage NuGet Packages – the screenshot below shows how to find vulnerable NuGets.\n\n\n\n\n\n\n\n1d. Compile the changed code\n\n\n\nOnce you have changed the library’s .NET version (step 1b) and updated the NuGets (step 1c) then you are ready to compile the code. I recommend you use the Build>Rebuild Solution to compile the code because changing the version and NuGets have a lot of effects.\n\n\n\nNormally the code compiles OK, but in some very rare cases the compile fails. In this case it’s likely that the new .NET version has changed, moved (e.g. changing the method’s name) or removed some code features. In this case you need to see what the problems are and decide what to do about it.\n\n\n\nNOTE: In my EfCore.TestSupport library I added a feature called EnsureClean which was faster, but used code that is not supported by Microsoft. In NET 9 version I changes the EnsureClean to use EnsureDeleted / EnsureCreated. It slower but works ever time.\n\n\n\n1e. Run the unit tests\n\n\n\nAll of my NET-specific  libraries have a Test project which uses my EfCore.TestSupport library to test the library. You are looking for every test to be passed, but in some cases I have a failing test to say that a feature that doesn’t work (EfCore.SchemaCompare has one of those). That way I suggested you ran the unit tests on the original library in step 1a because you it will show you what a good run looks like.\n\n\n\n\nNOTE: My EfCore.TestSupport library allows you set up a SQLite in-memory database, and a way to set SqlServer and PostgreSQL connections strings – see this documentation on how this.\n\n\n\n\n1f. Update the NuGets information\n\n\n\nTo define a NuGet there lots of values you need to provide to create a valid NuGet. For most of my libraries there is one project file (.csproj) in the code that contains the setting to create a NuGet file. For instance the EfCore.TestSupport NuGet has the NuGet information in the TestSupport.csproj file. So before you compile the library you need to update three values to create a new version, as shown below.\n\n\n\nNameExample valuesNotesPackageVersion and Version9.0.0Must be unique on your computerPackageReleaseNotesUpdated to .NET 9 \n\n\n\nIn the case of the AuthP library, which has multiple projects going into a NuGet, I had to create a dotnet tool called JonPSmith.MultiProjPack, found in nuget.org. This used a file called MultiProjPack.xml in the AuthP and the values you need to change are:\n\n\n\nNameExample valuesNotesversion9.0.0Must be unique on your computerreleaseNotesUpdated to .NET 9 \n\n\n\n1g. Create a local .nupkg file\n\n\n\nAll my libraries, apart from AuthP, are designed create a NuGet .nupkg file on every compile. You want to be in “Release” mode when compiling to create a NuGet because it will create a smaller and faster NuGet file (“Debug” NuGets are useful if you want to see debug information from the NuGet).\n\n\n\nOn compile in “Release” mode the NuGet file will be created in:\n\n\n\n…<SolutionName>\\<PrimaryProjectName>\\bin\\Release\\<NuGetName>. nupkg\n\n\n\nAnd here is a real example of my EfCore.TestSupport NuGet:\n\n\n\n…\\EfCore.TestSupport\\TestSupport\\bin\\Release\\EfCore.TestSupport.8.0.1.nupkg\n\n\n\nIn the case of the AuthP library, which has multiple projects to create the NuGet, I created a dotnet tool called JonPSmith.MultiProjPack to create the .nupkg file. The “How to create an AuthPermissions.AspNetCore NuGet package” in the AuthP’s ReadMe file shows how to install and run this dotnet tool.\n\n\n\n\n\nNOTE: You can read about why I create the JonPSmith.MultiProjPack dotnet tool in the ReadMe of the code.\n\n\n\n\n\nTIP: I recommend using the NuGet Package Explorer app to check that the NuGet Package you just created has the settings / information that you was expecting.\n\n\n\n1h. Add a local NuGet .nupkg file source to your application\n\n\n\nThe previous step created the NuGet .nupkg file, but to use this file you need to setup Visual Studio’s  NuGet Package Manager to handle local .nupkg files. Typically you would get NuGets via the https://www.nuget.org app, but Visual Studio’s NuGet Package Manager has a way to find NuGet from a directory on your development computer.\n\n\n\nTo use this “local NuGets” feature you need to:\n\n\n\n\nCreate a directory to hold the local NuGets. My local NuGet directory is called “LocalNuGet” in my user account, i.e. C:\\Users\\JonPSmith\\LocalNuGet.\n\n\n\nThen you manually copy the new .nupkg file in the Project > bin > Release directory to your local NuGet directory you set up in the last step.\n\n\n\nYou need go into the Options>NuGet Package Manager>Package Sources and add a new source where source is a directory on your development computer – see the screenshot below.\n\n\n\n\n\n\n\n\nAfter that you can click on the “Package source” and select the “Local NuGet” you can access to the local NuGet(s) you updated. That allows you to update your application’s NuGets using the normal NuGets via https://www.nuget.org and local NuGets you created yourself on your local computer.\n\n\n\n\nNOTE: In the case of the AuthP library, the MultiProjPack dotnet tool automatically copies the new NuGet to the “{USERPROFILE}\\LocalNuGet” directory.\n\n\n\n\nConclusion\n\n\n\nIt would be great if all the NET-specific NuGets you use are always updated when a new .NET version comes out, but sometimes they aren’t. That usually means the author(s) should update a NET-specific NuGet and then add it into the https://www.nuget.org application. But in my case, I know that some time I won’t be able update my libraries, which would be a pity for people who use my libraries.\n\n\n\nI hoped I’ll be able to still do programming for years, but when .NET 10 came out my dementia had taken my ability to do understand how to update my .NET apps. That’s why I created this article now while I’m doing well so that you‘re covered if I’m not around. The other reason for me to keep programming is that it helps me to counter dementia’s degrading of my brain – see the ENDNOTE dementia and programming after this conclusion.\n\n\n\nOne thing I would say is please don’t try to help me by sending me random Pull Requests. Even before I had dementia, I found some Pull Requests with no information, and typically no test results, and it takes me time to work out what the PR does and is it useful. The really good improvements come from someone opening an issue or PR with a conversation with me to work out what is the best way to do this – this PR as an example.\n\n\n\nENDNOTE dementia and programming\n\n\n\nIt was my programming that alerted me that something had changed. Normally I can hold all of parts of the code in my head, and I would instinctively know where to go and what to do, but in 2022 I found I couldn’t hold the code in my head, which was devastating! It took over a year to get the diagnosis of dementia in Alzheimer’s disease which I got in early 2024. NOTE: Currently there are no known cures for Alzheimer’s.\n\n\n\nOnce I had the diagnosis there was no one to tell me what this means for me, so I googled “Alzheimer’s disease” and it wasn’t nice, or useful. Thankfully a friend who is a dementia nurse came over and talked about what is happening to me. They didn’t sugar-coat the future, but they said what will happen and what I could do to slow down my decline. Thankfully my programming changing meant that I caught the dementia early (most people are diagnosed in the middle stage of dementia) so had time to work on things.\n\n\n\nFrom my perspective the best suggestion my nurse friend gave me was Cognitive Stimulation Therapy (CST). The core of CST is that you tackle jobs that are hard, but ones you can complete. The typical suggestions to do crossword puzzles, Sudoku, Rubik’s Cube, etc. I do some of these but for me the best CST work is programming! I had to change my approach to programming to counter the dementia’s symptoms, for instance:\n\n\n\n\nBecause dementia affects my memory I have to use lists of the things to do and tick them off when I have done them (I rarely used worklists before).\n\n\n\nBecause dementia affects problem-solving I must accept that I will be slower when programming. I was very fast before (so my clients said) but now I’m five times slower or more.\n\n\n\nI also have to handle the frustrations when I can’t do something I could before, or it took longer than before. I have found that trying to something while I’m frustrated will usually fail and I will feel bad. I have to accept my situation and enjoy the things I can do.  \n\n\n\n\nA concrete example of how this works can been in this article and the many months of thinking, coding, and writing. I starting my cleaning with my biggest library, AuthP library, which has 20 projects including seven example applications. During cleaning the AuthP library I felt I regained some of programming skills that I had before dementia, for instance I started get back a similar feeling that I could hold “the code is in my head” came back. That was a WONDERFUL feeling to see some of damage from dementia could be rolled back.\n\n\n\nBut on the other hand I now do need a worklist to help me manage the whole cleanup and update process, which covers many months. And I had to accept that I’m slower at programming, but the good news I that I CAN still code.\n\n\n\nWhile I focused on dementia and programming because my blog is about programming, but I also have lots of other things outside programming, like talking to people to keep my speech up and using apps to make sure I remember things and dates. In fact writing this article is another CST’s “hard, but possible” job, especially as one part of dementia’s symptoms is not remembering words.\n\n\n\nThanks for reading this."
  },
  {
    "itemId": "https://www.thereformedprogrammer.net/?p=2917",
    "raw": "\n<p>This article focuses on the <a href=\"https://en.wikipedia.org/wiki/Shard_(database_architecture)\">sharding approach</a> of building a .NET multi-tenant application using the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore\">AuthPermissions.AspNetCore</a> library (shortened to <em>AuthP</em>). After working exclusively on a sharding-only multi-tenant application I found various issues that make building and using such an application is difficult. This article describes the issues I found and the changes I made to the AuthP’s 6 release to improve sharding multi-tenant application.</p>\n\n\n\n<p>This article is part of the series that covers AuthP’s multi-tenant applications in general. The other articles in “Building ASP.NET Core and EF Core multi-tenant apps” series are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\" start=\"1\">\n<li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part1-the-database/\">The database: Using a DataKey to only show data for users in their tenant</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part2-administration/\">Administration: different ways to add and control tenants and users</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/multi-tenant-apps-with-different-versions-can-increase-your-profits/\">Versioning your app: Creating different versions to maximise your profits</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-hierarchical-multi-tenant-apps/\">Hierarchical multi-tenant: Handling tenants that have sub-tenants</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/advanced-techniques-around-asp-net-core-users-and-their-claims/\">Advanced techniques around ASP.NET Core Users and their claims</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/part6-using-sharding-to-build-multi-tenant-apps-using-asp-net-core-and-ef-core/\">Using sharding to build multi-tenant apps using EF Core and ASP.NET Core</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/three-ways-to-securely-add-new-users-to-an-application-using-the-authp-library/\">Three ways to securely add new users to an application using the AuthP library</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/how-to-take-an-asp-net-core-web-site-down-for-maintenance/\">How to take an ASP.NET Core web site “Down for maintenance”</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/asp-net-core-three-ways-to-refresh-the-claims-of-a-logged-in-user/\">Three ways to refresh the claims of a logged-in user</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/using-custom-databases-with-the-authp-library-part1-normal-apps/\">Use custom databases with the AuthP library – Part1: normal apps</a></li>\n\n\n\n<li>Making .NET sharding multi-tenant apps easier to use with AuthP 5.1 (<strong>this article</strong>)</li>\n\n\n\n<li>Use custom databases with the AuthP library – Part2: sharding / hybrid apps (coming soon)</li>\n</ol>\n\n\n\n<h2 class=\"wp-block-heading\">TL;DR; – Summary of this article</h2>\n\n\n\n<ul class=\"wp-block-list\">\n<li>This article is about a sharding multi-tenant application. AuthP has two types of sharding:<ul><li>Hybrid, which supports tenants that share a database with other users and tenants that have their own database, which I refer to <em>Sharding-only</em>.</li></ul>\n<ul class=\"wp-block-list\">\n<li>Sharding-only, where every tenant have their own database.</li>\n</ul>\n</li>\n\n\n\n<li>Part 1 covers two types of multi-tenant applications: one where admin is done by the app-maker and one where specific user(s) in a tenants handle the admin of their tenant.</li>\n\n\n\n<li>Part 2 describes the changes the AuthP’s sharding-only multi-tenant application, which are<ul><li>Allow certain features to work, e.g. the “<a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part2-administration/#1-automate-the-creation-of-a-new-tenant\">Sign up now</a>” feature</li></ul><ul><li>To improve the administration of a sharding-only multi-tenant application.</li></ul>\n<ul class=\"wp-block-list\">\n<li>Add a service to make creating / removing sharding-only tenants easier in code and human time.</li>\n</ul>\n</li>\n\n\n\n<li>Part 3 covers how you can use the new features in AuthP version 6. They are<ul><li>Where does each tenant’s data is stored when using AuthP’s sharding?</li></ul><ul><li>A service that makes it simpler to create / delete a sharding-only tenant.</li></ul>\n<ul class=\"wp-block-list\">\n<li>How the AuthP’s 6 “Sign up now” feature handles sharding-only tenants.</li>\n</ul>\n</li>\n\n\n\n<li>At the end of this article it provides links to relevant documentation, the file containing steps to update an sharding multi-tenant using an older version, and a new example app.</li>\n</ul>\n\n\n\n<h2 class=\"wp-block-heading\">Part 1: Two types of multi-tenant applications</h2>\n\n\n\n<p>Recently I have been working on the multi-tenant features in the AuthP’s library, and I started to see that there are different <em>types</em> of multi-tenant applications. This insight came while building a new sharding-only app and it helped me to see areas where I need to improve the AuthP’s sharding futures. The two main types of multi-tenant are based on who is in administration of users and tenants – see the description of two types below.</p>\n\n\n\n<h3 class=\"wp-block-heading\">1. Multi-tenant app controlled by the app-maker</h3>\n\n\n\n<p>This type of multi-tenant app is controlled by the organisation who owns the app. Normally there is some form of admin team (which I refer to as the <em>app admin</em>) in the organisation who manages the users and its data. Some examples of this type of multi-tenant apps are:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>A bank app allowing its users to manage their bank accounts.</li>\n\n\n\n<li>An in-house app that controls the inventory in the organisation.</li>\n</ul>\n\n\n\n<p>The pro of this style is they have good control over who can access the app, but the downside is you need an admin team to manage the users, tenants etc., e.g. add / remove users, changing what they can do, etc.</p>\n\n\n\n<h3 class=\"wp-block-heading\">2. Multi-tenant app controlled by tenant user</h3>\n\n\n\n<p>This type of multi-tenant app move much of the admin features out to a tenant user. The AuthP has the concept of a<em> tenant admin</em> allow a user to <a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part2-administration/#1-automate-the-creation-of-a-new-tenant\">create their own tenant</a> for their organisation (normally with a payment) and then manage the users in their tenant, such as <a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part2-administration/#2-have-the-admin-user-invite-a-new-user-to-join-a-tenant\">adding new users</a>, controlling what they can do, etc. Some examples of this type of multi-tenant apps are:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><a href=\"https://github.com/\">GitHub</a>, which allows users to create their own space and manage.</li>\n\n\n\n<li><a href=\"https://about.meta.com/\">Facebook / Meta</a>,&nbsp; where you post comments, share photos and have friends.</li>\n</ul>\n\n\n\n<p>The pros of this style is that the tenant user can quickly makes changes and its reduces the size of the app admin team you need for to support your multi-tenant application. The downside is the multi-tenant administration code is more complex , but AuthP has built-in solutions to most of these admin features.</p>\n\n\n\n<p><em>NOTE: I was asked to design a large multi-tenant application for a client, and I personally know that there is a LOT of admin code. Also, the app admin team were very busy when a large organisation joined their multi-tenant application. This is why I put a lot of work on the tenant admin features to reduce the amount of work the app admin team must deal with.</em></p>\n\n\n\n<p>The AuthP library supports both multi-tenant types, but you will read how I needed to improve the AuthP’s features for sharding-only databases.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Part 2: The problems I found and what I did to improve sharding features</h2>\n\n\n\n<p>The AuthP’s implementation of sharding uses a “sharding entry” approach that links a tenant to a database. The diagram below the implementation of two types:&nbsp; “controlled by the app-maker” and the “controlled by tenant users”.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/TwoWaysToSetupSharding.png\"><img loading=\"lazy\" decoding=\"async\" width=\"721\" height=\"420\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/TwoWaysToSetupSharding.png\" alt=\"\" class=\"wp-image-2902\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/TwoWaysToSetupSharding.png 721w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/TwoWaysToSetupSharding-300x175.png 300w\" sizes=\"auto, (max-width: 721px) 100vw, 721px\" /></a></figure>\n\n\n\n<p>What I found that both types could be improved, but the “controlled by tenants” had one feature didn’t work as it should, and admin code weren’t that easy to use, especially around creating / deleting sharding-only tenants. Part 2 (below) will cover the problems and how I solve them.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Part 2: The problems I found and what I did to solve them</h2>\n\n\n\n<p>The list below details the various problems and what I did about it&nbsp;</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>The “<a href=\"https://www.thereformedprogrammer.net/multi-tenant-apps-with-different-versions-can-increase-your-profits/\">Sign up for a new tenant</a>” feature doesn’t handle sharding tenants</li>\n\n\n\n<li>Solved a limitation in ASP.Net Core’s IOptions feature (breaking changes)</li>\n\n\n\n<li>Add a service to make creating / removing sharding-only tenants.</li>\n</ol>\n\n\n\n<h3 class=\"wp-block-heading\">2.1. The “<a href=\"https://www.thereformedprogrammer.net/multi-tenant-apps-with-different-versions-can-increase-your-profits/\">Sign up for a new tenant</a>” feature doesn’t handle sharding-only tenants</h3>\n\n\n\n<p>The AuthP’s “Sign up for a new tenant” feature allows to a user to create a new tenant, which can significantly reduce the amount of work for your admin people. However the version 5.0.0 of the “Sign up” feature doesn’t contain code to setup a new sharding entry in a sharding-only tenant.</p>\n\n\n\n<p>But it was then that is hit a limitation of the ASP.Net Core’s IOptions features &#8211; see the next section below what the problem is and how I got around it.</p>\n\n\n\n<h3 class=\"wp-block-heading\">2.2. Solved a limitation in ASP.Net Core’s IOptions feature (<strong>breaking changes</strong>)</h3>\n\n\n\n<p>The current sharding entries are held in a json file and accessed via <a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options\">ASP.NET Core’s IOptions feature</a> (similar to how ASP.NET Core uses a appsetting.json file). What I found was that the I added a new sharding entry to a json file the IOptionsMonitor won’t see the changes until a new HTTP request starts – I assume it looked for updates at the end of every HTTP request. This causes me a problem as there are cases where a new sharding entry is added and another service needs to retrieve sharding entry within the same HTTP request.</p>\n\n\n\n<p>There are a few ways to get around this, but in the end I changed to using my <a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache\">Net.DistributedFileStoreCache</a> library (shortened to <a><em>FileStoreCache</em></a>) &nbsp;that uses the FileSystemWatcher and updates are immediately updated. The upside of using the FileStoreCache is has a similar very fast (~25ns) read-time that the IOptions approach had. The downside is this change creates a <a href=\"https://en.wiktionary.org/wiki/breaking_change\">breaking change</a> to applications that have been created to older versions of AuthP. &nbsp;</p>\n\n\n\n<p><em>NOTE: I have created a detail list of the changes in the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/UpdateToVersion6.md\">UpdateToVersion6</a> file and a console application to help with update your app’s sharding entries to the AuthP 6 format.</em></p>\n\n\n\n<h3 class=\"wp-block-heading\">2.3. Add a service to make creating / removing sharding-only tenants</h3>\n\n\n\n<p>When you are adding a new sharding-only tenant there are four steps:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>Add a sharding entry to define the new database that the tenant will use.</li>\n\n\n\n<li>Create the tenant using AuthP’s AuthTenantAdminService which will&#8230;</li>\n\n\n\n<li>Run your <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions/AdminCode/ITenantChangeService.cs\">ITenantChangeService</a> code to set up the database.</li>\n</ol>\n\n\n\n<p>…And if you are using a cloud database service, then you need create a new database.</p>\n\n\n\n<p><em>NOTE: If you need to create / delete cloud database, then you can do that withing your implementation of the ITenantChangeService – create your cloud database in the create tenant method and delete your cloud database in the delete tenant method.</em></p>\n\n\n\n<p>You could do this yourself with the AuthP’s version 5 in two manual steps, but in AuthP version 6 there is a new service called <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.AspNetCore/ShardingServices/IShardingOnlyTenantAddRemove.cs\">IShardingOnlyTenantAddRemove</a> which runs the three steps for creating and removing a tenant. This service makes it easier, and clearer, for an admin person to add or remove sharding-only tenants.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Part 3 – How you can use these new features</h2>\n\n\n\n<p>So, having told you what has changed in AuthP version 6 let’s see how you would use these updated features. I will cover the following topics, and I will point out the things that have changed</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>Where does each tenant’s data is stored when using AuthP’s sharding?</li>\n\n\n\n<li>A service that makes it simpler to create / delete a sharding-only tenant</li>\n\n\n\n<li>How the AuthP’s 6 “<a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part2-administration/#1-automate-the-creation-of-a-new-tenant\">Sign up now</a>” feature handles sharding-only tenants</li>\n</ol>\n\n\n\n<h3 class=\"wp-block-heading\">3.1 Where does each tenant’s data is stored when using AuthP’s sharding?</h3>\n\n\n\n<p>A multi-tenant application provided a service for an organization / person finds useful, but instead of deploying a single web app / database for each tenant they have one web app and they segregate each tenant’s data. In AuthP provides three ways to segregate the tenant’s data, as shown in the table below.</p>\n\n\n\n<figure class=\"wp-block-table\"><table><tbody><tr><td><strong>Types</strong></td><td><strong>Description</strong></td><td><strong>How filter only tenant’s data?</strong></td></tr><tr><td>1. One database</td><td>All the tenant’s data in one database</td><td>Filter data be unique key</td></tr><tr><td>2. Hybrid</td><td>Some tenants have their own database, and some tenants share a database</td><td>Select the correct database<br>Filter data be unique key</td></tr><tr><td><strong>3. Sharding-Only</strong></td><td><strong>Each tenant has their own database for data</strong></td><td><strong>Select the correct database</strong></td></tr></tbody></table></figure>\n\n\n\n<p>Since AuthP version 3&nbsp; supports all these ways to separate each tenant’s data, but when I ran a <a href=\"https://twitter.com/thereformedprog/status/1682052862568808448\">twitter poll</a> on what type of approach they wanted the “Tenants have their own db” (4. In the diagram above) won by a large margin. That why this article (and the new release of the AuthP library) is all about.</p>\n\n\n\n<p>AuthP version 3 defined a way that a tenant can be linked to a database. That database may have data from many tenants in it (shared) or a database has only one tenant’s data (shared-only). In this article we are mainly looking sharding, and in particular at the “Select the correct database” part, which applies to both hybrid and sharding-only approaches. The diagram shows the four stages that sets up the tenant’s data DbContext to the specific database for tenant that the logged-in user is linked to.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/ShardingSettingsSteps2.png\"><img loading=\"lazy\" decoding=\"async\" width=\"1003\" height=\"754\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/ShardingSettingsSteps2.png\" alt=\"\" class=\"wp-image-2903\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/ShardingSettingsSteps2.png 1003w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/ShardingSettingsSteps2-300x226.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/ShardingSettingsSteps2-768x577.png 768w\" sizes=\"auto, (max-width: 1003px) 100vw, 1003px\" /></a></figure>\n\n\n\n<p>AuthP version 6 stills these four steps, but it had to change the service that implements stage 2 was changed due the limitation in the ASP.NET Core IOptionsMonitor features. This created **<strong>breaking changes**</strong> in the version 6 release and I created <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/UpdateToVersion6.md\">UpdateToVersion6.md</a> file which shows how to update your existing sharding multi-tenant built using a previous release of the AuthP library.</p>\n\n\n\n<p><em>NOTE: When fixing the ASP.NET Core IOptionsMonitor limitation I also found the existing code rather hard to understand, partly because of the code being complex and partly because the names of some of the classes and methods didn’t really say what they were doing. Therefore I wanted to make the code easier to understand, but this created more breaking changes. Thankfully these changes are obvious i.e. there will be a compile error as the name have changed.</em></p>\n\n\n\n<h3 class=\"wp-block-heading\">3.2. A service that makes it simpler to create / delete a sharding-only tenant</h3>\n\n\n\n<p>Section 1.3 talks about a new service called <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.AspNetCore/ShardingServices/IShardingOnlyTenantAddRemove.cs\">IShardingOnlyTenantAddRemove</a> that combines the creation of the tenant and its sharding entry at the same time. This service means that the admin user only has one page to fill in and the code sets up the rest. The service does the following:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>Gathers the information to create the tenant and sharding entry needed:<ul><li>Tenant name – from the admin user</li></ul><ul><li>The connection string holding the database server (code or human – see diagram below)</li></ul>\n<ul class=\"wp-block-list\">\n<li>Set the database provider used to create the tenant database (e.g. SqlServer) is set by your code</li>\n</ul>\n</li>\n\n\n\n<li>Then, after various checks, it creates the sharding entry and Tenant in one go.</li>\n</ul>\n\n\n\n<p>The diagram below shows two web pages that the app admin user (think “controlled by app-maker” type) to create a new tenant on one go. The two pages show the two types of app: left is where the application has a single database server while on the right is for applications needing multiple database servers.</p>\n\n\n\n<p><em>NOTE: The <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/Example7.MvcWebApp.ShardingOnly/Controllers/TenantController.cs\">Example7’s TenantController</a> in the AuthP repo has an example of the multiple database servers option.</em></p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/TwoWaysToCreateTenant.png\"><img loading=\"lazy\" decoding=\"async\" width=\"839\" height=\"518\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/TwoWaysToCreateTenant.png\" alt=\"\" class=\"wp-image-2904\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/TwoWaysToCreateTenant.png 839w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/TwoWaysToCreateTenant-300x185.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/TwoWaysToCreateTenant-768x474.png 768w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/TwoWaysToCreateTenant-825x510.png 825w\" sizes=\"auto, (max-width: 839px) 100vw, 839px\" /></a></figure>\n\n\n\n<p><em>NOTE: AuthP’s sharding muti-tenant feature uses connections strings to define the database server, authentication, and other options, but AuthP will add the name of the database. That’s why the  multiple database servers option above uses the name “Servers” for the connection strings names.</em></p>\n\n\n\n<p>The service has a companion class called <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.AspNetCore/ShardingServices/ShardingOnlyTenantAddDto.cs\">ShardingOnlyTenantAddDto</a> which makes setting up of the data very simple. In fact the code below will work for both create tenant options as it detects if you only have one valid connection string and sets the ConnectionStringName automatically.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic IActionResult Create(&#x5B;FromServices] \n    IGetSetShardingEntries shardingService)\n{\n    var dto = new ShardingOnlyTenantAddDto\n    {\n        DbProviderShortName = AuthPDatabaseTypes.SqlServer.ToString()\n    };\n    dto.SetConnectionStringNames(\n        shardingService.GetConnectionStringNames());\n    return View(dto);\n}\n</pre></div>\n\n\n<p><em>NOTE: The name of the database and the sharding entry is created by the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.AspNetCore/ShardingServices/ShardingOnlyTenantAddDto.cs\">ShardingOnlyTenantAddDto</a>’s FormDatabaseInformation method which uses time as the database name, e.g. 20230808101149-892. If you want to use the tenant name then the FormDatabaseInformation method can be overridden by you.</em></p>\n\n\n\n<h3 class=\"wp-block-heading\">3.3 How the AuthP’s 6 “<a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part2-administration/#1-automate-the-creation-of-a-new-tenant\">Sign up now</a>” feature handles sharding-only tenants</h3>\n\n\n\n<p>Earlier I said that the IOptionsMonitor limitation made it impossible to use the “Sign up now” feature to create a new sharding-only tenant (think “controlled by tenant user” type). Once the IOptionsMonitor limitation was overcome it wasn’t that hard to create a service that handles the tenant and its sharding entry.</p>\n\n\n\n<p>The AuthP repo contains a <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DemoShardOnlyGetDatabaseForNewTenant.cs\">DemoShardOnlyGetDatabaseForNewTenant</a> which handles sharding-only tenant and the required sharding entry. The Example7 app in the repo has the “Sign up now” and uses the DemoShardOnlyGetDatabaseForNewTenant. The screenshot below shows this working – note that allows the user to decide where they wanted their data located.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/SignUpNowShardinOnly.png\"><img loading=\"lazy\" decoding=\"async\" width=\"476\" height=\"365\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/SignUpNowShardinOnly.png\" alt=\"\" class=\"wp-image-2905\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/SignUpNowShardinOnly.png 476w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/08/SignUpNowShardinOnly-300x230.png 300w\" sizes=\"auto, (max-width: 476px) 100vw, 476px\" /></a></figure>\n\n\n\n<h2 class=\"wp-block-heading\">Lots of new / updated documentation for AuthP version 6</h2>\n\n\n\n<p>When I came back to programming after 21-year break (I went to the dark side, e.g. I was a manager) I picked Microsoft because their documentation was so good. Therefore I know that documentation is (nearly) as important as the code.</p>\n\n\n\n<p>So, with the release of version 6 of the AuthP I have added / updated the documentation about sharding. Here is a list.</p>\n\n\n\n<figure class=\"wp-block-table\"><table><tbody><tr><td>Document</td><td>What about</td></tr><tr><td><a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Multi-tenant-explained\">Multi-tenant explained</a></td><td>Start here if new to AuthP</td></tr><tr><td><a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Sharding-explained\">Sharding explained</a></td><td>Describes two sharding modes, new</td></tr><tr><td><a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/How-AuthP-handles-sharding\">How AuthP handles sharding</a></td><td>Describes internal code, new</td></tr><tr><td><a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Configuring-sharding\">Configuring sharding</a></td><td>How to setup sharding app, new</td></tr><tr><td><a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Extra-help-for-shading-only-apps\">Extra help for shading‐only apps</a></td><td>Docs on new features, new</td></tr><tr><td><a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Managing-sharding-databases\">Managing sharding databases</a></td><td>Showing / changing tenants, updated</td></tr><tr><td><a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/UpdateToVersion6.md\">UpdateToVersion6</a></td><td>How to update app to AuthP 6</td></tr></tbody></table></figure>\n\n\n\n<p>The documents give you the overview of what to do, but I also take the time to add comments on all the code. That’s because sometimes it easier read the code to really what it does.</p>\n\n\n\n<p>Also, the AuthP’s repo now has new example called <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example7.MvcWebApp.ShardingOnly\">Example7</a> which implements a sharding-only multi-tenant application. The Example7 app uses all the new / updated features included in the new AuthP version 6 release.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Conclusion</h2>\n\n\n\n<p>When I started to look at improving Auth’s sharding-only tenant I kept finding things more and more issues and I wasn’t sure it was worth doing the update, so I did a <a href=\"https://twitter.com/thereformedprog/status/1682052862568808448\">twitter poll</a> to find out what the users of the AuthP wanted. That poll clearly shows that developers preferred the sharding-only approach nearly twice more than a shared database approach. This feedback made my spend more time to make sharding-only really well.</p>\n\n\n\n<p>I’m very happy about the AuthP version 6 update because it fixed the limitations in sharding-only multi-tenant applications and improved the admin of creating / deleting tenants. The only problem is that AuthP version 6 contains the <strong><em>breaking changes</em></strong>, which that means you have alter your the sharding multi-tenant application when update to AuthP version 6 – see <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/UpdateToVersion6.md\">UpdateToVersion6</a> for the details.</p>\n\n\n\n<p>There was always going to be some breaking changes, but I found my previous sharding code was hard to understand so I tided up that code at the same time. This adds extra breaking changes, but it turned out to fairly simple. For instance the update of the Example6 (hybrid multi-tenant) from version 5 to version 6 wasn’t hard – usually it was just changing the names of the services and methods, with the complex changed only in the internal code.</p>\n\n\n\n<p>I hope AuthP’s user’s will find version 6 helps them, or anyone building a sharding-only multi-tenant application can gets some ideas for their project. Do give me feedback on version 6 and I am happy to answer your questions via the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/issues\">AuthP ‘s GitHub issues pages</a>.</p>\n\n\n\n<p>Happy coding.</p>\n",
    "sanitized": "This article focuses on the sharding approach of building a .NET multi-tenant application using the AuthPermissions.AspNetCore library (shortened to AuthP). After working exclusively on a sharding-only multi-tenant application I found various issues that make building and using such an application is difficult. This article describes the issues I found and the changes I made to the AuthP’s 6 release to improve sharding multi-tenant application.\n\n\n\nThis article is part of the series that covers AuthP’s multi-tenant applications in general. The other articles in “Building ASP.NET Core and EF Core multi-tenant apps” series are:\n\n\n\n\nThe database: Using a DataKey to only show data for users in their tenant\n\n\n\nAdministration: different ways to add and control tenants and users\n\n\n\nVersioning your app: Creating different versions to maximise your profits\n\n\n\nHierarchical multi-tenant: Handling tenants that have sub-tenants\n\n\n\nAdvanced techniques around ASP.NET Core Users and their claims\n\n\n\nUsing sharding to build multi-tenant apps using EF Core and ASP.NET Core\n\n\n\nThree ways to securely add new users to an application using the AuthP library\n\n\n\nHow to take an ASP.NET Core web site “Down for maintenance”\n\n\n\nThree ways to refresh the claims of a logged-in user\n\n\n\nUse custom databases with the AuthP library – Part1: normal apps\n\n\n\nMaking .NET sharding multi-tenant apps easier to use with AuthP 5.1 (this article)\n\n\n\nUse custom databases with the AuthP library – Part2: sharding / hybrid apps (coming soon)\n\n\n\n\nTL;DR; – Summary of this article\n\n\n\n\nThis article is about a sharding multi-tenant application. AuthP has two types of sharding:Hybrid, which supports tenants that share a database with other users and tenants that have their own database, which I refer to Sharding-only.\n\nSharding-only, where every tenant have their own database.\n\n\n\n\n\nPart 1 covers two types of multi-tenant applications: one where admin is done by the app-maker and one where specific user(s) in a tenants handle the admin of their tenant.\n\n\n\nPart 2 describes the changes the AuthP’s sharding-only multi-tenant application, which areAllow certain features to work, e.g. the “Sign up now” featureTo improve the administration of a sharding-only multi-tenant application.\n\nAdd a service to make creating / removing sharding-only tenants easier in code and human time.\n\n\n\n\n\nPart 3 covers how you can use the new features in AuthP version 6. They areWhere does each tenant’s data is stored when using AuthP’s sharding?A service that makes it simpler to create / delete a sharding-only tenant.\n\nHow the AuthP’s 6 “Sign up now” feature handles sharding-only tenants.\n\n\n\n\n\nAt the end of this article it provides links to relevant documentation, the file containing steps to update an sharding multi-tenant using an older version, and a new example app.\n\n\n\n\nPart 1: Two types of multi-tenant applications\n\n\n\nRecently I have been working on the multi-tenant features in the AuthP’s library, and I started to see that there are different types of multi-tenant applications. This insight came while building a new sharding-only app and it helped me to see areas where I need to improve the AuthP’s sharding futures. The two main types of multi-tenant are based on who is in administration of users and tenants – see the description of two types below.\n\n\n\n1. Multi-tenant app controlled by the app-maker\n\n\n\nThis type of multi-tenant app is controlled by the organisation who owns the app. Normally there is some form of admin team (which I refer to as the app admin) in the organisation who manages the users and its data. Some examples of this type of multi-tenant apps are:\n\n\n\n\nA bank app allowing its users to manage their bank accounts.\n\n\n\nAn in-house app that controls the inventory in the organisation.\n\n\n\n\nThe pro of this style is they have good control over who can access the app, but the downside is you need an admin team to manage the users, tenants etc., e.g. add / remove users, changing what they can do, etc.\n\n\n\n2. Multi-tenant app controlled by tenant user\n\n\n\nThis type of multi-tenant app move much of the admin features out to a tenant user. The AuthP has the concept of a tenant admin allow a user to create their own tenant for their organisation (normally with a payment) and then manage the users in their tenant, such as adding new users, controlling what they can do, etc. Some examples of this type of multi-tenant apps are:\n\n\n\n\nGitHub, which allows users to create their own space and manage.\n\n\n\nFacebook / Meta,  where you post comments, share photos and have friends.\n\n\n\n\nThe pros of this style is that the tenant user can quickly makes changes and its reduces the size of the app admin team you need for to support your multi-tenant application. The downside is the multi-tenant administration code is more complex , but AuthP has built-in solutions to most of these admin features.\n\n\n\nNOTE: I was asked to design a large multi-tenant application for a client, and I personally know that there is a LOT of admin code. Also, the app admin team were very busy when a large organisation joined their multi-tenant application. This is why I put a lot of work on the tenant admin features to reduce the amount of work the app admin team must deal with.\n\n\n\nThe AuthP library supports both multi-tenant types, but you will read how I needed to improve the AuthP’s features for sharding-only databases.\n\n\n\nPart 2: The problems I found and what I did to improve sharding features\n\n\n\nThe AuthP’s implementation of sharding uses a “sharding entry” approach that links a tenant to a database. The diagram below the implementation of two types:  “controlled by the app-maker” and the “controlled by tenant users”.\n\n\n\n\n\n\n\nWhat I found that both types could be improved, but the “controlled by tenants” had one feature didn’t work as it should, and admin code weren’t that easy to use, especially around creating / deleting sharding-only tenants. Part 2 (below) will cover the problems and how I solve them.\n\n\n\nPart 2: The problems I found and what I did to solve them\n\n\n\nThe list below details the various problems and what I did about it \n\n\n\n\nThe “Sign up for a new tenant” feature doesn’t handle sharding tenants\n\n\n\nSolved a limitation in ASP.Net Core’s IOptions feature (breaking changes)\n\n\n\nAdd a service to make creating / removing sharding-only tenants.\n\n\n\n\n2.1. The “Sign up for a new tenant” feature doesn’t handle sharding-only tenants\n\n\n\nThe AuthP’s “Sign up for a new tenant” feature allows to a user to create a new tenant, which can significantly reduce the amount of work for your admin people. However the version 5.0.0 of the “Sign up” feature doesn’t contain code to setup a new sharding entry in a sharding-only tenant.\n\n\n\nBut it was then that is hit a limitation of the ASP.Net Core’s IOptions features – see the next section below what the problem is and how I got around it.\n\n\n\n2.2. Solved a limitation in ASP.Net Core’s IOptions feature (breaking changes)\n\n\n\nThe current sharding entries are held in a json file and accessed via ASP.NET Core’s IOptions feature (similar to how ASP.NET Core uses a appsetting.json file). What I found was that the I added a new sharding entry to a json file the IOptionsMonitor won’t see the changes until a new HTTP request starts – I assume it looked for updates at the end of every HTTP request. This causes me a problem as there are cases where a new sharding entry is added and another service needs to retrieve sharding entry within the same HTTP request.\n\n\n\nThere are a few ways to get around this, but in the end I changed to using my Net.DistributedFileStoreCache library (shortened to FileStoreCache)  that uses the FileSystemWatcher and updates are immediately updated. The upside of using the FileStoreCache is has a similar very fast (~25ns) read-time that the IOptions approach had. The downside is this change creates a breaking change to applications that have been created to older versions of AuthP.  \n\n\n\nNOTE: I have created a detail list of the changes in the UpdateToVersion6 file and a console application to help with update your app’s sharding entries to the AuthP 6 format.\n\n\n\n2.3. Add a service to make creating / removing sharding-only tenants\n\n\n\nWhen you are adding a new sharding-only tenant there are four steps:\n\n\n\n\nAdd a sharding entry to define the new database that the tenant will use.\n\n\n\nCreate the tenant using AuthP’s AuthTenantAdminService which will…\n\n\n\nRun your ITenantChangeService code to set up the database.\n\n\n\n\n…And if you are using a cloud database service, then you need create a new database.\n\n\n\nNOTE: If you need to create / delete cloud database, then you can do that withing your implementation of the ITenantChangeService – create your cloud database in the create tenant method and delete your cloud database in the delete tenant method.\n\n\n\nYou could do this yourself with the AuthP’s version 5 in two manual steps, but in AuthP version 6 there is a new service called IShardingOnlyTenantAddRemove which runs the three steps for creating and removing a tenant. This service makes it easier, and clearer, for an admin person to add or remove sharding-only tenants.\n\n\n\nPart 3 – How you can use these new features\n\n\n\nSo, having told you what has changed in AuthP version 6 let’s see how you would use these updated features. I will cover the following topics, and I will point out the things that have changed\n\n\n\n\nWhere does each tenant’s data is stored when using AuthP’s sharding?\n\n\n\nA service that makes it simpler to create / delete a sharding-only tenant\n\n\n\nHow the AuthP’s 6 “Sign up now” feature handles sharding-only tenants\n\n\n\n\n3.1 Where does each tenant’s data is stored when using AuthP’s sharding?\n\n\n\nA multi-tenant application provided a service for an organization / person finds useful, but instead of deploying a single web app / database for each tenant they have one web app and they segregate each tenant’s data. In AuthP provides three ways to segregate the tenant’s data, as shown in the table below.\n\n\n\nTypesDescriptionHow filter only tenant’s data?1. One databaseAll the tenant’s data in one databaseFilter data be unique key2. HybridSome tenants have their own database, and some tenants share a databaseSelect the correct databaseFilter data be unique key3. Sharding-OnlyEach tenant has their own database for dataSelect the correct database\n\n\n\nSince AuthP version 3  supports all these ways to separate each tenant’s data, but when I ran a twitter poll on what type of approach they wanted the “Tenants have their own db” (4. In the diagram above) won by a large margin. That why this article (and the new release of the AuthP library) is all about.\n\n\n\nAuthP version 3 defined a way that a tenant can be linked to a database. That database may have data from many tenants in it (shared) or a database has only one tenant’s data (shared-only). In this article we are mainly looking sharding, and in particular at the “Select the correct database” part, which applies to both hybrid and sharding-only approaches. The diagram shows the four stages that sets up the tenant’s data DbContext to the specific database for tenant that the logged-in user is linked to.\n\n\n\n\n\n\n\nAuthP version 6 stills these four steps, but it had to change the service that implements stage 2 was changed due the limitation in the ASP.NET Core IOptionsMonitor features. This created **breaking changes** in the version 6 release and I created UpdateToVersion6.md file which shows how to update your existing sharding multi-tenant built using a previous release of the AuthP library.\n\n\n\nNOTE: When fixing the ASP.NET Core IOptionsMonitor limitation I also found the existing code rather hard to understand, partly because of the code being complex and partly because the names of some of the classes and methods didn’t really say what they were doing. Therefore I wanted to make the code easier to understand, but this created more breaking changes. Thankfully these changes are obvious i.e. there will be a compile error as the name have changed.\n\n\n\n3.2. A service that makes it simpler to create / delete a sharding-only tenant\n\n\n\nSection 1.3 talks about a new service called IShardingOnlyTenantAddRemove that combines the creation of the tenant and its sharding entry at the same time. This service means that the admin user only has one page to fill in and the code sets up the rest. The service does the following:\n\n\n\n\nGathers the information to create the tenant and sharding entry needed:Tenant name – from the admin userThe connection string holding the database server (code or human – see diagram below)\n\nSet the database provider used to create the tenant database (e.g. SqlServer) is set by your code\n\n\n\n\n\nThen, after various checks, it creates the sharding entry and Tenant in one go.\n\n\n\n\nThe diagram below shows two web pages that the app admin user (think “controlled by app-maker” type) to create a new tenant on one go. The two pages show the two types of app: left is where the application has a single database server while on the right is for applications needing multiple database servers.\n\n\n\nNOTE: The Example7’s TenantController in the AuthP repo has an example of the multiple database servers option.\n\n\n\n\n\n\n\nNOTE: AuthP’s sharding muti-tenant feature uses connections strings to define the database server, authentication, and other options, but AuthP will add the name of the database. That’s why the  multiple database servers option above uses the name “Servers” for the connection strings names.\n\n\n\nThe service has a companion class called ShardingOnlyTenantAddDto which makes setting up of the data very simple. In fact the code below will work for both create tenant options as it detects if you only have one valid connection string and sets the ConnectionStringName automatically.\n\n\n\npublic IActionResult Create([FromServices] \n    IGetSetShardingEntries shardingService)\n{\n    var dto = new ShardingOnlyTenantAddDto\n    {\n        DbProviderShortName = AuthPDatabaseTypes.SqlServer.ToString()\n    };\n    dto.SetConnectionStringNames(\n        shardingService.GetConnectionStringNames());\n    return View(dto);\n}\n\n\n\nNOTE: The name of the database and the sharding entry is created by the ShardingOnlyTenantAddDto’s FormDatabaseInformation method which uses time as the database name, e.g. 20230808101149-892. If you want to use the tenant name then the FormDatabaseInformation method can be overridden by you.\n\n\n\n3.3 How the AuthP’s 6 “Sign up now” feature handles sharding-only tenants\n\n\n\nEarlier I said that the IOptionsMonitor limitation made it impossible to use the “Sign up now” feature to create a new sharding-only tenant (think “controlled by tenant user” type). Once the IOptionsMonitor limitation was overcome it wasn’t that hard to create a service that handles the tenant and its sharding entry.\n\n\n\nThe AuthP repo contains a DemoShardOnlyGetDatabaseForNewTenant which handles sharding-only tenant and the required sharding entry. The Example7 app in the repo has the “Sign up now” and uses the DemoShardOnlyGetDatabaseForNewTenant. The screenshot below shows this working – note that allows the user to decide where they wanted their data located.\n\n\n\n\n\n\n\nLots of new / updated documentation for AuthP version 6\n\n\n\nWhen I came back to programming after 21-year break (I went to the dark side, e.g. I was a manager) I picked Microsoft because their documentation was so good. Therefore I know that documentation is (nearly) as important as the code.\n\n\n\nSo, with the release of version 6 of the AuthP I have added / updated the documentation about sharding. Here is a list.\n\n\n\nDocumentWhat aboutMulti-tenant explainedStart here if new to AuthPSharding explainedDescribes two sharding modes, newHow AuthP handles shardingDescribes internal code, newConfiguring shardingHow to setup sharding app, newExtra help for shading‐only appsDocs on new features, newManaging sharding databasesShowing / changing tenants, updatedUpdateToVersion6How to update app to AuthP 6\n\n\n\nThe documents give you the overview of what to do, but I also take the time to add comments on all the code. That’s because sometimes it easier read the code to really what it does.\n\n\n\nAlso, the AuthP’s repo now has new example called Example7 which implements a sharding-only multi-tenant application. The Example7 app uses all the new / updated features included in the new AuthP version 6 release.\n\n\n\nConclusion\n\n\n\nWhen I started to look at improving Auth’s sharding-only tenant I kept finding things more and more issues and I wasn’t sure it was worth doing the update, so I did a twitter poll to find out what the users of the AuthP wanted. That poll clearly shows that developers preferred the sharding-only approach nearly twice more than a shared database approach. This feedback made my spend more time to make sharding-only really well.\n\n\n\nI’m very happy about the AuthP version 6 update because it fixed the limitations in sharding-only multi-tenant applications and improved the admin of creating / deleting tenants. The only problem is that AuthP version 6 contains the breaking changes, which that means you have alter your the sharding multi-tenant application when update to AuthP version 6 – see UpdateToVersion6 for the details.\n\n\n\nThere was always going to be some breaking changes, but I found my previous sharding code was hard to understand so I tided up that code at the same time. This adds extra breaking changes, but it turned out to fairly simple. For instance the update of the Example6 (hybrid multi-tenant) from version 5 to version 6 wasn’t hard – usually it was just changing the names of the services and methods, with the complex changed only in the internal code.\n\n\n\nI hope AuthP’s user’s will find version 6 helps them, or anyone building a sharding-only multi-tenant application can gets some ideas for their project. Do give me feedback on version 6 and I am happy to answer your questions via the AuthP ‘s GitHub issues pages.\n\n\n\nHappy coding."
  },
  {
    "itemId": "https://www.thereformedprogrammer.net/?p=2891",
    "raw": "\n<p>The <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore\">AuthPermissions.AspNetCore</a><strong> </strong>library, referred to as <em>AuthP library</em>, provides <a href=\"https://www.thereformedprogrammer.net/finally-a-library-that-improves-role-authorization-in-asp-net-core/\">enhanced Roles authentication</a> and <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Multi-tenant-explained\">multi-tenant services</a> to an .NET application. The AuthP library needs to store information in a database, and the previous version (4.2.0) supported SQL Server and PostgreSQL, but with release of AuthP version 5.0.0 you can use the main database provider that <a href=\"https://learn.microsoft.com/en-us/ef/core/providers/\">that EF Core supports</a>. This feature is called “<em>custom databases”</em> and which allows you to use other database providers other than the build-in SqlServer or PostgreSQL database providers.</p>\n\n\n\n<p>This article explains the steps you need to use a different database provider with a normal (i.e. not sharding / hybrid) multi-tenant application. A second article called “Use custom databases with the AuthP library – Part2: sharding / hybrid apps” will cover using the “custom databases” feature with sharding / hybrid multi-tenant application.</p>\n\n\n\n<p>This article is part of the series that covers AuthP’s multi-tenant applications in general. The other articles in “Building ASP.NET Core and EF Core multi-tenant apps” series are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\" start=\"1\">\n<li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part1-the-database/\">The database: Using a DataKey to only show data for users in their tenant</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part2-administration/\">Administration: different ways to add and control tenants and users</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/multi-tenant-apps-with-different-versions-can-increase-your-profits/\">Versioning your app: Creating different versions to maximise your profits</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-hierarchical-multi-tenant-apps/\">Hierarchical multi-tenant: Handling tenants that have sub-tenants</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/advanced-techniques-around-asp-net-core-users-and-their-claims/\">Advanced techniques around ASP.NET Core Users and their claims</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/part6-using-sharding-to-build-multi-tenant-apps-using-asp-net-core-and-ef-core/\">Using sharding to build multi-tenant apps using EF Core and ASP.NET Core</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/three-ways-to-securely-add-new-users-to-an-application-using-the-authp-library/\">Three ways to securely add new users to an application using the AuthP library</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/how-to-take-an-asp-net-core-web-site-down-for-maintenance/\">How to take an ASP.NET Core web site “Down for maintenance”</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/asp-net-core-three-ways-to-refresh-the-claims-of-a-logged-in-user/\">Three ways to refresh the claims of a logged-in user</a></li>\n\n\n\n<li>Use custom databases with the AuthP library – Part1: normal apps (<strong>this article</strong>)</li>\n\n\n\n<li>Use custom databases with the AuthP library – Part2: sharding / hybrid apps (coming soon)</li>\n</ol>\n\n\n\n<h2 class=\"wp-block-heading\">TL;DR; – Summary of this article</h2>\n\n\n\n<ul class=\"wp-block-list\">\n<li>The AuthP library is designed to make building .NET <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Multi-tenant-explained\">multi-tenant applications</a> by providing a the backend design and admin features to get your application build more quickly.</li>\n\n\n\n<li>The new AuthP version 5.0.0 and contains the “custom databases” feature (plus other features &#8211; see next section), where you can now use any of the main of EF Core database providers with AuthP, focusing on normal (i.e. not sharding / hybrid) multi-tenant applications.</li>\n\n\n\n<li>To use the “custom databases” feature with a normal multi-tenant applications you need to go three stages:<ul><li>Create an EF Core migration for your selected database provider</li></ul><ul><li>Create an extension method to register your custom database</li></ul>\n<ul class=\"wp-block-list\">\n<li>Various minor changes to your tenant data to work with your custom database</li>\n</ul>\n</li>\n\n\n\n<li>There is a working example of a normal multi-tenant applications using Sqlite as the custom database. You can find this in the <a href=\"https://github.com/JonPSmith/AuthPermissions.CustomDatabaseExamples/tree/main/CustomDatabase1.SqliteCustomParts/Migrations\">AuthP.CustomDatabaseExamples</a> repo – look at projects with a name starting with “CustomDatabase1.”</li>\n\n\n\n<li>This article compares a multi-tenant application using a build-in database and the same multi-tenant application using Sqlite as the custom database.</li>\n</ul>\n\n\n\n<h2 class=\"wp-block-heading\">Summary of the new features in AuthP version 5.0.0</h2>\n\n\n\n<p>Before getting to the details of the new “custom databases” in AuthP version 5.0.0 I provide an overall list of all the new in this release:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>BREAKING CHANGE in AuthP’s <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Multi-tenant-explained#2-defining-the-three-multi-tenant-database-arrangements\">sharding / hybrid multi-tenant feature</a>: If you are using AuthP’s sharding /hybrid features, then look at the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/UpdateToVersion5.md\">UpdateToVersion5.md file</a> for what you need to do.</li>\n\n\n\n<li>This new release makes it easier to use, and change, the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Multi-tenant-explained#2-defining-the-three-multi-tenant-database-arrangements\">sharding / hybrid multi-tenant feature</a>. The two items below cover the easy of use / change:<ul><li><em>Easier to use</em>: there is a new extension method called <code>SetupMultiTenantSharding</code> that sets up the sharding / hybrid multi-tenant feature. This makes it easier to set up this feature.</li></ul>\n<ul class=\"wp-block-list\">\n<li><em>Easier to change</em>: You can change the internal services / setting of the sharding / hybrid feature, e.g. one developer wants to store sharding data in a database, instead of in a json file, which this release allows. This is done by creating a new extension method containing the code in the <code>SetupMultiTenantSharding</code> extension method with your changes.</li>\n</ul>\n</li>\n\n\n\n<li>New feature: You can now use range of database providers (see list later) to use with the AuthP library. The table below shown the database providers AuthP 5.0.0 supports:</li>\n</ul>\n\n\n\n<figure class=\"wp-block-table\"><table><tbody><tr><td><strong>Supported database providers in V5.0.0</strong></td><td>Comments</td></tr><tr><td>Microsoft.EntityFrameworkCore.SqlServer</td><td>Built-in – already in AuthP library</td></tr><tr><td>Npgsql.EntityFrameworkCore.PostgreSQL</td><td>Built-in – already in AuthP library</td></tr><tr><td>Microsoft.EntityFrameworkCore.Sqlite</td><td>&nbsp;</td></tr><tr><td>Microsoft.EntityFrameworkCore.Cosmos</td><td>&nbsp;</td></tr><tr><td>Pomelo.EntityFrameworkCore.MySql</td><td><a href=\"https://github.com/PomeloFoundation\">Pomelo Foundation Project</a></td></tr><tr><td>MySql.EntityFrameworkCore</td><td><a href=\"https://dev.mysql.com\">MySQL project</a> (Oracle)</td></tr><tr><td>Oracle.EntityFrameworkCore</td><td><a href=\"https://www.oracle.com/technetwork/topics/dotnet/\">Oracle</a></td></tr></tbody></table></figure>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: The AuthP library uses Giorgi Dalakishvili’s <a href=\"https://github.com/Giorgi/EntityFramework.Exceptions\">EntityFramework.Exceptions</a> library to detect concurrency and unique errors, and Giorgi only supports the main EF Core database providers, i.e. SqlServer, PostgreSQL, SQLite, MySQL, MySQL.Pomelo, and Oracle.</p>\n</blockquote>\n\n\n\n<p>The rest of this article covers using a “custom database” with a single tenant database, and Part2 article will show to use “custom databases” with tenants in many databases (i.e. sharding / hybrid approach).</p>\n\n\n\n<h2 class=\"wp-block-heading\">Setting the scene – how AuthP’s multi-tenant features uses databases &nbsp;</h2>\n\n\n\n<p>The AuthP’s multi-tenant feature provides nearly all the backend services / admin to build a multi-tenant application. I started building the AuthP library using one / two databases, which works for small / medium sized multi-tenant apps. Then in version 3.0.0 I added a “one db per tenant” approach (known as <em>sharding</em>) plus a hybrid design, which gives you more flexibility to handle both small and large tenants on the same multi-tenant app. The diagram below shows the four ways AuthP can handle databases to provide the right cost / performance for your multi-tenant project.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/05/FourWaysToStoreAuthPAndTenantData.png\"><img loading=\"lazy\" decoding=\"async\" width=\"732\" height=\"329\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/05/FourWaysToStoreAuthPAndTenantData.png\" alt=\"\" class=\"wp-image-2892\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/05/FourWaysToStoreAuthPAndTenantData.png 732w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/05/FourWaysToStoreAuthPAndTenantData-300x135.png 300w\" sizes=\"auto, (max-width: 732px) 100vw, 732px\" /></a></figure>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: If you aren’t creating a multi-tenant project, then you follow the first, “All in in one Db” approach with AuthP data and any project data in one database.</p>\n</blockquote>\n\n\n\n<p>Up to this point the AuthP only supported SQL Server and Postgres database types, but a few developers asked if the I could support other database providers. So, when I found time, I created a new version of the AuthP I added the “custom database” feature that supports allows any database server that EF Core supports.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Introducing the AuthP.CustomDatabaseExamples repo</h2>\n\n\n\n<p>To help you, and to make sure the custom database feature works, I created a repo called <a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples\">AuthP.CustomDatabaseExamples</a> which contains two examples: this article covering multi-tenant application that keep all tenant data in one database (see 1 and 2 in the Four Ways diagram).</p>\n\n\n\n<p>To use a custom database you must change various code and migrations, which this article will explain. I chose Sqlite for my custom database type because the Individual User Accounts authentication supports Sqlite.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: Using Sqlite for the custom database examples requires extra code over other database providers. That’s because the Sqlite’s connection string doesn’t have a Server / host part but has a filepath in the data source part. Other databases, such as MySql, should be slightly easier as the connection string fully defines the server and database name.</p>\n</blockquote>\n\n\n\n<p>The example which works with AuthP “add tenant data in one database” and has three projects, all starting with CustomDatabase1.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Steps in building a normal AuthP application with a custom database</h2>\n\n\n\n<p>We start with an application using AuthP which uses one / two databases, i.e. 1 and 2 in the previous “Four Ways” diagram. Here are the steps to use a custom database are listed below, which will detailed later.</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>Create a migration of the AuthPermissionsDbContext for your custom database.</li>\n\n\n\n<li>Create an extension method to register your custom database.</li>\n\n\n\n<li>Other, non-AuthP things you need to think about</li>\n</ol>\n\n\n\n<p>These stages are explained below.</p>\n\n\n\n<h3 class=\"wp-block-heading\">1. Create a migration of the AuthPermissionsDbContext for your custom database</h3>\n\n\n\n<p>To create or update the AuthPermissionsDbContext you need to create an EF Core migration, and each database provider needs its own migration based on your chosen custom database type.</p>\n\n\n\n<p>If you are using AuthP’s build-in database providers, then the AuthP NuGet package contains migrations for SQL Server and Postgres. But when using the custom database feature, then you need to create the migration for your custom database type. There are <a href=\"https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/\">many ways to create a EF migration</a>, but personally I use a IDesignTimeDbContextFactor&lt;TContext>.   The code below comes from the <a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples/blob/main/CustomDatabase1.SqliteCustomParts/AuthPermissionsDbMigrate/AuthPermissionsDbContextSqlite.cs\">CustomDatabase1’s AuthPermissionsDbContextSqlite</a> class.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; highlight: [6,7,13,16]; title: ; notranslate\">\npublic class AuthPermissionsDbContextSqlite :\n     IDesignTimeDbContextFactory&lt;AuthPermissionsDbContext&gt;\n{\n    // The connection string must be valid, but the  \n    // connection string isn’t used when adding a migration.\n    private const string connectionString = \n        &quot;Data source=PrimaryDatabase.sqlite&quot;;\n\n    public AuthPermissionsDbContext CreateDbContext(string&#x5B;] args)\n    {\n        var optionsBuilder =\n            new DbContextOptionsBuilder&lt;AuthPermissionsDbContext&gt;();\n        optionsBuilder.UseSqlite(connectionString);\n\n        return new AuthPermissionsDbContext(optionsBuilder.Options, \n            null, new SqliteDbConfig());\n    }\n}\n</pre></div>\n\n\n<p>The following lines you to change for your custom database provider</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>Lines 6 and 7: You must have a connection string in the correct format for your custom database type, but if you are creating a migration then the database won&#8217;t be accessed. </li>\n\n\n\n<li>Line 13: you need to use the correct “Use???” method for your custom database provider.</li>\n\n\n\n<li>Line 16: The third parameter to the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.BaseCode/DataLayer/EfCode/AuthPermissionsDbContext.cs\">AuthPermissionsDbContext</a> class allows you to add any custom-specific set of EF Core model commands to be run at the start of the AuthPermissionsDbContext’s  OnModelCreating method.  The main use is to set up concurrency tokens to capture concurrent changes to the same table. See the <a href=\"https://github.com/JonPSmith/AuthPermissions.CustomDatabaseExamples/blob/main/CustomDatabase1.SqliteCustomParts/SqliteDbConfig.cs\">SqliteDbConfig</a> class for Sqlite concurrent change commands.</li>\n</ul>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: Setting up the Sqlite concurrent change in the EF Core migration is a bit harder than from other database types. That’s because you need to add extra trigger code – see <a href=\"https://www.bricelam.net/2020/08/07/sqlite-and-efcore-concurrency-tokens.html\">this article</a> on what Sqlite needs and see the <a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples/tree/main/CustomDatabase1.SqliteCustomParts/Migrations\">…Version5.cs in the SqliteCustomParts Migrations folder</a>.</p>\n</blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">2. Extension method to register your custom database</h3>\n\n\n\n<p>You need to create an extension method to register your custom database. You do this by copying one of existing extension methods already in the AuthP code, such as <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions/SetupExtensions.cs#L46-L89\">UsingEfCoreSqlServer</a>, and alter six parts:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>You set the AuthPDatabaseType to the enum AuthPDatabaseTypes.CustomDatabase</li>\n\n\n\n<li>Change the AuthPermissionsDbContext to your custom database provider.</li>\n\n\n\n<li>Link to your assembly containing the AuthPermissionsDbContext migration.</li>\n\n\n\n<li>Update the <a href=\"https://github.com/Giorgi/EntityFramework.Exceptions\">EntityFramework.Exceptions</a> to your custom database provider.</li>\n\n\n\n<li>Add new code to register custom database configuration code.</li>\n\n\n\n<li>Optional: Update the RunMethodsSequentially code to provide a global lock</li>\n</ol>\n\n\n\n<p>The diagram below shows how you would take the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions/SetupExtensions.cs#L46-L89\">UsingEfCoreSqlServer</a> extension method and alter it to become your custom database extension method (NOTE click to get a bigger version of the diagram).</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/05/ConvertUsingEfCoreSqlServerToCustomDb.png\"><img loading=\"lazy\" decoding=\"async\" width=\"917\" height=\"663\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/05/ConvertUsingEfCoreSqlServerToCustomDb.png\" alt=\"\" class=\"wp-image-2893\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/05/ConvertUsingEfCoreSqlServerToCustomDb.png 917w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/05/ConvertUsingEfCoreSqlServerToCustomDb-300x217.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/05/ConvertUsingEfCoreSqlServerToCustomDb-768x555.png 768w\" sizes=\"auto, (max-width: 917px) 100vw, 917px\" /></a></figure>\n\n\n\n<p>The AuthP.CustomDatabaseExamples repo has a UsingEfCoreSqlite extension method in the <a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples/blob/main/CustomDatabase1.SqliteCustomParts/SqliteSetupExtensions.cs\">SqliteSetupExtensions</a> class which sets up a Sqlite database as the custom database. This has gone through the six steps shown in the diagram above.</p>\n\n\n\n<h3 class=\"wp-block-heading\">3. Other, non-AuthP things you need to think about</h3>\n\n\n\n<p>There are a few other things to do that use your custom database outside the AuthP library. The main one is the tenant part provides some sort of application that users will use. In the AuthP library there is one that mimics an application where you can entry invoices. Another example is managing shops sales/stock. If you want to use your custom database in your tenant data, then you need to set that up too.</p>\n\n\n\n<p>The first two options in the “Four Ways” diagram show that you two ways to handle the tenant part of the outside sharding.</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>“All in one Db”: your tenant data is within the same database, so it must use the same custom database.</li>\n\n\n\n<li>“Separate AuthP / tenant data”: In this case your tenant data doesn’t have to use the same custom database that AuthP uses.&nbsp;</li>\n</ol>\n\n\n\n<h2 class=\"wp-block-heading\">Comparing two AuthP multi-tenant examples to see the changes</h2>\n\n\n\n<p>I created an example multi-tenant application using Sqlite as the custom database, by copying an existing multi-tenant application that used the built-in SqlServer – see <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example3.MvcWebApp.IndividualAccounts\">Example3 in the AuthP repo</a>. This allows me to compare the changes to my new Sqlite to show what has changed.</p>\n\n\n\n<p>I created a new repo called <a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples\">AuthP.CustomDatabaseExamples</a> and copy / updated an&nbsp; example multi-tenant application, using three projects wholes names all starting with “CustomDatabase1.”. There are three projects are:</p>\n\n\n\n<figure class=\"wp-block-table\"><table><tbody><tr><td>Projects</td><td>&nbsp;</td></tr><tr><td>CustomDatabase1.InvoiceCode</td><td>Code for the tenant data / features</td></tr><tr><td>CustomDatabase1.SqliteCustomParts</td><td>Contains Sqlite code / migration</td></tr><tr><td>CustomDatabase1.WebApp</td><td>ASP.NET Core providing a runnable web app</td></tr></tbody></table></figure>\n\n\n\n<h4 class=\"wp-block-heading\">3a. Example3.InvoiceCode -&gt; CustomDatabase1.InvoiceCode</h4>\n\n\n\n<p>The main changes are to so using Sqlite for the invoice code. Here are the changes:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples/blob/main/CustomDatabase1.InvoiceCode/AppStart/StartupExtensions.cs\">&#8230;AppStart.RegisterInvoiceServices</a> – changed to use Sqlite</li>\n\n\n\n<li><a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples/blob/main/CustomDatabase1.InvoiceCode/EfCoreCode/InvoicesDesignTimeContextFactory.cs\">InvoicesDesignTimeContextFactory</a> (IDesignTimeDbContextFactory) to create a migration for the Invoice DbContext to Sqlite (The AuthP Example3 Invoice DbContext used the build-in SqlServer). See my comments on the end of this class which provides one way to create the migration.</li>\n\n\n\n<li>You need to create a <a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples/tree/main/CustomDatabase1.InvoiceCode/EfCoreCode/Migrations\">Sqlite Migration</a> for the Invoice DbContext using the InvoicesDesignTimeContextFactory detail above.</li>\n</ul>\n\n\n\n<p>3b. New <a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples/tree/main/CustomDatabase1.SqliteCustomParts/Migrations\">CustomDatabase1.SqliteCustomParts</a> project</p>\n\n\n\n<p>This project contains the Sqlite extras that you need to use Sqlite with AuthP. They are:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>The <a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples/blob/main/CustomDatabase1.SqliteCustomParts/SqliteDbConfig.cs\">SqliteDbConfig class</a> which contains some extra EF Core commands to be run in the DbContext’s OnModelCreating method to set up extra concurrency tokens. Concurrency tokens are different for each database provider, so this use to the correct concurrency tokens for your custom database. NOTE: Sqlite concurrency tokens are <a href=\"https://www.bricelam.net/2020/08/07/sqlite-and-efcore-concurrency-tokens.html\">quite difficult to add to a migration</a> – look at the code in the provided migration</li>\n\n\n\n<li><a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples/blob/main/CustomDatabase1.SqliteCustomParts/AuthPermissionsDbMigrate/AuthPermissionsDbContextSqlite.cs\">AuthPermissionsDbContextSqlite</a> (IDesignTimeDbContextFactory) which will create a Sqlite migration for the AuthP’s DbContext which holds the admin data.</li>\n\n\n\n<li><a href=\"https://github.com/JonPSmith/AuthPermissions.CustomDatabaseExamples/blob/main/CustomDatabase1.SqliteCustomParts/SqliteSetupExtensions.cs\">SqliteSetupExtensions</a>, which I explained in section “<a href=\"https://www.thereformedprogrammer.net/using-custom-databases-with-the-authp-library-part1-normal-apps/#2-extension-method-to-register-your-custom-database\">2. Extension method to register your custom database</a>”.</li>\n</ul>\n\n\n\n<h4 class=\"wp-block-heading\">3.c. Example3.MvcWebApp.IndividualAccounts -&gt; CustomDatabase1.WebApp</h4>\n\n\n\n<p>The big change in the ASP.NET Core project is changing is the Program class. In the <a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples/blob/main/CustomDatabase1.WebApp/Program.cs\">Program class</a> I have added #regions to show what has changed.</p>\n\n\n\n<p>The other change is in the <a href=\"https://github.com/JonPSmith/AuthP.CustomDatabaseExamples/blob/main/CustomDatabase1.WebApp/appsettings.json\">appsettings.json file</a> where you need to provide the Sqlite connection string, which is quite different from other database connection strings.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Conclusion</h2>\n\n\n\n<p>I haven’t had many requests for the “custom database” feature for AuthP, but like the support for multiple languages in AuthP many found it useful once its there.</p>\n\n\n\n<p>Creating the “custom database” feature for a normal (non-sharding) applications was fairly quick to create, but doing the same to the sharding / hybrid applications it turns out to be quite more complex. I decided to release AuthP version 5.0.0 without the sharding / hybrid “custom database” feature because this release contains other improvements that people have asked for.</p>\n\n\n\n<p>Watch this space for Part2 of the “custom databases” article to see how to use “custom database” feature when building sharding / hybrid multi-tenants applications. Happy cod</p>\n",
    "sanitized": "The AuthPermissions.AspNetCore library, referred to as AuthP library, provides enhanced Roles authentication and multi-tenant services to an .NET application. The AuthP library needs to store information in a database, and the previous version (4.2.0) supported SQL Server and PostgreSQL, but with release of AuthP version 5.0.0 you can use the main database provider that that EF Core supports. This feature is called “custom databases” and which allows you to use other database providers other than the build-in SqlServer or PostgreSQL database providers.\n\n\n\nThis article explains the steps you need to use a different database provider with a normal (i.e. not sharding / hybrid) multi-tenant application. A second article called “Use custom databases with the AuthP library – Part2: sharding / hybrid apps” will cover using the “custom databases” feature with sharding / hybrid multi-tenant application.\n\n\n\nThis article is part of the series that covers AuthP’s multi-tenant applications in general. The other articles in “Building ASP.NET Core and EF Core multi-tenant apps” series are:\n\n\n\n\nThe database: Using a DataKey to only show data for users in their tenant\n\n\n\nAdministration: different ways to add and control tenants and users\n\n\n\nVersioning your app: Creating different versions to maximise your profits\n\n\n\nHierarchical multi-tenant: Handling tenants that have sub-tenants\n\n\n\nAdvanced techniques around ASP.NET Core Users and their claims\n\n\n\nUsing sharding to build multi-tenant apps using EF Core and ASP.NET Core\n\n\n\nThree ways to securely add new users to an application using the AuthP library\n\n\n\nHow to take an ASP.NET Core web site “Down for maintenance”\n\n\n\nThree ways to refresh the claims of a logged-in user\n\n\n\nUse custom databases with the AuthP library – Part1: normal apps (this article)\n\n\n\nUse custom databases with the AuthP library – Part2: sharding / hybrid apps (coming soon)\n\n\n\n\nTL;DR; – Summary of this article\n\n\n\n\nThe AuthP library is designed to make building .NET multi-tenant applications by providing a the backend design and admin features to get your application build more quickly.\n\n\n\nThe new AuthP version 5.0.0 and contains the “custom databases” feature (plus other features – see next section), where you can now use any of the main of EF Core database providers with AuthP, focusing on normal (i.e. not sharding / hybrid) multi-tenant applications.\n\n\n\nTo use the “custom databases” feature with a normal multi-tenant applications you need to go three stages:Create an EF Core migration for your selected database providerCreate an extension method to register your custom database\n\nVarious minor changes to your tenant data to work with your custom database\n\n\n\n\n\nThere is a working example of a normal multi-tenant applications using Sqlite as the custom database. You can find this in the AuthP.CustomDatabaseExamples repo – look at projects with a name starting with “CustomDatabase1.”\n\n\n\nThis article compares a multi-tenant application using a build-in database and the same multi-tenant application using Sqlite as the custom database.\n\n\n\n\nSummary of the new features in AuthP version 5.0.0\n\n\n\nBefore getting to the details of the new “custom databases” in AuthP version 5.0.0 I provide an overall list of all the new in this release:\n\n\n\n\nBREAKING CHANGE in AuthP’s sharding / hybrid multi-tenant feature: If you are using AuthP’s sharding /hybrid features, then look at the UpdateToVersion5.md file for what you need to do.\n\n\n\nThis new release makes it easier to use, and change, the sharding / hybrid multi-tenant feature. The two items below cover the easy of use / change:Easier to use: there is a new extension method called SetupMultiTenantSharding that sets up the sharding / hybrid multi-tenant feature. This makes it easier to set up this feature.\n\nEasier to change: You can change the internal services / setting of the sharding / hybrid feature, e.g. one developer wants to store sharding data in a database, instead of in a json file, which this release allows. This is done by creating a new extension method containing the code in the SetupMultiTenantSharding extension method with your changes.\n\n\n\n\n\nNew feature: You can now use range of database providers (see list later) to use with the AuthP library. The table below shown the database providers AuthP 5.0.0 supports:\n\n\n\n\nSupported database providers in V5.0.0CommentsMicrosoft.EntityFrameworkCore.SqlServerBuilt-in – already in AuthP libraryNpgsql.EntityFrameworkCore.PostgreSQLBuilt-in – already in AuthP libraryMicrosoft.EntityFrameworkCore.Sqlite Microsoft.EntityFrameworkCore.Cosmos Pomelo.EntityFrameworkCore.MySqlPomelo Foundation ProjectMySql.EntityFrameworkCoreMySQL project (Oracle)Oracle.EntityFrameworkCoreOracle\n\n\n\n\nNOTE: The AuthP library uses Giorgi Dalakishvili’s EntityFramework.Exceptions library to detect concurrency and unique errors, and Giorgi only supports the main EF Core database providers, i.e. SqlServer, PostgreSQL, SQLite, MySQL, MySQL.Pomelo, and Oracle.\n\n\n\n\nThe rest of this article covers using a “custom database” with a single tenant database, and Part2 article will show to use “custom databases” with tenants in many databases (i.e. sharding / hybrid approach).\n\n\n\nSetting the scene – how AuthP’s multi-tenant features uses databases  \n\n\n\nThe AuthP’s multi-tenant feature provides nearly all the backend services / admin to build a multi-tenant application. I started building the AuthP library using one / two databases, which works for small / medium sized multi-tenant apps. Then in version 3.0.0 I added a “one db per tenant” approach (known as sharding) plus a hybrid design, which gives you more flexibility to handle both small and large tenants on the same multi-tenant app. The diagram below shows the four ways AuthP can handle databases to provide the right cost / performance for your multi-tenant project.\n\n\n\n\n\n\n\n\nNOTE: If you aren’t creating a multi-tenant project, then you follow the first, “All in in one Db” approach with AuthP data and any project data in one database.\n\n\n\n\nUp to this point the AuthP only supported SQL Server and Postgres database types, but a few developers asked if the I could support other database providers. So, when I found time, I created a new version of the AuthP I added the “custom database” feature that supports allows any database server that EF Core supports.\n\n\n\nIntroducing the AuthP.CustomDatabaseExamples repo\n\n\n\nTo help you, and to make sure the custom database feature works, I created a repo called AuthP.CustomDatabaseExamples which contains two examples: this article covering multi-tenant application that keep all tenant data in one database (see 1 and 2 in the Four Ways diagram).\n\n\n\nTo use a custom database you must change various code and migrations, which this article will explain. I chose Sqlite for my custom database type because the Individual User Accounts authentication supports Sqlite.\n\n\n\n\nNOTE: Using Sqlite for the custom database examples requires extra code over other database providers. That’s because the Sqlite’s connection string doesn’t have a Server / host part but has a filepath in the data source part. Other databases, such as MySql, should be slightly easier as the connection string fully defines the server and database name.\n\n\n\n\nThe example which works with AuthP “add tenant data in one database” and has three projects, all starting with CustomDatabase1.\n\n\n\nSteps in building a normal AuthP application with a custom database\n\n\n\nWe start with an application using AuthP which uses one / two databases, i.e. 1 and 2 in the previous “Four Ways” diagram. Here are the steps to use a custom database are listed below, which will detailed later.\n\n\n\n\nCreate a migration of the AuthPermissionsDbContext for your custom database.\n\n\n\nCreate an extension method to register your custom database.\n\n\n\nOther, non-AuthP things you need to think about\n\n\n\n\nThese stages are explained below.\n\n\n\n1. Create a migration of the AuthPermissionsDbContext for your custom database\n\n\n\nTo create or update the AuthPermissionsDbContext you need to create an EF Core migration, and each database provider needs its own migration based on your chosen custom database type.\n\n\n\nIf you are using AuthP’s build-in database providers, then the AuthP NuGet package contains migrations for SQL Server and Postgres. But when using the custom database feature, then you need to create the migration for your custom database type. There are many ways to create a EF migration, but personally I use a IDesignTimeDbContextFactor<TContext>.   The code below comes from the CustomDatabase1’s AuthPermissionsDbContextSqlite class.\n\n\n\npublic class AuthPermissionsDbContextSqlite :\n     IDesignTimeDbContextFactory<AuthPermissionsDbContext>\n{\n    // The connection string must be valid, but the  \n    // connection string isn’t used when adding a migration.\n    private const string connectionString = \n        \"Data source=PrimaryDatabase.sqlite\";\n\n    public AuthPermissionsDbContext CreateDbContext(string[] args)\n    {\n        var optionsBuilder =\n            new DbContextOptionsBuilder<AuthPermissionsDbContext>();\n        optionsBuilder.UseSqlite(connectionString);\n\n        return new AuthPermissionsDbContext(optionsBuilder.Options, \n            null, new SqliteDbConfig());\n    }\n}\n\n\n\nThe following lines you to change for your custom database provider\n\n\n\n\nLines 6 and 7: You must have a connection string in the correct format for your custom database type, but if you are creating a migration then the database won’t be accessed. \n\n\n\nLine 13: you need to use the correct “Use???” method for your custom database provider.\n\n\n\nLine 16: The third parameter to the AuthPermissionsDbContext class allows you to add any custom-specific set of EF Core model commands to be run at the start of the AuthPermissionsDbContext’s  OnModelCreating method.  The main use is to set up concurrency tokens to capture concurrent changes to the same table. See the SqliteDbConfig class for Sqlite concurrent change commands.\n\n\n\n\n\nNOTE: Setting up the Sqlite concurrent change in the EF Core migration is a bit harder than from other database types. That’s because you need to add extra trigger code – see this article on what Sqlite needs and see the …Version5.cs in the SqliteCustomParts Migrations folder.\n\n\n\n\n2. Extension method to register your custom database\n\n\n\nYou need to create an extension method to register your custom database. You do this by copying one of existing extension methods already in the AuthP code, such as UsingEfCoreSqlServer, and alter six parts:\n\n\n\n\nYou set the AuthPDatabaseType to the enum AuthPDatabaseTypes.CustomDatabase\n\n\n\nChange the AuthPermissionsDbContext to your custom database provider.\n\n\n\nLink to your assembly containing the AuthPermissionsDbContext migration.\n\n\n\nUpdate the EntityFramework.Exceptions to your custom database provider.\n\n\n\nAdd new code to register custom database configuration code.\n\n\n\nOptional: Update the RunMethodsSequentially code to provide a global lock\n\n\n\n\nThe diagram below shows how you would take the UsingEfCoreSqlServer extension method and alter it to become your custom database extension method (NOTE click to get a bigger version of the diagram).\n\n\n\n\n\n\n\nThe AuthP.CustomDatabaseExamples repo has a UsingEfCoreSqlite extension method in the SqliteSetupExtensions class which sets up a Sqlite database as the custom database. This has gone through the six steps shown in the diagram above.\n\n\n\n3. Other, non-AuthP things you need to think about\n\n\n\nThere are a few other things to do that use your custom database outside the AuthP library. The main one is the tenant part provides some sort of application that users will use. In the AuthP library there is one that mimics an application where you can entry invoices. Another example is managing shops sales/stock. If you want to use your custom database in your tenant data, then you need to set that up too.\n\n\n\nThe first two options in the “Four Ways” diagram show that you two ways to handle the tenant part of the outside sharding.\n\n\n\n\n“All in one Db”: your tenant data is within the same database, so it must use the same custom database.\n\n\n\n“Separate AuthP / tenant data”: In this case your tenant data doesn’t have to use the same custom database that AuthP uses. \n\n\n\n\nComparing two AuthP multi-tenant examples to see the changes\n\n\n\nI created an example multi-tenant application using Sqlite as the custom database, by copying an existing multi-tenant application that used the built-in SqlServer – see Example3 in the AuthP repo. This allows me to compare the changes to my new Sqlite to show what has changed.\n\n\n\nI created a new repo called AuthP.CustomDatabaseExamples and copy / updated an  example multi-tenant application, using three projects wholes names all starting with “CustomDatabase1.”. There are three projects are:\n\n\n\nProjects CustomDatabase1.InvoiceCodeCode for the tenant data / featuresCustomDatabase1.SqliteCustomPartsContains Sqlite code / migrationCustomDatabase1.WebAppASP.NET Core providing a runnable web app\n\n\n\n3a. Example3.InvoiceCode -> CustomDatabase1.InvoiceCode\n\n\n\nThe main changes are to so using Sqlite for the invoice code. Here are the changes:\n\n\n\n\n…AppStart.RegisterInvoiceServices – changed to use Sqlite\n\n\n\nInvoicesDesignTimeContextFactory (IDesignTimeDbContextFactory) to create a migration for the Invoice DbContext to Sqlite (The AuthP Example3 Invoice DbContext used the build-in SqlServer). See my comments on the end of this class which provides one way to create the migration.\n\n\n\nYou need to create a Sqlite Migration for the Invoice DbContext using the InvoicesDesignTimeContextFactory detail above.\n\n\n\n\n3b. New CustomDatabase1.SqliteCustomParts project\n\n\n\nThis project contains the Sqlite extras that you need to use Sqlite with AuthP. They are:\n\n\n\n\nThe SqliteDbConfig class which contains some extra EF Core commands to be run in the DbContext’s OnModelCreating method to set up extra concurrency tokens. Concurrency tokens are different for each database provider, so this use to the correct concurrency tokens for your custom database. NOTE: Sqlite concurrency tokens are quite difficult to add to a migration – look at the code in the provided migration\n\n\n\nAuthPermissionsDbContextSqlite (IDesignTimeDbContextFactory) which will create a Sqlite migration for the AuthP’s DbContext which holds the admin data.\n\n\n\nSqliteSetupExtensions, which I explained in section “2. Extension method to register your custom database”.\n\n\n\n\n3.c. Example3.MvcWebApp.IndividualAccounts -> CustomDatabase1.WebApp\n\n\n\nThe big change in the ASP.NET Core project is changing is the Program class. In the Program class I have added #regions to show what has changed.\n\n\n\nThe other change is in the appsettings.json file where you need to provide the Sqlite connection string, which is quite different from other database connection strings.\n\n\n\nConclusion\n\n\n\nI haven’t had many requests for the “custom database” feature for AuthP, but like the support for multiple languages in AuthP many found it useful once its there.\n\n\n\nCreating the “custom database” feature for a normal (non-sharding) applications was fairly quick to create, but doing the same to the sharding / hybrid applications it turns out to be quite more complex. I decided to release AuthP version 5.0.0 without the sharding / hybrid “custom database” feature because this release contains other improvements that people have asked for.\n\n\n\nWatch this space for Part2 of the “custom databases” article to see how to use “custom database” feature when building sharding / hybrid multi-tenants applications. Happy cod"
  },
  {
    "itemId": "https://www.thereformedprogrammer.net/?p=2878",
    "raw": "\n<p>This article is about a pattern / library that allows you to create methods that can return a <em>status</em>, that is a success / fail value, plus the error messages – I call this “<em>returning a status</em>”. It then goes on to describe another library called <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors\">Net.LocalizeMessagesAndErrors</a> (shortened<strong> </strong>to <em>Localize-ME</em>) that returns a status where the errors can be in multiple languages (known as <em>localization</em>).</p>\n\n\n\n<p>This article talks about a library called <a href=\"https://github.com/JonPSmith/GenericServices.StatusGeneric\">GenericServices.StatusGeneric</a><strong> </strong>(shortened to <em>StatusGeneric</em><strong>) </strong>that implements the “return a status” pattern. Then it talks about a different library called  <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors\">Net.LocalizeMessagesAndErrors</a> (shortened to <em>Localize-ME</em>) that contains an implementation of “return a status” pattern, but handles multiple languages (known as <em>localization</em>) of the error messages.</p>\n\n\n\n<p>This article is part of series about handling localization.<a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki\"></a> The full list of the articles in this series are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li><a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications\">Improving the support of multiple languages in .NET applications</a></li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/applying-an-improved-multiple-languages-library-to-net-applications/\">Applying the improved multiple languages support to .NET applications</a></li>\n\n\n\n<li>A pattern / library for methods that return a status, including localization (<strong>this article</strong>)</li>\n</ol>\n\n\n\n<h2 class=\"wp-block-heading\">TL;DR; – Summary of this article</h2>\n\n\n\n<ul class=\"wp-block-list\">\n<li>The “return a status” pattern is useful wherever a method could return an error.</li>\n\n\n\n<li>The StatusGeneric library provides a simple, but powerful implementation of the “return a status” pattern and this article provides information on how to use the StatusGeneric library.</li>\n\n\n\n<li>A second library, Localize-ME, contains an implementation of&nbsp; the “return a status” pattern, where the error’s message can be returned in different languages. The localization part uses Localize-ME library, which has extra features on top of the .NET localization services.</li>\n</ul>\n\n\n\n<h2 class=\"wp-block-heading\">1. Introduction to the StatusGeneric library</h2>\n\n\n\n<p>In 2014 I created <a href=\"https://github.com/JonPSmith/GenericServices\">a library</a> using Entity Framework (known as EF6) which contains the “return a status” pattern inside it. Then in 2019, when .NET and EF Core were stable, I built a number of libraries that used the “return a status” pattern, so I created the standalone <a href=\"https://github.com/JonPSmith/GenericServices.StatusGeneric\">StatusGeneric library</a><strong> </strong>so that I could use it in lots of places / libraries<strong>. </strong>So far, this library has been downloads > 200,000 times so obviously others find it useful too.</p>\n\n\n\n<p>The following subsections will introduce you to the StatusGeneric library and how you can use it, starting with what the returned status contains.</p>\n\n\n\n<h3 class=\"wp-block-heading\">The returned status: IStatusGeneric and IStatusGeneric&lt;out T&gt;</h3>\n\n\n\n<p>The key of the “return a status” is the <a href=\"https://github.com/JonPSmith/GenericServices.StatusGeneric/blob/master/StatusGeneric/IStatusGeneric.cs\">IStatusGeneric</a>, which defines what the returned status contains. This list below defined each property in the</p>\n\n\n\n<p>I created an interface, which I refer to as a <em>status</em>, that is returned to the calling method. This interface, called <a href=\"https://github.com/JonPSmith/GenericServices.StatusGeneric/blob/master/StatusGeneric/IStatusGeneric.cs\">IStatusGeneric</a>, has the following properties:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>A IReadOnlyList <code>Errors </code>property where errors are stored. Each error is contained in a <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.componentmodel.dataannotations.validationresult\">ValidationResult</a> class, which contains the error message and optionally the name of the member that error is linked to (ASP.NET Core uses this to show the error next to the actual entry that has an error.</li>\n\n\n\n<li>A boolean <code>IsValid </code>property, which is true if there are no errors.</li>\n\n\n\n<li>A boolean <code>HasErrors </code>property, which is true if there are errors.</li>\n\n\n\n<li>A string <code>Message </code>property, which can contain a success message if there aren’t any Errors or contains “Failed with nn errors” if there are in the Errors property.</li>\n</ul>\n\n\n\n<p>I also created the <a href=\"https://github.com/JonPSmith/GenericServices.StatusGeneric/blob/master/StatusGeneric/IStatusGeneric.Generic.cshttps:/github.com/JonPSmith/GenericServices.StatusGeneric/blob/master/StatusGeneric/IStatusGeneric.Generic.cs\">IStatusGeneric&lt;out T&gt;</a> interface, which adds a Result property to the IStatusGeneric for methods that want to return a value as part of the status. The Result property is set to default if there are errors to ensure that</p>\n\n\n\n<h3 class=\"wp-block-heading\">How to use the StatusGeneric library in your code</h3>\n\n\n\n<p>The first step is to add the StatusGeneric’s <a href=\"https://www.nuget.org/packages/GenericServices.StatusGeneric/\">NuGet package</a> to the project you want use the StatusGeneric library. Then you can create a method that returns a status, as shown below. Below the code I give a list of the various parts in the code:</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic IStatusGeneric CheckNull(string? month)\n{\n    var status = new StatusGenericHandler();\n    status.Message = &quot;All went well&quot;;\n\n    if (month == null)\n        return status.AddError(&quot;input must not be null&quot;, \n             nameof(month));\n\n    return status;\n}\n</pre></div>\n\n\n<p>The list below contains a description of the use of the StatusGeneric library in the method above</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>Line 1: The method returns a class that matches the IStatusGeneric.</li>\n\n\n\n<li>Line 3: You need to create a status using the StatusGenericHandler constructor. This sets up an empty status, i.e. has no errors.</li>\n\n\n\n<li>Line 4: Optionally you can set a success Message. Note that if there are errors, then the Message contains the string “Failed with nn errors&#8221;;</li>\n\n\n\n<li>Line 7: This adds a error to the status and then returns the status\n<ul class=\"wp-block-list\">\n<li>Line 8: Optionally you can add the name of the member that has the error.</li>\n</ul>\n</li>\n\n\n\n<li>Line 10: This returns the status. In this case there are no errors, so it is valid.</li>\n</ul>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: The name of the member that has the error (line 8) must have the actual name of the property in a class, which in the case above would be Month, not month. I use a method called CamelToPascal (see <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/blob/main/LocalizeMessagesAndErrors/NameExtension.cs\">this extension class</a> in the Localize-ME library) that changes the first character to a capital character.</p>\n</blockquote>\n\n\n\n<p>And the code below provides an example of how use the CheckNull method in an ASP.NET Core application, with a list of the various parts after the code:</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: You need to add the EfCore.GenericServices.AspNetCore <a href=\"https://www.nuget.org/packages/EfCore.GenericServices.AspNetCore/\">NuGet package</a> to obtain access to the &nbsp;CopyErrorsToModelState method to copy and errors to the Razor pages.</p>\n</blockquote>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\n&#x5B;HttpPost]\n&#x5B;ValidateAntiForgeryToken]\npublic IActionResult CheckNull(string? month)\n{\n    var status = _exampleMethods.CheckNull(month);\n    if (status.IsValid)\n        return RedirectToAction(nameof(Index), \n             new { message = status.Message });\n\n    status.CopyErrorsToModelState(ModelState);\n    return View();\n}\n</pre></div>\n\n\n<p>The list below contains a description of how the CheckNull method could be used in an ASP.NET Core application:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>Line 5: You call the CheckNull method and you get back a status, which is of type IStatusGeneric.</li>\n\n\n\n<li>Line 6: If the status is valid, then you go back to the Index page.</li>\n\n\n\n<li>Line 8: The success message from the CheckNull method to show to the user.</li>\n\n\n\n<li>Line 9: Otherwise, the status has errors, so we want to show the error(s).</li>\n\n\n\n<li>Line 10: Using the CopyErrorsToModelState method from<strong> </strong><a href=\"https://github.com/JonPSmith/EfCore.GenericServices.AspNetCore\">EfCore.GenericServices.AspNetCore</a> library the errors (which are stored using the <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.componentmodel.dataannotations.validationresult\">ValidationResult</a> class) are added to the ASP.NET Core’s ModelState.</li>\n\n\n\n<li>Line 11: This returns to the Get action and the error(s) in the ModelState are shown to the user.</li>\n</ul>\n\n\n\n<h3 class=\"wp-block-heading\">Different ways to add errors to the status</h3>\n\n\n\n<p>The last section provided a simple example of using the StatusGeneric library, but in real life the checking for errors can be must more complex. Here are some of the situations you might come across and how the StatusGeneric library:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>Using multiple checks to return all the errors to the user</li>\n\n\n\n<li>Combining errors from multiple statuses</li>\n</ol>\n\n\n\n<h4 class=\"wp-block-heading\">1. Using multiple checks to return all the errors to the user</h4>\n\n\n\n<p>The example below show you might apply many checks so that the user gets all the errors in one go. This pattern is good for users as all the errors are returned at the same time.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: plain; title: ; notranslate\">\npublic IStatusGeneric CheckPassword(string password)\n{\n    var status = new StatusGenericHandler();\n\n    //series of tests and then return all the errors together\n    //Good because the user gets all the errors at once\n    if (password.Length &lt; 10)\n        status.AddError(&quot;A password must be 10 or more in length&quot;,\n            nameof(password));\n    if (!password.Any(char.IsUpper))\n        status.AddError(&quot;A password must contain an upper case character&quot;,\n            nameof(password));\n    if (!password.Any(char.IsLower))\n        status.AddError(&quot;A password must contain a lower case character&quot;,\n            nameof(password));\n    if (!password.Any(char.IsDigit))\n        status.AddError(&quot;A password must contain an number&quot;,\n            nameof(password));\n    \n    return status;\n}\n</pre></div>\n\n\n<h4 class=\"wp-block-heading\">2. Combining errors from multiple statuses</h4>\n\n\n\n<p>Sometimes the testing for errors is best coded by called to other “return a status” methods so the StatusGeneric library has a CombineStatuses method. This method will copy the errors from one the called “return a status” method into the caller’s status.</p>\n\n\n\n<p>The code below shows an example of logging in with tests on the email, password and the actual login part and, if successful, then returns the userId.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic IStatusGeneric&lt;string&gt; Login\n    (string email, string password)\n{\n    var status = new StatusGenericHandler&lt;string&gt;();\n\n    status.CombineStatuses(\n        CheckValidEmail(email));\n\n    if (status.HasErrors)\n        return status;\n\n    if (status.CombineStatuses(\n            CheckPassword(password)).HasErrors)\n        return status;\n\n    var loginStatus = LoginUser(email, password);\n    status.CombineStatuses(loginStatus);\n\n    status.SetResult(loginStatus.Result);\n\n    return status;\n}\n</pre></div>\n\n\n<p>The list below contains a description of how the Login method works:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>Line 1: The Login method will return the logged-in user’s userId.</li>\n\n\n\n<li>Lines 6,7: The Login method calls a CheckValidEmail method that returns a status which is copying into the caller’s status via the CombineStatuses method.</li>\n\n\n\n<li>Lines 9,10: This returns the combine status if the status has errors.</li>\n\n\n\n<li>Lines 12 to 14: This shows shorter way to return on a combined status that has errors.</li>\n\n\n\n<li>Lines 16: The LoginUser method returns a status that contains (if there are no errors) the logged-in user’s userId. </li>\n\n\n\n<li>Line 17: Its status is combined to pick up any errors.</li>\n\n\n\n<li>Line 19: This sets the string Result to send back with the method’s status. NOTE: if there are errors the Result is set to default, which for a string is null.</li>\n</ul>\n\n\n\n<h3 class=\"wp-block-heading\">Real-world examples of using the StatusGeneric library</h3>\n\n\n\n<p>I built a large library called <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore\">AuthPermissions.AspNetCore</a> (shortened to <em>AuthP</em>) which allow developers to create multi-tenant applications (and other features). Up to version 4.0.0 the AuthP  library uses the StatusGeneric library, and here is a link to <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/V4.0.0/AuthPermissions/AdminCode/Services/AuthTenantAdminService.cs\">AuthTenantAdminService</a> in AuthP 4.0.0 version, which shows it handles errors (tip: start at line 126, because that’s where the error handling starts).</p>\n\n\n\n<h2 class=\"wp-block-heading\">2. How to use the Localize-ME library</h2>\n\n\n\n<p>And in the end of 2022 I created another library, referred to as to <em>Localize-ME</em>, that includes a version that supports the StatusGeneric’s interfaces, but handles multiple languages of the error messages (known as localization). I created this library to add localization to my AuthP library and because because the AuthP already used the StatusGeneric library I added the StatusGenericLocalizer / StatusGenericLocalizer&lt;T> classes to replace the StatusGenericHandler / StatusGenericHandler&lt;T> classes.</p>\n\n\n\n<p>The design of the StatusGenericLocalizer (and its IDefaultLocalizer service) is to have a default message / error within your code, in your selected language you define when register the IDefaultLocalizer service. This has two benefits, a) the code is easier to understand and b) if localization isn’t turned on it can still provide message / error (useful in NuGet packages).</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: The Localize-ME library was build to add features that overcome certain restrictions in the .NET localization services – see <a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/\">this article</a> for more on this.</p>\n</blockquote>\n\n\n\n<p>The Localize-ME library has <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki\">comprehensive documentation</a> so this section is really about understanding the differences between the StatusGeneric library and the <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/blob/main/LocalizeMessagesAndErrors/StatusGenericLocalizer.cs\">StatusGenericLocalizer</a> class and its IDefaultLocalizer service in the Localize-ME library.</p>\n\n\n\n<h3 class=\"wp-block-heading\">How the StatusGenericLocalizer is different from the StatusGeneric?</h3>\n\n\n\n<p>The code below does exactly as the StatusGeneric shown in the “How to use the StatusGeneric library in your code” section ?LINK? but it’s a lot longer than the StatusGeneric version. That’s because we need to provide the service and keys to display the Message and Errors in different languages. The list after the code explains the different parts from the original StatusGeneric version ?LINK?.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic IStatusGeneric CheckNull(string? month)\n{\n    var status = new StatusGenericLocalizer(\n         _defaultLocalizer);\n    status.SetMessageString(\n        &quot;Success&quot;.ClassMethodLocalizeKey(this, false), \n        &quot;All went well&quot;);\n\n    if (month == null)\n        return status.AddErrorString(\n            &quot;NullParam&quot;.JustThisLocalizeKey(this), \n            &quot;The input must not be null.&quot;, \n            nameof(month).CamelToPascal())\n\n    return status;\n}\n</pre></div>\n\n\n<p>The list below contains a description of the use of the StatusGenericLocalizer class in the method above:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>Lines 3,4: The StatusGenericLocalizer constructor needs a IDefaultLocalizer service. This requires to <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Steps-to-localize-your-ASP.NET-Core-app\">localize your application</a> and  <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Adding-this-library-to-a-ASP.NET-Core-app#adding-the-idefaultlocalizer-service\">register the IDefaultLocalizer service</a> on startup.</li>\n\n\n\n<li>Lines 5 to 7: This adds a default success Message with two parts:<ul><li>Line 6:  This creates a unique key (see <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Creating-DefaultLocalization-localize-keys\">this document</a>) to lookup the message/error in the localization resource files.</li></ul>\n<ul class=\"wp-block-list\">\n<li>Line 7: This is the message to use if the culture (language) of the user / app matches the default culture. Note that if there are errors, then the Message contains the string “Failed with nn errors&#8221;;</li>\n</ul>\n</li>\n\n\n\n<li>Lines 10 to 13: This adds an error to the status and then returns the status<ul><li>Line 10: This a method that adds an error in the form of a constant string. Other methods allow FormattableStrings, which can contain dynamic data in the error.</li></ul><ul><li>Line 11: Creates a key to lookup the error message in the localization resource files.</li></ul><ul><li>Line 12: The error string in the default culture.</li></ul>\n<ul class=\"wp-block-list\">\n<li>Line 13: Optionally you can add the name of the member that has the error. In this case the Localize-ME library contains an implementation of the CamelToPascal method, which makes the member name used in a class.</li>\n</ul>\n</li>\n</ul>\n\n\n\n<h3 class=\"wp-block-heading\">Real-world examples of using the Localize-ME library</h3>\n\n\n\n<p>As I said I have a library called AuthP and I released version 4.1.0 with localization via the Localize-ME library. In the “Real-world examples of using the StatusGeneric library” section ?LINK? I gave you a link to the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/V4.0.0/AuthPermissions/AdminCode/Services/AuthTenantAdminService.cs\">AuthTenantAdminService</a> in AuthP 4.0.0, before the localization.</p>\n\n\n\n<p>This link to the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions/AdminCode/Services/AuthTenantAdminService.cs\">AuthTenantAdminService</a> comes from the main branch, which does the same as the AuthP 4.0.0 version, but it supports localization (tip: start at line 128, because that’s where the error handling starts).</p>\n\n\n\n<h2 class=\"wp-block-heading\">Conclusions</h2>\n\n\n\n<p>The “returning a status” method pattern is simple, but powerful pattern. I have used this pattern so many times that I build “return a status” code in 2014. Then in 2019, when .NET was stable, I released the <a href=\"https://github.com/JonPSmith/GenericServices.StatusGeneric\">StatusGeneric library</a> with an improved version over the 2014 implementation due to feedback of using the first version for many years.</p>\n\n\n\n<p>What I didn’t do well on StatusGeneric library was documentation, and this article is one way to fix that issue, although I have also improved the StatusGeneric’s <a href=\"https://github.com/JonPSmith/GenericServices.StatusGeneric/blob/master/README.md\">README file</a> a few times to provide better documentation.</p>\n\n\n\n<p>The Localize-ME library DOES have <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki\">good documentation</a> right from the start, with <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Introduction-to-StatusGenericLocalizer\">this page</a> for the StatusGenericLocalizer classes. It needed the documentation because localization is MUCH more complex than the “return a status” pattern, but if you want to support multiple languages then you need it.</p>\n\n\n\n<p>Happy coding.</p>\n",
    "sanitized": "This article is about a pattern / library that allows you to create methods that can return a status, that is a success / fail value, plus the error messages – I call this “returning a status”. It then goes on to describe another library called Net.LocalizeMessagesAndErrors (shortened to Localize-ME) that returns a status where the errors can be in multiple languages (known as localization).\n\n\n\nThis article talks about a library called GenericServices.StatusGeneric (shortened to StatusGeneric) that implements the “return a status” pattern. Then it talks about a different library called  Net.LocalizeMessagesAndErrors (shortened to Localize-ME) that contains an implementation of “return a status” pattern, but handles multiple languages (known as localization) of the error messages.\n\n\n\nThis article is part of series about handling localization. The full list of the articles in this series are:\n\n\n\n\nImproving the support of multiple languages in .NET applications\n\n\n\nApplying the improved multiple languages support to .NET applications\n\n\n\nA pattern / library for methods that return a status, including localization (this article)\n\n\n\n\nTL;DR; – Summary of this article\n\n\n\n\nThe “return a status” pattern is useful wherever a method could return an error.\n\n\n\nThe StatusGeneric library provides a simple, but powerful implementation of the “return a status” pattern and this article provides information on how to use the StatusGeneric library.\n\n\n\nA second library, Localize-ME, contains an implementation of  the “return a status” pattern, where the error’s message can be returned in different languages. The localization part uses Localize-ME library, which has extra features on top of the .NET localization services.\n\n\n\n\n1. Introduction to the StatusGeneric library\n\n\n\nIn 2014 I created a library using Entity Framework (known as EF6) which contains the “return a status” pattern inside it. Then in 2019, when .NET and EF Core were stable, I built a number of libraries that used the “return a status” pattern, so I created the standalone StatusGeneric library so that I could use it in lots of places / libraries. So far, this library has been downloads > 200,000 times so obviously others find it useful too.\n\n\n\nThe following subsections will introduce you to the StatusGeneric library and how you can use it, starting with what the returned status contains.\n\n\n\nThe returned status: IStatusGeneric and IStatusGeneric<out T>\n\n\n\nThe key of the “return a status” is the IStatusGeneric, which defines what the returned status contains. This list below defined each property in the\n\n\n\nI created an interface, which I refer to as a status, that is returned to the calling method. This interface, called IStatusGeneric, has the following properties:\n\n\n\n\nA IReadOnlyList Errors property where errors are stored. Each error is contained in a ValidationResult class, which contains the error message and optionally the name of the member that error is linked to (ASP.NET Core uses this to show the error next to the actual entry that has an error.\n\n\n\nA boolean IsValid property, which is true if there are no errors.\n\n\n\nA boolean HasErrors property, which is true if there are errors.\n\n\n\nA string Message property, which can contain a success message if there aren’t any Errors or contains “Failed with nn errors” if there are in the Errors property.\n\n\n\n\nI also created the IStatusGeneric<out T> interface, which adds a Result property to the IStatusGeneric for methods that want to return a value as part of the status. The Result property is set to default if there are errors to ensure that\n\n\n\nHow to use the StatusGeneric library in your code\n\n\n\nThe first step is to add the StatusGeneric’s NuGet package to the project you want use the StatusGeneric library. Then you can create a method that returns a status, as shown below. Below the code I give a list of the various parts in the code:\n\n\n\npublic IStatusGeneric CheckNull(string? month)\n{\n    var status = new StatusGenericHandler();\n    status.Message = \"All went well\";\n\n    if (month == null)\n        return status.AddError(\"input must not be null\", \n             nameof(month));\n\n    return status;\n}\n\n\n\nThe list below contains a description of the use of the StatusGeneric library in the method above\n\n\n\n\nLine 1: The method returns a class that matches the IStatusGeneric.\n\n\n\nLine 3: You need to create a status using the StatusGenericHandler constructor. This sets up an empty status, i.e. has no errors.\n\n\n\nLine 4: Optionally you can set a success Message. Note that if there are errors, then the Message contains the string “Failed with nn errors”;\n\n\n\nLine 7: This adds a error to the status and then returns the status\n\nLine 8: Optionally you can add the name of the member that has the error.\n\n\n\n\n\nLine 10: This returns the status. In this case there are no errors, so it is valid.\n\n\n\n\n\nNOTE: The name of the member that has the error (line 8) must have the actual name of the property in a class, which in the case above would be Month, not month. I use a method called CamelToPascal (see this extension class in the Localize-ME library) that changes the first character to a capital character.\n\n\n\n\nAnd the code below provides an example of how use the CheckNull method in an ASP.NET Core application, with a list of the various parts after the code:\n\n\n\n\nNOTE: You need to add the EfCore.GenericServices.AspNetCore NuGet package to obtain access to the  CopyErrorsToModelState method to copy and errors to the Razor pages.\n\n\n\n\n[HttpPost]\n[ValidateAntiForgeryToken]\npublic IActionResult CheckNull(string? month)\n{\n    var status = _exampleMethods.CheckNull(month);\n    if (status.IsValid)\n        return RedirectToAction(nameof(Index), \n             new { message = status.Message });\n\n    status.CopyErrorsToModelState(ModelState);\n    return View();\n}\n\n\n\nThe list below contains a description of how the CheckNull method could be used in an ASP.NET Core application:\n\n\n\n\nLine 5: You call the CheckNull method and you get back a status, which is of type IStatusGeneric.\n\n\n\nLine 6: If the status is valid, then you go back to the Index page.\n\n\n\nLine 8: The success message from the CheckNull method to show to the user.\n\n\n\nLine 9: Otherwise, the status has errors, so we want to show the error(s).\n\n\n\nLine 10: Using the CopyErrorsToModelState method from EfCore.GenericServices.AspNetCore library the errors (which are stored using the ValidationResult class) are added to the ASP.NET Core’s ModelState.\n\n\n\nLine 11: This returns to the Get action and the error(s) in the ModelState are shown to the user.\n\n\n\n\nDifferent ways to add errors to the status\n\n\n\nThe last section provided a simple example of using the StatusGeneric library, but in real life the checking for errors can be must more complex. Here are some of the situations you might come across and how the StatusGeneric library:\n\n\n\n\nUsing multiple checks to return all the errors to the user\n\n\n\nCombining errors from multiple statuses\n\n\n\n\n1. Using multiple checks to return all the errors to the user\n\n\n\nThe example below show you might apply many checks so that the user gets all the errors in one go. This pattern is good for users as all the errors are returned at the same time.\n\n\n\npublic IStatusGeneric CheckPassword(string password)\n{\n    var status = new StatusGenericHandler();\n\n    //series of tests and then return all the errors together\n    //Good because the user gets all the errors at once\n    if (password.Length < 10)\n        status.AddError(\"A password must be 10 or more in length\",\n            nameof(password));\n    if (!password.Any(char.IsUpper))\n        status.AddError(\"A password must contain an upper case character\",\n            nameof(password));\n    if (!password.Any(char.IsLower))\n        status.AddError(\"A password must contain a lower case character\",\n            nameof(password));\n    if (!password.Any(char.IsDigit))\n        status.AddError(\"A password must contain an number\",\n            nameof(password));\n    \n    return status;\n}\n\n\n\n2. Combining errors from multiple statuses\n\n\n\nSometimes the testing for errors is best coded by called to other “return a status” methods so the StatusGeneric library has a CombineStatuses method. This method will copy the errors from one the called “return a status” method into the caller’s status.\n\n\n\nThe code below shows an example of logging in with tests on the email, password and the actual login part and, if successful, then returns the userId.\n\n\n\npublic IStatusGeneric<string> Login\n    (string email, string password)\n{\n    var status = new StatusGenericHandler<string>();\n\n    status.CombineStatuses(\n        CheckValidEmail(email));\n\n    if (status.HasErrors)\n        return status;\n\n    if (status.CombineStatuses(\n            CheckPassword(password)).HasErrors)\n        return status;\n\n    var loginStatus = LoginUser(email, password);\n    status.CombineStatuses(loginStatus);\n\n    status.SetResult(loginStatus.Result);\n\n    return status;\n}\n\n\n\nThe list below contains a description of how the Login method works:\n\n\n\n\nLine 1: The Login method will return the logged-in user’s userId.\n\n\n\nLines 6,7: The Login method calls a CheckValidEmail method that returns a status which is copying into the caller’s status via the CombineStatuses method.\n\n\n\nLines 9,10: This returns the combine status if the status has errors.\n\n\n\nLines 12 to 14: This shows shorter way to return on a combined status that has errors.\n\n\n\nLines 16: The LoginUser method returns a status that contains (if there are no errors) the logged-in user’s userId. \n\n\n\nLine 17: Its status is combined to pick up any errors.\n\n\n\nLine 19: This sets the string Result to send back with the method’s status. NOTE: if there are errors the Result is set to default, which for a string is null.\n\n\n\n\nReal-world examples of using the StatusGeneric library\n\n\n\nI built a large library called AuthPermissions.AspNetCore (shortened to AuthP) which allow developers to create multi-tenant applications (and other features). Up to version 4.0.0 the AuthP  library uses the StatusGeneric library, and here is a link to AuthTenantAdminService in AuthP 4.0.0 version, which shows it handles errors (tip: start at line 126, because that’s where the error handling starts).\n\n\n\n2. How to use the Localize-ME library\n\n\n\nAnd in the end of 2022 I created another library, referred to as to Localize-ME, that includes a version that supports the StatusGeneric’s interfaces, but handles multiple languages of the error messages (known as localization). I created this library to add localization to my AuthP library and because because the AuthP already used the StatusGeneric library I added the StatusGenericLocalizer / StatusGenericLocalizer<T> classes to replace the StatusGenericHandler / StatusGenericHandler<T> classes.\n\n\n\nThe design of the StatusGenericLocalizer (and its IDefaultLocalizer service) is to have a default message / error within your code, in your selected language you define when register the IDefaultLocalizer service. This has two benefits, a) the code is easier to understand and b) if localization isn’t turned on it can still provide message / error (useful in NuGet packages).\n\n\n\n\nNOTE: The Localize-ME library was build to add features that overcome certain restrictions in the .NET localization services – see this article for more on this.\n\n\n\n\nThe Localize-ME library has comprehensive documentation so this section is really about understanding the differences between the StatusGeneric library and the StatusGenericLocalizer class and its IDefaultLocalizer service in the Localize-ME library.\n\n\n\nHow the StatusGenericLocalizer is different from the StatusGeneric?\n\n\n\nThe code below does exactly as the StatusGeneric shown in the “How to use the StatusGeneric library in your code” section ?LINK? but it’s a lot longer than the StatusGeneric version. That’s because we need to provide the service and keys to display the Message and Errors in different languages. The list after the code explains the different parts from the original StatusGeneric version ?LINK?.\n\n\n\npublic IStatusGeneric CheckNull(string? month)\n{\n    var status = new StatusGenericLocalizer(\n         _defaultLocalizer);\n    status.SetMessageString(\n        \"Success\".ClassMethodLocalizeKey(this, false), \n        \"All went well\");\n\n    if (month == null)\n        return status.AddErrorString(\n            \"NullParam\".JustThisLocalizeKey(this), \n            \"The input must not be null.\", \n            nameof(month).CamelToPascal())\n\n    return status;\n}\n\n\n\nThe list below contains a description of the use of the StatusGenericLocalizer class in the method above:\n\n\n\n\nLines 3,4: The StatusGenericLocalizer constructor needs a IDefaultLocalizer service. This requires to localize your application and  register the IDefaultLocalizer service on startup.\n\n\n\nLines 5 to 7: This adds a default success Message with two parts:Line 6:  This creates a unique key (see this document) to lookup the message/error in the localization resource files.\n\nLine 7: This is the message to use if the culture (language) of the user / app matches the default culture. Note that if there are errors, then the Message contains the string “Failed with nn errors”;\n\n\n\n\n\nLines 10 to 13: This adds an error to the status and then returns the statusLine 10: This a method that adds an error in the form of a constant string. Other methods allow FormattableStrings, which can contain dynamic data in the error.Line 11: Creates a key to lookup the error message in the localization resource files.Line 12: The error string in the default culture.\n\nLine 13: Optionally you can add the name of the member that has the error. In this case the Localize-ME library contains an implementation of the CamelToPascal method, which makes the member name used in a class.\n\n\n\n\n\n\nReal-world examples of using the Localize-ME library\n\n\n\nAs I said I have a library called AuthP and I released version 4.1.0 with localization via the Localize-ME library. In the “Real-world examples of using the StatusGeneric library” section ?LINK? I gave you a link to the AuthTenantAdminService in AuthP 4.0.0, before the localization.\n\n\n\nThis link to the AuthTenantAdminService comes from the main branch, which does the same as the AuthP 4.0.0 version, but it supports localization (tip: start at line 128, because that’s where the error handling starts).\n\n\n\nConclusions\n\n\n\nThe “returning a status” method pattern is simple, but powerful pattern. I have used this pattern so many times that I build “return a status” code in 2014. Then in 2019, when .NET was stable, I released the StatusGeneric library with an improved version over the 2014 implementation due to feedback of using the first version for many years.\n\n\n\nWhat I didn’t do well on StatusGeneric library was documentation, and this article is one way to fix that issue, although I have also improved the StatusGeneric’s README file a few times to provide better documentation.\n\n\n\nThe Localize-ME library DOES have good documentation right from the start, with this page for the StatusGenericLocalizer classes. It needed the documentation because localization is MUCH more complex than the “return a status” pattern, but if you want to support multiple languages then you need it.\n\n\n\nHappy coding."
  },
  {
    "itemId": "https://www.thereformedprogrammer.net/?p=2857",
    "raw": "\n<p>The <a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/\">last article</a> covered why I added extra features to the .NET support of multiple languages &nbsp;(known as <em>localization</em> in .NET) and via the <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors\">Net.LocalizeMessagesAndErrors</a> library (shortened to <em>Localize-ME</em> library). This article provides the details of how you would use the Localize-ME library in to add localization to your .NET application.<a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki\"></a> The full list of the articles in this series are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li><a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications\">Improving the support of multiple languages in .NET applications</a></li>\n\n\n\n<li>Applying the improved multiple languages support to .NET applications (<strong>this article</strong>)</li>\n\n\n\n<li>A library / pattern for methods that return a status, including localization (coming soon)</li>\n</ol>\n\n\n\n<h2 class=\"wp-block-heading\">TL;DR; – Summary of this article</h2>\n\n\n\n<ul class=\"wp-block-list\">\n<li>This article assumes you know the terms / concepts of localization. If you don’t, then go to the “<a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/#a-brief-view-of-how-net-localization-works\">A brief view of how .NET localization works</a>” which introduces to the localization concepts.</li>\n\n\n\n<li>The Localize-ME library adds extra localization features focused on a) making it easier to localize an existing application, and b) stop localization from making your code harder to understand.</li>\n\n\n\n<li>The Localize-ME library provides two services<ul><li>SimpleLocalizer service is good in small / simple applications and is simple to use.</li></ul>\n<ul class=\"wp-block-list\">\n<li>DefaultLocalizer service is good from large applications with many localizations because it uses a more formal pattern that makes it easier to find / set up the localized messages.</li>\n</ul>\n</li>\n\n\n\n<li>This article provides eight steps to localize an ASP.NET Core application using either, or both Localize-ME services. Each step provides a summary of what you need to do with links to the <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki\">Localize-ME documentation</a> for the definitive details.</li>\n</ul>\n\n\n\n<h2 class=\"wp-block-heading\">Super-quick explanation on the Localize-ME library provides</h2>\n\n\n\n<p>The Localize-ME library adds extra localization features to improve localizing your application. The big difference from the .NET localization is that you keep your existing messages, error strings, etc. in your code (known as the <em>default messages</em>) while .NET localization would replace your messages with a key (referred to as <em>localize key</em>).</p>\n\n\n\n<p>Keeping your existing messages in your application has lots of benefits, but the biggest are a) its easier to add localization an existing application, and b) your code is easier to understand and test.</p>\n\n\n\n<p>To make this work you provide the language (referred to as <em>culture</em>) that your default messages are written in when the Localize-ME library is registered. This allows the Localize-ME services to return the message in your code when the user’s / app’s culture matches the default messages culture. If the user’s / app’s culture isn’t the same as the default messages culture, then it uses the .NET localisation services to lookup the message in the correct resource file for the required culture.</p>\n\n\n\n<p>The diagram below shows this for French (LHS), which isn’t the default messages culture, and English (RHS), which is default messages culture. &nbsp;The <em>blue italic</em> words in the diagram explains the two different routes for the two cultures.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><img loading=\"lazy\" decoding=\"async\" width=\"711\" height=\"460\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/DefaultLocalizerDiagram.png\" alt=\"\" class=\"wp-image-2836\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/DefaultLocalizerDiagram.png 711w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/DefaultLocalizerDiagram-300x194.png 300w\" sizes=\"auto, (max-width: 711px) 100vw, 711px\" /></figure>\n\n\n\n<h2 class=\"wp-block-heading\">Setting the scene – the best places to use the Localize-ME library</h2>\n\n\n\n<p>The Localize-ME library adds two localize services on top of the .NET localization services which provide new (better) ways to localize your application. From my experience I created two services, SimpleLocalizer and DefaultLocalizer, that both localize a message, but works better in different cases. The list below provides my take on where are best used.</p>\n\n\n\n<h3 class=\"wp-block-heading\">1. The SimpleLocalizer service is good for using in Razor pages etc.</h3>\n\n\n\n<p>The SimpleLocalizer service provides the simplest approach to obtaining a localized message. Its features that make it simpler are:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><strong>Auto localize key:</strong> the SimpleLocalizer service uses your message as the lookup key (which I call <em>localise key</em>) which is unique, while the IStringLocalizer needs you to add a string that must be unique to your message.</li>\n\n\n\n<li><strong>Simpler injection</strong>: the SimpleLocalizer’s TResource part (the later <a href=\"https://www.thereformedprogrammer.net/applying-an-improved-multiple-languages-library-to-net-applications/#3-adding-your-resource-files-and-tresource-classes\">section 3</a> describes the TResource part) for what is set on startup so you only need ISimpleLocalizer to get an instance, while the IStringLocalizer needs IStringLocalizer&lt;TResource></li>\n</ul>\n\n\n\n<h3 class=\"wp-block-heading\">2. The DefaultLocalizer service is better on large localizations with backend projects</h3>\n\n\n\n<p>When I started adding localization to a medium size application, I found string constants for the localize key were hard to remember and hence error prone. The DefaultLocalizer service uses extension methods to create the localize key, which has the following benefits:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><strong>Formal localize key design</strong>: The localize key has a {class}, {method} and {localKey}, which tells you what class and method the message came from in your code.</li>\n\n\n\n<li><strong>Auto fill in of {class} &#038; {method}</strong>: the extension methods will fill in the {class} &#038; {method} parts of the localize key for you.</li>\n\n\n\n<li><strong>Short, but unique localize key</strong>: The library has various ways to make short, but unique localize keys. See <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Creating-DefaultLocalization-localize-keys#the-balance-between-readable-localize-key-and-being-unique\">this section</a> from the Localize-ME documentation on how that works.</li>\n</ul>\n\n\n\n<p>The common features of both the SimpleLocalizer and DefaultLocalizer are:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><strong>Your code is easier to understand</strong>: the .NET localization services replace your messages with a localise key. The SimpleLocalizer / DefaultLocalizer services keep your message</li>\n\n\n\n<li><strong>Better missing entry handling</strong>: If the the .NET localization services can’t find the localized message, then it returns the localize key which isn’t that useful to the user. While SimpleLocalizer / DefaultLocalizer services returns the default message, which might be in the wrong language but can translated by the user (it also logs a warning with very detailed information what was missing – see <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/All-about-resource-files#what-happens-when-there-is-a-missing-resource-files--entries\">this section</a> in the Localize-ME documentation.</li>\n</ul>\n\n\n\n<h3 class=\"wp-block-heading\">Things that the Localize-ME library doesn’t provide</h3>\n\n\n\n<p>The .NET localization services contain features that I don’t try to provide in the Localize-ME library. They are:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>The IHtmlLocalizer&lt;T&gt;, which will handle HTML strings</li>\n\n\n\n<li><a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/localization#dataannotations-localization\">DataAnnotations localization</a>, which localizes Data Annotations</li>\n</ul>\n\n\n\n<h2 class=\"wp-block-heading\">Using the Localize-ME library in an ASP.NET Core application</h2>\n\n\n\n<p>The list below contains the eight steps for adding localization to an .NET application, with examples from an ASP.NET Core application. Each step provides a summary and examples for its steps, with links to the <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki\">Localize-ME documentation</a> which contains the more detailed information</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>Setting up the .NET localization</li>\n\n\n\n<li>Setting up the Localize-ME services</li>\n\n\n\n<li>Adding your resource files and TResource classes</li>\n\n\n\n<li>Getting an instance of the SimpleLocalizer</li>\n\n\n\n<li>Getting an instance of the DefaultLocalizer</li>\n\n\n\n<li>Using the SimpleLocalizer service</li>\n\n\n\n<li>Using the DefaultLocalizer service</li>\n\n\n\n<li>How to unit test your localized code</li>\n</ol>\n\n\n\n<h3 class=\"wp-block-heading\">1. Setting up the .NET localization</h3>\n\n\n\n<p>The Localize-ME library relies on the .NET localization services so we start with this (the Localize-ME adds its extra features, which are described later).</p>\n\n\n\n<p>On startup you need to register the .NET localization, its resource files (see <a href=\"https://www.thereformedprogrammer.net/applying-an-improved-multiple-languages-library-to-net-applications/#3-adding-your-resource-files-and-tresource-classes\">section 3</a> later about resource files) and, set up how to obtain the user’s / app’s language (known as <em>culture</em> in .NET). The Localize-ME documentation contains information on how to <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Steps-to-localize-your-ASP.NET-Core-app\">set this within an ASP.NET Core application</a> in some detail with lots of links to useful information and three example applications, so go to that document for the full information</p>\n\n\n\n<p>I did want to point out how the .NET localization obtains user’s / app’s culture, which is needed to return the messages in the correct language. By default the parameter called <a href=\"https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.builder.requestlocalizationoptions.requestcultureproviders\">RequestCultureProviders</a> within the .NET localization options has three ways to try to obtain the culture, which are used in turn until it gets a culture &nbsp;– see list below:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\" start=\"1\">\n<li>QueryStringRequestCultureProvider – uses culture data in the query string, which allows you to create a URL that will set the culture.</li>\n\n\n\n<li>CookieRequestCultureProvider – looks for a culture cookie, which is useful if want users to select the language they want.</li>\n\n\n\n<li>AcceptLanguageHeaderRequestCultureProvider – this picks up data from the browser to set the culture.</li>\n</ol>\n\n\n\n<p>These are the main approaches to get the user / app cultures, and they are <a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/localization#localization-middleware\">described here</a>.</p>\n\n\n\n<h3 class=\"wp-block-heading\">2. Setting up the Localize-ME services</h3>\n\n\n\n<p>I have made the setting up of the Localize-ME library as simple as possible. Here are the two registrations you need to add to your setup code in the Program class.</p>\n\n\n\n<p>The code below registers the DefaultLocalizer – <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Adding-this-library-to-a-ASP.NET-Core-app#adding-the-idefaultlocalizer-service\">click here</a> for information on the two parameters.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\nbuilder.Services.RegisterDefaultLocalizer(\n    &quot;en&quot;, supportedCultures);\n</pre></div>\n\n\n<p>The code below registers the SimpleLocalizer –<a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Adding-this-library-to-a-ASP.NET-Core-app#adding-the-isimplelocalizer-as-a-service\"> click here</a> for information on the optional parameter</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\nbuilder.Services.RegisterSimpleLocalizer\n    &lt;HomeController&gt;();\n</pre></div>\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: The DefaultLocalizer service must be registered for the SimpleLocalizer service to work.</p>\n</blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">3. Adding your resource files and TResource classes</h3>\n\n\n\n<p>Resource files hold the messages, in a specific language, in the <strong>Value</strong> column while the localise key is held in the <strong>Name</strong> column. The .NET localization services uses the culture to pick the correct resource file and then the localize key obtain the correct message to show to the user.</p>\n\n\n\n<p>You link a resource file to your localization service via a class, known as a <em>TResource class</em>, in the ASP.NET Core project. The resource file uses part of the TResource class’s FullName to the start of its filename. For instance, if you used the HomeController class as a TResource class and the language is USA English then the resource file name would be (but see <a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/localization#resource-file-naming\">this link</a> to see the other file formats)</p>\n\n\n\n<p><code>Controllers.HomeController.</code>en-US<code>.resx</code></p>\n\n\n\n<p>Resource files aren’t the easiest part of the localization service, so I suggest you read the Localize-ME <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/All-about-resource-files\">All about resource files</a> documentation. This explains how to register them, and the different ways you can organise the resource files.</p>\n\n\n\n<p>The other problem is finding all the localise keys and the appropriate localized message and then adding into the resource files. I give two approaches that I created when I was applying this library in to my AuthP library. See:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>The <a href=\"https://www.thereformedprogrammer.net/applying-an-improved-multiple-languages-library-to-net-applications/#8a-logging-localize-me-localization-during-unit-testing\">8a section</a> about why logging localization data during unit testing helps you to add entries in the resource files.</li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/#7-tip-use-excel-or-other-app-to-setup-the-data-for-the-resource-files\">Tip: Use Excel (or other app) to setup the data for the resource files</a> from the first article.</li>\n</ul>\n\n\n\n<h3 class=\"wp-block-heading\">4. Getting an instance of the SimpleLocalizer</h3>\n\n\n\n<p>Obtaining an instance of the SimpleLocalizer service is easy, as you have already defined the TResource class on startup.</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>If you are in C# code, then you use the interface ISimpleLocalizer via dependency injection to get SimpleLocalizer service.</li>\n\n\n\n<li>If you are in a Razor page (cshtml), you use “@inject ISimpleLocalizer SimpleLocalizer”.</li>\n</ul>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: See <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Using-the-SimpleLocalizer-methods#getting-an-instance-of-the-isimplelocalizer-service\">this Localize-ME document</a> for example code and more on ISimpleLocalizerFactory service.</p>\n</blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">5. Getting an instance of the DefaultLocalizer</h3>\n\n\n\n<p>The way to get an instance of the DefaultLocalizer service is the same as getting the SimpleLocalizer service, but you need to the TResource class to define which resource file group this service should look up for localized message.</p>\n\n\n\n<p>The simplest approach is to use a dependency injection with the IDefaultLocalizer&lt;TResource&gt; interface, e.g. IDefaultLocalizer&lt;HomeController&gt;.</p>\n\n\n\n<p>But if you have backend code in other projects you can’t do that because the TResource class must be in the ASP.NET Core project and your backend projects can’t link to these TResource because that would create a circular reference. In this case you need the IDefaultLocalizerFactory service and some options.</p>\n\n\n\n<p>To use the IDefaultLocalizerFactory service you need to register singleton class (shown as MyOptions in the code below) which contains the Type of TResource class(es) you need in your backend code, and then use the IDefaultLocalizerFactory service, as shown below within your backend code.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic class MyBackendCode \n{\n    private readonly IDefaultLocalizer _defaultLocalizer;\n\n    /// &lt;summary&gt;\n    /// ctor\n    /// &lt;/summary&gt;\n    public MyBackendCode(MyOptions options,\n        IDefaultLocalizerFactory factory)\n    {\n        _localizeDefault = factory.Create(\n            options.BackendResourceType) \n    }\n    //… rest of class left out\n}\n</pre></div>\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: See the <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Using-the-DefaultLocalizer-methods#getting-an-instance-of-the-idefaultlocalizer-service\">Getting an instance of the IDefaultLocalizer service</a> documentation for more details.</p>\n</blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">6. Using the SimpleLocalizer service</h3>\n\n\n\n<p>The SimpleLocalizer service is simple to use! It only has only two methods and the localise key is derived from the message (see <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Using-the-SimpleLocalizer-methods#how-it-finds-messages-in-other-languages\">this section</a> in the <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Using-the-SimpleLocalizer-methods\">Using SimpleLocalizer</a> documentation on how that works). The first method is shown below and handles a string message.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\n&lt;label for=&quot;month&quot;&gt;\n    @(SimpleLocalizer.LocalizeString(\n        &quot;Provide a string (can be null)&quot;, this))\n&lt;/label&gt;\n</pre></div>\n\n\n<p>The other method shown below handles FormattableStrings, where you can provide dynamic data into the localized message.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\n&lt;h1&gt;\n    @(SimpleLocalizer.LocalizeFormatted(\n       $&quot;List of {Model.NumBooks} books&quot;, this))\n&lt;/h1&gt;\n</pre></div>\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: These two examples come from Razor pages, using the “@inject ISimpleLocalizer SimpleLocalizer” approach, but you can also use dependency injection within a ASP.NET Core Controller or Page.</p>\n</blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">7. Using the DefaultLocalizer service</h3>\n\n\n\n<p>The DefaultLocalizer service has only two methods:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Using-the-DefaultLocalizer-methods#localizestringmessage-method\"><code>LocalizeStringMessage</code> method</a>, which handles string messages, e.g. &#8220;Welcome&#8221;</li>\n\n\n\n<li><a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Using-the-DefaultLocalizer-methods#localizeformattedmessage-method\"><code>LocalizeFormattedMessage</code> method</a>, which handles messages dynamic message, e.g. &#8220;The date is {DateTime.Now:d}&#8221;</li>\n</ul>\n\n\n\n<p>Both methods take in two parts</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>The localize key that uses a formal design that can contain the {callingClass}, {method} and {localKey}.</li>\n\n\n\n<li>The default message, either in a string or a FormattableString.</li>\n</ol>\n\n\n\n<p>The localize key is created by one of the localize key extension methods which contain various combinations of the {callingClass}, {method} and {localKey} &#8211; <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Creating-DefaultLocalization-localize-keys#list-of-localize-key-extension-methods\">this link</a> shows you the various methods / combinations and what situation each one is used for.</p>\n\n\n\n<p>This makes calling a DefaultLocalizer method is a bit more work than the SimpleLocalizer method calls, but the extra effort provides you with a localise key that is easy to understand and easily track back to where you made the localize call.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: There is an interesting section about DefaultLocalizer localize key creation called <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Creating-DefaultLocalization-localize-keys#the-balance-between-readable-localize-key-and-being-unique\">the balance between readable localize key and being unique</a>, which provides two ways to create both short and unique localize keys.</p>\n</blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">8. How to unit test your localized code</h3>\n\n\n\n<p>Once you change your code to use the Localize-ME library, then you will need to provide a ISimpleLocalizer or IDefaultLocalizer service to runs your tests. I recommend using a <em>stubbing out</em> approach (see <a href=\"https://learn.microsoft.com/en-us/visualstudio/test/using-stubs-to-isolate-parts-of-your-application-from-each-other-for-unit-testing\">this Microsoft document</a> about stubbing) in your unit tests as because the stub to return the default message in your code, which makes it easier to update your unit tests and the tests are easier to understand.</p>\n\n\n\n<p>The Localize-ME library contains stubs for the ISimpleLocalizer or IDefaultLocalizer services, called <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/blob/main/LocalizeMessagesAndErrors/UnitTestingCode/StubSimpleLocalizer.cs\"><code>StubSimpleLocalizer</code></a> and <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/blob/main/LocalizeMessagesAndErrors/UnitTestingCode/StubDefaultLocalizer.cs\"><code>StubDefaultLocalizer</code></a> respectively. The code below shows the using StubDefaultLocalizer (the StubSimpleLocalizer works the same)</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\n&#x5B;Fact]\npublic void TestStubDefaultLocalizer()\n{\n    //SETUP\n    var defaultLoc = new StubDefaultLocalizer();\n\n    //ATTEMPT\n    var message = defaultLoc.LocalizeStringMessage(\n        &quot;MyLocalizeKey&quot;.MethodLocalizeKey(this),\n        &quot;My message&quot;);\n\n    //VERIFY\n    message.ShouldEqual(&quot;My message&quot;);\n    defaultLoc.LastKeyData.LocalizeKey.ShouldEqual(\n        &quot;TestStubDefaultLocalizer_MyLocalizeKey&quot;);\n}\n</pre></div>\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: The <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Unit-testing-your-localized-code\">unit testing your localized code</a> document gives more information on the StubSimpleLocalizer and StubDefaultLocalizer classes.</p>\n</blockquote>\n\n\n\n<h4 class=\"wp-block-heading\">8a. Logging Localize-ME localization during unit testing</h4>\n\n\n\n<p>I also created a more powerful IDefaultLocalizer stub called <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/blob/main/Test/StubClasses/StubLocalizeDefaultWithLogging.cs\">StubDefaultLocalizerWithLogging</a>, which returns the default message, which optionally logs the full information of the localization data to a database. This provides a quick way to look at the localized messages, and it can find certain problems.</p>\n\n\n\n<p>This stub is much more complex to use, but it does provide a very useful list of the localised messages. This helps in checking the localize keys and also speeded up the process of building the resource files – see the <a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/#6-i-wanted-to-check-the-localized-messages-with-their-localize-key\">this section from the first article</a> where I explain why I found it so useful, but here is a screenshot of a section of the logged localization data. Note the PossibleErrors column which has found an existing entry in the database with the same localize key, but the message format is different. NOTE Click the screenshot to get a bigger version.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/ExampleLoggingLog.png\"><img loading=\"lazy\" decoding=\"async\" width=\"862\" height=\"409\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/ExampleLoggingLog.png\" alt=\"\" class=\"wp-image-2839\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/ExampleLoggingLog.png 862w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/ExampleLoggingLog-300x142.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/ExampleLoggingLog-768x364.png 768w\" sizes=\"auto, (max-width: 862px) 100vw, 862px\" /></a></figure>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: There is <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Unit-testing-your-localized-code#using-the-stublocalizedefaultwithlogging-class\">detailed documentation</a> about how to setup and use the StubDefaultLocalizerWithLogging class.</p>\n</blockquote>\n\n\n\n<h2 class=\"wp-block-heading\">Conclusions</h2>\n\n\n\n<p>I had a <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/issues/58\">requirement from a developer</a> to add localization to my <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore\">AuthP library</a> so I started looking at .NET localization services. The .NET localization didn’t have the features to provide an <em>optional </em>localization feature (i.e. your code will still works without resource files) to my AuthP library as it was. So, I started to create the Localize-ME library that makes localization optional in my AuthP library.</p>\n\n\n\n<p>Once I knew I had to create a new library, then I could reimagine how I would like to apply localization in a .NET application. For instance, I made it possible to keep your messages are in your non-localized application which means that your code is easier to update and understand. While the .NET localization approach, which would move the messages to the resource files and replace them with a localize key, makes the code (a bit) harder to understand.</p>\n\n\n\n<p>Unfortunately, I didn’t come up a way to remove the manual / tedious job of building resource files, but you might like to look at <a href=\"https://www.thereformedprogrammer.net/applying-an-improved-multiple-languages-library-to-net-applications/#8a-logging-localize-me-localization-during-unit-testing\">section 8a</a> about capturing the localize data while running your unit tests. Personally, I found this very useful in providing the data to help in building resource files.</p>\n\n\n\n<p>Other improvements came as I started to use the Localize-ME library in different ways, from a <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/tree/main/LocalizedWebApp\">test application</a>. updating the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore\">AuthP library</a> and creating another <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example1.RazorPages.IndividualAccounts\">test example</a> in the AuthP library. Each usage was different which highlight different issues, and each issue often provided new approaches or features. This means it took way longer that I thought it would create the library, but I’m pleased with the final result. I hope the Localize-ME library will help you too.</p>\n\n\n\n<p><em>Extra note:</em> I ran a twitter poll on whether users of AuthP library would use the new localization feature the votes were <a href=\"https://twitter.com/thereformedprog/status/1613904709139726337\">10 to 1 in favour</a> of needing the localization feature. This makes sense as the AuthP library’s features is helping developers to create <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Multi-tenant-explained\">multi-tenant applications</a>, which could be used in any country or countries.</p>\n\n\n\n<p>Happy coding.</p>\n",
    "sanitized": "The last article covered why I added extra features to the .NET support of multiple languages  (known as localization in .NET) and via the Net.LocalizeMessagesAndErrors library (shortened to Localize-ME library). This article provides the details of how you would use the Localize-ME library in to add localization to your .NET application. The full list of the articles in this series are:\n\n\n\n\nImproving the support of multiple languages in .NET applications\n\n\n\nApplying the improved multiple languages support to .NET applications (this article)\n\n\n\nA library / pattern for methods that return a status, including localization (coming soon)\n\n\n\n\nTL;DR; – Summary of this article\n\n\n\n\nThis article assumes you know the terms / concepts of localization. If you don’t, then go to the “A brief view of how .NET localization works” which introduces to the localization concepts.\n\n\n\nThe Localize-ME library adds extra localization features focused on a) making it easier to localize an existing application, and b) stop localization from making your code harder to understand.\n\n\n\nThe Localize-ME library provides two servicesSimpleLocalizer service is good in small / simple applications and is simple to use.\n\nDefaultLocalizer service is good from large applications with many localizations because it uses a more formal pattern that makes it easier to find / set up the localized messages.\n\n\n\n\n\nThis article provides eight steps to localize an ASP.NET Core application using either, or both Localize-ME services. Each step provides a summary of what you need to do with links to the Localize-ME documentation for the definitive details.\n\n\n\n\nSuper-quick explanation on the Localize-ME library provides\n\n\n\nThe Localize-ME library adds extra localization features to improve localizing your application. The big difference from the .NET localization is that you keep your existing messages, error strings, etc. in your code (known as the default messages) while .NET localization would replace your messages with a key (referred to as localize key).\n\n\n\nKeeping your existing messages in your application has lots of benefits, but the biggest are a) its easier to add localization an existing application, and b) your code is easier to understand and test.\n\n\n\nTo make this work you provide the language (referred to as culture) that your default messages are written in when the Localize-ME library is registered. This allows the Localize-ME services to return the message in your code when the user’s / app’s culture matches the default messages culture. If the user’s / app’s culture isn’t the same as the default messages culture, then it uses the .NET localisation services to lookup the message in the correct resource file for the required culture.\n\n\n\nThe diagram below shows this for French (LHS), which isn’t the default messages culture, and English (RHS), which is default messages culture.  The blue italic words in the diagram explains the two different routes for the two cultures.\n\n\n\n\n\n\n\nSetting the scene – the best places to use the Localize-ME library\n\n\n\nThe Localize-ME library adds two localize services on top of the .NET localization services which provide new (better) ways to localize your application. From my experience I created two services, SimpleLocalizer and DefaultLocalizer, that both localize a message, but works better in different cases. The list below provides my take on where are best used.\n\n\n\n1. The SimpleLocalizer service is good for using in Razor pages etc.\n\n\n\nThe SimpleLocalizer service provides the simplest approach to obtaining a localized message. Its features that make it simpler are:\n\n\n\n\nAuto localize key: the SimpleLocalizer service uses your message as the lookup key (which I call localise key) which is unique, while the IStringLocalizer needs you to add a string that must be unique to your message.\n\n\n\nSimpler injection: the SimpleLocalizer’s TResource part (the later section 3 describes the TResource part) for what is set on startup so you only need ISimpleLocalizer to get an instance, while the IStringLocalizer needs IStringLocalizer<TResource>\n\n\n\n\n2. The DefaultLocalizer service is better on large localizations with backend projects\n\n\n\nWhen I started adding localization to a medium size application, I found string constants for the localize key were hard to remember and hence error prone. The DefaultLocalizer service uses extension methods to create the localize key, which has the following benefits:\n\n\n\n\nFormal localize key design: The localize key has a {class}, {method} and {localKey}, which tells you what class and method the message came from in your code.\n\n\n\nAuto fill in of {class} & {method}: the extension methods will fill in the {class} & {method} parts of the localize key for you.\n\n\n\nShort, but unique localize key: The library has various ways to make short, but unique localize keys. See this section from the Localize-ME documentation on how that works.\n\n\n\n\nThe common features of both the SimpleLocalizer and DefaultLocalizer are:\n\n\n\n\nYour code is easier to understand: the .NET localization services replace your messages with a localise key. The SimpleLocalizer / DefaultLocalizer services keep your message\n\n\n\nBetter missing entry handling: If the the .NET localization services can’t find the localized message, then it returns the localize key which isn’t that useful to the user. While SimpleLocalizer / DefaultLocalizer services returns the default message, which might be in the wrong language but can translated by the user (it also logs a warning with very detailed information what was missing – see this section in the Localize-ME documentation.\n\n\n\n\nThings that the Localize-ME library doesn’t provide\n\n\n\nThe .NET localization services contain features that I don’t try to provide in the Localize-ME library. They are:\n\n\n\n\nThe IHtmlLocalizer<T>, which will handle HTML strings\n\n\n\nDataAnnotations localization, which localizes Data Annotations\n\n\n\n\nUsing the Localize-ME library in an ASP.NET Core application\n\n\n\nThe list below contains the eight steps for adding localization to an .NET application, with examples from an ASP.NET Core application. Each step provides a summary and examples for its steps, with links to the Localize-ME documentation which contains the more detailed information\n\n\n\n\nSetting up the .NET localization\n\n\n\nSetting up the Localize-ME services\n\n\n\nAdding your resource files and TResource classes\n\n\n\nGetting an instance of the SimpleLocalizer\n\n\n\nGetting an instance of the DefaultLocalizer\n\n\n\nUsing the SimpleLocalizer service\n\n\n\nUsing the DefaultLocalizer service\n\n\n\nHow to unit test your localized code\n\n\n\n\n1. Setting up the .NET localization\n\n\n\nThe Localize-ME library relies on the .NET localization services so we start with this (the Localize-ME adds its extra features, which are described later).\n\n\n\nOn startup you need to register the .NET localization, its resource files (see section 3 later about resource files) and, set up how to obtain the user’s / app’s language (known as culture in .NET). The Localize-ME documentation contains information on how to set this within an ASP.NET Core application in some detail with lots of links to useful information and three example applications, so go to that document for the full information\n\n\n\nI did want to point out how the .NET localization obtains user’s / app’s culture, which is needed to return the messages in the correct language. By default the parameter called RequestCultureProviders within the .NET localization options has three ways to try to obtain the culture, which are used in turn until it gets a culture  – see list below:\n\n\n\n\nQueryStringRequestCultureProvider – uses culture data in the query string, which allows you to create a URL that will set the culture.\n\n\n\nCookieRequestCultureProvider – looks for a culture cookie, which is useful if want users to select the language they want.\n\n\n\nAcceptLanguageHeaderRequestCultureProvider – this picks up data from the browser to set the culture.\n\n\n\n\nThese are the main approaches to get the user / app cultures, and they are described here.\n\n\n\n2. Setting up the Localize-ME services\n\n\n\nI have made the setting up of the Localize-ME library as simple as possible. Here are the two registrations you need to add to your setup code in the Program class.\n\n\n\nThe code below registers the DefaultLocalizer – click here for information on the two parameters.\n\n\n\nbuilder.Services.RegisterDefaultLocalizer(\n    \"en\", supportedCultures);\n\n\n\nThe code below registers the SimpleLocalizer – click here for information on the optional parameter\n\n\n\nbuilder.Services.RegisterSimpleLocalizer\n    <HomeController>();\n\n\n\n\nNOTE: The DefaultLocalizer service must be registered for the SimpleLocalizer service to work.\n\n\n\n\n3. Adding your resource files and TResource classes\n\n\n\nResource files hold the messages, in a specific language, in the Value column while the localise key is held in the Name column. The .NET localization services uses the culture to pick the correct resource file and then the localize key obtain the correct message to show to the user.\n\n\n\nYou link a resource file to your localization service via a class, known as a TResource class, in the ASP.NET Core project. The resource file uses part of the TResource class’s FullName to the start of its filename. For instance, if you used the HomeController class as a TResource class and the language is USA English then the resource file name would be (but see this link to see the other file formats)\n\n\n\nControllers.HomeController.en-US.resx\n\n\n\nResource files aren’t the easiest part of the localization service, so I suggest you read the Localize-ME All about resource files documentation. This explains how to register them, and the different ways you can organise the resource files.\n\n\n\nThe other problem is finding all the localise keys and the appropriate localized message and then adding into the resource files. I give two approaches that I created when I was applying this library in to my AuthP library. See:\n\n\n\n\nThe 8a section about why logging localization data during unit testing helps you to add entries in the resource files.\n\n\n\nTip: Use Excel (or other app) to setup the data for the resource files from the first article.\n\n\n\n\n4. Getting an instance of the SimpleLocalizer\n\n\n\nObtaining an instance of the SimpleLocalizer service is easy, as you have already defined the TResource class on startup.\n\n\n\n\nIf you are in C# code, then you use the interface ISimpleLocalizer via dependency injection to get SimpleLocalizer service.\n\n\n\nIf you are in a Razor page (cshtml), you use “@inject ISimpleLocalizer SimpleLocalizer”.\n\n\n\n\n\nNOTE: See this Localize-ME document for example code and more on ISimpleLocalizerFactory service.\n\n\n\n\n5. Getting an instance of the DefaultLocalizer\n\n\n\nThe way to get an instance of the DefaultLocalizer service is the same as getting the SimpleLocalizer service, but you need to the TResource class to define which resource file group this service should look up for localized message.\n\n\n\nThe simplest approach is to use a dependency injection with the IDefaultLocalizer<TResource> interface, e.g. IDefaultLocalizer<HomeController>.\n\n\n\nBut if you have backend code in other projects you can’t do that because the TResource class must be in the ASP.NET Core project and your backend projects can’t link to these TResource because that would create a circular reference. In this case you need the IDefaultLocalizerFactory service and some options.\n\n\n\nTo use the IDefaultLocalizerFactory service you need to register singleton class (shown as MyOptions in the code below) which contains the Type of TResource class(es) you need in your backend code, and then use the IDefaultLocalizerFactory service, as shown below within your backend code.\n\n\n\npublic class MyBackendCode \n{\n    private readonly IDefaultLocalizer _defaultLocalizer;\n\n    /// <summary>\n    /// ctor\n    /// </summary>\n    public MyBackendCode(MyOptions options,\n        IDefaultLocalizerFactory factory)\n    {\n        _localizeDefault = factory.Create(\n            options.BackendResourceType) \n    }\n    //… rest of class left out\n}\n\n\n\n\nNOTE: See the Getting an instance of the IDefaultLocalizer service documentation for more details.\n\n\n\n\n6. Using the SimpleLocalizer service\n\n\n\nThe SimpleLocalizer service is simple to use! It only has only two methods and the localise key is derived from the message (see this section in the Using SimpleLocalizer documentation on how that works). The first method is shown below and handles a string message.\n\n\n\n<label for=\"month\">\n    @(SimpleLocalizer.LocalizeString(\n        \"Provide a string (can be null)\", this))\n</label>\n\n\n\nThe other method shown below handles FormattableStrings, where you can provide dynamic data into the localized message.\n\n\n\n<h1>\n    @(SimpleLocalizer.LocalizeFormatted(\n       $\"List of {Model.NumBooks} books\", this))\n</h1>\n\n\n\n\nNOTE: These two examples come from Razor pages, using the “@inject ISimpleLocalizer SimpleLocalizer” approach, but you can also use dependency injection within a ASP.NET Core Controller or Page.\n\n\n\n\n7. Using the DefaultLocalizer service\n\n\n\nThe DefaultLocalizer service has only two methods:\n\n\n\n\nLocalizeStringMessage method, which handles string messages, e.g. “Welcome”\n\n\n\nLocalizeFormattedMessage method, which handles messages dynamic message, e.g. “The date is {DateTime.Now:d}”\n\n\n\n\nBoth methods take in two parts\n\n\n\n\nThe localize key that uses a formal design that can contain the {callingClass}, {method} and {localKey}.\n\n\n\nThe default message, either in a string or a FormattableString.\n\n\n\n\nThe localize key is created by one of the localize key extension methods which contain various combinations of the {callingClass}, {method} and {localKey} – this link shows you the various methods / combinations and what situation each one is used for.\n\n\n\nThis makes calling a DefaultLocalizer method is a bit more work than the SimpleLocalizer method calls, but the extra effort provides you with a localise key that is easy to understand and easily track back to where you made the localize call.\n\n\n\n\nNOTE: There is an interesting section about DefaultLocalizer localize key creation called the balance between readable localize key and being unique, which provides two ways to create both short and unique localize keys.\n\n\n\n\n8. How to unit test your localized code\n\n\n\nOnce you change your code to use the Localize-ME library, then you will need to provide a ISimpleLocalizer or IDefaultLocalizer service to runs your tests. I recommend using a stubbing out approach (see this Microsoft document about stubbing) in your unit tests as because the stub to return the default message in your code, which makes it easier to update your unit tests and the tests are easier to understand.\n\n\n\nThe Localize-ME library contains stubs for the ISimpleLocalizer or IDefaultLocalizer services, called StubSimpleLocalizer and StubDefaultLocalizer respectively. The code below shows the using StubDefaultLocalizer (the StubSimpleLocalizer works the same)\n\n\n\n[Fact]\npublic void TestStubDefaultLocalizer()\n{\n    //SETUP\n    var defaultLoc = new StubDefaultLocalizer();\n\n    //ATTEMPT\n    var message = defaultLoc.LocalizeStringMessage(\n        \"MyLocalizeKey\".MethodLocalizeKey(this),\n        \"My message\");\n\n    //VERIFY\n    message.ShouldEqual(\"My message\");\n    defaultLoc.LastKeyData.LocalizeKey.ShouldEqual(\n        \"TestStubDefaultLocalizer_MyLocalizeKey\");\n}\n\n\n\n\nNOTE: The unit testing your localized code document gives more information on the StubSimpleLocalizer and StubDefaultLocalizer classes.\n\n\n\n\n8a. Logging Localize-ME localization during unit testing\n\n\n\nI also created a more powerful IDefaultLocalizer stub called StubDefaultLocalizerWithLogging, which returns the default message, which optionally logs the full information of the localization data to a database. This provides a quick way to look at the localized messages, and it can find certain problems.\n\n\n\nThis stub is much more complex to use, but it does provide a very useful list of the localised messages. This helps in checking the localize keys and also speeded up the process of building the resource files – see the this section from the first article where I explain why I found it so useful, but here is a screenshot of a section of the logged localization data. Note the PossibleErrors column which has found an existing entry in the database with the same localize key, but the message format is different. NOTE Click the screenshot to get a bigger version.\n\n\n\n\n\n\n\n\nNOTE: There is detailed documentation about how to setup and use the StubDefaultLocalizerWithLogging class.\n\n\n\n\nConclusions\n\n\n\nI had a requirement from a developer to add localization to my AuthP library so I started looking at .NET localization services. The .NET localization didn’t have the features to provide an optional localization feature (i.e. your code will still works without resource files) to my AuthP library as it was. So, I started to create the Localize-ME library that makes localization optional in my AuthP library.\n\n\n\nOnce I knew I had to create a new library, then I could reimagine how I would like to apply localization in a .NET application. For instance, I made it possible to keep your messages are in your non-localized application which means that your code is easier to update and understand. While the .NET localization approach, which would move the messages to the resource files and replace them with a localize key, makes the code (a bit) harder to understand.\n\n\n\nUnfortunately, I didn’t come up a way to remove the manual / tedious job of building resource files, but you might like to look at section 8a about capturing the localize data while running your unit tests. Personally, I found this very useful in providing the data to help in building resource files.\n\n\n\nOther improvements came as I started to use the Localize-ME library in different ways, from a test application. updating the AuthP library and creating another test example in the AuthP library. Each usage was different which highlight different issues, and each issue often provided new approaches or features. This means it took way longer that I thought it would create the library, but I’m pleased with the final result. I hope the Localize-ME library will help you too.\n\n\n\nExtra note: I ran a twitter poll on whether users of AuthP library would use the new localization feature the votes were 10 to 1 in favour of needing the localization feature. This makes sense as the AuthP library’s features is helping developers to create multi-tenant applications, which could be used in any country or countries.\n\n\n\nHappy coding."
  },
  {
    "itemId": "https://www.thereformedprogrammer.net/?p=2835",
    "raw": "\n<p>One of users of my <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore\">AuthPermissions.AspNetCore</a><strong> </strong>library (shortened to AuthP in this article) asked for support for multiple languages – known in .NET as <a href=\"https://learn.microsoft.com/en-us/dotnet/core/extensions/localization\"><em>Localization</em></a>. I looked at the .NET localization solution and it lacked some features I needed for my situation. I took some time to work out to use the .NET localization code and in the end, I built a small library called <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors\">Net.LocalizeMessagesAndErrors</a> which wraps the .NET version with a interface that adds a some extra features.</p>\n\n\n\n<p>This article explains how this new library it easier to add / manage multiple languages in your applications, with articles showing how to use this new localization library. The full list of the articles in this series are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>Improving the support of multiple languages in .NET applications (<strong>this article</strong>)</li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/applying-an-improved-multiple-languages-library-to-net-applications/\">Applying an improved multiple languages library to .NET applications</a>.</li>\n\n\n\n<li>A library / pattern for methods that return a status, including localization (coming soon)</li>\n</ol>\n\n\n\n<h2 class=\"wp-block-heading\">TL;DR; – Summary of this article</h2>\n\n\n\n<ul class=\"wp-block-list\">\n<li>This article provides a super-quick introduction to .NET localization feature, as some of the concepts weren’t obvious to me at the start.</li>\n\n\n\n<li>My problem was if I added the .NET localization to my AuthP library, then no one could use the AuthP library unless they had set up the .NET localization with resource files, which is lot of work.</li>\n\n\n\n<li>My solution was to build a service that wraps around the .NET localization service and provides extra features. Specifically, you can build applications without .NET localization, and it will still work. This feature will also help developer who need to add localization to an existing application, as you can apply localization in stages.</li>\n\n\n\n<li>Once I started looking at localization, I found several ways to either make the code easier to understand, or easier to use. The result is the <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors\">Net.LocalizeMessagesAndErrors</a> library<strong>.</strong></li>\n\n\n\n<li>After the quick explanation how the <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors\">Net.LocalizeMessagesAndErrors</a>’s IDefaultLocalizer service works I detail six<strong> </strong>localization<strong> </strong>challenges and how I got around them, plus a tip on how to setup localization resource files. &nbsp;</li>\n</ul>\n\n\n\n<h2 class=\"wp-block-heading\">A brief view of how .NET localization works</h2>\n\n\n\n<p>At first, I was confused by how to support multiple languages because I has no idea what the terms means and how they work together. Therefore, here is a short introduction from me with links at the end to other articles that I found very useful:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><a href=\"https://learn.microsoft.com/en-us/dotnet/core/extensions/localization\"><em>Localization</em></a> means providing different languages, e.g. English, German, Mandarin, in your application – (I like the name <em>Multilingual support</em> as its more obvious, but I use localization because that what Microsoft calls it).</li>\n\n\n\n<li><a href=\"https://learn.microsoft.com/en-us/dotnet/core/extensions/globalization\"><em>Globalization</em></a> is about showing dates and numbers in the correct format, with some compare / order string methods.</li>\n\n\n\n<li>With .NET localization you store the different messages in <a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/localization#resource-files\">resource files</a> in your application. Each resource file has a name based on:<ul><li>A name, usually taken from a class’s Fullname, e.g. Controllers.HomeController</li></ul><ul><li>A name representing the language it contains, eg. “en-GB”</li></ul>\n<ul class=\"wp-block-list\">\n<li>And has extension of .resx.</li>\n</ul>\n</li>\n\n\n\n<li>A resource file has entries with a Name (which I call the <em>localize key</em>) and Value which holds you’re message in the correct language. The Name / Value entries in the resource file works like a dictionary, with the Name being the key.</li>\n\n\n\n<li>You add a resource file for each language (known as <em>culture</em>) and in each resource you would add an entry for each message (Value) you want to show, with a unique localize key (Name) to use as the lookup.</li>\n\n\n\n<li>You also need to setup the localization services – <a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/localization#implement-a-strategy-to-select-the-languageculture-for-each-request\">see this</a> for how to setup an in ASP.NET Core application and the other links below.</li>\n\n\n\n<li>You would get a localize service, like <a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/localization#make-the-apps-content-localizable\">IStringLocalizer&lt;TResource&gt;</a>, to obtain the localized message. There are three parts to get the localised message:<ul><li>The start of the resource filename is defined by the TResource’s FullName.It then adds the current culture Name from the user, cookie, or other source (depends on what you setup).Your .NET service which takes your localize key, e.g. <code>_localizer[“YourKey”]</code>, which return a string containing the entry found in the selected resource file.</li></ul>\n<ul class=\"wp-block-list\">\n<li>You can also have formatted messages, such as $&#8221;Date is {0}&#8221;, which would need extra data, e.g. <code>_localizer[“YourKey”, DateTime.Now]</code>.</li>\n</ul>\n</li>\n</ul>\n\n\n\n<p>Once I understood the names / concepts the Microsoft’s documentation of .NET localization made much more sense to me. Here are links to articles about .NET localization that I found useful:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>Microsoft’s <a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/localization\">ASP.NET Core globalization and localization</a> document – good, but steps are confusing.</li>\n\n\n\n<li><a href=\"https://www.ezzylearning.net/tutorial/building-multilingual-applications-in-asp-net-core\">Building Multilingual Applications in ASP.NET Core</a> – excellent step-by-step article</li>\n\n\n\n<li><a href=\"https://www.codeproject.com/Articles/5324504/Localization-in-ASP-NET-Core-Web-API\">Localization in ASP.NET Core Web API</a> – another excellent step-by-step article (.NET 6)</li>\n\n\n\n<li><a href=\"https://joonasw.net/view/aspnet-core-localization-deep-dive\">ASP.NET Core Localization Deep Dive</a> – shows all the different localization parts</li>\n</ul>\n\n\n\n<h2 class=\"wp-block-heading\">Super-quick explanation on the IDefaultLocalizer works</h2>\n\n\n\n<p>This article is about why I implemented the Net.LocalizeMessagesAndErrors library and what new features that it contains, but here is an overview of the IDefaultLocalizer service to help you understand the extra features this service provides.</p>\n\n\n\n<p>In the nutshell the IDefaultLocalizer service lets you to put strings like <code>“Hello!”</code> or FormattableString like <code>$\"The date is {DateTime.Now}\"</code> in your code (I use the term <em>message</em> for these two types), which makes your code easier to understand. Have look at the diagram below and read the <em>blue italic</em> words which explains how the IDefaultLocalizer service works.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/DefaultLocalizerDiagram.png\"><img loading=\"lazy\" decoding=\"async\" width=\"711\" height=\"460\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/DefaultLocalizerDiagram.png\" alt=\"\" class=\"wp-image-2836\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/DefaultLocalizerDiagram.png 711w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/DefaultLocalizerDiagram-300x194.png 300w\" sizes=\"auto, (max-width: 711px) 100vw, 711px\" /></a></figure>\n\n\n\n<p>This article doesn’t tell you how to use the Net.LocalizeMessagesAndErrors library, but it highlights the main change – there is a message in each call. If you want more information on how use the library then see the “How to add multiple languages to a ASP.NET Core using the Net.LocalizeMessagesAndErrors library” (coming soon) or the <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki\">Net.LocalizeMessagesAndErrors documentation</a>.</p>\n\n\n\n<h2 class=\"wp-block-heading\">The localize challenges I found and how I fixed them in my library</h2>\n\n\n\n<p>I spent a lot of time trying to come up with ways to use the .NET localization to work with my AuthP library, but it just didn’t work for me. Some of the problems were around adding localization to a NuGet package, but the biggest issue was the massive changes I would have to make to the AuthP library if I changed over to .NET localization.</p>\n\n\n\n<p>The list below gives the localize challenges I found and how I overcame them. The list is in order with the biggest challenges first. They are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li><a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/#1-i-didnt-want-to-turn-all-the-messages-errors-into-just-a-localize-key\">I didn’t want to turn all the messages / errors into just a localize key</a>.</li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/#2-i-wanted-a-nuget-that-works-without-having-to-setup-the-net-localization\">I wanted a NuGet that works without having to setup the .NET localization</a>.</li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/#3-i-didnt-like-nets-localizations-handling-of-missing-resource-files-entries\">I didn’t like .NET’s localization’s handling of missing resource files / entries</a>.</li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/#4-i-wanted-a-better-format-for-the-localise-key-to-help-creating-unique-strings\">I wanted a better format for the localise key to help creating unique strings</a>.</li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/#5-i-wanted-to-unit-test-without-setting-up-localization\">I wanted to unit test without setting up localization</a>.</li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/#6-i-wanted-to-check-the-localized-messages-with-their-localize-key\">I wanted to check the localized messages with their localize key</a>.</li>\n\n\n\n<li><a href=\"https://www.thereformedprogrammer.net/improving-the-support-of-multiple-languages-in-net-applications/#7-tip-use-excel-or-other-app-to-setup-the-data-for-the-resource-files\">Tip: Use Excel (or other app) to setup the data for the resource files</a>.</li>\n</ol>\n\n\n\n<h3 class=\"wp-block-heading\">1. I didn’t want to turn all the messages / errors into just a localize key</h3>\n\n\n\n<p>As of version 4.0.0 of the AuthP library has 100+ messages over five projects. Most of these messages are error messages while the rest are success messages. Here are an example of success and error message:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><code>\"Successfully added the new user.\"</code></li>\n\n\n\n<li><code>$\"There is already a Role with the name of {0}\"</code></li>\n</ul>\n\n\n\n<p>If I used .NET localization these messages would be turned into a localize key, which from my view has the following downsides:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>The messages make great comments and turning into just a localise key messages would make the code harder to understand.</li>\n\n\n\n<li>It’s a lot of work to move these messages to a resource file, and the messages are much harder to update.</li>\n</ul>\n\n\n\n<p>My solution was to leave the current success / error messages where they are and define them as generic English (culture “en”) – I call these messages as <em>default messages</em>. I already have a common pattern for my methods / services which handles success and error message, so it was easy to update the code to pass the default messages to my localization wrapper called <em>DefaultLocalizer</em>. The process the DefaultLocalizer follows are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>On registration of the DefaultLocalizer service, I define the culture of the <em>default messages</em>, in this case “en”.</li>\n\n\n\n<li>If the user’s / app’s culture started with default culture, then the default message is returned without having to use the .NET localization.</li>\n\n\n\n<li>If the user’s / app’s culture doesn’t start with default culture, the DefaultLocalizer service uses the .NET localization to obtain the message from the resource files.</li>\n</ol>\n\n\n\n<p>Here is an example of my improved common method to handle localization showing a success message and an error message.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: plain; title: ; notranslate\">\npublic class ExamplesOfStatusGenericsLoc&lt;TResource&gt;\n{\n    private readonly IDefaultLocalizer&lt;TResource&gt; \n        _defaultLocalizer;\n\n    public ExamplesOfStatusGenericsLoc(\n        IDefaultLocalizer&lt;TResource&gt; defaultLocalizer)\n    {\n        _defaultLocalizer = defaultLocalizer;\n    }\n\n    public IStatusGeneric CheckNull(string? month)\n    {\n        var status = new StatusGenericLocalizer(_defaultLocalizer);\n        status.SetMessageString(\n            &quot;Success&quot;.ClassMethodLocalizeKey(this, false), \n            &quot;Successful completion.&quot;);\n\n        if (month == null)\n            return status.AddErrorString(\n                &quot;NullParam&quot;.JustThisLocalizeKey(this), \n                &quot;The input must not be null.&quot;);\n\n        return status;\n    }\n//...rest of class left out\n</pre></div>\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: If any errors are added to the status, then the Message is changed to “Failed with {n} errors”. That’s just in case the success Message is incorrectly shown.</p>\n</blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">2. I wanted a NuGet that works without having to setup the .NET localization</h3>\n\n\n\n<p>If I just applied the .NET localization to the AuthP NuGet library, it would mean everyone that used this library they would have to set up .NET localization with resources etc. The library is already complex and with the extra needed to understand / setup .NET localization would put off developers from using this library.</p>\n\n\n\n<p>The solution I added is into the DefaultLocalizer service is to return the default message if the .NET localization hasn’t been setup. This means when the localization version of the AuthP library is released:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>The AuthP library doesn’t get any more complex unless the developer what’s to use this new localization feature.</li>\n\n\n\n<li>Developers that are already using the AuthP library can upgrade to the localization version without needing to change their code.</li>\n</ul>\n\n\n\n<p>I hate to think what new and existing users would think if they had to set up .NET localization to use the AuthP library!</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\">\n<p>NOTE: You might not be creating a NuGet like I has, but if you are adding localization to an existing application, then this approach allows you to add localization in stages. That might be pretty useful.</p>\n</blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">3. I didn’t like .NET’s localization’s handling of missing resource files / entries</h3>\n\n\n\n<p>The .NET localization will return the localize key if no entry is found in the resource files. This typically doesn’t provide a good experience for the user. The DefaultLocalizer service can provide the default message which isn’t in the correct language, but easy for the user to translate.</p>\n\n\n\n<p>The other issue of missing resource files / entries is reporting. The NET localization does provide a ResourceNotFound parameter, which will be true if the localized message isn’t found, but if you want a log / event then you need to add that to each localization call. On the other hand, the DefaultLocalizer service provides a very detailed log – a example is shown below.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: plain; title: ; notranslate\">\nThe message with the localizeKey name of \n'MissingResourceEntry_MissingEntry' \nand culture of 'fr' was not found in the \nLocalizedWebApp.Resources.Controllers.HomeController' \nresource. \nThe message came from \nDefaultLocalizerController.MissingResourceEntry, line 38.\n</pre></div>\n\n\n<p>This provides everything you need to correct this problem, including the class, method, and line number of where the localization came from.</p>\n\n\n\n<h3 class=\"wp-block-heading\">4. I wanted a better format for the localise key to help creating unique strings</h3>\n\n\n\n<p>The .NET localization service allows you to use any string as the localize key, and its up to you to make sure it is unique. You can use string constants, e.g. &#8220;HelloMessage&#8221; for the localise key, but when I build (and used!) the DefaultLocalizer service I found string constants were hard work and error prone.</p>\n\n\n\n<p>My view is that string constants are fine for small applications, but for larger applications the localize key needs a standard format and methods to help the developer to create unique localize keys quickly. My solution has a format of <code>“{className}_{methodName}_{localKey}”</code>, with the className and methodName being optional. The table below shows are three main versions that are used, with the first one used on 90% cases.</p>\n\n\n\n<figure class=\"wp-block-table\"><table><tbody><tr><td>Localise key string</td><td>Unique</td></tr><tr><td>“MyClass_MyMethod_SetByDev”</td><td>Unique in the class and method – most used</td></tr><tr><td>“MyClass_SetByDev”</td><td>Unique in the class – useful for common errors</td></tr><tr><td>“SetByDev”</td><td>It’s the developer’s job to ensure it is unique</td></tr></tbody></table></figure>\n\n\n\n<p>To implement this localize key format I have created a set of extension methods that can automatically fills in the “{className}” and “{methodName}” for you. This has two advantages:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li>Easier for the developer to create a unique localize key.</li>\n\n\n\n<li>The developer can work out where the localize key was created.</li>\n\n\n\n<li>You can cut / paste your localize code and the localise key will automatically change to the new class &#038; method parts of the localize key.</li>\n</ul>\n\n\n\n<p>Here are two examples taken from the ExamplesOfStatusGenericsLoc method shown earlier in this article:</p>\n\n\n\n<ul class=\"wp-block-list\">\n<li><code>\"Success\".ClassMethodLocalizeKey(this, false)</code></li>\n\n\n\n<li><code>\"NullParam\".JustThisLocalizeKey(this),</code></li>\n</ul>\n\n\n\n<p>You can get a full set of the extension methods in the “<a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Creating-DefaultLocalization-localize-keys\">Creating localize keys</a>”  document also cover some of the problems and solutions of the balance between readable localize key and being unique in <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Creating-DefaultLocalization-localize-keys#the-balance-between-readable-localize-key-and-being-unique\">this section</a>.</p>\n\n\n\n<h3 class=\"wp-block-heading\">5. I wanted to unit test without setting up localization.</h3>\n\n\n\n<p>As I said the AuthP library has five project containing code and I have nearly 400 unit tests, of which a third check errors or success messages. If I used .NET’s localization on its own, then I could easily stub out (see <a href=\"https://learn.microsoft.com/en-us/visualstudio/test/using-stubs-to-isolate-parts-of-your-application-from-each-other-for-unit-testing\">this Microsoft document</a> about stubbing) the .NET’s localize methods but would still have to change many of the unit tests to use the localize key instead of the actual error / success messages. It’s more work and makes the unit tests less easy to understand as the actual error / success strings are gone.</p>\n\n\n\n<p>Because the DefaultLocalizer can return the default messages it’s easy to create a DefaultLocalizer&nbsp; stub can return the actual error / success strings. The Net.LocalizeMessagesAndErrors repro contains several stubs, but in this case, you need the StubDefaultLocalizer class.</p>\n\n\n\n<p>The <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/blob/main/LocalizeMessagesAndErrors/UnitTestingCode/StubDefaultLocalizer.cs\">StubDefaultLocalizer</a> class has the same methods as the DefaultLocalizer class, but it a) returns the default message, and b) holds the localize key data of the last localize. This allows the unit test to continue in the same way, but if I want to you can check on the localizer key. See the code below which shows how the StubDefaultLocalizer class works.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\n&#x5B;Fact]\npublic void TestStubDefaultLocalizer()\n{\n    //SETUP\n    var defaultLoc = new StubDefaultLocalizer();\n\n    //ATTEMPT\n    var message = defaultLoc.LocalizeStringMessage(\n        &quot;MyLocalizeKey&quot;.MethodLocalizeKey(this),\n        &quot;My message&quot;);\n\n    //VERIFY\n    message.ShouldEqual(&quot;My message&quot;);\n    defaultLoc.LastKeyData.LocalizeKey.ShouldEqual(\n        &quot;TestStubDefaultLocalizer_MyLocalizeKey&quot;);\n}\n</pre></div>\n\n\n<p>This works fine, but I found another type of stub that solved another issue I came across, as described in the next section.</p>\n\n\n\n<h3 class=\"wp-block-heading\">6. I wanted to check the localized messages with their localize key</h3>\n\n\n\n<p>Once I starting to localize my AuthP library, which has ~110 localization I soon found I really needed an overview of all the localizations to check on localise key uniqueness, format, duplicates etc. Stepping though the code to fine each message is hard work and its easy to miss one.</p>\n\n\n\n<p>So, I thought – can I write the localize information to a database when running my unit tests. At that point I created <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/blob/main/Test/StubClasses/StubLocalizeDefaultWithLogging.cs\">StubDefaultLocalizerWithLogging</a> class, which returns the default message, but (optionally) logs the full information of the localization data to a database. This provides a quick way to look at the localized messages, and it can find certain problems.</p>\n\n\n\n<p>For each use of a DefaultLocalizer usage it logs the localize key, culture, the message and where the localised entry was created (the full list of what is in the log can be found in the <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/blob/main/LocalizeMessagesAndErrors/LocalizedLog.cs\">LocalizedLog</a> class, which has 9 parameters).</p>\n\n\n\n<p>The screenshot below is a section of the logged localization data. Note the PossibleErrors column which has found an existing entry in the database with the same localize key, but the message format is different. NOTE Click the screenshot to get a bigger version.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/ExampleLoggingLog.png\"><img loading=\"lazy\" decoding=\"async\" width=\"862\" height=\"409\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/ExampleLoggingLog.png\" alt=\"\" class=\"wp-image-2839\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/ExampleLoggingLog.png 862w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/ExampleLoggingLog-300x142.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2023/01/ExampleLoggingLog-768x364.png 768w\" sizes=\"auto, (max-width: 862px) 100vw, 862px\" /></a></figure>\n\n\n\n<p>I have found quite a few of localization issues by looking through the sorted data. I also I found the logged list very useful when building resource files for other languages because it gives me the Name (localize key) and the Value (string / format) that needs translating. My unit tests only find 75 localized messages when in fact that there are ~110 localized messages. For the 35 localize message ones that aren’t logged I had to go three extra steps to set up the entry in the resource file(s):</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\">\n<li>Find the code that created the localized message.</li>\n\n\n\n<li>Work out what the localize key is.</li>\n\n\n\n<li>Copy the message format.</li>\n</ol>\n\n\n\n<p>These three manual steps are tedious and error prone. It enough to make me improve my unit test coverage <img src=\"https://s.w.org/images/core/emoji/16.0.1/72x72/1f60a.png\" alt=\"😊\" class=\"wp-smiley\" style=\"height: 1em; max-height: 1em;\" />.</p>\n\n\n\n<p>The only downside of logging to a database is the unit tests are slower &#8211; in the Net.LocalizeMessagesAndErrors library that has ~100 the unit tests which take ~1.5 seconds without logging to the database, but ~2 seconds with logging to the database. In the AuthP library, which has nearly 400 tests the difference between log to database being on / off is a smaller percentage.</p>\n\n\n\n<p>Thankfully you can turn the database logging on or off by setting the `SaveLocalizesToDb` to true or false respectively – see the documentation for the StubDefaultLocalizerWithLogging <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki/Unit-testing-your-localized-code#using-the-stublocalizedefaultwithlogging-class\">here</a>.</p>\n\n\n\n<h3 class=\"wp-block-heading\">7. Tip: Use Excel (or other app) to setup the data for the resource files.</h3>\n\n\n\n<p>This isn’t anything to do using DefaultLocalizer, but I found that adding entries to a resource files isn’t a nice process in Visual Studio (VS Code, with the <a href=\"https://marketplace.visualstudio.com/items?itemName=DominicVonk.vscode-resx-editor\">ResX Editor extension</a>, is better). In the end used Excel to entry the resource Name / Value and then turn in into a .csv file. The code below (taken from my AuthP repo) converts CVS to a resource file.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic void CreateResxFileFromCSV()\n{\n    var csvFilePath = &quot;filepath to csv file&quot;;\n    var resxFilePath = &quot;filepath to EMPTY resource file&quot;;\n    \n    //see https://joshclose.github.io/CsvHelper/getting-started/#reading-a-csv-file\n    using (var reader = new StreamReader(csvFilePath))\n    using (var csv = new CsvReader(reader, \n          CultureInfo.InvariantCulture))\n    {\n        var records = csv.GetRecords&lt;CsvInputOfResx&gt;();\n        //see https://learn.microsoft.com/en-us/dotnet/core/extensions/work-with-resx-files-programmatically#create-a-resx-fil\n\n        using (ResXResourceWriter writer = \n             new ResXResourceWriter(@resxFilePath))\n        {\n            foreach (var entry in records)\n            {\n                writer.AddResource(entry.Name, entry.Value);\n            }\n        }\n    }\n}\n</pre></div>\n\n\n<p>I find this is especially useful if you need to change / add to your resource file, as its much easier to search / change in Excel.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Conclusions</h2>\n\n\n\n<p>The Net.LocalizeMessagesAndErrors is relatively small (the DefaultLocalizer is only has ~100 lines of code), but it took me more than five weeks of work! That’s because when I started to use the library I found a load of improvement – I got to local version 1.0.0-preview034 before I had finished. The result is that the library is much easier to use when updating an existing application to support multiple languages, and hopefully nicer to work with.</p>\n\n\n\n<p>The changes I added came from applying the library to a) my AuthP library, b) adding a demo ASP.NET Core app within the library repo (see <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/tree/main/LocalizedWebApp\">LocalizedWebApp</a>), c) localizing the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example1.RazorPages.IndividualAccounts\">Example1 ASP.NET Core in my AuthP library</a> and d) writing the <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki\">Net.LocalizeMessagesAndErrors documentation</a> (writing the docs always shows me any bad interfaces).</p>\n\n\n\n<p>In the following articles I will show how to use the Net.LocalizeMessagesAndErrors library to build localized .NET applications. There also good <a href=\"https://github.com/JonPSmith/Net.LocalizeMessagesAndErrors/wiki\">documentation for this library</a> now that contains all the details if you want to try it out now.</p>\n\n\n\n<p>Happy coding.</p>\n",
    "sanitized": "One of users of my AuthPermissions.AspNetCore library (shortened to AuthP in this article) asked for support for multiple languages – known in .NET as Localization. I looked at the .NET localization solution and it lacked some features I needed for my situation. I took some time to work out to use the .NET localization code and in the end, I built a small library called Net.LocalizeMessagesAndErrors which wraps the .NET version with a interface that adds a some extra features.\n\n\n\nThis article explains how this new library it easier to add / manage multiple languages in your applications, with articles showing how to use this new localization library. The full list of the articles in this series are:\n\n\n\n\nImproving the support of multiple languages in .NET applications (this article)\n\n\n\nApplying an improved multiple languages library to .NET applications.\n\n\n\nA library / pattern for methods that return a status, including localization (coming soon)\n\n\n\n\nTL;DR; – Summary of this article\n\n\n\n\nThis article provides a super-quick introduction to .NET localization feature, as some of the concepts weren’t obvious to me at the start.\n\n\n\nMy problem was if I added the .NET localization to my AuthP library, then no one could use the AuthP library unless they had set up the .NET localization with resource files, which is lot of work.\n\n\n\nMy solution was to build a service that wraps around the .NET localization service and provides extra features. Specifically, you can build applications without .NET localization, and it will still work. This feature will also help developer who need to add localization to an existing application, as you can apply localization in stages.\n\n\n\nOnce I started looking at localization, I found several ways to either make the code easier to understand, or easier to use. The result is the Net.LocalizeMessagesAndErrors library.\n\n\n\nAfter the quick explanation how the Net.LocalizeMessagesAndErrors’s IDefaultLocalizer service works I detail six localization challenges and how I got around them, plus a tip on how to setup localization resource files.  \n\n\n\n\nA brief view of how .NET localization works\n\n\n\nAt first, I was confused by how to support multiple languages because I has no idea what the terms means and how they work together. Therefore, here is a short introduction from me with links at the end to other articles that I found very useful:\n\n\n\n\nLocalization means providing different languages, e.g. English, German, Mandarin, in your application – (I like the name Multilingual support as its more obvious, but I use localization because that what Microsoft calls it).\n\n\n\nGlobalization is about showing dates and numbers in the correct format, with some compare / order string methods.\n\n\n\nWith .NET localization you store the different messages in resource files in your application. Each resource file has a name based on:A name, usually taken from a class’s Fullname, e.g. Controllers.HomeControllerA name representing the language it contains, eg. “en-GB”\n\nAnd has extension of .resx.\n\n\n\n\n\nA resource file has entries with a Name (which I call the localize key) and Value which holds you’re message in the correct language. The Name / Value entries in the resource file works like a dictionary, with the Name being the key.\n\n\n\nYou add a resource file for each language (known as culture) and in each resource you would add an entry for each message (Value) you want to show, with a unique localize key (Name) to use as the lookup.\n\n\n\nYou also need to setup the localization services – see this for how to setup an in ASP.NET Core application and the other links below.\n\n\n\nYou would get a localize service, like IStringLocalizer<TResource>, to obtain the localized message. There are three parts to get the localised message:The start of the resource filename is defined by the TResource’s FullName.It then adds the current culture Name from the user, cookie, or other source (depends on what you setup).Your .NET service which takes your localize key, e.g. _localizer[“YourKey”], which return a string containing the entry found in the selected resource file.\n\nYou can also have formatted messages, such as $”Date is {0}”, which would need extra data, e.g. _localizer[“YourKey”, DateTime.Now].\n\n\n\n\n\n\nOnce I understood the names / concepts the Microsoft’s documentation of .NET localization made much more sense to me. Here are links to articles about .NET localization that I found useful:\n\n\n\n\nMicrosoft’s ASP.NET Core globalization and localization document – good, but steps are confusing.\n\n\n\nBuilding Multilingual Applications in ASP.NET Core – excellent step-by-step article\n\n\n\nLocalization in ASP.NET Core Web API – another excellent step-by-step article (.NET 6)\n\n\n\nASP.NET Core Localization Deep Dive – shows all the different localization parts\n\n\n\n\nSuper-quick explanation on the IDefaultLocalizer works\n\n\n\nThis article is about why I implemented the Net.LocalizeMessagesAndErrors library and what new features that it contains, but here is an overview of the IDefaultLocalizer service to help you understand the extra features this service provides.\n\n\n\nIn the nutshell the IDefaultLocalizer service lets you to put strings like “Hello!” or FormattableString like $\"The date is {DateTime.Now}\" in your code (I use the term message for these two types), which makes your code easier to understand. Have look at the diagram below and read the blue italic words which explains how the IDefaultLocalizer service works.\n\n\n\n\n\n\n\nThis article doesn’t tell you how to use the Net.LocalizeMessagesAndErrors library, but it highlights the main change – there is a message in each call. If you want more information on how use the library then see the “How to add multiple languages to a ASP.NET Core using the Net.LocalizeMessagesAndErrors library” (coming soon) or the Net.LocalizeMessagesAndErrors documentation.\n\n\n\nThe localize challenges I found and how I fixed them in my library\n\n\n\nI spent a lot of time trying to come up with ways to use the .NET localization to work with my AuthP library, but it just didn’t work for me. Some of the problems were around adding localization to a NuGet package, but the biggest issue was the massive changes I would have to make to the AuthP library if I changed over to .NET localization.\n\n\n\nThe list below gives the localize challenges I found and how I overcame them. The list is in order with the biggest challenges first. They are:\n\n\n\n\nI didn’t want to turn all the messages / errors into just a localize key.\n\n\n\nI wanted a NuGet that works without having to setup the .NET localization.\n\n\n\nI didn’t like .NET’s localization’s handling of missing resource files / entries.\n\n\n\nI wanted a better format for the localise key to help creating unique strings.\n\n\n\nI wanted to unit test without setting up localization.\n\n\n\nI wanted to check the localized messages with their localize key.\n\n\n\nTip: Use Excel (or other app) to setup the data for the resource files.\n\n\n\n\n1. I didn’t want to turn all the messages / errors into just a localize key\n\n\n\nAs of version 4.0.0 of the AuthP library has 100+ messages over five projects. Most of these messages are error messages while the rest are success messages. Here are an example of success and error message:\n\n\n\n\n\"Successfully added the new user.\"\n\n\n\n$\"There is already a Role with the name of {0}\"\n\n\n\n\nIf I used .NET localization these messages would be turned into a localize key, which from my view has the following downsides:\n\n\n\n\nThe messages make great comments and turning into just a localise key messages would make the code harder to understand.\n\n\n\nIt’s a lot of work to move these messages to a resource file, and the messages are much harder to update.\n\n\n\n\nMy solution was to leave the current success / error messages where they are and define them as generic English (culture “en”) – I call these messages as default messages. I already have a common pattern for my methods / services which handles success and error message, so it was easy to update the code to pass the default messages to my localization wrapper called DefaultLocalizer. The process the DefaultLocalizer follows are:\n\n\n\n\nOn registration of the DefaultLocalizer service, I define the culture of the default messages, in this case “en”.\n\n\n\nIf the user’s / app’s culture started with default culture, then the default message is returned without having to use the .NET localization.\n\n\n\nIf the user’s / app’s culture doesn’t start with default culture, the DefaultLocalizer service uses the .NET localization to obtain the message from the resource files.\n\n\n\n\nHere is an example of my improved common method to handle localization showing a success message and an error message.\n\n\n\npublic class ExamplesOfStatusGenericsLoc<TResource>\n{\n    private readonly IDefaultLocalizer<TResource> \n        _defaultLocalizer;\n\n    public ExamplesOfStatusGenericsLoc(\n        IDefaultLocalizer<TResource> defaultLocalizer)\n    {\n        _defaultLocalizer = defaultLocalizer;\n    }\n\n    public IStatusGeneric CheckNull(string? month)\n    {\n        var status = new StatusGenericLocalizer(_defaultLocalizer);\n        status.SetMessageString(\n            \"Success\".ClassMethodLocalizeKey(this, false), \n            \"Successful completion.\");\n\n        if (month == null)\n            return status.AddErrorString(\n                \"NullParam\".JustThisLocalizeKey(this), \n                \"The input must not be null.\");\n\n        return status;\n    }\n//...rest of class left out\n\n\n\n\nNOTE: If any errors are added to the status, then the Message is changed to “Failed with {n} errors”. That’s just in case the success Message is incorrectly shown.\n\n\n\n\n2. I wanted a NuGet that works without having to setup the .NET localization\n\n\n\nIf I just applied the .NET localization to the AuthP NuGet library, it would mean everyone that used this library they would have to set up .NET localization with resources etc. The library is already complex and with the extra needed to understand / setup .NET localization would put off developers from using this library.\n\n\n\nThe solution I added is into the DefaultLocalizer service is to return the default message if the .NET localization hasn’t been setup. This means when the localization version of the AuthP library is released:\n\n\n\n\nThe AuthP library doesn’t get any more complex unless the developer what’s to use this new localization feature.\n\n\n\nDevelopers that are already using the AuthP library can upgrade to the localization version without needing to change their code.\n\n\n\n\nI hate to think what new and existing users would think if they had to set up .NET localization to use the AuthP library!\n\n\n\n\nNOTE: You might not be creating a NuGet like I has, but if you are adding localization to an existing application, then this approach allows you to add localization in stages. That might be pretty useful.\n\n\n\n\n3. I didn’t like .NET’s localization’s handling of missing resource files / entries\n\n\n\nThe .NET localization will return the localize key if no entry is found in the resource files. This typically doesn’t provide a good experience for the user. The DefaultLocalizer service can provide the default message which isn’t in the correct language, but easy for the user to translate.\n\n\n\nThe other issue of missing resource files / entries is reporting. The NET localization does provide a ResourceNotFound parameter, which will be true if the localized message isn’t found, but if you want a log / event then you need to add that to each localization call. On the other hand, the DefaultLocalizer service provides a very detailed log – a example is shown below.\n\n\n\nThe message with the localizeKey name of \n'MissingResourceEntry_MissingEntry' \nand culture of 'fr' was not found in the \nLocalizedWebApp.Resources.Controllers.HomeController' \nresource. \nThe message came from \nDefaultLocalizerController.MissingResourceEntry, line 38.\n\n\n\nThis provides everything you need to correct this problem, including the class, method, and line number of where the localization came from.\n\n\n\n4. I wanted a better format for the localise key to help creating unique strings\n\n\n\nThe .NET localization service allows you to use any string as the localize key, and its up to you to make sure it is unique. You can use string constants, e.g. “HelloMessage” for the localise key, but when I build (and used!) the DefaultLocalizer service I found string constants were hard work and error prone.\n\n\n\nMy view is that string constants are fine for small applications, but for larger applications the localize key needs a standard format and methods to help the developer to create unique localize keys quickly. My solution has a format of “{className}_{methodName}_{localKey}”, with the className and methodName being optional. The table below shows are three main versions that are used, with the first one used on 90% cases.\n\n\n\nLocalise key stringUnique“MyClass_MyMethod_SetByDev”Unique in the class and method – most used“MyClass_SetByDev”Unique in the class – useful for common errors“SetByDev”It’s the developer’s job to ensure it is unique\n\n\n\nTo implement this localize key format I have created a set of extension methods that can automatically fills in the “{className}” and “{methodName}” for you. This has two advantages:\n\n\n\n\nEasier for the developer to create a unique localize key.\n\n\n\nThe developer can work out where the localize key was created.\n\n\n\nYou can cut / paste your localize code and the localise key will automatically change to the new class & method parts of the localize key.\n\n\n\n\nHere are two examples taken from the ExamplesOfStatusGenericsLoc method shown earlier in this article:\n\n\n\n\n\"Success\".ClassMethodLocalizeKey(this, false)\n\n\n\n\"NullParam\".JustThisLocalizeKey(this),\n\n\n\n\nYou can get a full set of the extension methods in the “Creating localize keys”  document also cover some of the problems and solutions of the balance between readable localize key and being unique in this section.\n\n\n\n5. I wanted to unit test without setting up localization.\n\n\n\nAs I said the AuthP library has five project containing code and I have nearly 400 unit tests, of which a third check errors or success messages. If I used .NET’s localization on its own, then I could easily stub out (see this Microsoft document about stubbing) the .NET’s localize methods but would still have to change many of the unit tests to use the localize key instead of the actual error / success messages. It’s more work and makes the unit tests less easy to understand as the actual error / success strings are gone.\n\n\n\nBecause the DefaultLocalizer can return the default messages it’s easy to create a DefaultLocalizer  stub can return the actual error / success strings. The Net.LocalizeMessagesAndErrors repro contains several stubs, but in this case, you need the StubDefaultLocalizer class.\n\n\n\nThe StubDefaultLocalizer class has the same methods as the DefaultLocalizer class, but it a) returns the default message, and b) holds the localize key data of the last localize. This allows the unit test to continue in the same way, but if I want to you can check on the localizer key. See the code below which shows how the StubDefaultLocalizer class works.\n\n\n\n[Fact]\npublic void TestStubDefaultLocalizer()\n{\n    //SETUP\n    var defaultLoc = new StubDefaultLocalizer();\n\n    //ATTEMPT\n    var message = defaultLoc.LocalizeStringMessage(\n        \"MyLocalizeKey\".MethodLocalizeKey(this),\n        \"My message\");\n\n    //VERIFY\n    message.ShouldEqual(\"My message\");\n    defaultLoc.LastKeyData.LocalizeKey.ShouldEqual(\n        \"TestStubDefaultLocalizer_MyLocalizeKey\");\n}\n\n\n\nThis works fine, but I found another type of stub that solved another issue I came across, as described in the next section.\n\n\n\n6. I wanted to check the localized messages with their localize key\n\n\n\nOnce I starting to localize my AuthP library, which has ~110 localization I soon found I really needed an overview of all the localizations to check on localise key uniqueness, format, duplicates etc. Stepping though the code to fine each message is hard work and its easy to miss one.\n\n\n\nSo, I thought – can I write the localize information to a database when running my unit tests. At that point I created StubDefaultLocalizerWithLogging class, which returns the default message, but (optionally) logs the full information of the localization data to a database. This provides a quick way to look at the localized messages, and it can find certain problems.\n\n\n\nFor each use of a DefaultLocalizer usage it logs the localize key, culture, the message and where the localised entry was created (the full list of what is in the log can be found in the LocalizedLog class, which has 9 parameters).\n\n\n\nThe screenshot below is a section of the logged localization data. Note the PossibleErrors column which has found an existing entry in the database with the same localize key, but the message format is different. NOTE Click the screenshot to get a bigger version.\n\n\n\n\n\n\n\nI have found quite a few of localization issues by looking through the sorted data. I also I found the logged list very useful when building resource files for other languages because it gives me the Name (localize key) and the Value (string / format) that needs translating. My unit tests only find 75 localized messages when in fact that there are ~110 localized messages. For the 35 localize message ones that aren’t logged I had to go three extra steps to set up the entry in the resource file(s):\n\n\n\n\nFind the code that created the localized message.\n\n\n\nWork out what the localize key is.\n\n\n\nCopy the message format.\n\n\n\n\nThese three manual steps are tedious and error prone. It enough to make me improve my unit test coverage .\n\n\n\nThe only downside of logging to a database is the unit tests are slower – in the Net.LocalizeMessagesAndErrors library that has ~100 the unit tests which take ~1.5 seconds without logging to the database, but ~2 seconds with logging to the database. In the AuthP library, which has nearly 400 tests the difference between log to database being on / off is a smaller percentage.\n\n\n\nThankfully you can turn the database logging on or off by setting the `SaveLocalizesToDb` to true or false respectively – see the documentation for the StubDefaultLocalizerWithLogging here.\n\n\n\n7. Tip: Use Excel (or other app) to setup the data for the resource files.\n\n\n\nThis isn’t anything to do using DefaultLocalizer, but I found that adding entries to a resource files isn’t a nice process in Visual Studio (VS Code, with the ResX Editor extension, is better). In the end used Excel to entry the resource Name / Value and then turn in into a .csv file. The code below (taken from my AuthP repo) converts CVS to a resource file.\n\n\n\npublic void CreateResxFileFromCSV()\n{\n    var csvFilePath = \"filepath to csv file\";\n    var resxFilePath = \"filepath to EMPTY resource file\";\n    \n    //see https://joshclose.github.io/CsvHelper/getting-started/#reading-a-csv-file\n    using (var reader = new StreamReader(csvFilePath))\n    using (var csv = new CsvReader(reader, \n          CultureInfo.InvariantCulture))\n    {\n        var records = csv.GetRecords<CsvInputOfResx>();\n        //see https://learn.microsoft.com/en-us/dotnet/core/extensions/work-with-resx-files-programmatically#create-a-resx-fil\n\n        using (ResXResourceWriter writer = \n             new ResXResourceWriter(@resxFilePath))\n        {\n            foreach (var entry in records)\n            {\n                writer.AddResource(entry.Name, entry.Value);\n            }\n        }\n    }\n}\n\n\n\nI find this is especially useful if you need to change / add to your resource file, as its much easier to search / change in Excel.\n\n\n\nConclusions\n\n\n\nThe Net.LocalizeMessagesAndErrors is relatively small (the DefaultLocalizer is only has ~100 lines of code), but it took me more than five weeks of work! That’s because when I started to use the library I found a load of improvement – I got to local version 1.0.0-preview034 before I had finished. The result is that the library is much easier to use when updating an existing application to support multiple languages, and hopefully nicer to work with.\n\n\n\nThe changes I added came from applying the library to a) my AuthP library, b) adding a demo ASP.NET Core app within the library repo (see LocalizedWebApp), c) localizing the Example1 ASP.NET Core in my AuthP library and d) writing the Net.LocalizeMessagesAndErrors documentation (writing the docs always shows me any bad interfaces).\n\n\n\nIn the following articles I will show how to use the Net.LocalizeMessagesAndErrors library to build localized .NET applications. There also good documentation for this library now that contains all the details if you want to try it out now.\n\n\n\nHappy coding."
  },
  {
    "itemId": "https://www.thereformedprogrammer.net/?p=2794",
    "raw": "\n<p>An ASP.NET Core application uses claims to hold the logged-in user’s <a href=\"https://learn.microsoft.com/en-us/aspnet/core/security/authentication/\">authentication</a> and <a href=\"https://learn.microsoft.com/en-us/aspnet/core/security/authorization/introduction\">authorization</a> data. These claims are created on login and stored in a cookie or a JWT Token for quick access. This makes access to the claims is very fast, but downside is claims are fixed. Most of the time the “fixed claims” approach works fine, but there are some circumstances where you might need to update the user’s claims.</p>\n\n\n\n<p>This article describes three different ways to dynamically change a user’s claims for cookie and/or JWT Token authentication. The article also introduces some of the deeper parts of ASP.NET Core’s authorization and <a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/\">middleware</a>, which might help you in understanding how ASP.NET Core works.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: This article covers some similar topics in the <a href=\"https://www.thereformedprogrammer.net/advanced-techniques-around-asp-net-core-users-and-their-claims/\">Advanced techniques around ASP.NET Core Users and their claims</a>, but includes new approaches provided by a new distributed cache <a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache\">Net.DistributedFileStoreCache</a> library (referred to as <em>FileStore cache</em> in this article). The first example has a small improvement, while the other two approaches are new and work with JWT Token authentication.</p></blockquote>\n\n\n\n<p>This article is part of the series that covers .NET multi-tenant applications in general. The other articles in “Building ASP.NET Core and EF Core multi-tenant apps” series are:</p>\n\n\n\n<ul class=\"wp-block-list\"><li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part1-the-database/\">The database: Using a DataKey to only show data for users in their tenant</a></li><li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part2-administration/\">Administration: different ways to add and control tenants and users</a></li><li><a href=\"https://www.thereformedprogrammer.net/multi-tenant-apps-with-different-versions-can-increase-your-profits/\">Versioning your app: Creating different versions to maximise your profits</a></li><li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-hierarchical-multi-tenant-apps/\">Hierarchical multi-tenant: Handling tenants that have sub-tenants</a></li><li><a href=\"https://www.thereformedprogrammer.net/advanced-techniques-around-asp-net-core-users-and-their-claims/\">Advanced techniques around ASP.NET Core Users and their claims</a></li><li><a href=\"https://www.thereformedprogrammer.net/part6-using-sharding-to-build-multi-tenant-apps-using-asp-net-core-and-ef-core/\">Using sharding to build multi-tenant apps using EF Core and ASP.NET Core</a></li><li><a href=\"https://www.thereformedprogrammer.net/three-ways-to-securely-add-new-users-to-an-application-using-the-authp-library/\">Three ways to securely add new users to an application using the AuthP library</a></li><li><a href=\"https://www.thereformedprogrammer.net/how-to-take-an-asp-net-core-web-site-down-for-maintenance/\">How to take an ASP.NET Core web site “Down for maintenance”</a></li><li>ASP.NET Core: Three ways to refresh the claims of a logged-in user <strong>(This article)</strong></li></ul>\n\n\n\n<h2 class=\"wp-block-heading\">TL;DR; – Summary of this article</h2>\n\n\n\n<ul class=\"wp-block-list\"><li>ASP.NET Core creates HttpContext.User on login, which contains user information (like their name and email) in <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.security.claims.claim\">claims</a>. The User, with its claims, is stored in a cookie or a JWT Token for quick access. You can think of the cookie / JWT Token as a kind of cache.</li><li>If you have data a) is used in almost every HTTP request, and b) it takes some time calculate, then it’s a good candidate to calculate/add it as a claim during the login. See <a href=\"https://www.thereformedprogrammer.net/advanced-techniques-around-asp-net-core-users-and-their-claims/#1-adding-extra-claims-on-to-authentication-handlers-on-login\">this article</a> on how to do add your own claims on login.</li><li>By default, the claims in a logged-in user won’t change until they log out and log back in again. Normally the “fixed claims” is fine but have various situations where I need to update a user’s claims around managing multi-tenant users.</li><li>Therefore, I have needed to create ways to refresh the claims of a logged-in user. In this article I describe three approaches:<ul><li><strong>1. Update user claims via cookie event: </strong>This is a relatively easy way to update the user’s claims when using is the standard way to update an already logged-in user’s claims, but it only works for cookie authentication – see <a href=\"https://www.thereformedprogrammer.net/asp-net-core-three-ways-to-refresh-the-claims-of-a-logged-in-user/#1-update-user-claims-via-cookie-event-cookie-authentication-only\">this section</a> on this approach.</li></ul><ul><li><strong>2. Replace a user claim on a change</strong>: This uses middleware to update a claim when the logged-in claim is out of date. This approach it works with both cookie and cookie authentication – see <a href=\"https://www.thereformedprogrammer.net/asp-net-core-three-ways-to-refresh-the-claims-of-a-logged-in-user/#2-replace-a-user-claim-on-a-change-jwt-token-and-cookie-authentication\">this section</a> on this approach.</li></ul><ul><li><strong>3. On-demand add a new claim: </strong>This uses middleware to add a new claim not already in your JWT Token or Cookie. This is useful if you have secret / personal data that you don’t want in a JWT Token because the data isn’t encrypted – see <a href=\"https://www.thereformedprogrammer.net/asp-net-core-three-ways-to-refresh-the-claims-of-a-logged-in-user/#3-on-demand-add-a-new-claim-in-middleware-jwt-token-and-cookie\">this section</a> on this approach.</li><li><strong>4. Extra, IClaimTransformation</strong>: After I released this article Mohammed Ahmed Hussien (twitter: @shoogn17) said that the <a href=\"https://learn.microsoft.com/en-us/aspnet/core/security/authentication/claims/#extend-or-add-custom-claims-using-iclaimstransformation\">IClaimTransformation interface</a> can also help on change a user’s claims, so I have added something about using IClaimTransformation instead of the middleware approach.</li></ul></li><li>All these examples rely on a distributed cache called <a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache\">Net.DistributedFileStoreCache</a> I created for these types of situations. This get a cache value in ~25 nanoseconds, but adding a cache value is slow-ish ( &gt; 1 milliseconds). The very fast cache read means using these approaches won’t slow down your application.</li></ul>\n\n\n\n<h2 class=\"wp-block-heading\">Setting the scene – three types of dynamically updating a logged-in claims</h2>\n\n\n\n<p>I have created the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore\">AuthPermissions.AspNetCore</a><strong> </strong>library (shortened to <em>AuthP</em> in this article) which contains a) an improved ASP.NET Core Roles authorization system<strong> and b) </strong>features to help create an ASP.NET Core multi-tenant database system<strong>. </strong>The AuthP’s improved Roles authorization adds a Roles/Permissions claim and if the multi-tenant feature is activated, then an DataKey claim is also added.</p>\n\n\n\n<p>In certain circumstances these AuthP’s Roles/Permissions and DataKey claims may change, and to handle this I have developed code to dynamically change a user’s claims. Here are two that I have found:</p>\n\n\n\n<ul class=\"wp-block-list\"><li>In an AuthP multi-tenant application there is code to move a tenant’s data from one database to another, thus changing tenant DataKey. This requires the DataKey claim of all the user’s linked to the moved tenant. You can try this out on <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example4.MvcWebApp.IndividualAccounts\">AuthP’s Example4</a> hierarchical multi-tenant application and <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example6.MvcWebApp.Sharding\">Authp’s Example6</a> sharding multi-tenant application.</li><li>The AuthP library version of ASP.NET Core Roles allows a <a href=\"https://www.thereformedprogrammer.net/finally-a-library-that-improves-role-authorization-in-asp-net-core/\">Role to be dynamically changed</a>, which means that an admin user can what pages / Web APIs are in a Role. If a Role is changed there might be security issues, so the user’s Roles/Permissions claim needs updating. You can try this out in the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example2.WebApiWithToken.IndividualAccounts\">AuthP’s Example2</a> WebApi application that uses the JWT Token authentication.</li><li>The third approach is useful if you need a secret or personal value claim when using JWT Token authentication. You shouldn’t be added to the JWT Token because the token data isn’t encrypted. For instance, various personal privacy laws stop you from adding Personal Identifiable Information (PII) values in a JWT Token. You can try this out in the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example2.WebApiWithToken.IndividualAccounts\">AuthP’s Example2</a> WebApi application that uses the JWT Token authentication.</li><li>At the end I also cover the IClaimTransformation interface that allows you to change a user’s claims. The IClaimTransformation service is an alternative from using middleware approach used in examples 2 and 3</li></ul>\n\n\n\n<h2 class=\"wp-block-heading\">Introducing the three examples of updating a user’s claims</h2>\n\n\n\n<p>The three examples of updating a user’s claims use different approaches to implementation. This allows you to choose the approach that works for you, but even if you never need these approaches seeing how they use events and ASP.NET Core middleware might help you understand the ASP.NET Core code a bit more.</p>\n\n\n\n<p>The three approaches in this article assume you have added extra claims to your users on login. This is &nbsp;described in <a href=\"https://www.thereformedprogrammer.net/advanced-techniques-around-asp-net-core-users-and-their-claims/#1-adding-extra-claims-on-to-authentication-handlers-on-login\">this section</a> of the article called “<a href=\"https://www.thereformedprogrammer.net/advanced-techniques-around-asp-net-core-users-and-their-claims/\">Advanced techniques around ASP.NET Core Users and their claims</a>”. I recommend you read this article if you aren’t aware how to add extra claims to a user on login.</p>\n\n\n\n<p>All the solutions rely on a distributed cache called <a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache\">Net.DistributedFileStoreCache</a> I created for these types of situations (can find out more about the FileStore cache in <a href=\"https://www.thereformedprogrammer.net/a-net-distributed-cache-with-a-25-nanosecond-read-time/\">this article</a>). The FileStore cache’s key feature is that it as a very fast read time, measured in nanoseconds, which is important if you want application to be fast because each implementation is called on every HTTP request. It also a distributed cache, so it will work on web sites using multiple instances.</p>\n\n\n\n<p>Here is a list of the three examples with a quick summary, their pros and cons and a comment on performance:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li><strong>Update user claims via cookie event: Cookie authentication only.</strong><ol><li><strong>Summary</strong>: This is the standard way to update an already logged-in user’s claims.</li></ol><ol><li><strong>Pros</strong>: Can handle any type of change because it can change all the claims.</li></ol><ol><li><strong>Cons</strong>: Doesn’t work with JWT Token authentication</li></ol><ol><li><strong>Performance: </strong>It re-calculate all the extra claims, but only for logged-in users. Very efficient as the cookie is updated to the new claims.</li></ol></li><li><strong>Replace a user claim on a change: JWT Token and cookie authentication</strong><ol><li><strong>Summary</strong>: This uses middleware to update a claim when the logged-in claim is out of date.</li></ol><ol><li><strong>Pro</strong>: Can work with both JWT Token and cookie authentication.</li></ol><ol><li><strong>Cons</strong>: Could need a big cache file if lots of users.</li></ol><ol><li><strong>Performance:</strong> It re-calculates one claim for all users, not just logged-in users. If large number of users, then this can be slower than the third example.</li></ol></li><li><strong>On-demand add a new claim: JWT Token and cookie authentication</strong><ol><li><strong>Summary</strong>: This adds a new claim not already in your JWT Token or Cookie.</li></ol><ol><li><strong>Pro</strong>: Hide secret data, e.g. you shouldn’t add a Personal Identifiable Information (PII) claim when using JWT Token.</li></ol><ol><li><strong>Cons</strong>: None</li></ol><ol><li><strong>Performance:</strong> It has a very good performance because the claim only calculated if a user is logged in, but it would be slower than example 2 if a database change altered many users.</li></ol></li></ol>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: At the end I talk about using services that follow the IClaimTransformation interface, which could be used in example 2 and 3 instead of adding middleware. </p></blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">1. Update user claims via cookie event: Cookie authentication only</h3>\n\n\n\n<p>This example only works with cookie authentication only but its fairly simple and is fast, i.e. it doesn’t add much extra time to each HTTP request and It’s also quite easy to adapt to different situations. The downside is you can’t use this with a JWT Token.</p>\n\n\n\n<p>The two parts of this implementation are:</p>\n\n\n\n<ul class=\"wp-block-list\"><li><strong>Detect Change:</strong> The code links to EF Core’s StateChanged event and detects a change to the entries that would change the claim. On such an event it writes the current UTC DateTime to the “LastChanged” entry in the cache – see the left side of the diagram below.</li><li><strong>Apply to User:</strong> The code links to the cookie’s <a href=\"https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.cookies.cookieauthenticationevents.onvalidateprincipal\">OnValidatePrincipal</a> event and if the user’s “LastChanged” claim DateTime is older that the “LastChanged” DateTime from the cache, &nbsp;then it will update the user’s claims and also create a new authentication cookie – see the right side of the diagram below.</li></ul>\n\n\n\n<p>The figure below shows how this example works.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/CookieAuthenticationTenantChange.png\"><img loading=\"lazy\" decoding=\"async\" width=\"750\" height=\"354\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/CookieAuthenticationTenantChange.png\" alt=\"\" class=\"wp-image-2795\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/CookieAuthenticationTenantChange.png 750w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/CookieAuthenticationTenantChange-300x142.png 300w\" sizes=\"auto, (max-width: 750px) 100vw, 750px\" /></a></figure>\n\n\n\n<p>The main code to implement contains three pieces of code:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li>The event code to detect the database changes that require an update to user’s claims</li><li>The <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DownStatusCode/GlobalChangeTimeService.cs\">GlobalChangeTimeService</a> which sets / gets the “LastChanged” entry</li><li>The event code called by cookie’s OnValidatePrincipal to check / update a user’s claims</li></ol>\n\n\n\n<p>With two support services</p>\n\n\n\n<ul class=\"wp-block-list\"><li>A service called <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions/ClaimsCalculator.cs\">ClaimsCalculator</a> that provides the extras claims to add to a user.</li><li>The <a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache\">Net.DistributedFileStoreCache</a> library to provide a cache with a very fast read.</li></ul>\n\n\n\n<p>Let’s now look at the main code:</p>\n\n\n\n<h4 class=\"wp-block-heading\">1.3 The event code to detect the database changes</h4>\n\n\n\n<p>I’m using EF Core which has a several events to track what is happing to the database. In this case I used EF Core’s ChangeTracker.StateChanged (see <a href=\"https://thecodeblogger.com/2021/07/17/how-to-use-net-evens-provided-by-ef-core/\">this useful article</a> about EF Core events). The code can be found in the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DownStatusCode/TenantKeyOrShardChangeService.cs\">TenantKeyOrShardChangeService</a> class inherits the IDatabaseStateChangeEvent interface and much be register via the ASP.NET Core DI provider. The constructor of the application’s DbContext contains an extra parameter containing an IEnumerable&lt;IDatabaseStateChangeEvent&gt; that contains any registered classes that have the IDatabaseStateChangeEvent interface.</p>\n\n\n\n<p>In this example I am looking for two changes to the Tenant entity:</p>\n\n\n\n<ul class=\"wp-block-list\"><li>The ParentDataKey property being modified – this would change the DataKey claim, which defines the tenant filer key (lines 13 to 14).</li><li>The DatabaseInfoName property being modified – this is used in sharding and would change the DatabaseInfoName claim, which defines what database to use (lines 15 to 16).</li></ul>\n\n\n\n<p>The code below is taken from the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DownStatusCode/TenantKeyOrShardChangeService.cs\">TenantKeyOrShardChangeService</a> class and shows the code to register its event listener, and the actual event handler.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic void RegisterEventHandlers(\n    AuthPermissionsDbContext context)\n{\n    context.ChangeTracker.StateChanged += \n        RegisterKeyOrShardChange;\n}\n\nprivate void RegisterKeyOrShardChange(object sender, \n    EntityStateChangedEventArgs e)\n{\n    if (e.Entry.Entity is Tenant\n        &&amp; e.NewState == EntityState.Modified\n        &&amp; (e.Entry.OriginalValues&#x5B;nameof(Tenant.ParentDataKey)] != \n               e.Entry.CurrentValues&#x5B;nameof(Tenant.ParentDataKey)] ||\n            e.Entry.OriginalValues&#x5B;nameof(Tenant.DatabaseInfoName)] !=\n               e.Entry.CurrentValues&#x5B;nameof(Tenant.DatabaseInfoName)])\n        )\n    {\n        _globalAccessor.SetGlobalChangeTimeToNowUtc();\n    }\n}\n</pre></div>\n\n\n<p>The SetGlobalChangeTimeToNowUtc method is called if a modification is found. This method comes from the GlobalChangeTimeService class which is described next section.</p>\n\n\n\n<h4 class=\"wp-block-heading\">1.2 The GlobalChangeTimeService class</h4>\n\n\n\n<p>The <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DownStatusCode/GlobalChangeTimeService.cs\">GlobalChangeTimeService</a> class provides a thin wrapper around the FileStore cache and has two methods that set and get the &#8220;ChangeAtThisTime&#8221; &nbsp;entry in the FileStore cache. Also handles the DateTime conversions. The methods are:</p>\n\n\n\n<ul class=\"wp-block-list\"><li>SetGlobalChangeTimeToNowUtc(), which sets the cache entry with the name &#8220;ChangeAtThisTime&#8221; with a value of DateTime.UtcNow.DateTimeToTicks()</li><li>GetGlobalChangeTimeUtc(), which returns a DateTime from the cache entry with the name &#8220;ChangeAtThisTime&#8221;, or DateTime.MinValue if that entry hasn’t been set.</li></ul>\n\n\n\n<h4 class=\"wp-block-heading\">1.3 The event code called by cookie’s OnValidatePrincipal</h4>\n\n\n\n<p>The event code can be found in the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DownStatusCode/SomethingChangedCookieEvent.cs\">SomethingChangedCookieEvent</a> class and needs to register it in your Program class using the code shown below</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\nbuilder.Services.ConfigureApplicationCookie(options =&gt;\n{\n    options.Events.OnValidatePrincipal = \n      SomethingChangedCookieEvent\n          .UpdateClaimsIfSomethingChangesAsync;\n});\n</pre></div>\n\n\n<p>The code shown below comes from the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DownStatusCode/SomethingChangedCookieEvent.cs\">SomethingChangedCookieEvent</a> class. The steps are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li>Lines 4 to 7: Gets the current user’s claims and the latest time a Global Change was found.</li><li>Lines 9 to 11: If the user’s claims are older that the Global Change time it needs to update the user’s claims.</li><li>Lines 19 to 25: This updates the AuthP&#8217;s claims via its AuthP’s <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions/ClaimsCalculator.cs\">ClaimsCalculator</a> which will recalculate the extra claims, including the claim that holds the last time the claims were updated.</li><li>Lines 27 to 29: This a) creates a new User (of type ClaimsPrincipal) for this HTTP request, and b) in line 30 it says the authentication cookie should be updated with these new claims.</li></ol>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic static async Task UpdateClaimsIfSomethingChangesAsync\n    (CookieValidatePrincipalContext context)\n{\n    var originalClaims = context.Principal.Claims.ToList();\n    var globalTimeService = context.HttpContext.RequestServices\n       .GetRequiredService&lt;IGlobalChangeTimeService&gt;();\n    var lastUpdateUtc = globalTimeService.GetGlobalChangeTimeUtc();\n\n    if (originalClaims.\n           GetClaimDateTimeTicksValue(EntityChangeClaimType) \n        &lt; lastUpdateUtc)\n    {\n        //Need to refresh the user's claims \n        var userId = originalClaims.GetUserIdFromClaims();\n        if (userId == null)\n            //this shouldn't happen, but best to return\n            return;\n\n        var claimsCalculator = context.HttpContext.RequestServices\n            .GetRequiredService&lt;IClaimsCalculator&gt;();\n        var newClaims = await claimsCalculator\n            .GetClaimsForAuthUserAsync(userId);\n        //Copy over unchanged claims\n        newClaims.AddRange(originalClaims.\n            RemoveUpdatedClaimsFromOriginalClaims(newClaims)); \n\n        var identity = new ClaimsIdentity(newClaims, &quot;Cookie&quot;);\n        var newPrincipal = new ClaimsPrincipal(identity);\n        context.ReplacePrincipal(newPrincipal);\n        context.ShouldRenew = true;\n    }\n}\n\nprivate static IEnumerable&lt;Claim&gt; \n    RemoveUpdatedClaimsFromOriginalClaims(\n        this List&lt;Claim&gt; originalClaims, List&lt;Claim&gt; newClaims)\n{\n    var newClaimTypes = newClaims.Select(x =&gt; x.Type);\n    return originalClaims\n        .Where(x =&gt; !newClaimTypes.Contains(x.Type));\n}\n</pre></div>\n\n\n<h3 class=\"wp-block-heading\">2. Replace a user claim on a change: JWT Token and cookie authentication</h3>\n\n\n\n<p>This approach uses middleware to replace a claim, not by updating the user’s claims in the first approach, but by updating the current HTTP User on every HTTP request. The pro of this approach is that it works for JWT Token and cookie authentication, but the con is needs code to run on every HTTP request which cause some performance problems. I only considered this approach after I had created a the FileStore distributed cache, as it has a read time of ~25 nanoseconds.</p>\n\n\n\n<p>Like the first example there are two parts to this approach:</p>\n\n\n\n<ul class=\"wp-block-list\"><li><strong>Detect Change:</strong> The code links to EF Core’s StateChanged event and detects a change to the entries that would change the claim. In this case it calculates the new claim value for each affected user and stores each claim value in the cache – see the left side of the diagram below.</li><li><strong>Apply to User:</strong> The extra middleware code runs after the authorization middleware and if a new claim for the current user is found in the cache, then it replaces the out-of-date claim and creates a new ClaimsPrincipal – see the right side of the diagram below.</li></ul>\n\n\n\n<p>The figure below shows how this example works.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/MiddlewareUpdateAuthorization.png\"><img loading=\"lazy\" decoding=\"async\" width=\"1017\" height=\"414\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/MiddlewareUpdateAuthorization.png\" alt=\"\" class=\"wp-image-2796\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/MiddlewareUpdateAuthorization.png 1017w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/MiddlewareUpdateAuthorization-300x122.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/MiddlewareUpdateAuthorization-768x313.png 768w\" sizes=\"auto, (max-width: 1017px) 100vw, 1017px\" /></a></figure>\n\n\n\n<p>The main code to implement contains pieces of code:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li>The event code to detect the database changes and add replacement claims to the cache.</li><li>The middleware which updates the HTTP User if a replacement claim is found in the cache.</li></ol>\n\n\n\n<p>It also uses the <a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache\">Net.DistributedFileStoreCache</a> library to provide a cache with a very fast read.</p>\n\n\n\n<p>Let’s now look at the main code:</p>\n\n\n\n<h4 class=\"wp-block-heading\">2.1 The event code to detect the database changes</h4>\n\n\n\n<p>In the first example the database event code just had to detect a change, so it’s used EF Core’s StateChanged event. In this example we need to detect a change and then calculate the updated claim once the database has been updated, which makes the code more complex. You can find the code in the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/Example2.WebApiWithToken.IndividualAccounts/ClaimsChangeCode/RoleChangedDetectorService.cs\">RoleChangedDetectorService</a> class, but because the code is quite long, I will describe the various parts with pseudo-code</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/RoleChangedDetectorServicePseudoCode-1.png\"><img loading=\"lazy\" decoding=\"async\" width=\"1024\" height=\"685\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/RoleChangedDetectorServicePseudoCode-1-1024x685.png\" alt=\"\" class=\"wp-image-2798\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/RoleChangedDetectorServicePseudoCode-1-1024x685.png 1024w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/RoleChangedDetectorServicePseudoCode-1-300x201.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/RoleChangedDetectorServicePseudoCode-1-768x513.png 768w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/RoleChangedDetectorServicePseudoCode-1-1536x1027.png 1536w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/RoleChangedDetectorServicePseudoCode-1.png 1542w\" sizes=\"auto, (max-width: 1024px) 100vw, 1024px\" /></a></figure>\n\n\n\n<p>The code in the AddPermissionOverridesToCache method calculates the claim for each effected Users and stores the new claim in the FileStore cache with a key containing the userId of user that the claim applies to.</p>\n\n\n\n<p>The RoleChangedDetectorService inherits the the IDatabaseStateChangeEvent interface and much be register via the ASP.NET Core DI provider. The constructor of the application’s DbContext contains an extra parameter containing an IEnumerable&lt;IDatabaseStateChangeEvent&gt; that contains any registered classes that have the IDatabaseStateChangeEvent interface.</p>\n\n\n\n<h4 class=\"wp-block-heading\">2.2. The middleware which updates the HTTP User outdated claim</h4>\n\n\n\n<p>The middleware code can be found in the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/Example2.WebApiWithToken.IndividualAccounts/ClaimsChangeCode/UpdateRoleClaimMiddleware.cs\">UpdateRoleClaimMiddleware</a> class which both provides the extension method to register the middleware, and the code that will be called on every HTTP request. Here is the code in you need to your Program class to add this code into the into the middleware pipeline (see highlighted line) – note that the UsePermissionsChange method must come after the UseAuthorization.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; highlight: [4]; title: ; notranslate\">\n//other code left out\napp.UseAuthentication();\napp.UseAuthorization();\napp.UsePermissionsChange();\n//other code left out\n</pre></div>\n\n\n<p>The actual method in the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/Example2.WebApiWithToken.IndividualAccounts/ClaimsChangeCode/UpdateRoleClaimMiddleware.cs\">UpdateRoleClaimMiddleware</a> class that updates a claim if that claim has been updated is shown below, with this list explain what each part does and where that code is found:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li>Lines 4 to 5: It only looks at logged-in user. Not logged-in requests are ignored.</li><li>Lines 12 to 13: This looks for a replacement value for its Permissions’ claim value. If its null, then there no replacement and the current User is used.</li><li>Lines 17 to 23: This gets the current User’s claims and replaces the Permissions’ claim with a new claim where its value is taken from the found cache.</li><li>Lines 25 to 28:&nbsp; This creates a new ClaimsIdentity containing the updated claim. This new user sent back to the outer code which assigns it to the HTTPContext’s &nbsp;context.User property.</li></ol>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic static async Task&lt;ClaimsPrincipal&gt; ReplacePermissionsMiddleware(\n    IServiceProvider serviceProvider, ClaimsPrincipal user)\n{\n    var userId = user.GetUserIdFromUser();\n    if (userId != null)\n    {\n        //There is a logged-in user, find if the\n        //FileStore cache contains a new Permissions claim\n        var fsCache = serviceProvider.GetRequiredService\n            &lt;IDistributedFileStoreCacheClass&gt;();\n\n        var replacementPermissions = await fsCache.GetAsync(\n            userId.FormReplacementPermissionsKey());\n        if (replacementPermissions != null)\n            //Replacement permissions claim found, so update the User\n\n            var updateClaims = user.Claims.ToList();\n            var found = updateClaims.FirstOrDefault(c =&gt;\n                c.Type == PermissionConstants.PackedPermissionClaimType);\n            updateClaims.Remove(found); \n            updateClaims.Add(new Claim(\n                PermissionConstants.PackedPermissionClaimType, \n                replacementPermissions));\n\n            var appIdentity = new ClaimsIdentity(\n                updateClaims, \n                user.Identity!.AuthenticationType);\n            return new ClaimsPrincipal(appIdentity);\n        }\n    }\n    \n    return null; //no change to the current user\n}\n</pre></div>\n\n\n<p>The ReplacePermissionsMiddleware method is called from the code that registers the middleware. If the method returns null, then the current HTTP User is unchanged as there was no update. If there is an update to the User’s claims the method returns a new User (ClaimsPrincipal), which is then assigned to the HttpContext.User property.</p>\n\n\n\n<h3 class=\"wp-block-heading\">3. On-demand add a new claim in middleware: JWT Token and cookie</h3>\n\n\n\n<p>The final example is similar to the second example as its uses middleware, but it’s the middleware that calculates the claim rather than the database trigger. This approach is good when you have secret / sensitive claims that you don’t want to put in a JWT Token, because a JWT Token isn’t encrypted. For instance, various privacy rules say that Personal Identifiable Information (PII), e.g. user’s email address, when using JWT Token.</p>\n\n\n\n<p>The two parts to this approach are:</p>\n\n\n\n<ul class=\"wp-block-list\"><li><strong>On-demand Claim:</strong> The middleware code will look for claim value from the cache. If the cache value is empty, then it will access the database to get the latest value and store that in the cache. Finally, the code will add the claim to the HTTP User.</li><li><strong>Detect Change:</strong> If a database change alters the cache value, then it removes any existing cache value, thus causing the middleware to recalculate the claim value for the user.</li></ul>\n\n\n\n<p>The figure below shows how this example works.</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/MiddlewareOnDemandClaim.png\"><img loading=\"lazy\" decoding=\"async\" width=\"1024\" height=\"355\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/MiddlewareOnDemandClaim-1024x355.png\" alt=\"\" class=\"wp-image-2799\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/MiddlewareOnDemandClaim-1024x355.png 1024w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/MiddlewareOnDemandClaim-300x104.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/MiddlewareOnDemandClaim-768x266.png 768w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/10/MiddlewareOnDemandClaim.png 1067w\" sizes=\"auto, (max-width: 1024px) 100vw, 1024px\" /></a></figure>\n\n\n\n<p>The main code to implement contains pieces of code:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li>The middleware which adds a new claim to the HTTP User from the cache.</li><li>The event code to detect the database changes and removes the cache value.</li></ol>\n\n\n\n<p>It also uses the <a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache\">Net.DistributedFileStoreCache</a> library to provide a cache with a very fast read.</p>\n\n\n\n<p>Let’s now look at the main code:</p>\n\n\n\n<h4 class=\"wp-block-heading\">3.1 The middleware which adds a new claim</h4>\n\n\n\n<p>The middleware code can be found in the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/Example2.WebApiWithToken.IndividualAccounts/ClaimsChangeCode/AddEmailClaimMiddleware.cs\">AddEmailClaimMiddleware</a> class which both provides the extension method to register the middleware, and the code that will be called on every HTTP request. Here is the code in you need to your Program class to add this code into the into the middleware pipeline (see highlighted line) – note that the UseAddEmailClaimToUsers method must come after the UseAuthorization.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; highlight: [4]; title: ; notranslate\">\n//other code left out\napp.UseAuthentication();\napp.UseAuthorization();\napp.UseAddEmailClaimToUsers();\n//other code left out\n</pre></div>\n\n\n<p>The actual method in the AddEmailClaimMiddleware class that adds the new claim is shown below, with this list explain what each part does and where that code is found:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li>Lines 4 to 5: It only looks at logged-in user. Not logged-in requests are ignored.</li><li>Lines 11  to 13: This looks for a replacement value for its Email claim value. If its null, then it needs to access the database for the latest email of the current HTTP User.</li><li>Lines 16 to 26: This gets the current user email from the database and adds a cache entry so that the next time it doesn’t have to query the database.</li><li>Lines 30 to 35:&nbsp; This creates a new ClaimsIdentity containing the added email claim. This new user sent back to the outer code which assigns it to the HTTPContext’s &nbsp;User property.</li></ol>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic static async Task&lt;ClaimsPrincipal&gt; AddEmailClaimToCurrentUser(\n    IServiceProvider serviceProvider, ClaimsPrincipal user)\n{\n    var userId = user.GetUserIdFromUser();\n    if (userId != null)\n    {\n        //There is a logged-in user, so cache contains a new Permissions claim\n        var fsCache = serviceProvider.GetRequiredService\n            &lt;IDistributedFileStoreCacheClass&gt;();\n\n        var usersEmail = await fsCache.GetAsync(\n            userId.FormAddedEmailClaimKey());\n        if (usersEmail == null)\n        {\n            //Not set up yet, get the user's email \n            var context = serviceProvider.GetRequiredService\n                 &lt;AuthPermissionsDbContext&gt;();\n            usersEmail = context.AuthUsers\n                 .Where(x =&gt; x.UserId == userId)\n                 .Select(x =&gt; x.Email).FirstOrDefault();\n            \n            if (usersEmail == null)\n                return null; //shouldn't happen, but could in certain updates\n\n            //Add to cache so next time it will be quicker\n            await fsCache.SetAsync(userId.FormAddedEmailClaimKey(), usersEmail);\n        }\n\n        //We need to add the Email from the cache\n        var updateClaims = user.Claims.ToList();\n        updateClaims.Add(new Claim(ClaimTypes.Email, usersEmail));\n\n        var appIdentity = new ClaimsIdentity(updateClaims,\n            user.Identity!.AuthenticationType);\n        return new ClaimsPrincipal(appIdentity);\n    }\n    \n    return null; //no change to the current user\n}\n</pre></div>\n\n\n<p>The AddEmailClaimToCurrentUser method is called from the code that registers the middleware. If the user is logged in the method will return a new User (ClaimsPrincipal) with the email claim added, which is then assigned to the HttpContext.User property. For user that aren’t logged in, then the method returns null, which means the current User should be used.</p>\n\n\n\n<h4 class=\"wp-block-heading\">3.2. The event code to detect the change of a user’s email</h4>\n\n\n\n<p>The database event code is very simple – if a user’s email has changed, then make sure the cache entry linked to the user’s email is removed. That means the next time that user accesses the web app the AddEmailClaimMiddleware will recalculate the user’s email (and add the cache entry).</p>\n\n\n\n<p>The code below come from the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/Example2.WebApiWithToken.IndividualAccounts/ClaimsChangeCode/EmailChangeDetectorService.cs\">EmailChangeDetectorService</a> class.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic void RegisterEventHandlers(AuthPermissionsDbContext context)\n{\n    context.ChangeTracker.StateChanged += \n         delegate(object sender, EntityStateChangedEventArgs e)\n    {\n        if (e.Entry.Entity is AuthUser user\n            &&amp; e.NewState == EntityState.Modified\n            &&amp; e.Entry.OriginalValues&#x5B;nameof(AuthUser.Email)] \n               != e.Entry.CurrentValues&#x5B;nameof(AuthUser.Email)]\n            )\n            //Email has changed, so we remove the current cache value\n            _fsCache.Remove(user.UserId.FormAddedEmailClaimKey());\n    };\n}\n</pre></div>\n\n\n<p>The EmailChangeDetectorService inherits the IDatabaseStateChangeEvent interface, and much be register via the ASP.NET Core DI provider. The constructor of the application’s DbContext contains an extra parameter containing an IEnumerable&lt;IDatabaseStateChangeEvent&gt; that contains any registered classes that have the IDatabaseStateChangeEvent interface.</p>\n\n\n\n<h3 class=\"wp-block-heading\">4. Extra: Using IClaimTransformation to update the user’s claims</h3>\n\n\n\n<p>I wanted to add this extra part to talk about services that follow the IClaimTransformation interface to update the user’s claims. Like the middleware approach the IClaimTransformation services run on every HTTP request after the AuthenticateAsync middleware.</p>\n\n\n\n<p>I haven’t used IClaimTransformation services but when Mohammed Ahmed Hussien (twitter: @shoogn17) pointed it out I can see that it might be easier for people to use because:</p>\n\n\n\n<ul class=\"wp-block-list\"><li>You can use the normal constructor dependency injection to inject other services you need in your code.</li><li>Unlike the middleware approach a IClaimTransformation service only runs if there a logged-in user, which means you don’t have to add code to ignore non-logged in users.</li></ul>\n\n\n\n<p>This <a href=\"https://learn.microsoft.com/en-us/aspnet/core/security/authentication/claims#extend-or-add-custom-claims-using-iclaimstransformation\">section from the Microsoft docs</a> gives you a simple example of how you would create and register a IClaimTransformation service.</p>\n\n\n\n<p>I haven’t compared the middleware and IClaimTransformation service for performance, but I would expect both of them are fast, assuming your code doesn’t access a database every HTTP request. (I found a couple of articles about IClaimTransformation which has database accesses on every HTTP request. I don’t recommend that for performance reason, which is why I use the FileStore cache to keep the claim update fast.)</p>\n\n\n\n<h2 class=\"wp-block-heading\">Conclusions</h2>\n\n\n\n<p>This article gives a detailed looks at three ways to update the claims of a logged-in user to a ASP.NET Core application. The three examples provide a wide range of approaches that cover most claim update situations. And each example can be tweaked to make them perform better for specific changes: for instance, the first example updates all logged-in users, but I could be changed to be more selective on which users are updated. &nbsp;&nbsp;&nbsp;</p>\n\n\n\n<p>I start with the cookie-only approach which I used many years ago on my first ASP.NET Core application for a client. Its pretty simple and performs very well when changes are infrequent. I have used this for many years, including in client’s applications, and it well tried and tested. The only change I have added in this article is the use of the FileStore distributed cache, which makes it a bit faster.</p>\n\n\n\n<p>For many years I didn’t have a viable solution for changing the claims when using JWT Token authentication, which is a problem as many frontend frameworks work better with a JWT Token. It wasn’t until I build the FileStore distributed cache, which has a very fast read time, e.g. ~25 nanoseconds (see <a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache#performance-figures\">FileStore distributed cache benchmark</a> for full data), that I found an approach that has a good per-HTTP request performance.</p>\n\n\n\n<p>Examples 2 and 3 offer two approaches that work with both cookie and JWT Token authentication, with their implementations almost the reverse of each other: example 2 calculates the updated claims within the database event, while example 3 calculate the claim in the middleware code. These different approaches also provide different performance parameters – see the performance section in the list of the three approaches in <a href=\"https://www.thereformedprogrammer.net/asp-net-core-three-ways-to-refresh-the-claims-of-a-logged-in-user/#introducing-the-three-examples-of-updating-a-users-claims\">introduction section</a> for more on this.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: These three examples are in the AuthP’s repro examples and be tried by running various ASP.NET Core applications. The Update user claims via cookie event version can be found in <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example4.MvcWebApp.IndividualAccounts\">AuthP’s Example4</a> hierarchical multi-tenant application and <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example6.MvcWebApp.Sharding\">Authp’s Example6</a> sharding multi-tenant application. The last two examples work with JWT Token, so both middleware versions are in the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example2.WebApiWithToken.IndividualAccounts\">AuthP’s Example2</a> WebApi application that uses the JWT Token authentication.</p></blockquote>\n\n\n\n<p>Happy coding.</p>\n",
    "sanitized": "An ASP.NET Core application uses claims to hold the logged-in user’s authentication and authorization data. These claims are created on login and stored in a cookie or a JWT Token for quick access. This makes access to the claims is very fast, but downside is claims are fixed. Most of the time the “fixed claims” approach works fine, but there are some circumstances where you might need to update the user’s claims.\n\n\n\nThis article describes three different ways to dynamically change a user’s claims for cookie and/or JWT Token authentication. The article also introduces some of the deeper parts of ASP.NET Core’s authorization and middleware, which might help you in understanding how ASP.NET Core works.\n\n\n\nNOTE: This article covers some similar topics in the Advanced techniques around ASP.NET Core Users and their claims, but includes new approaches provided by a new distributed cache Net.DistributedFileStoreCache library (referred to as FileStore cache in this article). The first example has a small improvement, while the other two approaches are new and work with JWT Token authentication.\n\n\n\nThis article is part of the series that covers .NET multi-tenant applications in general. The other articles in “Building ASP.NET Core and EF Core multi-tenant apps” series are:\n\n\n\nThe database: Using a DataKey to only show data for users in their tenantAdministration: different ways to add and control tenants and usersVersioning your app: Creating different versions to maximise your profitsHierarchical multi-tenant: Handling tenants that have sub-tenantsAdvanced techniques around ASP.NET Core Users and their claimsUsing sharding to build multi-tenant apps using EF Core and ASP.NET CoreThree ways to securely add new users to an application using the AuthP libraryHow to take an ASP.NET Core web site “Down for maintenance”ASP.NET Core: Three ways to refresh the claims of a logged-in user (This article)\n\n\n\nTL;DR; – Summary of this article\n\n\n\nASP.NET Core creates HttpContext.User on login, which contains user information (like their name and email) in claims. The User, with its claims, is stored in a cookie or a JWT Token for quick access. You can think of the cookie / JWT Token as a kind of cache.If you have data a) is used in almost every HTTP request, and b) it takes some time calculate, then it’s a good candidate to calculate/add it as a claim during the login. See this article on how to do add your own claims on login.By default, the claims in a logged-in user won’t change until they log out and log back in again. Normally the “fixed claims” is fine but have various situations where I need to update a user’s claims around managing multi-tenant users.Therefore, I have needed to create ways to refresh the claims of a logged-in user. In this article I describe three approaches:1. Update user claims via cookie event: This is a relatively easy way to update the user’s claims when using is the standard way to update an already logged-in user’s claims, but it only works for cookie authentication – see this section on this approach.2. Replace a user claim on a change: This uses middleware to update a claim when the logged-in claim is out of date. This approach it works with both cookie and cookie authentication – see this section on this approach.3. On-demand add a new claim: This uses middleware to add a new claim not already in your JWT Token or Cookie. This is useful if you have secret / personal data that you don’t want in a JWT Token because the data isn’t encrypted – see this section on this approach.4. Extra, IClaimTransformation: After I released this article Mohammed Ahmed Hussien (twitter: @shoogn17) said that the IClaimTransformation interface can also help on change a user’s claims, so I have added something about using IClaimTransformation instead of the middleware approach.All these examples rely on a distributed cache called Net.DistributedFileStoreCache I created for these types of situations. This get a cache value in ~25 nanoseconds, but adding a cache value is slow-ish ( > 1 milliseconds). The very fast cache read means using these approaches won’t slow down your application.\n\n\n\nSetting the scene – three types of dynamically updating a logged-in claims\n\n\n\nI have created the AuthPermissions.AspNetCore library (shortened to AuthP in this article) which contains a) an improved ASP.NET Core Roles authorization system and b) features to help create an ASP.NET Core multi-tenant database system. The AuthP’s improved Roles authorization adds a Roles/Permissions claim and if the multi-tenant feature is activated, then an DataKey claim is also added.\n\n\n\nIn certain circumstances these AuthP’s Roles/Permissions and DataKey claims may change, and to handle this I have developed code to dynamically change a user’s claims. Here are two that I have found:\n\n\n\nIn an AuthP multi-tenant application there is code to move a tenant’s data from one database to another, thus changing tenant DataKey. This requires the DataKey claim of all the user’s linked to the moved tenant. You can try this out on AuthP’s Example4 hierarchical multi-tenant application and Authp’s Example6 sharding multi-tenant application.The AuthP library version of ASP.NET Core Roles allows a Role to be dynamically changed, which means that an admin user can what pages / Web APIs are in a Role. If a Role is changed there might be security issues, so the user’s Roles/Permissions claim needs updating. You can try this out in the AuthP’s Example2 WebApi application that uses the JWT Token authentication.The third approach is useful if you need a secret or personal value claim when using JWT Token authentication. You shouldn’t be added to the JWT Token because the token data isn’t encrypted. For instance, various personal privacy laws stop you from adding Personal Identifiable Information (PII) values in a JWT Token. You can try this out in the AuthP’s Example2 WebApi application that uses the JWT Token authentication.At the end I also cover the IClaimTransformation interface that allows you to change a user’s claims. The IClaimTransformation service is an alternative from using middleware approach used in examples 2 and 3\n\n\n\nIntroducing the three examples of updating a user’s claims\n\n\n\nThe three examples of updating a user’s claims use different approaches to implementation. This allows you to choose the approach that works for you, but even if you never need these approaches seeing how they use events and ASP.NET Core middleware might help you understand the ASP.NET Core code a bit more.\n\n\n\nThe three approaches in this article assume you have added extra claims to your users on login. This is  described in this section of the article called “Advanced techniques around ASP.NET Core Users and their claims”. I recommend you read this article if you aren’t aware how to add extra claims to a user on login.\n\n\n\nAll the solutions rely on a distributed cache called Net.DistributedFileStoreCache I created for these types of situations (can find out more about the FileStore cache in this article). The FileStore cache’s key feature is that it as a very fast read time, measured in nanoseconds, which is important if you want application to be fast because each implementation is called on every HTTP request. It also a distributed cache, so it will work on web sites using multiple instances.\n\n\n\nHere is a list of the three examples with a quick summary, their pros and cons and a comment on performance:\n\n\n\nUpdate user claims via cookie event: Cookie authentication only.Summary: This is the standard way to update an already logged-in user’s claims.Pros: Can handle any type of change because it can change all the claims.Cons: Doesn’t work with JWT Token authenticationPerformance: It re-calculate all the extra claims, but only for logged-in users. Very efficient as the cookie is updated to the new claims.Replace a user claim on a change: JWT Token and cookie authenticationSummary: This uses middleware to update a claim when the logged-in claim is out of date.Pro: Can work with both JWT Token and cookie authentication.Cons: Could need a big cache file if lots of users.Performance: It re-calculates one claim for all users, not just logged-in users. If large number of users, then this can be slower than the third example.On-demand add a new claim: JWT Token and cookie authenticationSummary: This adds a new claim not already in your JWT Token or Cookie.Pro: Hide secret data, e.g. you shouldn’t add a Personal Identifiable Information (PII) claim when using JWT Token.Cons: NonePerformance: It has a very good performance because the claim only calculated if a user is logged in, but it would be slower than example 2 if a database change altered many users.\n\n\n\nNOTE: At the end I talk about using services that follow the IClaimTransformation interface, which could be used in example 2 and 3 instead of adding middleware. \n\n\n\n1. Update user claims via cookie event: Cookie authentication only\n\n\n\nThis example only works with cookie authentication only but its fairly simple and is fast, i.e. it doesn’t add much extra time to each HTTP request and It’s also quite easy to adapt to different situations. The downside is you can’t use this with a JWT Token.\n\n\n\nThe two parts of this implementation are:\n\n\n\nDetect Change: The code links to EF Core’s StateChanged event and detects a change to the entries that would change the claim. On such an event it writes the current UTC DateTime to the “LastChanged” entry in the cache – see the left side of the diagram below.Apply to User: The code links to the cookie’s OnValidatePrincipal event and if the user’s “LastChanged” claim DateTime is older that the “LastChanged” DateTime from the cache,  then it will update the user’s claims and also create a new authentication cookie – see the right side of the diagram below.\n\n\n\nThe figure below shows how this example works.\n\n\n\n\n\n\n\nThe main code to implement contains three pieces of code:\n\n\n\nThe event code to detect the database changes that require an update to user’s claimsThe GlobalChangeTimeService which sets / gets the “LastChanged” entryThe event code called by cookie’s OnValidatePrincipal to check / update a user’s claims\n\n\n\nWith two support services\n\n\n\nA service called ClaimsCalculator that provides the extras claims to add to a user.The Net.DistributedFileStoreCache library to provide a cache with a very fast read.\n\n\n\nLet’s now look at the main code:\n\n\n\n1.3 The event code to detect the database changes\n\n\n\nI’m using EF Core which has a several events to track what is happing to the database. In this case I used EF Core’s ChangeTracker.StateChanged (see this useful article about EF Core events). The code can be found in the TenantKeyOrShardChangeService class inherits the IDatabaseStateChangeEvent interface and much be register via the ASP.NET Core DI provider. The constructor of the application’s DbContext contains an extra parameter containing an IEnumerable<IDatabaseStateChangeEvent> that contains any registered classes that have the IDatabaseStateChangeEvent interface.\n\n\n\nIn this example I am looking for two changes to the Tenant entity:\n\n\n\nThe ParentDataKey property being modified – this would change the DataKey claim, which defines the tenant filer key (lines 13 to 14).The DatabaseInfoName property being modified – this is used in sharding and would change the DatabaseInfoName claim, which defines what database to use (lines 15 to 16).\n\n\n\nThe code below is taken from the TenantKeyOrShardChangeService class and shows the code to register its event listener, and the actual event handler.\n\n\n\npublic void RegisterEventHandlers(\n    AuthPermissionsDbContext context)\n{\n    context.ChangeTracker.StateChanged += \n        RegisterKeyOrShardChange;\n}\n\nprivate void RegisterKeyOrShardChange(object sender, \n    EntityStateChangedEventArgs e)\n{\n    if (e.Entry.Entity is Tenant\n        && e.NewState == EntityState.Modified\n        && (e.Entry.OriginalValues[nameof(Tenant.ParentDataKey)] != \n               e.Entry.CurrentValues[nameof(Tenant.ParentDataKey)] ||\n            e.Entry.OriginalValues[nameof(Tenant.DatabaseInfoName)] !=\n               e.Entry.CurrentValues[nameof(Tenant.DatabaseInfoName)])\n        )\n    {\n        _globalAccessor.SetGlobalChangeTimeToNowUtc();\n    }\n}\n\n\n\nThe SetGlobalChangeTimeToNowUtc method is called if a modification is found. This method comes from the GlobalChangeTimeService class which is described next section.\n\n\n\n1.2 The GlobalChangeTimeService class\n\n\n\nThe GlobalChangeTimeService class provides a thin wrapper around the FileStore cache and has two methods that set and get the “ChangeAtThisTime”  entry in the FileStore cache. Also handles the DateTime conversions. The methods are:\n\n\n\nSetGlobalChangeTimeToNowUtc(), which sets the cache entry with the name “ChangeAtThisTime” with a value of DateTime.UtcNow.DateTimeToTicks()GetGlobalChangeTimeUtc(), which returns a DateTime from the cache entry with the name “ChangeAtThisTime”, or DateTime.MinValue if that entry hasn’t been set.\n\n\n\n1.3 The event code called by cookie’s OnValidatePrincipal\n\n\n\nThe event code can be found in the SomethingChangedCookieEvent class and needs to register it in your Program class using the code shown below\n\n\n\nbuilder.Services.ConfigureApplicationCookie(options =>\n{\n    options.Events.OnValidatePrincipal = \n      SomethingChangedCookieEvent\n          .UpdateClaimsIfSomethingChangesAsync;\n});\n\n\n\nThe code shown below comes from the SomethingChangedCookieEvent class. The steps are:\n\n\n\nLines 4 to 7: Gets the current user’s claims and the latest time a Global Change was found.Lines 9 to 11: If the user’s claims are older that the Global Change time it needs to update the user’s claims.Lines 19 to 25: This updates the AuthP’s claims via its AuthP’s ClaimsCalculator which will recalculate the extra claims, including the claim that holds the last time the claims were updated.Lines 27 to 29: This a) creates a new User (of type ClaimsPrincipal) for this HTTP request, and b) in line 30 it says the authentication cookie should be updated with these new claims.\n\n\n\npublic static async Task UpdateClaimsIfSomethingChangesAsync\n    (CookieValidatePrincipalContext context)\n{\n    var originalClaims = context.Principal.Claims.ToList();\n    var globalTimeService = context.HttpContext.RequestServices\n       .GetRequiredService<IGlobalChangeTimeService>();\n    var lastUpdateUtc = globalTimeService.GetGlobalChangeTimeUtc();\n\n    if (originalClaims.\n           GetClaimDateTimeTicksValue(EntityChangeClaimType) \n        < lastUpdateUtc)\n    {\n        //Need to refresh the user's claims \n        var userId = originalClaims.GetUserIdFromClaims();\n        if (userId == null)\n            //this shouldn't happen, but best to return\n            return;\n\n        var claimsCalculator = context.HttpContext.RequestServices\n            .GetRequiredService<IClaimsCalculator>();\n        var newClaims = await claimsCalculator\n            .GetClaimsForAuthUserAsync(userId);\n        //Copy over unchanged claims\n        newClaims.AddRange(originalClaims.\n            RemoveUpdatedClaimsFromOriginalClaims(newClaims)); \n\n        var identity = new ClaimsIdentity(newClaims, \"Cookie\");\n        var newPrincipal = new ClaimsPrincipal(identity);\n        context.ReplacePrincipal(newPrincipal);\n        context.ShouldRenew = true;\n    }\n}\n\nprivate static IEnumerable<Claim> \n    RemoveUpdatedClaimsFromOriginalClaims(\n        this List<Claim> originalClaims, List<Claim> newClaims)\n{\n    var newClaimTypes = newClaims.Select(x => x.Type);\n    return originalClaims\n        .Where(x => !newClaimTypes.Contains(x.Type));\n}\n\n\n\n2. Replace a user claim on a change: JWT Token and cookie authentication\n\n\n\nThis approach uses middleware to replace a claim, not by updating the user’s claims in the first approach, but by updating the current HTTP User on every HTTP request. The pro of this approach is that it works for JWT Token and cookie authentication, but the con is needs code to run on every HTTP request which cause some performance problems. I only considered this approach after I had created a the FileStore distributed cache, as it has a read time of ~25 nanoseconds.\n\n\n\nLike the first example there are two parts to this approach:\n\n\n\nDetect Change: The code links to EF Core’s StateChanged event and detects a change to the entries that would change the claim. In this case it calculates the new claim value for each affected user and stores each claim value in the cache – see the left side of the diagram below.Apply to User: The extra middleware code runs after the authorization middleware and if a new claim for the current user is found in the cache, then it replaces the out-of-date claim and creates a new ClaimsPrincipal – see the right side of the diagram below.\n\n\n\nThe figure below shows how this example works.\n\n\n\n\n\n\n\nThe main code to implement contains pieces of code:\n\n\n\nThe event code to detect the database changes and add replacement claims to the cache.The middleware which updates the HTTP User if a replacement claim is found in the cache.\n\n\n\nIt also uses the Net.DistributedFileStoreCache library to provide a cache with a very fast read.\n\n\n\nLet’s now look at the main code:\n\n\n\n2.1 The event code to detect the database changes\n\n\n\nIn the first example the database event code just had to detect a change, so it’s used EF Core’s StateChanged event. In this example we need to detect a change and then calculate the updated claim once the database has been updated, which makes the code more complex. You can find the code in the RoleChangedDetectorService class, but because the code is quite long, I will describe the various parts with pseudo-code\n\n\n\n\n\n\n\nThe code in the AddPermissionOverridesToCache method calculates the claim for each effected Users and stores the new claim in the FileStore cache with a key containing the userId of user that the claim applies to.\n\n\n\nThe RoleChangedDetectorService inherits the the IDatabaseStateChangeEvent interface and much be register via the ASP.NET Core DI provider. The constructor of the application’s DbContext contains an extra parameter containing an IEnumerable<IDatabaseStateChangeEvent> that contains any registered classes that have the IDatabaseStateChangeEvent interface.\n\n\n\n2.2. The middleware which updates the HTTP User outdated claim\n\n\n\nThe middleware code can be found in the UpdateRoleClaimMiddleware class which both provides the extension method to register the middleware, and the code that will be called on every HTTP request. Here is the code in you need to your Program class to add this code into the into the middleware pipeline (see highlighted line) – note that the UsePermissionsChange method must come after the UseAuthorization.\n\n\n\n//other code left out\napp.UseAuthentication();\napp.UseAuthorization();\napp.UsePermissionsChange();\n//other code left out\n\n\n\nThe actual method in the UpdateRoleClaimMiddleware class that updates a claim if that claim has been updated is shown below, with this list explain what each part does and where that code is found:\n\n\n\nLines 4 to 5: It only looks at logged-in user. Not logged-in requests are ignored.Lines 12 to 13: This looks for a replacement value for its Permissions’ claim value. If its null, then there no replacement and the current User is used.Lines 17 to 23: This gets the current User’s claims and replaces the Permissions’ claim with a new claim where its value is taken from the found cache.Lines 25 to 28:  This creates a new ClaimsIdentity containing the updated claim. This new user sent back to the outer code which assigns it to the HTTPContext’s  context.User property.\n\n\n\npublic static async Task<ClaimsPrincipal> ReplacePermissionsMiddleware(\n    IServiceProvider serviceProvider, ClaimsPrincipal user)\n{\n    var userId = user.GetUserIdFromUser();\n    if (userId != null)\n    {\n        //There is a logged-in user, find if the\n        //FileStore cache contains a new Permissions claim\n        var fsCache = serviceProvider.GetRequiredService\n            <IDistributedFileStoreCacheClass>();\n\n        var replacementPermissions = await fsCache.GetAsync(\n            userId.FormReplacementPermissionsKey());\n        if (replacementPermissions != null)\n            //Replacement permissions claim found, so update the User\n\n            var updateClaims = user.Claims.ToList();\n            var found = updateClaims.FirstOrDefault(c =>\n                c.Type == PermissionConstants.PackedPermissionClaimType);\n            updateClaims.Remove(found); \n            updateClaims.Add(new Claim(\n                PermissionConstants.PackedPermissionClaimType, \n                replacementPermissions));\n\n            var appIdentity = new ClaimsIdentity(\n                updateClaims, \n                user.Identity!.AuthenticationType);\n            return new ClaimsPrincipal(appIdentity);\n        }\n    }\n    \n    return null; //no change to the current user\n}\n\n\n\nThe ReplacePermissionsMiddleware method is called from the code that registers the middleware. If the method returns null, then the current HTTP User is unchanged as there was no update. If there is an update to the User’s claims the method returns a new User (ClaimsPrincipal), which is then assigned to the HttpContext.User property.\n\n\n\n3. On-demand add a new claim in middleware: JWT Token and cookie\n\n\n\nThe final example is similar to the second example as its uses middleware, but it’s the middleware that calculates the claim rather than the database trigger. This approach is good when you have secret / sensitive claims that you don’t want to put in a JWT Token, because a JWT Token isn’t encrypted. For instance, various privacy rules say that Personal Identifiable Information (PII), e.g. user’s email address, when using JWT Token.\n\n\n\nThe two parts to this approach are:\n\n\n\nOn-demand Claim: The middleware code will look for claim value from the cache. If the cache value is empty, then it will access the database to get the latest value and store that in the cache. Finally, the code will add the claim to the HTTP User.Detect Change: If a database change alters the cache value, then it removes any existing cache value, thus causing the middleware to recalculate the claim value for the user.\n\n\n\nThe figure below shows how this example works.\n\n\n\n\n\n\n\nThe main code to implement contains pieces of code:\n\n\n\nThe middleware which adds a new claim to the HTTP User from the cache.The event code to detect the database changes and removes the cache value.\n\n\n\nIt also uses the Net.DistributedFileStoreCache library to provide a cache with a very fast read.\n\n\n\nLet’s now look at the main code:\n\n\n\n3.1 The middleware which adds a new claim\n\n\n\nThe middleware code can be found in the AddEmailClaimMiddleware class which both provides the extension method to register the middleware, and the code that will be called on every HTTP request. Here is the code in you need to your Program class to add this code into the into the middleware pipeline (see highlighted line) – note that the UseAddEmailClaimToUsers method must come after the UseAuthorization.\n\n\n\n//other code left out\napp.UseAuthentication();\napp.UseAuthorization();\napp.UseAddEmailClaimToUsers();\n//other code left out\n\n\n\nThe actual method in the AddEmailClaimMiddleware class that adds the new claim is shown below, with this list explain what each part does and where that code is found:\n\n\n\nLines 4 to 5: It only looks at logged-in user. Not logged-in requests are ignored.Lines 11  to 13: This looks for a replacement value for its Email claim value. If its null, then it needs to access the database for the latest email of the current HTTP User.Lines 16 to 26: This gets the current user email from the database and adds a cache entry so that the next time it doesn’t have to query the database.Lines 30 to 35:  This creates a new ClaimsIdentity containing the added email claim. This new user sent back to the outer code which assigns it to the HTTPContext’s  User property.\n\n\n\npublic static async Task<ClaimsPrincipal> AddEmailClaimToCurrentUser(\n    IServiceProvider serviceProvider, ClaimsPrincipal user)\n{\n    var userId = user.GetUserIdFromUser();\n    if (userId != null)\n    {\n        //There is a logged-in user, so cache contains a new Permissions claim\n        var fsCache = serviceProvider.GetRequiredService\n            <IDistributedFileStoreCacheClass>();\n\n        var usersEmail = await fsCache.GetAsync(\n            userId.FormAddedEmailClaimKey());\n        if (usersEmail == null)\n        {\n            //Not set up yet, get the user's email \n            var context = serviceProvider.GetRequiredService\n                 <AuthPermissionsDbContext>();\n            usersEmail = context.AuthUsers\n                 .Where(x => x.UserId == userId)\n                 .Select(x => x.Email).FirstOrDefault();\n            \n            if (usersEmail == null)\n                return null; //shouldn't happen, but could in certain updates\n\n            //Add to cache so next time it will be quicker\n            await fsCache.SetAsync(userId.FormAddedEmailClaimKey(), usersEmail);\n        }\n\n        //We need to add the Email from the cache\n        var updateClaims = user.Claims.ToList();\n        updateClaims.Add(new Claim(ClaimTypes.Email, usersEmail));\n\n        var appIdentity = new ClaimsIdentity(updateClaims,\n            user.Identity!.AuthenticationType);\n        return new ClaimsPrincipal(appIdentity);\n    }\n    \n    return null; //no change to the current user\n}\n\n\n\nThe AddEmailClaimToCurrentUser method is called from the code that registers the middleware. If the user is logged in the method will return a new User (ClaimsPrincipal) with the email claim added, which is then assigned to the HttpContext.User property. For user that aren’t logged in, then the method returns null, which means the current User should be used.\n\n\n\n3.2. The event code to detect the change of a user’s email\n\n\n\nThe database event code is very simple – if a user’s email has changed, then make sure the cache entry linked to the user’s email is removed. That means the next time that user accesses the web app the AddEmailClaimMiddleware will recalculate the user’s email (and add the cache entry).\n\n\n\nThe code below come from the EmailChangeDetectorService class.\n\n\n\npublic void RegisterEventHandlers(AuthPermissionsDbContext context)\n{\n    context.ChangeTracker.StateChanged += \n         delegate(object sender, EntityStateChangedEventArgs e)\n    {\n        if (e.Entry.Entity is AuthUser user\n            && e.NewState == EntityState.Modified\n            && e.Entry.OriginalValues[nameof(AuthUser.Email)] \n               != e.Entry.CurrentValues[nameof(AuthUser.Email)]\n            )\n            //Email has changed, so we remove the current cache value\n            _fsCache.Remove(user.UserId.FormAddedEmailClaimKey());\n    };\n}\n\n\n\nThe EmailChangeDetectorService inherits the IDatabaseStateChangeEvent interface, and much be register via the ASP.NET Core DI provider. The constructor of the application’s DbContext contains an extra parameter containing an IEnumerable<IDatabaseStateChangeEvent> that contains any registered classes that have the IDatabaseStateChangeEvent interface.\n\n\n\n4. Extra: Using IClaimTransformation to update the user’s claims\n\n\n\nI wanted to add this extra part to talk about services that follow the IClaimTransformation interface to update the user’s claims. Like the middleware approach the IClaimTransformation services run on every HTTP request after the AuthenticateAsync middleware.\n\n\n\nI haven’t used IClaimTransformation services but when Mohammed Ahmed Hussien (twitter: @shoogn17) pointed it out I can see that it might be easier for people to use because:\n\n\n\nYou can use the normal constructor dependency injection to inject other services you need in your code.Unlike the middleware approach a IClaimTransformation service only runs if there a logged-in user, which means you don’t have to add code to ignore non-logged in users.\n\n\n\nThis section from the Microsoft docs gives you a simple example of how you would create and register a IClaimTransformation service.\n\n\n\nI haven’t compared the middleware and IClaimTransformation service for performance, but I would expect both of them are fast, assuming your code doesn’t access a database every HTTP request. (I found a couple of articles about IClaimTransformation which has database accesses on every HTTP request. I don’t recommend that for performance reason, which is why I use the FileStore cache to keep the claim update fast.)\n\n\n\nConclusions\n\n\n\nThis article gives a detailed looks at three ways to update the claims of a logged-in user to a ASP.NET Core application. The three examples provide a wide range of approaches that cover most claim update situations. And each example can be tweaked to make them perform better for specific changes: for instance, the first example updates all logged-in users, but I could be changed to be more selective on which users are updated.    \n\n\n\nI start with the cookie-only approach which I used many years ago on my first ASP.NET Core application for a client. Its pretty simple and performs very well when changes are infrequent. I have used this for many years, including in client’s applications, and it well tried and tested. The only change I have added in this article is the use of the FileStore distributed cache, which makes it a bit faster.\n\n\n\nFor many years I didn’t have a viable solution for changing the claims when using JWT Token authentication, which is a problem as many frontend frameworks work better with a JWT Token. It wasn’t until I build the FileStore distributed cache, which has a very fast read time, e.g. ~25 nanoseconds (see FileStore distributed cache benchmark for full data), that I found an approach that has a good per-HTTP request performance.\n\n\n\nExamples 2 and 3 offer two approaches that work with both cookie and JWT Token authentication, with their implementations almost the reverse of each other: example 2 calculates the updated claims within the database event, while example 3 calculate the claim in the middleware code. These different approaches also provide different performance parameters – see the performance section in the list of the three approaches in introduction section for more on this.\n\n\n\nNOTE: These three examples are in the AuthP’s repro examples and be tried by running various ASP.NET Core applications. The Update user claims via cookie event version can be found in AuthP’s Example4 hierarchical multi-tenant application and Authp’s Example6 sharding multi-tenant application. The last two examples work with JWT Token, so both middleware versions are in the AuthP’s Example2 WebApi application that uses the JWT Token authentication.\n\n\n\nHappy coding."
  },
  {
    "itemId": "https://www.thereformedprogrammer.net/?p=2769",
    "raw": "\n<p>If you have an e-commerce or business web app used by lots of users, then you really don’t want that app to be “down” (e.g. “site offline” or “site not found”) because it’s bad for business. But at the same time some database changes are just too complex to allow users to access a database while the data being changed. This article describes a way to momentary divert users during a database is changed, which means that the database change code has exclusive access, and any change has the smallest effect on your logged-in users.</p>\n\n\n\n<p>I designed this approach for <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Multi-tenant-explained\">multi-tenant applications</a>, especially when using <a href=\"https://en.wikipedia.org/wiki/Shard_(database_architecture)\">sharding</a>. In these sorts of applications a single tenant might need changing or moved and the code to do that needs exclusive access – see this <a href=\"https://docs.microsoft.com/en-us/azure/azure-sql/database/elastic-scale-overview-split-and-merge\">Microsoft article</a> which describes the split and merge processes, which are two examples of changes that need exclusive access.</p>\n\n\n\n<p>This article is part of the series that covers .NET multi-tenant applications in general. The other articles in “Building ASP.NET Core and EF Core multi-tenant apps” series are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part1-the-database/\">The database: Using a DataKey to only show data for users in their tenant</a></li><li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part2-administration/\">Administration: different ways to add and control tenants and users</a></li><li><a href=\"https://www.thereformedprogrammer.net/multi-tenant-apps-with-different-versions-can-increase-your-profits/\">Versioning your app: Creating different versions to maximise your profits</a></li><li><a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-hierarchical-multi-tenant-apps/\">Hierarchical multi-tenant: Handling tenants that have sub-tenants</a></li><li><a href=\"https://www.thereformedprogrammer.net/advanced-techniques-around-asp-net-core-users-and-their-claims/\">Advanced techniques around ASP.NET Core Users and their claims</a></li><li><a href=\"https://www.thereformedprogrammer.net/part6-using-sharding-to-build-multi-tenant-apps-using-asp-net-core-and-ef-core/\">Using sharding to build multi-tenant apps using EF Core and ASP.NET Core</a> </li><li><a href=\"https://www.thereformedprogrammer.net/three-ways-to-securely-add-new-users-to-an-application-using-the-authp-library/\">Three ways to securely add new users to an application using the AuthP library</a></li><li>How to take an ASP.NET Core web site “Down for maintenance” <strong>(This article)</strong></li><li><a href=\"https://www.thereformedprogrammer.net/asp-net-core-three-ways-to-refresh-the-claims-of-a-logged-in-user/\">Three ways to refresh the claims of a logged-in user</a></li></ol>\n\n\n\n<p></p>\n\n\n\n<h2 class=\"wp-block-heading\">TL;DR; – Summary of this article</h2>\n\n\n\n<ul class=\"wp-block-list\"><li>The feature described is solves a problem that can arise in multi-tenant applications, that is it can temporarily stop users from accessing a tenant’s data while a complex change is applied to the tenant data. A “complex change” might be moving a tenant’s data to another database.</li><li>The solution uses ASP.NET Core’s <a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/\">middleware</a> to intercept every HTTP request and checks that that data that the user might access isn’t “down”, i.e. that data is being changed and mustn’t accessed. If the data the user uses is “down” they are diverted to a “down for maintenance – back soon” page.</li><li>Because the middleware is called on every HTTP request, I have used the FileStore distributed cache, which has a read time of ~25 ns, which means this feature doesn’t slow down the application.</li><li>I have implemented the code in version 3.4.0 of my open-source <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore\">AuthPermissions.AspNetCore</a> library – see the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/%22Down-for-maintenance%22-feature\">“Down for Maintenance”</a> documentation. But the design and code of this feature can be copied to any ASP.NET Core application.</li></ul>\n\n\n\n<h2 class=\"wp-block-heading\">Setting the scene – why did I need this feature</h2>\n\n\n\n<p>I have a library called my <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore\">AuthPermissions.AspNetCore</a> library (referred to as AuthP in this article) that helps developers to build complex multi-tenant applications and it includes sharding, that is each tenant has their own database. One of the best ways to manage lots of databases is <a href=\"https://docs.microsoft.com/en-us/azure/azure-sql/database/elastic-pool-overview\">Azure SQL Server elastic pools</a> but the suggested <a></a><a href=\"https://github.com/Azure/elastic-db-tools\">elastic pool support</a> library is <a href=\"https://github.com/Azure/elastic-db-tools/issues/221\">not supported any more</a>. So, if I wanted to use SQL Server elastic pools, then I needed to build code that implements the split-merge code.</p>\n\n\n\n<p>I had built most of the features needed, like defining a tenant and the <a href=\"https://www.thereformedprogrammer.net/building-asp-net-core-and-ef-core-multi-tenant-apps-part1-the-database/\">keys for each tenant</a> and <a href=\"https://www.thereformedprogrammer.net/part6-using-sharding-to-build-multi-tenant-apps-using-asp-net-core-and-ef-core/\">sharding</a>, in version 3.0.0 of the AuthP library, but the last missing feature is the ability to stop users from accessing a tenant while it is changed / moved (I used the term <em>move</em> for both split and merge). That’s because if a user is accessing the tenant data at the same time as a, then the user might get the wrong data or more crucially, it can cause data loss during a move.</p>\n\n\n\n<p>The diagram below shows the process I need to build if I want to successfully change / move a tenant’s data while the application is still running. &nbsp;Note that only tenant user linked to “tenant 123” are diverted while users not linked to “tenant 123” would work normally.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceTenantUpdate.png\"><img loading=\"lazy\" decoding=\"async\" width=\"820\" height=\"547\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceTenantUpdate.png\" alt=\"\" class=\"wp-image-2770\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceTenantUpdate.png 820w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceTenantUpdate-300x200.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceTenantUpdate-768x512.png 768w\" sizes=\"auto, (max-width: 820px) 100vw, 820px\" /></a></figure>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: In the AuthP library the keys to a tenant data key(s) are held in the user’s claims, which means that after a change / move the user’s tenant claims(s) need updating. The AuthP library has a feature called “<a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Update-claims-on-tenant-change\">update claims on tenant change</a>” &#8211; click the link to go to the documentation.</p></blockquote>\n\n\n\n<p>It turns out that the solution to implement this “down” process is to use ASP.NET Core’s <a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/\">Middleware</a>. You can intercept a user and divert them to another page / url if a move / change is in action by adding an extra middleware in the correct place. I call a divert a “down” because the tenant is “down for maintenance” while the change / move is being executes.</p>\n\n\n\n<p>The downside of the added the extra middleware is that the code is called on every HTTP request. This means the middleware needs to be is fast, otherwise you will slow down your whole application for a few, infrequent change / move diverts. I solved this by creating the <a href=\"https://www.thereformedprogrammer.net/a-net-distributed-cache-with-a-25-nanosecond-read-time/\">FileStore distritributed cache</a>, which has a very fast read time (e.g. ~25 ns).</p>\n\n\n\n<p>Read on to see how this works and how you could use it.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Design aims: what database changes do I want to cover?</h2>\n\n\n\n<p>The main “down” feature is temporarily diverting users accessing a tenant database while a change / move is being applied, but I also found some other added some extra diverts as well, which are listed below:</p>\n\n\n\n<ul class=\"wp-block-list\"><li><strong>Manual, application “down”:</strong> Allows an admin user to manually “down” the whole application. Every user apart from the admin who took the app “down” will be diverted to a page with an explanation and expected time when the app will be available.</li><li><strong>Manual, tenant database “down”:</strong> Allows an admin user to manually “down” a tenant database, thus diverting all users linked to the tenant database to a page saying, “stopped by admin”.&nbsp; Access to the tenant can be restored by an admin manually removing this this “down”.</li><li><strong>Tenant database Delete:</strong> This permanently diverts all users linked to the deleted tenant to a page saying, “the tenant is deleted”. This is a permanent divert, but it can be removed manually.&nbsp;</li></ul>\n\n\n\n<p>Here is a diagram that shows how the“ down for maintenance” feature can be implemented in ASP.Net Core.</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenance-flow.png\"><img loading=\"lazy\" decoding=\"async\" width=\"1024\" height=\"492\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenance-flow-1024x492.png\" alt=\"\" class=\"wp-image-2771\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenance-flow-1024x492.png 1024w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenance-flow-300x144.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenance-flow-768x369.png 768w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenance-flow.png 1145w\" sizes=\"auto, (max-width: 1024px) 100vw, 1024px\" /></a></figure>\n\n\n\n<p>The rest of the article describes each step in “down for maintenance” feature, with references to the code in my AuthP library. The steps are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li><a href=\"https://www.thereformedprogrammer.net/how-to-take-an-asp-net-core-web-site-down-for-maintenance/#1-startup-registering-the-services\">Startup: Registering the services</a> </li><li><a href=\"https://www.thereformedprogrammer.net/how-to-take-an-asp-net-core-web-site-down-for-maintenance/#2-create-a-controller-web-apis-to-handle-the-down-for-maintenance\">Adding a StatusController (or an equivalent Web API)</a> </li><li><a href=\"https://www.thereformedprogrammer.net/how-to-take-an-asp-net-core-web-site-down-for-maintenance/#3-using-the-isetremovestatus-service-to-set-remove-a-down-state\">Using the ISetRemoveStatus service to set / remove a “down” state</a></li><li><a href=\"https://www.thereformedprogrammer.net/how-to-take-an-asp-net-core-web-site-down-for-maintenance/#4-understanding-the-down-for-maintenance-middleware\">Understanding the “down for maintenance” middleware</a></li><li><a href=\"https://www.thereformedprogrammer.net/how-to-take-an-asp-net-core-web-site-down-for-maintenance/#5-other-things-to-consider-when-moving-a-tenant-database\">Other things to consider when moving a tenant database</a></li></ol>\n\n\n\n<h2 class=\"wp-block-heading\">1. Startup: Registering the services</h2>\n\n\n\n<p>There are two parts to setup the register the “down for maintenance” feature:</p>\n\n\n\n<ul class=\"wp-block-list\"><li>Registering the “down for maintenance” services</li><li>Adding the “down for maintenance” middleware.</li></ul>\n\n\n\n<p>Both parts are applied in the ASP.NET Core Program / Startup code. First is the registering of the FileStore cache, which holds the various “down” statuses, and the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DownStatusCode/SetRemoveStatus.cs\">SetRemoveStatus</a> class, which provide simple methods to add / remove “down” statuses. The code below is added in the startup section that registers services with the .NET dependency injection provider.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\n//previous code left out\nbuilder.Services.AddDistributedFileStoreCache(options =&gt;\n{\n    options.WhichVersion = FileStoreCacheVersions.Class;\n}, builder.Environment);\n\nbuilder.Services.AddTransient\n     &lt;ISetRemoveStatus, SetRemoveStatus&gt;(); \n</pre></div>\n\n\n<p>The “down for maintenance” middleware is added in the “app” part of the ASP.NET Core startup code – see the highlighted line that adds the extra middleware.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; highlight: [6]; title: ; notranslate\">\nvar app = builder.Build();\n//other app code left out\n\napp.UseAuthentication();\napp.UseAuthorization();\napp.UseDownForMaintenance();\n\n//other code left out\n</pre></div>\n\n\n<p>The important thing is that the “down for maintenance” middleware is added AFTER the UseAuthorization method. That’s because the “down for maintenance” middleware needs assess to the user’s claims.</p>\n\n\n\n<h3 class=\"wp-block-heading\">2. Create a Controller / web APIs to handle the “down for maintenance”</h3>\n\n\n\n<p>You need pages / APIs to handle the following:</p>\n\n\n\n<ul class=\"wp-block-list\"><li>For the admin users<ul><li>Look at all the current “downs” and have the ability to remove any</li></ul><ul><li>Manually set the app “down” (with messages for the users)</li></ul><ul><li>Manually set a tenant “down”</li></ul></li><li>For diverted users<ul><li>App Down</li></ul><ul><li>Tenant down while being updated</li></ul><ul><li>Tenant down by admin</li></ul><ul><li>Tenant is deleted</li></ul></li></ul>\n\n\n\n<p>In the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example4.MvcWebApp.IndividualAccounts\">Example4</a> web site (hierarchical tenant design) and <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/tree/main/Example6.MvcWebApp.Sharding\">Example6</a> web site (single-level + sharding) I have a controller called StatusController that contains the actions / pages listed above. Please look at the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/Example4.MvcWebApp.IndividualAccounts/Controllers/StatusController.cs\">Example4’s StatusController</a> for an example of what you need to create.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: the diverted pages are hard coded into the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DownStatusCode/RedirectUsersViaStatusData.cs\">RedirectUsersViaStatusData</a> class, while the controller’s name can be changed. If you want to have different urls for the diverted pages, then you need to copy the code and register your version of the RedirectUsersViaStatusData class.</p></blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">3. Using the ISetRemoveStatus service to set / remove a “down” state</h3>\n\n\n\n<p>The <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DownStatusCode/SetRemoveStatus.cs\">SetRemoveStatus</a> class contains the code to set, remove and display the “down” statues in the FileStore distributed cache. There are many types of diverts and this service creates the cache key which defines the type of divert that the user should be diverted to.</p>\n\n\n\n<p>The AppDown divert is easy because it has one divert, but the tenant divert is more complex because a) it has three divert types and b) a divert is unique to a tenant. Each “down” entry in FileStore distributed database has a unique key name, which allows you to have multiple “downs” at once. And in the case of a tenant down the FileStore entry’s value is the tenant key, which is used to detect if the user is linked to a tenant that is in a “down” state.</p>\n\n\n\n<p>The ISetRemoveStatus service makes it easy for the developer to wrap your change / move code with a “down” at the start and remove the “down”” at the end. The code below shows an example of how the ISetRemoveStatus service would work, with the “down” and remove “down” code highlighted.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; highlight: [7,8,9,13]; title: ; notranslate\">\n&#x5B;HttpPost]\n&#x5B;ValidateAntiForgeryToken]\n&#x5B;HasPermission(Example6Permissions.MoveTenantDatabase)]\npublic async Task&lt;IActionResult&gt; MoveDatabase(\n    ShardingSingleLevelTenantDto input)\n{\n    var removeDownAsync = await _upDownService\n        .SetTenantDownWithDelayAsync(\n              TenantDownVersions.Update, input.TenantId);\n    var status = await _authTenantAdmin\n        .MoveToDifferentDatabaseAsync(input.TenantId, \n              input.HasOwnDb, input.ConnectionName);\n    await removeDownAsync();\n\n    return status.HasErrors\n        ? RedirectToAction(nameof(ErrorDisplay),\n              new { errorMessage = status.GetAllErrors() })\n        : RedirectToAction(nameof(Index), \n              new { message = status.Message });\n}\n</pre></div>\n\n\n<p>As you can see you define what type of tenant change via the TenantDownVersions enums. The ISetRemoveStatus service handles creating the key name for the actual “down” entry in the FileStore distributed database. The “down” entry key string is designed to make finding / filtering the “down” values to work quickly, so the key string is a bit complex. The figure below shows the various combinations of key names to provide a) define what type of divert it is, and b) is unique name for each tenant.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceDivertKeys.png\"><img loading=\"lazy\" decoding=\"async\" width=\"825\" height=\"339\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceDivertKeys.png\" alt=\"\" class=\"wp-image-2772\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceDivertKeys.png 825w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceDivertKeys-300x123.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceDivertKeys-768x316.png 768w\" sizes=\"auto, (max-width: 825px) 100vw, 825px\" /></a></figure>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: For a tenant “down” entry the value is the tenant’s unique key, while for the AppDown the value contains a message, expected time, and UserId of the user that “downed” the whole app.</p></blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">4. Understanding the “down for maintenance” middleware</h3>\n\n\n\n<p>The middleware code (see <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DownStatusCode/RedirectUsersViaStatusData.cs\">RedirectUsersViaStatusData</a> class) is called on every HTTP request, and its job is to quickly let through a user if there isn’t an “down” status that effects the current user. There are three stages in this middleware to cover each part of the filter. They are:</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: I use the term <em>admin user</em> (see this link) to define a user who is managing the application. These types of users have a) access to high-level admin features and b) aren’t linked to a tenant.</p></blockquote>\n\n\n\n<h4 class=\"wp-block-heading\">STAGE 1: Allowed URLs get through</h4>\n\n\n\n<p>The middleware allows two types of URLs.</p>\n\n\n\n<ul class=\"wp-block-list\"><li>You can login and logout. I added this when I “downed” the app and then rerun the app, at which point I couldn’t log to remove the “App down”!</li><li>I allow access to the Status controller. This allows an admin user and manually turn off a “down” if anything goes wrong.</li></ul>\n\n\n\n<h4 class=\"wp-block-heading\">STAGE 2: Handle AppDown</h4>\n\n\n\n<p>The AppDown feature stops all users from using the application’s features, apart from the admin user that “downed” the app. This means that the admin user can check / fix the problem before removing the “down” on the app.</p>\n\n\n\n<p>This feature is there for situations where the application’s software or data that can’t be updated by the normal deploy / migrate approach. You will rarely need the AppDown feature, but it’s there for emergencies.</p>\n\n\n\n<h4 class=\"wp-block-heading\">STAGE 3: Handle Tenant “down”</h4>\n\n\n\n<p>The main usage of the middleware is to managing changes to a tenant’s data and the code uses the start of the “down” key to detect which types of divert is needed. The three types are:</p>\n\n\n\n<ul class=\"wp-block-list\"><li>Tenant down while being updated</li><li>Tenant down by an admin use (known as tenant “manual down”)</li><li>Tenant is deleted (this stops user trying a tenant that doesn’t exist)</li></ul>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: An example of the code to take a tenant “down” while being updated can be found in <a href=\"https://www.thereformedprogrammer.net/how-to-take-an-asp-net-core-web-site-down-for-maintenance/#3-using-the-isetremovestatus-service-to-set-remove-a-down-state\">section 3</a>.</p></blockquote>\n\n\n\n<p>The middleware code isn’t complex, but it’s a bit hard to follow so I have provided a flowchart to show how the three stages are handled. The important thing is the middleware is very fast (via using the FileStore distributed cache) at letting though users when no “down” is active.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceMiddlewareFlowChart.png\"><img loading=\"lazy\" decoding=\"async\" width=\"736\" height=\"734\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceMiddlewareFlowChart.png\" alt=\"\" class=\"wp-image-2773\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceMiddlewareFlowChart.png 736w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceMiddlewareFlowChart-300x300.png 300w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/DownForMaintenanceMiddlewareFlowChart-150x150.png 150w\" sizes=\"auto, (max-width: 736px) 100vw, 736px\" /></a></figure>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: The <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/DownStatusCode/RedirectUsersViaStatusData.cs\">RedirectUsersViaStatusData</a> class has comments starting with the three STAGES shown in the flowchart.</p></blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">5. Other things to consider when moving a tenant database</h3>\n\n\n\n<p>The tenant “Down for Maintenance” feature solves the most complex issue of ensuring that the tenant data isn’t accessed during the data is moved. But there are some extra issues you need to consider which the AuthP library already has solutions for. The issues are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li>Updating the tenant user’s DataKey claims on a move</li><li>An internal hierarchical move needs to “down” two parts of the tenant data</li><li>The <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Multi-tenant:-Admin-access-tenant-data\">admin access to tenant data</a> feature needs extra code in the middleware</li></ol>\n\n\n\n<h4 class=\"wp-block-heading\">5.1. Updating the tenant user’s DataKey claims on a move</h4>\n\n\n\n<p>If you are moving a database in a <a href=\"https://www.thereformedprogrammer.net/part6-using-sharding-to-build-multi-tenant-apps-using-asp-net-core-and-ef-core/\">sharding multi-tenant</a> application or <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Hierarchical-Multi-Tenant#moving-a-hierarchical-tenant\">moving data in a hierarchical multi-tenant</a> application, then the information used by the user to access the tenant data will change. Therefore, you MUST update the information used by the user to access the tenant data.</p>\n\n\n\n<p>In the AuthP library the user’s key to a tenant data is held in the user’s claims which makes the user access very fast (see <a href=\"https://www.thereformedprogrammer.net/advanced-techniques-around-asp-net-core-users-and-their-claims/#4-refreshing-the-logged-in-users-claims-on-an-event\">this section</a> of an earlier article). But that means that the tenant claims need to be updated when the DataKey changes, and AuthP has feature that detects a change to the tenant DataKey parts and then makes sure all the logged-in users have their claims updated – see the AuthP “<a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Update-claims-on-tenant-change\">update claims on tenant change</a>” documentation on how this works.</p>\n\n\n\n<h4 class=\"wp-block-heading\">5.2. An internal hierarchical move needs to “down” two parts of the tenant data</h4>\n\n\n\n<p>The AuthP hierarchical multi-tenant has a move feature where a section of the hierarchical data can be moved to another part of the hierarchy – known as the <em>parent</em> (see <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Hierarchical-Multi-Tenant#moving-a-hierarchical-tenant\">this example</a>). In this case you need to “down” both the section to be moved and the section that the moved too.</p>\n\n\n\n<p>For this reason, the SetTenantDownWithDelayAsync method has an optional parameter called parentId. If the parentId is not zero, then it will also “down” the parent during the hierarchical move. The code below shows the code, with the extra parentId parameter highlighted.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; highlight: [4]; title: ; notranslate\">\nvar removeDownAsync = await _upDownService\n    .SetTenantDownWithDelayAsync(\n        TenantDownVersions.Update, input.TenantId, \n        input.ParentId);\nvar status = await _authTenantAdmin\n    .MoveHierarchicalTenantToAnotherParentAsync\n        (input.TenantId, input.ParentId);\nawait removeDownAsync();\n\n</pre></div>\n\n\n<h4 class=\"wp-block-heading\">5.3. The “admin access to tenant” data feature needs extra code in the middleware</h4>\n\n\n\n<p>The AuthP library provides a feature that allows admin / support users (i.e. users not linked to a tenant) to temporary gain access to a tenant’s data (see the <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/wiki/Multi-tenant:-Admin-access-tenant-data\">admin access to tenant documentation</a> for more information).</p>\n\n\n\n<p>This is implemented by using a cookie to contain the tenant DataKey, but the “down for maintenance” middleware doesn’t contain code to handle that. While giving admin user a way to access the tenant’s data is useful if a problem occurs in the change / move, but admin must be aware of any tenant change / move and not try to access that tenant (or turn off the “admin access to tenant” feature).</p>\n\n\n\n<h2 class=\"wp-block-heading\">Conclusions</h2>\n\n\n\n<p>Back in 2015 I wrote an article about <a href=\"https://www.thereformedprogrammer.net/how-to-take-a-asp-net-mvc-web-site-down-for-maintenance/\">how to take an ASP.NET MVC5 web site “Down for maintenance”</a> and now in 2022 I this article provides a version for an ASP.NET Core application. The basic approach of using middleware is the same, but this latest approach also contains features to handle multi-tenant applications.</p>\n\n\n\n<p>Both the older ASP.NET MVC5 version and the latest ASP.NET Core are designed to be quick. This focus on high performance is because the code is run on every HTTP request. Both versions use a shared file to work across multiple instances of the web applications, for instance when you use Azure’s scale-out. But the new version has much more complex needs, with tenant-level “down” features, which required a more sophisticated approach, which is handled by the <a href=\"https://www.thereformedprogrammer.net/a-net-distributed-cache-with-a-25-nanosecond-read-time/\">FileStore distributed cache</a> acting as a fast-read / slow-write database.</p>\n\n\n\n<p>With this feature added to version 3.4.0 of the AuthP library you can safely manage tenants while users are accessing your multi-tenant application.</p>\n",
    "sanitized": "If you have an e-commerce or business web app used by lots of users, then you really don’t want that app to be “down” (e.g. “site offline” or “site not found”) because it’s bad for business. But at the same time some database changes are just too complex to allow users to access a database while the data being changed. This article describes a way to momentary divert users during a database is changed, which means that the database change code has exclusive access, and any change has the smallest effect on your logged-in users.\n\n\n\nI designed this approach for multi-tenant applications, especially when using sharding. In these sorts of applications a single tenant might need changing or moved and the code to do that needs exclusive access – see this Microsoft article which describes the split and merge processes, which are two examples of changes that need exclusive access.\n\n\n\nThis article is part of the series that covers .NET multi-tenant applications in general. The other articles in “Building ASP.NET Core and EF Core multi-tenant apps” series are:\n\n\n\nThe database: Using a DataKey to only show data for users in their tenantAdministration: different ways to add and control tenants and usersVersioning your app: Creating different versions to maximise your profitsHierarchical multi-tenant: Handling tenants that have sub-tenantsAdvanced techniques around ASP.NET Core Users and their claimsUsing sharding to build multi-tenant apps using EF Core and ASP.NET Core Three ways to securely add new users to an application using the AuthP libraryHow to take an ASP.NET Core web site “Down for maintenance” (This article)Three ways to refresh the claims of a logged-in user\n\n\n\n\n\n\n\nTL;DR; – Summary of this article\n\n\n\nThe feature described is solves a problem that can arise in multi-tenant applications, that is it can temporarily stop users from accessing a tenant’s data while a complex change is applied to the tenant data. A “complex change” might be moving a tenant’s data to another database.The solution uses ASP.NET Core’s middleware to intercept every HTTP request and checks that that data that the user might access isn’t “down”, i.e. that data is being changed and mustn’t accessed. If the data the user uses is “down” they are diverted to a “down for maintenance – back soon” page.Because the middleware is called on every HTTP request, I have used the FileStore distributed cache, which has a read time of ~25 ns, which means this feature doesn’t slow down the application.I have implemented the code in version 3.4.0 of my open-source AuthPermissions.AspNetCore library – see the “Down for Maintenance” documentation. But the design and code of this feature can be copied to any ASP.NET Core application.\n\n\n\nSetting the scene – why did I need this feature\n\n\n\nI have a library called my AuthPermissions.AspNetCore library (referred to as AuthP in this article) that helps developers to build complex multi-tenant applications and it includes sharding, that is each tenant has their own database. One of the best ways to manage lots of databases is Azure SQL Server elastic pools but the suggested elastic pool support library is not supported any more. So, if I wanted to use SQL Server elastic pools, then I needed to build code that implements the split-merge code.\n\n\n\nI had built most of the features needed, like defining a tenant and the keys for each tenant and sharding, in version 3.0.0 of the AuthP library, but the last missing feature is the ability to stop users from accessing a tenant while it is changed / moved (I used the term move for both split and merge). That’s because if a user is accessing the tenant data at the same time as a, then the user might get the wrong data or more crucially, it can cause data loss during a move.\n\n\n\nThe diagram below shows the process I need to build if I want to successfully change / move a tenant’s data while the application is still running.  Note that only tenant user linked to “tenant 123” are diverted while users not linked to “tenant 123” would work normally.\n\n\n\n\n\n\n\nNOTE: In the AuthP library the keys to a tenant data key(s) are held in the user’s claims, which means that after a change / move the user’s tenant claims(s) need updating. The AuthP library has a feature called “update claims on tenant change” – click the link to go to the documentation.\n\n\n\nIt turns out that the solution to implement this “down” process is to use ASP.NET Core’s Middleware. You can intercept a user and divert them to another page / url if a move / change is in action by adding an extra middleware in the correct place. I call a divert a “down” because the tenant is “down for maintenance” while the change / move is being executes.\n\n\n\nThe downside of the added the extra middleware is that the code is called on every HTTP request. This means the middleware needs to be is fast, otherwise you will slow down your whole application for a few, infrequent change / move diverts. I solved this by creating the FileStore distritributed cache, which has a very fast read time (e.g. ~25 ns).\n\n\n\nRead on to see how this works and how you could use it.\n\n\n\nDesign aims: what database changes do I want to cover?\n\n\n\nThe main “down” feature is temporarily diverting users accessing a tenant database while a change / move is being applied, but I also found some other added some extra diverts as well, which are listed below:\n\n\n\nManual, application “down”: Allows an admin user to manually “down” the whole application. Every user apart from the admin who took the app “down” will be diverted to a page with an explanation and expected time when the app will be available.Manual, tenant database “down”: Allows an admin user to manually “down” a tenant database, thus diverting all users linked to the tenant database to a page saying, “stopped by admin”.  Access to the tenant can be restored by an admin manually removing this this “down”.Tenant database Delete: This permanently diverts all users linked to the deleted tenant to a page saying, “the tenant is deleted”. This is a permanent divert, but it can be removed manually. \n\n\n\nHere is a diagram that shows how the“ down for maintenance” feature can be implemented in ASP.Net Core.\n\n\n\n\n\n\n\nThe rest of the article describes each step in “down for maintenance” feature, with references to the code in my AuthP library. The steps are:\n\n\n\nStartup: Registering the services Adding a StatusController (or an equivalent Web API) Using the ISetRemoveStatus service to set / remove a “down” stateUnderstanding the “down for maintenance” middlewareOther things to consider when moving a tenant database\n\n\n\n1. Startup: Registering the services\n\n\n\nThere are two parts to setup the register the “down for maintenance” feature:\n\n\n\nRegistering the “down for maintenance” servicesAdding the “down for maintenance” middleware.\n\n\n\nBoth parts are applied in the ASP.NET Core Program / Startup code. First is the registering of the FileStore cache, which holds the various “down” statuses, and the SetRemoveStatus class, which provide simple methods to add / remove “down” statuses. The code below is added in the startup section that registers services with the .NET dependency injection provider.\n\n\n\n//previous code left out\nbuilder.Services.AddDistributedFileStoreCache(options =>\n{\n    options.WhichVersion = FileStoreCacheVersions.Class;\n}, builder.Environment);\n\nbuilder.Services.AddTransient\n     <ISetRemoveStatus, SetRemoveStatus>(); \n\n\n\nThe “down for maintenance” middleware is added in the “app” part of the ASP.NET Core startup code – see the highlighted line that adds the extra middleware.\n\n\n\nvar app = builder.Build();\n//other app code left out\n\napp.UseAuthentication();\napp.UseAuthorization();\napp.UseDownForMaintenance();\n\n//other code left out\n\n\n\nThe important thing is that the “down for maintenance” middleware is added AFTER the UseAuthorization method. That’s because the “down for maintenance” middleware needs assess to the user’s claims.\n\n\n\n2. Create a Controller / web APIs to handle the “down for maintenance”\n\n\n\nYou need pages / APIs to handle the following:\n\n\n\nFor the admin usersLook at all the current “downs” and have the ability to remove anyManually set the app “down” (with messages for the users)Manually set a tenant “down”For diverted usersApp DownTenant down while being updatedTenant down by adminTenant is deleted\n\n\n\nIn the Example4 web site (hierarchical tenant design) and Example6 web site (single-level + sharding) I have a controller called StatusController that contains the actions / pages listed above. Please look at the Example4’s StatusController for an example of what you need to create.\n\n\n\nNOTE: the diverted pages are hard coded into the RedirectUsersViaStatusData class, while the controller’s name can be changed. If you want to have different urls for the diverted pages, then you need to copy the code and register your version of the RedirectUsersViaStatusData class.\n\n\n\n3. Using the ISetRemoveStatus service to set / remove a “down” state\n\n\n\nThe SetRemoveStatus class contains the code to set, remove and display the “down” statues in the FileStore distributed cache. There are many types of diverts and this service creates the cache key which defines the type of divert that the user should be diverted to.\n\n\n\nThe AppDown divert is easy because it has one divert, but the tenant divert is more complex because a) it has three divert types and b) a divert is unique to a tenant. Each “down” entry in FileStore distributed database has a unique key name, which allows you to have multiple “downs” at once. And in the case of a tenant down the FileStore entry’s value is the tenant key, which is used to detect if the user is linked to a tenant that is in a “down” state.\n\n\n\nThe ISetRemoveStatus service makes it easy for the developer to wrap your change / move code with a “down” at the start and remove the “down”” at the end. The code below shows an example of how the ISetRemoveStatus service would work, with the “down” and remove “down” code highlighted.\n\n\n\n[HttpPost]\n[ValidateAntiForgeryToken]\n[HasPermission(Example6Permissions.MoveTenantDatabase)]\npublic async Task<IActionResult> MoveDatabase(\n    ShardingSingleLevelTenantDto input)\n{\n    var removeDownAsync = await _upDownService\n        .SetTenantDownWithDelayAsync(\n              TenantDownVersions.Update, input.TenantId);\n    var status = await _authTenantAdmin\n        .MoveToDifferentDatabaseAsync(input.TenantId, \n              input.HasOwnDb, input.ConnectionName);\n    await removeDownAsync();\n\n    return status.HasErrors\n        ? RedirectToAction(nameof(ErrorDisplay),\n              new { errorMessage = status.GetAllErrors() })\n        : RedirectToAction(nameof(Index), \n              new { message = status.Message });\n}\n\n\n\nAs you can see you define what type of tenant change via the TenantDownVersions enums. The ISetRemoveStatus service handles creating the key name for the actual “down” entry in the FileStore distributed database. The “down” entry key string is designed to make finding / filtering the “down” values to work quickly, so the key string is a bit complex. The figure below shows the various combinations of key names to provide a) define what type of divert it is, and b) is unique name for each tenant.\n\n\n\n\n\n\n\nNOTE: For a tenant “down” entry the value is the tenant’s unique key, while for the AppDown the value contains a message, expected time, and UserId of the user that “downed” the whole app.\n\n\n\n4. Understanding the “down for maintenance” middleware\n\n\n\nThe middleware code (see RedirectUsersViaStatusData class) is called on every HTTP request, and its job is to quickly let through a user if there isn’t an “down” status that effects the current user. There are three stages in this middleware to cover each part of the filter. They are:\n\n\n\nNOTE: I use the term admin user (see this link) to define a user who is managing the application. These types of users have a) access to high-level admin features and b) aren’t linked to a tenant.\n\n\n\nSTAGE 1: Allowed URLs get through\n\n\n\nThe middleware allows two types of URLs.\n\n\n\nYou can login and logout. I added this when I “downed” the app and then rerun the app, at which point I couldn’t log to remove the “App down”!I allow access to the Status controller. This allows an admin user and manually turn off a “down” if anything goes wrong.\n\n\n\nSTAGE 2: Handle AppDown\n\n\n\nThe AppDown feature stops all users from using the application’s features, apart from the admin user that “downed” the app. This means that the admin user can check / fix the problem before removing the “down” on the app.\n\n\n\nThis feature is there for situations where the application’s software or data that can’t be updated by the normal deploy / migrate approach. You will rarely need the AppDown feature, but it’s there for emergencies.\n\n\n\nSTAGE 3: Handle Tenant “down”\n\n\n\nThe main usage of the middleware is to managing changes to a tenant’s data and the code uses the start of the “down” key to detect which types of divert is needed. The three types are:\n\n\n\nTenant down while being updatedTenant down by an admin use (known as tenant “manual down”)Tenant is deleted (this stops user trying a tenant that doesn’t exist)\n\n\n\nNOTE: An example of the code to take a tenant “down” while being updated can be found in section 3.\n\n\n\nThe middleware code isn’t complex, but it’s a bit hard to follow so I have provided a flowchart to show how the three stages are handled. The important thing is the middleware is very fast (via using the FileStore distributed cache) at letting though users when no “down” is active.\n\n\n\n\n\n\n\nNOTE: The RedirectUsersViaStatusData class has comments starting with the three STAGES shown in the flowchart.\n\n\n\n5. Other things to consider when moving a tenant database\n\n\n\nThe tenant “Down for Maintenance” feature solves the most complex issue of ensuring that the tenant data isn’t accessed during the data is moved. But there are some extra issues you need to consider which the AuthP library already has solutions for. The issues are:\n\n\n\nUpdating the tenant user’s DataKey claims on a moveAn internal hierarchical move needs to “down” two parts of the tenant dataThe admin access to tenant data feature needs extra code in the middleware\n\n\n\n5.1. Updating the tenant user’s DataKey claims on a move\n\n\n\nIf you are moving a database in a sharding multi-tenant application or moving data in a hierarchical multi-tenant application, then the information used by the user to access the tenant data will change. Therefore, you MUST update the information used by the user to access the tenant data.\n\n\n\nIn the AuthP library the user’s key to a tenant data is held in the user’s claims which makes the user access very fast (see this section of an earlier article). But that means that the tenant claims need to be updated when the DataKey changes, and AuthP has feature that detects a change to the tenant DataKey parts and then makes sure all the logged-in users have their claims updated – see the AuthP “update claims on tenant change” documentation on how this works.\n\n\n\n5.2. An internal hierarchical move needs to “down” two parts of the tenant data\n\n\n\nThe AuthP hierarchical multi-tenant has a move feature where a section of the hierarchical data can be moved to another part of the hierarchy – known as the parent (see this example). In this case you need to “down” both the section to be moved and the section that the moved too.\n\n\n\nFor this reason, the SetTenantDownWithDelayAsync method has an optional parameter called parentId. If the parentId is not zero, then it will also “down” the parent during the hierarchical move. The code below shows the code, with the extra parentId parameter highlighted.\n\n\n\nvar removeDownAsync = await _upDownService\n    .SetTenantDownWithDelayAsync(\n        TenantDownVersions.Update, input.TenantId, \n        input.ParentId);\nvar status = await _authTenantAdmin\n    .MoveHierarchicalTenantToAnotherParentAsync\n        (input.TenantId, input.ParentId);\nawait removeDownAsync();\n\n\n\n\n5.3. The “admin access to tenant” data feature needs extra code in the middleware\n\n\n\nThe AuthP library provides a feature that allows admin / support users (i.e. users not linked to a tenant) to temporary gain access to a tenant’s data (see the admin access to tenant documentation for more information).\n\n\n\nThis is implemented by using a cookie to contain the tenant DataKey, but the “down for maintenance” middleware doesn’t contain code to handle that. While giving admin user a way to access the tenant’s data is useful if a problem occurs in the change / move, but admin must be aware of any tenant change / move and not try to access that tenant (or turn off the “admin access to tenant” feature).\n\n\n\nConclusions\n\n\n\nBack in 2015 I wrote an article about how to take an ASP.NET MVC5 web site “Down for maintenance” and now in 2022 I this article provides a version for an ASP.NET Core application. The basic approach of using middleware is the same, but this latest approach also contains features to handle multi-tenant applications.\n\n\n\nBoth the older ASP.NET MVC5 version and the latest ASP.NET Core are designed to be quick. This focus on high performance is because the code is run on every HTTP request. Both versions use a shared file to work across multiple instances of the web applications, for instance when you use Azure’s scale-out. But the new version has much more complex needs, with tenant-level “down” features, which required a more sophisticated approach, which is handled by the FileStore distributed cache acting as a fast-read / slow-write database.\n\n\n\nWith this feature added to version 3.4.0 of the AuthP library you can safely manage tenants while users are accessing your multi-tenant application."
  },
  {
    "itemId": "https://www.thereformedprogrammer.net/?p=2752",
    "raw": "\n<p>This article describes a way to create a database using ASP.NET Core appsettings.json configuration feature. The big benefit of this approach is the read is blistering fast, something like 1,000 times quicker than a SQL Server database query. The downside is the write is relatively slow (e.g. &gt;1 ms write) so this approach is best for situations where you have lots more reads than writes. I use this approach in an ASP.NET Core applications where certain data are read on every HTTP requests.</p>\n\n\n\n<h2 class=\"wp-block-heading\">TL;DR; – Summary of this article</h2>\n\n\n\n<ul class=\"wp-block-list\"><li>There is a way to use ASP.NET Core Configuration feature to create a type of database that has is much faster (~1,000 times faster) read than a typical database, but the write is slower than a database (small database = ~2 times slower, 400kb size database = ~10 times slower).</li><li>A good use for this type of database is where you have lots of reads and rare writes. I created this approach to handle a database query on every HTTP request.</li><li>This article describes the five steps to implement a database using ASP.NET Core Configuration feature.</li><li>There is a library called <a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache\">Net.DistributedFileStoreCache</a> (shortened to FileStore cache) which provides a pre-build version of this approach. You might like to refer to these articles:<ul><li>A .NET distributed cache with a ~25 nanosecond read time!</li></ul><ul><li>How to change/move databases on a live ASP.NET Core web site, which uses the FileStore cache as a database.</li></ul></li></ul>\n\n\n\n<h2 class=\"wp-block-heading\">Setting the scene – why did I use an appsettings.json file as a database?</h2>\n\n\n\n<p>My <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore\">AuthPermissions.AspNetCore</a> library (shortened to AuthP) provides back-end code for building <a href=\"https://www.gartner.com/en/information-technology/glossary/multitenancy\">multi-tenant applications</a> using ASP.NET Core and EF Core, and in version 3 of the AuthP library I added support for <a href=\"https://www.thereformedprogrammer.net/part6-using-sharding-to-build-multi-tenant-apps-using-asp-net-core-and-ef-core/#setting-the-scene-what-is-sharding-and-why-it-is-useful\">sharding</a>. To implement sharding I needed to create a connection string that points to the database server+database on every HTTP request from a tenant user.</p>\n\n\n\n<p>Also, there were couple of extra features that I wanted my sharding implementation to support</p>\n\n\n\n<ul class=\"wp-block-list\"><li>Should work with Azure’s SQL Server elastic pools. Azure elastic pooling provides a cost-effective way to have lots of databases (see <a href=\"https://docs.microsoft.com/en-us/azure/azure-sql/database/elastic-pool-overview\">this document</a> on why this is useful).</li><li>Support geographically placed database servers to improve performance when you have users that are geographically spread out.</li><li>Good security: the connection strings contains Username/Password of the servers, so for security reasons I store the <a href=\"https://docs.microsoft.com/en-us/azure/app-service/configure-common#configure-connection-strings\">database strings in Azure</a>.</li></ul>\n\n\n\n<p>The diagram below shows how the implementation of the sharding is changed to support these three extra features:</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/GeographicalSpreadServers.png\"><img loading=\"lazy\" decoding=\"async\" width=\"690\" height=\"369\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/GeographicalSpreadServers.png\" alt=\"\" class=\"wp-image-2753\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/GeographicalSpreadServers.png 690w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/GeographicalSpreadServers-300x160.png 300w\" sizes=\"auto, (max-width: 690px) 100vw, 690px\" /></a></figure>\n\n\n\n<p>The sharding code gets the sharding data for a specific tenant which contains the name of the connection string linked to a database server and the name of the database on that database server. From these two parts it forms the composite connection string needed to access the tenant database. This isn’t that complex procedure, but it does to read in the sharding data (name of connection string and name of the database) on every HTPP request for a tenant user.</p>\n\n\n\n<p>I could go with a database access, but I’m really trying to make this library very fast, so I started to look at ASP.NET Core Configuration features i.e. appsettings.json and IOptions because I know that the read of configuration data is really fast because the data is cached by ASP.NET Code configuration code.</p>\n\n\n\n<p>Therefore, I created a appsettings.json type file which I could update and then used the Configuration <code>IOptionsSnapshot&lt;T&gt;</code> method to get the latest data my settings file. (see Microsoft <a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/optionsuse-ioptionssnapshot-to-read-updated-data\">Options Pattern docs</a> for more info on this type of read). The diagram below shows the whole process.</p>\n\n\n\n<figure class=\"wp-block-image size-full\"><a href=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/ShardingSettingsSteps.png\"><img loading=\"lazy\" decoding=\"async\" width=\"761\" height=\"520\" src=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/ShardingSettingsSteps.png\" alt=\"\" class=\"wp-image-2754\" srcset=\"https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/ShardingSettingsSteps.png 761w, https://www.thereformedprogrammer.net/wp-content/uploads/2022/09/ShardingSettingsSteps-300x205.png 300w\" sizes=\"auto, (max-width: 761px) 100vw, 761px\" /></a></figure>\n\n\n\n<p>This might seem very complex, but it’s:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li>Very fast: something like 1,000 times quicker than using a database access.</li><li>Secure: The connection string isn’t in any of your code or your claims.</li><li>Doesn’t use a database: This means your tenant databases won’t be slowed by lots of small queries.</li></ol>\n\n\n\n<p>The rest of this article describes the steps needed to create a generic fast-read database by using ASP.NET Core Configuration feature. In the steps I show examples from the sharding feature described above, with links to the code in the AuthP’s open-source repo. That way you have working code examples of how I used this approach.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Steps to turn an appsettings.json file into a fast-read database</h2>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: I refer to the json file which will be used as database as the <em>database json file</em> in this article.</p></blockquote>\n\n\n\n<p>The steps are to implementing a database json file are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li>Create a json file to act as a database</li><li>Make sure the database json file isn’t overwritten</li><li>Register the database json file on startup</li><li>Write to the database json file within a distributed lock</li><li>Use <code>IOptionsSnapshot&lt;T&gt;</code> to read the database json file</li></ol>\n\n\n\n<h3 class=\"wp-block-heading\">1. Define a json file to act as a database</h3>\n\n\n\n<p>The first thing to do is work out what data you need to store the database json file for your application. Once you have decided on the data you need, then you must implement the dats by using class(es) that contain parameters that can be serialized / deserialized to json by the .NET Text.Json library.</p>\n\n\n\n<p>For my sharding settings I have a List of the class called <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.AspNetCore/Services/DatabaseInformation.cs\">DatabaseInformation</a>, which has four properties (all of type string) that define a specific settings of each sharding server+database. The code below shows the type of json the sharding settings file would contain.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: jscript; title: ; notranslate\">\n{\n  &quot;ShardingDatabases&quot;: &#x5B;\n    {\n      &quot;Name&quot;: &quot;ShardWest1&quot;,\n      &quot;DatabaseName&quot;: &quot;West1&quot;,\n      &quot;ConnectionName&quot;: &quot;WestServer&quot;,\n      &quot;DatabaseType&quot;: &quot;SqlServer&quot;\n    },\n    {\n      &quot;Name&quot;: &quot;ShardWest2&quot;,\n      //… rest of the content has been left out \n    }\n  ]\n}\n</pre></div>\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: The name of the section / array used in your database json file must be unique across all the configuration json files.</p></blockquote>\n\n\n\n<h3 class=\"wp-block-heading\">2. Make sure the database json file isn’t overwritten</h3>\n\n\n\n<p>A normal appsettings.json file gets overwritten when an application is deployed. But because we want to use json file as a database, then you don’t want the file to overwritten. I do two things to make sure the database json file isn’t overwritten.</p>\n\n\n\n<p>First, I use a filename which includes the environment name, e.g. Debug, Staging, Production, so my implementation the filename is $“shardingsettings.{EnvironmentName}.json”. This means that filename used developing the application in Debug mode can’t overwrite your Production database json file.</p>\n\n\n\n<p>But the most important thing to do (but easy to forget) is to set the file’s “Copy to Output Director” property to “Do not copy”. This stops the database json file being copied in your deployment. You can manually set this via file properties, but I prefer to add a ItemGroup to the ASP.NET Core .csproj file, as shown below.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: plain; title: ; notranslate\">\n&lt;ItemGroup&gt;\n\t&lt;Content Update=&quot;shardingsettings.Production.json&quot;&gt;\n\t\t&lt;CopyToOutputDirectory&gt;Never&lt;/CopyToOutputDirectory&gt;\n\t&lt;/Content&gt;\n&lt;/ItemGroup&gt;\n</pre></div>\n\n\n<h3 class=\"wp-block-heading\">3. Register the database json file on startup</h3>\n\n\n\n<p>There are two parts to registering database json file on startup. They are:</p>\n\n\n\n<ol class=\"wp-block-list\" type=\"1\"><li>Register the database json file to the ASP.NET Core’s Configuration</li><li>Register your IOptions access via the Configure&lt;T&gt; service</li></ol>\n\n\n\n<h4 class=\"wp-block-heading\">3.1 Register the database json file to the ASP.NET Core’s Configuration</h4>\n\n\n\n<p>To register your database json file to be part of the Configuration you use the AddJsonFile method. The code below goes in the Program class and registers my shardingsettings file.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\nvar shardingFileName = \n    $“shardingsettings.{builder.Environment.EnvironmentName}.json”\nbuilder.Configuration.AddJsonFile(shardingFileName, \n      optional: true, reloadOnChange: true); \n</pre></div>\n\n\n<p>You need to think what happens when you first deploy using a database json file. In this case I set the optional parameter to true, which means the application can start without the file. If you use <code>IOptionsSnapshot&lt;T&gt;</code> (see next subsection on IOptionsSnapshot&lt;T&gt;) it will return null if the database json file isn’t there or doesn’t have any json in it, but once you create the file the application will start tracking the file and the <code>IOptionsSnapshot&lt;T&gt;</code> Value will be non-null.</p>\n\n\n\n<blockquote class=\"wp-block-quote is-layout-flow wp-block-quote-is-layout-flow\"><p>NOTE: The other approach is set the optional parameter to false and ensure that there is a json file exists. But if the optional parameter is false, then if the json file isn’t there, then the application will fail on startup. This means you need to create on startup if no file exists. &nbsp;</p></blockquote>\n\n\n\n<h4 class=\"wp-block-heading\">3.2 Register your IOptions access via the Configure&lt;T&gt; service</h4>\n\n\n\n<p>You must register a Configure&lt;T&gt; service, where T is the class which defines the json content of the database json file, to allow you use the IOptions access to the data inside. This is done by registering a class to a specific part of the <a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options#bind-hierarchical-configuration\">configuration setting via a class</a>.</p>\n\n\n\n<p>In my shardingsettings file I use a collection of data, so my options class looks like this:</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\npublic class ShardingSettingsOption\n{\n    public List&lt;DatabaseInformation&gt; \n          ShardingDatabases { get; set; }\n} \n</pre></div>\n\n\n<p>And configured by the code below, which will look for a json array in all the registered json files with the name of ShardingDatabases.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\nbuilder.Services.Configure&lt;ShardingSettingsOption&gt;\n      (builder.Configuration);\n</pre></div>\n\n\n<h3 class=\"wp-block-heading\">4. Write to the database json file within a distributed lock</h3>\n\n\n\n<p>To update the data in the database json file you need to read in the current json, add your change and write back out. This read-&gt;update-&gt;write process is fairly easy to implement – Have a look at my <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.SupportCode/ShardingServices/AccessDatabaseInformation.cs\">AccessDatabaseInformation</a> class for an example of what this would look like.</p>\n\n\n\n<p>While the update part of the code is straightforward, we do need to handle simultaneous updates, because one update could overwrite another update. This type of simultaneous updates is rare, but because they can occur, we need to handle this. This means we need to wrap the update process with some code that would stop other updates from running until the current update has finished.</p>\n\n\n\n<p>If you are only running one instance of your ASP.NET Core application, then you could use a .NET <a href=\"https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/statements/lock\">lock</a>. But my library is designed with high performance applications where multiple instances of the application are running at the same time (Azure calls this <em>scale out</em>), so I need a distributed lock. I use an excellent library called <a href=\"https://github.com/madelson/DistributedLock\">DistributedLock</a>. &nbsp;</p>\n\n\n\n<p>The DistributedLock library uses a global resource, such as a database, to form a lock across all the running instances. The code below (adapted from the <a href=\"https://github.com/madelson/DistributedLock#acquire\">Acquire section of the DistributedLock Readme</a>)</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\nvar myDistributedLock = \n     new SqlDistributedLock(name, connectionString); \nusing (myDistributedLock.Acquire())\n{\n\t//Run the read-&gt;update-&gt;write process within this lock\n} // this releases the lock\n</pre></div>\n\n\n<h3 class=\"wp-block-heading\">5. Use IOptionsSnapshot&lt;T&gt; to read the database json file</h3>\n\n\n\n<p>Finally, you can access the information in the database json file via ASP.NET Core’s <code>IOptionsSnapshot&lt;T&gt;</code> method. The code below is a simplified version of the AuthP’s <a href=\"https://github.com/JonPSmith/AuthPermissions.AspNetCore/blob/main/AuthPermissions.AspNetCore/Services/ShardingConnections.cs\">ShardingConnections constructor</a>. When the ShardingConnections service is created it uses the <code>IOptionsSnapshot&lt;T&gt;</code> method to get the data in the database json file, in this case my sharding settings file. (see Microsoft <a href=\"https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/optionsuse-ioptionssnapshot-to-read-updated-data\">Options Pattern docs</a> for more info).</p>\n\n\n\n<p>As I showed in the <a href=\"https://www.thereformedprogrammer.net/how-to-turn-an-asp-net-core-appsettings-json-file-into-a-fast-read-database/#setting-the-scene-why-did-i-use-an-appsettings-json-file-as-a-database\">setting the scene section</a> using the <code>IOptionsSnapshot&lt;T&gt;</code> method in the code below reads in the current sharding settings.</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: csharp; title: ; notranslate\">\nprivate readonly ShardingSettingsOption _shardingSettings;\npublic ShardingConnections(\n     IOptionsSnapshot&lt;ShardingSettingsOption&gt;\n     shardingSettingsAccessor, AuthPermissionsOptions options,\n     … other parameters left out)\n{\n    _shardingSettings = shardingSettingsAccessor.Value\n        //If no sharding settings file, \n        //then add the default sharding setting\n        ?? new List&lt;DatabaseInformation&gt;\n       {\n           DatabaseInformation.FormDefaultDatabaseInfo(options)\n       };\n}\n</pre></div>\n\n\n<p>Note that if the sharding settings file doesn’t exist the <code>IOptionsSnapshot&lt;T&gt;</code> Value will be null, and you need to work out in that case. You could return the null, but often the best solution is to create an empty collection or similar. In the AuthP’s sharding settings shown above a new deployment always has a single, default DatabaseInformation, which is formed from the multi-tenant setup information contains.</p>\n\n\n\n<h2 class=\"wp-block-heading\">Conclusions</h2>\n\n\n\n<p>Creating a fast-read / slow-write database using ASP.NET Core’s Configuration / <code>IOptionsSnapshot&lt;T&gt;</code> might not be the first approach you would think of for creating a database, but in situations where you want a very fast read where the data changes rarely. For instance, the AuthP sharding feature is a very good fit to this approach because it needs two read queries (one to get the sharing data and another to get the database server connection string) on every HTTP tenant user request read with rare changes to the sharding data.</p>\n\n\n\n<p>I also created a library called <a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache\">Net.DistributedFileStoreCache</a> (shortened to FileStore cache) which implement a <a href=\"https://docs.microsoft.com/en-us/aspnet/core/performance/caching/distributed\">Distributed cache</a>. This library uses the approach that ASP.NET Core Configuration / IOptionsSnapshot&lt;T&gt; &nbsp;but uses .NET’s <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.io.filesystemwatcher\">FileSystemWatcher</a> class instead to IOptionsSnapshot&lt;T&gt;. The FileStore cache has a ~25 ns. read time and a write time &gt; 1 ms. – see the FileStore cache <a href=\"https://github.com/JonPSmith/Net.DistributedFileStoreCache#performance-figures\">full performance figures here</a>.</p>\n\n\n\n<p>I use the FileStore cache in database mode in the article “How to change / move databases on a live ASP.NET Core web site” because this feature needs multiple reads on every HTTP request. Using FileStore cache removes the extra ~1 ms. that a database might have.</p>\n\n\n\n<p>If nothing else you have learnt more about ASP.NET Core’s Configuration / IOptionsSnapshot&lt;T&gt;, and you have learnt a new way to store data with a different performance from a normal database.</p>\n\n\n\n<p>Happy coding.</p>\n",
    "sanitized": "This article describes a way to create a database using ASP.NET Core appsettings.json configuration feature. The big benefit of this approach is the read is blistering fast, something like 1,000 times quicker than a SQL Server database query. The downside is the write is relatively slow (e.g. >1 ms write) so this approach is best for situations where you have lots more reads than writes. I use this approach in an ASP.NET Core applications where certain data are read on every HTTP requests.\n\n\n\nTL;DR; – Summary of this article\n\n\n\nThere is a way to use ASP.NET Core Configuration feature to create a type of database that has is much faster (~1,000 times faster) read than a typical database, but the write is slower than a database (small database = ~2 times slower, 400kb size database = ~10 times slower).A good use for this type of database is where you have lots of reads and rare writes. I created this approach to handle a database query on every HTTP request.This article describes the five steps to implement a database using ASP.NET Core Configuration feature.There is a library called Net.DistributedFileStoreCache (shortened to FileStore cache) which provides a pre-build version of this approach. You might like to refer to these articles:A .NET distributed cache with a ~25 nanosecond read time!How to change/move databases on a live ASP.NET Core web site, which uses the FileStore cache as a database.\n\n\n\nSetting the scene – why did I use an appsettings.json file as a database?\n\n\n\nMy AuthPermissions.AspNetCore library (shortened to AuthP) provides back-end code for building multi-tenant applications using ASP.NET Core and EF Core, and in version 3 of the AuthP library I added support for sharding. To implement sharding I needed to create a connection string that points to the database server+database on every HTTP request from a tenant user.\n\n\n\nAlso, there were couple of extra features that I wanted my sharding implementation to support\n\n\n\nShould work with Azure’s SQL Server elastic pools. Azure elastic pooling provides a cost-effective way to have lots of databases (see this document on why this is useful).Support geographically placed database servers to improve performance when you have users that are geographically spread out.Good security: the connection strings contains Username/Password of the servers, so for security reasons I store the database strings in Azure.\n\n\n\nThe diagram below shows how the implementation of the sharding is changed to support these three extra features:\n\n\n\n\n\n\n\nThe sharding code gets the sharding data for a specific tenant which contains the name of the connection string linked to a database server and the name of the database on that database server. From these two parts it forms the composite connection string needed to access the tenant database. This isn’t that complex procedure, but it does to read in the sharding data (name of connection string and name of the database) on every HTPP request for a tenant user.\n\n\n\nI could go with a database access, but I’m really trying to make this library very fast, so I started to look at ASP.NET Core Configuration features i.e. appsettings.json and IOptions because I know that the read of configuration data is really fast because the data is cached by ASP.NET Code configuration code.\n\n\n\nTherefore, I created a appsettings.json type file which I could update and then used the Configuration IOptionsSnapshot<T> method to get the latest data my settings file. (see Microsoft Options Pattern docs for more info on this type of read). The diagram below shows the whole process.\n\n\n\n\n\n\n\nThis might seem very complex, but it’s:\n\n\n\nVery fast: something like 1,000 times quicker than using a database access.Secure: The connection string isn’t in any of your code or your claims.Doesn’t use a database: This means your tenant databases won’t be slowed by lots of small queries.\n\n\n\nThe rest of this article describes the steps needed to create a generic fast-read database by using ASP.NET Core Configuration feature. In the steps I show examples from the sharding feature described above, with links to the code in the AuthP’s open-source repo. That way you have working code examples of how I used this approach.\n\n\n\nSteps to turn an appsettings.json file into a fast-read database\n\n\n\nNOTE: I refer to the json file which will be used as database as the database json file in this article.\n\n\n\nThe steps are to implementing a database json file are:\n\n\n\nCreate a json file to act as a databaseMake sure the database json file isn’t overwrittenRegister the database json file on startupWrite to the database json file within a distributed lockUse IOptionsSnapshot<T> to read the database json file\n\n\n\n1. Define a json file to act as a database\n\n\n\nThe first thing to do is work out what data you need to store the database json file for your application. Once you have decided on the data you need, then you must implement the dats by using class(es) that contain parameters that can be serialized / deserialized to json by the .NET Text.Json library.\n\n\n\nFor my sharding settings I have a List of the class called DatabaseInformation, which has four properties (all of type string) that define a specific settings of each sharding server+database. The code below shows the type of json the sharding settings file would contain.\n\n\n\n{\n  \"ShardingDatabases\": [\n    {\n      \"Name\": \"ShardWest1\",\n      \"DatabaseName\": \"West1\",\n      \"ConnectionName\": \"WestServer\",\n      \"DatabaseType\": \"SqlServer\"\n    },\n    {\n      \"Name\": \"ShardWest2\",\n      //… rest of the content has been left out \n    }\n  ]\n}\n\n\n\nNOTE: The name of the section / array used in your database json file must be unique across all the configuration json files.\n\n\n\n2. Make sure the database json file isn’t overwritten\n\n\n\nA normal appsettings.json file gets overwritten when an application is deployed. But because we want to use json file as a database, then you don’t want the file to overwritten. I do two things to make sure the database json file isn’t overwritten.\n\n\n\nFirst, I use a filename which includes the environment name, e.g. Debug, Staging, Production, so my implementation the filename is $“shardingsettings.{EnvironmentName}.json”. This means that filename used developing the application in Debug mode can’t overwrite your Production database json file.\n\n\n\nBut the most important thing to do (but easy to forget) is to set the file’s “Copy to Output Director” property to “Do not copy”. This stops the database json file being copied in your deployment. You can manually set this via file properties, but I prefer to add a ItemGroup to the ASP.NET Core .csproj file, as shown below.\n\n\n\n<ItemGroup>\n\t<Content Update=\"shardingsettings.Production.json\">\n\t\t<CopyToOutputDirectory>Never</CopyToOutputDirectory>\n\t</Content>\n</ItemGroup>\n\n\n\n3. Register the database json file on startup\n\n\n\nThere are two parts to registering database json file on startup. They are:\n\n\n\nRegister the database json file to the ASP.NET Core’s ConfigurationRegister your IOptions access via the Configure<T> service\n\n\n\n3.1 Register the database json file to the ASP.NET Core’s Configuration\n\n\n\nTo register your database json file to be part of the Configuration you use the AddJsonFile method. The code below goes in the Program class and registers my shardingsettings file.\n\n\n\nvar shardingFileName = \n    $“shardingsettings.{builder.Environment.EnvironmentName}.json”\nbuilder.Configuration.AddJsonFile(shardingFileName, \n      optional: true, reloadOnChange: true); \n\n\n\nYou need to think what happens when you first deploy using a database json file. In this case I set the optional parameter to true, which means the application can start without the file. If you use IOptionsSnapshot<T> (see next subsection on IOptionsSnapshot<T>) it will return null if the database json file isn’t there or doesn’t have any json in it, but once you create the file the application will start tracking the file and the IOptionsSnapshot<T> Value will be non-null.\n\n\n\nNOTE: The other approach is set the optional parameter to false and ensure that there is a json file exists. But if the optional parameter is false, then if the json file isn’t there, then the application will fail on startup. This means you need to create on startup if no file exists.  \n\n\n\n3.2 Register your IOptions access via the Configure<T> service\n\n\n\nYou must register a Configure<T> service, where T is the class which defines the json content of the database json file, to allow you use the IOptions access to the data inside. This is done by registering a class to a specific part of the configuration setting via a class.\n\n\n\nIn my shardingsettings file I use a collection of data, so my options class looks like this:\n\n\n\npublic class ShardingSettingsOption\n{\n    public List<DatabaseInformation> \n          ShardingDatabases { get; set; }\n} \n\n\n\nAnd configured by the code below, which will look for a json array in all the registered json files with the name of ShardingDatabases.\n\n\n\nbuilder.Services.Configure<ShardingSettingsOption>\n      (builder.Configuration);\n\n\n\n4. Write to the database json file within a distributed lock\n\n\n\nTo update the data in the database json file you need to read in the current json, add your change and write back out. This read->update->write process is fairly easy to implement – Have a look at my AccessDatabaseInformation class for an example of what this would look like.\n\n\n\nWhile the update part of the code is straightforward, we do need to handle simultaneous updates, because one update could overwrite another update. This type of simultaneous updates is rare, but because they can occur, we need to handle this. This means we need to wrap the update process with some code that would stop other updates from running until the current update has finished.\n\n\n\nIf you are only running one instance of your ASP.NET Core application, then you could use a .NET lock. But my library is designed with high performance applications where multiple instances of the application are running at the same time (Azure calls this scale out), so I need a distributed lock. I use an excellent library called DistributedLock.  \n\n\n\nThe DistributedLock library uses a global resource, such as a database, to form a lock across all the running instances. The code below (adapted from the Acquire section of the DistributedLock Readme)\n\n\n\nvar myDistributedLock = \n     new SqlDistributedLock(name, connectionString); \nusing (myDistributedLock.Acquire())\n{\n\t//Run the read->update->write process within this lock\n} // this releases the lock\n\n\n\n5. Use IOptionsSnapshot<T> to read the database json file\n\n\n\nFinally, you can access the information in the database json file via ASP.NET Core’s IOptionsSnapshot<T> method. The code below is a simplified version of the AuthP’s ShardingConnections constructor. When the ShardingConnections service is created it uses the IOptionsSnapshot<T> method to get the data in the database json file, in this case my sharding settings file. (see Microsoft Options Pattern docs for more info).\n\n\n\nAs I showed in the setting the scene section using the IOptionsSnapshot<T> method in the code below reads in the current sharding settings.\n\n\n\nprivate readonly ShardingSettingsOption _shardingSettings;\npublic ShardingConnections(\n     IOptionsSnapshot<ShardingSettingsOption>\n     shardingSettingsAccessor, AuthPermissionsOptions options,\n     … other parameters left out)\n{\n    _shardingSettings = shardingSettingsAccessor.Value\n        //If no sharding settings file, \n        //then add the default sharding setting\n        ?? new List<DatabaseInformation>\n       {\n           DatabaseInformation.FormDefaultDatabaseInfo(options)\n       };\n}\n\n\n\nNote that if the sharding settings file doesn’t exist the IOptionsSnapshot<T> Value will be null, and you need to work out in that case. You could return the null, but often the best solution is to create an empty collection or similar. In the AuthP’s sharding settings shown above a new deployment always has a single, default DatabaseInformation, which is formed from the multi-tenant setup information contains.\n\n\n\nConclusions\n\n\n\nCreating a fast-read / slow-write database using ASP.NET Core’s Configuration / IOptionsSnapshot<T> might not be the first approach you would think of for creating a database, but in situations where you want a very fast read where the data changes rarely. For instance, the AuthP sharding feature is a very good fit to this approach because it needs two read queries (one to get the sharing data and another to get the database server connection string) on every HTTP tenant user request read with rare changes to the sharding data.\n\n\n\nI also created a library called Net.DistributedFileStoreCache (shortened to FileStore cache) which implement a Distributed cache. This library uses the approach that ASP.NET Core Configuration / IOptionsSnapshot<T>  but uses .NET’s FileSystemWatcher class instead to IOptionsSnapshot<T>. The FileStore cache has a ~25 ns. read time and a write time > 1 ms. – see the FileStore cache full performance figures here.\n\n\n\nI use the FileStore cache in database mode in the article “How to change / move databases on a live ASP.NET Core web site” because this feature needs multiple reads on every HTTP request. Using FileStore cache removes the extra ~1 ms. that a database might have.\n\n\n\nIf nothing else you have learnt more about ASP.NET Core’s Configuration / IOptionsSnapshot<T>, and you have learnt a new way to store data with a different performance from a normal database.\n\n\n\nHappy coding."
  }
]
